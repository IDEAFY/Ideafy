/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","lib/spin.min"],function(e,t,i,s,n,a,r){return function(){var o,c=new e,l=n.get("labels"),d=new a,u=n.get("user"),p=null,g=!1;return c.plugins.addAll({label:new i(l),model:new i(d,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setButton:function(e){e?this.setAttribute("style","display: inline-block;"):this.setAttribute("style","display:none;")},displayVote:function(e){var t=this.getAttribute("name"),i=d.get(t+"Votes"),s=this.querySelector(".yesvote"),n=this.querySelector(".novote");e?i.indexOf(u.get("_id"))>-1?n.classList.add("invisible"):s.classList.add("invisible"):(s.classList.remove("invisible"),n.classList.remove("invisible"))},setResult:function(e){this.innerHTML=e?l.get(e):""}}),event:new s(c)}),c.template='<div class = "confirm invisible"><legend><span data-label="bind:innerHTML, decidemsg"></span><span class="unanimity" data-label="bind: innerHTML, unanimity"></span></legend><div class="votingitem invisible" name="public" data-model="bind:setVisible,public; bind: displayVote, publicVote"><div class="sessionquestion" data-label="bind:innerHTML,setpublic"></div><div class = "votingbuttons" name="public"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: touchstart, push; listen: touchend, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: touchstart, push; listen: touchend, vote">No</span></div><div class="votingresult" data-model="bind: setResult, publicResult"></div></div><div class="votingitem invisible" name = "replay" data-model="bind:setVisible,replay; bind: displayVote, replayVote"><div class="sessionquestion" data-label="bind:innerHTML,enablereplay"></div><div class = "votingbuttons" name="replay"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: touchstart, push; listen: touchend, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: touchstart, push; listen: touchend, vote">No</span></div><div class="votingresult" data-model="bind: setResult, replayResult"></div></div><div id="muvotespinner"></div><div class="option left votebutton" data-event="listen:touchstart, press; listen:touchend, submit" data-model="bind:setButton, submit" data-label="bind: innerHTML, submitlbl">Submit</div><div class="option right votebutton" data-event="listen:touchstart, press; listen:touchend, skip" data-model="bind:setButton, skip" data-label="bind:innerHTML, skiplbl">Skip</div></div>',c.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},c.push=function(e,t){var i=t.parentNode,s=i.getAttribute("name");d.get(s+"Vote")||d.get(s+"Result")||t.setAttribute("style","-webkit-box-shadow: 0px 0px 2px #657B99;")},c.vote=function(e,t){var i=t.parentNode,s=i.getAttribute("name");if(t.setAttribute("style","-webkit-box-shadow: none;"),d.get("leader"))t.classList.toggle("voted"),t.classList.contains("yesvote")?t.classList.contains("voted")?(d.set(s+"Votes",[u.get("_id")]),i.querySelector(".novote").classList.remove("voted")):d.set(s+"Votes",[]):(i.querySelector(".yesvote").classList.remove("voted"),d.set(s+"Votes",[])),d.get("publicVotes").length||d.get("replayVotes").length?d.set("submit",!0):d.set("submit",!1);else if(!d.get(s+"Vote")){var n=d.get(s+"Votes");t.classList.contains("novote")?("public"===s&&d.set("publicResult","rejected"),"replay"===s&&d.set("replayResult","rejected")):(n.push(u.get("_id")),d.set(s+"Votes",n),n.length===p.get("participants").length+1&&("public"===s&&d.set("publicResult","accepted"),"replay"===s&&d.set("replayResult","accepted"))),t.classList.add("voted"),d.set(s+"Vote",!0),g?setTimeout(c.uploadVote,3e3):c.uploadVote()}},c.uploadVote=function(){var e;d.get("leader")||(e=p.get("vote"),g=!0,e.public&&(e.publicVotes=d.get("publicVotes"),e.publicResult=d.get("publicResult")),e.replay&&(e.replayVotes=d.get("replayVotes"),e.replayResult=d.get("replayResult")),p.set("vote",e),p.upload().then(function(){g=!1},function(e){console.log(e)}))},c.submit=function(e,t){var i={};t.classList.remove("pressed"),d.set("skip",!1),d.set("submit",!1),["public","replay"].forEach(function(e){d.get(e+"Votes").length?(i[e]=!0,i[e+"Votes"]=[u.get("_id")]):d.get(e+"Vote")?d.set(e+"Result","rejected"):d.set(e,!1),d.set(e+"Vote",!0)}),p.set("vote",i),p.upload().then(function(){return!0},function(e){console.log(e)})},c.skip=function(e,t){t&&t.classList.remove("pressed"),c.close(),o({visibility:"private",replay:!1})},c.close=function(){t.get("cache").classList.remove("votingcache"),c.dom.classList.add("invisible"),p=null},c.isActive=function(){return!(null===p)},c.show=function(){t.get("cache").classList.add("votingcache"),c.dom.classList.remove("invisible")},c.reset=function(e,i){var s;p=e,o=i,d.reset({}),p.get("vote")&&d.reset(p.get("vote")),p.get("initiator").id===u.get("_id")?(d.set("leader",!0),d.set("submit",!1),d.set("skip",!0),["public","replay"].forEach(function(e){d.set(e,!0),d.set(e+"Vote",!1),d.set(e+"Votes",[]),d.set(e+"Result","")})):(d.set("leader",!1),d.set("submit",!1),d.set("skip",!1)),d.set("publicVote",!1),d.set("replayVote",!1),c.show(),s=p.watchValue("vote",function(e){var i={},n=new r({lines:10,length:8,width:4,radius:8,top:10});exitVote=function(){p.unwatch(s),n.spin(c.dom.querySelector("#muvotespinner")),setTimeout(function(){n.stop(),t.get("cache").classList.remove("votingcache"),o&&o(i)},5e3)},e&&e.public&&e.replay?(d.set("publicResult",e.publicResult),d.set("replayResult",e.replayResult),e.publicResult&&e.replayResult&&(i.visibility="accepted"===e.publicResult?"public":"private",i.replay="accepted"===e.replayResult?!0:!1,exitVote())):e&&e.public?(d.set("publicResult",e.publicResult),i.replay=!1,e.publicResult&&(i.visibility="accepted"===e.publicResult?"public":"private",i.replay=!1,exitVote())):e&&e.replay&&(d.set("replayResult",e.replayResult),i.visibility="private",e.replayResult&&(i.replay="accepted"===e.replayResult?!0:!1,exitVote()))})},c}});