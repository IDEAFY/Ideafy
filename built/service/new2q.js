/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,i,n,s,a,r,o){return function(){var r=new e,c=new a(s.get("TQTemplate")),l=new a(s.get("userLanguages")),d=s.get("user"),u=function(){c.set("lang",d.get("lang")),l.loop(function(e,t){e.name===d.get("lang").substring(0,2)?l.update(t,"selected",!0):l.update(t,"selected",!1)})},p=s.get("labels"),g=140,h=new a({error:""}),m=new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();return c.setTransport(s.get("transport")),u(),r.plugins.addAll({new2q:new i(c,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setLength:function(e){10===e&&this.setAttribute("maxlength",g)}}),select:new i(l,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new i(p),errormsg:new i(h,{setError:function(e){switch(e){case"noquestion":this.innerHTML=p.get("noquestion");break;case"lengthexceeded":this.innerHTML=p.get("lengthexceeded")+" ("+g+p.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new n(r)}),r.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:touchstart, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-new2q="bind: displayLang, lang" data-new2qevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-new2qevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',r.render(),r.place(t.get("new2q-popup")),r.showLang=function(){r.dom.querySelector(".idealang ul").classList.remove("invisible")},r.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),l.loop(function(e,t){i===t?l.update(t,"selected",!0):l.update(t,"selected",!1)})},r.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),c.set("lang",l.get(i).name),r.dom.querySelector(".idealang ul").classList.add("invisible")},r.press=function(e,t){t.classList.add("pressed"),r.dom.querySelector(".description").blur()},r.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),c.unsync(),c.reset(s.get("TQTemplate")),u(),h.reset({error:""}),r.dom.querySelector(".idealang ul").classList.add("invisible")},r.cancel=function(){r.closePopup()},r.upload=function(e,t){var i,n=new Date,a="Q:"+n.getTime();t.classList.remove("pressed"),c.get("question")||h.set("error","noquestion"),h.get("error")||c.get("_id")||(t.classList.add("invisible"),m.spin(t.parentNode),i=setInterval(function(){h.get("error")===p.get("uploadinprogress")?h.set("error",p.get("uploadinprogress")+"..."):h.set("error",p.get("uploadinprogress"))},150),c.set("author",d.get("_id")),c.set("username",d.get("username")),c.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),c.set("lang",d.get("lang")),c.sync(s.get("db"),a).then(function(){return c.upload()}).then(function(){s.get("transport").request("UpdateUIP",{userid:d.get("_id"),type:c.get("type"),docId:a,question:c.get("question")},function(e){var o,l=d.get("connections"),u=l.length,g=[],v={type:"2Q+",docId:a,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:d.get("_id"),username:d.get("username"),firstname:d.get("firstname"),toList:"",ccList:"",object:d.get("username")+p.get("askednew"),body:c.get("question"),signature:""};for("ok"!==e&&console.log(e),clearInterval(i),i=setInterval(function(){h.get("error")===p.get("notifyingcontacts")?h.set("error",p.get("notifyingcontacts")+"..."):h.set("error",p.get("notifyingcontacts"))},150),o=0;u>o;o++)"user"===l[o].type&&g.push(l[o].userid);v.dest=g,s.get("transport").request("Notify",v,function(e){console.log(e)}),m.stop(),t.classList.remove("invisible"),r.closePopup()})}))},r.checkLength=function(e,t){t.value.length>=g?h.set("error","lengthexceeded"):h.set("error","")},r}});