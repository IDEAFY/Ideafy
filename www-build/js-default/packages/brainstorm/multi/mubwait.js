/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(v,m){var g=new e,y=new n,b=new t,w=new t({msg:""}),E=u.get("user"),S=u.get("labels"),x=new p,T,N,C={listener:null},k,L=(new d({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin();return y.setTransport(u.get("transport")),g.plugins.addAll({labels:new i(S),model:new i(y,{setTitle:function(e){e&&(this.innerHTML=e),E.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),E.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new h([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},showStartButton:function(e){e&&e.length&&E.get("_id")===y.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new i(b,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new h([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(w),place:new o({chat:x}),mubwaitevent:new s(g)}),g.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',g.place(document.getElementById("mubwait")),g.help=function(e,t){a.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},T=new l(document.body,null,null,"musession-confirm"),g.reset=function(t){x.clear(),y.unsync(),y.reset({}),b.reset([]),N=function(e){e?(E.set("sessionInProgress",""),E.upload(),y.get("initiator").id===E.get("_id")?g.cancelSession():g.leaveSession()):T.hide()},C.listener=f.exitListener("mubwait",g.leave),y.sync(u.get("db"),t).then(function(){y.get("initiator").id===E.get("_id")?T.reset(S.get("leaderleave"),N):T.reset(S.get("participantleave"),N),b.reset(y.get("participants")),x.reset(y.get("chat")[0]),E.set("sessionInProgress",{id:t,type:"musession",mode:"join"}),E.upload()})},g.leave=function(t){k=t.getAttribute("href")||t,T.show()},g.leaveSession=function(){var t=y.get("participants"),n;for(n=t.length-1;n>=0;n--)if(t[n].id===E.get("_id")){t.splice(n,1);break}y.set("participants",t),y.set("status","waiting"),y.upload().then(function(){return x.leave()}).then(function(){y.unsync(),y.reset({})}),g.goToScreen()},g.cancelSession=function(){var t=5e3;y.get("participants").length||(t=2e3),g.displayInfo("deleting",t).then(function(){y.remove(),g.goToScreen()})},g.displayInfo=function(t,n){var r,i=document.querySelector(".sessionmsg"),s=new c,o=function(){i.classList.add("invisible"),clearInterval(r),w.set("msg",""),s.fulfill()};return T.hide(),document.body.removeChild(document.querySelector(".confirm")),i.classList.remove("invisible"),r=setInterval(function(){t!=="deleting"?w.set("msg",t):w.set("msg",S.get("deletingsession")+n/1e3+"s"),n<=0&&o(),n-=1e3},1e3),t==="deleting"&&(y.set("status","deleted"),y.upload().then(function(){x.cancel()})),s},g.goToScreen=function(){var t;k.getAttribute&&k.getAttribute("data-notify_id")?(T.hide(),document.body.removeChild(document.querySelector(".confirm")),v(),u.get("observer").notify("goto-screen","#connect"),document.removeEventListener("mousedown",C.listener,!0),t=k.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(t,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){k===e&&(T.hide(),document.body.removeChild(document.querySelector(".confirm")),v(),u.get("observer").notify("goto-screen",e),document.removeEventListener("mousedown",C.listener,!0))}),b.reset([]),y.reset({})},g.checkUpdate=function(e,t){var n=t.getAttribute("name");e.keyCode===13&&(g.updateSession(n,t.innerHTML),t.blur())},g.updateField=function(e,t){var n=t.getAttribute("name");g.updateSession(n,t.innerHTML)},g.updateSession=function(t,n){y.get(t)!==n&&(y.set(t,n),y.upload())},g.press=function(e,t){t.classList.add("pressed")},g.start=function(e,t){var n=new Date,r=y.get("chat");document.body.removeChild(document.querySelector(".confirm")),x.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),L.spin(t.parentNode),y.set("status","in progress"),y.set("step","musetup"),y.set("startTime",n.getTime()),y.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),r.push(y.get("_id")+"_1"),y.set("chat",r),g.createChat(y.get("chat")[1]).then(function(){return y.upload()}).then(function(){document.removeEventListener("mousedown",C.listener,!0),y.unsync(),L.stop(),t.classList.remove("invisible"),m(y.get("_id"))})},g.createChat=function(t){var r=new n,i=(new Date).getTime(),s=new c;return r.setTransport(u.get("transport")),r.set("users",x.getModel().get("users")),r.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:i}]),r.set("sid",y.get("_id")),r.set("lang",y.get("lang")),r.set("readonly",!1),r.set("step",1),r.set("type",17),r.sync(u.get("db"),t).then(function(){return r.upload()}).then(function(){s.fulfill(),r.unsync()}),s},y.watchValue("status",function(e){e==="deleted"&&y.get("initiator").id!==E.get("_id")&&g.displayInfo(S.get("canceledbyleader"),2e3).then(function(){y.unsync(),v(),document.removeEventListener("mousedown",C.listener,!0)}),e==="in progress"&&y.get("initiator").id!==E.get("_id")&&(document.removeEventListener("mousedown",C.listener,!0),y.unsync(),m(y.get("_id")),y.reset({}),b.reset([]))}),y.watchValue("participants",function(e){b.reset(e)}),g}});