/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,i,n,s,a,l,r,o,d,c,u,g,m,p){return function(n,b){var v,h,f,w=new e,y=new i,L=new t,S=new t({msg:""}),k=r.get("user"),T=r.get("labels"),M=new m,A={listener:null},H=new p({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return y.setTransport(r.get("transport")),w.plugins.addAll({labels:new s(T),model:new s(y,{setTitle:function(e){e&&(this.innerHTML=e),k.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),k.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new g([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},showStartButton:function(e){e&&e.length&&k.get("_id")===y.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new s(L,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new g([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "}}),info:new s(S),place:new l({chat:M}),mubwaitevent:new a(w)}),w.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:touchstart, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: touchstart, press; listen:touchend, start"></div></form><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',w.place(document.getElementById("mubwait")),w.help=function(){o.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},v=new c(document.body,null,null,"musession-confirm"),w.reset=function(e){M.clear(),y.unsync(),y.reset({}),L.reset([]),h=function(e){e?(k.set("sessionInProgress",""),k.upload(),y.get("initiator").id===k.get("_id")?w.cancelSession():w.leaveSession()):v.hide()},A.listener=d.exitListener("mubwait",w.leave),y.sync(r.get("db"),e).then(function(){y.get("initiator").id===k.get("_id")?v.reset(T.get("leaderleave"),h):v.reset(T.get("participantleave"),h),L.reset(y.get("participants")),M.reset(y.get("chat")[0]),k.set("sessionInProgress",{id:e,type:"musession",mode:"join"}),k.upload()})},w.leave=function(e){f=e.getAttribute("href")||e,v.show()},w.leaveSession=function(){var e,t=y.get("participants");for(e=t.length-1;e>=0;e--)if(t[e].id===k.get("_id")){t.splice(e,1);break}y.set("participants",t),y.set("status","waiting"),y.upload().then(function(){return M.leave()}).then(function(){y.unsync(),y.reset({})}),w.goToScreen()},w.cancelSession=function(){var e=5e3;y.get("participants").length||(e=2e3),w.displayInfo("deleting",e).then(function(){y.remove(),w.goToScreen()})},w.displayInfo=function(e,t){var i,n=document.querySelector(".sessionmsg"),s=new u,a=function(){n.classList.add("invisible"),clearInterval(i),S.set("msg",""),s.fulfill()};return v.hide(),document.body.removeChild(document.querySelector(".confirm")),n.classList.remove("invisible"),i=setInterval(function(){"deleting"!==e?S.set("msg",e):S.set("msg",T.get("deletingsession")+t/1e3+"s"),0>=t&&a(),t-=1e3},1e3),"deleting"===e&&(y.set("status","deleted"),y.upload().then(function(){M.cancel()})),s},w.goToScreen=function(){var e;f.getAttribute&&f.getAttribute("data-notify_id")?(v.hide(),document.body.removeChild(document.querySelector(".confirm")),n(),r.get("observer").notify("goto-screen","#connect"),document.removeEventListener("touchstart",A.listener,!0),e=f.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(e,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){f===e&&(v.hide(),document.body.removeChild(document.querySelector(".confirm")),n(),r.get("observer").notify("goto-screen",e),document.removeEventListener("touchstart",A.listener,!0))}),L.reset([]),y.reset({})},w.checkUpdate=function(e,t){var i=t.getAttribute("name");13===e.keyCode&&(w.updateSession(i,t.innerHTML),t.blur())},w.updateField=function(e,t){var i=t.getAttribute("name");w.updateSession(i,t.innerHTML)},w.updateSession=function(e,t){y.get(e)!==t&&(y.set(e,t),y.upload())},w.press=function(e,t){t.classList.add("pressed")},w.start=function(e,t){var i=new Date,n=y.get("chat");document.body.removeChild(document.querySelector(".confirm")),M.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),H.spin(t.parentNode),y.set("status","in progress"),y.set("step","musetup"),y.set("startTime",i.getTime()),y.set("date",[i.getFullYear(),i.getMonth(),i.getDate()]),n.push(y.get("_id")+"_1"),y.set("chat",n),w.createChat(y.get("chat")[1]).then(function(){return y.upload()}).then(function(){document.removeEventListener("touchstart",A.listener,!0),y.unsync(),H.stop(),t.classList.remove("invisible"),b(y.get("_id"))})},w.createChat=function(e){var t=new i,n=(new Date).getTime(),s=new u;return t.setTransport(r.get("transport")),t.set("users",M.getModel().get("users")),t.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:n}]),t.set("sid",y.get("_id")),t.set("lang",y.get("lang")),t.set("readonly",!1),t.set("step",1),t.set("type",17),t.sync(r.get("db"),e).then(function(){return t.upload()}).then(function(){s.fulfill(),t.unsync()}),s},y.watchValue("status",function(e){"deleted"===e&&y.get("initiator").id!==k.get("_id")&&w.displayInfo(T.get("canceledbyleader"),2e3).then(function(){y.unsync(),n(),document.removeEventListener("touchstart",A.listener,!0)}),"in progress"===e&&y.get("initiator").id!==k.get("_id")&&(document.removeEventListener("touchstart",A.listener,!0),y.unsync(),b(y.get("_id")),y.reset({}),L.reset([]))}),y.watchValue("participants",function(e){L.reset(e)}),w}});