/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Amy/Stack-plugin","Bind.plugin","Event.plugin","Amy/Control-plugin","Store","service/avatar","service/actionbar","./addcontact","./addgroup","./contact-detail","./group-detail"],function(e,t,s,n,a,c,r,o,d,u,p,g,v,h){return function(){var m,b,f,w=new e,y=new n,L=new p,k=new g,S=new v,T=new h,x=new o([{name:"all",label:"allbtn",selected:!0},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),q=0,M=new o([]),A=s.get("user"),C=s.get("labels"),I=function(e){var t=x.get(e).name,s=A.get("connections"),n=s.length,a=[];switch(t){case"users":for(i=0;n>i;i++)"user"===s[i].type&&a.push(s[i]);break;case"groups":for(i=0;n>i;i++)"group"===s[i].type&&a.push(s[i]);break;default:a=s}return a},H=function(e){var t=[],s=[];if(t=A.get("connections").concat(),""===e)s=t,x.update(0,"selected",!0),q=0;else for(i=0,l=t.length;l>i;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&s.push(t[i]);return s};return w.plugins.addAll({label:new a(C),sort:new a(x,{setLabel:function(e){this.innerHTML=C.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),contact:new a(M,{setAvatar:function(e){var t,s,i=this.getAttribute("data-contact_id");"group"===e?(this.hasChildNodes()&&this.removeChild(this.firstChild),this.setAttribute("style","background: url('img/connect/"+M.get(i).color+"') no-repeat center center; background-size: contain;display:block; width:40px; height:40px;float:left;")):"user"===e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),s=new d([M.get(i).userid]),s.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "}}),contactdetailstack:y,contactlistcontrol:new r(w),contactlistevent:new c(w)}),w.template='<div id="connect-contacts"><div class="contacts"><div class="header blue-light"><span data-label="bind: innerHTML, contactlistheadertitle">My Contacts</span><div class="option right" data-contactlistevent="listen: touchstart, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-contactlistevent="listen:touchstart, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-contactlistevent="listen: keypress, search"><div class="contactlist overflow" data-contactlistcontrol="radio:li,selected,touchstart,selectContact"><ul data-contact="foreach"><li class="contact list-item" data-contactlistevent="listen:touchstart, setStart; listen:touchmove, showActionBar"><div data-contact="bind:setAvatar, type"></div><p class="contact-name" data-contact="bind:innerHTML, username"></p><p class="contact-intro" data-contact="bind:setIntro, intro"></p><div class="select-contact"></div></li></ul></div></div><div id="toggleadd" class="group" data-contactlistevent="listen:touchstart, press; listen:touchend, toggleAddUI"></div><div id="contact-detail" class="details" data-contactdetailstack="destination"></div></div>',w.place(t.get("connect-contacts")),w.plus=function(){var e=document.getElementById("toggleadd");y.getStack().get("#addcontact").reset(),y.getStack().show("#addcontact"),e.classList.contains("user")&&e.classList.remove("user"),e.classList.add("group")},w.init=function(){M.reset(A.get("connections")),L.init().then(function(){y.getStack().show("#addcontact")}),k.init(),T.init()},w.reset=function(){M.reset(A.get("connections")),L.reset(),y.getStack().show("#addcontact"),f&&f.hide()},w.getSelectedContact=function(){var e=document.querySelector(".contact.selected"),t=-1;return e&&(t=e.getAttribute("data-contact_id")),t},w.selectContact=function(e){var t=e.target.getAttribute("data-contact_id"),s=M.get(t);document.getElementById("toggleadd").classList.remove("group"),document.getElementById("toggleadd").classList.remove("user"),"user"===s.type?(S.reset(M.get(t)),"#contactdetails"!==y.getStack().getCurrentName()&&y.getStack().show("#contactdetails")):(T.reset(M.get(t)),"#groupdetails"!==y.getStack().getCurrentName()&&y.getStack().show("#groupdetails"))},w.displaySort=function(e,t){var s=t.getAttribute("data-sort_id");M.reset([]),q>-1&&x.update(q,"selected",!1),x.update(s,"selected",!0),q=s,M.reset(I(s))},w.search=function(e,t){13===e.keyCode&&(x.update(q,"selected",!1),q=-1,M.reset(H(t.value)))},w.setStart=function(e){m=[e.pageX,e.pageY],f&&(f.hide(),f=null)},w.showActionBar=function(e,t){var s,i=t.getAttribute("data-contact_id"),n=!1;b=[e.pageX,e.pageY],f&&f.getParent()===t&&(n=!0),!n&&m[0]-b[0]>40&&b[1]-m[1]<20&&b[1]-m[1]>-20&&(f=new u("contact",t,M.get(i)),s=document.createDocumentFragment(),f.place(s),t.appendChild(s))},w.press=function(e,t){t.classList.add("pressed")},w.toggleAddUI=function(e,t){t.classList.remove("pressed"),t.classList.contains("group")?(t.classList.remove("group"),y.getStack().get("#addgroup").reset(),y.getStack().show("#addgroup"),t.classList.add("user")):(t.classList.remove("user"),y.getStack().get("#addcontact").reset(),y.getStack().show("#addcontact"),t.classList.add("group"))},y.getStack().add("#contactdetails",S),y.getStack().add("#groupdetails",T),y.getStack().add("#addcontact",L),y.getStack().add("#addgroup",k),k.init(),w.init(),A.watchValue("connections",function(){var e;q>-1&&M.reset(I(q)),"#contactdetails"===y.getStack().getCurrentName()&&(e=w.getSelectedContact(),e>-1?(contactDetail.reset(M.get(e)),y.getStack().show("#contactdetails")):(y.getStack().show("#addcontact"),document.getElementById("toggleadd").classList.add("group")))}),s.get("observer").watch("contact-deleted",function(){y.getStack().show("#addcontact")}),A.watchValue("lang",function(){var e;x.loop(function(t,s){t.selected&&(e=s)}),x.reset([{name:"all",label:"allbtn",selected:!1},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),x.update(e,"selected",!0)}),w}});