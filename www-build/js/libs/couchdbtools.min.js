define("CouchDBSecurity",["CouchDBStore"],function(t){function n(){var e="_security";this.setName=function(n){return n?(e=n,!0):!1},this.getName=function(){return e},this.load=function(n){return this.sync(n,e)}}return function(){return n.prototype=new t,new n}}),define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(t,n,r,i){function s(){var e="CouchDB",t=null,s={},o=new i,u={getView:function(){s.query=s.query||{},t.request(e,{method:"GET",path:"/"+s.database+"/_design/"+s.design+"/"+s.view,query:s.query},function(e){var t=JSON.parse(e);if(!t.rows)throw new Error("CouchDBStore ["+s.database+", "+s.design+", "+s.view+"].sync() failed: "+e);this.reset(t.rows),typeof t.total_rows=="undefined"&&this.setReducedViewInfo(!0),f.event("subscribeToViewChanges")},this)},getDocument:function(){t.request(e,{method:"GET",path:"/"+s.database+"/"+s.document,query:s.query},function(e){var t=JSON.parse(e);t._id?(this.reset(t),f.event("subscribeToDocumentChanges")):o.reject(e)},this)},getBulkDocuments:function(){var n={path:"/"+s.database+"/_all_docs",query:s.query},r;s.keys instanceof Array?(n.method="POST",n.data=JSON.stringify({keys:s.keys}),n.headers={"Content-Type":"application/json"},r=n.data):(n.method="GET",r=JSON.stringify(s.query)),s.query.include_docs=!0,t.request(e,n,function(e){var t=JSON.parse(e);if(!t.rows)throw new Error('CouchDBStore.sync("'+s.database+'", '+r+") failed: "+e);this.reset(t.rows),f.event("subscribeToBulkChanges")},this)},createDocument:function(n){t.request(e,{method:"PUT",path:"/"+s.database+"/"+s.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(e){var t=JSON.parse(e);t.ok?f.event("subscribeToDocumentChanges"):n.reject(t)})},subscribeToViewChanges:function(){r.mixin({feed:"continuous",heartbeat:1e4,descending:!0},s.query),this.stopListening=t.listen(e,{path:"/"+s.database+"/_changes",query:s.query},function(e){if(e=="\n")return!1;var t=JSON.parse(e),n;s.reducedView?n="updateReduced":t.deleted?n="delete":t.changes&&t.changes[0].rev.search("1-")==0?n="add":n="change",f.event(n,t.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=t.listen(e,{path:"/"+s.database+"/_changes",query:{feed:"continuous",heartbeat:1e4,descending:!0}},function(e){var t;if(e=="\n")return!1;t=JSON.parse(e),t.id==s.document&&t.changes.pop().rev!=this.get("_rev")&&(t.deleted?f.event("deleteDoc"):f.event("updateDoc"))},this)},subscribeToBulkChanges:function(){r.mixin({feed:"continuous",heartbeat:1e4,descending:!0,include_docs:!0},s.query),this.stopListening=t.listen(e,{path:"/"+s.database+"/_changes",query:s.query},function(e){var t;if(e=="\n")return!1;var t=JSON.parse(e),n;t.changes[0].rev.search("1-")==0?n="bulkAdd":t.deleted?n="delete":n="bulkChange",f.event(n,t.id,t.doc)},this)},updateDocInStore:function(n){t.request(e,{method:"GET",path:"/"+s.database+"/_design/"+s.design+"/"+s.view,query:s.query},function(e){var t=JSON.parse(e);t.rows.length==this.getNbItems()?t.rows.some(function(e,t){e.id==n&&this.set(t,e)},this):this.actions.evenDocsInStore.call(this,t.rows,n)},this)},evenDocsInStore:function(e,t){var n=this.getNbItems();e.length<n?this.loop(function(e,n){e.id==t&&this.del(n)},this):e.length>n&&e.some(function(e,n){if(e.id==t)return this.alter("splice",n,0,e)},this)},addBulkDocInStore:function(n){if(!s.query.startkey&&!s.query.endkey)return!1;s.query.include_docs=!0,s.query.update_seq=!0,t.request(e,{method:"GET",path:"/"+s.database+"/_all_docs",query:s.query},function(e){var t=JSON.parse(e);t.rows.forEach(function(e,t){e.id==n&&this.alter("splice",t,0,e.doc)},this)},this)},updateBulkDocInStore:function(e,t){this.loop(function(n,r){n.id==e&&this.set(r,t)},this)},removeDocInStore:function(e){this.loop(function(t,n){t.id==e&&this.del(n)},this)},addDocInStore:function(n){t.request(e,{method:"GET",path:"/"+s.database+"/_design/"+s.design+"/"+s.view,query:s.query},function(e){var t=JSON.parse(e);t.rows.some(function(e,t){e.id==n&&this.alter("splice",t,0,e)},this)},this)},updateReduced:function(){t.request(e,{method:"GET",path:"/"+s.database+"/_design/"+s.design+"/"+s.view,query:s.query},function(e){var t=JSON.parse(e);this.set(0,t.rows[0])},this)},updateDoc:function(){t.request(e,{method:"GET",path:"/"+s.database+"/"+s.document},function(e){this.reset(JSON.parse(e))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(n){t.request(e,{method:"PUT",path:"/"+s.database+"/"+s.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(e){var t=JSON.parse(e);t.ok?(this.set("_rev",t.rev),n.resolve(t)):(console.log("DOCUMENT UPLOAD FAILED",this.toJSON()),n.reject(t))},this)},updateDatabaseWithBulkDoc:function(n){var r=[];this.loop(function(e){r.push(e.doc)}),t.request(e,{method:"POST",path:"/"+s.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:r})},function(e){n.resolve(JSON.parse(e))})},removeFromDatabase:function(){t.request(e,{method:"DELETE",path:"/"+s.database+"/"+s.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening(),delete this.stopListening}},f=new n("Unsynched",{Unsynched:[["getView",u.getView,this,"Synched"],["getDocument",u.getDocument,this,"Synched"],["getBulkDocuments",u.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",u.createDocument,this],["subscribeToViewChanges",u.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",u.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",u.subscribeToBulkChanges,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["entry",function(){o.resolve(this)}],["change",u.updateDocInStore,this],["bulkAdd",u.addBulkDocInStore,this],["bulkChange",u.updateBulkDocInStore,this],["delete",u.removeDocInStore,this],["add",u.addDocInStore,this],["updateReduced",u.updateReduced,this],["updateDoc",u.updateDoc,this],["deleteDoc",u.deleteDoc,this],["updateDatabase",u.updateDatabase,this],["updateDatabaseWithBulkDoc",u.updateDatabaseWithBulkDoc,this],["removeFromDatabase",u.removeFromDatabase,this],["unsync",u.unsync,this,"Unsynched"]]});this.sync=function(){return o=new i,typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]=="string"?(this.setSyncInfo(arguments[0],arguments[1],arguments[2],arguments[3]),f.event("getView"),o):typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]!="string"?(this.setSyncInfo(arguments[0],arguments[1],arguments[2]),f.event("getDocument"),o):typeof arguments[0]=="string"&&arguments[1]instanceof Object?(this.setSyncInfo(arguments[0],arguments[1]),f.event("getBulkDocuments"),o):!1},this.setSyncInfo=function(){return this.clearSyncInfo(),typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]=="string"?(s.database=arguments[0],s.design=arguments[1],s.view=arguments[2],s.query=arguments[3],!0):typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]!="string"?(s.database=arguments[0],s.document=arguments[1],s.query=arguments[2],!0):typeof arguments[0]=="string"&&arguments[1]instanceof Object?(s.database=arguments[0],s.query=arguments[1],s.query.keys instanceof Array&&(s.keys=s.query.keys,delete s.query.keys),!0):!1},this.clearSyncInfo=function(){return s={},!0},this.setReducedViewInfo=function(t){return typeof t=="boolean"?(s.reducedView=t,!0):!1},this.getSyncInfo=function(){return s},this.unsync=function(){return f.event("unsync")},this.upload=function(){var t=new i;return s.document?(f.event("updateDatabase",t),t):s.view?!1:(f.event("updateDatabaseWithBulkDoc",t),t)},this.remove=function(){return s.document?f.event("removeFromDatabase"):!1},this.setTransport=function(n){return n&&typeof n.listen=="function"&&typeof n.request=="function"?(t=n,!0):!1},this.getStateMachine=function(){return f},this.getTransport=function(){return t},this.actions=u}return function(n){return s.prototype=new t(n),new s}}),define("CouchDBUser",["CouchDBStore","Promise"],function(t,n){function r(){var e="_users",t="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(n){return n?(e=n,!0):!1},this.getIdPrefix=function(){return t},this.setIdPrefix=function(n){return n?(t=n,!0):!1},this.setId=function(n){return n?(this.set("_id",t+n),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(r){return this.sync(e,t+r)},this.login=function(){var t=new n,r=this.get("name"),i=this.get("password");return r&&typeof r=="string"&&typeof i=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+r,auth:r+":"+i},t.resolve,t):t.reject({error:"name & password must be strings"}),t},this.create=function(){var t=new n;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.load(this.get("name")).then(function(){t.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(e){t.resolve(e)},function(e){t.reject(e)})},this),t}}return function(){return r.prototype=new t,new r}});