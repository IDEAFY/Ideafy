/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min","service/utils"],function(e,t,n,i,s,a,r,o){return function(t){var c,l=new e,d=new a({}),u=s.get("user"),p=new a(s.get("userLanguages")),g=function(){var e=u.get("lang").substring(0,2);d.set("default_lang",e),p.loop(function(t,n){t.name===e?p.update(n,"selected",!0):p.update(n,"selected",!1)})},h=(s.get("transport"),s.get("labels")),f=new a({error:""}),m=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin(),v=60,b=60,w=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=v/t,t=v):(t*=b/n,n=b),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},y=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),r=a.getContext("2d"),o=v,c=b;s.src=e,setTimeout(function(){a.width=o,a.height=c,n=Math.floor(Math.max(0,(s.width-o)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),r.drawImage(s,n,i,o,c,0,0,o,c),t(a.toDataURL("image/png"))},300)},k=function(){var e="/upload",t=new FormData,n="deckpic",i="decks",s=c;t.append("type",n),t.append("dir",i),t.append("filename",d.get("_id")),t.append("dataString",s),o.uploadFile(e,t,null,function(e){console.log(e)})};return d.setTransport(s.get("transport")),g(),l.plugins.addAll({newdeck:new n(d,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),select:new n(p,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new n(h),errormsg:new n(f,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new i(l)}),l.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:touchstart, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newdeck="bind: displayLang, default_lang" data-newdeckevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newdeckevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend data-labels="bind: innerHTML, setdecklogo"></legend><div class="deckicon"><div class="decklogo"></div><div class="importbutton" data-newdeckevent="listen: touchstart, press; listen:touchend, picturePreview" data-labels="bind:innerHTML, importpiclbl"></div></div><div class=""><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>',l.reset=function(){d.reset({_id:"",type:9,description:"",default_lang:u.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:u.get("_id"),author:u.get("username"),"public":!1,sharedwith:[]}),c=null},l.show=function(){l.reset(),document.getElementById("cache").classList.add("appear"),l.dom.classList.add("appear")},l.press=function(e,t){t.classList.add("pressed")},l.showLang=function(){l.dom.querySelector(".idealang ul").classList.remove("invisible")},l.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),p.loop(function(e,t){n===t?p.update(t,"selected",!0):p.update(t,"selected",!1)})},l.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),d.set("default_lang",p.get(n).name),l.dom.querySelector(".idealang ul").classList.add("invisible")},l.picturePreview=function(e,t){var n,i,s=navigator.camera.PictureSourceType.PHOTOLIBRARY,a=new Image,r={quality:50,correctOrientation:!0,sourceType:s};n=function(e){a.src=e,setTimeout(function(){y(w(a),function(e){var n=l.dom.querySelector(".decklogo");n.setAttribute("style","background-image: url('"+e+"')"),c=e,d.set("picture_file","decklogo"),t.classList.remove("pressed")})},750)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(n,i,r)},l.closePopup=function(){l.dom.classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),d.unsync(),l.reset(),f.reset({error:""})},l.resetError=function(e,t){var n;t.scrollTop=99999,f.get("error")&&(n=t.classList.contains("description")?"nodesc":t.classList.contains("solution")?"nosol":"notitle",f.get("error")===n&&t.value&&f.set("error",""))},l.cancel=function(){l.closePopup()},l.upload=function(e,n){var i=new Date,a="D:"+i.getTime();n.classList.remove("pressed"),d.get("title")?d.get("description")||f.set("error","nodesc"):f.set("error","notitle"),f.get("error")||d.get("_id")||(n.classList.add("invisible"),m.spin(n.parentNode),d.set("_id",a),d.set("date",[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()]),d.sync(s.get("db"),a).then(function(){return d.get("picture_file")&&k(),d.upload()}).then(function(){t("new",a);var e=u.get("custom_decks")||[];return e.unshift(a),u.set("custom_decks",e),u.upload()}).then(function(){m.stop(),n.classList.remove("invisible"),l.closePopup()}))},l.reset(),l}});