/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,i,s,a,r,o,c){return function(l){var d,u=new e,p=new i,g=new n(r.get("userLanguages")),h=function(){g.loop(function(e,t){p.get("lang")&&e.name===p.get("lang").substring(0,2)?g.update(t,"selected",!0):g.update(t,"selected",!1)})},f=r.get("labels"),v=new n({error:""});return p.setTransport(r.get("transport")),u.plugins.addAll({editlabel:new s(f),editidea:new s(p,{displayLang:function(e){var t;e&&(t=e.substring(0,2),this.setAttribute("style","background-image:url('img/flags/"+t+".png');"))},setVisibility:function(e){this.innerHTML="public"===e?f.get("publiclbl"):f.get("privatelbl")},hideVisibility:function(e){"public"===e?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){"public"===e?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 19px 16px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){e&&-1===e.search("deleted")?this.setAttribute("style","display:inline-block"):this.setAttribute("style","display:none")},setIdeafyStatus:function(e){this.innerHTML=e?f.get("enabledreplaylbl"):f.get("disabledreplaylbl")},setSessionReplay:function(e){this.innerHTML=e?f.get("disablereplaylbl"):f.get("enablereplaylbl")}}),select:new s(g,{setBg:function(e){e&&this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),editevent:new a(u),errormsg:new s(v,{setError:function(e){switch(e){case"notitle":this.innerHTML=f.get("titlefield")+f.get("emptyfielderror");break;case"nodesc":this.innerHTML=f.get("descriptionfield")+f.get("emptyfielderror");break;case"nosol":this.innerHTML=f.get("solutionfield")+f.get("emptyfielderror");break;default:this.innerHTML=""}}})}),u.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl"></span></div><form class="form"><div class="idealang"><div class="currentlang" data-editidea="bind: displayLang, lang" data-editevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:touchstart, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:touchstart, press; listen:touchend, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editlabel="bind:innerHTML, publishlbl" data-editevent="listen:touchstart, press;listen:touchend, upload"></label><label class="cancel pressed-btn" data-editlabel="bind:innerHTML, cancellbl" data-editevent="listen:touchstart, press;listen:touchend, cancel"></label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',u.place(t.get("library-edit")),u.reset=function(e){p.unsync(),p.reset(),p.sync(r.get("db"),e).then(h),d=!1},u.showLang=function(){u.dom.querySelector(".idealang ul").classList.remove("invisible")},u.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),g.loop(function(e,t){n===t?g.update(t,"selected",!0):g.update(t,"selected",!1)})},u.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),p.set("lang",g.get(n).name),u.dom.querySelector(".idealang ul").classList.add("invisible")},u.editVisibility=function(e,t){var n=new o(t,f.get("setpublicquestion"),function(e){e?p.set("visibility","public"):p.set("visibility","private"),n.close()})},u.press=function(e,t){t.classList.add("pressed")},u.enableReplay=function(e,t){setTimeout(function(){p.get("sessionReplay")?p.set("sessionReplay",!1):p.set("sessionReplay",!0),d=!0,t.classList.remove("pressed")},300)},u.updateSessionReplay=function(e){var t=new c,n=new i;return n.setTransport(r.get("transport")),n.sync(r.get("db"),p.get("sessionId")).then(function(){var i,s=n.get("replayIdeas")||[];if(e)s.push(p.get("_id"));else for(i=s.length-1;i>=0;i--)s[i]===p.get("_id")&&s.splice(i,1);n.set("replayIdeas",s),n.upload().then(function(){t.fulfill(),n.unsync()})}),t},u.upload=function(e,t){var n=new Date,i=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];""===p.get("title")?v.set("error","notitle"):""===p.get("description")?v.set("error","nodesc"):""===p.get("solution")?v.set("error","nosol"):(p.set("modification_date",i),p.upload().then(function(){d&&u.updateSessionReplay(p.get("sessionReplay")).then(null,function(e){console.log(e)}),u.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")})),t.classList.remove("pressed")},u.cancel=function(e,t){t.classList.remove("pressed"),u.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")},u}});