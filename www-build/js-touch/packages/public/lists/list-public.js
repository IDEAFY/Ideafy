/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h=n.get("user"),p,d,v=null,m={db:e,view:f,design:o,query:{descending:!0,limit:50}},g=this;c.setTransport(n.get("transport")),l&&(m.query=l),g.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:touchstart, setStart; listen:touchmove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:innerHTML,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul></div>",m.query.q&&(g.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:touchstart, setStart; listen:touchmove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div><h2 data-listideas='bind:innerHTML,doc.authornames'></h2><span class='date' data-listideas='bind:date,doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3><p data-listideas='bind:setDesc,doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, rating'></span> </div></li></ul></div>"),g.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function y(y){y&&(this.innerHTML=s.formatDate(y))},setDesc:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>"))},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=c.get(n).doc.votes||[];r.length===0?this.innerHTML="":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=t},setAvatar:function(t){var n,r}}),listevent:new i(this)}),g.getModel=function(){return c},g.resetQuery=function(e){var t=new a,r=h.get("public-favorites")||[],i={idList:r},s=g.dom.querySelector(".noresult");return m.query=e,c.unsync(),c.reset([]),l==="fav"&&r.length?n.get("transport").request("GetFavList",i,function(n){var r=JSON.parse(n),i,o,u;if(!e||e==="*")c.reset(r);else for(i=0,o=r.length;i<o;i++)u=r[i].value.doc.lang.substring(0,2),e===u&&c.alter("push",r[i]);c.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),t.fulfill()}):c.sync(m.db,m.design,m.view,m.query).then(function(){v&&v.hide(),c.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),t.fulfill()}),t},g.setLang=function(e){return l==="fav"?g.resetQuery(e):e==="*"?g.resetQuery({startkey:"[0,{}]",endkey:"[0]",descending:!0,limit:50}):g.resetQuery({startkey:'[1,"'+e+'", {}]',endkey:'[1,"'+e+'"]',descending:!0,limit:50})},g.setStart=function(e,t){p=[e.pageX,e.pageY],v&&(v.hide(),v=null)},g.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r,i=!1;d=[e.pageX,e.pageY],v&&v.getParent()===t&&(i=!0),!i&&p[0]-d[0]>40&&d[1]-p[1]<20&&d[1]-p[1]>-20&&(v=new u("idea",t,c.get(n).id),r=document.createDocumentFragment(),v.place(r),t.appendChild(r))},g.init=function(){var t=new a,r=h.get("public-favorites")||[],i={idList:r},s=g.dom.querySelector(".noresult");return l==="fav"?r.length?n.get("transport").request("GetFavList",i,function(e){c.reset(JSON.parse(e)),s.classList.add("invisible"),t.fulfill()}):(c.reset([]),s.classList.remove("invisible"),t.fulfill()):c.sync(m.db,m.design,m.view,m.query).then(function(){c.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),t.fulfill()}),t}}return function(n,r,i,s){return f.prototype=new e,new f(n,r,i,s)}});