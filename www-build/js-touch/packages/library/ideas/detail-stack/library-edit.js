/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new r,p=new n(o.get("userLanguages")),d=function(){p.loop(function(e,t){h.get("lang")&&e.name===h.get("lang").substring(0,2)?p.update(t,"selected",!0):p.update(t,"selected",!1)})},v=o.get("labels"),m=new n({error:""}),g;return h.setTransport(o.get("transport")),c.plugins.addAll({editlabel:new i(v),editidea:new i(h,{displayLang:function(e){var t;e&&(t=e.substring(0,2),this.setAttribute("style","background-image:url('img/flags/"+t+".png');"))},setVisibility:function(e){e==="public"?this.innerHTML=v.get("publiclbl"):this.innerHTML=v.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 19px 16px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=v.get("enabledreplaylbl"):this.innerHTML=v.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=v.get("disablereplaylbl"):this.innerHTML=v.get("enablereplaylbl")}}),select:new i(p,{setBg:function(e){e&&this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),editevent:new s(c),errormsg:new i(m,{setError:function(e){switch(e){case"notitle":this.innerHTML=v.get("titlefield")+v.get("emptyfielderror");break;case"nodesc":this.innerHTML=v.get("descriptionfield")+v.get("emptyfielderror");break;case"nosol":this.innerHTML=v.get("solutionfield")+v.get("emptyfielderror");break;default:this.innerHTML=""}}})}),c.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl"></span></div><form class="form"><div class="idealang"><div class="currentlang" data-editidea="bind: displayLang, lang" data-editevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:touchstart, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:touchstart, press; listen:touchend, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editlabel="bind:innerHTML, publishlbl" data-editevent="listen:touchstart, press;listen:touchend, upload"></label><label class="cancel pressed-btn" data-editlabel="bind:innerHTML, cancellbl" data-editevent="listen:touchstart, press;listen:touchend, cancel"></label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',c.place(t.get("library-edit")),c.reset=function(t){h.unsync(),h.reset(),h.sync(o.get("db"),t).then(d),g=!1},c.showLang=function(e,t){c.dom.querySelector(".idealang ul").classList.remove("invisible")},c.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),p.loop(function(e,t){n===t?p.update(t,"selected",!0):p.update(t,"selected",!1)})},c.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),h.set("lang",p.get(n).name),c.dom.querySelector(".idealang ul").classList.add("invisible")},c.editVisibility=function(e,t){var n=new u(t,v.get("setpublicquestion"),function(e){e?h.set("visibility","public"):h.set("visibility","private"),n.close()})},c.press=function(e,t){t.classList.add("pressed")},c.enableReplay=function(e,t){setTimeout(function(){h.get("sessionReplay")?h.set("sessionReplay",!1):h.set("sessionReplay",!0),g=!0,t.classList.remove("pressed")},300)},c.updateSessionReplay=function(t){var n=new a,i=new r;return i.setTransport(o.get("transport")),i.sync(o.get("db"),h.get("sessionId")).then(function(){var e=i.get("replayIdeas")||[],r;if(t)e.push(h.get("_id"));else for(r=e.length-1;r>=0;r--)e[r]===h.get("_id")&&e.splice(r,1);i.set("replayIdeas",e),i.upload().then(function(){n.fulfill(),i.unsync()})}),n},c.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];h.get("title")===""?m.set("error","notitle"):h.get("description")===""?m.set("error","nodesc"):h.get("solution")===""?m.set("error","nosol"):(h.set("modification_date",r),h.upload().then(function(){g&&c.updateSessionReplay(h.get("sessionReplay")).then(null,function(e){console.log(e)}),c.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")})),t.classList.remove("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),c.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")},c}});