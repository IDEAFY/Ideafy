/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBView","CouchDBDocument","Store","service/utils","service/avatarlist","service/confirm","lib/spin.min","Promise"],function(e,t,n,s,a,r,o,c,l,d,u,p,g){return function(){var h,v,f=new e,m=(new e,t.get("sessions")),b=new c,y=a.get("db"),w=a.get("transport"),L=a.get("user"),k=(a.get("avatars"),a.get("labels")),S=new c({}),T="sbydate",M=[],x=[],C="",A=new r,q=new p({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330}).spin();return A.setTransport(w),f.plugins.addAll({label:new n(k),sort:new n(S,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(b,{setMode:function(e){switch(e){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');")}},formatDate:function(e){e&&e.length&&(this.innerHTML=l.formatDate(e))},formatIdeas:function(e){if(e&&1===e.length)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=k.get("noideayet")},setAvatars:function(e){var t,i;e&&(t=new d(e),i=document.createDocumentFragment(),node=this,t.place(i),node.hasChildNodes()?node.replaceChild(i,node.firstChild):node.appendChild(i))},setStatus:function(e){this.innerHTML="completed"===e?k.get("completed"):k.get("inprogress")},setScore:function(e){this.innerHTML=e>=0?e:""},setSuffix:function(e){this.innerHTML=void 0===e||""===e||null===e?k.get("noscore"):"ip"}}),sortevent:new s(f),sessionevent:new s(f)}),f.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: touchstart, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: touchstart, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: touchstart, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: touchstart, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen:touchstart, setStart; listen: touchmove, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: touchend, hideActionBar"><div class="replaysession" name="replay" data-sessionevent="listen: touchstart, press; listen:touchend, replay"></div><div class="deletesession" name="delete" data-sessionevent="listen: touchstart, press; listen:touchend, deleteSession"></div></div></li></ul></div></div></div>',f.sort=function(e,t){var i=t.getAttribute("id");S.get(i).selected?S.set(i,{selected:!0,descending:!S.get(i).descending}):(S.set(T,{selected:!1,descending:S.get(T).descending}),S.set(i,{selected:!0,descending:S.get(i).descending}),T=i),f.sortSessions(i)},f.sortSessions=function(e){var t;if(t=C?x:M,t.length)switch(e){case"sbytitle":l.sortByProperty(t,"title",S.get("sbytitle").descending);break;case"sbydate":l.sortByProperty(t,"date",S.get("sbydate").descending);break;case"sbyidea":l.sortByProperty(t,"idea",S.get("sbyidea").descending);break;case"sbyscore":l.sortByProperty(t,"score",S.get("sbyscore").descending)}b.reset(t)},f.acceptinput=function(e,t){t.removeAttribute("readonly")},f.search=function(e,t){var i=document.getElementById("sessionsearchresult");i.innerHTML="",13===e.keyCode&&(C=t.value,""===C?(f.sortSessions(T),b.reset(M)):(x=l.searchArray(M,C),i.innerHTML=k.get("foundlbl")+" "+x.length+" "+k.get("matchingsessions"),b.reset(x)))},f.setStart=function(e){h=[e.pageX,e.pageY]},f.displayActionBar=function(e,t){var i=t.getAttribute("data-sessions_id"),n=t.offsetHeight,s=b.get(i);v=[e.pageX,e.pageY],h[0]-v[0]>40&&v[1]-h[1]<20&&v[1]-h[1]>-20&&(t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+n+"px;height: "+n+"px;"),s.participants.length>1||s.participants[0]!=L.get("_id")||s.id===L.get("sessionInProgress").id?t.querySelector(".deletesession").setAttribute("style","display: none;"):t.querySelector(".deletesession").setAttribute("style","display: inline-block;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3))},f.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},f.press=function(e,t){var i=t.getAttribute("data-sessions_id");t.classList.add("pressed"),i&&q.spin(document.getElementById("sessionlistspinner"))},f.replay=function(e,t){var i=t.getAttribute("data-sessions_id"),n=b.get(i).id,s=b.get(i).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),q.stop(),a.get("observer").notify("replay-session",n,s)},f.deleteSession=function(e,t){var i,n=t.getAttribute("data-sessions_id"),s=b.get(n).id,a=function(e){var t=new o,i=new g;return t.setTransport(w),t.sync(y,e).then(function(){var e=t.get("replayIdeas")||[];e.forEach(function(e){var t=new o;t.setTransport(w),t.sync(y,e).then(function(){return t.set("sessionId",t.get("sessionId")+"_deleted"),t.set("sessionReplay",!1),t.upload()}).then(function(){t.unsync()},function(e){console.log(e)})}),w.request("cleanUpSession",s,function(e){e.err&&console.log(e.err),t.remove().then(function(){t.unsync(),i.fulfill()})})}),i},r=k.get("deletereplay"),c=function(e){e?(q.spin(document.getElementById("sessionlistspinner")),a(s).then(function(){q.stop(),i.close()})):i.close()};t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;"),b.get(n).replayIdeas&&b.get(n).replayIdeas.length?(q.stop(),i=new u(document.getElementById("session-list"),r,c),i.show()):a(s).then(function(){q.stop()})},f.resetSessionData=function(){M=[],A.loop(function(e){var t={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode,replayIdeas:e.value.replayIdeas};for(t.participants.push(e.value.initiator.id),t.usernames.push(e.value.initiator.username),j=0;j<e.value.participants.length;j++)t.participants.push(e.value.participants[j].id),t.usernames.push(e.value.participants[j].username);t.idea&&t.idea.length>1&&l.sortByProperty(t.idea,"title",!1),M.push(t)}),f.sortSessions("sbydate")},f.getMode=function(e){var t;return A.loop(function(i){i.id===e&&(t=i.value.mode)}),t},f.place(m),f.reset=function(){A.unsync(),A.reset(),b.reset([]),S.reset({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),T="sbydate",M=[],x=[],C="",A.sync(y,"library","_view/sessions",{key:'"'+L.get("_id")+'"',descending:!0}).then(function(){f.resetSessionData()})},["added","deleted","updated"].forEach(function(e){A.watch(e,function(){f.resetSessionData(),f.sortSessions(T)})}),f.reset(),f}});