/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","CouchDBView","Store","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,i,n,s,a,r,o,c,l){function d(e,i,o,d){var u,p,g,h=new t([]),v=null,m=n.get("user"),b={db:e,view:o,design:i,query:{descending:!0,limit:50}},f=this;d&&(b.query=d),this.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:touchstart, setStart; listen:touchmove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:setDesc,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul></div>",this.plugins.addAll({labels:new s(n.get("labels")),listideas:new s(h,{date:function(e){this.innerHTML=r.formatDate(e)},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(e){if(void 0===e){var t=this.getAttribute("data-listideas_id"),i=h.get(t).doc.votes||[];this.innerHTML=0===i.length?"":Math.round(100*(i.reduce(function(e,t){return e+t})/i.length))/100}else this.innerHTML=e},setAvatar:function(){}}),listevent:new a(this)}),this.getModel=function(){return h},f.resetQuery=function(e){var i=new l,s=m.get("settings").polling_interval||n.get("polling_interval"),a=new t,r=f.dom.querySelector(".noresult");return e&&(b.query=e),clearInterval(g),a.setTransport(n.get("transport")),a.sync(b.db,b.design,b.view,b.query).then(function(){v&&v.hide(),h.reset(JSON.parse(a.toJSON())),h.getNbItems()?r.classList.add("invisible"):r.classList.remove("invisible"),a.unsync(),g=setInterval(function(){a.reset([]),a.sync(b.db,b.design,b.view,b.query).then(function(){v&&v.hide(),h.reset(JSON.parse(a.toJSON())),h.getNbItems()?r.classList.add("invisible"):r.classList.remove("invisible"),a.unsync()})},s),i.fulfill()}),i},this.setLang=function(e){return"*"===e?f.resetQuery({startkey:"[0,{}]",endkey:"[0]",descending:!0,limit:50}):f.resetQuery({key:'[1,"'+e+'"]',descending:!0,limit:50})},this.setStart=function(e){u=[e.pageX,e.pageY],v&&(v.hide(),v=null)},this.showActionBar=function(e,t){var i,n=t.getAttribute("data-listideas_id"),s=(document.getElementById("public"),!1);p=[e.pageX,e.pageY],v&&v.getParent()===t&&(s=!0),!s&&u[0]-p[0]>40&&p[1]-u[1]<20&&p[1]-u[1]>-20&&(v=new c("idea",t,h.get(n).id),i=document.createDocumentFragment(),v.place(i),t.appendChild(i))},this.init=function(){var e=new l,i=m.get("settings").polling_interval||n.get("polling_interval"),s=new t,a=f.dom.querySelector(".noresult");return s.setTransport(n.get("transport")),s.sync(b.db,b.design,b.view,b.query).then(function(){h.reset(JSON.parse(s.toJSON())),h.getNbItems()?a.classList.add("invisible"):a.classList.remove("invisible"),s.unsync(),g=setInterval(function(){s.reset([]),s.sync(b.db,b.design,b.view,b.query).then(function(){h.reset(JSON.parse(s.toJSON())),h.getNbItems()?a.classList.add("invisible"):a.classList.remove("invisible"),s.unsync()})},i),e.fulfill()}),e},m.watchValue("settings",function(){var e,i=new t,s=f.dom.querySelector(".noresult");m.get("settings").polling_interval!==n.get("polling_interval")&&(n.set("polling_interval",m.get("settings").polling_interval),e=n.get("polling_interval"),clearInterval(g),i.setTransport(n.get("transport")),g=setInterval(function(){i.reset(),i.sync(b.db,b.design,b.view,b.query).then(function(){v&&v.hide(),h.reset(JSON.parse(i.toJSON())),h.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),i.unsync()})},e))}),n.get("observer").watch("update-polling",function(){f.resetQuery()})}return function(t,i,n,s){return d.prototype=new e,new d(t,i,n,s)}});