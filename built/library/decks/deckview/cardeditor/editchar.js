/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,i,s,a,r,o){return function(c,l){var d,u=new e,p=t.get("user"),h=t.get("labels"),g={_id:"",default_lang:p.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:p.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},f=new n,m={},v=new a({error:""}),b=87,w=87,y=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=b/t,t=b):(t*=w/n,n=w),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},k=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),r=a.getContext("2d"),o=b,c=w;s.src=e,setTimeout(function(){a.width=o,a.height=c,n=Math.floor(Math.max(0,(s.width-o)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),r.drawImage(s,n,i,o,c,0,0,o,c),t(a.toDataURL("image/png"))},300)},L=function(){var e="/upload",t=new FormData,n="cardpic",i="cards",s=d;t.append("type",n),t.append("dir",i),t.append("filename",f.get("_id")),t.append("dataString",s),r.uploadFile(e,t,null,function(e){"ok"!==e.response&&console.log(e)})},S=new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin();return f.setTransport(t.get("transport")),u.plugins.addAll({label:new i(h),model:new i(f,{setTitle:function(e){e&&""!==e&&"<br>"!==e?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=h.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},setPic:function(e){var n,i,s=this;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",s.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))},setAge:function(e){e||0===e||(this.innerHTML="",this.setAttribute("placeholder","age"))},setCity:function(e){var t="";e&&e.length?(t=e.split(",")[0].trim(),this.value=t):this.value=""},setCountry:function(e){var t="";e&&e.length?(t=e.split(",").slice(1,e.length).join().trim(),this.value=t):this.value=""},setFamilyStatus:function(e){(e||0===e)&&(this.selectedIndex=e)},setChildren:function(e){(e||0===e)&&(this.selectedIndex=e)},setChildrenlbl:function(e){this.innerHTML=e&&"1"===e?h.get("onechildlbl"):h.get("childrenlbl")},setSituation:function(e){e&&e.length&&(this.selectedIndex=e[0])},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].comment)})},setComment:function(e){var t=this,n=t.getAttribute("name");[0,1].forEach(function(i){e&&e[i]&&n.search(i)>0&&(t.value=e[i])})}}),error:new i(v),editevent:new s(u)}),u.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: touchstart, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><button class="choosepic" data-label="bind:innerHTML, importpiclbl" data-editevent="listen: touchstart, press; listen:touchend, picturePreview"></button><button class="takepic" data-editevent="listen: touchstart, press; listen:touchend, cameraPreview" data-label="bind:innerHTML, importcameralbl"></button><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:touchstart, press; listen:touchend, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:touchstart, press; listen:touchend, upload" data-label="bind:innerHTML, savelbl"></div></div></div>',u.reset=function(e,n){var i=new Date;d=null,v.set("error",""),m={},f.reset(),"newcard"===n?(f.reset(g),f.set("_id","C:"+i.getTime()),f.set("created_on",[i.getFullYear(),i.getMonth(),i.getDate()]),f.set("deck",[e])):f.sync(t.get("db"),n)},u.clearDefault=function(e,t){var n=t.getAttribute("name");""===f.get(n)&&(t.innerHTML="")},u.updateTitle=function(e,t){var n=t.innerHTML;n=n.charAt(0).toUpperCase()+n.slice(1),f.set("title",n)},u.picturePreview=function(e,t){var n,i,s=navigator.camera.PictureSourceType.PHOTOLIBRARY,a=new Image,r={quality:50,correctOrientation:!0,sourceType:s},c=new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin(),l=u.dom.querySelector(".cardpicture");n=function(e){a.src=e,l.setAttribute("style","background-image: none"),c.spin(l),setTimeout(function(){k(y(a),function(e){l.setAttribute("style","background-image: url('"+e+"')"),c.stop(),d=e,t.classList.remove("pressed")})},750)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(n,i,r)},u.cameraPreview=function(e,t){var n,i,s=new Image,a={quality:50,correctOrientation:!0},r=new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin(),c=u.dom.querySelector(".cardpicture");n=function(e){s.src=e,c.setAttribute("style","background-image: none"),r.spin(c),setTimeout(function(){k(y(s),function(e){c.setAttribute("style","background-image: url('"+e+"')"),d=e,r.stop(),t.classList.remove("pressed")})},750)},i=function(e){alert("error: "+e),t.classList.remove("pressed")},navigator.camera.getPicture(n,i,a)},u.updateField=function(e,t){var n=t.getAttribute("name");m[n]=t.value},u.updateLocation=function(){var e,t,n=f.get("location");e=u.dom.querySelector("input[name='city']").value||"",t=u.dom.querySelector("input[name='country']").value||"",n=e&&t?e+", "+t:e+t,m.location=n},u.updateFamily=function(e,t){var n=t.getAttribute("name"),i=f.get("family");i[n]=t.selectedIndex,m.family=i},u.updateJob=function(e,t){var n=f.get("occupation"),i=t.getAttribute("name");switch(i){case"situation":n.details[0]=t.selectedIndex;break;case"job":n.details[1]=t.value;break;case"organization":n.details[2]=t.value;break;default:n.description=t.value}m.occupation=n},u.updateLeisureName=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=f.get("leisure_activities");s[i].name=t.value,m.leisure_activities=s},u.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=f.get("leisure_activities");s[i].comment=t.value,m.leisure_activities=s},u.updateInterestName=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=f.get("interests");s[i].name=t.value,m.interests=s},u.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=f.get("interests");s[i].comment=t.value,m.interests=s},u.updateComments=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=f.get("comments");s[i]=t.value,m.comments=s},u.press=function(e,t){t.classList.add("pressed")},u.cancel=function(){l()},u.upload=function(e,n){var i=new Date,s=f.get("firstname"),a=f.get("lastname");n.classList.remove("pressed"),v.set("error",""),S.spin(n),f.get("title")||(s&&a?f.set("title",s+" "+a):(s||a)&&f.set("title",s+a)),f.get("title")||v.set("error",h.get("titlerequired")),v.get("error")?S.stop():f.get("_rev")?(f.set("last_modified",[i.getFullYear(),i.getMonth(),i.getDate()]),u.uploadCard(n)):f.sync(t.get("db"),f.get("_id")).then(function(){u.uploadCard()})},u.uploadCard=function(){var e;if(d&&(L(),f.set("picture_file",f.get("_id"))),m!=={})for(e in m)f.set(e,m[e]);f.upload().then(function(){return c(f.get("type"),f.get("_id"))}).then(function(){S.stop(),l(),f.unsync(),f.reset({})})},MODEL=f,u}});