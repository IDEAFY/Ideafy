/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","Promise","service/utils","service/actionbar"],function(e,t,n,r,i,s,o,u,a,f){return function(u){var l=new e,c=n.get("labels"),h=n.get("user"),p=new s([]),d=null;return l.plugins.addAll({labels:new r(c),active:new r(h,{}),decks:new r(p,{setVersion:function(e){e?this.innerHTML=c.get("version")+e:this.innerHTML=""},setAuthor:function(e){e==="Taiaut"?(this.innerHTML="",this.setAttribute("style","background-image:url('img/logo.png');")):this.innerHTML=e},date:function(e){e?this.innerHTML=a.formatDate(e):this.innerHTML=""}}),decklistevent:new i(l)}),l.template='<ul id="deck-list" data-decks="foreach"><li class="list-item" data-decklistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>',l.setStart=function(e,t){console.log("set Start node :",t),d&&d.hide()},l.showActionBar=function(e,t){console.log("doubleclick node :",t);var n=t.getAttribute("data-decks_id"),r=!1,i;d&&d.getParent()===t&&(r=!0),r||(d=new f("deck",t,p.get(n)._id),i=document.createDocumentFragment(),d.place(i),t.appendChild(i),r=!0)},l.reset=function(t){var n=t||null;p.reset([]),l.getDecks(u,n),display=!1},l.getModel=function(){return p},l.getDecks=function(t,r){var i=new o,s=[];switch(t){default:s=h.get("taiaut_decks").concat(h.get("custom_decks"))}i.setTransport(n.get("transport")),i.sync(n.get("db"),{keys:s}).then(function(){var e=h.get("lang"),t=[];i.loop(function(n,r){!n.doc.default_lang||n.doc.default_lang===e?t.push(n.doc):n.doc.translations&&n.doc.translations[e]?t.push(n.doc.translations[e]):t.push(n.doc)}),t.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),p.reset(t),r&&r("ok"),i.unsync()})},l.initSelected=function(t,n){var r=l.dom,i=r.querySelector(".list-item[data-decks_id='"+n+"']");t(i),i.classList.add("selected")},l.highlightDeck=function(t,n){var r=l.dom,i,s;return n===0?(i=r.querySelector(".list-item[data-decks_id='0']"),s=0):(p.loop(function(e,t){e._id===n&&(s=t)}),i=r.querySelector(".list-item[data-decks_id='"+s+"']")),t(i),i.classList.add("selected"),i.scrollIntoView(),s},l.init=function(t){l.reset(t)},h.watchValue("lang",function(){l.getDecks(u)}),l}});