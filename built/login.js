/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Amy/Stack-plugin","service/map","Event.plugin","service/config","Bind.plugin","Store","lib/spin.min","Promise","CouchDBDocument"],function(e,t,i,n,s,a,r,o,c,l){return function(d,u,p){var g,h=new e,v=new e,f=new e,m=new e,b=new e,y=new e,w=new t,k=new r({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),L=s.get("labels"),S=s.get("transport"),T=(s.get("db"),new o({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270}).spin()),M=!1;return h.plugins.addAll({loginstack:w}),m.plugins.add("label",new a(L)),m.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>',m.place(document.getElementById("loading")),b.plugins.add("label",new a(L)),b.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p><div id="loadingspin"></div></div>',y.plugins.add("label",new a(L)),y.template='<div id="nointernt"><p data-label="bind: innerHTML, nointernet"></p><div id="loadingspin"></div></div>',f.plugins.addAll({label:new a(L),loginmodel:new a(k),signupevent:new n(f)}),f.template='<form id="signup-form"><p class="login-fields"><input data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:keypress, resetError; listen:keypress, entersignup"></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: touchstart, press; listen: touchend, release; listen:touchend, signup"></label></p><p><label class="login-button pressed-btn" name="#login-screen" data-signupevent="listen: touchstart, press; listen:touchend, release; listen: touchend, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form>',f.press=function(e,t){t.classList.add("pressed")},f.release=function(e,t){t.classList.remove("pressed")},f.entersignup=function(e){13===e.keyCode&&(e.target.blur(),f.signup())},f.showLogin=function(){w.getStack().show("#login-screen")},f.resetError=function(){k.set("error","")},f.signup=function(){var e=k.get("email"),t=k.get("password"),i=k.get("confirm-password"),n=k.get("firstname"),a=k.get("lastname"),r=(new c,new l);if(""===e)k.set("error",L.get("signupmissingemail"));else if(""===t)k.set("error",L.get("signupmissingpwd"));else if(""===i)k.set("error",L.get("signupmissingpwdok"));else if(""===n)k.set("error",L.get("signupmissingfn"));else if(""===a)k.set("error",L.get("signupmissingln"));else{var o=e.toLowerCase(),g=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;g.test(o)?t!==i?k.set("error",L.get("signuppwdnomatch")):(T.spin(f.dom),S.request("Signup",{name:o,password:t,fn:n,ln:a,lang:s.get("lang")},function(e){if("ok"===e.signup){r.reset(s.get("userTemplate")),r.set("firstname",n),r.set("lastname",a),r.set("username",n+" "+a),r.set("lang",s.get("lang"));var t=new Date;r.set("notifications",[{type:"MSG",toList:n+" "+a,date:[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],object:L.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:L.get("signupwelcomebody")}]),S.request("Welcome",{userid:o,language:r.get("lang")},function(e){return e}),e.db&&p.set("db",e.db),r.set("online",!0),r.set("sock",s.get("socket").socket.sessionid),r.setTransport(S),r.sync(e.db,o).then(function(){return r.upload()}).then(function(){p.set("currentLogin",o),p.set("userAvatar",r.get("picture_file")),p.sync("ideafy-data"),s.set("uid",'"'+o+'"'),r.unsync(),M?u(!0):d(!0)})}else k.set("error","error : "+e.message),k.set("email",""),T.stop()},this)):k.set("error",L.get("signupinvalidemail"))}},v.plugins.addAll({label:new a(L),loginmodel:new a(k),loginevent:new n(v)}),v.template='<form id="login-form"><p class="login-fields"><input data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: keypress, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:touchstart, press; listen: touchend, release; listen:touchend, login"></label></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup-button" class="pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: touchstart, press; listen:touchend, release; listen: touchend, showSignup"></label></p></form>',v.press=function(e,t){t.classList.add("pressed")},v.release=function(e,t){t.classList.remove("pressed")},v.enterlogin=function(e){13===e.keyCode&&(e.target.blur(),v.login())},v.showSignup=function(){w.getStack().show("#signup-screen")},v.resetError=function(){k.set("error","")},v.login=function(){var e=k.get("email").toLowerCase(),t=k.get("password");e&&t?(T.spin(v.dom),S.request("Login",{name:e,password:t,sock:s.get("socket").socket.sessionid},function(t){"ok"===t.login?(s.set("uid",'"'+e+'"'),t.db&&p.set("db",t.db),p.set("currentLogin",e),S.request("GetAvatar",{id:e},function(e){e.error||(p.set("userAvatar",e),p.sync("ideafy-data"),s.set("avatar",e)),M?u():d()})):(k.set("error",L.get("invalidlogin")),T.stop())})):k.set("error",L.get("invalidlogin"))},w.getStack().add("#login-screen",v),w.getStack().add("#signup-screen",f),w.getStack().add("#loading-screen",m),w.getStack().add("#maintenance-screen",b),w.getStack().add("#nointernet",y),h.alive(i.get("login")),h.init=function(){w.getStack().show("#loading-screen"),g=new o({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin(document.getElementById("loadingspin"))},h.setScreen=function(e){w.getStack().show(e)},h.reset=function(e){k.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),e&&(M=!0)},h.stopSpinner=function(){T&&T.stop(),g&&g.stop()},h}});