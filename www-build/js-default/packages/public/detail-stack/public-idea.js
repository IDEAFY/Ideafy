/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(v){var m=new e,g=new a,y=new f("public"),b=u.get("labels"),w=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),E=!1,S=u.get("user"),x=u.get("transport"),T=new h,N=i.get("public-detail"),C,k=new l;return T.setTransport(x),m.plugins.addAll({label:new n(b),publicdetail:new n(T,{toggleRateEdit:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#public-edit"):this.setAttribute("href","#public-favorites")},toggleTwocentShare:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#public-share"):this.setAttribute("href","#public-2cents")},displayWriteTwocent:function(e){e.indexOf(S.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("public-writetwocents").classList.add("invisible")},date:function L(L){L&&(this.innerHTML=s.formatDate(L))},setAuthor:function(e){e===S.get("username")&&T.get("authors").indexOf(S.get("_id"))>-1?this.innerHTML=b.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e.length===1&&e[0]===S.get("_id")?this.innerHTML=b.get("youwrotelbl"):e.length>1?this.innerHTML=b.get("theywrotelbl"):this.innerHTML=b.get("ideawrotelbl")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new o(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setRating:function(t){t.length===0?this.innerHTML="":this.innerHTML=Math.round(t.reduce(function(e,t){return e+t})/t.length*100)/100},setDescription:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},setSolution:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=T.get("_id"),n=T.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),S.get("rated_ideas").indexOf(t)<0&&n.indexOf(S.get("_id"))<0&&!E?(this.setAttribute("name","vote"),this.innerHTML=b.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(E=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),e.length===0?this.innerHTML="("+b.get("novotesyet")+")":e.length===1?this.innerHTML="("+b.get("onevote")+")":this.innerHTML="("+e.length+" "+b.get("votes")+")",this.classList.add("votes"))}}),vote:new n(w,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new p({PublicTwocentUI:y}),publicdetailevent:new r(m)}),m.template='<div class="public-idea"><div class="header blue-dark"><a href="#public-2cents" data-publicdetail="bind: toggleTwocentShare, authors" data-publicdetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, publicdetailsheadertitle"></span><a href="#public-favorites" data-publicdetail="bind: toggleRateEdit, authors" data-publicdetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-publicdetail="bind:setAvatar, authors"></div><h2 data-publicdetail="bind:innerHTML,title"></h2><span class="date" data-publicdetail="bind:date, creation_date"></span><br><span class="author" data-publicdetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-publicdetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><p data-publicdetail="bind:setDescription,description"></p><p data-publicdetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class ="rateIdea"><a class="item-acorn"></a><div class="rating" data-publicdetail="bind:setRating,votes"></div><div class="publicButton" data-publicdetail="bind:toggleVoteButton, votes" name="vote" data-publicdetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-publicdetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="public-writetwocents" class="invisible" data-publicdetail="bind: displayWriteTwocent, authors"></div><div id="public-twocents" class="twocents" data-publicdetail="bind: displayTwocentList, twocents" data-place="place: PublicTwocentUI"></div></div>',m.showCache=function(){m.dom.querySelector("#idea-cache").classList.remove("invisible")},m.hideCache=function(){m.dom.querySelector("#idea-cache").classList.add("invisible")},m.reset=function(t,n){var r=t.get(n).id,i=new c;return w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),m.getIdea(r).then(function(){E=!1,g.reset(T.get("_id")),y.reset(T.get("_id")),C=document.getElementById("public-writetwocents"),g.place(C),i.fulfill()}),i},m.getIdea=function(t){return T.unsync(),T.reset(),T.sync(u.get("db"),t)},m.action=function(e,t){var n=t.getAttribute("href");n==="#public-2cents"?(g.reset(T.get("_id")),C.classList.remove("invisible")):v(n)},m.edit=function(){_stack.getStack().show("#public-edit")},m.press=function(e,t){t.classList.add("pressed")},m.vote=function(e,t){E||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},m.previewVote=function(e,t){var n=0,r=t.getAttribute("data-vote_id");w.loop(function(e,t){t<=r?w.update(t,"active",!0):w.update(t,"active",!1)})},m.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,r=T.get("_id"),i={id:r,vote:n,voter:S.get("_id")};E||(E=!0,x.request("Vote",i,function(e){var t=S.get("rated_ideas")||[];e!=="ok"?(console.log(e,"something went wrong, please try again later"),E=!1):(t.unshift(r),S.set("rated_ideas",t),alert(u.get("labels").get("thankyou")),u.get("observer").notify("update-polling"),document.getElementById("ratingPopup").classList.remove("appear"),w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},m.place(N),m}});