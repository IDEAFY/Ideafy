/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBBulkDocuments","CouchDBDocument","Store","service/cardpopup","Promise"],function(e,t,n,i,s,a,r,o,c){return function(l,d,u){var p,h,g=new e,f=new r([]),m=new r([]),v=new r({currentPage:0,nbPages:0}),b=t.get("labels"),w=t.get("user"),y=null,k=null;return g.plugins.addAll({pagination:new n(v,{setPage:function(e){var t=e+1;this.innerHTML=v.get("nbPages")>1?b.get("page")+t+" / "+v.get("nbPages"):""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<v.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(m,{formatTitle:function(e){e?(this.classList.remove("newcard"),"techno"!==l?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;"))):this.classList.add("newcard")},setPic:function(e){var n,i=this;if(e&&e.search("img/decks/")>-1)this.setAttribute("style","background-image:url('"+e+"');");else if(e)n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){i.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});else switch(l){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}),cardlistevent:new i(g)}),g.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:touchstart, setStart; listen:touchmove, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:touchstart, push; listen:touchend, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:touchstart, push; listen:touchend, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:touchstart, highlight; listen:touchend, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn invisible" data-cardlistevent="listen: touchstart, press; listen:touchend, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: touchstart, press; listen:touchend, deleteCard"></div></div></li></ul></div></div>',g.reset=function(e){k=null,g.dom.querySelector("#cardlist-popup").classList.add("invisible"),y=e,g.getCardList(e.content[l])},g.getCardList=function(e){var n=new s,i=e,a=new c;return"newcard"===e[0]&&(i=e.slice(1,e.length)),i.length?(n.setTransport(t.get("transport")),n.sync(t.get("db"),{keys:i}).then(function(){"newcard"===e[0]?f.reset([{_id:"newcard",title:"",picture_file:""}]):f.reset([]),n.loop(function(e){f.alter("push",e.doc)}),v.set("nbPages",Math.ceil(f.getNbItems()/12)),g.displayPage(0),a.fulfill(),n.unsync()})):(f.reset([{_id:"newcard",title:"",picture_file:""}]),v.set("nbPages",1),g.displayPage(0),a.fulfill()),a},g.displayPage=function(e){var t,n=f.getNbItems()-12*e;for(v.set("currentPage",e),m.reset([]),t=0;n>t;t++)m.alter("push",f.get(12*e+t))},g.removeCard=function(e){var n,i,s,r,o=new a,d=new a,p=!0;w.get("active_deck")===y._id&&(n=y.content.characters.length,i=y.content.contexts.length,s=y.content.problems.length,r=y.content.techno.length,(2>=n||2>=i||2>=s||4>=r)&&(p=!1,alert(b.get("cannotremovecard")))),p&&(o.setTransport(t.get("transport")),d.setTransport(t.get("transport")),o.sync(t.get("db"),y._id).then(function(){var t=o.get("content"),n=t[l];return n.splice(n.indexOf(e),1),t[l]=n,o.set("content",t),o.upload()}).then(function(){return u("updated",y._id,l),o.unsync(),d.sync(t.get("db"),e)}).then(function(){var e,n=d.get("deck"),i=new c,s=d.get("picture_file");return n.splice(n.indexOf(y._id),1),n.length?(d.set("deck",n),d.upload().then(function(){i.fulfill()})):(-1===s.search("img/decks")&&(e={type:"card",file:s},t.get("transport").request("DeleteAttachment",e,function(e){"ok"!==e&&console.log(e)})),d.remove().then(function(){i.fulfill()})),i}))},g.push=function(e,t){t.classList.add("invisible")},g.press=function(e,t){t.classList.add("pressed")},g.previousPage=function(){g.displayPrevious()},g.nextPage=function(){g.displayNext()},g.displayPrevious=function(){var e=v.get("currentPage");e>0&&g.displayPage(e-1)},g.displayNext=function(){var e=v.get("currentPage");e<v.get("nbPages")-1&&g.displayPage(e+1)},g.setStart=function(e){p=[e.pageX,e.pageY]},g.changePage=function(e){touchPoint=[e.pageX,e.pageY],p[0]-touchPoint[0]>40&&touchPoint[1]-p[1]<20&&touchPoint[1]-p[1]>-20?g.displayNext():p[0]-touchPoint[0]<40&&touchPoint[1]-p[1]<20&&touchPoint[1]-p[1]>-20&&g.displayPrevious()},g.highlight=function(e,t){null!==k&&document.querySelector("li[data-cards_id='"+k+"']").classList.remove("highlighted"),k=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},g.zoom=function(e,t){var n=t.getAttribute("data-cards_id");"newcard"===m.get(n)._id?(d("newcard",l),t.classList.remove("highlighted")):(g.setPopup(n),w.get("_id")===y.created_by&&(t.querySelector(".cardbtnbar").classList.remove("invisible"),m.get(n).created_by===w.get("_id")?t.querySelector(".editcardbtn").classList.remove("invisible"):t.querySelector(".editcardbtn").classList.add("invisible")))},g.editCard=function(e,t){var n=t.getAttribute("data-cards_id");e.stopPropagation(),h.close(),t.parentNode.classList.add("invisible"),d(m.get(n)._id,l)},g.deleteCard=function(e,t){var n=t.getAttribute("data-cards_id");e.stopPropagation(),h.close(),t.parentNode.classList.add("invisible"),g.removeCard(m.get(n)._id)},g.setPopup=function(e){var t,n={x:0,y:0},i="";switch(t=e%12){case 1:n.x=304,n.y=157,i="left";break;case 2:n.x=23,n.y=157,i="right";break;case 3:n.x=170,n.y=157,i="right";break;case 4:n.x=157,n.y=339,i="left";break;case 5:n.x=304,n.y=339,i="left";break;case 6:n.x=23,n.y=339,i="right";break;case 7:n.x=170,n.y=339,i="right";break;case 8:n.x=157,n.y=350,i="left";break;case 9:n.x=304,n.y=350,i="left";break;case 10:n.x=23,n.y=350,i="right";break;case 11:n.x=170,n.y=350,i="right";break;default:n.x=157,n.y=157,i="left"}h.reset(m.get(e),n,i,document.getElementById("cardlist-popup"))},g.closePopup=function(){g.dom.querySelector("li[data-cards_id='"+k+"']").classList.remove("highlighted"),g.dom.querySelector("li[data-cards_id='"+k+"']").querySelector(".cardbtnbar").classList.add("invisible"),k=null},h=new o(g.closePopup),g}});