/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Place.plugin","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min","./mubchat"],function(e,t,i,s,n,a,r,o,c,d,l,u,p,g){return function(m,h,v,b,f){var w,y,L,S=new e,T=null,k=null,x=new o({timer:null,display:!1}),I=a.get("transport"),A=a.get("user"),M=a.get("db"),C=a.get("labels"),_=new g,H=new o({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),q=[],N=!0,D=new o,P=new o,O=new o,B={tech1:D,tech2:P,tech3:O},E=0,J=new o([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),V="step",j=new p({color:"#657B99",lines:10,length:8,width:4,radius:8,top:336,left:481}).spin(),R={};return S.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===A.get("_id")},S.plugins.addAll({labels:new s(C),display:new s(H,{setReload:function(e){!e&&E>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(){S.isLeader()&&H.get("tech1").selected&&H.get("tech2").selected&&H.get("tech3").selected&&"step"===V?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new s(J,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){this.innerHTML=e?e.toUpperCase():C.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),mutechtimer:new s(x,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),place:new i({chat:_}),mutechevent:new n(S)}),S.template='<div id = "mutech"><div class="previousbutton" data-mutechevent="listen: touchstart, press; listen: touchstart, prev"></div><div id="mutech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, mutech" data-mutechevent="listen:touchstart, toggleProgress"></div><div class="timer" data-mutechtimer="bind:setTime, timer; bind: displayTimer, display" data-mutechevent="listen:touchstart,toggleTimer"></div><div class="help-brainstorm" data-mutechevent="listen:touchstart, help"></div><div id="mutech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-mutechevent="listen: touchstart, select; listen:touchstart, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-mutechevent="listen: touchstart, push; listen:touchend, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-mutechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-mutechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-mutechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-mutechevent="listen: touchstart, pushOk; listen:touchend, accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-mutechevent="listen: touchstart, pushOk; listen:touchend, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-mutechevent="listen: touchstart, pushOk; listen:touchend, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-mutechevent="listen: touchstart, press; listen:touchend, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',S.place(t.get("mutech")),S.press=function(e,t){t.classList.add("pressed")},S.next=function(e,t){var i=new Date;i.getTime()-T,j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===V?(V="screen",h.set("techno",J),clearInterval(w),x.set("display",!0),S.updateSessionScore(x.get("timer")).then(function(){m.unsync(),m.sync(M,m.get("_id")).then(function(){var e=m.get("elapsedTimers");_.conclude("next"),e.mutech=x.get("timer"),m.set("elapsedTimers",e),m.set("techno",[[J.get(0).id,J.get(1).id,J.get(2).id]]),b("mutech")})})):b("mutech")},S.stopSpinner=function(){j.stop()},S.help=function(){r.setContent("mutechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},S.prev=function(e,t){t.classList.remove("pressed"),v("mutech")},S.toggleProgress=function(){f()},S.toggleTimer=function(){S.isLeader()&&x.set("display",!x.get("display"))},S.select=function(e,t){var i=t.getAttribute("name");(i.search("tech")<0||E>0||"screen"===V)&&t.classList.add("highlighted")},S.zoom=function(e,t){var i=t.getAttribute("name");(i.search("tech")<0||E>0||"screen"===V)&&S.setPopup(i)},S.setPopup=function(e){var t,i={x:0,y:257},s="left",n=H.get(L)||"",a=new o,r=H.get(e);n&&(n.popup=!1,H.set(L,n)),r.popup=!0,H.set(e,r),L=e,"scenario"===e?(i.x=147,i.y=275,a.reset(m.get("scenario")[0]),a.set("type",5),t=a.toJSON()):("tech1"===e&&(i.x=467),"tech2"===e&&(i.x=186,s="right"),"tech3"===e&&(i.x=333,s="right"),B[e].get("_id")&&(t=B[e].toJSON())),t&&y.reset(t,i,s,document.getElementById("mutech-popup"))},S.closePopup=function(){var e=H.get(L);e.popup=!1,H.set(L,e),L=""},S.push=function(e,t){var i=t.getAttribute("name");t.classList.contains("drawok")?B[i].get("_id")&&"step"===V&&S.isLeader()&&t.classList.add("pushed"):t.classList.add("pushed")},S.draw=function(e,t){var i=[];S.isLeader()&&"step"===V&&N?(N=!1,["tech1","tech2","tech3"].forEach(function(e){H.get(e).selected||i.push(e)}),S.drawTech(i).then(function(){t.classList.remove("pushed"),N=!0})):t.classList.remove("pushed")},S.drawTech=function(e){var t,i=[],s=new d,n=new o({count:e.length});return e.length?(e.forEach(function(e){q.length<=0&&(q=h.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){H.get(e).selected&&i.push(J.get(t).id)}),q.filter(function(e){return!(i.indexOf(e)>-1)})),t=Math.floor(Math.random()*q.length),S.getCardDetails(q[t],e).then(function(){var e=n.get("count");e--,n.set("count",e)}),H.set("left",q.length),E++,q.splice(t,1)}),n.watchValue("count",function(e){e||(m.unsync(),m.sync(M,m.get("_id")).then(function(){return["tech1","tech2","tech3"].forEach(function(e,t){m.set("drawn"+e,J.get(t).id)}),m.upload()}).then(function(){s.fulfill()}))})):s.fulfill(),DRS=n,s},S.getCardDetails=function(e,t){var i=new c,s=["tech1","tech2","tech3"],n=s.indexOf(t),a=new d;return i.setTransport(I),i.sync(M,e).then(function(){B[t].reset(JSON.parse(i.toJSON())),J.update(n,"id",e),J.update(n,"title",i.get("title")),J.update(n,"pic",i.get("picture_file")),a.fulfill(),i.unsync()}),a},S.pushOk=function(e,t){var i=R[t.getAttribute("name")]||null;S.isLeader()&&"step"===V&&(i?R[t.getAttribute("name")].spin(t):R[t.getAttribute("name")]=(new p).spin(t))},S.accept=function(e,t){var i=t.getAttribute("name"),s=["tech1","tech2","tech3"],n=s.indexOf(i),a=H.get(i);"step"===V&&S.isLeader()&&(a.selected=J.get(n)&&J.get(n).id?!a.selected:!1,m.unsync(),m.sync(M,m.get("_id")).then(function(){return m.set("selected_"+i,a.selected),m.upload()}).then(function(){R[t.getAttribute("name")].stop(),H.set(i,a)}))},S.reset=function(e){var t=m.get("techno")[0];_.clear(),m.get("chat")[3]&&_.reset(m.get("chat")[3]),H.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),e||t.length?(V="screen",_.dom.querySelector(".chatread").classList.add("extended"),S.getCardDetails(t[0],"tech1").then(function(){return S.getCardDetails(t[1],"tech2")}).then(function(){return S.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){H.set(e,{popup:!1,selected:!0})}),h.set("techno",J)})):(q=[],E=0,V="step",D.reset(),P.reset(),O.reset(),J.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),m.get("elapsedTimers").mutech&&(k=m.get("elapsedTimers").mutech,x.set("timer",k),"screen"===V?x.set("display",!0):S.isLeader()&&S.initTimer(k))},S.updateSessionScore=function(e){var t=new d,i={sid:m.get("_id"),step:"mutech",time:e,cards:E};return I.request("UpdateSessionScore",i,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},S.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;x.set("display",!1),x.set("timer",s),"mutech"===m.get("step")&&(clearInterval(w),w=setInterval(function(){var e=new Date;x.set("timer",s+e.getTime()-i)},1e3))},y=new l(S.closePopup),S.getChatUI=function(){return _},m.watchValue("chat",function(e){4===e.length&&_.getModel().get("_id")!==e[3]&&_.reset(e[3])}),h.watchValue("deck",function(e){q=e.techno.concat(),H.set("left",q.length)}),["tech1","tech2","tech3"].forEach(function(e){m.watchValue("drawn"+e,function(t){S.isLeader()||S.getCardDetails(t,e)}),m.watchValue("selected_"+e,function(t){var i;S.isLeader()||(i=H.get(e),i.selected=t,H.set(e,i),t&&h.set("techno",J))})}),S}});