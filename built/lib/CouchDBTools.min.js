define("CouchDBBase",["Store","Tools","Promise"],function(e,t,s){function i(){var e,t=null,i="CouchDB",n=null,a=new s;this.setPromise=function(e){return"object"==typeof e&&"function"==typeof e.fulfill&&"function"==typeof e.reject&&"function"==typeof e.then?(a=e,!0):!1},this.getPromise=function(){return a},this.getStateMachine=function(){return t},this.setStateMachine=function(e){return"object"==typeof e&&"function"==typeof e.event?(t=e,!0):!1},this.getTransport=function(){return n},this.setTransport=function(e){return"object"==typeof e&&"function"==typeof e.request&&"function"==typeof e.listen?(n=e,!0):!1},this.getHandlerName=function(){return i},this.setHandlerName=function(e){return"string"==typeof e?(i=e,!0):!1},this.sync=function(){return a=new s,(e=this.setSyncInfo.apply(this,arguments))?(t.event("sync"),a):!1},this.unsync=function(){return t.event("unsync")},this.getSyncInfo=function(){return e},this.onSync=function(){},this.onListen=function(){},this.onUnsync=function(){this.stopListening&&this.stopListening(),delete this.stopListening},this.unsync=function(){t.event("unsync")},this.onChange=function(){},this.onAdd=function(){},this.onRemove=function(){},this.setSyncInfo=function(t){return e=t}}return function(t){return i.prototype=new e(t),new i}}),define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,s,i,n){function a(){this.setSyncInfo=function(e,t,s){return"string"==typeof e&&"string"==typeof t?s&&"object"!=typeof s?!1:{database:e,document:t,query:s||{}}:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document,query:e.query},function(e){e=JSON.parse(e),e._id&&(this.reset(e),this.getStateMachine().event("listen")),this.getPromise().fulfill(e)},this)},this.onListen=function(){var e=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:{feed:"continuous",heartbeat:2e4,descending:!0}},function(t){return"\n"==t?!1:(t=JSON.parse(t),t.id==e.document&&t.changes.pop().rev!=this.get("_rev")&&(t.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change")),void 0)},this)},this.onChange=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document},function(e){this.reset(JSON.parse(e))},this)},this.onRemove=function(){this.reset({})},this.upload=function(){var e=new i;return this.getSyncInfo().document?(this.getStateMachine().event("upload",e),e):!1},this.remove=function(){this.getSyncInfo();var e=new i;return this.getStateMachine().event("removeFromDatabase",e),e},this.databaseCreate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(t){t=JSON.parse(t),t.ok?(this.set("_rev",t.rev),this.set("_id",t.id),this.getStateMachine().event("listen"),e.fulfill(t)):e.reject(t)},this)},this.databaseUpdate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(t){t=JSON.parse(t),t.ok?(this.set("_rev",t.rev),e.fulfill(t)):e.reject(t)},this)},this.databaseRemove=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+t.database+"/"+t.document,query:{rev:this.get("_rev")}},function(t){t=JSON.parse(t),t.ok?e.fulfill(t):e.reject(t)})},this.setStateMachine(new n("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(e){return a.prototype=new t(e),new a}}),define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(e,t,s,i){function n(){this.setSyncInfo=function(e,t,s,i){return"string"==typeof e&&"string"==typeof t&&"string"==typeof s?i&&"object"!=typeof i?!1:{database:e,design:t,view:s,query:i||{}}:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(t){var s=JSON.parse(t);if(!s.rows)throw Error("CouchDBStore ["+e.database+", "+e.design+", "+e.view+"].sync() failed: "+t);this.reset(s.rows),"undefined"==typeof s.total_rows&&(e.reducedView=!0),this.getStateMachine().event("listen"),this.getPromise().fulfill(s)},this)},this.onListen=function(){var e=this.getSyncInfo();s.mixin({feed:"continuous",heartbeat:2e4,descending:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(t){if("\n"==t)return!1;var s,t=JSON.parse(t);s=e.reducedView?"updateReduced":t.deleted?"remove":t.changes&&0==t.changes[0].rev.search("1-")?"add":"change",this.getStateMachine().event(s,t.id)},this)},this.onChange=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){t=JSON.parse(t),t.rows.length==this.getNbItems()?t.rows.some(function(t,s){t.id==e&&this.set(s,t)},this):this.evenDocsInStore.call(this,t.rows,e)},this)},this.evenDocsInStore=function(e,t){var s=this.getNbItems();e.length<s?this.loop(function(e,s){e.id==t&&this.del(s)},this):e.length>s&&e.some(function(e,s){return e.id==t?this.alter("splice",s,0,e):void 0},this)},this.onAdd=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){JSON.parse(t).rows.some(function(t,s){t.id==e&&this.alter("splice",s,0,t)},this)},this)},this.onRemove=function(e){this.loop(function(t,s){t.id==e&&this.del(s)},this)},this.updateReduced=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(e){this.set(0,JSON.parse(e).rows[0])},this)},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(e){return n.prototype=new t(e),new n}}),define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,s,i,n){function a(){this.setSyncInfo=function(e,t){if("string"==typeof e&&"object"==typeof t){var s={database:e,query:t||{}};return Array.isArray(s.query.keys)&&(s.keys=s.query.keys,delete s.query.keys),s}return!1},this.onSync=function(){var e,t=this.getSyncInfo(),s={path:"/"+t.database+"/_all_docs",query:t.query};Array.isArray(t.keys)?(s.method="POST",s.data=JSON.stringify({keys:t.keys}),s.headers={"Content-Type":"application/json"},e=s.data):(s.method="GET",e=JSON.stringify(t.query)),t.query.include_docs=!0,this.getTransport().request(this.getHandlerName(),s,function(s){var i=JSON.parse(s);if(!i.rows)throw Error('CouchDBBulkDocuments.sync("'+t.database+'", '+e+") failed: "+s);this.reset(i.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this)},this)},this.onListen=function(){var e=this.getSyncInfo();s.mixin({feed:"continuous",heartbeat:2e4,descending:!0,include_docs:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(e){if("\n"==e)return!1;var t,e=JSON.parse(e);t=0==e.changes[0].rev.search("1-")?"add":e.deleted?"remove":"change",this.getStateMachine().event(t,e.id,e.doc)},this)},this.onAdd=function(e){var t=this.getSyncInfo();return t.query.startkey||t.query.endkey?(t.query.include_docs=!0,t.query.update_seq=!0,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_all_docs",query:t.query},function(t){JSON.parse(t).rows.forEach(function(t,s){t.id==e&&this.alter("splice",s,0,t.doc)},this)},this),void 0):!1},this.onChange=function(e,t){this.loop(function(s,i){s.id==e&&this.set(i,t)},this)},this.onRemove=function(e){this.loop(function(t,s){t.id==e&&this.del(s)},this)},this.databaseUpdate=function(e){var t=[],s=this.getSyncInfo();this.loop(function(e){t.push(e.doc)}),this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+s.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:t})},function(t){var s=JSON.parse(t);this.loop(function(e,t){s[t].ok&&(e.doc._rev=s[t].rev)}),e.fulfill(s)},this)},this.upload=function(){var e=new i;return this.getStateMachine().event("upload",e),e},this.setStateMachine(new n("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(e){return a.prototype=new t(e),new a}}),define("CouchDBUser",["CouchDBDocument","Promise"],function(e,t){function s(){var e="_users",s="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(t){return t?(e=t,!0):!1},this.getIdPrefix=function(){return s},this.setIdPrefix=function(e){return e?(s=e,!0):!1},this.setId=function(e){return e?(this.set("_id",s+e),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(t){return this.sync(e,s+t)},this.login=function(){var e=new t,s=this.get("name"),i=this.get("password");return s&&"string"==typeof s&&"string"==typeof i?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+s,auth:s+":"+i},e.fulfill,e):e.reject({error:"name & password must be strings"}),e},this.create=function(){var e=new t;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.load(this.get("name")).then(function(){e.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(t){e.fulfill(t)},function(t){e.reject(t)})},this),e}}return function(){return s.prototype=new e,new s}}),define("CouchDBSecurity",["CouchDBDocument"],function(e){function t(){var e="_security";this.setName=function(t){return t?(e=t,!0):!1},this.getName=function(){return e},this.load=function(t){return this.sync(t,e)}}return function(){return t.prototype=new e,new t}});