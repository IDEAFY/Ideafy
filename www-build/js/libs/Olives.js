/**
 * @license Olives <VERSION> http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

/**
 * Olives http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

define("Olives/DomUtils",function(){return{getNodes:function(t,n){return this.isAcceptedType(t)?(t.parentNode||document.createDocumentFragment().appendChild(t),t.parentNode.querySelectorAll(n||"*")):!1},getDataset:function(t){var n=0,r,i={},s,o;if(this.isAcceptedType(t)){if(t.hasOwnProperty("dataset"))return t.dataset;for(r=t.attributes.length;n<r;n++)s=t.attributes[n].name.split("-"),s.shift()=="data"&&(i[o=s.join("-")]=t.getAttribute("data-"+o));return i}return!1},isAcceptedType:function(t){return t instanceof HTMLElement||t instanceof SVGElement?!0:!1},setAttribute:function(t,n,r){return t instanceof HTMLElement?(t[n]=r,!0):t instanceof SVGElement?(t.setAttribute(n,r),!0):!1}}}),define("Olives/Event-plugin",function(){return function(t){this.listen=function(e,n,r,i){e.addEventListener(n,function(n){t[r].call(t,n,e)},i=="true")}}}),define("Olives/LocalStore",["Store","Tools"],function(t,n){function r(){var e=null,t=localStorage,r=function(){t.setItem(e,this.toJSON())};this.setLocalStorage=function(n){return n&&n.setItem instanceof Function?(t=n,!0):!1},this.getLocalStorage=function(){return t},this.sync=function(s){var o;return typeof s=="string"?(e=s,o=JSON.parse(t.getItem(s)),n.loop(o,function(e,t){this.has(t)||this.set(t,e)},this),r.call(this),this.watch("added",r,this),this.watch("updated",r,this),this.watch("deleted",r,this),!0):!1}}return function(n){return r.prototype=new t(n),new r}}),define("Olives/Model-plugin",["Store","Observable","Tools","Olives/DomUtils"],function(t,n,r,s){return function(n,o){var u=null,a={},f={};this.observers={},this.setModel=function(n){return n instanceof t?(u=n,!0):!1},this.getModel=function(){return u},this.ItemRenderer=function(n,o){var a=null,f=null,c=null,h=null,p=null;this.setRenderer=function(t){return a=t,!0},this.getRenderer=function(){return a},this.setRootNode=function(t){var n;return s.isAcceptedType(t)?(c=t,n=c.querySelector("*"),this.setRenderer(n),n&&c.removeChild(n),!0):!1},this.getRootNode=function(){return c},this.setPlugins=function(t){return f=t,!0},this.getPlugins=function(){return f},this.items=new t([]),this.setStart=function(t){return h=parseInt(t,10),h},this.getStart=function(){return h},this.setNb=function(t){return p=t=="*"?t:parseInt(t,10),p},this.getNb=function(){return p},this.addItem=function(t){var n,r;return typeof t=="number"&&!this.items.get(t)?(n=this.create(t),n?(r=this.getNextItem(t),r?c.insertBefore(n,r):c.appendChild(n),!0):!1):!1},this.getNextItem=function(t){return this.items.alter("slice",t+1).filter(function(e){if(s.isAcceptedType(e))return!0})[0]},this.removeItem=function(t){var n=this.items.get(t);return n?(c.removeChild(n),this.items.set(t),!0):!1},this.create=function(t){if(u.has(t)){var n=a.cloneNode(!0),i=s.getNodes(n);return r.toArray(i).forEach(function(e){e.setAttribute("data-"+f.name+"_id",t)}),this.items.set(t,n),f.apply(n),n}},this.render=function(){var t=p=="*"?u.getNbItems():p,n=[];if(p!==null&&h!==null){this.items.loop(function(e,r){(r<h||r>=h+t||!u.has(r))&&n.push(r)},this),n.sort(r.compareNumbers).reverse().forEach(this.removeItem,this);for(i=h,l=t+h;i<l;i++)this.addItem(i);return!0}return!1},this.setPlugins(n),this.setRootNode(o)},this.setItemRenderer=function(t,n){t=t||"default",f[t]=n},this.getItemRenderer=function(t){return f[t]},this.foreach=function(t,n,r,i){var s=new this.ItemRenderer(this.plugins,t);s.setStart(r||0),s.setNb(i||"*"),s.render(),u.watch("added",s.render,s),u.watch("deleted",function(e){s.render(),this.observers[e]&&this.observers[e].forEach(function(e){u.unwatchValue(e)},this),delete this.observers[e]},this),this.setItemRenderer(n,s)},this.updateStart=function(t,n){var r=this.getItemRenderer(t);return r?(r.setStart(n),!0):!1},this.updateNb=function(t,n){var r=this.getItemRenderer(t);return r?(r.setNb(n),!0):!1},this.refresh=function(t){var n=this.getItemRenderer(t);return n?(n.render(),!0):!1},this.bind=function(t,n,i){i=i||"";var o=t.getAttribute("data-"+this.plugins.name+"_id"),a=i.split("."),f=o||a.shift(),l=o?i:a.join("."),c=r.getNestedProperty(u.get(f),l),h=r.toArray(arguments).slice(3);if(c||c===0||c===!1)this.execBinding.apply(this,[t,n,c].concat(h))||s.setAttribute(t,n,c);this.hasBinding(n)||t.addEventListener("change",function(e){u.has(f)&&(l?u.update(f,i,t[n]):u.set(f,t[n]))},!0),this.observers[f]=this.observers[f]||[],this.observers[f].push(u.watchValue(f,function(e){this.execBinding.apply(this,[t,n,r.getNestedProperty(e,l)].concat(h))||s.setAttribute(t,n,r.getNestedProperty(e,l))},this))},this.set=function(t){return s.isAcceptedType(t)&&t.name?(u.set(t.name,t.value),!0):!1},this.form=function c(c){if(c&&c.nodeName=="FORM"){var e=this;return c.addEventListener("submit",function(t){r.toArray(c.querySelectorAll("[name]")).forEach(e.set,e),t.preventDefault()},!0),!0}return!1},this.addBinding=function(t,n){return t&&typeof t=="string"&&typeof n=="function"?(a[t]=n,!0):!1},this.execBinding=function(t,n){return this.hasBinding(n)?(a[n].apply(t,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(t){return a.hasOwnProperty(t)},this.getBinding=function(t){return a[t]},this.addBindings=function(t){return r.loop(t,function(e,t){this.addBinding(t,e)},this)},this.setModel(n),this.addBindings(o)}}),define("Olives/OObject",["StateMachine","Store","Olives/Plugins","Olives/DomUtils","Tools"],function(t,n,r,i,s){return function(o){var u=function(t){var n=l||document.createElement("div");if(!t.template)throw Error("UI.template must be set prior to render");typeof t.template=="string"?n.innerHTML=t.template.trim():i.isAcceptedType(t.template)&&n.appendChild(t.template);if(n.childNodes.length>1)throw Error("UI.template should have only one parent node");t.dom=n.childNodes[0],t.plugins.apply(t.dom)},a=function h(e,h,t){h&&(t?h.insertBefore(e.dom,t):h.appendChild(e.dom),l=h)},f=function(t,n){u(t),a.apply(null,s.toArray(arguments))},l=null,c=new t("Init",{Init:[["render",u,this,"Rendered"],["place",f,this,"Rendered"]],Rendered:[["place",a,this],["render",u,this]]});this.model=o instanceof n?o:new n,this.plugins=new r,this.template=null,this.dom=null,this.place=function(t,n){c.event("place",this,t,n)},this.render=function(){c.event("render",this)},this.setTemplateFromDom=function(t){return i.isAcceptedType(t)?(this.template=t,!0):!1},this.alive=function(t){return i.isAcceptedType(t)?(this.setTemplateFromDom(t),this.place(t.parentNode,t.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return l}}}),define("Olives/Plugins",["Tools","Olives/DomUtils"],function(t,n){return function(){var r={},i=function(t){return t.trim()},s=function(t,n,s){n.split(";").forEach(function(e){var n=e.split(":"),o=n[0].trim(),u=n[1]?n[1].split(",").map(i):[];u.unshift(t),r[s]&&r[s][o]&&r[s][o].apply(r[s],u)})};this.add=function(t,n){var i=this,s="plugins";return typeof t=="string"&&typeof n=="object"&&n?(r[t]=n,n[s]={name:t,apply:function(){return i.apply.apply(i,arguments)}},!0):!1},this.addAll=function(n){return t.loop(n,function(e,t){this.add(t,e)},this)},this.get=function(t){return r[t]},this.del=function(t){return delete r[t]},this.apply=function(r){var i;return n.isAcceptedType(r)?(i=n.getNodes(r),t.loop(t.toArray(i),function(e){t.loop(n.getDataset(e),function(t,n){s(e,t,n)})}),r):!1}}}),define("Olives/Transport",["Observable","Tools"],function(t,n){return function(n,r){var i=null,s=null,o=new t,u={};this.setIO=function(t){return t&&typeof t.connect=="function"?(s=t,!0):!1},this.getIO=function(){return s},this.connect=function(t){return typeof t=="string"?(i=s.connect(t),!0):!1},this.getSocket=function(){return i},this.on=function(t,n){return i.on(t,n)},this.once=function(t,n){return i.once(t,n)},this.emit=function(t,n,r){return i.emit(t,n,r)},this.removeListener=function(t,n,r){return i.removeListener(t,n,r)},this.request=function(t,n,r,i){if(typeof t=="string"&&typeof n!="undefined"){var s={eventId:Date.now()+Math.floor(Math.random()*1e6),data:n},o=function(){r&&r.apply(i||null,arguments)};return this.once(s.eventId,o),this.emit(t,s),!0}return!1},this.listen=function(t,n,r,i){if(typeof t=="string"&&typeof n!="undefined"&&typeof r=="function"){var s={eventId:Date.now()+Math.floor(Math.random()*1e6),data:n,keepAlive:!0},o=function(){r&&r.apply(i||null,arguments)},u=this;return this.on(s.eventId,o),this.emit(t,s),function(){u.emit("disconnect-"+s.eventId),u.removeListener(s.eventId,o)}}return!1},this.setIO(n),this.connect(r)}}),define("Olives/UI-plugin",["Olives/OObject","Tools"],function(e,t){return function(r){var i={};this.place=function(n,r){if(!(i[r]instanceof e))throw new Error(r+" is not an OObject UI in place:"+r);i[r].place(n)},this.set=function(n,r){return typeof n=="string"&&r instanceof e?(i[n]=r,!0):!1},this.setAll=function(n){t.loop(n,function(e,t){this.set(t,e)},this)},this.get=function(t){return i[t]},this.setAll(r)}});