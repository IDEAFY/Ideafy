/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Amy/Stack-plugin","Amy/Control-plugin","Event.plugin","Place.plugin","service/config","service/map","./decklist/decklist","./deckview/deckview","./newdeck"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var c=new e,h=new r(c),p=o.get("user"),d,v=new n,m,g,y,b=function(e){var t=v.getStack().getCurrentScreen(),n=t.getModel();d=t.highlightDeck(h.init,e),x.reset(n.get(d))},w=!1,E,S=function(e,t,n){var r;E=t,e==="new"&&(w=!0,E=t),e==="updated"&&(r=v.getStack().getCurrentScreen(),r.reset(function(e){e&&(r.highlightDeck(h.init,t),x.reset(r.getModel().get(d),n))}))},x=new f(S),T=new l(S);return c.plugins.addAll({label:new t(o.get("labels")),deckliststack:v,decksevent:new i(c),deckplace:new s({deckView:x,newDeck:T}),deckscontrol:h}),c.template='<div id="decks"><div id="decklist" class="list"><div class="header blue-light"><div class="option left" data-deckscontrol=""></div><span data-label="bind: innerHTML, decklistheadertitle"></span><div class="option right" data-decksevent="listen: mousedown, plus"></div></div><div class="overflow" data-deckliststack="destination" data-deckscontrol="radio:li,selected,mousedown,selectStart"></div></div><div data-deckplace="place:deckView"></div><div data-deckplace="place:newDeck"></div></div>',c.reset=function(){m.reset(function(e){e&&(v.getStack().show("ideafy"),m.highlightDeck(h.init,0),x.reset(m.getModel().get(0)),d=0)})},c.displayDeck=b,c.init=function(){m=new a("all_decks"),v.getStack().add("ideafy",m),m.init(function(e){e&&(v.getStack().show("ideafy"),x.init(),m.highlightDeck(h.init,0),x.reset(m.getModel().get(0),"details"),d=0)})},c.selectStart=function(e){var t=v.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-decks_id");x.reset(t.get(n)),d=n},c.plus=function(e,t){T.show()},c.init(),p.watchValue("lang",function(){var e=v.getStack().getCurrentName(),t,n=v.getStack().getCurrentScreen();switch(e){case"taiaut":t="taiaut_decks";case"custom":t="custom_decks";break;default:t="all_decks"}n.getDecks(t,function(e){e&&(n.initSelected(h.init,d),x.reset(n.getModel().get(d)))})}),p.watchValue("custom_decks",function(e,t,n){m.reset(function(t){var r;t&&w?b(E):t&&e.length<n.length&&(r=m.getModel(),r.getNbItems()&&(m.initSelected(h.init,0),x.reset(r.get(0)),d=0)),w=!1})}),p.watchValue("taiaut_decks",function(e,t,n){m.reset(function(e){e&&(m.initSelected(h.init,0),x.reset(m.getModel().get(0)))})}),c}});