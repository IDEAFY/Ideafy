/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/config","Store","Olives/Model-plugin","Olives/Event-plugin","service/avatar","service/utils","./message-reply"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new a,d=new n,v=new n({response:""}),m=t.get("labels"),g=t.get("user"),y=t.get("observer"),b=t.get("transport");return h.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="more" class="more" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:mousedown, press; listen:mouseup, showDoc"></div></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: mousedown, press; listen: mouseup, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:mousedown, press; listen:mouseup, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:mousedown, press; listen:mouseup, rejectCXR"></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div>',h.plugins.addAll({label:new r(m),message:new r(d,{date:function w(w){var e=new Date,t=w[3],n=w[4],r=w[5];w&&w[0]===e.getFullYear()&&w[1]===e.getMonth()&&w[2]===e.getDate()?(t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r):this.innerHTML=u.formatDate(w)+"  "+t+":"+n},setObject:function(e){switch(e){case"CXR":this.innerHTML=d.get("username")+m.get("CXRobject");break;case"CXRaccept":this.innerHTML=d.get("username")+m.get("acceptedCXR");break;case"CXRreject":this.innerHTML=d.get("username")+m.get("rejectedCXR");break;case"CXCancel":this.innerHTML=d.get("username")+m.get("canceledCX");break;case"DOC":this.innerHTML=d.get("username")+m.get("sentdocmsg");break;case"2Q+":this.innerHTML=d.get("username")+m.get("askednew");break;case"2C+":this.innerHTML=d.get("username")+m.get("senttc");break;default:this.innerHTML=d.get("object")}},setBody:function(e){switch(e){case"CXRaccept":this.innerHTML=m.get("youlbl")+m.get("nowconnected")+d.get("username");break;case"DOC":this.innerHTML=d.get("username")+m.get("sentdocmsg")+" : <b>"+d.get("docTitle")+"</b>";break;default:this.innerHTML=d.get("body")}},showOptions:function(e){e.search("CX")>-1||e==="2Q+"?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(e){e?this.innerHTML=e:this.innerHTML=m.get("melbl")},showCcList:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(e){e==="CXR"?this.classList.remove("invisible"):this.classList.add("invisible")},showDocBtn:function(e){e==="DOC"?this.classList.remove("invisible"):this.classList.add("invisible")},showTwoQ:function(e){e==="2Q+"||e==="2C+"?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new o([t]);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)}}),cxr:new r(v,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(e){e==="YES"?this.innerHTML=m.get("CXRaccepted")+d.get("username")+m.get("isnowacontact"):this.innerHTML=m.get("CXRrejected")}}),messageevent:new s(h)}),h.showDoc=function(t,n){n.classList.remove("pushed"),d.get("type")==="DOC"&&y.notify("display-doc",d.get("docId"),d.get("docType"))},h.showTwoQ=function(t,n){n.classList.remove("pushed"),d.get("type")==="2Q+"&&y.notify("display-twoq",d.get("docId"),d.get("author")),d.get("type")==="2C+"&&y.notify("display-twoc")},h.press=function(e,t){t.classList.add("pushed")},h.action=function(e,t){var n=t.getAttribute("name"),r=document.getElementById("msgreply"),i=document.querySelector(".msgoptionlist");switch(n){case"more":i.classList.remove("invisible");break;case"reply":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"reply"),r.classList.remove("invisible");break;case"replyall":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"replyall"),r.classList.remove("invisible");break;case"forward":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"forward"),r.classList.remove("invisible");break;case"deletemsg":i.classList.add("invisible"),h.deletemsg(d.toJSON()),c("#defaultPage");break;default:}t.classList.remove("pushed")},h.deletemsg=function(t){var n=g.get("notifications"),r;for(i=0,l=n.length;i<l;i++)if(JSON.stringify(n[i])===t){r=i;break}n.splice(r,1),g.set("notifications",n),g.upload()},h.acceptCXR=function(e,t){var n=g.get("connections"),r=g.get("news")||[],s=0,o=new Date,u=[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];t.classList.remove("pushed");for(i=0,l=n.length;i<l;i++)n[i].type==="user"?(n[i].lastname<d.get("contactInfo").lastname&&s++,n[i].lastname===d.get("contactInfo").lastname&&n[i].firstname<d.get("contactInfo").firstname&&s++):n[i].username<d.get("contactInfo").lastname&&s++;n.splice(s,0,d.get("contactInfo")),g.set("connections",n),r.unshift({type:"CX+",date:u,content:{userid:d.get("author"),username:d.get("username")}}),g.set("news",r),g.upload().then(function(){var e={dest:[d.get("author")],date:u,original:"",type:"CXRaccept",author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:d.get("username"),ccList:"",object:g.get("username")+m.get("acceptedCXR"),body:m.get("youlbl")+m.get("nowconnected")+g.get("username"),signature:"",contactInfo:{firstname:g.get("firstname"),lastname:g.get("lastname"),userid:g.get("_id"),username:g.get("username"),intro:g.get("intro"),type:"user"}};v.set("response","YES"),b.request("Notify",e,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){h.deletemsg(d.toJSON()),c("#defaultPage")},1e3)})})},h.rejectCXR=function(e,t){var n,r=new Date;t.classList.remove("pushed"),v.set("response","NO"),n={dest:[d.get("author")],original:"",date:[r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds()],type:"CXRreject",author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:d.get("username"),ccList:"",object:g.get("username")+m.get("rejectedCXR"),body:"",signature:""},b.request("Notify",n,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){h.deletemsg(d.toJSON()),c("#defaultPage")},1500)})},h.reset=function(t){v.reset({response:""}),d.reset(t),p.reset(t,"reply")},MSG=d,h}});