/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBDocument"],function(e,t,n,r,i,s){return function(){var u=new e,a=t.get("labels"),f=t.get("user"),l=new i({body:"",result:""}),c=new i({}),h=new i({}),p=new s,d=new s;return p.setTransport(t.get("transport")),d.setTransport(t.get("transport")),u.plugins.addAll({labels:new n(a),support:new n(l),news:new n(c,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),maintenance:new n(h,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){this.innerHTML=(new Date(e)).toString()}}),supportevent:new r(u)}),u.template='<div class="aboutcontent"><p class="supportmsg invisible" data-news="bind:setVisible, active; bind:innerHTML, content"></p><legend class="support" data-labels="bind:innerHTML, supportlegend"></legend><textarea class="input" data-labels="bind:placeholder, supportplaceholder" data-support="bind: value, body"></textarea><span data-support="bind:innerHTML, result"></span><div class="cancel" data-labels="bind: innerHTML, cancellbl" data-supportevent="listen: touchstart, press; listen: touchend, cancel"></div><div class="send" data-labels="bind: innerHTML, sendlbl" data-supportevent="listen: touchstart, press; listen: touchend, send"></div><div class="maintenancemsg invisible" data-maintenance="bind:setVisible,active"><legend data-labels="bind:innerHTML, schedmaintenance"></legend><p><span data-labels="bind: innerHTML, nextmaintenance"></span><span class="dateandtime" data-maintenance="bind:setDate, date">Sunday April 7th 6:00 EST</span><br/><span data-maintenance="bind:innerHTML, comment"></span></p></div><div class="supportus"><legend data-labels="bind: innerHTML, twoway"></legend><p data-labels="bind: innerHTML, supportusintro"><ul><li><h4 data-labels="bind: innerHTML, asanideafyer"></h4><p data-labels="bind: innerHTML, ideafyerhelp"></p></li><li><h4 data-labels="bind: innerHTML, asanexec"></h4><p data-labels="bind: innerHTML, exechelp"></p></li><li><h4 data-labels="bind: innerHTML, asadev"></h4><p data-labels="bind: innerHTML, devhelp"></p></li><li><h4 data-labels="bind: innerHTML, asaninvest"></h4><p data-labels="bind: innerHTML, investhelp"></p></li></ul></p></div></div>',u.send=function(e,t){t.classList.remove("pressed"),u.sendRequest(l.get("body"))},u.cancel=function(e,t){t.classList.remove("pressed"),l.set("body","")},u.press=function(e,t){t.classList.add("pressed")},u.sendRequest=function(n){var r={},i=new Date;r.request=n,r.date=i.getTime(),r.userid=t.get("user").get("_id"),t.get("transport").request("Support",r,function(e){e==="ok"?l.set("result",a.get("requestsent")):l.set("result",e),setTimeout(function(){l.set("result",""),l.set("body","")},3e3)})},u.setSupportMSG=function(t){p.get("lang")===t||!p.get("translations")[t]?c.reset(JSON.parse(p.toJSON())):c.reset(p.get("translations")[t])},u.setMaintenanceMSG=function(t){d.get("lang")===t||!d.get("translations")[t]?h.reset(JSON.parse(d.toJSON())):h.reset(d.get("translations")[t])},p.sync(t.get("db"),"SUPPORTMSG").then(function(){u.setSupportMSG(f.get("lang"))}),d.sync(t.get("db"),"MAINTENANCE").then(function(){u.setMaintenanceMSG(f.get("lang"))}),f.watchValue("lang",function(){u.setSupportMSG(f.get("lang"),"SUPPORTMSG"),u.setMaintenanceMSG(f.get("lang"),"MAINTENANCE")}),p.watchValue("active",function(){u.setSupportMSG(f.get("lang"))}),d.watchValue("active",function(){u.setMaintenanceMSG(f.get("lang"))}),u}});