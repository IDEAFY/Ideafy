/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","Promise","Store"],function(e,t,n,r,i,s,o,u,a){return function(l,c,h,p){var d=new e,v=i.get("user"),m=i.get("db"),g=new a(i.get("userLanguages")),y=function(){var e=v.get("lang").substring(0,2);l.set("lang",e),g.loop(function(t,n){t.name===e?g.update(n,"selected",!0):g.update(n,"selected",!1)})},b=i.get("labels"),w="step",E=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return y(),d.plugins.addAll({labels:new n(b),select:new n(g,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),model:new n(l,{setTitle:function(e){var t=new Date;e&&e.username&&this.setAttribute("placeholder",b.get("quickstarttitleplaceholderpre")+e.username+b.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),quickstartevent:new r(d)}),d.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:mousedown, help"></div><form class="quickstart-form"><div class="idealang"><div class="currentlang" data-model="bind: displayLang, lang" data-quickstartevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-quickstartevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: mousedown, press; listen:mouseup, next"></div></form><div>',d.place(t.get("quickstart")),d.press=function(e,t){t.classList.add("pressed")},d.next=function(e,t){E.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),w==="step"?(w="screen",l.get("title")===""&&l.set("title",b.get("quickstarttitleplaceholderpre")+l.get("initiator").username+b.get("quickstarttitleplaceholderpost")),l.set("lang",v.get("lang")),l.set("_id","S:QUICK:"+l.get("startTime")),l.sync(m,l.get("_id")).then(function(){return v.set("sessionInProgress",{id:l.get("_id"),type:"quick"}),v.upload()}).then(function(){h("quickstart")})):h("quickstart")},d.stopSpinner=function(){E.stop(),d.dom.querySelector(".next-button").classList.remove("invisible")},d.prev=function(e,t){t.classList.remove("pressed"),c("quickstart")},d.toggleProgress=function(e,t){p()},d.showLang=function(e,t){d.dom.querySelector(".idealang ul").classList.remove("invisible")},d.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),g.loop(function(e,t){n===t?g.update(t,"selected",!0):g.update(t,"selected",!1)})},d.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),l.set("lang",g.get(n).name),d.dom.querySelector(".idealang ul").classList.add("invisible")},d.reset=function(t){var n=new Date,r=l.get("step"),i=new u;t?(r==="quickstart"?w="step":w="screen",r!=="quickwrapup"&&l.set("resumeTime",n.getTime())):(l.set("startTime",n.getTime()),l.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),l.set("lang",v.get("lang")),w="step")},d.help=function(e,t){s.setContent("quickstarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},d}});