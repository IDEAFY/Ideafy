/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,i,n,s,a,r,o,c){function l(e,r,l,d){var u,p,g=new t([]),h=i.get("user"),v=null,m={db:e,view:l,design:r,query:{descending:!0,limit:50}},b=this;g.setTransport(i.get("transport")),d&&(m.query=d),b.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:touchstart, setStart; listen:touchmove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:innerHTML,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul></div>",m.query.q&&(b.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:touchstart, setStart; listen:touchmove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div><h2 data-listideas='bind:innerHTML,doc.authornames'></h2><span class='date' data-listideas='bind:date,doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3><p data-listideas='bind:setDesc,doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, rating'></span> </div></li></ul></div>"),b.plugins.addAll({labels:new n(i.get("labels")),listideas:new n(g,{date:function f(f){f&&(this.innerHTML=a.formatDate(f))},setDesc:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>"))},setRating:function(e){if(void 0===e){var t=this.getAttribute("data-listideas_id"),i=g.get(t).doc.votes||[];this.innerHTML=0===i.length?"":Math.round(100*(i.reduce(function(e,t){return e+t})/i.length))/100}else this.innerHTML=e},setAvatar:function(){}}),listevent:new s(this)}),b.getModel=function(){return g},b.resetQuery=function(e){var t=new c,n=h.get("public-favorites")||[],s={idList:n},a=b.dom.querySelector(".noresult");return m.query=e,g.unsync(),g.reset([]),"fav"===d&&n.length?i.get("transport").request("GetFavList",s,function(i){var n,s,r,o=JSON.parse(i);if(e&&"*"!==e)for(n=0,s=o.length;s>n;n++)r=o[n].value.doc.lang.substring(0,2),e===r&&g.alter("push",o[n]);else g.reset(o);g.getNbItems()?a.classList.add("invisible"):a.classList.remove("invisible"),t.fulfill()}):g.sync(m.db,m.design,m.view,m.query).then(function(){v&&v.hide(),g.getNbItems()?a.classList.add("invisible"):a.classList.remove("invisible"),t.fulfill()}),t},b.setLang=function(e){return"fav"===d?b.resetQuery(e):"*"===e?b.resetQuery({startkey:"[0,{}]",endkey:"[0]",descending:!0,limit:50}):b.resetQuery({startkey:'[1,"'+e+'", {}]',endkey:'[1,"'+e+'"]',descending:!0,limit:50})},b.setStart=function(e){u=[e.pageX,e.pageY],v&&(v.hide(),v=null)},b.showActionBar=function(e,t){var i,n=t.getAttribute("data-listideas_id"),s=!1;p=[e.pageX,e.pageY],v&&v.getParent()===t&&(s=!0),!s&&u[0]-p[0]>40&&p[1]-u[1]<20&&p[1]-u[1]>-20&&(v=new o("idea",t,g.get(n).id),i=document.createDocumentFragment(),v.place(i),t.appendChild(i))},b.init=function(){var e=new c,t=h.get("public-favorites")||[],n={idList:t},s=b.dom.querySelector(".noresult");return"fav"===d?t.length?i.get("transport").request("GetFavList",n,function(t){g.reset(JSON.parse(t)),s.classList.add("invisible"),e.fulfill()}):(g.reset([]),s.classList.remove("invisible"),e.fulfill()):g.sync(m.db,m.design,m.view,m.query).then(function(){g.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),e.fulfill()}),e}}return function(t,i,n,s){return l.prototype=new e,new l(t,i,n,s)}});