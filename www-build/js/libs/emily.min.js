/*
 Emily <VERSION> http://flams.github.com/emily

 The MIT License (MIT)

 Copyright (c) 2012 Olivier Scherrer <pode.fr@gmail.com>
*/

define("Observable",["Tools"],function(e){return function(){var t={};this.watch=function(e,n,r){if(typeof n=="function"){var i=t[e]=t[e]||[],n=[n,r];return i.push(n),[e,i.indexOf(n)]}return!1},this.unwatch=function(e){var n=e[0],e=e[1];return t[n]&&t[n][e]?(delete t[n][e],t[n].some(function(e){return!!e})||delete t[n],!0):!1},this.notify=function(n){var r=t[n],i=e.toArray(arguments).slice(1);return r?(e.loop(r,function(e){try{e&&e[0].apply(e[1]||null,i)}catch(t){}}),!0):!1},this.hasObserver=function(e){return!(!e||!t[e[0]]||!t[e[0]][e[1]])},this.hasTopic=function(e){return!!t[e]},this.unwatchAll=function(e){return t[e]?delete t[e]:t={},!0}}}),define("Promise",["Observable","StateMachine"],function(e,t){return function(){var n,r,i=new t("Unresolved",{Unresolved:[["resolve",function(e){n=e,s.notify("success",e)},"Resolved"],["reject",function(e){r=e,s.notify("fail",e)},"Rejected"],["addSuccess",function(e,t){s.watch("success",e,t)}],["addFail",function(e,t){s.watch("fail",e,t)}]],Resolved:[["addSuccess",function(e,t){e.call(t,n)}]],Rejected:[["addFail",function(e,t){e.call(t,r)}]]}),s=new e;this.resolve=function(e){return i.event("resolve",e)},this.reject=function(e){return i.event("reject",e)},this.then=function(e,t,n,r){return e instanceof Function&&(t instanceof Function?i.event("addSuccess",e):i.event("addSuccess",e,t)),t instanceof Function&&i.event("addFail",t,n),n instanceof Function&&i.event("addFail",n,r),this},this.getObservable=function(){return s},this.getStateMachine=function(){return i}}}),define("StateMachine",["Tools"],function(e){function t(){var t={};this.add=function(e,n,r,i){var s=[];return t[e]?!1:typeof e=="string"&&typeof n=="function"?(s[0]=n,typeof r=="object"&&(s[1]=r),typeof r=="string"&&(s[2]=r),typeof i=="string"&&(s[2]=i),t[e]=s,!0):!1},this.has=function(e){return!!t[e]},this.get=function(e){return t[e]||!1},this.event=function n(n){var r=t[n];return r?(r[0].apply(r[1],e.toArray(arguments).slice(1)),r[2]):!1}}return function(n,r){var i={},s="";this.init=function(e){return i[e]?(s=e,!0):!1},this.add=function(e){return i[e]?!1:i[e]=new t},this.get=function(e){return i[e]},this.getCurrent=function(){return s},this.event=function(t){var n;return n=i[s].event.apply(i[s].event,e.toArray(arguments)),n===!1?!1:(n&&(i[s].event("exit"),s=n,i[s].event("entry")),!0)},e.loop(r,function(e,t){var n=this.add(t);e.forEach(function(e){n.add.apply(null,e)})},this),this.init(n)}}),define("Store",["Observable","Tools"],function(e,t){return function(n){var r=t.clone(n)||{},i=new e,s=new e,o=function(e){var n=t.objectsDiffs(e,r);["updated","deleted","added"].forEach(function(e){n[e].forEach(function(t){i.notify(e,t,r[t]),s.notify(t,r[t],e)})})};this.getNbItems=function(){return r instanceof Array?r.length:t.count(r)},this.get=function(e){return r[e]},this.has=function(e){return r.hasOwnProperty(e)},this.set=function(e,t){var n;return typeof e!="undefined"?(n=this.has(e),r[e]=t,n=n?"updated":"added",i.notify(n,e,r[e]),s.notify(e,r[e],n),!0):!1},this.update=function(e,n,r){var o;return this.has(e)?(o=this.get(e),t.setNestedProperty(o,n,r),i.notify("updated",n,r),s.notify(e,o,"updated"),!0):!1},this.del=function(e){return this.has(e)?(this.alter("splice",e,1)||(delete r[e],i.notify("deleted",e),s.notify(e,r[e],"deleted")),!0):!1},this.delAll=function(e){return e instanceof Array?(e.sort(t.compareNumbers).reverse().forEach(this.del,this),!0):!1},this.alter=function(e){var n,i;return r[e]?(i=t.clone(r),n=r[e].apply(r,Array.prototype.slice.call(arguments,1)),o(i),n):!1},this.watch=function(e,t,n){return i.watch(e,t,n)},this.unwatch=function(e){return i.unwatch(e)},this.getStoreObservable=function(){return i},this.watchValue=function(e,t,n){return s.watch(e,t,n)},this.unwatchValue=function(e){return s.unwatch(e)},this.getValueObservable=function(){return s},this.loop=function(e,n){t.loop(r,e,n)},this.reset=function(e){if(e instanceof Object){var n=t.clone(r);return r=t.clone(e)||{},o(n),!0}return!1},this.toJSON=function(){return JSON.stringify(r)}}}),define("Tools",[],function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(e,t,n){return this.loop(e,function(r,i){if(!t[i]||!n)t[i]=e[i]}),t},count:function(e){var t=0;return this.loop(e,function(){t++}),t},compareObjects:function(e,t){return Object.getOwnPropertyNames(e).sort().join("")==Object.getOwnPropertyNames(t).sort().join("")},compareNumbers:function(e,t){return e>t?1:e<t?-1:0},toArray:function(e){return Array.prototype.slice.call(e)},loop:function(e,t,n){var r;if(e instanceof Object&&t instanceof Function){if(e instanceof Array)for(r=0;r<e.length;r++)t.call(n,e[r],r,e);else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e);return!0}return!1},objectsDiffs:function(e,t){if(e instanceof Object&&t instanceof Object){var n=[],r=[],i=[],s=[];return this.loop(t,function(t,i){typeof e[i]=="undefined"?s.push(i):t!==e[i]?r.push(i):t===e[i]&&n.push(i)}),this.loop(e,function(e,n){typeof t[n]=="undefined"&&i.push(n)}),{updated:r,unchanged:n,added:s,deleted:i}}return!1},jsonify:function(e){return e instanceof Object?JSON.parse(JSON.stringify(e)):!1},clone:function(e){return e instanceof Array?e.slice(0):typeof e!="object"||e===null||e instanceof RegExp?!1:this.mixin(e,{})},getNestedProperty:function(e,t){return e&&e instanceof Object?typeof t=="string"&&t!=""?t.split(".").reduce(function(e,t){return e&&e[t]},e):typeof t=="number"?e[t]:e:e},setNestedProperty:function(e,t,n){if(e&&e instanceof Object){if(typeof t=="string"&&t!=""){var r=t.split(".");return r.reduce(function(e,t,i){return e[t]=e[t]||{},r.length==i+1&&(e[t]=n),e[t]},e)}return typeof t=="number"?(e[t]=n,e[t]):e}return e}}}),define("Transport",["Store"],function(){return function(e){var t=null;this.setReqHandlers=function(e){return e instanceof Object?(t=e,!0):!1},this.getReqHandlers=function(){return t},this.request=function(e,n,r,i){return t.has(e)&&typeof n!="undefined"?(t.get(e)(n,function(){r&&r.apply(i,arguments)}),!0):!1},this.listen=function(e,n,r,i){if(t.has(e)&&typeof n!="undefined"&&typeof r=="function"){var s=function(){r.apply(i,arguments)},o;return o=t.get(e)(n,s,s),function(){o.func.call(o.scope)}}return!1},this.setReqHandlers(e)}});