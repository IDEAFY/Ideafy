/*
 Olives <VERSION> http://flams.github.com/olives
 The MIT License (MIT)
 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
*/

define("DomUtils",["Tools"],function(e){return{getNodes:function(e,t){return this.isAcceptedType(e)?(e.parentNode||document.createDocumentFragment().appendChild(e),e.parentNode.querySelectorAll(t||"*")):!1},getDataset:function(e){var t,i,s,n=0,a={};if(this.isAcceptedType(e)){if(e.hasOwnProperty("dataset"))return e.dataset;for(t=e.attributes.length;t>n;n++)i=e.attributes[n].name.split("-"),"data"==i.shift()&&(a[s=i.join("-")]=e.getAttribute("data-"+s));return a}return!1},isAcceptedType:function(e){return e instanceof HTMLElement||e instanceof SVGElement?!0:!1},setAttribute:function(e,t,i){return e instanceof HTMLElement?(e[t]=i,!0):e instanceof SVGElement?(e.setAttribute(t,i),!0):!1},matches:function(t,i,s){return e.toArray(this.getNodes(t,i)).indexOf(s)>-1}}}),define("Bind.plugin",["Store","Observable","Tools","DomUtils"],function(e,t,i,s){return function(t,n){function a(e){l[e]&&(l[e].forEach(function(e){r.unwatchValue(e)}),delete l[e])}var r=null,o={},c={},l={};this.observers=l,this.setModel=function(t){return t instanceof e?(r=t,!0):!1},this.getModel=function(){return r},this.ItemRenderer=function(e,t){var n=null,o=null,c=null,l=null,d=null;this.setRenderer=function(e){return n=e,!0},this.getRenderer=function(){return n},this.setRootNode=function(e){return s.isAcceptedType(e)?(c=e,e=c.querySelector("*"),this.setRenderer(e),e&&c.removeChild(e),!0):!1},this.getRootNode=function(){return c},this.setPlugins=function(e){return o=e,!0},this.getPlugins=function(){return o},this.items={},this.setStart=function(e){return l=parseInt(e,10)},this.getStart=function(){return l},this.setNb=function(e){return d="*"==e?e:parseInt(e,10)},this.getNb=function(){return d},this.addItem=function(e){var t;return"number"!=typeof e||this.items[e]?!1:(t=this.getNextItem(e),(e=this.create(e))?(t?c.insertBefore(e,t):c.appendChild(e),!0):!1)},this.getNextItem=function(e){var t=Object.keys(this.items).map(function(e){return Number(e)}),s=i.closestGreater(e,t),t=t[s];return t!=e?this.items[t]:void 0},this.removeItem=function(e){var t=this.items[e];return t?(c.removeChild(t),delete this.items[e],a(e),!0):!1},this.create=function(e){if(r.has(e)){var t=n.cloneNode(!0),a=s.getNodes(t);return i.toArray(a).forEach(function(t){t.setAttribute("data-"+o.name+"_id",e)}),this.items[e]=t,o.apply(t),t}},this.render=function(){var e="*"==d?r.getNbItems():d,t=[];if(null!==d&&null!==l){i.loop(this.items,function(i,s){s=Number(s),(l>s||s>=l+e||!r.has(s))&&t.push(s)},this),t.sort(i.compareNumbers).reverse().forEach(this.removeItem,this);for(var s=l,n=e+l;n>s;s++)this.addItem(s);return!0}return!1},this.setPlugins(e),this.setRootNode(t)},this.setItemRenderer=function(e,t){c[e||"default"]=t},this.getItemRenderer=function(e){return c[e]},this.foreach=function(e,t,i,s){var n=new this.ItemRenderer(this.plugins,e);n.setStart(i||0),n.setNb(s||"*"),n.render(),r.watch("added",n.render,n),r.watch("deleted",function(e){n.render(),a(e)},this),this.setItemRenderer(t,n)},this.updateStart=function(e,t){var i=this.getItemRenderer(e);return i?(i.setStart(t),!0):!1},this.updateNb=function(e,t){var i=this.getItemRenderer(e);return i?(i.setNb(t),!0):!1},this.refresh=function(e){return(e=this.getItemRenderer(e))?(e.render(),!0):!1},this.bind=function(e,t,n){var n=n||"",a=e.getAttribute("data-"+this.plugins.name+"_id"),o=n.split("."),c=a||o.shift(),l=a?n:o.join("."),a=i.getNestedProperty(r.get(c),l),d=i.toArray(arguments).slice(3);(a||0===a||a===!1)&&(this.execBinding.apply(this,[e,t,a].concat(d))||s.setAttribute(e,t,a)),this.hasBinding(t)||e.addEventListener("change",function(){r.has(c)&&(l?r.update(c,n,e[t]):r.set(c,e[t]))},!0),this.observers[c]=this.observers[c]||[],this.observers[c].push(r.watchValue(c,function(n){this.execBinding.apply(this,[e,t,i.getNestedProperty(n,l)].concat(d))||s.setAttribute(e,t,i.getNestedProperty(n,l))},this))},this.set=function(e){return s.isAcceptedType(e)&&e.name?(r.set(e.name,e.value),!0):!1},this.getItemIndex=function(e){return(e=s.getDataset(e))&&"undefined"!=typeof e[this.plugins.name+"_id"]?+e[this.plugins.name+"_id"]:!1},this.form=function(e){if(e&&"FORM"==e.nodeName){var t=this;return e.addEventListener("submit",function(s){i.toArray(e.querySelectorAll("[name]")).forEach(t.set,t),s.preventDefault()},!0),!0}return!1},this.addBinding=function(e,t){return e&&"string"==typeof e&&"function"==typeof t?(o[e]=t,!0):!1},this.execBinding=function(e,t){return this.hasBinding(t)?(o[t].apply(e,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(e){return o.hasOwnProperty(e)},this.getBinding=function(e){return o[e]},this.addBindings=function(e){return i.loop(e,function(e,t){this.addBinding(t,e)},this)},this.setModel(t),this.addBindings(n)}}),define("Event.plugin",["DomUtils"],function(e){return function(t,i){var s=null,n={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},a=!!i;this.addEventListener=function(e,t,i,s){e.addEventListener(this.map(t),i,!!s)},this.listen=function(e,t,i,n){this.addEventListener(e,t,function(t){s[i].call(s,t,e)},!!n)},this.delegate=function(t,i,n,a,r){this.addEventListener(t,n,function(n){e.matches(t,i,n.target)&&s[a].call(s,n,t)},!!r)},this.getParent=function(){return s},this.setParent=function(e){return e instanceof Object?(s=e,!0):!1},this.map=function(e){return a?n[e]||e:e},this.setMap=function(e,t){return"string"==typeof e&&"string"==typeof t?(n[e]=t,!0):!1},this.setParent(t)}}),define("LocalStore",["Store","Tools"],function(e,t){function i(){var e=null,i=localStorage,s=function(){i.setItem(e,this.toJSON())};this.setLocalStorage=function(e){return e&&e.setItem instanceof Function?(i=e,!0):!1},this.getLocalStorage=function(){return i},this.sync=function(n){return"string"==typeof n?(e=n,n=JSON.parse(i.getItem(n)),t.loop(n,function(e,t){this.has(t)||this.set(t,e)},this),s.call(this),this.watch("added",s,this),this.watch("updated",s,this),this.watch("deleted",s,this),!0):!1}}return function(t){return i.prototype=new e(t),new i}}),define("Plugins",["Tools","DomUtils"],function(e,t){return function(i){var s={},n=function(e){return e.trim()},a=function(e,t,i){t.split(";").forEach(function(t){var a=t.split(":"),t=a[0].trim(),a=a[1]?a[1].split(",").map(n):[];a.unshift(e),s[i]&&s[i][t]&&s[i][t].apply(s[i],a)})};this.add=function(e,t){var i=this;return"string"==typeof e&&"object"==typeof t&&t?(s[e]=t,t.plugins={name:e,apply:function(){return i.apply.apply(i,arguments)}},!0):!1},this.addAll=function(t){return e.loop(t,function(e,t){this.add(t,e)},this)},this.get=function(e){return s[e]},this.del=function(e){return delete s[e]},this.apply=function(i){var s;return t.isAcceptedType(i)?(s=t.getNodes(i),e.loop(e.toArray(s),function(i){e.loop(t.getDataset(i),function(e,t){a(i,e,t)})}),i):!1},this.addAll(i)}}),define("OObject",["StateMachine","Store","Plugins","DomUtils","Tools"],function(e,t,i,s,n){return function(a){var r=function(e){var t=c||document.createElement("div");if(!e.template)throw Error("UI.template must be set prior to render");if("string"==typeof e.template?t.innerHTML=e.template.trim():s.isAcceptedType(e.template)&&t.appendChild(e.template),t.childNodes.length>1)throw Error("UI.template should have only one parent node");e.dom=t.childNodes[0],e.plugins.apply(e.dom)},o=function(e,t,i){t&&(i?t.insertBefore(e.dom,i):t.appendChild(e.dom),c=t)},c=null,l=new e("Init",{Init:[["render",r,this,"Rendered"],["place",function(e){r(e),o.apply(null,n.toArray(arguments))},this,"Rendered"]],Rendered:[["place",o,this],["render",r,this]]});this.model=a instanceof t?a:new t,this.plugins=new i,this.dom=this.template=null,this.place=function(e,t){l.event("place",this,e,t)},this.render=function(){l.event("render",this)},this.setTemplateFromDom=function(e){return s.isAcceptedType(e)?(this.template=e,!0):!1},this.alive=function(e){return s.isAcceptedType(e)?(this.setTemplateFromDom(e),this.place(e.parentNode,e.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return c}}}),define("Place.plugin",["OObject","Tools"],function(e,t){return function(i){var s={};this.place=function(t,i){if(!(s[i]instanceof e))throw Error(i+" is not an OObject UI in place:"+i);s[i].place(t)},this.set=function(t,i){return"string"==typeof t&&i instanceof e?(s[t]=i,!0):!1},this.setAll=function(e){t.loop(e,function(e,t){this.set(t,e)},this)},this.get=function(e){return s[e]},this.setAll(i)}}),define("SocketIOTransport",["Observable","Tools"],function(){return function(e){var t=null;this.setSocket=function(e){return e&&"function"==typeof e.emit?(t=e,!0):!1},this.getSocket=function(){return t},this.on=function(e,i){return t.on(e,i)},this.once=function(e,i){return t.once(e,i)},this.emit=function(e,i,s){return t.emit(e,i,s)},this.removeListener=function(e,i,s){return t.removeListener(e,i,s)},this.request=function(e,t,i,s){return"string"==typeof e&&"undefined"!=typeof t?(t={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t},this.once(t.eventId,function(){i&&i.apply(s||null,arguments)}),this.emit(e,t),!0):!1},this.listen=function(e,t,i,s){if("string"==typeof e&&"undefined"!=typeof t&&"function"==typeof i){var n={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t,keepAlive:!0},a=function(){i&&i.apply(s||null,arguments)},r=this;return this.on(n.eventId,a),this.emit(e,n),function(){r.emit("disconnect-"+n.eventId),r.removeListener(n.eventId,a)}}return!1},this.setSocket(e)}}),define("Stack",["Tools"],function(){var e=require("Tools");return function(t){function i(t){if(!(t>=a.length)){var n=a[t];return-1==e.toArray(s.childNodes).indexOf(n)?i(t+1):n}}var s=document.createDocumentFragment(),n=document.createElement("div"),a=[],r=null;this.add=function(e){return!this.has(e)&&e instanceof HTMLElement?(s.appendChild(e),a.push(e),e):!1},this.remove=function(e){var t;return this.has(e)?(t=a.indexOf(e),s.removeChild(e),a.splice(t,1),e):!1},this.place=function(e){return e instanceof HTMLElement?([].slice.call(s.childNodes).forEach(function(t){this.has(t)&&e.appendChild(t)},this),this._setParent(e)):!1},this.up=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t+1),e}return!1},this.down=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t-1),e}return!1},this.move=function(e,t){if(this.has(e)){var n=a.indexOf(e);return a.splice(n,1),(n=i(t))?s.insertBefore(e,n):s.appendChild(e),a.splice(t,0,e),e}return!1},this.insert=function(e,t){return!this.has(e)&&e instanceof HTMLElement?(a.splice(t,0,e),s.insertBefore(e,s.childNodes[t]),e):!1},this.getPosition=function(e){return a.indexOf(e)},this.count=function(){return s.childNodes.length},this.has=function(e){return this.getPosition(e)>=0},this.hide=function(e){return this.has(e)?(n.appendChild(e),!0):!1},this.show=function(e){return this.has(e)&&e.parentNode===n?(this.move(e,a.indexOf(e)),!0):!1},this.hideAll=function(){a.forEach(this.hide,this)},this.showAll=function(){a.forEach(this.show,this)},this.getParent=function(){return s},this._setParent=function(e){return e instanceof HTMLElement?s=e:!1},this.getHidePlace=function(){return n},this.setHidePlace=function(e){return e instanceof HTMLElement?(n=e,!0):!1},this.getLastTransit=function(){return r},this.transit=function(e){return r&&this.hide(r),this.show(e)?(r=e,!0):!1},this._setParent(t)}}),define("LocationRouter",["Router","Tools"],function(e,t){function i(){function e(){window.location.hash?this.navigate.apply(this,this.parse(window.location.hash)):this.navigate(s)}var i,s="",n=window.location.hash;this.setDefaultRoute=function(e){return e&&"string"==typeof e?(s=e,!0):!1},this.getDefaultRoute=function(){return s},this.parse=function(e){return e.split("#").pop().split("/")},this.toUrl=function(e){return e.join("/")},this.start=function(t){this.setDefaultRoute(t),e.call(this),this.bindOnHashChange(),this.bindOnRouteChange()},this.destroy=function(){this.unwatch(i),window.removeEventListener("hashchange",this.boundOnHashChange,!0)},this.onHashChange=function(){window.location.hash!=n&&e.call(this)},this.boundOnHashChange=this.onHashChange.bind(this),this.bindOnHashChange=function(){window.addEventListener("hashchange",this.boundOnHashChange,!0)},this.bindOnRouteChange=function(){i=this.watch(this.onRouteChange,this)},this.onRouteChange=function(){window.location.hash=this.toUrl(t.toArray(arguments)),n=window.location.hash},this.getLastRoute=function(){return n}}return function(){return i.prototype=new e,new i}});