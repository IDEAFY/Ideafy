/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","CouchDBStore","Store","Promise","service/cardpopup","service/help","service/utils"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v,m){var g=new e,y,b=t.get("quicksetup"),w=i.get("labels"),E=i.get("transport"),S=i.get("db"),x=i.get("user"),T={},N=new o({timer:null,display:!1}),C,k=new o({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),L=new o({"char":{id:"",title:w.get("char"),pic:""},context:{id:"",title:w.get("context"),pic:""},problem:{id:"",title:w.get("problem"),pic:""}}),A={"char":0,context:0,problem:0},O=!0,M={"char":new o,context:new o,problem:new o},_="",D=null,P=0,H="step";return g.plugins.addAll({labels:new n(w),quicksetup:new n(k,{setReload:function(e){e===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){k.get("char").selected&&k.get("context").selected&&k.get("problem").selected?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),quicksetuptimer:new n(N,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicksetupcards:new n(L,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():this.innerHTML=e},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),quicksetupevent:new r(g)}),g.template='<div id = "quicksetup"><div class="previousbutton" data-quicksetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicksetup-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicksetup" data-quicksetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicksetuptimer="bind:setTime, timer; bind: displayTimer, display" data-quicksetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicksetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, char.pic" data-quicksetup="bind: popup, char.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, context.pic" data-quicksetup="bind: popup, context.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, problem.pic" data-quicksetup="bind: popup, problem.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-quicksetup="bind:setSelected, char.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="context" data-quicksetup="bind:setSelected, context.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="problem" data-quicksetup="bind:setSelected, problem.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-quicksetupevent="listen: mousedown, press; listen:mouseup, next" data-quicksetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div></div>',g.place(b),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){H==="step"?(H="screen",p.set("characters",L.get("char")),p.set("contexts",L.get("context")),p.set("problems",L.get("problem")),clearInterval(C),N.set("display",!0),g.updateSessionScore(N.get("timer")).then(function(){h.unsync(),h.sync(i.get("db"),h.get("_id")).then(function(){h.set("elapsedTimers",{quicksetup:N.get("timer")}),h.set("characters",[L.get("char").id]),h.set("contexts",[L.get("context").id]),h.set("problems",[L.get("problem").id]),t.classList.remove("pressed"),v("quicksetup")})})):(t.classList.remove("pressed"),v("quicksetup"))},g.help=function(e,t){f.setContent("quicksetuphelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g.prev=function(e,t){t.classList.remove("pressed"),d("quicksetup")},g.toggleProgress=function(e,t){m(t)},g.toggleTimer=function(e,t){N.set("display",!N.get("display"))},g.push=function(e,t){H!=="screen"&&t.classList.add("pushed")},g.draw=function(e,t){var n=t.getAttribute("name"),r=k.get(n);_now=new Date,H==="step"&&O&&(r.left===0&&(T[n]=p.get("deck")[n].concat(),r.left=T[n].length,k.set(n,r)),r.selected&&alert("please unlock selected card first"),O&&!r.selected&&(O=!1,r.selected===!1?g.drawCard(n).then(function(){var e=!1;t.classList.remove("pushed"),O=!0,k.loop(function(t,n){t.popup===!0&&(e=!0)}),e&&g.setPopup(n)}):(t.classList.remove("pushed"),O=!0)))},g.accept=function(e,t){var n=t.getAttribute("name"),r=k.get(n);H==="step"&&(L.get(n).id?r.selected?(r.selected=!1,k.set(n,r)):(r.selected=!0,k.set(n,r)):(r.selected=!1,k.set(n,r)))},g.zoom=function(e,t){var n=t.getAttribute("name");g.setPopup(n)},g.setPopup=function(t){var n={x:0,y:337},r="left",i=k.get(_)||"",s=k.get(t);i&&(i.popup=!1,k.set(_,i)),s.popup=!0,k.set(t,s),_=t,t==="char"&&(n.x=475),t==="context"&&(n.x=195,r="right"),t==="problem"&&(n.x=342,r="right"),M[t].getNbItems()&&y.reset(M[t].toJSON(),n,r,document.getElementById("quicksetup-popup"))},g.closePopup=function(){var t=k.get(_);t.popup=!1,k.set(_,t),_=""},y=new a(g.closePopup),g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;N.set("display",!1),N.set("timer",r),h.get("step")==="quicksetup"&&(C=setInterval(function(){var e=new Date;N.set("timer",r+e.getTime()-n)},1e3))},g.reset=function(t){t?(P=h.get("elapsedTimers").quicksetup||0,h.get("characters").length?(H="screen",g.getDeck(h.get("deck")).then(function(){g.getCard(h.get("characters")[0],M.char).then(function(){var e=M.char;L.set("char",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("characters",L.get("char"))}),g.getCard(h.get("contexts")[0],M.context).then(function(){var e=M.context;L.set("context",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("contexts",L.get("context"))}),g.getCard(h.get("problems")[0],M.problem).then(function(){var e=M.problem;L.set("problem",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("problems",L.get("problem"))}),k.reset({"char":{selected:!0,left:1,popup:!1},context:{selected:!0,left:1,popup:!1},problem:{selected:!0,left:1,popup:!1}}),_="",N.set("timer",P),N.set("display",!0)})):(g.init(),g.initTimer(P))):g.init()},g.getDeck=function(t){var n=new u,r=new s;return r.setTransport(E),r.sync(S,t).then(function(){var e,t={},s=i.get("user").get("lang");!r.get("default_lang")||r.get("default_lang")===s?e=JSON.parse(r.toJSON()):r.get("translations")&&r.get("translations")[s]?e=r.get("translations")[s]:e=JSON.parse(r.toJSON()),t.char=e.content.characters,t.context=e.content.contexts,t.problem=e.content.problems,t.techno=e.content.techno,p.set("deck",t),n.resolve(),setTimeout(function(){r.unsync()},2e3)}),n},g.getCard=function(t,n){var r=new u,i=new s;return i.setTransport(E),i.sync(S,t).then(function(){n.reset(JSON.parse(i.toJSON())),r.resolve(),setTimeout(function(){i.unsync()},250)}),r},g.drawCard=function(t){var n=new u,r=k.get(t),i=L.get(t),s=Math.floor(Math.random()*T[t].length),o=T[t][s];return g.getCard(o,M[t]).then(function(){var e=M[t];A[t]++,T[t].splice(s,1),i.id=o,i.title=e.get("title"),i.pic=e.get("picture_file"),L.set(t,i),r.left=T[t].length,k.set(t,r),n.resolve()}),n},g.updateSessionScore=function(t){var n=new u,r={sid:h.get("_id"),step:"quicksetup",time:t,cards:A.char+A.context+A.problem};return E.request("UpdateSessionScore",r,function(e){e.res==="ok"?n.resolve():n.reject()}),n},g.init=function(){g.getDeck(i.get("user").get("active_deck")).then(function(){var e=p.get("deck");T.char=e.char.concat(),T.context=e.context.concat(),T.problem=e.problem.concat(),A.char=0,A.context=0,A.problem=0,M={"char":new o,context:new o,problem:new o},_="",O=!0,D=null,L.reset({"char":{id:"",title:w.get("char"),pic:""},context:{id:"",title:w.get("context"),pic:""},problem:{id:"",title:w.get("problem"),pic:""}}),k.reset({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}})}),H="step"},g}});