/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,s,o){function u(e,t,u){var a=this,f=s.get("user"),c=!1,h=new o([]);a.plugins.addAll({auto:new n(h,{setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")},setType:function(e){e==="group"?this.classList.add("group"):this.classList.remove("group")}}),select:new r(a)}),a.template='<div class = "autocontact"><div class="autoclose" data-select="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:setType, type; bind:setSelected, selected" data-select="listen:mousedown, select"></li></ul></div>',a.init=function(){var n=f.get("connections"),r=[],s=[],o={};h.reset([]);for(i=0,l=n.length;i<l;i++)r.push(n[i].username),o[n[i].username]=n[i].type;r.sort().forEach(function(e){h.alter("push",{username:e,type:o[e]})});if(t.value){s=t.value.split(/,|;/);for(i=0,l=s.length;i<l;i++)s[i]=s[i].trim()}h.loop(function(e,t){s.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})},a.updateList=function(){var n,r,s=[],o={};if(t.value){c=!0,n=t.value.split(/,|;/),r=n[n.length-1].trim().toLowerCase(),h.reset([]),f.get("connections").forEach(function(e){e.username.toLowerCase().search(r)===0&&h.alter("push",{username:e.username,type:e.type})});if(t.value){currentList=t.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++)currentList[i]=currentList[i].trim()}h.loop(function(e,t){currentList.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})}},a.close=function(t,n){t.stopPropagation(),e.classList.add("invisible")},a.select=function(e,t){var n=t.getAttribute("data-auto_id"),r=h.get(n).selected;h.update(n,"selected",!r),r?a.remove(h.get(n)):a.add(h.get(n))},a.add=function(n){var r;if(n.type==="user")if(!c)t.value?t.value+=", "+n.username:t.value=n.username;else{var s=t.value.split(/,|;/),o="";s.forEach(function(e){e=e.trim()}),s.pop();for(i=0,l=s.length;i<l;i++)o+=s[i]+", ";o+=n.username,t.value=o,c=!1}else f.get("connections").forEach(function(e){e.username===n.username&&(r=e.contacts)}),r.forEach(function(e){t.value.search(e.username)<0&&(a.add(e),h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!0)}))});u(t.value)},a.remove=function(n){var r,s="";if(n.type==="user"){r=t.value.split(/,|;/);for(i=0,l=r.length;i<l;i++)r[i]=r[i].trim();r.splice(r.indexOf(n.username),1),r.forEach(function(e){s+=e+", "}),t.value=s.substr(0,s.length-2),u(s.substr(0,s.length-2)),h.loop(function(e,t){e.type==="group"&&e.selected&&f.get("connections").forEach(function(r){r.username===e.username&&JSON.stringify(r).search(n.username)>-1&&h.update(t,"selected",!1)})})}else f.get("connections").forEach(function(e){e.username===n.username&&e.contacts.forEach(function(e){h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!1)}),a.remove(e)})})},a.init(),a.render(),a.place(e)}return function(n,r,i){return u.prototype=new e,new u(n,r,i)}});