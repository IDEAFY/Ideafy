/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","CouchDBDocument","CouchDBView","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new i,p=new i({max:0}),d=new i([]),v=new u,m=(new a({top:255,left:297,lines:8,radius:6,color:"#cccccc"})).spin(),g=t.get("user"),y=t.get("labels"),b,w=60,E=60,S=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=w/t,t=w):(t*=E/n,n=E),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},x=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=w,o=E,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},T=function(){var e="/upload",t=new FormData,n="deckpic",r=b;t.append("type",n),t.append("dir","decks"),t.append("filename",h.get("_id")),t.append("dataString",r),s.uploadFile(e,t,null,function(e){return e})};return v.setTransport(t.get("transport")),c.plugins.addAll({labels:new n(y),range:new n(p,{setCursorWidth:function(e){}}),cards:new n(d,{setStyle:function(e){e&&e==="null"?this.classList.add("invisible"):this.classList.remove("invisible")},formatTitle:function(e){var t,n=this;e&&(t=n.getAttribute("data-cards_id"),d.get(t).type&&d.get(t).type!==4?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?this.setAttribute("style","background-image:url('"+e+"');"):e?(i=(new a({color:"#657b99"})).spin(r),n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');"),i.stop()})):this.setAttribute("style","background-image: none;")}}),deckdetails:new n(h,{formatDate:function(e){e?this.innerHTML=s.formatDate(e):this.innerHTML=""},setPic:function(e){var n,r=this,i;e===""?this.setAttribute("style","background-image:url('img/connect/graygroup.png');"):e==="img/logo.png"?this.setAttribute("style","background-image:url('img/logo.png');"):e==="decklogo"&&(i=(new a({color:"#657b99"})).spin(r),n={dir:"decks",filename:h.get("_id")},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');"),i.stop()})),h.get("created_by")===g.get("_id")&&r.querySelector("input").classList.remove("invisible")},edit:function(e){e===g.get("_id")?(this.setAttribute("contenteditable",!0),this.classList.add("editable")):(this.setAttribute("contenteditable",!1),this.classList.remove("editable"))}}),carouselevent:new r(c),editevent:new r(c)}),c.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: mousedown, editPic"><input class="invisible" type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: change, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" ></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider invisible" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div></div>',c.displayCards=function(t){var n,r=[];d.reset([]);for(n=0;n<5;n++)v.get(t-2+n)?r[n]=v.get(t-2+n).value:r[n]={style:"null"};d.reset(r),m.stop()},c.updateCards=function(e,t){c.displayCards(t.value)},c.displayButtons=function(e,t){c.dom.querySelector(".cancelmail").classList.remove("invisible"),c.dom.querySelector(".sendmail").classList.remove("invisible")},c.hideButtons=function(){c.dom.querySelector(".cancelmail").classList.add("invisible"),c.dom.querySelector(".sendmail").classList.add("invisible")},c.editPic=function(e,t){h.get("created_by")===g.get("_id")&&t.setAttribute("style","background-image: url('img/brainstorm/reload.png')")},c.changePic=function(e,t){var n=new FileReader,r=new Image,i=c.dom.querySelector(".decklogo"),s=(new a({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){x(S(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),b=e,c.displayButtons()})},300)},n.readAsDataURL(t.files[0])},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){var n=JSON.parse(h.toJSON());h.reset({}),h.reset(n),c.hideButtons(),t.classList.remove("pressed")},c.upload=function(e,n){var r=new o,i=c.dom.querySelector(".deckheader h2").innerHTML,s=c.dom.querySelector(".deckdescription").innerHTML,u=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30})).spin(n);n.classList.add("invisible"),r.setTransport(t.get("transport")),r.sync(t.get("db"),h.get("_id")).then(function(){var e=new Date;return b&&(T(),r.set("picture_file","decklogo")),r.set("title",i),r.set("description",s),r.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),r.upload()}).then(function(){l("updated",r.get("_id")),c.hideButtons(),n.classList.remove("pressed"),u.stop()}),b&&T()},c.reset=function(n){var r=c.dom.querySelector(".deckslider");c.dom.querySelector(".cancelmail").classList.add("invisible"),c.dom.querySelector(".sendmail").classList.add("invisible"),b=null,h.reset(n),m.spin(c.dom.querySelector(".deckcarousel")),p.set("max",0),v.reset([]),v.sync(t.get("db"),"library","_view/cards",{key:'"'+h.get("_id")+'"'}).then(function(){v.getNbItems()?r.classList.remove("invisible"):r.classList.add("invisible"),v.getNbItems()&&p.set("max",v.getNbItems()-1),v.unsync(),v.alter("sort",function(e,t){var n=e.value.title,r=t.value.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),c.displayCards(0)})},c}});