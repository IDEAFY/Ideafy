/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","Store","service/map","service/config","./idea-stack","./lists/idealist","Amy/Stack-plugin","lib/spin.min"],function(e,t,i,n,s,a,r,o,c,l,d,u){return function(){var p,g,h,v,f,m,b=new e,y=new a({search:""}),w=o.get("db"),L=(o.get("observer"),new t(b)),k=new c,S=o.get("user"),T=o.get("labels"),M=S.get("lang").substring(0,2),x=new a([{name:"#list-fav",css:"byfav",pushed:!1,lang:null},{name:"#list-date",css:"bydate",pushed:!0,lang:null},{name:"#list-rating",css:"byrating",pushed:!1,lang:null},{name:"#lang",css:"bylang",pushed:!1,lang:M}]),C=new a([{name:"*"}]),A=o.get("userLanguages"),q=new d,H=new u({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();return A.forEach(function(e){C.alter("push",e)}),b.template='<div id = "ideas"><div id="idea-list" class="list"><div class="header blue-light"><div class="option left" data-ideascontrol="toggle:.option.left,mosaic,touchstart,mosaic"></div><span data-label="bind: innerHTML, idealistheadertitle">My Ideas</span><div class="option right" data-ideasevent="listen: touchstart, plus"></div></div><div data-idealiststack="destination" data-ideascontrol="radio:li.list-item,selected,touchstart,selectStart"><div class="tools"><input class="search" type="text" data-search="bind: value, search" data-label="bind: placeholder, searchprivateplaceholder" data-ideasevent="listen: keypress, search"><ul class="listbtns" data-listbtns="foreach"><li class="tools-button" data-listbtns="bind:setName, name; bind:setClass, css; bind:setPushed, pushed; bind:setLang, lang" data-ideasevent="listen:touchstart,show"></li></ul><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-ideasevent="listen: touchstart, setLang; listen:touchend, stopPropagation"></li></ul></div></div></div><div id="ideas-detail" class="details" data-ideaplace="place:details"></div></div>',b.plugins.addAll({idealiststack:q,listbtns:new i(x,{setPushed:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},setLang:function(e){e&&"*"!==e&&(this.setAttribute("style","background-image:url('img/flags/"+e+".png');"),this.innerHTML=""),"*"===e&&(this.setAttribute("style","background-image: none;"),this.innerHTML="*")},setClass:function(e){e&&this.classList.add(e)},setName:function(e){e&&this.setAttribute("name",e)}}),select:new i(C,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;"),this.innerHTML="*"):this.setAttribute("style","background-image:url('img/flags/"+e+".png');")}}),label:new i(T),search:new i(y),ideasevent:new s(b),ideaplace:new n({details:k}),ideascontrol:L}),b.place(r.get("ideas")),b.selectStart=function(e){var t=q.getStack().getCurrentScreen().getModel(),i=e.target.getAttribute("data-listideas_id");k.reset(t,i),y.set("search","")},b.displayHighlightedIdea=function(){var e,t=q.getStack().getCurrentScreen(),i=t.dom.querySelector(".list-item.selected")||t.dom.querySelector("li[data-listideas_id='0']");i?(e=i.getAttribute("data-listideas_id"),i.classList.add("selected"),i.scrollIntoView(),L.init(i),k.reset(t.getModel(),e)):k.displayEmpty(q.getStack().getCurrentName())},b.show=function(e,t){var i=parseInt(t.getAttribute("data-listbtns_id"),10),n=x.get(i).name,s=q.getStack();"#lang"===n?b.dom.querySelector(".langlist").classList.remove("invisible"):(x.loop(function(e,t){t===i?x.update(t,"pushed",!0):x.update(t,"pushed",!1)}),n!==s.getCurrentName&&(s.show(n),s.get(n).getModel().getNbItems()?b.displayHighlightedIdea():k.displayEmpty(n)))},b.setLang=function(e,t){var i,n;e.stopPropagation(),e.preventDefault(),i=t.getAttribute("data-select_id"),n=C.get(i).name,M=n,H.spin(document.getElementById("idea-list")),x.loop(function(e,t){"#lang"===e.name&&x.update(t,"lang",n)}),b.dom.querySelector(".langlist").classList.add("invisible"),["#list-rating","#list-fav","#list-date"].forEach(function(e){var t=q.getStack();t.get(e).setLang(n).then(function(){t.getCurrentName()===e&&H.stop(),t.getCurrentName()===e&&0===t.get(e).getModel().getNbItems()?k.displayEmpty(e):b.displayHighlightedIdea()})})},b.stopPropagation=function(e){e.stopPropagation(),e.preventDefault()},b.mosaic=function(){var e=document.getElementById("ideas-detail");b.dom.classList.toggle("mosaic"),e.classList.contains("invisible")?(e.classList.remove("invisible"),k.reset(p.getModel(),0)):e.classList.add("invisible")},b.plus=function(){r.get("newidea-popup").classList.add("appear"),r.get("cache").classList.add("appear")},b.search=function(e,t){var i;13===e.keyCode&&(""===t.value?(b.dom.querySelector(".listbtns").classList.remove("invisible"),q.getStack().show("#list-date"),x.loop(function(e,t){"#list-date"===e.name?x.update(t,"pushed",!0):x.update(t,"pushed",!1)}),b.displayHighlightedIdea()):(i=S.get("_id").replace(/@/,"at"),b.searchIdea("users:"+i+" AND "+t.value)),t.blur())},b.searchIdea=function(e){b.dom.querySelector(".listbtns").classList.add("invisible"),h.resetQuery({q:e,sort:"\\creation_date<date>",include_docs:!0}).then(function(){q.getStack().show("#list-search"),h.getModel().getNbItems()>0?(y.set("search",h.getModel().get(0).doc.title),b.dom.querySelector(".noresult").classList.add("invisible"),b.displayHighlightedIdea()):b.dom.querySelector(".noresult").classList.remove("invisible")})},b.reset=function(){y.set("search",""),h.resetQuery({q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),g.resetQuery({startkey:'["'+o.get("user").get("_id")+'",{}]',endkey:'["'+o.get("user").get("_id")+'"]',descending:!0,include_docs:!0}),p.resetQuery({key:'"'+S.get("_id")+'"',descending:!0,include_docs:!0}).then(function(){q.getStack().show("#list-date"),b.displayHighlightedIdea()})},S.get("settings").contentLang&&(M=S.get("settings").contentLang,"all"===M&&(M="*"),x.loop(function(e,t){"#lang"===e.name&&x.update(t,"lang",M)})),"*"===M?(f={key:'"'+S.get("_id")+'"',descending:!0},m={endkey:'[0,"'+S.get("_id")+'"]',startkey:'[0,"'+S.get("_id")+'",{},{}]',descending:!0}):(f={key:'[0,"'+S.get("_id")+'","'+M+'"]',descending:!0},m={endkey:'[1,"'+S.get("_id")+'","'+M+'"]',startkey:'[1,"'+S.get("_id")+'","'+M+'",{},{}]',descending:!0}),p=new l(w,"library","_view/ideas",f),h=new l("_fti/local/"+w,"indexedideas","userbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),g=new l(w,"ideas","_view/privatebyvotes",m),v=new l(w,"library","_view/allideas","fav"),q.getStack().add("#list-date",p),q.getStack().add("#list-rating",g),q.getStack().add("#list-search",h),q.getStack().add("#list-fav",v),g.init(),p.init().then(function(){return q.getStack().show("#list-date"),p.getModel().getNbItems()?b.displayHighlightedIdea():k.displayEmpty("#list-date"),v.setLang(M)}).then(function(){S.watchValue("library-favorites",function(e){e.length!==v.getModel().getNbItems()&&v.resetQuery(M).then(function(){"#list-fav"===q.getStack().getCurrentName()&&(v.getModel().getNbItems()?b.displayHighlightedIdea():k.displayEmpty("#list-fav"))})}),S.watchValue("settings",function(e){M=e.contentLang?"all"===e.contentLang?"*":e.contentLang:S.get("lang").substring(0,2),x.loop(function(e,t){"#lang"===e.name&&x.update(t,"lang",M)}),["#list-date","#list-rating","#list-fav"].forEach(function(e){q.getStack().get(e).setLang(M)})})}),b}});