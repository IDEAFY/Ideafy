/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,i,s,a,r,o){return function(c,l){var d,u=new e,p=t.get("user"),h=t.get("labels"),g={_id:"",default_lang:p.get("lang"),title:"",didYouKnow:"",deck:[],category:"",coefficient:1,sources:[],created_by:p.get("_id"),created_on:[],picture_credit:"",type:null,picture_file:""},f=new n,v=new a({error:""}),m=87,b=87,w=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=m/t,t=m):(t*=b/n,n=b),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},y=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),r=a.getContext("2d"),o=m,c=b;s.src=e,setTimeout(function(){a.width=o,a.height=c,n=Math.floor(Math.max(0,(s.width-o)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),r.drawImage(s,n,i,o,c,0,0,o,c),t(a.toDataURL("image/png"))},300)},k=function(){var e="/upload",t=new FormData,n="cardpic",i="cards",s=d;t.append("type",n),t.append("dir",i),t.append("filename",f.get("_id")),t.append("dataString",s),r.uploadFile(e,t,null,function(e){"ok"!==e.response&&console.log(e)})},L=new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin();return f.setTransport(t.get("transport")),u.plugins.addAll({label:new i(h),model:new i(f,{setTitle:function(e){e&&""!==e&&"<br>"!==e?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=h.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},formatTitle:function(e){switch(e){case 2:this.setAttribute("style","background: #5f8f28");break;case 3:this.setAttribute("style","background: #bd262c");break;case 4:this.setAttribute("style","background: #f27b3d")}},setSources:function(e){this.innerHTML=e&&e.length?e instanceof Array?e.join(", "):e:""},setPic:function(e){var n,i,s=this;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",s.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))}}),error:new i(v),editevent:new s(u)}),u.template='<div class="cardpopup editcard"><div class="card-detail"><div class="cd-header blue-dark" data-model="bind:formatTitle, type"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: touchstart, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class ="cardpicture" data-model="bind:setPic, picture_file"></div><div class="picinfo"><span class="cd-creditslbl"data-label="bind:innerHTML, credits"></span><input type="text" class="input editcredit" data-label="bind: placeholder, picturecredit" data-model="bind:value, picture_credit"></div><button class="choosepic" data-label="bind:innerHTML, importpiclbl" data-editevent="listen: touchstart, press; listen:touchend, picturePreview"></button><button class="takepic" data-editevent="listen: touchstart, press; listen:touchend, cameraPreview" data-label="bind:innerHTML, importcameralbl"></button></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><textarea class="input enterdyknow" data-label="bind: placeholder, enterdyknow" data-model="bind:value,didYouKnow"></textarea><span class="cd-sourcelbl" data-label="bind:innerHTML, source"></span><textarea class="input entersources" data-label="bind: placeholder, dyknowsources" data-model="bind: value, sources"></textarea></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:touchstart, press; listen:touchend, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:touchstart, press; listen:touchend, upload" data-label="bind:innerHTML, savelbl">Save</div></div></div>',u.reset=function(e,n,i){var s=new Date;d=null,v.set("error",""),f.reset(),"newcard"===n?(f.reset(g),f.set("_id","C:"+s.getTime()),f.set("created_on",[s.getFullYear(),s.getMonth(),s.getDate()]),f.set("deck",[e]),"contexts"===i&&(f.set("type",2),f.set("picture_file","img/decks/context.png")),"problems"===i&&(f.set("type",3),f.set("picture_file","img/decks/problem.png")),"techno"===i&&(f.set("type",4),f.set("picture_file","img/decks/technology.png"))):f.sync(t.get("db"),n)},u.changeType=function(e){switch(e){case 1:f.set("type",2),f.set("picture_file","img/decks/context.png");break;case 2:f.set("type",3),f.set("picture_file","img/decks/problem.png");break;case 3:f.set("type",4),f.set("picture_file","img/decks/technology.png");break;default:f.set("type",2),f.set("picture_file","img/decks/context.png")}},u.clearDefault=function(e,t){var n=t.getAttribute("name");""===f.get(n)&&(t.innerHTML="")},u.updateTitle=function(e,t){var n=t.innerHTML;n=4===f.get("type")?n.toUpperCase():n.charAt(0).toUpperCase()+n.slice(1),f.set("title",n)},u.picturePreview=function(e,t){var n,i,s=navigator.camera.PictureSourceType.PHOTOLIBRARY,a=new Image,r={quality:50,correctOrientation:!0,sourceType:s},c=new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin(),l=u.dom.querySelector(".cardpicture");n=function(e){a.src=e,l.setAttribute("style","background-image: none"),c.spin(l),setTimeout(function(){y(w(a),function(e){l.setAttribute("style","background-image: url('"+e+"')"),c.stop(),d=e,t.classList.remove("pressed")})},750)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(n,i,r)},u.cameraPreview=function(e,t){var n,i,s=new Image,a={quality:50,correctOrientation:!0},r=new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin(),c=u.dom.querySelector(".cardpicture");n=function(e){s.src=e,c.setAttribute("style","background-image: none"),r.spin(c),setTimeout(function(){y(w(s),function(e){c.setAttribute("style","background-image: url('"+e+"')"),d=e,r.stop(),t.classList.remove("pressed")})},750)},i=function(e){alert("error: "+e),t.classList.remove("pressed")},navigator.camera.getPicture(n,i,a)},u.press=function(e,t){t.classList.add("pressed")},u.cancel=function(e,t){t.classList.remove("pressed"),l(),f.unsync(),f.reset({})},u.upload=function(e,n){var i=new Date;n.classList.remove("pressed"),v.set("error",""),L.spin(n),f.get("title")&&"<br>"!==f.get("title")||v.set("error",h.get("titlerequired")),v.get("error")?L.stop():f.get("_rev")?(f.set("last_modified",[i.getFullYear(),i.getMonth(),i.getDate()]),u.uploadCard(n)):f.sync(t.get("db"),f.get("_id")).then(function(){u.uploadCard()})},u.uploadCard=function(){d&&(k(),f.set("picture_file",f.get("_id"))),f.upload().then(function(){return c(f.get("type"),f.get("_id"))}).then(function(){L.stop(),l(),f.unsync(),f.reset({})})},u}});