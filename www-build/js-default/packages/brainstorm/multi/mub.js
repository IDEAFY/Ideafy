/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","CouchDBDocument","CouchDBView","service/config","Promise","Store","./mubinit","./mubwait","./session/mucontroller","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(r,s){var u=new e,a=new t,p=o.get("user"),d,v,m,g=(new h({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return u.plugins.add("mustack",a),u.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>',u.place(document.getElementById("ideafy-multi")),u.reset=function(t){t?t.mode==="join"?u.join(t.id):u.replayMUSession(t.id):(v.reset(),a.getStack().show("mubinit"))},u.replayMUSession=function(t){m.reset(t,!0),a.getStack().show("musession")},u.join=function(t){var n=new i;n.setTransport(o.get("transport")),n.sync(o.get("db"),t).then(function(){var e=n.get("participants"),r=!1;e.forEach(function(e){e.id===p.get("_id")&&(r=!0)}),r?n.get("step")==="mustart"?(d.reset(t),a.getStack().show("mubwait")):u.startSession(t):(e.push({id:p.get("_id"),username:p.get("username"),intro:p.get("intro")}),n.set("participants",e),e.length===3&&n.set("status","full"),n.upload().then(function(){d.reset(t),a.getStack().show("mubwait")},function(e){console.log(e),alert("failed to join session")}))},function(e){console.log(e),alert("failed to join session")})},u.startSession=function(t){a.getStack().show("musession"),m.reset(t)},v=new f(s),d=new l(s,u.startSession),m=new c(s),a.getStack().add("mubinit",v),a.getStack().add("mubwait",d),a.getStack().add("musession",m),r?r.mode==="join"?(console.log("joining session",r),u.join(r.id)):u.replayMUSession(r.id):a.getStack().show("mubinit"),o.get("observer").watch("start-mu_session",function(e){d.reset(e),a.getStack().show("mubwait")}),u}});