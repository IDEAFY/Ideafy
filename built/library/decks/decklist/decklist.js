/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","Promise","service/utils","service/actionbar"],function(e,t,n,i,s,a,r,o,c,l){return function(t){var o,d,u=new e,p=n.get("labels"),h=n.get("user"),g=new a([]),f=null;return u.plugins.addAll({labels:new i(p),active:new i(h,{}),decks:new i(g,{setVersion:function(e){this.innerHTML=e?p.get("version")+e:""},setAuthor:function(e){"Taiaut"===e?(this.innerHTML="",this.setAttribute("style","background-image:url('img/logo.png');")):this.innerHTML=e},date:function(e){this.innerHTML=e?c.formatDate(e):""}}),decksevent:new s(u)}),u.template='<ul id="deck-list" data-decks="foreach"><li class="list-item" data-decksevent="listen:touchstart, setStart; listen: touchmove, showActionBar"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>',u.setStart=function(e){o=[e.pageX,e.pageY],f&&f.hide()},u.showActionBar=function(e,t){var n,i=t.getAttribute("data-decks_id"),s=!1;d=[e.pageX,e.pageY],f&&f.getParent()===t&&(s=!0),!s&&o[0]-d[0]>40&&d[1]-o[1]<20&&d[1]-o[1]>-20&&(f=new l("deck",t,g.get(i)._id),n=document.createDocumentFragment(),f.place(n),t.appendChild(n))},u.reset=function(e){var n=e||null;g.reset([]),u.getDecks(t,n)},u.getModel=function(){return g},u.getDecks=function(e,t){var i=new r,s=[];switch(e){default:s=h.get("taiaut_decks").concat(h.get("custom_decks"))}i.setTransport(n.get("transport")),i.sync(n.get("db"),{keys:s}).then(function(){var e=h.get("lang"),n=[];i.loop(function(t){t.doc.default_lang&&t.doc.default_lang!==e?t.doc.translations&&t.doc.translations[e]?n.push(t.doc.translations[e]):n.push(t.doc):n.push(t.doc)}),n.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),g.reset(n),t&&t("ok"),i.unsync()})},u.initSelected=function(e,t){var n=u.dom,i=n.querySelector(".list-item[data-decks_id='"+t+"']");e(i),i.classList.add("selected")},u.highlightDeck=function(e,t){var n,i,s=u.dom;return 0===t?(n=s.querySelector(".list-item[data-decks_id='0']"),i=0):(g.loop(function(e,n){e._id===t&&(i=n)}),n=s.querySelector(".list-item[data-decks_id='"+i+"']")),e(n),n.classList.add("selected"),n.scrollIntoView(),i},u.init=function(e){u.reset(e)},h.watchValue("lang",function(){u.getDecks(t)}),u}});