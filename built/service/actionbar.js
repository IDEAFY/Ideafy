/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min","service/confirm"],function(e,t,i,n,s,a,r,o,c,d,u){function p(e,p,g){var h,v=new s([]),f=p.offsetHeight,m=new s({height:f}),b=10,y=n.get("user"),w=n.get("labels"),L=n.get("observer"),k=n.get("transport"),S=n.get("db"),T=this,M=new d({color:"#9AC9CD",lines:10,length:10,width:8,radius:10}).spin(),A=new d({color:"#a0a0a0",lines:10,length:6,width:4,radius:6}).spin();this.plugins.addAll({buttons:new t(v,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(m,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-b)+"px;")},setButtons:function(e){var t=Math.floor((e-b-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new i(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:touchend, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:touchstart, press; listen:touchend, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(){var e=T.dom.parentElement;e&&e.removeChild(e.lastChild)},this.getParent=function(){return p},this.press=function(e,t){e.stopPropagation(),t.classList.add("pressed"),M.el=document.getElementById("abspinner")},this.action=function(e,t){var i=t.getAttribute("data-buttons_id"),s=v.get(i).name;switch(e.stopPropagation(),t.classList.remove("pressed"),s){case"delete":this.deleteItem().then(function(){T.hide()});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":n.get("observer").notify("replay-session",g.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();break;case"unfav":A.spin(t),document.getElementById("public")?this.removeFav("public-favorites"):this.removeFav("library-favorites");break;case"addfav":A.spin(t),document.getElementById("public")?this.addFav("public-favorites"):this.addFav("library-favorites")}},h=function(e,t){var i;switch(e){case"idea":i=new a,i.setTransport(k),i.sync(S,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){var e=y.get("public-favorites")||[],s=y.get("library-favorites")||[];if(t=i.get(0).doc,g=i.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&v.alter("push",{name:"edit",icon:"img/wall/35modify.png"}),t.sessionId&&""!==t.sessionId&&-1===t.sessionId.search("deleted")&&(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1)){var r=new a;r.setTransport(n.get("transport")),r.sync(n.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){r.get(0)&&v.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}document.getElementById("public")?e.indexOf(t._id)>-1?v.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):v.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"}):document.getElementById("library")&&(s.indexOf(t._id)>-1?v.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):v.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"})),v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?v.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&v.alter("push",{name:"share",icon:"img/wall/35share.png"})),1!==t.authors.length||t.authors[0]!==y.get("_id")||t.twocents.length||t.sharedwith.length||"public"===t.visibility||v.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),-1===t.authors.indexOf(y.get("_id"))&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"deck":var s=new r;s.setTransport(k),s.sync(S,g).then(function(){s.get("created_by")===y.get("_id")&&(y.get("connections")&&y.get("connections").length?v.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&v.alter("push",{name:"share",icon:"img/wall/35share.png"})),y.get("taiaut_decks").length+y.get("custom_decks").length>1&&v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),v.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),"user"===t.type&&v.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})}},this.deleteItem=function(){var t=new o,i=new r,s=this;switch(i.setTransport(k),e){case"idea":1===g.authors.length&&g.authors[0]===y.get("_id")?i.sync(n.get("db"),g._id).then(function(){return i.remove()}).then(function(){t.fulfill()}):k.request("RemoveFromLibrary",{id:g._id,userid:y.get("_id")},function(){t.fulfill()});break;case"deck":y.get("active_deck")===g?(alert(w.get("cannotdelactivedeck")),s.hide()):(document.getElementById("cache").classList.add("appear"),confirmUI=new u(document.body,w.get("deldeckwarning"),function(e){var n=new d({lines:10,length:20,width:8,radius:10}).spin();if(e)if(n.spin(document.getElementById("deckview")),document.getElementById("cache").classList.add("appear"),y.get("taiaut_decks").indexOf(g)>-1){var a=y.get("taiaut_decks");a.splice(a.indexOf(g),1),y.set("taiaut_decks",a),y.upload().then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})}else i.sync(S,g).then(function(){var e=i.get("sharedwith")||[],s=y.get("custom_decks").concat();e.length&&e.indexOf(y.get("_id"))>-1?(e.splice(e.indexOf(y.get("_id")),1),i.set("sharedwith",e),i.upload.then(function(){return s.splice(s.indexOf(g),1),y.set("custom_decks",s),y.upload()}).then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})):i.get("created_by")===y.get("_id")&&k.request("DeleteDeck",{id:g,userid:y.get("_id")},function(e){"ok"===e?(s.splice(s.indexOf(g),1),y.set("custom_decks",s),y.upload().then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})):console.log(e)})});else s.hide();document.body.removeChild(document.querySelector(".confirm"))},"importcard-confirm"));break;case"message":var a,c,p=y.get("notifications");for(a=0,l=p.length;l>a;a++)if(JSON.stringify(p[a])===JSON.stringify(g)){c=a;break}p.splice(c,1),y.set("notifications",p),y.upload();break;case"contact":var p=y.get("connections"),h=new Date,v=[h.getFullYear(),h.getMonth(),h.getDate(),h.getHours(),h.getMinutes(),h.getSeconds()];if("user"===g.type){for(a=p.length-1;a>=0;a--)if("user"===p[a].type&&p[a].userid===g.userid)p.splice(a,1);else if("group"===p[a].type){var f=p[a].contacts;for(j=f.length-1;j>=0;j--)f[j].userid===g.userid&&f.splice(j,1)}}else for(a=p.length-1;a>=0;a--)p[a].username===g.username&&p.splice(a,1);y.set("connections",p),"user"===g.type&&y.get("news").unshift({type:"CX-",date:v,content:{userid:g.userid,username:g.username}}),y.upload().then(function(){if("user"===g.type){var e=(new Date,{dest:[g.userid],date:v,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:g.username,ccList:"",object:y.get("username")+w.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}});k.request("Notify",e,function(e){console.log(e)})}L.notify("contact-deleted")})}return t},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?L.notify("public-edit",g._id):L.notify("library-edit",g._id)}M.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?L.notify("public-sendmail",g):L.notify("library-sendmail",g);break;case"message":break;case"contact":L.notify("message-contact",g)}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?L.notify("public-share",g):L.notify("library-share",g);break;case"deck":L.notify("deck-share",g);break;case"message":break;case"contact":}},this.sendTwocent=function(){c.reset(g)},this.addFav=function(e){var t;t=y.get(e)?y.get(e).concat():[],t.length<100?(t.push(g._id),y.set(e,t),y.upload().then(function(){A.stop(),alert(w.get("addedfav")),T.hide()})):(A.stop(),alert(w.get("maxfavsize")),T.hide())},this.removeFav=function(e){var t;t=y.get(e)?y.get(e).concat():[],t.splice(t.indexOf(g._id),1),y.set(e,t),y.upload().then(function(){A.stop(),alert(w.get("removedfav")),T.hide()})},h(e,g)}return function(t,i,n){return p.prototype=new e,new p(t,i,n)}});