/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./quickstart","./quicksetup","./quickscenario","./quicktech","./quickidea","./quickwrapup","CouchDBDocument","CouchDBView","service/config","Promise","Store","lib/spin.min"],function(e,t,s,i,n,a,r,c,o,l,d,u,p,g,m,h,v){return function(b,f){var w=new e,y=new e,L=(document.createDocumentFragment(),new s),S=g.get("labels"),k=new h([{name:"quickstart",label:S.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}]),T=g.get("user"),x=new u,M=new h,q=new v({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin();return w.plugins.add("quickstack",L),w.template='<div id="ideafy-quick"><div class="stack" data-quickstack="destination"></div></div>',w.place(t.get("ideafy-quick")),y.plugins.addAll({labels:new i(S),step:new i(k,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new n(y)}),y.template='<div class = "progressbar invisible"><ul id = "quicksteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: touchstart, highlightStep; listen:touchend, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: touchstart, press; listen:touchend, exit"></div></div>',y.place(w.dom),y.highlightStep=function(e,t){t.classList.toggle("inactive")},y.changeStep=function(e,t){var s=t.getAttribute("data-step_id");k.get(s).status?(k.loop(function(e,t){s==t?k.update(t,"currentStep",!0):k.update(t,"currentStep",!1)}),L.getStack().show(k.get(s).name)):e.stopImmediatePropagation(),y.dom.classList.add("invisible")},y.press=function(e,t){t.classList.add("pressed")},y.exit=function(e,t){t.classList.remove("pressed"),y.dom.classList.add("invisible"),f()},w.retrieveSession=function(e){q.spin(document.getElementById("brainstorm")),M.reset(),x.unsync(),x.reset(),w.sessionExists(e.id).then(function(){return x.sync(g.get("db"),e.id)}).then(function(){var t=x.get("step"),s=1e4;k.getNbItems(),L.getStack().get("quickstart").reset(e),L.getStack().get("quicksetup").reset(e),L.getStack().get("quickscenario").reset(e),L.getStack().get("quicktech").reset(e),L.getStack().get("quickidea").reset(e),L.getStack().get("quickwrapup").reset(e),k.loop(function(e,i){s>i&&(e.name===t?(s=i,k.update(i,"currentStep",!0),"quickwrapup"===e.name?k.update(i,"status","done"):k.update(i,"status","ongoing")):k.update(i,"status","done"))}),"quickwrapup"===t?(q.stop(),L.getStack().show("quickwrapup"),k.update(0,"currentStep",!1)):(k.update(0,"currentStep",!0),k.update(s,"currentStep",!1),q.stop(),L.getStack().show("quickstart"),"completed"!==x.get("status")&&(T.set("sessionInProgress",e),T.upload()))},function(){q.stop(),alert("session could not be retrieved")})},w.startNewSession=function(){x.unsync(),x.reset(g.get("sessionTemplate")),M.reset({}),x.set("initiator",{id:T.get("_id"),username:T.get("username"),picture_file:T.get("picture_file")}),x.set("mode","quick"),x.set("step","quickstart"),x.set("deck",T.get("active_deck")),x.set("lang",T.get("lang")),L.getStack().get("quickstart").reset(),L.getStack().get("quicksetup").reset(),L.getStack().get("quickscenario").reset(),L.getStack().get("quicktech").reset(),L.getStack().get("quickidea").reset(),L.getStack().get("quickwrapup").reset(),L.getStack().show("quickstart")},w.sessionExists=function(e){var t=new m,s=new p;return s.setTransport(g.get("transport")),s.sync(g.get("db"),"library","_view/sessioncount",{key:'"'+e+'"'}).then(function(){s.getNbItems()?t.fulfill():t.reject("not found")}),t},w.reset=function(e){k.reset([{name:"quickstart",label:S.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}]),e?w.retrieveSession(e):w.startNewSession()},w.prev=function(e){var t;k.loop(function(s,i){s.name===e&&(t=i)}),t>0?(k.update(t,"currentStep",!1),k.update(t-1,"currentStep",!0),L.getStack().show(k.get(t-1).name)):(alert("Exiting session"),f())},w.next=function(e){var t,s,i=L.getStack().get(e),n=new m;return k.loop(function(s,i){s.name===e&&(t=i)}),t<k.getNbItems()-1&&(k.update(t,"currentStep",!1),k.update(t+1,"currentStep",!0),"done"!==k.get(t).status?(k.update(t,"status","done"),k.update(t+1,"status","ongoing"),x.set("step",k.get(t+1).name),x.upload().then(function(){s=L.getStack().get(k.get(t+1).name),s.initTimer&&s.initTimer(),i.stopSpinner(),L.getStack().show(k.get(t+1).name),n.fulfill()})):(i.stopSpinner(),L.getStack().show(k.get(t+1).name),n.fulfill())),n},w.toggleProgress=function(){y.dom.classList.toggle("invisible")},w.init=function(e){x.setTransport(g.get("transport")),L.getStack().add("quickstart",new a(x,w.prev,w.next,w.toggleProgress)),L.getStack().add("quicksetup",new r(x,M,w.prev,w.next,w.toggleProgress)),L.getStack().add("quickscenario",new c(x,M,w.prev,w.next,w.toggleProgress)),L.getStack().add("quicktech",new o(x,M,w.prev,w.next,w.toggleProgress)),L.getStack().add("quickidea",new l(x,M,w.prev,w.next,w.toggleProgress)),L.getStack().add("quickwrapup",new d(x,M,w.prev,w.next,w.toggleProgress)),w.reset(e)},w.init(b),g.get("observer").watch("reconnect",function(){x.get("_id")&&(x.unsync(),x.sync(g.get("db"),x.get("_id")))}),w}});