/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/config","service/map","Store","Olives/Model-plugin","Olives/Event-plugin","service/avatar"],function(e,t,n,r,s,o,u){return function(){var f=new e,c=new e,h=n.get("notify"),p=n.get("notify-popup"),d=t.get("user"),v=t.get("observer"),m=t.get("labels"),g=0,y=0,b=!0,w=new r({unread:0,newmsg:!1}),E=new r([]);return f.plugins.addAll({notif:new s(w,{flashNew:function(e){var t,n=this;e&&(t=setInterval(function(){n.classList.contains("orange")?n.classList.remove("orange"):n.classList.add("orange")},600),setTimeout(function(){clearInterval(t),n.classList.remove("orange"),w.set("newmsg",!1)},3e3))}}),notifevent:new o(f)}),f.template='<div><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: mousedown, press; listen:mouseup, showPopup"></div></div>',f.place(h),f.getUnread=function(){var t=d.get("notifications"),n=0;for(i=0,l=t.length;i<l;i++)t[i].status==="unread"&&n++;return n},f.press=function(e,t){t.classList.add("orange")},f.showPopup=function(e,t){t.classList.remove("orange"),p.classList.add("show-notify")},c.plugins.addAll({labels:new s(m),notify:new s(E,{setObject:function(e){var t=this.getAttribute("data-notify_id");switch(e){case"CXR":this.innerHTML=E.get(t).username+m.get("CXRobject");break;case"CXRaccept":this.innerHTML=E.get(t).username+m.get("acceptedCXR");break;case"CXRreject":this.innerHTML=E.get(t).username+m.get("rejectedCXR");break;case"CXCancel":this.innerHTML=E.get(t).username+m.get("canceledCX");break;case"DOC":this.innerHTML=E.get(t).username+m.get("sentdocmsg");break;case"2Q+":this.innerHTML=E.get(t).username+m.get("askednew");break;case"2C+":this.innerHTML=E.get(t).username+m.get("senttc");break;default:this.innerHTML=E.get(t).object}},setStyle:function(e){e==="unread"?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),notifyevent:new o(c)}),c.template='<div><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:mousedown, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:mousedown, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:innerHTML, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>',c.closePopup=function(t,n){p.classList.remove("show-notify")},c.displayComCenter=function(t,n){var r=n.getAttribute("data-notify_id");v.notify("display-message",r),c.closePopup()},f.init=function(){y=f.getUnread(),w.set("unread",y),w.set("newmsg",!1),E.reset(d.get("notifications")),c.place(p)},d.watchValue("notifications",function(){var e=f.getUnread();e>y?(w.set("newmsg",!0),w.set("unread",e),y=e,d.get("settings")&&d.get("settings").notifyPopup&&p.classList.add("show-notify")):e<y&&(w.set("unread",e),y=e),E.reset(d.get("notifications"))}),f}});