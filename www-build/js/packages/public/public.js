/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","Amy/Control-plugin","Olives/Model-plugin","Amy/Delegate-plugin","CouchDBStore","service/map","service/config","./public-stack","service/utils","./lists/list-public","./lists/list-polling","Amy/Stack-plugin","service/submenu"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(){var i=new e,a=s.get("public"),p=a.querySelector(".bydate"),d=a.querySelector(".byrating"),v=o.get("db"),m=new t(this),g=new u,y=new h(s.get("public-menu")),b=new c;i.plugins.addAll({liststack:b,publicevent:new r(this),publiccontrol:m}),this.selectStart=function(e){var t=b.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");g.reset(t,n)},this.show=function(e,t){var n=a.querySelector(".bydate"),r=a.querySelector(".byrating"),i=t.getAttribute("name");i!==b.getStack().getCurrentName&&(b.getStack().show(i),i==="#list-date"?(g.reset(w.getModel(),0),r.classList.remove("pushed"),n.classList.add("pushed")):(g.reset(E.getModel(),0),r.classList.add("pushed"),n.classList.remove("pushed")))},this.selectEnd=function(e){},this.mosaic=function(){var e=document.getElementById("public-detail");a.classList.toggle("mosaic"),e.classList.contains("invisible")&&(e.classList.remove("invisible"),g.reset(w.getModel(),0))},this.plus=function(){s.get("newidea-popup").classList.add("appear"),s.get("cache").classList.add("appear")},this.search=function(e,t){e.keyCode===13&&(t.value===""?(p.setAttribute("style","display: inline-block;"),d.setAttribute("style","display: inline-block;"),b.getStack().show("#list-date"),p.classList.add("pushed")):i.searchIdea(t.value))},i.searchIdea=function(t){p.setAttribute("style","display: none;"),d.setAttribute("style","display: none;"),S.resetQuery({q:t,sort:"\\creation_date<date>",include_docs:!0}).then(function(){b.getStack().show("#list-search"),LS=S.getModel(),g.reset(S.getModel(),0)})},i.alive(a),i.showMenu=function(){y.toggleActive(!0)},i.hideMenu=function(){y.toggleActive(!1)},y.toggleActive(!1);var w=new l(v,"library","_view/publicideas"),E=new f(v,"ideas","_view/ideasbyvotes"),S=new f("_fti/local/"+v,"indexedideas","publicbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:60,include_docs:!0});return b.getStack().add("#list-rating",E),b.getStack().add("#list-search",S),b.getStack().add("#list-date",w),E.init(g.reset),w.init(g.reset).then(function(){b.getStack().show("#list-date"),g.reset(w.getModel(),0)}),i}});