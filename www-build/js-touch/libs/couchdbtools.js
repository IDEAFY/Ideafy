/**
 * https://github.com/flams/CouchDB-emily-tools
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

define("CouchDBBase",["Store","Tools","Promise"],function(t,n,r){function i(e){return typeof e=="object"&&typeof e.event=="function"?!0:!1}function s(e){return typeof e=="object"&&typeof e.request=="function"&&typeof e.listen=="function"?!0:!1}function o(e){return typeof e=="object"&&typeof e.fulfill=="function"&&typeof e.reject=="function"&&typeof e.then=="function"?!0:!1}function u(){var e=null,t="CouchDB",n=null,u,a=new r;this.setPromise=function(t){return o(t)?(a=t,!0):!1},this.getPromise=function(){return a},this.getStateMachine=function(){return e},this.setStateMachine=function(n){return i(n)?(e=n,!0):!1},this.getTransport=function(){return n},this.setTransport=function(t){return s(t)?(n=t,!0):!1},this.getHandlerName=function(){return t},this.setHandlerName=function(n){return typeof n=="string"?(t=n,!0):!1},this.sync=function(){return a=new r,(u=this.setSyncInfo.apply(this,arguments))?(e.event("sync"),a):!1},this.unsync=function(){return e.event("unsync")},this.getSyncInfo=function(){return u},this.onSync=function(){},this.onListen=function(){},this.onUnsync=function(){this.stopListening&&this.stopListening(),delete this.stopListening},this.unsync=function(){e.event("unsync")},this.onChange=function(){},this.onAdd=function(){},this.onRemove=function(){},this.setSyncInfo=function(t){return u=t}}return function(n){return u.prototype=new t(n),new u}}),define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(t,n,r,i,s){function o(){this.setSyncInfo=function(t,n,r){return typeof t=="string"&&typeof n=="string"?!r||typeof r=="object"?{database:t,document:n,query:r||{}}:!1:!1},this.onSync=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/"+t.document,query:t.query},function(e){var t=JSON.parse(e);t._id&&(this.reset(t),this.getStateMachine().event("listen")),this.getPromise().fulfill(t)},this)},this.onListen=function(){var t=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:{feed:"continuous",heartbeat:2e4,descending:!0}},function(e){var n;if(e=="\n")return!1;n=JSON.parse(e),n.id==t.document&&n.changes.pop().rev!=this.get("_rev")&&(n.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)},this.onChange=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/"+t.document},function(e){this.reset(JSON.parse(e))},this)},this.onRemove=function(){this.reset({})},this.upload=function(){var t=new i,n=this.getSyncInfo();return n.document?(this.getStateMachine().event("upload",t),t):!1},this.remove=function(){var t=this.getSyncInfo(),n=new i;return this.getStateMachine().event("removeFromDatabase",n),n},this.databaseCreate=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+n.database+"/"+n.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(e){var n=JSON.parse(e);n.ok?(this.set("_rev",n.rev),this.set("_id",n.id),this.getStateMachine().event("listen"),t.fulfill(n)):t.reject(n)},this)},this.databaseUpdate=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+n.database+"/"+n.document,headers:{"Content-Type":"application/json",Connection:"close"},data:this.toJSON()},function(e){var n=JSON.parse(e);n.ok?(this.set("_rev",n.rev),t.fulfill(n)):t.reject(n)},this)},this.databaseRemove=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+n.database+"/"+n.document,query:{rev:this.get("_rev")}},function(e){var n=JSON.parse(e);n.ok?t.fulfill(n):t.reject(n)})},this.setStateMachine(new s("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(t){return o.prototype=new n(t),new o}}),define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(t,n,r,i){function s(){this.setSyncInfo=function(t,n,r,i){return typeof t=="string"&&typeof n=="string"&&typeof r=="string"?!i||typeof i=="object"?{database:t,design:n,view:r,query:i||{}}:!1:!1},this.onSync=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(e){var n=JSON.parse(e);if(!n.rows)throw new Error("CouchDBStore ["+t.database+", "+t.design+", "+t.view+"].sync() failed: "+e);this.reset(n.rows),typeof n.total_rows=="undefined"&&(t.reducedView=!0),this.getStateMachine().event("listen"),this.getPromise().fulfill(n)},this)},this.onListen=function(){var t=this.getSyncInfo();r.mixin({feed:"continuous",heartbeat:2e4,descending:!0},t.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:t.query},function(e){if(e=="\n")return!1;var n=JSON.parse(e),r;t.reducedView?r="updateReduced":n.deleted?r="remove":n.changes&&n.changes[0].rev.search("1-")==0?r="add":r="change",this.getStateMachine().event(r,n.id)},this)},this.onChange=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_design/"+n.design+"/"+n.view,query:n.query},function(e){var n=JSON.parse(e);n.rows.length==this.getNbItems()?n.rows.some(function(e,n){e.id==t&&this.set(n,e)},this):this.evenDocsInStore.call(this,n.rows,t)},this)},this.evenDocsInStore=function(t,n){var r=this.getNbItems();t.length<r?this.loop(function(e,t){e.id==n&&this.del(t)},this):t.length>r&&t.some(function(e,t){if(e.id==n)return this.alter("splice",t,0,e)},this)},this.onAdd=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_design/"+n.design+"/"+n.view,query:n.query},function(e){var n=JSON.parse(e);n.rows.some(function(e,n){e.id==t&&this.alter("splice",n,0,e)},this)},this)},this.onRemove=function(t){this.loop(function(e,n){e.id==t&&this.del(n)},this)},this.updateReduced=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(e){var t=JSON.parse(e);this.set(0,t.rows[0])},this)},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(t){return s.prototype=new n(t),new s}}),define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(t,n,r,i,s){function o(){this.setSyncInfo=function(t,n){if(typeof t=="string"&&typeof n=="object"){var r={database:t,query:n||{}};return Array.isArray(r.query.keys)&&(r.keys=r.query.keys,delete r.query.keys),r}return!1},this.onSync=function(){var t=this.getSyncInfo(),n={path:"/"+t.database+"/_all_docs",query:t.query},r;Array.isArray(t.keys)?(n.method="POST",n.data=JSON.stringify({keys:t.keys}),n.headers={"Content-Type":"application/json"},r=n.data):(n.method="GET",r=JSON.stringify(t.query)),t.query.include_docs=!0,this.getTransport().request(this.getHandlerName(),n,function(e){var n=JSON.parse(e);if(!n.rows)throw new Error('CouchDBBulkDocuments.sync("'+t.database+'", '+r+") failed: "+e);this.reset(n.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this)},this)},this.onListen=function(){var t=this.getSyncInfo();r.mixin({feed:"continuous",heartbeat:2e4,descending:!0,include_docs:!0},t.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:t.query},function(e){var t;if(e=="\n")return!1;var t=JSON.parse(e),n;t.changes[0].rev.search("1-")==0?n="add":t.deleted?n="remove":n="change",this.getStateMachine().event(n,t.id,t.doc)},this)},this.onAdd=function(t){var n=this.getSyncInfo();if(!n.query.startkey&&!n.query.endkey)return!1;n.query.include_docs=!0,n.query.update_seq=!0,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_all_docs",query:n.query},function(e){var n=JSON.parse(e);n.rows.forEach(function(e,n){e.id==t&&this.alter("splice",n,0,e.doc)},this)},this)},this.onChange=function(t,n){this.loop(function(e,r){e.id==t&&this.set(r,n)},this)},this.onRemove=function(t){this.loop(function(e,n){e.id==t&&this.del(n)},this)},this.databaseUpdate=function(t){var n=[],r=this.getSyncInfo();this.loop(function(e){n.push(e.doc)}),this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+r.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:n})},function(e){var n=JSON.parse(e);this.loop(function(e,t){n[t].ok&&(e.doc._rev=n[t].rev)}),t.fulfill(n)},this)},this.upload=function(){var t=new i;return this.getStateMachine().event("upload",t),t},this.setStateMachine(new s("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(t){return o.prototype=new n(t),new o}}),define("CouchDBUser",["CouchDBDocument","Promise"],function(t,n){function r(){var e="_users",t="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(n){return n?(e=n,!0):!1},this.getIdPrefix=function(){return t},this.setIdPrefix=function(n){return n?(t=n,!0):!1},this.setId=function(n){return n?(this.set("_id",t+n),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(r){return this.sync(e,t+r)},this.login=function(){var t=new n,r=this.get("name"),i=this.get("password");return r&&typeof r=="string"&&typeof i=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+r,auth:r+":"+i},t.fulfill,t):t.reject({error:"name & password must be strings"}),t},this.create=function(){var t=new n;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.load(this.get("name")).then(function(){t.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(e){t.fulfill(e)},function(e){t.reject(e)})},this),t}}return function(){return r.prototype=new t,new r}}),define("CouchDBSecurity",["CouchDBDocument"],function(t){function n(){var e="_security";this.setName=function(n){return n?(e=n,!0):!1},this.getName=function(){return e},this.load=function(n){return this.sync(n,e)}}return function(){return n.prototype=new t,new n}});