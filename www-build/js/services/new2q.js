/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","CouchDBStore"],function(e,t,n,r,i,s){return function(){var u=new e,a=new s(i.get("TQTemplate")),f=i.get("user"),l=i.get("labels"),c=140,h=!1,p=new s({error:""});return a.setTransport(i.get("transport")),u.plugins.addAll({new2q:new n(a,{setLength:function(e){e===10&&this.setAttribute("maxlength",c)}}),labels:new n(l),errormsg:new n(p,{setError:function(e){switch(e){case"noquestion":this.innerHTML=l.get("noquestion");break;case"lengthexceeded":this.innerHTML=l.get("lengthexceeded")+" ("+c+l.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new r(u)}),u.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',u.render(),u.place(t.get("new2q-popup")),u.press=function(e,t){t.classList.add("pressed")},u.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),a.unsync(),a.reset(i.get("TQTemplate")),p.reset({error:""})},u.cancel=function(e,t){u.closePopup()},u.upload=function(e,t){var n=new Date,r,s="Q:"+n.getTime();a.get("question")||p.set("error","noquestion"),!p.get("error")&&!a.get("_id")&&!h?(h=!0,r=setInterval(function(){p.get("error")===l.get("uploadinprogress")?p.set("error",l.get("uploadinprogress")+"..."):p.set("error",l.get("uploadinprogress"))},150),a.set("author",f.get("_id")),a.set("username",f.get("username")),a.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),a.set("lang",f.get("lang")),a.sync(i.get("db"),s),setTimeout(function(){a.upload(),i.get("transport").request("UpdateUIP",{userid:f.get("_id"),type:a.get("type"),docId:s,question:a.get("question")},function(e){var t,o=f.get("connections"),c=o.length,h=[],d={type:"2Q+",docId:s,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:f.get("_id"),username:f.get("username"),firstname:f.get("firstname"),toList:"",ccList:"",object:f.get("username")+l.get("askednew"),body:a.get("question"),signature:""};e!=="ok"&&console.log(e),u.closePopup(),clearInterval(r),r=setInterval(function(){p.get("error")===l.get("notifyingcontacts")?p.set("error",l.get("notifyingcontacts")+"..."):p.set("error",l.get("notifyingcontacts"))},150);for(t=0;t<c;t++)o[t].type==="user"&&h.push(o[t].userid);d.dest=h,i.get("transport").request("Notify",d,function(e){var e=JSON.parse(e);console.log(e)})})},500)):t.classList.remove("pressed")},u.checkLength=function(e,t){t.value.length>=c?p.set("error","lengthexceeded"):p.set("error","")},u}});