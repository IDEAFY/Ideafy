/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,i,s,n,a,l,r,d,o,u){return function(){var c=new e,m=n.get("labels"),g=n.get("user"),b=n.get("db"),v=n.get("transport"),f=new l([]),h=new l([]),p=new u,y=(new l([]),new l({modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"})),L=new l([{name:"*"}]),k=n.get("userLanguages"),w="mulistall",S=r.getUserContactIds(),M=new d({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200}).spin();return k.forEach(function(e){L.alter("push",e)}),c.plugins.addAll({labels:new t(m),options:new t(y,{setBg:function(e){"all"===e?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))},setMode:function(e){var t,i,s="";for(t=0,i=e.length;i>t;t++)s+="<option>"+m.get(e[t])+"</option>";this.innerHTML=s}}),select:new t(L,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),muall:new t(f,{setParticipants:function(e){var t,i=e.length+1,s="<ul>";for(t=0;i>t;t++)s+="<li></li>";s+="</ul>",this.innerHTML=s},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){this.setAttribute("style","background-image: url('img/flags/"+e.substring(0,2)+".png');"),this.innerHTML=" "}}),musearch:new t(h,{setParticipants:function(e){var t,i=parseInt(e,10)+1,s="<ul>";for(t=0;i>t;t++)s+="<li></li>";s+="</ul>",this.innerHTML=s},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');"),this.innerHTML=" "}}),mupreview:new o({preview:p}),mulistevent:new i(c)}),c.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><div class="selectlang"><div data-options="bind:setBg, selectedLang"></div><button data-mulistevent = "listen:touchstart, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-mulistevent="listen: touchend, filterLang"></li></ul></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div class="noresult invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: touchstart, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: touchstart, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',c.reset=function(){w="mulistall",M.spin(document.getElementById("mulistspinner")),y.set("selectedLang","all"),y.set("selectedMode","allmodes"),c.buildList(w).then(function(){M.stop()})},c.buildList=function(e,t){var i=[],s=new a;return"mulistall"===e&&(f.reset([]),c.addSessions(i,"roulette").then(function(){return c.addSessions(i,"campfire")}).then(function(){return c.addSessions(i,"boardroom")}).then(function(){i.length?c.dom.querySelector(".noresult").classList.add("invisible"):c.dom.querySelector(".noresult").classList.remove("invisible"),f.reset(i),s.fulfill()})),"musearch"===e&&(h.reset([]),c.syncSearch(i,t).then(function(){i.length?c.dom.querySelector(".noresult").classList.add("invisible"):c.dom.querySelector(".noresult").classList.remove("invisible"),h.reset(i),s.fulfill()})),s},c.syncSearch=function(e,t,i){var n=new a,l=new s;return l.setTransport(v),l.sync("_fti/local/"+b,"indexedsessions","waiting",{q:t,descending:!0}).then(function(){l.loop(function(t){var s=!1;"roulette"===t.fields.mode?s=!0:"campfire"===t.fields.mode&&S.indexOf(t.fields.initiator.id)>-1?s=!0:"boardroom"===t.fields.mode&&t.fields.invited.search(g.get("_id"))>-1&&(s=!0),s&&(i?t.fields.mode.search(i.mode)>-1&&t.fields.lang.search(i.lang)>-1&&e.push(t):e.push(t))}),n.fulfill()}),n},c.addSessions=function(e,t,i){var n=new a,l=new s,r="_view/"+t,d={};return l.setTransport(v),d="roulette"===t?i?{key:'"'+i+'"',descending:!1,limit:50}:{descending:!1,limit:50}:i?{key:'["'+g.get("_id")+'","'+i+'"]',descending:!1}:{startkey:'["'+g.get("_id")+'",{}]',endkey:'["'+g.get("_id")+'"]',descending:!0},l.sync(b,"library",r,d).then(function(){console.log("MODE : ",t,"QUERY : ",JSON.stringify(d),"RESULT : ",l.toJSON()),l.loop(function(t){e.unshift(t)}),n.fulfill(),l.unsync()},function(e){console.log(e,t)}),n},c.search=function(e,t){13===e.keyCode&&(""===t.value?c.toggleList("mulistall"):c.toggleList("musearch"))},c.displayLang=function(){c.dom.querySelector(".langlist").classList.remove("invisible")},c.filterLang=function(e,t){var i=parseInt(t.getAttribute("data-select_id"),10);c.dom.querySelector(".langlist").classList.add("invisible"),0===i?y.set("selectedLang","all"):y.set("selectedLang",L.get(i).name),M.spin(document.getElementById("mulistspinner")),c.filterList().then(function(){M.stop()})},c.filterMode=function(e,t){var i=t.selectedIndex;switch(y.set("selectedMode",y.get("modes")[i]),i){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}M.spin(document.getElementById("mulistspinner")),c.filterList().then(function(){M.stop()})},c.filterList=function(){var e=[],t=document.getElementById("mulist-content").querySelector("input").value,i=new a,s="",n="";return"allmodes"!==y.get("selectedMode")&&(s=y.get("selectedMode")),"all"!==y.get("selectedLang")&&(n=y.get("selectedLang")),""===s&&""===n?c.buildList(w,t).then(function(){i.fulfill()}):"mulistall"===w?(f.reset([]),s?c.addSessions(e,s,n).then(function(){f.reset(e),e.length?c.dom.querySelector(".noresult").classList.add("invisible"):c.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()}):c.addSessions(e,"roulette",n).then(function(){return c.addSessions(e,"campfire",n)}).then(function(){return c.addSessions(e,"boardroom",n)}).then(function(){f.reset(e),e.length?c.dom.querySelector(".noresult").classList.add("invisible"):c.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()})):(h.reset([]),c.syncSearch(e,t,{mode:s,lang:n}).then(function(){h.reset(e),e.length?c.dom.querySelector(".noresult").classList.add("invisible"):c.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()})),i},c.zoom=function(e,t){var i;t.classList.add("pressed"),"mulistall"===w?(i=parseInt(t.getAttribute("data-muall_id"),10),p.reset(f.get(i).id)):"musearch"===w&&(i=t.getAttribute("data-musearch_id"),p.reset(h.get(i).id))},c.toggleList=function(e){e!==w&&(document.getElementById(w).classList.add("invisible"),document.getElementById(e).classList.remove("invisible"),w=e),M.spin(document.getElementById("mulistspinner")),c.filterList().then(function(){M.stop()})},c.refreshList=function(){c.toggleList(w)},p.init(c.refreshList),g.watchValue("lang",function(){var e;y.set("modes",["allmodes","roulette","campfire","boardroom"]),e=y.get("lang"),e.splice(0,1,m.get("all")),y.set("lang",e)}),c}});