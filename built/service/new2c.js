/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,i,n,s,a){return new function(){var r,o=new e,c=new a({userid:"",username:""}),l=s.get("user"),d=new a,u=s.get("labels"),p=s.get("transport"),g=!1,h=new a({error:""});return o.plugins.addAll({new2c:new i(d),dest:new i(c,{setHeader:function(e){this.innerHTML=u.get("sendtcprefix")+e+u.get("sendtcsuffix")}}),labels:new i(u),errormsg:new i(h),new2cevent:new n(o)}),o.template='<div><div class = "header blue-dark"><span data-dest="bind: setHeader, username"></span><div class="close-popup" data-new2cevent="listen:touchstart, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, twocentplaceholder" data-new2c="bind: value, message"></textarea></p><div><span class="errormsg" data-errormsg="bind:innerHTML, error"></span><div class="sendmail" data-new2cevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, sendlbl"></div></div></form></div>',o.render(),o.place(t.get("new2c-popup")),o.press=function(e,t){t.classList.add("pressed")},o.closePopup=function(){document.getElementById("new2c-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),d.reset(),c.reset(),h.reset({error:""})},o.reset=function(e){r=e,t.get("new2c-popup").classList.add("appear"),t.get("cache").classList.add("appear"),c.set("userid",r.userid),c.set("username",r.username),d.reset({author:l.get("_id"),message:"",firstname:l.get("firstname"),username:l.get("username"),date:[],datemod:"",plusones:0,replies:[]}),g=!1},o.cancel=function(){o.closePopup()},o.upload=function(e,t){var i,n=new Date,s={};d.get("message")?(g=!0,i=setInterval(function(){h.get("error")===u.get("sendinginprogress")?h.set("error",u.get("sendinginprogress")+" ..."):h.set("error",u.get("sendinginprogress"))},150),d.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),s.tc=JSON.parse(d.toJSON()),s.userid=c.get("userid"),s.username=c.get("username"),p.request("SendTwocent",s,function(e){var n,a=r.twocents||[],c=l.get("connections");if("ok"===e){for(a.unshift(s.tc),r.twocents=a,n=c.length-1;n>=0;n--)"user"===c[n].type&&c[n].userid===r.userid&&c.splice(n,1,r);l.set("connections",c),l.upload().then(function(){clearInterval(i),t.classList.remove("pressed"),o.closePopup()})}else h.set("error","something went wrong - try again later"),clearInterval(i),t.classList.remove("pressed")})):(h.set("error",u.get("nomessage")),t.classList.remove("pressed"))},o}});