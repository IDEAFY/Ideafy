/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","Place.plugin","Amy/Stack-plugin","Store","service/map","./deckdetails","./cardlist","service/config","./cardeditor/newcard","./deck-share"],function(e,t,n,i,s,a,r,o,c,l,d,u){return function(r){var p=new e,h=new d(r),g=new u,f=new a([{name:"characters",active:!1,count:0},{name:"contexts",active:!1,count:0},{name:"problems",active:!1,count:0},{name:"techno",active:!1,count:0}]),m=new s,v="",b="";return p.plugins.addAll({cardmenu:new t(f,{setClass:function(e){e&&this.classList.add(e)},setActive:function(e){e?this.classList.add("active"):this.classList.remove("active")}}),place:new i({newCard:h,shareDeck:g}),deckviewstack:m,deckviewevent:new n(p)}),p.template='<div id="deckview" class="details"><div data-place="place: newCard"></div><div data-place="place: shareDeck"></div><ul class="card-menu" data-cardmenu="foreach"><li><div class="card-type" data-cardmenu = "bind: setClass, name; bind:setActive, active" data-deckviewevent="listen: touchstart, viewCards"></div><div class="card-count" data-cardmenu="bind:innerHTML, count"></div></li></li></ul><div id="deckviewstack" data-deckviewstack="destination"></div></div>',p.viewCards=function(e,t){var n=t.getAttribute("data-cardmenu_id");f.loop(function(e,t){t===parseInt(n)?f.update(t,"active",!0):f.update(t,"active",!1)}),m.getStack().show(f.get(n).name)},p.editCard=function(e,t){h.reset(e,t,b,v)},p.hideEditView=function(){h&&h.close()},p.reset=function(e,t){p.hideEditView(),g.hide(),p.dom.setAttribute("style","overflow-y: none;"),["details","characters","contexts","problems","techno"].forEach(function(t){m.getStack().get(t).reset(e)}),b=e._id,v=e.title,f.reset([]),["characters","contexts","problems","techno"].forEach(function(t){"newcard"===e.content[t][0]?f.alter("push",{name:t,active:!1,count:e.content[t].length-1}):f.alter("push",{name:t,active:!1,count:e.content[t].length})}),t?m.getStack().show(t):m.getStack().show("details")},p.init=function(){m.getStack().add("details",new o(r)),m.getStack().add("characters",new c("characters",p.editCard,r)),m.getStack().add("contexts",new c("contexts",p.editCard,r)),m.getStack().add("problems",new c("problems",p.editCard,r)),m.getStack().add("techno",new c("techno",p.editCard,r))},l.get("observer").watch("deck-share",function(e){g.reset(e),g.show()}),p}});