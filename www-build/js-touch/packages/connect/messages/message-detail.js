/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/avatar","service/utils","./message-reply"],function(e,t,n,r,s,o,u,a,f){return function(h){var p=new e,d=new f,v=new n,m=new n({response:""}),g=t.get("labels"),y=t.get("user"),b=t.get("observer"),w=t.get("transport");return p.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class="msgdetailarea"><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="more" class="more" data-messageevent="listen:touchstart, press; listen:touchend, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><p data-message="bind:setSignature, type"></p><p class="invisible" data-message="bind:setJoinMsg, sessionStatus"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:touchstart, press; listen:touchend, showDoc"></div><div class="gotosession invisible" data-message="bind: showSessionBtn, sessionStatus" data-messageevent="listen:touchstart, press; listen:touchend, gotoSession"></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: touchstart, press; listen: touchend, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:touchstart, press; listen:touchend, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:touchstart, press; listen:touchend, rejectCXR"></div></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div></div>',p.plugins.addAll({label:new s(g),message:new s(v,{date:function E(E){var e=new Date,t=E[3],n=E[4],r=E[5];E&&E[0]===e.getFullYear()&&E[1]===e.getMonth()&&E[2]===e.getDate()?(t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r):this.innerHTML=a.formatDate(E)+"  "+t+":"+n},setObject:function(e){switch(e){case"CXR":this.innerHTML=v.get("username")+g.get("CXRobject");break;case"INV":this.innerHTML=v.get("username")+g.get("INVObject");break;case"CXRaccept":this.innerHTML=v.get("username")+g.get("acceptedCXR");break;case"CXRreject":this.innerHTML=v.get("username")+g.get("rejectedCXR");break;case"CXCancel":this.innerHTML=v.get("username")+g.get("canceledCX");break;case"DOC":this.innerHTML=v.get("username")+g.get("sentdocmsg");break;case"2Q+":this.innerHTML=v.get("username")+g.get("askednew");break;case"2C+":this.innerHTML=v.get("username")+g.get("senttc");break;case"REF":this.innerHTML=messages.get(id).username+g.get("joinedideafy");break;default:this.innerHTML=v.get("object")}},setBody:function(e){switch(e){case"CXRaccept":this.innerHTML=g.get("youlbl")+g.get("nowconnected")+v.get("username");break;case"DOC":this.innerHTML="<p>"+v.get("body")+"</p><p>"+v.get("username")+"</p><p>"+v.get("signature")+"</p><br><br><p>"+g.get("clicktoview")+" : <b>"+v.get("docTitle")+"</b></p>";break;case"INV":this.innerHTML=v.get("username")+g.get("INVObject")+" : <b>"+v.get("docTitle")+"</b>";break;case"REF":this.innerHTML=g.get("referral");break;default:this.innerHTML=v.get("body").replace(/\n/g,"<br>")}},setSignature:function(e){e==="MSG"?(this.classList.remove("invisible"),this.innerHTML=v.get("signature")):this.classList.add("invisible")},showOptions:function(e){e.search("CX")>-1||e==="2Q+"||e==="INV"?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(e){e?this.innerHTML=e:this.innerHTML=g.get("melbl")},showCcList:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(e){e==="CXR"?this.classList.remove("invisible"):this.classList.add("invisible")},showDocBtn:function(e){e==="DOC"?this.classList.remove("invisible"):this.classList.add("invisible")},showSessionBtn:function(e){e&&e==="waiting"&&!v.get("joined")?this.classList.remove("invisible"):this.classList.add("invisible")},setJoinMsg:function(e){e?(this.classList.remove("invisible"),e==="unavailable"?this.innerHTML=g.get("nolongerjoin"):e==="joined"?this.innerHTML=g.get("joinedsession"):e==="waiting"&&(this.innerHTML=g.get("clicktojoin"))):this.classList.add("invisible")},showTwoQ:function(e){e==="2Q+"||e==="2C+"?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u([t]);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)}}),cxr:new s(m,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(e){e==="YES"?this.innerHTML=g.get("CXRaccepted")+v.get("username")+g.get("isnowacontact"):this.innerHTML=g.get("CXRrejected")}}),messageevent:new o(p)}),p.showDoc=function(t,n){n.classList.remove("pushed"),v.get("type")==="DOC"&&b.notify("display-doc",v.get("docId"),v.get("docType"))},p.showTwoQ=function(t,n){n.classList.remove("pushed"),v.get("type")==="2Q+"&&b.notify("display-twoq",v.get("docId"),v.get("author")),v.get("type")==="2C+"&&b.notify("display-twoc")},p.press=function(e,t){t.classList.add("pushed")},p.action=function(e,t){var n=t.getAttribute("name"),r=document.getElementById("msgreply"),i=document.querySelector(".msgoptionlist");switch(n){case"more":i.classList.remove("invisible");break;case"reply":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"reply"),r.classList.remove("invisible");break;case"replyall":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"replyall"),r.classList.remove("invisible");break;case"forward":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"forward"),r.classList.remove("invisible");break;case"deletemsg":i.classList.add("invisible"),p.deletemsg(v.toJSON()),h("#defaultPage");break;default:}t.classList.remove("pushed")},p.deletemsg=function(t){var n=y.get("notifications").concat(),r;for(i=0,l=n.length;i<l;i++)if(JSON.stringify(n[i])===t){r=i;break}n.splice(r,1),y.set("notifications",n),y.upload()},p.acceptCXR=function(e,t){var n=y.get("connections"),r=y.get("news")||[],s=0,o=new Date,u=[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];t.classList.remove("pushed");for(i=0,l=n.length;i<l;i++)n[i].type==="user"?(n[i].lastname<v.get("contactInfo").lastname&&s++,n[i].lastname===v.get("contactInfo").lastname&&n[i].firstname<v.get("contactInfo").firstname&&s++):n[i].username<v.get("contactInfo").lastname&&s++;n.splice(s,0,v.get("contactInfo")),y.set("connections",n),r.unshift({type:"CX+",date:u,content:{userid:v.get("author"),username:v.get("username")}}),y.set("news",r),y.upload().then(function(){var e={dest:[v.get("author")],date:u,original:"",type:"CXRaccept",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:v.get("username"),ccList:"",object:y.get("username")+g.get("acceptedCXR"),body:g.get("youlbl")+g.get("nowconnected")+y.get("username"),signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};m.set("response","YES"),w.request("Notify",e,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){p.deletemsg(v.toJSON()),h("#defaultPage")},1e3)})})},p.rejectCXR=function(e,t){var n,r=new Date;t.classList.remove("pushed"),m.set("response","NO"),n={dest:[v.get("author")],original:"",date:[r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds()],type:"CXRreject",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:v.get("username"),ccList:"",object:y.get("username")+g.get("rejectedCXR"),body:"",signature:""},w.request("Notify",n,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){p.deletemsg(v.toJSON()),h("#defaultPage")},1500)})},p.checkSessionStatus=function(n){var i=new r;i.setTransport(w),i.sync(t.get("db"),n).then(function(){i.get("status")==="waiting"?v.set("sessionStatus","waiting"):v.set("sessionStatus","unavailable"),i.unsync()},function(e){alert(e)})},p.gotoSession=function(e,n){var r=y.get("notifications");n.classList.remove("pushed"),v.set("joined",!0),t.get("observer").notify("join-musession",v.get("docId"));for(i=0,l=r.length;i<l;i++)if(r[i].type==="INV"&&r[i].docId===v.get("docId")){r[i].joined=!0;break}y.set("notifications",r),y.upload()},p.reset=function(t){v.reset({}),m.reset({response:""}),v.reset(t),d.reset(t,"reply"),v.get("type")==="INV"&&(v.get("joined")?v.set("joined",!0):(v.set("sessionStatus",null),p.checkSessionStatus(v.get("docId"))))},p}});