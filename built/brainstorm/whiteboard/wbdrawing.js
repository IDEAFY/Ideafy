/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,s,n,a,r,c,o){return function(t,d){var u,p=new e,g=null,h=[],v=new r({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m=new r([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),b=new r([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),f=s.get("labels"),w=new r({status:null}),y=new r({type:"drawing",content:"",background:""}),L=function(e){var t=new c,i="/upload",n=new FormData,a="postit",r="sessions/"+u,d=p.dom.querySelector(".drawingcanvas"),l=d.toDataURL("image/png"),g=new Date,h=e||s.get("user").get("_id")+"_"+g.getTime();return n.append("type",a),n.append("dir",r),n.append("filename",h),n.append("dataString",l),o.uploadFile(i,n,w,function(){y.set("content",h),y.set("background",v.get("bg")),t.fulfill()}),t},k=93;return p.plugins.addAll({labels:new n(f),color:new n(m,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),pencil:new n(v,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){"pencil"===e?this.setAttribute("fill",v.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){"pencil"===v.get("mode")?this.setAttribute("fill",e):this.setAttribute("fill",v.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new n(b,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),uploadprogress:new n(w,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),drawing:new n(y,{draw:function(e){var t,i=s.get("transport"),n=this;e&&(t={dir:"sessions/"+u,filename:e},i.request("GetFile",t,function(e){var t=new Image,i=n.getContext("2d");t.src=e,i.drawImage(t,0,0)}))}}),drawingevent:new a(p)}),p.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:touchstart, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:touchstart, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:touchstart, select; listen:touchend,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:touchstart, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:touchstart, stop; listen:touchmove,stop; listen:touchend,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:touchstart, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:touchstart, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:touchstart, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:touchstart, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:touchstart, select; listen:touchend,cancel"></div><div class="deletedrawing" data-drawingevent="listen:touchstart,select;listen:touchend,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:touchstart, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:touchstart,start;listen:touchmove,move;listen:touchend,end;" data-drawing="bind:draw, content"></canvas></div>',p.setSessionId=function(e){u=e},p.clear=function(e,t){var i=p.dom.querySelector(".drawingcanvas"),s=i.getContext("2d");s.clearRect(0,0,i.width,i.height),t.classList.remove("selected")},p.resetColors=function(){v.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),b.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},p.erase=function(){v.set("mode","erase"),v.set("color",v.get("bg"))},p.drawactive=function(){v.set("mode","pencil"),m.loop(function(e){e.active&&v.set("color",e.color)})},p.expand=function(e,t){var i=t.getAttribute("name"),s=document.getElementById(i);s.classList.contains("invisible")?s.classList.remove("invisible"):s.classList.add("invisible")},p.stop=function(e){e.stopPropagation()},p.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},p.select=function(e,t){t.classList.add("selected")},p.getColor=function(e,t){var i=t.getAttribute("data-color_id");e.stopPropagation(),m.loop(function(e,t){t===parseInt(i)?m.update(t,"active",!0):m.update(t,"active",!1)}),v.set("color",m.get(i).color),v.set("mode","pencil"),t.parentNode.classList.add("invisible")},p.getBgColor=function(e,t){var i=t.getAttribute("data-bgcolor_id");e.stopPropagation(),b.loop(function(e,t){t===parseInt(i)?b.update(t,"active",!0):b.update(t,"active",!1)}),v.set("bg",b.get(i).color),t.parentNode.classList.add("invisible")},p.cancel=function(e,t){p.clear(e,t),p.resetColors(),y.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),d("drawing")},p.deletedrawing=function(e,i){(g||0===g)&&t.del(g),p.cancel(e,i)},p.post=function(e,i){i.classList.add("selected"),L(y.get("content")).then(function(){g||0===g?t.alter("splice",g,1,JSON.parse(y.toJSON())):t.alter("push",JSON.parse(y.toJSON())),i.classList.remove("selected"),p.cancel(e,i),w.reset({status:""})})},p.reset=function(e){var i=p.dom.querySelector(".drawingcanvas");g=e,p.resetColors(),h=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&i.setAttribute("height",380),g||0===g?(y.reset(t.get(e)),v.set("bg",y.get("background")),b.loop(function(e,t){e.color===y.get("background")?b.update(t,"active",!0):b.update(t,"active",!1)})):y.reset({type:"drawing",content:"",background:""})},p.start=function(e,t){var s=e.touches,n=t.offsetLeft+k;for(i=0,l=s.length;l>i;i++){var a=s[i];h[a.identifier]={x:a.pageX-n,y:a.pageY-t.offsetTop}}e.preventDefault()},p.end=function(){},p.move=function(e,t){var s=e.touches,n=t.offsetLeft+k;for(i=0,l=s.length;l>i;i++){var a=s[i],r=a.identifier,c=a.pageX-n-h[r].x,o=a.pageY-t.offsetTop-h[r].y,d=p.draw(t,r,c,o);h[r]={x:d.x,y:d.y}}e.preventDefault()},p.draw=function(e,t,i,s){var n=e.getContext("2d");return n.lineWidth=v.get("size"),n.strokeStyle=v.get("color"),n.lineCap=v.get("cap"),n.beginPath(),n.moveTo(h[t].x,h[t].y),n.lineTo(h[t].x+i,h[t].y+s),n.stroke(),n.closePath(),{x:h[t].x+i,y:h[t].y+s}},p}});