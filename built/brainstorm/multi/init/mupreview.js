/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min"],function(e,t,i,s,n,a,l,r,d){return function(){var r,o=new e,c=t.get("labels"),u=new i,m=new s({msg:""}),g=new s([]),b=new d({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return u.setTransport(t.get("transport")),o.plugins.addAll({labels:new n(c),model:new n(u,{setTitle:function(e){this.innerHTML=e,user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,i;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new l([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){this.innerHTML=e?e:" "}}),participant:new n(g,{setAvatar:function(e){var t,i;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new l([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){this.innerHTML=e?e:" "}}),info:new n(m),previewevent:new a(o)}),o.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:touchstart, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button" data-labels="bind:innerHTML, joinbutton" data-previewevent="listen: touchstart, press; listen:touchend, join"></div><div class="infopreview invisible" data-info="bind:innerHTML, msg"></div></div></div>',o.reset=function(e){document.getElementById("mupreview").classList.remove("invisible"),u.sync(t.get("db"),e).then(function(){g.reset(u.get("participants"))})},o.closePreview=function(){o.dom.classList.add("invisible"),u.unsync(),u.reset(),r()},o.press=function(e,t){t.classList.add("pressed")},o.join=function(e,i){i.classList.add("invisible"),i.classList.remove("pressed"),b.spin(i.parentNode),t.get("observer").notify("join-musession",u.get("_id")),setTimeout(function(){b.stop(),o.dom.classList.add("invisible"),u.unsync(),u.reset()},15e3)},o.init=function(e){r=e},u.watchValue("participants",function(e){var t=document.getElementById("mupreview"),i=t.querySelector(".start-button"),s=t.querySelector(".infopreview");g.reset(e),e.length<3&&"waiting"===u.get("status")?(i.classList.remove("invisible"),s.classList.add("invisible")):(3===e.length&&"waiting"===u.get("status")&&m.set("msg",c.get("sessionfull")),i.classList.add("invisible"),s.classList.remove("invisible"))}),u.watchValue("status",function(e){var t=document.getElementById("mupreview"),i=t.querySelector(".start-button"),s=t.querySelector(".infopreview");"waiting"===e&&u.get("participants").length<3?(i.classList.remove("invisible"),s.classList.add("invisible")):(3===u.get("participants").length&&"waiting"===e&&m.set("msg",c.get("sessionfull")),"in progress"===e&&(m.set("msg",c.get("sessionstarted")),u.unsync()),"deleted"===e&&(m.set("msg",c.get("sessiondeleted")),u.unsync()),i.classList.add("invisible"),s.classList.remove("invisible"))}),SPIP=b,o}});