/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBBulkDocuments","CouchDBDocument","Store","service/cardpopup","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l,c,h){var p=new e,d=new o([]),v=new o([]),m=new o({currentPage:0,nbPages:0}),g,y=t.get("labels"),b=t.get("user"),w=null,E=null;return p.plugins.addAll({pagination:new n(m,{setPage:function(e){var t=e+1;m.get("nbPages")>1?this.innerHTML=y.get("page")+t+" / "+m.get("nbPages"):this.innerHTML=""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<m.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(v,{formatTitle:function(e){e?(this.classList.remove("newcard"),l!=="techno"?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;"))):this.classList.add("newcard")},setPic:function(e){var n,r;if(e&&e.search("img/decks/")>-1)this.setAttribute("style","background-image:url('"+e+"');");else if(e)n="cards",r={dir:n,filename:e},t.get("transport").request("GetFile",r,function(e){node.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});else switch(l){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}),cardlistevent:new r(p)}),p.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:mousedown, setStart; listen:dblclick, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn" data-cardlistevent="listen: mousedown, press; listen:mouseup, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: mousedown, press; listen:mouseup, deleteCard"></div></div></li></ul></div></div>',p.reset=function(t){E=null,w=t._id,p.getCardList(t.content[l])},p.getCardList=function(n){var r=new i,s=n;n[0]==="newcard"&&(s=n.slice(1,n.length)),s.length?(r.setTransport(t.get("transport")),r.sync(t.get("db"),{keys:s}).then(function(){n[0]==="newcard"?d.reset([{_id:"newcard",title:"",picture_file:""}]):d.reset([]),r.loop(function(e,t){d.alter("push",e.doc)}),m.set("nbPages",Math.ceil(d.getNbItems()/12)),p.displayPage(0),r.unsync()})):(d.reset([{_id:"newcard",title:"",picture_file:""}]),m.set("nbPages",1),p.displayPage(0))},p.displayPage=function(t){var n,r=d.getNbItems()-12*t;m.set("currentPage",t),v.reset([]);for(n=0;n<r;n++)v.alter("push",d.get(t*12+n))},p.removeCard=function(n){var r=new s,i=new s;r.setTransport(t.get("transport")),i.setTransport(t.get("transport")),r.sync(t.get("db"),w).then(function(){var e=r.get("content"),t=e[l];return t.splice(t.indexOf(n),1),e[l]=t,r.set("content",e),r.upload()}).then(function(){return h("updated",w,l),r.unsync(),i.sync(t.get("db"),n)}).then(function(){var e=i.get("deck"),n=new a,r,s=i.get("picture_file");return e.splice(w,1),e.length?(i.set("deck",e),i.upload().then(function(){n.fulfill()})):(s.search("img/decks")===-1&&(r={type:"card",file:s},t.get("transport").request("DeleteAttachment",r,function(e){e!=="ok"&&console.log(e)})),i.remove().then(function(){n.fulfill()})),n}).then(function(){console.log("card removal operation completed")})},p.push=function(e,t){t.classList.add("invisible"),e.stopPropagation()},p.press=function(e,t){t.classList.add("pressed")},p.previousPage=function(e,t){p.displayPrevious()},p.nextPage=function(e,t){p.displayNext()},p.displayPrevious=function(){var t=m.get("currentPage");t>0&&p.displayPage(t-1)},p.displayNext=function(){var t=m.get("currentPage");t<m.get("nbPages")-1&&p.displayPage(t+1)},p.changePage=function(e,t){var n=[e.pageX,e.pageY];n[0]>(document.width+301)/2?p.displayNext():p.displayPrevious()},p.highlight=function(e,t){E!==null&&document.querySelector("li[data-cards_id='"+E+"']").classList.remove("highlighted"),E=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},p.zoom=function(e,t){var n=parseInt(t.getAttribute("data-cards_id"),10)+12*m.get("currentPage");d.get(n)._id==="newcard"?c("newcard",l):(p.setPopup(n),d.get(n).created_by===b.get("_id")&&t.querySelector(".cardbtnbar").classList.remove("invisible"))},p.editCard=function(t,n){var r=parseInt(n.getAttribute("data-cards_id"),10)+12*m.get("currentPage");t.stopPropagation(),g.close(),n.parentNode.classList.add("invisible"),c(d.get(r)._id,l)},p.deleteCard=function(t,n){var r=parseInt(n.getAttribute("data-cards_id"),10)+12*m.get("currentPage");t.stopPropagation(),g.close(),n.parentNode.classList.add("invisible"),p.removeCard(d.get(r)._id)},p.setPopup=function(t){var n={x:0,y:0},r="";t%=12;switch(t){case 1:n.x=304,n.y=157,r="left";break;case 2:n.x=23,n.y=157,r="right";break;case 3:n.x=170,n.y=157,r="right";break;case 4:n.x=157,n.y=339,r="left";break;case 5:n.x=304,n.y=339,r="left";break;case 6:n.x=23,n.y=339,r="right";break;case 7:n.x=170,n.y=339,r="right";break;case 8:n.x=157,n.y=350,r="left";break;case 9:n.x=304,n.y=350,r="left";break;case 10:n.x=23,n.y=350,r="right";break;case 11:n.x=170,n.y=350,r="right";break;default:n.x=157,n.y=157,r="left"}g.reset(d.get(t),n,r,document.getElementById("cardlist-popup"))},p.closePopup=function(){p.dom.querySelector("li[data-cards_id='"+E+"']").classList.remove("highlighted"),p.dom.querySelector("li[data-cards_id='"+E+"']").querySelector(".cardbtnbar").classList.add("invisible"),E=null},g=new u(p.closePopup),p}});