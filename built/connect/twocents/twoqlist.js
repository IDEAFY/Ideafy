/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,s,i,n,a,c,r,o,l){function d(e,d,u,p,g){var v,h,m=new s([]),b=new t([]),f="",w=null,y={db:d,view:p,design:u,query:{descending:!0}},L=i.get("labels"),k=this;m.setTransport(i.get("transport")),f="contact"===e?"contacttwoqlist":"",this.template='<div><ul class="twoq-list '+f+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:touchstart, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+f+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:touchstart, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new n(m,{date:function S(S){this.innerHTML=S?c.formatDate(S):""},showReplies:function(e){var t;e&&(t=e.length),0===t?this.innerHTML=L.get("noreplyyet"):1===t?this.innerHTML=t+" "+L.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+L.get("showtcrepliesafter"))},setAvatar:function(e){var t,s;e&&(s=document.createDocumentFragment(),t=new r([e]),t.place(s),this.hasChildNodes()?this.replaceChild(s,this.firstChild):this.appendChild(s))},setVisibility:function(e){e&&"public"===e?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new n(b,{date:function T(T){this.innerHTML=T?c.formatDate(T):""},showReplies:function(e){var t;e&&(t=e.length),0===t?this.innerHTML=L.get("noreplyyet"):1===t?this.innerHTML=t+" "+L.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+L.get("showtcrepliesafter"))},setAvatar:function(e){var t,s;e&&(s=document.createDocumentFragment(),t=new r([e]),t.place(s),this.hasChildNodes()?this.replaceChild(s,this.firstChild):this.appendChild(s))},setVisibility:function(e){e&&"public"===e?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new a(this)}),this.getModel=function(){var e,t;return t=!k.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),e=t?b:m},this.resetQuery=function(e){var t=new l;return y.query=e,m.unsync(),m.reset([]),k.hideSearch(),m.sync(y.db,y.design,y.view,y.query).then(function(){w&&w.hide(),t.fulfill()}),t},this.setStart=function(e){v=[e.pageX,e.pageY],w&&(w.hide(),w=null)},this.showActionBar=function(e,t){var s,i=t.getAttribute("data-twoqlist_id"),n=(document.getElementById("mtc-list"),!1);h=[e.pageX,e.pageY],w&&w.getParent()===t&&(n=!0),!n&&v[0]-h[0]>40&&h[1]-v[1]<20&&h[1]-v[1]>-20&&(w=new o("2Q",t,m.get(i)._id),s=document.createDocumentFragment(),w.place(s),t.appendChild(s))},this.showSearch=function(){var e=document.querySelector(".twoq-searchlist"),t=document.querySelector(".twoq-list");e&&e.classList.contains("invisible")&&(t.classList.add("invisible"),e.classList.remove("invisible"))},this.hideSearch=function(){var e=this.dom.querySelector(".twoq-searchlist"),t=this.dom.querySelector(".twoq-list");e&&!e.classList.contains("invisible")&&(t.classList.remove("invisible"),e.classList.add("invisible"))},this.search=function(e){b.reset([]),e.toLowerCase()?(this.showSearch(),m.loop(function(t){JSON.stringify(t).search(e)>-1&&b.alter("push",t)})):this.hideSearch()},g&&(y.query=g),this.init=function(){var e=new l;return m.sync(y.db,y.design,y.view,y.query).then(function(){e.fulfill()}),e}}return function(t,s,i,n,a){return d.prototype=new e,new d(t,s,i,n,a)}});