/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","service/config","Olives/Model-plugin","Olives/Event-plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBStore"],function(e,t,n,r,s,o,u,a,f,l){return function(a){var f=new e,c=new o({errormsg:""}),h=n.get("user"),p=n.get("transport"),d=n.get("labels"),v=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:h.get("signature")}),m=new o([]),g=new o([]),y=!1;return f.plugins.addAll({labels:new r(d),share:new r(v,{setHeader:function(e){this.innerHTML=d.get("sharing")+e}}),contacts:new r(g,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(m,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(f),errormsg:new r(c)}),f.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',f.reset=function(t){c.reset({errormsg:""}),v.reset({body:"",docId:t._id,docType:t.type,docTitle:t.title,signature:h.get("username")+" <"+h.get("_id")+">"}),h.get("signature")&&v.set("signature",h.get("signature")),g.reset([])},f.updateAutoContact=function(e,t){var n=JSON.parse(m.toJSON()),r=h.get("connections"),s,o=t.value.toLowerCase();if(t.value==="")m.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);m.reset(n)}m.loop(function(e,t){g.toJSON().search(e.contact.userid)>-1&&m.update(t,"selected",!0)})},f.close=function(t,n){n.parentNode.classList.add("invisible")},f.displayAutoContact=function(e,t){document.getElementById("sharelistauto").classList.remove("invisible"),m.reset(h.get("connections"))},f.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=g.get(n).userid;g.alter("splice",n,1),m.loop(function(e,t){e.userid===r&&setTimeout(function(){m.update(t,"selected",!1)},200)}),f.unselectGroup(r)},f.select=function(e,t){var n=t.getAttribute("data-auto_id");m.get(n).selected?(f.removeContact(m.get(n)),setTimeout(function(){m.update(n,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(f.addContact(m.get(n)),f.selectGroup(),setTimeout(function(){m.update(n,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},f.selectAll=function(e,t){t.classList.remove("pressed"),g.reset([]),m.reset(h.get("connections")),m.loop(function(e,t){m.update(t,"selected",!0),e.type==="user"&&g.alter("push",e)})},f.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)f.removeContact(e.contacts[j]);else g.loop(function(t,n){t.userid===e.userid&&g.alter("splice",n,1)}),f.unselectGroup(e.userid),m.loop(function(t,n){t.userid===e.userid&&m.update(n,"selected",!1)})},f.selectGroup=function(){var e,t=!1;m.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.lenght-1;j>=0;j--)if(g.toJSON().search(e[j].userid)<0){t=!1;break}t&&m.update(r,"selected",!0)}})},f.unselectGroup=function(e){m.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&m.update(n,"selected",!1)})},f.addContact=function(e){var t,n,r=!0;if(e.type==="user")g.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)g.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(g.alter("push",e.contacts[t]),m.loop(function(n,r){n.userid===e.contacts[t].userid&&m.update(r,"selected",!0)}))},f.press=function(e,t){t.classList.add("pressed")},f.share=function(e,t){var n=new Date,r={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:h.get("_id"),username:h.get("username"),firstname:h.get("firstname"),toList:"",ccList:"",object:"",body:v.get("body"),signature:v.get("signature"),docId:v.get("docId"),docType:v.get("docType"),docTitle:v.get("docTitle"),dest:[]};y||(y=!0,g.loop(function(e,t){r.dest.push(e.userid)}),p.request("Notify",r,function(e){console.log(e),c.set("errormsg",d.get("shareok")),t.classList.remove("pressed"),f.updateSharedWith(r.docId,r.dest),setTimeout(function(){c.set("errormsg",""),y=!1,a("close")},1e3)}))},f.cancel=function(e,t){t.classList.remove("pressed"),a("close")},f.updateSharedWith=function(t,r){var i=new l;i.setTransport(p),i.sync(n.get("db"),t).then(function(){var e=i.get("sharedwith")||[],t,n=!0;e===[]?i.set("sharedwith",r):(r.forEach(function(r){n=!0;for(t=e.length-1;t>=0;t--)e[t]===r&&(n=!1);n&&e.push(r)}),i.set("sharedwith",e)),i.upload()})},f.place(t.get("library-share")),f}});