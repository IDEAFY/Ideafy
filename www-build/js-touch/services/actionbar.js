/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){function c(e,c,h,p){var d=new i([]),v=c.offsetHeight,m=new i({height:v}),g=10,y=r.get("user"),b=r.get("labels"),w=r.get("observer"),E=r.get("transport"),S=r.get("db"),x,T=this,N=(new f({color:"#9AC9CD",lines:10,length:10,width:8,radius:10})).spin();this.plugins.addAll({buttons:new t(d,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(m,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-g)+"px;")},setButtons:function(e){var t=Math.floor((e-g-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new n(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:touchend, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:touchstart, press; listen:touchend, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(e,t){p(this)},this.press=function(e,t){e.stopPropagation(),t.classList.add("pressed"),N.el=document.getElementById("abspinner")},this.action=function(e,t){var n=t.getAttribute("data-buttons_id"),i=d.get(n).name;e.stopPropagation(),t.classList.remove("pressed");switch(i){case"delete":this.deleteItem().then(function(){p(T)});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":r.get("observer").notify("replay-session",h.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();default:}},x=function(e,t){var n;switch(e){case"idea":n=new s,n.setTransport(E),n.sync(S,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){t=n.get(0).doc,h=n.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&d.alter("push",{name:"edit",icon:"img/wall/35modify.png"});if(t.sessionId&&t.sessionId!==""&&t.sessionId.search("deleted")===-1)if(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1){var e=new s;e.setTransport(r.get("transport")),e.sync(r.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){e.get(0)&&d.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),t.authors.length===1&&t.authors[0]===y.get("_id")&&!t.twocents.length&&!t.sharedwith.length&&t.visibility!=="public"&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),t.authors.indexOf(y.get("_id"))===-1&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.type==="user"&&d.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:}},this.deleteItem=function(){var n=new u,i=new o;i.setTransport(E);switch(e){case"idea":h.authors.length===1&&h.authors[0]===y.get("_id")?i.sync(r.get("db"),h._id).then(function(){return i.remove()}).then(function(){n.fulfill()}):E.request("RemoveFromLibrary",{id:h._id,userid:y.get("_id")},function(e){n.fulfill()});break;case"message":var s=y.get("notifications"),a,f;for(a=0,l=s.length;a<l;a++)if(JSON.stringify(s[a])===JSON.stringify(h)){f=a;break}s.splice(f,1),y.set("notifications",s),y.upload();break;case"contact":var s=y.get("connections"),c=new Date,p=[c.getFullYear(),c.getMonth(),c.getDate(),c.getHours(),c.getMinutes(),c.getSeconds()];if(h.type==="user"){for(a=s.length-1;a>=0;a--)if(s[a].type==="user"&&s[a].userid===h.userid)s.splice(a,1);else if(s[a].type==="group"){var d=s[a].contacts;for(j=d.length-1;j>=0;j--)d[j].userid===h.userid&&d.splice(j,1)}}else for(a=s.length-1;a>=0;a--)s[a].username===h.username&&s.splice(a,1);y.set("connections",s),h.type==="user"&&y.get("news").unshift({type:"CX-",date:p,content:{userid:h.userid,username:h.username}}),y.upload().then(function(){if(h.type==="user"){var e=new Date,t={dest:[h.userid],date:p,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:h.username,ccList:"",object:y.get("username")+b.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};E.request("Notify",t,function(e){console.log(e)})}w.notify("contact-deleted")});break;default:}return n},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-edit",h._id):w.notify("library-edit",h._id);break;default:}N.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-sendmail",h):w.notify("library-sendmail",h);break;case"message":break;case"contact":w.notify("message-contact",h);break;default:}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-share",h):w.notify("library-share",h);break;case"message":break;case"contact":break;default:}},this.sendTwocent=function(){a.reset(h)},x(e,h)}return function(n,r,i,s){return c.prototype=new e,new c(n,r,i,s)}});