/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","service/config","Olives/Model-plugin","Olives/Event-plugin","Store","Promise","service/utils"],function(e,t,n,r,s,o,u,a){return function(f,c){var h=new e,p=null,d=[],v=new o({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m=new o([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),g=new o([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),y=n.get("labels"),b=new o({status:null}),w=new o({type:"drawing",content:"",background:""}),E=function(e){var t=new u,r="/upload",i=new FormData,s="postit",o=document.getElementById("drawarea"),f=o.toDataURL("image/png"),l=new Date,c=e||n.get("user").get("_id")+"_"+l.getTime();return i.append("type",s),i.append("sid",S),i.append("filename",c),i.append("dataString",f),a.uploadFile(r,i,b,function(e){w.set("content",c),w.set("background",v.get("bg")),t.resolve()}),t},S;return h.plugins.addAll({labels:new r(y),color:new r(m,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),pencil:new r(v,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){e==="pencil"?this.setAttribute("fill",v.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){v.get("mode")==="pencil"?this.setAttribute("fill",e):this.setAttribute("fill",v.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new r(g,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),uploadprogress:new r(b,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),drawing:new r(w,{draw:function(e){var t=n.get("transport"),r=this,i;e&&(i={sid:S,filename:e},t.request("GetFile",i,function(e){var t=new Image,n=r.getContext("2d");t.src=e,n.drawImage(t,0,0)}))}}),drawingevent:new s(h)}),h.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="54"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="36" r="18" stroke-width="1" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="36" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:touchmove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas id="drawarea" class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:touchmove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',h.setSessionId=function(e){S=e},h.clear=function(e,t){var n=document.getElementById("drawarea"),r=n.getContext("2d");r.clearRect(0,0,n.width,n.height),t.classList.remove("selected")},h.resetColors=function(){v.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),g.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},h.erase=function(e,t){v.set("mode","erase"),v.set("color",v.get("bg"))},h.drawactive=function(e,t){v.set("mode","pencil"),m.loop(function(e,t){e.active&&v.set("color",e.color)})},h.expand=function(e,t){var n=t.getAttribute("name"),r=document.getElementById(n);r.classList.contains("invisible")?r.classList.remove("invisible"):r.classList.add("invisible")},h.stop=function(e,t){e.stopPropagation()},h.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},h.select=function(e,t){t.classList.add("selected")},h.getColor=function(e,t){var n=t.getAttribute("data-color_id");e.stopPropagation(),m.loop(function(e,t){t===parseInt(n)?m.update(t,"active",!0):m.update(t,"active",!1)}),v.set("color",m.get(n).color),v.set("mode","pencil"),t.parentNode.classList.add("invisible")},h.getBgColor=function(e,t){var n=t.getAttribute("data-bgcolor_id");e.stopPropagation(),g.loop(function(e,t){t===parseInt(n)?g.update(t,"active",!0):g.update(t,"active",!1)}),v.set("bg",g.get(n).color),t.parentNode.classList.add("invisible")},h.cancel=function(e,t){h.clear(e,t),h.resetColors(),w.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),c("drawing")},h.deletedrawing=function(e,t){(p||p===0)&&f.del(p),h.cancel(e,t)},h.post=function(e,t){t.classList.add("selected"),E(w.get("content")).then(function(){!p&&p!==0?f.alter("push",JSON.parse(w.toJSON())):(f.update(p,"content",w.get("content")),f.update(p,"background",w.get("background"))),t.classList.remove("selected"),h.cancel(e,t),b.reset({status:""})})},h.reset=function(t){p=t,h.resetColors(),d=[],!p&&p!==0?w.reset({type:"drawing",content:"",background:""}):(w.reset(f.get(t)),v.set("bg",w.get("background")),g.loop(function(e,t){e.color===w.get("background")?g.update(t,"active",!0):g.update(t,"active",!1)}))},h.start=function(e,t){var n=e.touches;for(i=0,l=n.length;i<l;i++){var r=n[i];d[r.identifier]={x:r.pageX-t.offsetLeft,y:r.pageY-t.offsetTop}}e.preventDefault()},h.end=function(e,t){},h.move=function(e,t){var n=e.touches;for(i=0,l=n.length;i<l;i++){var r=n[i],s=r.identifier,o=r.pageX-t.offsetLeft-d[s].x,u=r.pageY-t.offsetTop-d[s].y,a=h.draw(t,s,o,u);d[s]={x:a.x,y:a.y}}e.preventDefault()},h.draw=function(e,t,n,r){var i=e.getContext("2d");return i.lineWidth=v.get("size"),i.strokeStyle=v.get("color"),i.lineCap=v.get("cap"),i.beginPath(),i.moveTo(d[t].x,d[t].y),i.lineTo(d[t].x+n,d[t].y+r),i.stroke(),i.closePath(),{x:d[t].x+n,y:d[t].y+r}},h}});