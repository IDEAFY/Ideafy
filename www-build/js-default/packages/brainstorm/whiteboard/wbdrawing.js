/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,n,r,i,s,o,u){return function(a,f){var l=new e,c=null,h={},p=new s({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),d=new s([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v=new s([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),m=n.get("labels"),g=new s({status:null}),y=new s({type:"drawing",content:"",background:""}),b=function(e){var t=new o,r="/upload",i=new FormData,s="postit",a="sessions/"+w,f=l.dom.querySelector(".drawingcanvas"),c=f.toDataURL("image/png"),h=new Date,d=e||n.get("user").get("_id")+"_"+h.getTime();return i.append("type",s),i.append("dir",a),i.append("filename",d),i.append("dataString",c),u.uploadFile(r,i,g,function(e){y.set("content",d),y.set("background",p.get("bg")),t.fulfill()}),t},w,E=!1,S=(document.body.clientWidth-1024)/2,x=(document.body.clientHeight-748)/2;return l.plugins.addAll({labels:new r(m),color:new r(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),pencil:new r(p,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){e==="pencil"?this.setAttribute("fill",p.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){p.get("mode")==="pencil"?this.setAttribute("fill",e):this.setAttribute("fill",p.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new r(v,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),uploadprogress:new r(g,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),drawing:new r(y,{draw:function(e){var t=n.get("transport"),r=this,i;e&&(i={dir:w,filename:e},t.request("GetFile",i,function(e){var t=new Image,n=r.getContext("2d");t.src=e,n.drawImage(t,0,0)}))}}),drawingevent:new i(l)}),l.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',l.setSessionId=function(e){w=e},l.clear=function(e,t){var n=l.dom.querySelector(".drawingcanvas"),r=n.getContext("2d");r.clearRect(0,0,n.width,n.height),t.classList.remove("selected")},l.resetColors=function(){p.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),d.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},l.erase=function(e,t){p.set("mode","erase"),p.set("color",p.get("bg"))},l.drawactive=function(e,t){p.set("mode","pencil"),d.loop(function(e,t){e.active&&p.set("color",e.color)})},l.expand=function(e,t){var n=t.getAttribute("name"),r=document.getElementById(n);r.classList.contains("invisible")?r.classList.remove("invisible"):r.classList.add("invisible")},l.stop=function(e,t){e.stopPropagation()},l.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},l.select=function(e,t){t.classList.add("selected")},l.getColor=function(e,t){var n=t.getAttribute("data-color_id");e.stopPropagation(),d.loop(function(e,t){t===parseInt(n)?d.update(t,"active",!0):d.update(t,"active",!1)}),p.set("color",d.get(n).color),p.set("mode","pencil"),t.parentNode.classList.add("invisible")},l.getBgColor=function(e,t){var n=t.getAttribute("data-bgcolor_id");e.stopPropagation(),v.loop(function(e,t){t===parseInt(n)?v.update(t,"active",!0):v.update(t,"active",!1)}),p.set("bg",v.get(n).color),t.parentNode.classList.add("invisible")},l.cancel=function(e,t){l.clear(e,t),l.resetColors(),y.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),f("drawing")},l.deletedrawing=function(e,t){(c||c===0)&&a.del(c),l.cancel(e,t)},l.post=function(e,t){t.classList.add("selected"),b(y.get("content")).then(function(){!c&&c!==0?a.alter("push",JSON.parse(y.toJSON())):a.alter("splice",c,1,JSON.parse(y.toJSON())),t.classList.remove("selected"),l.cancel(e,t),g.reset({status:""})})},l.reset=function(t){var n=l.dom.querySelector(".drawingcanvas");c=t,l.resetColors(),_lines=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&n.setAttribute("height",380),!c&&c!==0?y.reset({type:"drawing",content:"",background:""}):(y.reset(a.get(t)),p.set("bg",y.get("background")),v.loop(function(e,t){e.color===y.get("background")?v.update(t,"active",!0):v.update(t,"active",!1)}))},l.start=function(e,t){h={x:e.pageX-t.offsetLeft-S,y:e.pageY-t.offsetTop-x},E=!0,e.preventDefault()},l.end=function(e,t){E=!1},l.move=function(e,t){var n,r,i;E&&(n=e.pageX-t.offsetLeft-S-h.x,r=e.pageY-t.offsetTop-x-h.y,i=l.draw(t,n,r),h={x:i.x,y:i.y}),e.preventDefault()},l.draw=function(e,t,n){var r=e.getContext("2d");return r.lineWidth=p.get("size"),r.strokeStyle=p.get("color"),r.lineCap=p.get("cap"),r.beginPath(),r.moveTo(h.x,h.y),r.lineTo(h.x+t,h.y+n),r.stroke(),r.closePath(),{x:h.x+t,y:h.y+n}},l}});