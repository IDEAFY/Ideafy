/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,s,n,a,r){return function(){var c=new e,o=new a({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),d=new a([{color:"#4D4D4D",icon:"graygroup.png",selected:!0},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}]),u=new a([]),p=new a([]),g=new a({error:""}),v=t.get("user"),h=t.get("labels");return c.plugins.addAll({label:new s(h),error:new s(g),color:new s(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),group:new s(o,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),contacts:new s(u,{setAvatar:function(e){_frag=document.createDocumentFragment(),_ui=new r([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),auto:new s(p,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),addgrpevent:new n(c)}),c.template='<div id="addgroup"><div class="header blue-dark"><span class="newfolderlbl" data-label="bind:innerHTML, newfolderlbl"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-addgrpevent="listen: touchstart, selectColor"></li></ul></form><div class = "groupcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-addgrpevent="listen: touchstart, toggleHide"></legend><ul class="contactlistdetail" data-contacts="foreach"><li class = "contact list-item" data-addgrpevent="listen:touchstart, discardContact"><div data-contacts="bind:setAvatar, userid"></div><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><div class="addgroupbtns"><span class="errormsg" data-error="bind:innerHTML, error"></span><div class="addct" data-addgrpevent="listen:touchstart, press; listen:touchend, add"></div><div class="cancelct" data-addgrpevent="listen:touchstart, press; listen:touchend, cancel"></div></div><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-addgrpevent="listen: touchstart, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-addgrpevent="listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-addgrpevent="listen:touchend, select"></li></ul></div></div></div></div>',c.init=function(){v.get("connections").forEach(function(e){"user"===e.type&&p.alter("push",{contact:e,selected:!1})})},c.selectColor=function(e,t){var i=t.getAttribute("data-color_id");d.loop(function(e,t){d.update(t,"selected",!1)}),d.update(i,"selected",!0),o.set("color",d.get(i).icon)},c.toggleHide=function(e,t){var i=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),"add"===i?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),"add"===i?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},c.select=function(e,t){var i=t.getAttribute("data-auto_id");p.get(i).selected?(c.removeContact(i),setTimeout(function(){p.update(i,"selected",!1)},200)):(c.addContact(i),setTimeout(function(){p.update(i,"selected",!0)},200))},c.addContact=function(e){var t=JSON.parse(u.toJSON()),s=p.get(e).contact,n=0;if(u.toJSON().search(s.userid)<0){for(i=0,l=t.length;l>i;i++)s.lastname>t[i].lastname?n++:s.lastname===t[i].lastname&&s.username>t[i].username&&n++;t.splice(n,0,s),u.reset(t),o.set("contacts",t)}},c.removeContact=function(e){var t=JSON.parse(u.toJSON());for(i=t.length-1;i>=0;i--)t[i].userid===p.get(e).contact.userid&&t.splice(i,1);u.reset(t)},c.updateAutoContact=function(e,t){var s,n=JSON.parse(p.toJSON()),a=v.get("connections"),r=t.value.toLowerCase();if(""===t.value)for(n=[],i=0,l=a.length;l>i;i++)"user"===a[i].type&&n.push({contact:a[i],selected:!1});else if(8===e.keyCode||46===e.keyCode){for(n=[],i=0,l=a.length;l>i;i++)"user"===a[i].type&&n.push({contact:a[i],selected:!1});for(i=n.length-1;i>=0;i--)0!==n[i].contact.username.toLowerCase().search(r)&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)s=n[i].contact.username.toLowerCase(),0!==s.search(r)&&n.splice(i,1);p.reset(n),p.loop(function(e,t){u.toJSON().search(e.contact.userid)>-1&&p.update(t,"selected",!0)})},c.discardContact=function(e,t){var i=t.getAttribute("data-contacts_id"),s=u.get(i).userid;u.alter("splice",i,1),p.loop(function(e,t){e.contact.userid===s&&setTimeout(function(){p.update(t,"selected",!1)},200)})},c.reset=function(){o.reset({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),u.reset([]),p.reset([]),g.reset({error:""}),v.get("connections").forEach(function(e){"user"===e.type&&p.alter("push",{contact:e,selected:!1})})},c.press=function(e,t){t.classList.add("pushed")},c.cancel=function(e,t){t.classList.remove("pushed"),c.reset(),document.querySelector("#addgroup input.search").value=""},c.add=function(e,t){var s=v.get("connections"),n=0,a=JSON.parse(o.toJSON());if(t.classList.remove("pushed"),g.set("error",""),""===a.username)g.set("error",h.get("nogrpname"));else if(""===a.intro)g.set("error",h.get("nogrpintro"));else if(a.contacts.length){for(i=0,l=s.length;l>i;i++)"user"===s[i].type?a.username>s[i].lastname&&n++:(a.username===s[i].username&&g.set("error",h.get("grpnameexists")),a.username>s[i].username&&n++);g.get("error")||(s.splice(n,0,a),v.set("connections",s),v.upload().then(function(){c.reset()}))}else g.set("error",h.get("nocontactselected"))},c}});