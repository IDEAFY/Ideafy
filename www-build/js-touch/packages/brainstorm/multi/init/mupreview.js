/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(){var f=new e,l=t.get("labels"),c=new n,h=new r({msg:""}),p=new r([]),d=(new a({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin(),v;return c.setTransport(t.get("transport")),f.plugins.addAll({labels:new i(l),model:new i(c,{setTitle:function(e){this.innerHTML=e,user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(t){var n,r;this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new o([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),participant:new i(p,{setAvatar:function(t){var n,r;this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new o([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(h),previewevent:new s(f)}),f.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:touchstart, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button" data-labels="bind:innerHTML, joinbutton" data-previewevent="listen: touchstart, press; listen:touchend, join"></div><div class="infopreview invisible" data-info="bind:innerHTML, msg"></div></div></div>',f.reset=function(n){document.getElementById("mupreview").classList.remove("invisible"),c.sync(t.get("db"),n).then(function(){p.reset(c.get("participants"))})},f.closePreview=function(t,n){f.dom.classList.add("invisible"),c.unsync(),c.reset(),v()},f.press=function(t,n){n.classList.add("pressed")},f.join=function(n,r){r.classList.add("invisible"),r.classList.remove("pressed"),d.spin(r.parentNode),t.get("observer").notify("join-musession",c.get("_id")),setTimeout(function(){d.stop(),f.dom.classList.add("invisible"),c.unsync(),c.reset()},15e3)},f.init=function(t){v=t},c.watchValue("participants",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");p.reset(e),e.length<3&&c.get("status")==="waiting"?(n.classList.remove("invisible"),r.classList.add("invisible")):(e.length===3&&c.get("status")==="waiting"&&h.set("msg",l.get("sessionfull")),n.classList.add("invisible"),r.classList.remove("invisible"))}),c.watchValue("status",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");e==="waiting"&&c.get("participants").length<3?(n.classList.remove("invisible"),r.classList.add("invisible")):(c.get("participants").length===3&&e==="waiting"&&h.set("msg",l.get("sessionfull")),e==="in progress"&&(h.set("msg",l.get("sessionstarted")),c.unsync()),e==="deleted"&&(h.set("msg",l.get("sessiondeleted")),c.unsync()),n.classList.add("invisible"),r.classList.remove("invisible"))}),SPIP=d,f}});