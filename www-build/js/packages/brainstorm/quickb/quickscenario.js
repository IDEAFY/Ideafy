/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","Store","CouchDBStore","service/cardpopup","../whiteboard/whiteboard","Promise","service/utils"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v,m){var g=new e,y,b,w=i.get("labels"),E=new s,S=new s,x=new s,T=new s({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),N=new s({cardpopup:{"char":!1,context:!1,problem:!1}},{postit:"inactive"},{"import":"inactive"},{drawing:"inactive"},{ready:!1},{showstory:!1},{shownext:!1},{readonly:!1}),C=new s({timer:null,display:!1}),k,L=new s({title:"",story:"",solution:""}),A=new s([]),O=new a("scenario",A,N),M,_=0,D="step",P=i.get("transport");return g.plugins.addAll({labels:new n(w,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(T,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(N,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new n(C,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(L),wbstack:O,quickscenarioevent:new r(g)}),g.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:mousedown,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend>Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend>Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend>Drawing tool</legend></div></div><div id="finish-button" class="invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="40" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea><div class = "finish-button finish-writeup"></div></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',g.place(t.get("quickscenario")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){t.classList.remove("pressed"),D==="step"?(D="screen",clearInterval(k),C.set("display",!0),p.set("scenario",JSON.parse(L.toJSON())),g.updateSessionScore(C.get("timer")).then(function(){h.unsync(),h.sync(i.get("db"),h.get("_id")).then(function(){var e=h.get("elapsedTimers");e.quickscenario=C.get("timer"),h.set("scenario",[JSON.parse(L.toJSON())]),h.set("elapsedTimers",e),N.set("readonly",!0),v("quickscenario")})})):v("quickscenario")},g.prev=function(e,t){t.classList.remove("pressed"),d("quickscenario")},g.toggleProgress=function(e,t){m(t)},g.toggleTimer=function(e,t){C.set("display",!C.get("display"))},g.push=function(e,t){var n=t.getAttribute("name");N.set(n,"active")},g.zoom=function(e,t){var n=t.getAttribute("name");g.setPopup(n)},g.setPopup=function(t){var n={x:240,y:130},r="left",s=T.get(t),u=N.get("cardpopup"),a="",f;b&&(u[b]=!1),u[t]=!0,N.set("cardpopup",u),b=t,t==="char"&&(n.y=120,s.id===E.get("_id")&&(a=E.toJSON())),t==="context"&&(n.y=290,s.id===S.get("_id")&&(a=S.toJSON())),t==="problem"&&(n.y=350,s.id===x.get("_id")&&(a=x.toJSON())),a?y.reset(a,n,r,document.getElementById("quickscenario-popup")):(f=new o,f.setTransport(P),f.sync(i.get("db"),s.id).then(function(){a=f.toJSON(),y.reset(a,n,r,document.getElementById("quickscenario-popup")),t==="char"&&E.reset(JSON.parse(f.toJSON())),t==="context"&&S.reset(JSON.parse(f.toJSON())),t==="problem"&&x.reset(JSON.parse(f.toJSON()))}))},g.closePopup=function(){var t=N.get("cardpopup");t[b]=!1,N.set("cardpopup",t),b=""},y=new u(g.closePopup),g.post=function(e,t){O.selectScreen("postit"),N.set("import","inactive"),N.set("drawing","inactive")},g.importpic=function(e,t){O.selectScreen("import"),N.set("postit","inactive"),N.set("drawing","inactive")},g.draw=function(e,t){O.selectScreen("drawing"),N.set("import","inactive"),N.set("postit","inactive")},g.exitTool=function(t){N.set(t,"inactive")},g.finish=function(e,t){O.setReadonly(!0),N.set("ready",!1),N.set("showstory",!0)},g.updateSessionScore=function(e){var t=new f,n={sid:h.get("_id"),step:"quickscenario",time:e,wbcontent:A.toJSON(),scenario:L.toJSON()};return P.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.resolve():t.reject()}),t},g.reset=function(t){N.reset({cardpopup:{"char":!1,context:!1,problem:!1}},{postit:"inactive"},{"import":"inactive"},{drawing:"inactive"},{ready:!1},{showstory:!1},{shownext:!1},{readonly:!1}),O.setSessionId(h.get("_id")),A.reset(h.get("scenarioWB")),A.getNbItems()?O.selectScreen("main"):O.selectScreen("default"),h.get("scenario").length?(D="screen",N.set("ready",!1),N.set("showstory",!0),O.setReadonly(!0),L.reset(h.get("scenario")[0]),p.set("scenario",h.get("scenario")[0]),N.set("readonly",!0),N.set("shownext",!0)):(L.reset({title:"",story:"",solution:""}),A.getNbItems()?N.set("ready",!0):N.set("ready",!1),O.setReadonly(!1),D="step"),h.get("elapsedTimers").quickscenario?_=h.get("elapsedTimers").quickscenario:_=0,C.set("timer",_),D==="screen"?C.set("display",!0):g.initTimer(_)},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;C.set("display",!1),C.set("timer",r),h.get("step")==="quickscenario"&&(k=setInterval(function(){var e=new Date;C.set("timer",r+e.getTime()-n)},1e3))},p.watchValue("characters",function(e){T.set("char",e)}),p.watchValue("contexts",function(e){T.set("context",e)}),p.watchValue("problems",function(e){T.set("problem",e)}),h.watchValue("_id",function(e){O.setSessionId(e)}),["added","deleted","updated"].forEach(function(e){A.watch(e,function(){JSON.stringify(h.get("scenarioWB"))!==A.toJSON()&&(h.set("scenarioWB",JSON.parse(A.toJSON())),h.upload()),A.getNbItems()&&D==="step"?N.set("ready",!0):N.set("ready",!1)})}),L.watch("updated",function(){L.get("title")&&L.get("story")&&L.get("solution")?N.set("shownext",!0):N.set("shownext",!1)}),g}});