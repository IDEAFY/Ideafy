/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","CouchDBStore","service/config","Olives/Model-plugin","Olives/Event-plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,f,l,c,h){var p=new t([]),d=new t([]),v,m,g=!1,y="",b=null,w={db:f,view:c,design:l,query:{descending:!0}},E=n.get("labels");p.setTransport(n.get("transport")),e==="contact"?y="contacttwoqlist":y="",this.template='<div><ul class="twoq-list '+y+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart; listen:mousemove, showActionBar"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+y+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart; listen:mousemove, showActionBar"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new r(p,{date:function S(S){S?this.innerHTML=s.formatDate(S):this.innerHTML=""},showReplies:function(t){var n=t.length;n===0?this.innerHTML=E.get("noreplyyet"):n===1?this.innerHTML=n+" "+E.get("showonetcreply"):this.innerHTML=n+" "+E.get("showtcrepliesafter")},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new o([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new r(d,{date:function x(x){x?this.innerHTML=s.formatDate(x):this.innerHTML=""},showReplies:function(t){var n=t.length;n===0?this.innerHTML=E.get("noreplyyet"):n===1?this.innerHTML=n+" "+E.get("showonetcreply"):this.innerHTML=n+" "+E.get("showtcrepliesafter")},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new o([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new i(this)}),this.getModel=function(){return p},this.resetQuery=function(e){var t=new a;return w.query=e,p.unsync(),p.reset([]),p.sync(w.db,w.design,w.view,w.query).then(function(){t.resolve()}),t},this.setStart=function(e,t){v=[e.pageX,e.pageY],b&&this.hideActionBar(b)},this.showActionBar=function(e,t){var n=t.getAttribute("data-twoqlist_id"),r=document.getElementById("mtc-list");m=[e.pageX,e.pageY];if(!r.classList.contains("mosaic")&&!g&&v[0]-m[0]>40&&m[1]-v[1]<20&&m[1]-v[1]>-20){var i=new u("2Q",t,p.get(n).value,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),b=i,g=!0}},this.hideActionBar=function(t){var n=t.dom.parentElement;n.removeChild(n.lastChild),g=!1,b=null},this.showSearch=function(){var t=document.querySelector(".twoq-searchlist"),n=document.querySelector(".twoq-list");t.classList.contains("invisible")&&(n.classList.add("invisible"),t.classList.remove("invisible"))},this.hideSearch=function(){var t=document.querySelector(".twoq-searchlist"),n=document.querySelector(".twoq-list");t.classList.contains("invisible")||(n.classList.remove("invisible"),t.classList.add("invisible"))},this.search=function(t){d.reset([]),t?(this.showSearch(),p.loop(function(e,n){JSON.stringify(e).search(t)>-1&&d.alter("push",e)})):this.hideSearch()},h&&(w.query=h),this.init=function(){var t=new a;return p.sync(w.db,w.design,w.view,w.query).then(function(){t.resolve()}),t}}return function(n,r,i,s,o){return f.prototype=new e,new f(n,r,i,s,o)}});