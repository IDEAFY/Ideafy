/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/config","Olives/Model-plugin","Olives/Event-plugin","CouchDBStore","Store","service/cardpopup"],function(e,t,n,r,i,s,o){return function(a){var f=new e,l=new s([]),c=new s([]),h=new s({currentPage:0,nbPages:0}),p,d,v=t.get("labels"),m=null;return f.plugins.addAll({pagination:new n(h,{setPage:function(e){var t=e+1;h.get("nbPages")>1?this.innerHTML=v.get("page")+t+" / "+h.get("nbPages"):this.innerHTML=""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<h.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(c,{formatTitle:function(e){e&&(a!=="techno"?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),cardlistevent:new r(f)}),f.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:mousedown, setStart; listen:mousemove, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, press; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, press; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div></div>',f.reset=function(t){m=null,f.getCardList(t.content[a])},f.getCardList=function(n){var r=new i;r.setTransport(t.get("transport")),r.sync(t.get("db"),{keys:n}).then(function(){l.reset([]),r.loop(function(e,t){l.alter("push",e.doc)}),h.set("nbPages",Math.ceil(l.getNbItems()/12)),f.displayPage(0),r.unsync()})},f.displayPage=function(t){var n,r=l.getNbItems()-12*t;h.set("currentPage",t),c.reset([]);for(n=0;n<r;n++)c.alter("push",l.get(t*12+n))},f.press=function(e,t){t.classList.add("invisible")},f.previousPage=function(e,t){f.displayPrevious()},f.nextPage=function(e,t){f.displayNext()},f.displayPrevious=function(){var t=h.get("currentPage");t>0&&f.displayPage(t-1)},f.displayNext=function(){var t=h.get("currentPage");t<h.get("nbPages")-1&&f.displayPage(t+1)},f.setStart=function(e,t){p=[e.pageX,e.pageY]},f.changePage=function(e,t){touchPoint=[e.pageX,e.pageY],p[0]-touchPoint[0]>40&&touchPoint[1]-p[1]<20&&touchPoint[1]-p[1]>-20?(console.log("displaynext"),f.displayNext()):p[0]-touchPoint[0]<40&&touchPoint[1]-p[1]<20&&touchPoint[1]-p[1]>-20&&(console.log("displayprev"),f.displayPrevious())},f.highlight=function(e,t){m!==null&&document.querySelector("li[data-cards_id='"+m+"']").classList.remove("highlighted"),m=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},f.zoom=function(e,t){var n=parseInt(t.getAttribute("data-cards_id"))+12*h.get("currentPage");f.setPopup(n)},f.setPopup=function(t){var n={x:0,y:0},r="";t%=12;switch(t){case 1:n.x=304,n.y=157,r="left";break;case 2:n.x=23,n.y=157,r="right";break;case 3:n.x=170,n.y=157,r="right";break;case 4:n.x=157,n.y=339,r="left";break;case 5:n.x=304,n.y=339,r="left";break;case 6:n.x=23,n.y=339,r="right";break;case 7:n.x=170,n.y=339,r="right";break;case 8:n.x=157,n.y=350,r="left";break;case 9:n.x=304,n.y=350,r="left";break;case 10:n.x=23,n.y=350,r="right";break;case 11:n.x=170,n.y=350,r="right";break;default:n.x=157,n.y=157,r="left"}d.reset(l.get(t),n,r,document.getElementById("cardlist-popup"))},f.closePopup=function(){document.querySelector("li[data-cards_id='"+m+"']").classList.remove("highlighted"),m=null},d=new o(f.closePopup),f}});