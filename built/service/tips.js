/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBView"],function(e,t,i,n,s,a,r){return function(){var o=new e,c=s.get("labels"),l=new r([]),d=s.get("user"),u=new a([]),p=new a({});return l.setTransport(s.get("transport")),o.plugins.addAll({labels:new i(c),tip:new i(p,{setTitle:function(e){this.innerHTML="TIP:0"===e?c.get("signupwelcomeobject"):c.get("dyknow")}}),tipevent:new n(o)}),o.template='<div><div class="help-doctor"></div><div class="close-tip" data-tipevent="listen:touchstart, close"></div><div class="tip-screen"><legend data-tip="bind:setTitle, id"></legend><p data-tip = "bind: innerHTML, body"></p><div class="next-button" data-labels = "bind: innerHTML, nextbutton" data-tipevent="listen: touchstart, press; listen:touchend, next"></div></div><div class="tip-footer"><input type="checkbox" data-tipevent="listen: change, doNotShow"><label data-labels="bind: innerHTML, notips"></label></div></div>',o.init=function(e){l.sync(s.get("db"),"about","_view/tip").then(function(){var i=d.get("lang");l.loop(function(e){var t=e.value;t.default_lang!==i&&t.translations[i]?u.alter("push",{id:t._id,title:t.translations[i].title,body:t.translations[i].body}):u.alter("push",{id:t._id,title:t.title,body:t.body})}),e?p.reset(u.get(0)):(u.alter("splice",0,1),o.getRandomTip()),o.place(t.get("tip-popup")),document.getElementById("tip-popup").classList.add("visible"),document.getElementById("cache").classList.add("visible")})},o.getRandomTip=function(){var e=u.getNbItems(),t=Math.floor(Math.random()*e);0===e?o.close():(p.reset(u.get(t)),u.alter("splice",t,1))},o.press=function(e,t){t.classList.add("pressed")},o.next=function(e,t){t.classList.remove("pressed"),o.getRandomTip()},o.close=function(){document.getElementById("tip-popup").classList.remove("visible"),document.getElementById("cache").classList.remove("visible")},o.doNotShow=function(e,t){var i;t.setAttribute("readonly","readonly"),t.checked===d.get("settings").showTips&&(i=d.get("settings"),i.showTips=!t.checked,d.set("settings",i),d.upload().then(function(){t.removeAttribute("readonly")}))},o}});