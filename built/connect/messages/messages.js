/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Amy/Control-plugin","Amy/Stack-plugin","Store","service/config","service/avatar","service/utils","./message-detail","./newmessage","service/actionbar","Promise"],function(e,t,s,n,a,c,r,o,d,u,p,g,m,v){return function(){var h,b,f,w=new e,y=new a(w),L=new c,k=function(e){L.getStack().show(e)},S="#defaultPage",T=new e,x=new p(k),q=new g(k),M=new r([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),C=0,A=new r([]),H=o.get("labels"),I=o.get("user"),N=o.get("observer"),D=function(e){var t,s=M.get(e).name,i=I.get("notifications"),n=i.length,a=[];switch(s){case"messages":for(t=0;n>t;t++)"MSG"===i[t].type&&a.push(i[t]);break;case"notifications":for(t=0;n>t;t++)"MSG"!==i[t].type&&a.push(i[t]);break;case"unread":for(t=0;n>t;t++)"unread"===i[t].status&&a.push(i[t]);break;default:a=i}return a},O=function(e){var t=[],s=[];if(t=I.get("notifications").concat(),""===e)s=t,M.update(0,"selected",!0),C=0;else for(i=0,l=t.length;l>i;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&s.push(t[i]);return s};return w.plugins.addAll({label:new s(H),sort:new s(M,{setLabel:function(e){this.innerHTML=H.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),msg:new s(A,{setObject:function(e){var t=this.getAttribute("data-msg_id");switch(e){case"INV":this.innerHTML=A.get(t).username+H.get("INVObject");break;case"CXR":this.innerHTML=A.get(t).username+H.get("CXRobject");break;case"CXRaccept":this.innerHTML=A.get(t).username+H.get("acceptedCXR");break;case"CXRreject":this.innerHTML=A.get(t).username+H.get("rejectedCXR");break;case"CXCancel":this.innerHTML=A.get(t).username+H.get("canceledCX");break;case"DOC":this.innerHTML=A.get(t).username+H.get("sentdocmsg");break;case"2Q+":this.innerHTML=A.get(t).username+H.get("askednew");break;case"2C+":this.innerHTML=A.get(t).username+H.get("senttc");break;case"REF":this.innerHTML=A.get(t).username+H.get("joinedideafy");break;default:this.innerHTML=A.get(t).object}},date:function _(_){var e=new Date;if(_&&_[0]===e.getFullYear()&&_[1]===e.getMonth()&&_[2]===e.getDate()){var t=_[3],s=_[4],i=_[5];10>t&&(t="0"+t),10>s&&(s="0"+s),10>i&&(i="0"+i),this.innerHTML=t+":"+s+":"+i}else this.innerHTML=u.formatDate(_)},highlight:function(e){e&&"unread"===e?this.classList.add("unread"):this.classList.remove("unread")},setAvatar:function(e){var t,s;e&&(t=document.createDocumentFragment(),s=new d([e]),s.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))}}),msglistevent:new n(w),msglistcontrol:y,msgdetailstack:L}),w.template='<div id="connect-messages"><div class="messages"><div class="header blue-light"><span data-label="bind: innerHTML, msglistheadertitle">My Messages</span><div class="option right" data-msglistevent="listen: touchstart, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-msglistevent="listen:touchstart, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-msglistevent="listen: keypress, search"><div class="msglist overflow" data-msglistcontrol="radio:li,selected,touchend,selectMsg"><ul data-msg="foreach"><li class="msg list-item" data-msglistevent="listen:touchstart, setStart; listen:touchmove, showActionBar"><div data-msg="bind:setAvatar, author"></div><p class="msg-author unread" data-msg="bind:highlight, status; bind:innerHTML, username">Author</p><div class="select-msg"></div><span class="date" data-msg="bind: date, date"></span><p class="msg-subject unread" data-msg="bind:highlight, status; bind:setObject, type">Subject</p></li></ul></div></div><div id="msg-detail" class="details" data-msgdetailstack="destination"></div></div>',w.place(t.get("connect-messages")),w.plus=function(){L.getStack().get("#newmsg").reset(),L.getStack().show("#newmsg")},w.displaySort=function(e,t){var s=t.getAttribute("data-sort_id");A.reset([]),L.getStack().show("#defaultPage"),C>-1&&M.update(C,"selected",!1),M.update(s,"selected",!0),C=s,A.reset(D(s))},w.search=function(e,t){13===e.keyCode&&(M.update(C,"selected",!1),C=-1,A.reset(O(t.value)))},w.selectMsg=function(e){var t=e.target.getAttribute("data-msg_id"),s=I.get("notifications");if("unread"===A.get(t).status){for(i=0,l=s.length;l>i;i++)if(JSON.stringify(s[i])===JSON.stringify(A.get(t))){index=i;break}A.update(t,"status","read"),s[index]=A.get(t),I.set("notifications",s),I.upload()}L.getStack().show("#msgdetail"),x.reset(A.get(t)),S="#msgdetail"},w.init=function(){A.reset(I.get("notifications")),w.cleanOld()},w.reset=function(){M.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),w.init(),L.getStack().show("#defaultPage"),f&&f.hide()},w.getSelectedmsg=function(){var e=document.querySelector(".msg.selected"),t=-1;return e&&(t=e.getAttribute("data-msg_id")),t},w.cleanOld=function(){var e,t,s=new v,n=new Date,a=!1,c=I.get("notifications")||[],r=I.get("sentMessages")||[];for(i=c.length-1;i>=0;i--)e=new Date(c[i].date[0],c[i].date[1],c[i].date[2],c[i].date[3],c[i].date[4],c[i].date[5]),n.getTime()-e.getTime()>2592e6&&(c.pop(),a=!0);for(i=r.length-1;i>=0;i--)t=new Date(r[i].date[0],r[i].date[1],r[i].date[2],r[i].date[3],r[i].date[4],r[i].date[5]),n.getTime()-t.getTime()>2592e6&&(r.pop(),a=!0);return a?(I.set("notifications",c),I.set("sentMessages",r),I.upload().then(function(){s.fulfill()})):s.fulfill(),s},w.setStart=function(e){h=[e.pageX,e.pageY],f&&(f.hide(),f=null)},w.showActionBar=function(e,t){var s,i=t.getAttribute("data-msg_id"),n=!1;b=[e.pageX,e.pageY],f&&f.getParent()===t&&(n=!0),!n&&h[0]-b[0]>40&&b[1]-h[1]<20&&b[1]-h[1]>-20&&(f=new m("message",t,A.get(i)._id),s=document.createDocumentFragment(),f.place(s),t.appendChild(s))},T.template='<div class="msgsplash"><div class="header blue-dark"><span>'+o.get("labels").get("messageview")+'</span></div><div class="innersplash" data-labels="bind: innerHTML, messagecenter"></div></div>',T.plugins.add("labels",new s(H)),w.init(),L.getStack().add("#defaultPage",T),L.getStack().add("#msgdetail",x),L.getStack().add("#newmsg",q),L.getStack().show("#defaultPage"),I.watchValue("notifications",function(){var e,t=[];A.reset([]),t=D(C),A.reset(t),"#msgdetail"===L.getStack().getCurrentName()&&(e=w.getSelectedmsg(),e>-1?x.reset(A.get(e)):L.getStack().show("#defaultPage"))}),N.watch("display-message",function(e){var t=I.get("notifications");M.update(C,"selected",!1),"MSG"===t[e].type?(M.update(1,"selected",!0),C=1):(M.update(2,"selected",!0),C=2),t[e].status="read",I.set("notifications",t),I.upload(),A.reset([t[e]]),document.querySelector('li[data-msg_id="0"]').classList.add("selected"),y.init(document.querySelector('li[data-msg_id="0"]')),L.getStack().show("#msgdetail"),x.reset(t[e]),S="#msgdetail"}),N.watch("message-contact",function(e){q.reset(e),L.getStack().show("#newmsg")}),I.watchValue("lang",function(){var e;M.loop(function(t,s){t.selected&&(e=s)}),M.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),M.update(e,"selected",!0)}),w}});