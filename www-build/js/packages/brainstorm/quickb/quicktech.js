/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","service/help","Store","CouchDBStore","Promise","service/cardpopup","service/utils"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v,m){var g=new e,y=null,b=null,w,E=new o({timer:null,display:!1}),S=i.get("transport"),x=i.get("user"),T=i.get("labels"),N,C,k=new o({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),L=[],A=!0,O=new o,M=new o,_=new o,D={tech1:O,tech2:M,tech3:_},P=0,H=new o([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),B="step";return g.plugins.addAll({labels:new n(T),display:new n(k,{setReload:function(e){!e&&P>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){k.get("tech1").selected&&k.get("tech2").selected&&k.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new n(H,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e&&(this.innerHTML=e.toUpperCase())},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),quicktechtimer:new n(E,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new r(g)}),g.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:mousedown, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-quicktechevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="tech2" data-quicktechevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="tech3" data-quicktechevent="listen: mousedown, push; listen:mouseup, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>',g.place(t.get("quicktech")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){var n=new Date,r=n.getTime()-y;B==="step"?(B="screen",p.set("techno",H),clearInterval(w),E.set("display",!0),g.updateSessionScore(E.get("timer")).then(function(){h.unsync(),h.sync(i.get("db"),h.get("_id")).then(function(){var e=h.get("elapsedTimers");e.quicktech=E.get("timer"),h.set("elapsedTimers",e),h.set("techno",[[H.get(0).id,H.get(1).id,H.get(2).id]]),t.classList.remove("pressed"),v("quicktech")})})):(t.classList.remove("pressed"),v("quicktech"))},g.help=function(e,t){s.setContent("quicktechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g.prev=function(e,t){t.classList.remove("pressed"),d("quicktech")},g.toggleProgress=function(e,t){m(t)},g.toggleTimer=function(e,t){E.set("display",!E.get("display"))},g.select=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||P>0||B==="screen")&&t.classList.add("highlighted")},g.zoom=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||P>0||B==="screen")&&g.setPopup(n)},g.setPopup=function(t){var n={x:0,y:337},r="left",i=k.get(C)||"",s=new o,u,a=k.get(t);i&&(i.popup=!1,k.set(C,i)),a.popup=!0,k.set(t,a),C=t,t==="scenario"?(n.x=240,n.y=275,s.reset(h.get("scenario")[0]),s.set("type",5),u=s.toJSON()):(t==="tech1"&&(n.x=560),t==="tech2"&&(n.x=279,r="right"),t==="tech3"&&(n.x=426,r="right"),D[t].get("_id")&&(u=D[t].toJSON())),u&&N.reset(u,n,r,document.getElementById("quicktech-popup"))},g.closePopup=function(){var t=k.get(C);t.popup=!1,k.set(C,t),C=""},g.push=function(e,t){var n=t.getAttribute("name");t.classList.contains("drawok")?D[n].get("_id")&&B==="step"&&t.classList.add("pushed"):t.classList.add("pushed")},g.draw=function(e,t){B==="step"&&A&&(A=!1,k.get("tech1").selected||g.drawTech("tech1"),k.get("tech2").selected||g.drawTech("tech2"),k.get("tech3").selected||g.drawTech("tech3"),setTimeout(function(){t.classList.remove("pushed"),A=!0},350))},g.drawTech=function(t){var n;L.length===0&&(L=p.get("deck").techno.concat(),k.loop(function(e,t){e.selected&&L.splice(L.indexOf(H.get(t).id),1)})),n=Math.floor(Math.random()*L.length),g.getCardDetails(L[n],t),L.splice(n,1),k.set("left",L.length),P++},g.getCardDetails=function(t,n){var r=new u,s=["tech1","tech2","tech3"],o=s.indexOf(n);r.setTransport(S),r.sync(i.get("db"),t).then(function(){D[n].reset(JSON.parse(r.toJSON())),H.update(o,"id",t),H.update(o,"title",r.get("title")),H.update(o,"pic",r.get("picture_file")),setTimeout(function(){r.unsync()},500)})},g.accept=function(e,t){var n=t.getAttribute("name"),r=["tech1","tech2","tech3"],i=r.indexOf(n),s=k.get(n);B==="step"&&(H.get(i)&&H.get(i).id?s.selected?(t.classList.remove("pushed"),s.selected=!1,k.set(n,s)):(s.selected=!0,k.set(n,s)):(alert("please draw a card first"),t.classList.remove("pushed")))},g.reset=function(e){var t=h.get("techno")[0];k.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),console.log("quicktech",e,t),e&&t.length?(B="screen",g.getCardDetails(t[0],"tech1"),g.getCardDetails(t[1],"tech2"),g.getCardDetails(t[2],"tech3"),["tech1","tech2","tech3"].forEach(function(e){k.set(e,{popup:!1,selected:!0})}),H.watch("updated",function(){H.getNbItems()===3&&p.set("techno",H)})):(L=[],P=0,B="step",O.reset(),M.reset(),_.reset(),H.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),h.get("elapsedTimers").quicktech?b=h.get("elapsedTimers").quicktech:b=0,E.set("timer",b),B==="screen"?E.set("display",!0):g.initTimer(b)},g.updateSessionScore=function(t){var n=new a,r={sid:h.get("_id"),step:"quicktech",time:t,cards:P};return S.request("UpdateSessionScore",r,function(e){e.res==="ok"?n.resolve():n.reject()}),n},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;E.set("display",!1),E.set("timer",r),h.get("step")==="quicktech"&&(w=setInterval(function(){var e=new Date;E.set("timer",r+e.getTime()-n)},1e3))},N=new f(g.closePopup),p.watchValue("deck",function(e){L=e.techno.concat(),k.set("left",L.length)}),g}});