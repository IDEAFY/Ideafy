/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBDocument","service/config","Promise","Store","service/utils","lib/spin.min"],function(e,t,s,n,a,l,r,o,d){return function(){var c=new e,u=new r({}),g=new r([]),m=new r([]),b=new r({errormsg:""}),v=a.get("labels"),p=a.get("user"),f=new r(a.get("userLanguages")),h=function(){var e=p.get("lang").substring(0,2);u.set("lang",e),f.loop(function(t,i){t.name===e?f.update(i,"selected",!0):f.update(i,"selected",!1)})},w=({title:"",description:"",initiator:{id:p.get("_id"),username:p.get("username"),intro:p.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:p.get("active_deck"),status:"waiting",step:"mustart",lang:p.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]},new d({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:660}).spin());return h(),c.plugins.addAll({labels:new t(v),newmub:new t(u,{initSessionMode:function(e){switch(e){case"campfire":this.selectedIndex=1,this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2,this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0,this.setAttribute("style","color: #5F8F28;")}},setSessionInfo:function(e){switch(e){case"campfire":this.innerHTML=v.get("campfireinfo");break;case"boardroom":this.innerHTML=v.get("boardroominfo");break;default:this.innerHTML=v.get("rouletteinfo")}},displayInvitations:function(e){"boardroom"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setTitle:function(e){new Date,e&&e.username&&this.setAttribute("placeholder",v.get("quickstarttitleplaceholderpre")+e.username+v.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),select:new t(f,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),auto:new t(g,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),invited:new t(m,{setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),errormsg:new t(b),newmubevent:new s(c)}),c.template='<div id="newmub"><div id="newmub-content"><form><div class="idealang"><div class="currentlang" data-newmub="bind: displayLang, lang" data-newmubevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newmubevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label></label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: touchstart, press; listen:touchend, selectAll">Select all</div><input class="search" data-newmubevent="listen:touchstart, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:touchstart,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:touchend, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:touchstart, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=60 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: touchstart, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: touchstart, press; listen:touchend, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:touchstart, press; listen:touchend, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>',c.place(document.getElementById("newmub")),c.reset=function(){var e={title:"",description:"",initiator:{id:p.get("_id"),username:p.get("username"),intro:p.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:p.get("active_deck"),status:"waiting",step:"",lang:p.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]};u.reset(e),u.set("lang",p.get("lang")),u.set("deck",p.get("active_deck")),u.set("initiator",{id:p.get("_id"),username:p.get("username"),intro:p.get("intro")}),m.reset([]),b.set("errormsg",""),g.reset(p.get("connections").concat())},c.showLang=function(){c.dom.querySelector(".idealang ul").classList.remove("invisible")},c.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),f.loop(function(e,t){i===t?f.update(t,"selected",!0):f.update(t,"selected",!1)})},c.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),u.set("lang",f.get(i).name),c.dom.querySelector(".idealang ul").classList.add("invisible")},c.changeSessionMode=function(e,t){var i=t.selectedIndex,s=t.childNodes[i],n=s.getAttribute("name");g.reset(p.get("connections")),m.reset([]),u.set("mode",n)},c.displayAutoContact=function(){document.getElementById("invitelistauto").classList.remove("invisible"),g.reset(p.get("connections").concat())},c.updateAutoContact=function(e,t){var s,n=JSON.parse(g.toJSON()),a=p.get("connections").concat(),l=t.value.toLowerCase();if(""===t.value)g.reset(a);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),0!==s.search(l)&&n.splice(i,1);g.reset(n)}g.loop(function(e,t){m.toJSON().search(e.contact.userid)>-1&&g.update(t,"selected",!0)})},c.close=function(e,t){t.parentNode.classList.add("invisible")},c.discardContact=function(e,t){var i=t.getAttribute("data-invited_id"),s=m.get(i).userid;m.alter("splice",i,1),g.loop(function(e,t){e.userid===s&&setTimeout(function(){g.update(t,"selected",!1)},200)}),c.unselectGroup(s)},c.select=function(e,t){var i=t.getAttribute("data-auto_id");g.get(i).selected?(c.removeContact(g.get(i)),setTimeout(function(){g.update(i,"selected",!1),document.getElementById("invitelistauto").classList.add("invisible")},200)):(c.addContact(g.get(i)),c.selectGroup(),setTimeout(function(){g.update(i,"selected",!0),document.getElementById("invitelistauto").classList.add("invisible")},200))},c.selectAll=function(e,t){t.classList.remove("pressed"),m.reset([]),g.reset(p.get("connections")),g.loop(function(e,t){g.update(t,"selected",!0),"user"===e.type&&m.alter("push",e)})},c.removeContact=function(e){if("group"===e.type)for(j=e.contacts.length-1;j>=0;j--)c.removeContact(e.contacts[j]);else m.loop(function(t,i){t.userid===e.userid&&m.alter("splice",i,1)}),c.unselectGroup(e.userid),g.loop(function(t,i){t.userid===e.userid&&g.update(i,"selected",!1)})},c.selectGroup=function(){var e,t=!1;g.loop(function(i,s){if("group"===i.type&&!i.selected){for(e=i.contacts,t=!0,j=e.length-1;j>=0;j--)if(m.toJSON().search(e[j].userid)<0){t=!1;break}t&&g.update(s,"selected",!0)}})},c.unselectGroup=function(e){g.loop(function(t,i){"group"===t.type&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&g.update(i,"selected",!1)})},c.addContact=function(e){var t,i,s=!0;if("user"===e.type)m.alter("push",e);else for(t=0,i=e.contacts.length;i>t;t++)m.loop(function(i){i.userid===e.contacts[t].userid&&(s=!1)}),s&&(m.alter("push",e.contacts[t]),g.loop(function(i,s){i.userid===e.contacts[t].userid&&g.update(s,"selected",!0)}))},c.removeReadonly=function(e,t){t.removeAttribute("readonly")},c.press=function(e,t){t.classList.add("pressed")},c.clear=function(e,t){t.classList.remove("pressed"),c.reset()},c.create=function(e,t){t.classList.remove("pressed"),b.set("errormsg",""),u.get("title").length<3||u.get("description").length<3?b.set("errormsg",v.get("providesessioninfo")):"roulette"!==u.get("mode")&&p.get("connections").length<1?b.set("errormsg",v.get("nofriendtoinvite")):"boardroom"!==u.get("mode")||m.getNbItems()?(t.classList.add("invisible"),w.spin(t.parentNode),c.uploadSession().then(function(){w.stop(),t.classList.remove("invisible"),c.reset()})):b.set("errormsg",v.get("inviteatleastone"))},c.createChat=function(e){var t=new n,i=(new Date).getTime(),s=new l;return t.setTransport(a.get("transport")),t.set("users",[{username:p.get("username"),userid:p.get("_id")}]),t.set("msg",[{user:"SYS",type:0,arg:0,time:i}]),t.set("sid",u.get("_id")),t.set("lang",u.get("lang")),t.set("readonly",!1),t.set("step",0),t.set("type",17),t.sync(a.get("db"),e).then(function(){return t.upload()}).then(function(){s.fulfill(),t.unsync()}),s},c.uploadSession=function(){var e,t=new n,i=new Date,s=u.get("chat")||[],r=new l;return u.set("_id","S:MU:"+i.getTime()),u.set("date",[i.getFullYear(),i.getMonth(),i.getDate()]),"boardroom"===u.get("mode")&&m.loop(function(e){u.get("invited").push(e.userid)}),"campfire"===u.get("mode")&&u.set("invited",o.getUserContactIds()),e=u.get("_id")+"_0",s.push(e),u.set("chat",s),t.reset(JSON.parse(u.toJSON())),t.setTransport(a.get("transport")),t.sync(a.get("db"),t.get("_id")).then(function(){return c.createChat(e)}).then(function(){return t.upload()}).then(function(){"boardroom"===t.get("mode")?(b.set("errormsg",v.get("sendinginvites")),c.sendInvites(t.get("invited"),t.get("_id"),t.get("title")).then(function(){a.get("observer").notify("start-mu_session",t.get("_id")),r.fulfill(),t.unsync()})):(a.get("observer").notify("start-mu_session",t.get("_id")),r.fulfill(),t.unsync())}),r},c.sendInvites=function(e,t,i){var s=new l,n=new Date,r={type:"INV",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:p.get("_id"),username:p.get("username"),firstname:p.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:t,docTitle:i,dest:e};return a.get("transport").request("Notify",r,function(){b.set("errormsg",v.get("invitesent")),s.fulfill()}),s},c.reset(),p.watchValue("lang",function(){var e=JSON.parse(u.toJSON()),t=JSON.parse(b.toJSON());u.reset({}),u.reset(e),b.reset({}),b.reset(t)}),c}});