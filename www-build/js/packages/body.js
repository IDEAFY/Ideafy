/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

require(["Olives/OObject","Olives/LocalStore","Store","service/map","Amy/Stack-plugin","Olives/Model-plugin","Amy/Delegate-plugin","./dock","./login","service/config","CouchDBStore","service/utils","Promise"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=new e,d=null,v=new i({"#login":d}),m=new u,g=new t,y=new n({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),b=c.updateLabels,w=c.checkServerStatus,E=f.get("labels"),S=f.get("db"),x=f.get("transport"),T=f.get("user"),N=document.getElementById("login-form"),C=document.getElementById("signup-form");p.plugins.addAll({event:new o(p),loginmodel:new s(y),label:new s(E),stack:v}),p.alive(r.get("body")),d=new a,navigator.connection&&navigator.connection.type==="none"?(g.get("labels")?E.reset(g.get("labels")):E.reset(f.get("defaultLabels")),d.setScreen("#nointernet"),v.getStack().setCurrentScreen(d),document.getElementById("nointernet").classList.remove("invisible")):(d.setScreen("#loading-screen"),v.getStack().setCurrentScreen(d),document.getElementById("loading").classList.remove("invisible"),g.sync("ideafy-data"),w().then(function(e){g.get("labels")?E.reset(g.get("labels")):b(navigator.language),C.classList.remove("invisible"),N.classList.remove("invisible"),d.setScreen("#loading-screen");var t=g.get("currentLogin");t?x.request("CheckLogin",{id:t},function(e){e.authenticated?p.init():d.setScreen("#login-screen")}):d.setScreen("#signup-screen"),v.getStack().add("#dock",m)},function(e){g.get("labels")?E.reset(g.get("labels")):E.reset(f.get("defaultLabels")),d.setScreen("#maintenance-screen"),document.getElementById("serverdown").classList.remove("invisible"),v.getStack().setCurrentScreen(d)})),p.login=function(){var e=y.get("email").toLowerCase(),t=y.get("password");e&&t&&x.request("Login",{name:e,password:t},function(t){t.login==="ok"?(f.set("uid",'"'+e+'"'),t.db&&f.set("db",t.db),g.set("currentLogin",e),x.request("GetAvatar",{id:e},function(e){e.error||(g.set("userAvatar",e),g.sync("ideafy-data"),f.set("avatar",e)),g.sync("ideafy-data"),p.init()})):y.set("error",E.get("invalidlogin"))})},p.signup=function(){var e=y.get("email"),t=y.get("password"),n=y.get("confirm-password"),r=y.get("firstname"),i=y.get("lastname"),s=new h,o=new l;if(e==="")y.set("error",E.get("signupmissingemail"));else if(t==="")y.set("error",E.get("signupmissingpwd"));else if(n==="")y.set("error",E.get("signupmissingpwdok"));else if(r==="")y.set("error",E.get("signupmissingfn"));else if(i==="")y.set("error",E.get("signupmissingln"));else{var u=e.toLowerCase(),a=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;a.test(u)?t!==n?y.set("error",E.get("signuppwdnomatch")):x.request("Signup",{name:u,password:t,lang:f.get("language")},function(e){if(e.signup==="ok"){d.setScreen("#loading-screen"),o.reset(f.get("userTemplate")),o.set("fistname",r),o.set("lastname",i),o.set("username",r+" "+i),o.set("lang",f.get("language"));var t=new Date;o.set("notifications",[{type:"MSG",toList:r+" "+i,date:[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],object:E.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:E.get("signupwelcomebody")}]),x.request("Welcome",{userid:u,language:o.get("lang")},function(e){console.log(e)}),e.db&&f.set("db",e.db),o.setTransport(x),o.sync(e.db,u),setTimeout(function(){o.upload(),g.set("currentLogin",u),g.set("userAvatar",o.get("picture_file")),g.sync("ideafy-data"),f.set("uid",'"'+u+'"'),s.resolve()},250),s.then(function(){o.unsync(),setTimeout(function(){p.init(!0)},250)})}else y.set("error","error : "+e.message),y.set("email","")},this):y.set("error",E.get("signupinvalidemail"))}},p.resetError=function(e,t){y.set("error","")},p.enterlogin=function(e,t){e.keyCode===13&&(e.target.blur(),p.login())},p.entersignup=function(e,t){e.keyCode===13&&(e.target.blur(),p.signup())},p.press=function(e){e.target.classList.add("pressed")},p.release=function(e){e.target.classList.remove("pressed")},p.forceLandscape=function(e,t){var n=.98046875,r=768/748;window.orientation===90||window.orientation===-90?t.setAttribute("style","-webkit-transform-origin:0;-webkit-transform:0;"):window.orientation>0?t.setAttribute("style","-webkit-transform-origin: 384px 374px; -webkit-transform:rotate(-90deg) scale("+n+","+r+"); -webkit-transition: all 1s ease-in-out;"):t.setAttribute("style","-webkit-transform-origin:384px 374px;-webkit-transform:rotate(90deg) scale("+n+","+r+"); -webkit-transition: all 0.25s ease-in-out;")},p.init=function(e){T.sync(S,g.get("currentLogin")).then(function(){var t=!1;f.set("uid",'"'+T.get("_id")+'"'),T.get("lang")!==f.get("lang")&&(t=!0),t&&T.get("picture_file").search("img/avatars/deedee")>-1?(f.set("avatar",T.get("picture_file")),b(T.get("lang")).then(function(){t=!1,m.init(),v.getStack().show("#dock")})):T.get("picture_file").search("img/avatars/deedee")>-1?(f.set("avatar",T.get("picture_file")),m.init(e),v.getStack().show("#dock")):(t&&b(T.get("lang")).then(function(){t=!1}),x.request("GetFile",{sid:"avatars",filename:T.get("_id")+"_@v@t@r"},function(t){t.error||(f.set("avatar",t),m.init(e),v.getStack().show("#dock"))}))}),f.watchValue("uid",function(e){e===""})}});