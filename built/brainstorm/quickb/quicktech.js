/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min"],function(e,t,i,s,n,a,r,c,o,d,l,u){return function(p,g,h,m,v){var b,f,w,y=new e,L=null,k=null,S=new r({timer:null,display:!1}),T=n.get("transport"),x=(n.get("user"),n.get("labels")),q={left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}},M=new r(q),A=[],I=!0,_=new r,P=new r,N=new r,H={tech1:_,tech2:P,tech3:N},C=0,D=new r([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),O="step",B=new u({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373}).spin();return y.plugins.addAll({labels:new i(x),display:new i(M,{setReload:function(e){!e&&C>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(){M.get("tech1").selected&&M.get("tech2").selected&&M.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new i(D,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){this.innerHTML=e?e.toUpperCase():x.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},n.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),quicktechtimer:new i(S,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new s(y)}),y.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: touchstart, press; listen: touchstart, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:touchstart, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:touchstart,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:touchstart, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: touchstart, select; listen:touchstart, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: touchstart, push; listen:touchend, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: touchstart, select; listen:touchend, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-quicktechevent="listen: touchstart,  accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-quicktechevent="listen: touchstart, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-quicktechevent="listen: touchstart, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: touchstart, press; listen:touchend, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>',y.place(t.get("quicktech")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var i=new Date;i.getTime()-L,B.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===O?(O="screen",g.set("techno",D),clearInterval(b),S.set("display",!0),y.updateSessionScore(S.get("timer")).then(function(){return p.unsync(),p.sync(n.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quicktech=S.get("timer"),p.set("elapsedTimers",e),p.set("techno",[[D.get(0).id,D.get(1).id,D.get(2).id]]),m("quicktech")})):m("quicktech")},y.stopSpinner=function(){B.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.help=function(){a.setContent("quicktechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},y.prev=function(e,t){t.classList.remove("pressed"),h("quicktech")},y.toggleProgress=function(){v()},y.toggleTimer=function(){S.set("display",!S.get("display"))},y.select=function(e,t){var i=t.getAttribute("name");(i.search("tech")<0||C>0||"screen"===O)&&t.classList.add("highlighted")},y.zoom=function(e,t){var i=t.getAttribute("name");(i.search("tech")<0||C>0||"screen"===O)&&y.setPopup(i)},y.setPopup=function(e){var t,i={x:0,y:337},s="left",n=M.get(w)||"",a=new r,c=M.get(e);n&&(n.popup=!1,M.set(w,n)),c.popup=!0,M.set(e,c),w=e,"scenario"===e?(i.x=147,i.y=275,a.reset(p.get("scenario")[0]),a.set("type",5),t=a.toJSON()):("tech1"===e&&(i.x=467),"tech2"===e&&(i.x=186,s="right"),"tech3"===e&&(i.x=333,s="right"),H[e].get("_id")&&(t=H[e].toJSON())),t&&f.reset(t,i,s,document.getElementById("quicktech-popup"))},y.closePopup=function(){var e=M.get(w);e.popup=!1,M.set(w,e),w=""},y.push=function(e,t){var i=t.getAttribute("name");t.classList.contains("drawok")?H[i].get("_id")&&"step"===O&&t.classList.add("pushed"):t.classList.add("pushed")},y.draw=function(e,t){var i=[];"step"===O&&I&&(I=!1,["tech1","tech2","tech3"].forEach(function(e){M.get(e).selected||i.push(e)}),y.drawTech(i).then(function(){t.classList.remove("pushed"),I=!0}))},y.drawTech=function(e){var t,i=[],s=new o;return e.forEach(function(e){A.length<=0&&(A=g.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){M.get(e).selected&&i.push(D.get(t).id)}),A.filter(function(e){return!(i.indexOf(e)>-1)})),t=Math.floor(Math.random()*A.length),y.getCardDetails(A[t],e),M.set("left",A.length),C++,A.splice(t,1)}),s.fulfill(),s},y.getCardDetails=function(e,t){var i=new c,s=["tech1","tech2","tech3"].indexOf(t),a=new o;return i.setTransport(T),i.sync(n.get("db"),e).then(function(){H[t].reset(JSON.parse(i.toJSON())),D.update(s,"id",e),D.update(s,"title",i.get("title")),D.update(s,"pic",i.get("picture_file")),a.fulfill(),i.unsync()}),a},y.accept=function(e,t){var i=t.getAttribute("name"),s=["tech1","tech2","tech3"].indexOf(i),n=M.get(i);"step"===O&&(D.get(s).id?(n.selected=!n.selected,M.set(i,n)):alert("please draw a card first"))},y.reset=function(e){var t=p.get("techno")[0];M.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),D.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),O="step",e&&t&&t.length?(O="screen",y.getCardDetails(t[0],"tech1").then(function(){return y.getCardDetails(t[1],"tech2")}).then(function(){return y.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){M.set(e,{popup:!1,selected:!0})}),g.set("techno",D)})):(A=[],C=0,_.reset(),P.reset(),N.reset(),D.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),k=p.get("elapsedTimers").quicktech?p.get("elapsedTimers").quicktech:0,S.set("timer",k),"screen"===O?S.set("display",!0):y.initTimer(k)},y.updateSessionScore=function(e){var t=new o,i={sid:p.get("_id"),step:"quicktech",time:e,cards:C};return T.request("UpdateSessionScore",i,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},y.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;S.set("display",!1),S.set("timer",s),"quicktech"===p.get("step")&&(b=setInterval(function(){var e=new Date;S.set("timer",s+e.getTime()-i)},1e3))},f=new d(y.closePopup),g.watchValue("deck",function(e){A=e.techno.concat(),M.set("left",A.length)}),y}});