/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/config","Olives/Model-plugin","Olives/Event-plugin","Store","service/utils"],function(e,t,n,r,i,s){return function(u){var a=new e,f=t.get("user"),l=t.get("transport"),c=new Date,h=new i({author:f.get("_id"),message:"",firstname:f.get("firstname"),date:[c.getFullYear(),c.getMonth(),c.getDate()],datemod:"",plusones:0,replies:[]}),p,d,v=u||"public",m="new",g=0;return a.plugins.addAll({twocent:new n(h,{date:function(e){e&&(this.innerHTML=s.formatDate(e))},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new n(t,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),labels:new n(t.get("labels")),twocentevent:new r(a)}),a.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: mousedown, press; listen: mouseup, publish">Publish</div></div></div>',a.reset=function(t,n,r,i){var s=new Date,o={author:f.get("_id"),message:"",firstname:f.get("firstname"),date:"",datemod:"",plusones:0,replies:[]};t&&(p=t),n?(h.reset(n),m=n,g=r,h.set("datemod",[s.getFullYear(),s.getMonth(),s.getDate()])):(h.reset(o),h.set("date",[s.getFullYear(),s.getMonth(),s.getDate()]),m="new"),i&&(d=i)},a.cancel=function(e,t){t.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),d?d():document.getElementById(v+"-writetwocents").classList.add("invisible")},a.publish=function(e,n){n.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;");if(h.get("message")){var r=JSON.parse(h.toJSON()),i,s;m==="new"?s="new":s="edit",i={docId:p,type:s,position:g,twocent:r},l.request("WriteTwocent",i,function(e){e!=="ok"?alert(t.get("labels").get("somethingwrong")):(m==="new"?document.getElementById(v+"-writetwocents").classList.add("invisible"):d(),a.reset(p))},a)}},a.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")},a}});