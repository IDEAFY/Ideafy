/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store","Promise","service/autocontact","lib/spin.min"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new s,d=new s({errormsg:""}),v=r.get("labels"),m=r.get("user"),g=r.get("transport"),y=!1,b=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),w={},E=function(e){var t=p.get("toList").toLowerCase().split(/,|;/),n=p.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(m.get("connections")).toLowerCase(),s=[],u={},a=new o;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+t[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(t[i].trim())}if(!d.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+n[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(n[i].trim())}return d.get("errormsg")||(u.list=s,g.request("CheckRecipientList",u,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.fulfill()}else d.set("errormsg",t.error),a.reject()})),a};return h.plugins.addAll({labels:new t(v),errormsg:new t(d),newmessage:new t(p,{setAvatar:function(e){this.setAttribute("style","background: url('"+r.get("avatar")+"') no-repeat center center;background-size:cover;")}}),newmessageevent:new n(h)}),h.template='<div id="newmsg"><div class="header blue-dark"><span data-labels="bind: innerHTML, newmsg">New message</span></div><div class="avatar" data-newmessage="bind: setAvatar, author"></div><form class="form"><p><textarea class="mail-header" name="toList" data-newmessage="bind: value, toList" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea class="mail-header" name="ccList" data-newmessage="bind: value, ccList" data-labels="bind:placeholder, cclbl" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><input type="text" class="input" data-newmessage="bind:value, object" data-labels="bind:placeholder, subjectlbl"></p><p><textarea class="input" data-newmessage="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-newmessage="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-newmessageevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-newmessageevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',h.reset=function(t){var n,r,i="";p.reset({author:m.get("_id"),username:m.get("username"),firstname:m.get("firstname"),type:"MSG",signature:m.get("username"),toList:"",ccList:"",object:"",body:"",date:null}),m.get("signature")?p.set("signature",m.get("signature")):p.set("signature",m.get("username")),d.reset({errormsg:""});if(t){console.log(t);if(t.type==="user")p.set("toList",t.username);else{for(n=0,r=t.contacts.length;n<r;n++)i?i=i+", "+t.contacts[n].username:i=t.contacts[n].username;p.set("toList",i)}}},h.press=function(e,t){t.classList.add("pressed")},h.cancel=function(e,t){t.classList.remove("pressed"),y=!1,h.reset(),c("#defaultPage")},h.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){p.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new u(r,t,s),w.name=i,r.classList.remove("invisible")},h.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?w.name.init():w.name.updateList()},h.send=function(e,t){var n=new Date,r={};t.classList.add("invisible"),t.classList.remove("pressed"),b.spin(t.parentNode),y||(y=!0,d.set("errormsg",""),r.author=p.get("author"),r.username=p.get("username"),r.firstname=p.get("firstname"),r.signature=p.get("signature"),r.toList=p.get("toList"),r.ccList=p.get("ccList"),r.object=p.get("object"),r.body=p.get("body"),r.type="MSG",p.get("object")||(d.set("errormsg",v.get("entersubjectlbl")),y=!1),r.dest=[],E(function(e){r.dest=e}).then(function(){d.get("errormsg")?(console.log(result),y=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],g.request("Notify",r,function(e){y=!1,b.stop(),t.classList.remove("invisible"),h.reset(),d.set("errormsg",v.get("messagesentok")),setTimeout(function(){d.set("errormsg",""),t.classList.remove("invisible"),c("#defaultPage")},2e3)}))}))},h}});