/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/cardpopup","../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min"],function(e,t,i,s,n,a,r,o,c,d,l,u){return function(p,g,m,h,v){var b,f,w,y=new e,L="step",S=0,k=new o({timer:null,display:!1}),T=new o({title:"",description:"",solution:"",visibility:"private"}),x=new o,q=new o([]),M=[],A={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},I=new o(A),H=new o([]),_=new r("idea",H,I),C=n.get("transport"),P=n.get("labels"),N=n.get("user"),D=new u({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690}).spin();return y.plugins.addAll({labels:new i(P,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new i(x),techs:new i(q,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},n.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(I,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;"scenario"===this.getAttribute("name")?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),quickideatimer:new i(k,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new i(T,{setVisibility:function(e){"public"===e?(this.value=0,this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")):(this.value=1,this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))}}),wbstack:_,quickideaevent:new s(y)}),y.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:touchstart, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:touchstart,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: touchstart, select; listen:touchend, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: touchstart, select; listen:touchend, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: touchstart, push; listen:touchend, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: touchstart, push; listen:touchend, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: touchstart, push; listen:touchend, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: touchstart, press; listen:touchend, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:touchend, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: touchstart, press; listen:touchend, next"></div></div></div>',y.place(t.get("quickidea")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var i;new Date,D.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===L?(L="screen",clearInterval(w),k.set("display",!0),i=y.getSessionDuration(),g.set("idea",JSON.parse(T.toJSON())),y.createIdeaDoc().then(function(){return y.updateSessionScore(k.get("timer"))}).then(function(){return p.unsync(),p.sync(n.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");return e.quickidea=k.get("timer"),p.set("idea",[JSON.parse(T.toJSON())]),p.set("elapsedTimers",e),p.set("duration",i),p.set("status","completed"),I.set("readonly",!0),h("quickidea")}).then(function(){N.set("sessionInProgress",{}),user.upload()})):h("quickidea")},y.stopSpinner=function(){D.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),m("quickidea")},y.toggleProgress=function(){v()},y.toggleTimer=function(){k.set("display",!k.get("display"))},y.toggleVisibility=function(){"step"===L&&("public"===T.get("visibility")?T.set("visibility","private"):T.set("visibility","public"))},y.push=function(e,t){var i=t.getAttribute("name");I.set(i,"active")},y.select=function(e,t){t.classList.add("higlighted")},y.zoom=function(e,t){var i,s;"scenario"===t.getAttribute("name")?i="scenario":(i="techno",s=t.getAttribute("data-techs_id")),y.setPopup(i,s)},y.setPopup=function(e,t){var i,s={x:147,y:30},a="left",r=I.get("cardpopup"),d=new o,l="";f&&("scenario"===f.type?r.scenario=!1:r.techs[f.id]=!1,I.set("cardpopup",r)),"scenario"===e?r.scenario=!0:r.techs[t]=!0,I.set("cardpopup",r),f={type:e,id:t},"scenario"===e?(s.y=55,d.reset(g.get("scenario")),d.set("type",5),l=d.toJSON(),b.reset(l,s,a,document.getElementById("quickidea-popup"))):(0==t&&(s.y=200),1==t&&(s.y=260),2==t&&(s.y=350),M[t]?(l=M[t],b.reset(l,s,a,document.getElementById("quickidea-popup"))):(i=new c,i.setTransport(C),i.sync(n.get("db"),g.get("techno").get(t).id).then(function(){l=i.toJSON(),b.reset(l,s,a,document.getElementById("quickidea-popup")),M[t]=l})))},y.closePopup=function(){var e=I.get("cardpopup");e[f]=!1,I.set("cardpopup",e),f=""},b=new a(y.closePopup),y.post=function(){_.selectScreen("postit"),I.set("import","inactive"),I.set("drawing","inactive")},y.importpic=function(){_.selectScreen("import"),I.set("postit","inactive"),I.set("drawing","inactive")},y.draw=function(){_.selectScreen("drawing"),I.set("import","inactive"),I.set("postit","inactive")},y.exitTool=function(e){I.set(e,"inactive")},y.finish=function(e,t){_.setReadonly(!0),I.set("ready",!1),I.set("showidea",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new d,i={sid:p.get("_id"),step:"quickidea",time:e,wbcontent:H.toJSON(),idea:T.toJSON()};return C.request("UpdateSessionScore",i,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},y.getSessionDuration=function(){var e=p.get("elapsedTime"),t=p.get("resumeTime")||p.get("startTime");return now=new Date,now.getTime()-t+e},y.createIdeaDoc=function(){var e=new c(n.get("ideaTemplate")),t=new Date,i="I:"+t.getTime(),s=new d;return e.setTransport(C),e.set("title",T.get("title")),e.set("sessionId",p.get("_id")),e.set("authors",[p.get("initiator").id]),e.set("description",T.get("description")),e.set("solution",T.get("solution")),e.set("creation_date",[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()]),e.set("character",p.get("characters")[0]),e.set("problem",p.get("problems")[0]),e.set("context",p.get("contexts")[0]),e.set("techno",p.get("techno")[0]),e.set("visibility",T.get("visibility")),e.set("authornames",p.get("initiator").username),e.set("lang",p.get("lang").substring(0,2)),e.set("_id",i),e.sync(n.get("db"),i).then(function(){return e.upload()}).then(function(){"public"===e.get("visibility")&&C.request("UpdateUIP",{userid:N.get("_id"),type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){"ok"!==e&&console.log(e)}),s.fulfill(),e.unsync()}),s},y.reset=function(){I.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),q.reset(),_.setSessionId(p.get("_id")),H.reset(p.get("ideaWB")),H.getNbItems()?_.selectScreen("main"):_.selectScreen("default"),clearInterval(w),p.get("idea").length?(_.setReadonly(!0),I.set("ready",!1),I.set("showidea",!0),T.reset(p.get("idea")[0]),g.set("idea",p.get("idea")[0]),I.set("readonly",!0),I.set("shownext",!0),L="screen"):(T.reset({title:"",description:"",solution:"",visibility:"private"}),H.getNbItems()?I.set("ready",!0):I.set("ready",!1),_.setReadonly(!1),L="step"),p.get("elapsedTimers").quickidea&&(S=p.get("elapsedTimers").quickidea,k.set("timer",S)),"screen"===L?k.set("display",!0):y.initTimer(S)},y.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;k.set("display",!1),k.set("timer",s),"quickidea"===p.get("step")&&(clearInterval(w),w=setInterval(function(){var e=new Date;k.set("timer",s+e.getTime()-i)},1e3))},p.watchValue("_id",function(e){_.setSessionId(e)}),g.watchValue("scenario",function(){x.reset(g.get("scenario"))}),g.watchValue("techno",function(){q.reset(JSON.parse(g.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){H.watch(e,function(){JSON.stringify(p.get("ideaWB"))!==H.toJSON()&&(p.set("ideaWB",JSON.parse(H.toJSON())),p.upload()),H.getNbItems()?I.set("ready",!0):I.set("ready",!1)})}),T.watch("updated",function(){T.get("title")&&T.get("description")&&T.get("solution")?I.set("shownext",!0):I.set("shownext",!1)}),y}});