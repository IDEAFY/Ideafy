/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,l,c,h,p){var d=new n([]),v=new t([]),m=!1,g="",y=null,b={db:l,view:h,design:c,query:{descending:!0}},w=r.get("labels"),E=this;d.setTransport(r.get("transport")),e==="contact"?g="contacttwoqlist":g="",this.template='<div><ul class="twoq-list '+g+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+g+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new i(d,{date:function S(S){S?this.innerHTML=o.formatDate(S):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=w.get("noreplyyet"):n===1?this.innerHTML=n+" "+w.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+w.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new i(v,{date:function x(x){x?this.innerHTML=o.formatDate(x):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=w.get("noreplyyet"):n===1?this.innerHTML=n+" "+w.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+w.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new s(this)}),this.getModel=function(){var e,t;return t=!E.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),t?e=v:e=d,e},this.resetQuery=function(e){var t=new f;return b.query=e,d.unsync(),d.reset([]),E.hideSearch(),d.sync(b.db,b.design,b.view,b.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){y&&this.hideActionBar(y)},this.showActionBar=function(e,t){var n=t.getAttribute("data-twoqlist_id"),r=document.getElementById("mtc-list"),i,s;r.classList.contains("mosaic")||(actionBar=new a("2Q",t,d.get(n).value,this.hideActionBar),s=document.createDocumentFragment(),actionBar.place(s),t.appendChild(s),y=actionBar,m=!0)},this.hideActionBar=function(t){var n=t.dom.parentElement;n.removeChild(n.lastChild),m=!1,y=null},this.showSearch=function(){var t=document.querySelector(".twoq-searchlist"),n=document.querySelector(".twoq-list");t&&t.classList.contains("invisible")&&(n.classList.add("invisible"),t.classList.remove("invisible"))},this.hideSearch=function(){var t=this.dom.querySelector(".twoq-searchlist"),n=this.dom.querySelector(".twoq-list");t&&!t.classList.contains("invisible")&&(n.classList.remove("invisible"),t.classList.add("invisible"))},this.search=function(t){v.reset([]),t.toLowerCase()?(this.showSearch(),d.loop(function(e,n){JSON.stringify(e).search(t)>-1&&v.alter("push",e)})):this.hideSearch()},p&&(b.query=p),this.init=function(){var t=new f;return d.sync(b.db,b.design,b.view,b.query).then(function(){t.fulfill()}),t}}return function(n,r,i,s,o){return l.prototype=new e,new l(n,r,i,s,o)}});