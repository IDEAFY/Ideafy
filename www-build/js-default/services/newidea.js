/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var a=new e,f=new s(i.get("ideaTemplate")),l=i.get("user"),c=i.get("labels"),h=new s({error:""}),p=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return f.setTransport(i.get("transport")),a.plugins.addAll({newidea:new n(f,{setVisibility:function(e){e==="public"?(this.innerHTML=c.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=c.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){e==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),labels:new n(c),errormsg:new n(h,{setError:function(e){switch(e){case"notitle":this.innerHTML=c.get("titlefield")+c.get("emptyfielderror");break;case"nodesc":this.innerHTML=c.get("descriptionfield")+c.get("emptyfielderror");break;case"nosol":this.innerHTML=c.get("solutionfield")+c.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new r(a)}),a.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',a.render(),a.place(t.get("newidea-popup")),a.toggleVisibility=function(e,t){t.value==="1"?f.set("visibility","private"):f.set("visibility","public")},a.press=function(e,t){t.classList.add("pressed"),a.dom.querySelector(".publicwarning").classList.add("invisible")},a.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.unsync(),f.reset(i.get("ideaTemplate")),h.reset({error:""}),a.dom.querySelector(".visibility-slider").value=1},a.resetError=function(e,t){var n;t.scrollTop=99999,h.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",h.get("error")===n&&t.value&&h.set("error",""))},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,t){var n=new Date,r="I:"+n.getTime(),s;t.classList.remove("pressed"),f.get("title")?f.get("description")?f.get("solution")||h.set("error","nosol"):h.set("error","nodesc"):h.set("error","notitle"),!h.get("error")&&!f.get("_id")&&(t.classList.add("invisible"),p.spin(t.parentNode),s=setInterval(function(){h.get("error")===c.get("uploadinprogress")?h.set("error",c.get("uploadinprogress")+"..."):h.set("error",c.get("uploadinprogress"))},100),f.set("authors",[l.get("_id")]),f.set("authornames",l.get("username")),f.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),f.set("lang",l.get("lang")),f.sync(i.get("db"),r).then(function(){return f.upload()}).then(function(){f.get("visibility")==="public"?i.get("transport").request("UpdateUIP",{userid:l.get("_id"),type:f.get("type"),docId:r,docTitle:f.get("title")},function(e){e!=="ok"&&console.log(e),p.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s)}):(p.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s))}))},a}});