/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","service/config","Olives/Model-plugin","Olives/Event-plugin","Store","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new o({errormsg:""}),d=n.get("user"),v=n.get("transport"),m=n.get("labels"),g=new o({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:!1});return h.plugins.addAll({labels:new r(m),mail:new r(g,{setUserAvatar:function(e){e&&this.setAttribute("style","background: url('"+n.get("avatar")+"') no-repeat center center;")},date:function y(y){y&&(this.innerHTML=a.formatDate(y))},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setRating:function(e){},setVotes:function(e){}}),mailevent:new s(h),errormsg:new r(p)}),h.template='<div class="idea-sendmail"><div class="header blue-dark"><a href="#public-2cents" class="option left"></a><span data-labels="bind:innerHTML, sendidealbl"></span><a href="#public-favorites" class="option right"></a></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment. votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',h.place(t.get("public-sendmail")),h.reset=function(t){p.reset({errormsg:""}),g.reset({toField:"",from:d.get("username"),subject:"",body:"",signature:d.get("username")+" <"+d.get("_id"),attachment:t,sent:!1}),d.get("signature")&&g.set("signature",d.get("signature")),json={}},h.validateAddress=function(t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,r=t.toLowerCase().split(/,|;/),s=!0;for(i=0,l=r.length;i<l;i++)if(!n.test(r[i].trim())){p.set("errormsg",r[i]+m.get("notavalidaddress")),s=!1;break}return s},h.validateMessage=function(){return g.get("toField")?h.validateAddress(g.get("toField")):p.set("errormsg",m.get("norecipient")),p.get("errormsg")===""},h.sendMail=function(){json.type="doc",json.recipient=g.get("toField"),json.cc=d.get("_id"),json.replyTo=d.get("_id"),json.subject=d.get("username")+m.get("sentdocmsg"),json.header=g.get("subject"),json.body=g.get("body"),json.signature=g.get("signature"),json.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+g.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+g.get("attachment").authornames+", <span style='color:black';>"+a.formatDate(g.get("attachment").creation_date)+"</span></p></div>",json.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").solution+"</p></div>",v.request("SendMail",json,function(e){e.sendmail==="ok"?(p.set("errormsg",m.get("yourmessage")+e.recipient+m.get("sentoklbl")),setTimeout(function(){c("close")},350)):(p.set("errormsg",m.get("somethingwrong")),g.set("sent",!1),console.log("error",e.error),console.log("response",e.response))})},h.press=function(e,t){(!t.classList.contains("sendmail")||!g.get("sent"))&&t.classList.add("pressed")},h.send=function(e,t){g.get("sent")||(g.set("sent",!0),p.set("errormsg",""),t.classList.remove("pressed"),h.validateMessage()?h.sendMail():g.set("sent",!1))},h.cancel=function(e,t){t.classList.remove("pressed"),c("close")},h}});