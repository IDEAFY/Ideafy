/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBView","CouchDBDocument","Store","service/utils","service/avatarlist","service/confirm","lib/spin.min","Promise"],function(e,t,n,r,s,o,u,a,f,l,c,h,p){return function(){var v=new e,m=new e,g=t.get("sessions"),y=new a,b=s.get("db"),w=s.get("transport"),E=s.get("user"),S=s.get("avatars"),x=s.get("labels"),T=new a({}),N="sbydate",C=[],k=[],L="",A=new o,O=(new h({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330})).spin(),M,_;return A.setTransport(w),v.plugins.addAll({label:new n(x),sort:new n(T,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(y,{setMode:function(e){switch(e){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');")}},formatDate:function(e){e&&e.length&&(this.innerHTML=f.formatDate(e))},formatIdeas:function(e){if(e&&e.length===1)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=x.get("noideayet")},setAvatars:function(e){var t,n;e&&(t=new l(e),n=document.createDocumentFragment(),node=this,t.place(n),node.hasChildNodes()?node.replaceChild(n,node.firstChild):node.appendChild(n))},setStatus:function(e){e==="completed"?this.innerHTML=x.get("completed"):this.innerHTML=x.get("inprogress")},setScore:function(e){e>=0?this.innerHTML=e:this.innerHTML=""},setSuffix:function(e){e===undefined||e===""||e===null?this.innerHTML=x.get("noscore"):this.innerHTML="ip"}}),sortevent:new r(v),sessionevent:new r(v)}),v.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen: dblclick, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>',v.sort=function(t,n){var r=n.getAttribute("id");T.get(r).selected?T.set(r,{selected:!0,descending:!T.get(r).descending}):(T.set(N,{selected:!1,descending:T.get(N).descending}),T.set(r,{selected:!0,descending:T.get(r).descending}),N=r),v.sortSessions(r)},v.sortSessions=function(t){var n;L?n=k:n=C;if(n.length)switch(t){case"sbytitle":f.sortByProperty(n,"title",T.get("sbytitle").descending);break;case"sbydate":f.sortByProperty(n,"date",T.get("sbydate").descending);break;case"sbyidea":f.sortByProperty(n,"idea",T.get("sbyidea").descending);break;case"sbyscore":f.sortByProperty(n,"score",T.get("sbyscore").descending)}y.reset(n)},v.acceptinput=function(e,t){t.removeAttribute("readonly")},v.search=function(t,n){var r=document.getElementById("sessionsearchresult");r.innerHTML="",t.keyCode===13&&(L=n.value,L===""?(v.sortSessions(N),y.reset(C)):(k=f.searchArray(C,L),r.innerHTML=x.get("foundlbl")+" "+k.length+" "+x.get("matchingsessions"),y.reset(k)))},v.displayActionBar=function(e,t){var n=t.getAttribute("data-sessions_id"),r=t.offsetHeight,i=y.get(n);t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+r+"px;height: "+r+"px;"),i.participants.length>1||i.participants[0]!=E.get("_id")||i.id===E.get("sessionInProgress").id?t.querySelector(".deletesession").setAttribute("style","display: none;"):t.querySelector(".deletesession").setAttribute("style","display: inline-block; background-size: 40px 40px;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3)},v.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},v.press=function(e,t){var n=t.getAttribute("data-sessions_id");t.classList.add("pressed"),n&&O.spin(document.getElementById("sessionlistspinner"))},v.replay=function(e,t){var n=t.getAttribute("data-sessions_id"),r=y.get(n).id,i=y.get(n).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),O.stop(),s.get("observer").notify("replay-session",r,i)},v.deleteSession=function(e,t){var n=t.getAttribute("data-sessions_id"),r=y.get(n).id,i=function(e){var t=new u,n=new p;return t.setTransport(w),t.sync(b,e).then(function(){var e=t.get("replayIdeas")||[];e.forEach(function(e){var t=new u;t.setTransport(w),t.sync(b,e).then(function(){return t.set("sessionId",t.get("sessionId")+"_deleted"),t.set("sessionReplay",!1),t.upload()}).then(function(){t.unsync()},function(e){console.log(e)})}),w.request("cleanUpSession",r,function(e){e.err&&console.log(e.err),t.remove().then(function(){t.unsync(),n.fulfill()})})}),n},s,o=x.get("deletereplay"),a=function(e){e?(O.spin(document.getElementById("sessionlistspinner")),i(r).then(function(){O.stop(),s.close()})):s.close()};t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;"),y.get(n).replayIdeas&&y.get(n).replayIdeas.length?(O.stop(),s=new c(document.getElementById("session-list"),o,a),s.show()):i(r).then(function(){O.stop()})},v.resetSessionData=function(){C=[],A.loop(function(e,t){var n={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode,replayIdeas:e.value.replayIdeas};n.participants.push(e.value.initiator.id),n.usernames.push(e.value.initiator.username);for(j=0;j<e.value.participants.length;j++)n.participants.push(e.value.participants[j].id),n.usernames.push(e.value.participants[j].username);n.idea&&n.idea.length>1&&f.sortByProperty(n.idea,"title",!1),C.push(n)}),v.sortSessions("sbydate")},v.getMode=function(t){var n;return A.loop(function(e,r){e.id===t&&(n=e.value.mode)}),n},v.place(g),v.reset=function(){A.unsync(),A.reset(),y.reset([]),T.reset({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),N="sbydate",C=[],k=[],L="",A.sync(b,"library","_view/sessions",{key:s.get("uid"),descending:!0}).then(function(){v.resetSessionData()})},["added","deleted","updated"].forEach(function(e){A.watch(e,function(e,t){v.resetSessionData(),v.sortSessions(N)})}),v.reset(),v}});