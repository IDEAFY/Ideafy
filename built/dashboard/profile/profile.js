/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","./leaderboard","./editprofile","Promise"],function(e,t,s,n,a,r,c,o,d,u){return function(){var p,g,v=new e,h=a.get("user"),b=(h.get("ip"),a.get("labels")),m=new r({total:0,ideas:0,sessions:0,contacts:0,twoQ:0}),f=new r({status:""}),w=new r({view:"info",completion:0,socialnw:0}),y=new r(h.get("news")),L=new r([]),k=new r;return v.plugins.addAll({label:new s(b),stats:new s(w,{setViewLbl:function(e){this.innerHTML=b.get(e),"info"===e?this.setAttribute("style","background: #9ac9cd;"):this.setAttribute("style","background: #5F8F28;")},toggleInformation:function(e){"info"===e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleLeaderboard:function(e){"leaderboard"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setPercentage:function(e){this.innerHTML=b.get("completionprefix")+e+b.get("completionsuffix")},setProgress:function(e){100===e?this.setAttribute("style","width:100%;border-top-right-radius:5px;border-bottom-right-radius:5px;"):this.setAttribute("style","width:"+e+"%;")},showDetails:function(e){100===e?this.classList.add("invisible"):this.classList.remove("invisible")},showSocialNW:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),grades:new s(L,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new s(k,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),progressbar:new s(m,{setWidth:function(e){this.setAttribute("style","width:"+e+"%;")}}),progress:new s(f),config:new s(a,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),user:new s(h,{setLocation:function(e){this.innerHTML=e.country?e.country.toUpperCase():b.get("completeprofile"),e.city&&e.country&&(this.innerHTML=e.city+", "+e.country.toUpperCase()),e.city&&e.state&&e.country&&(this.innerHTML=e.city+", "+e.state.toUpperCase()+" "+e.country.toUpperCase())},setAge:function(e){var t,i,s=new Date;e&&3===e.length?(t=new Date(e[0],e[1],e[2]),i=s.getTime()-t.getTime(),this.innerHTML=Math.floor(i/1e3/3600/24/365)+" "+b.get("agelbl")):this.innerHTML=b.get("completeprofile")},setFamily:function(e){var t,i,s=e.couple,n=e.children;null===s?t=b.get("completeprofile"):0===s?t=b.get("singlelbl"):1===s?t=b.get("marriedlbl"):2===s?t=b.get("divorcedlbl"):3===s&&(t=b.get("widowlbl")),n&&0!==n?(i=h.get("age")<20?1===n?n+b.get("onesiblinglbl"):n+b.get("siblingslbl"):1===n?n+b.get("onechildlbl"):n+b.get("childrenlbl"),i=", "+i):i="",this.innerHTML=t+i},setOccupation:function(e){this.innerHTML=4===e.situation?b.get("stayathome"):3===e.situation?b.get("unemployed"):0===e.situation?e.organization?b.get("student")+" @ "+e.organization:b.get("student"):2===e.situation?e.job?e.job+" ("+b.get("retired")+")":b.get("retired"):1===e.situation?e.job||e.organization?e.job&&!e.organization?e.job:!e.job&&e.organization?b.get("active")+" @ "+e.organization:e.job+" @ "+e.organization:b.get("active"):b.get("completeprofile")},showLeisure:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setLeisure:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)t+=e[i].comment?"<li>"+e[i].name+" ("+e[i].comment+")</li>":"<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showInterests:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setInterests:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)t+=e[i].comment?"<li>"+e[i].name+" ("+e[i].comment+")</li>":"<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showSN:function(e){this.innerHTML=e?e:""},setSessionCount:function(){var e=h.get("su_sessions_count")||0,t=h.get("mu_sessions_count")||0;this.innerHTML=e+t},setContactCount:function(e){var t=0;for(i=0,l=e.length;l>i;i++)"user"===e[i].type&&t++;this.innerHTML=t},setBarLength:function(e){e>=3e5?this.setAttribute("style","width: 100%"):e>=3e4?this.setAttribute("style","width: 75%"):e>=3e3?this.setAttribute("style","width: 50%"):this.setAttribute("style","width: 25%")}}),news:new s(y,{setType:function(e){e.search("CX")>-1?this.setAttribute("style","background: url('img/profileDisable.png') no-repeat center center; background-size: contain;"):e.search("RWD")>-1||e.search("RANK")>-1?this.setAttribute("style","background: url('img/brainstorm/yourScore40.png') no-repeat center center; background-size: 40px;"):e.search("ID")>-1?this.setAttribute("style","background: url('img/libraryIdeaDisabled40.png') no-repeat center center; background-size: 40px;"):e.search("2Q")>-1?this.setAttribute("style","background: url('img/2questionDisable50.png') no-repeat center center; background-size: 40px;"):e.search("2CTS")>-1&&this.setAttribute("style","background: url('img/2centDisable.png') no-repeat center center; background-size: 40px;")},setContent:function(){var e=this.getAttribute("data-news_id");switch(y.get(e).type){case"CX+":this.innerHTML="<span class='newsinfo'>"+y.get(e).content.username+"</span>"+b.get("isnowacontact");break;case"CX-":this.innerHTML="<span class='newsinfo'>"+y.get(e).content.username+"</span>"+b.get("isnolongeracontact");break;case"IDEA+":this.innerHTML=b.get("enterednewidea")+"<span class='newsinfo'>"+y.get(e).content.title+"</span>";break;case"SHID":this.innerHTML=b.get("sharedanidea")+"("+"<span class='newsinfo'>"+y.get(e).content.title+"</span>)";break;case"RANK":this.innerHTML=b.get("reachedrank")+"<span class='newsinfo'>"+y.get(e).content.label+"</span>";break;case"RWD":this.innerHTML=b.get("gotaward")+"<span class='newsinfo'>"+y.get(e).content.label+"</span>";break;case"2Q+":this.innerHTML=b.get("posted2q")+"<span class='newsinfo'>"+y.get(e).content.question+"</span>";break;case"2CTS":this.innerHTML=b.get("commentedon")+"<span class='newsinfo'>"+y.get(e).content.title+"</span>"+b.get("by")+y.get("id").content.username}},formatDate:function(e){this.innerHTML=c.formatDate(e)}}),profileevent:new n(v)}),v.template='<div id="dashboard-profile"><div class="header blue-dark"><span data-label="bind:innerHTML, profilelbl"></span></div><input class="infoslider" type="range" min="0" max="1" value ="0" data-profileevent="listen:touchend, switchLeaderboard"><span class="slidertext" data-stats="bind:setViewLbl, view"></span><div id="profile-content" data-stats="bind:toggleInformation, view"><div class="leftprofile"><div class="userdetails"><div class="editbtn" data-profileevent="listen:touchstart, edit"></div><div class="cd-picarea"><div class="cardpicture" data-config="bind:setAvatar, avatar"></div><div class="cardinfo"><h2 data-user="bind:innerHTML,username"></h2><blockquote data-user="bind:innerHTML, intro"></blockquote><p><span class="cd-agelbl"></span><span data-user="bind:setAge, birthdate"></span></p><p><span class="cd-locationlbl"></span><span class="cd-info" data-user="bind: setLocation, address"></span></p><p><span class="cd-joblbl"></span><span class="cd-info" data-user="bind: setOccupation, occupation"></span></p><p><span class="cd-familylbl"></span><span class="cd-info" data-user="bind: setFamily, family"></span></p></div></div><div class="cd-contentarea"><div data-user="bind:showLeisure, leisure_activities"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl"></span><p class = "userinfo" data-user="bind:setLeisure, leisure_activities"></p></div><div data-user="bind:showInterests, interests"><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "userinfo" data-user="bind: setInterests, interests"></p></div><div data-stats="bind:showSocialNW, socialnw"><span class="contentTitle" data-label="bind: innerHTML, socialnwlbl"></span><p class = "userinfo fb" data-user="bind:showSN, facebook"></p><p class = "userinfo gp" data-user="bind:showSN, gplus; bind:innerHTML"></p><p class = "userinfo tw" data-user="bind:showSN, twitter"></p><p class = "userinfo lin" data-user="bind:showSN, linkedin"></p></div></div><div><legend data-stats="bind: setPercentage, completion"></legend><div class="completionbar"><div class="innerbar" data-stats = "bind:setProgress, completion"></div></div></div></div><div class="edituserdetails invisible"></div><div class="mystats"><legend data-label="bind:innerHTML, mystatslbl"></legend><div class="completionbar"><ul data-user="bind: setBarLength, ip"><li class="innerbar myids" data-progressbar="bind: setWidth, ideas"></li><li class="innerbar myss" data-progressbar="bind:setWidth, sessions"></li><li class="innerbar myctcts" data-progressbar="bind: setWidth, contacts"></li><li class="innerbar my2q" data-progressbar="bind:setWidth, twoQ"></li></ul></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-user="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-user="bind: setSessionCount, ip"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-user="bind: setContactCount, connections"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-user="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="recentactivity"><legend data-label="bind:innerHTML, recentactivitylbl"></legend><ul data-news="foreach"><li><div class="newstype" data-news="bind:setType, type"></div><div class="newsdate" data-news="bind:formatDate, date"></div><p class="newstext" data-news="bind:setContent, content"></p></li></ul></div></div><div class = "rightprofile"><div class="userscore"><span class="ip" data-user="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><div class="userachievements"><h2 class="grade" data-stats="bind:innerHTML, title"></h2><ul class="badges" data-grades="foreach"><li class="badge"><div data-grades="bind:showBadge, badge"></div><legend data-grades="bind:innerHTML, title"></legend></li></ul><ul class="badges" data-achievements="foreach"><li class="badge"><div data-achievements="bind:showBadge, badge"></div><legend data-achievements="bind:innerHTML, label"></legend></li></ul></div></div></div><div id="leaderboard" data-stats="bind:toggleLeaderboard, view"></div></div>',v.place(t.get("dashboard-profile")),v.switchLeaderboard=function(e,t){var i=document.getElementById("leaderboard");document.getElementById("profile-content"),p||(p=new o,p.init(i)),1==t.value?w.set("view","leaderboard"):w.set("view","info")},v.edit=function(){var e=document.querySelector(".edituserdetails");document.querySelector(".userdetails").classList.add("invisible"),g?g.reset():(g=new d,g.init(e)),e.classList.remove("invisible")},a.get("observer").watch("profile-updated",function(){v.checkProfileCompletion().then(function(){v.updateGrade(),v.updateAchievements()})}),h.watchValue("ip",function(){v.updateGrade(),v.updateProgressBar()}),h.watchValue("tutorial_complete",function(){v.updateGrade(),v.updateAchievements()}),h.watchValue("settings",function(){v.updateGrade(),v.updateAchievements()}),h.watchValue("news",function(){y.reset(h.get("news"))}),h.watchValue("lang",function(){v.updateGrade().then(function(){v.updateAchievements()}),y.reset([]),y.reset(h.get("news"))}),v.checkProfileCompletion=function(){var e=c.checkProfileCompletion(),t=new u;return w.set("completion",e.percentage),w.set("missing",e.missing),e.missing.indexOf(b.get("entersocialnw"))<0&&w.set("socialnw",1),100===e.percentage&&h.get("profile_complete")!==!0?(h.set("profile_complete",!0),h.upload().then(function(){t.fulfill()})):e.percentage<100&&h.get("profile_complete")?(h.set("profile_complete",!1),h.upload().then(function(){t.fulfill()})):t.fulfill(),t},v.updateGrade=function(){var e=new u;return c.getGrade(h.get("ip"),function(t){var i;i=t.distinction?[t.grade,t.distinction]:[t.grade],L.reset(i),w.set("title",t.grade.label),e.fulfill()}),e},v.updateAchievements=function(){var e=new u;return c.getAchievements(h.get("_id"),function(t){t.length?k.reset(t):k.reset(h.get("achievements")),e.fulfill()}),e},v.updateProgressBar=function(){var e,t,i,s,n,a,r,c,o;for(t=h.get("ideas_count"),s=h.get("su_sessions_count")||0,n=h.get("mu_sessions_count")||0,i=s+n,r=h.get("twoquestions_count")||0,a=0,c=0,o=h.get("connections").length;o>c;c++)"user"===h.get("connections")[c].type&&a++;e=t+r+a+i,m.set("total",e),m.set("ideas",Math.floor(100*(t/e))),m.set("contacts",Math.floor(100*(a/e))),m.set("sessions",Math.floor(100*(i/e))),m.set("twoQ",Math.floor(100*(r/e)))},v.cleanOldNews=function(){var e,t,i=new Date,s=h.get("news"),n=new u;if(s.length){for(e=s.length-1;e>=0;e--)t=new Date(s[e].date[0],s[e].date[1],s[e].date[2]),i.getTime()-t.getTime()>1296e6&&s.splice(e,1);h.set("news",s),h.upload().then(function(){n.fulfill()})}return n},v.init=function(){v.checkProfileCompletion().then(function(){return v.updateGrade()}).then(function(){return v.updateAchievements()}).then(function(){v.updateProgressBar(),v.cleanOldNews()})},v.reset=function(){y.reset([]),y.reset(h.get("news")),v.init()},v.init(),v}});