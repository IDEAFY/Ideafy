/*! Socket.IO.min.js build:0.9.10, production. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */

/**
 * https://github.com/flams/CouchDB-emily-tools
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

/**
 * @license Emily <VERSION> http://flams.github.com/emily
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

/**
 * Emily
 * Copyright(c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 * MIT Licensed
 */

/**
 * @license Olives <VERSION> http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

/**
 * Olives http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Olivier Wietrich <Olivier.Wietrich@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/*
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/* 
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Authors: Vincent Weyl <vincent.weyl@taiaut.com> - Olivier Wietrich <Olivier.Wietrich@taiaut.com
 * Copyright (c) 2012-2013 TAIAUT
 */

var io="undefined"==typeof module?{}:module.exports;(function(){(function(e,t){var n=e;n.version="0.9.10",n.protocol=1,n.transports=[],n.j=[],n.sockets={},n.connect=function(e,r){var i=n.util.parseUri(e),s,o;t&&t.location&&(i.protocol=i.protocol||t.location.protocol.slice(0,-1),i.host=i.host||(t.document?t.document.domain:t.location.hostname),i.port=i.port||t.location.port),s=n.util.uniqueUri(i);var u={host:i.host,secure:"https"==i.protocol,port:i.port||("https"==i.protocol?443:80),query:i.query||""};n.util.merge(u,r);if(u["force new connection"]||!n.sockets[s])o=new n.Socket(u);return!u["force new connection"]&&o&&(n.sockets[s]=o),o=o||n.sockets[s],o.of(i.path.length>1?i.path:"")}})("object"==typeof module?module.exports:this.io={},this),function(e,t){var n=e.util={},r=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];n.parseUri=function(e){var t=r.exec(e||""),n={},s=14;while(s--)n[i[s]]=t[s]||"";return n},n.uniqueUri=function(e){var n=e.protocol,r=e.host,i=e.port;return"document"in t?(r=r||document.domain,i=i||(n=="https"&&document.location.protocol!=="https:"?443:document.location.port)):(r=r||"localhost",!i&&n=="https"&&(i=443)),(n||"http")+"://"+r+":"+(i||80)},n.query=function(e,t){var r=n.chunkQuery(e||""),i=[];n.merge(r,n.chunkQuery(t||""));for(var s in r)r.hasOwnProperty(s)&&i.push(s+"="+r[s]);return i.length?"?"+i.join("&"):""},n.chunkQuery=function(e){var t={},n=e.split("&"),r=0,i=n.length,s;for(;r<i;++r)s=n[r].split("="),s[0]&&(t[s[0]]=s[1]);return t};var s=!1;n.load=function(e){if("document"in t&&document.readyState==="complete"||s)return e();n.on(t,"load",e,!1)},n.on=function(e,t,n,r){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener&&e.addEventListener(t,n,r)},n.request=function(e){if(e&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!e||n.ua.hasCORS))return new XMLHttpRequest;if(!e)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}return null},"undefined"!=typeof window&&n.load(function(){s=!0}),n.defer=function(e){if(!n.ua.webkit||"undefined"!=typeof importScripts)return e();n.load(function(){setTimeout(e,100)})},n.merge=function(e,t,r,i){var s=i||[],o=typeof r=="undefined"?2:r,u;for(u in t)t.hasOwnProperty(u)&&n.indexOf(s,u)<0&&(typeof e[u]!="object"||!o?(e[u]=t[u],s.push(t[u])):n.merge(e[u],t[u],o-1,s));return e},n.mixin=function(e,t){n.merge(e.prototype,t.prototype)},n.inherit=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n},n.isArray=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},n.intersect=function(e,t){var r=[],i=e.length>t.length?e:t,s=e.length>t.length?t:e;for(var o=0,u=s.length;o<u;o++)~n.indexOf(i,s[o])&&r.push(s[o]);return r},n.indexOf=function(e,t,n){for(var r=e.length,n=n<0?n+r<0?0:n+r:n||0;n<r&&e[n]!==t;n++);return r<=n?-1:n},n.toArray=function(e){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(e[n]);return t},n.ua={},n.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var e=new XMLHttpRequest}catch(t){return!1}return e.withCredentials!=undefined}(),n.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),n.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(e,t){function n(){}e.EventEmitter=n,n.prototype.on=function(e,n){return this.$events||(this.$events={}),this.$events[e]?t.util.isArray(this.$events[e])?this.$events[e].push(n):this.$events[e]=[this.$events[e],n]:this.$events[e]=n,this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(e,t){function n(){r.removeListener(e,n),t.apply(this,arguments)}var r=this;return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,n){if(this.$events&&this.$events[e]){var r=this.$events[e];if(t.util.isArray(r)){var i=-1;for(var s=0,o=r.length;s<o;s++)if(r[s]===n||r[s].listener&&r[s].listener===n){i=s;break}if(i<0)return this;r.splice(i,1),r.length||delete this.$events[e]}else(r===n||r.listener&&r.listener===n)&&delete this.$events[e]}return this},n.prototype.removeAllListeners=function(e){return e===undefined?(this.$events={},this):(this.$events&&this.$events[e]&&(this.$events[e]=null),this)},n.prototype.listeners=function(e){return this.$events||(this.$events={}),this.$events[e]||(this.$events[e]=[]),t.util.isArray(this.$events[e])||(this.$events[e]=[this.$events[e]]),this.$events[e]},n.prototype.emit=function(e){if(!this.$events)return!1;var n=this.$events[e];if(!n)return!1;var r=Array.prototype.slice.call(arguments,1);if("function"==typeof n)n.apply(this,r);else{if(!t.util.isArray(n))return!1;var i=n.slice();for(var s=0,o=i.length;s<o;s++)i[s].apply(this,r)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){function f(e){return e<10?"0"+e:e}function date(e,t){return isFinite(e.valueOf())?e.getUTCFullYear()+"-"+f(e.getUTCMonth()+1)+"-"+f(e.getUTCDate())+"T"+f(e.getUTCHours())+":"+f(e.getUTCMinutes())+":"+f(e.getUTCSeconds())+"Z":null}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a instanceof Date&&(a=date(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")},JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,typeof JSON!="undefined"?JSON:undefined),function(e,t){var n=e.parser={},r=n.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],i=n.reasons=["transport not supported","client not handshaken","unauthorized"],s=n.advice=["reconnect"],o=t.JSON,u=t.util.indexOf;n.encodePacket=function(e){var t=u(r,e.type),n=e.id||"",a=e.endpoint||"",l=e.ack,c=null;switch(e.type){case"error":var p=e.reason?u(i,e.reason):"",v=e.advice?u(s,e.advice):"";if(p!==""||v!=="")c=p+(v!==""?"+"+v:"");break;case"message":e.data!==""&&(c=e.data);break;case"event":var m={name:e.name};e.args&&e.args.length&&(m.args=e.args),c=o.stringify(m);break;case"json":c=o.stringify(e.data);break;case"connect":e.qs&&(c=e.qs);break;case"ack":c=e.ackId+(e.args&&e.args.length?"+"+o.stringify(e.args):"")}var y=[t,n+(l=="data"?"+":""),a];return c!==null&&c!==undefined&&y.push(c),y.join(":")},n.encodePayload=function(e){var t="";if(e.length==1)return e[0];for(var n=0,r=e.length;n<r;n++){var i=e[n];t+="�"+i.length+"�"+e[n]}return t};var a=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;n.decodePacket=function(e){var t=e.match(a);if(!t)return{};var n=t[2]||"",e=t[5]||"",u={type:r[t[1]],endpoint:t[4]||""};n&&(u.id=n,t[3]?u.ack="data":u.ack=!0);switch(u.type){case"error":var t=e.split("+");u.reason=i[t[0]]||"",u.advice=s[t[1]]||"";break;case"message":u.data=e||"";break;case"event":try{var l=o.parse(e);u.name=l.name,u.args=l.args}catch(c){}u.args=u.args||[];break;case"json":try{u.data=o.parse(e)}catch(c){}break;case"connect":u.qs=e||"";break;case"ack":var t=e.match(/^([0-9]+)(\+)?(.*)/);if(t){u.ackId=t[1],u.args=[];if(t[3])try{u.args=t[3]?o.parse(t[3]):[]}catch(c){}}break;case"disconnect":case"heartbeat":}return u},n.decodePayload=function(e){if(e.charAt(0)=="�"){var t=[];for(var r=1,i="";r<e.length;r++)e.charAt(r)=="�"?(t.push(n.decodePacket(e.substr(r+1).substr(0,i))),r+=Number(i)+1,i=""):i+=e.charAt(r);return t}return[n.decodePacket(e)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t){function n(e,t){this.socket=e,this.sessid=t}e.Transport=n,t.util.mixin(n,t.EventEmitter),n.prototype.heartbeats=function(){return!0},n.prototype.onData=function(e){this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout();if(e!==""){var n=t.parser.decodePayload(e);if(n&&n.length)for(var r=0,i=n.length;r<i;r++)this.onPacket(n[r])}return this},n.prototype.onPacket=function(e){return this.socket.setHeartbeatTimeout(),e.type=="heartbeat"?this.onHeartbeat():(e.type=="connect"&&e.endpoint==""&&this.onConnect(),e.type=="error"&&e.advice=="reconnect"&&(this.isOpen=!1),this.socket.onPacket(e),this)},n.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var e=this;this.closeTimeout=setTimeout(function(){e.onDisconnect()},this.socket.closeTimeout)}},n.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},n.prototype.onConnect=function(){return this.socket.onConnect(),this},n.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},n.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},n.prototype.packet=function(e){this.send(t.parser.encodePacket(e))},n.prototype.onHeartbeat=function(e){this.packet({type:"heartbeat"})},n.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},n.prototype.onClose=function(){var e=this;this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},n.prototype.prepareUrl=function(){var e=this.socket.options;return this.scheme()+"://"+e.host+":"+e.port+"/"+e.resource+"/"+t.protocol+"/"+this.name+"/"+this.sessid},n.prototype.ready=function(e,t){t.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(e){this.options={port:80,secure:!1,document:"document"in n?document:!1,resource:"socket.io",transports:t.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},t.util.merge(this.options,e),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||t.util.ua.hasCORS)){var r=this;t.util.on(n,"beforeunload",function(){r.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function i(){}e.Socket=r,t.util.mixin(r,t.EventEmitter),r.prototype.of=function(e){return this.namespaces[e]||(this.namespaces[e]=new t.SocketNamespace(this,e),e!==""&&this.namespaces[e].packet({type:"connect"})),this.namespaces[e]},r.prototype.publish=function(){this.emit.apply(this,arguments);var e;for(var t in this.namespaces)this.namespaces.hasOwnProperty(t)&&(e=this.of(t),e.$emit.apply(e,arguments))},r.prototype.handshake=function(e){function n(t){t instanceof Error?(r.connecting=!1,r.onError(t.message)):e.apply(null,t.split(":"))}var r=this,s=this.options,o=["http"+(s.secure?"s":"")+":/",s.host+":"+s.port,s.resource,t.protocol,t.util.query(this.options.query,"t="+ +(new Date))].join("/");if(this.isXDomain()&&!t.util.ua.hasCORS){var u=document.getElementsByTagName("script")[0],a=document.createElement("script");a.src=o+"&jsonp="+t.j.length,u.parentNode.insertBefore(a,u),t.j.push(function(e){n(e),a.parentNode.removeChild(a)})}else{var f=t.util.request();f.open("GET",o,!0),this.isXDomain()&&(f.withCredentials=!0),f.onreadystatechange=function(){f.readyState==4&&(f.onreadystatechange=i,f.status==200?n(f.responseText):f.status==403?r.onError(f.responseText):(r.connecting=!1,!r.reconnecting&&r.onError(f.responseText)))},f.send(null)}},r.prototype.getTransport=function(e){var n=e||this.transports,r;for(var i=0,s;s=n[i];i++)if(t.Transport[s]&&t.Transport[s].check(this)&&(!this.isXDomain()||t.Transport[s].xdomainCheck(this)))return new t.Transport[s](this,this.sessionid);return null},r.prototype.connect=function(e){if(this.connecting)return this;var n=this;return n.connecting=!0,this.handshake(function(r,i,s,o){function u(e){n.transport&&n.transport.clearTimeouts(),n.transport=n.getTransport(e);if(!n.transport)return n.publish("connect_failed");n.transport.ready(n,function(){n.connecting=!0,n.publish("connecting",n.transport.name),n.transport.open(),n.options["connect timeout"]&&(n.connectTimeoutTimer=setTimeout(function(){if(!n.connected){n.connecting=!1;if(n.options["try multiple transports"]){var e=n.transports;while(e.length>0&&e.splice(0,1)[0]!=n.transport.name);e.length?u(e):n.publish("connect_failed")}}},n.options["connect timeout"]))})}n.sessionid=r,n.closeTimeout=s*1e3,n.heartbeatTimeout=i*1e3,n.transports||(n.transports=n.origTransports=o?t.util.intersect(o.split(","),n.options.transports):n.options.transports),n.setHeartbeatTimeout(),u(n.transports),n.once("connect",function(){clearTimeout(n.connectTimeoutTimer),e&&typeof e=="function"&&e()})}),this},r.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);if(this.transport&&!this.transport.heartbeats())return;var e=this;this.heartbeatTimeoutTimer=setTimeout(function(){e.transport.onClose()},this.heartbeatTimeout)},r.prototype.packet=function(e){return this.connected&&!this.doBuffer?this.transport.packet(e):this.buffer.push(e),this},r.prototype.setBuffer=function(e){this.doBuffer=e,!e&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},r.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},r.prototype.disconnect=function(){if(this.connected||this.connecting)this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted");return this},r.prototype.disconnectSync=function(){var e=t.util.request(),n=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,t.protocol,"",this.sessionid].join("/")+"/?disconnect=1";e.open("GET",n,!1),e.send(null),this.onDisconnect("booted")},r.prototype.isXDomain=function(){var e=n.location.port||("https:"==n.location.protocol?443:80);return this.options.host!==n.location.hostname||this.options.port!=e},r.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},r.prototype.onOpen=function(){this.open=!0},r.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},r.prototype.onPacket=function(e){this.of(e.endpoint).onPacket(e)},r.prototype.onError=function(e){e&&e.advice&&e.advice==="reconnect"&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",e&&e.reason?e.reason:e)},r.prototype.onDisconnect=function(e){var t=this.connected,n=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1;if(t||n)this.transport.close(),this.transport.clearTimeouts(),t&&(this.publish("disconnect",e),"booted"!=e&&this.options.reconnect&&!this.reconnecting&&this.reconnect())},r.prototype.reconnect=function(){function e(){if(n.connected){for(var e in n.namespaces)n.namespaces.hasOwnProperty(e)&&""!==e&&n.namespaces[e].packet({type:"connect"});n.publish("reconnect",n.transport.name,n.reconnectionAttempts)}clearTimeout(n.reconnectionTimer),n.removeListener("connect_failed",t),n.removeListener("connect",t),n.reconnecting=!1,delete n.reconnectionAttempts,delete n.reconnectionDelay,delete n.reconnectionTimer,delete n.redoTransports,n.options["try multiple transports"]=i}function t(){if(!n.reconnecting)return;if(n.connected)return e();if(n.connecting&&n.reconnecting)return n.reconnectionTimer=setTimeout(t,1e3);n.reconnectionAttempts++>=r?n.redoTransports?(n.publish("reconnect_failed"),e()):(n.on("connect_failed",t),n.options["try multiple transports"]=!0,n.transports=n.origTransports,n.transport=n.getTransport(),n.redoTransports=!0,n.connect()):(n.reconnectionDelay<s&&(n.reconnectionDelay*=2),n.connect(),n.publish("reconnecting",n.reconnectionDelay,n.reconnectionAttempts),n.reconnectionTimer=setTimeout(t,n.reconnectionDelay))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var n=this,r=this.options["max reconnection attempts"],i=this.options["try multiple transports"],s=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(t,this.reconnectionDelay),this.on("connect",t)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(e,t){this.socket=e,this.name=t||"",this.flags={},this.json=new r(this,"json"),this.ackPackets=0,this.acks={}}function r(e,t){this.namespace=e,this.name=t}e.SocketNamespace=n,t.util.mixin(n,t.EventEmitter),n.prototype.$emit=t.EventEmitter.prototype.emit,n.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},n.prototype.packet=function(e){return e.endpoint=this.name,this.socket.packet(e),this.flags={},this},n.prototype.send=function(e,t){var n={type:this.flags.json?"json":"message",data:e};return"function"==typeof t&&(n.id=++this.ackPackets,n.ack=!0,this.acks[n.id]=t),this.packet(n)},n.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1),n=t[t.length-1],r={type:"event",name:e};return"function"==typeof n&&(r.id=++this.ackPackets,r.ack="data",this.acks[r.id]=n,t=t.slice(0,t.length-1)),r.args=t,this.packet(r)},n.prototype.disconnect=function(){return this.name===""?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},n.prototype.onPacket=function(e){function n(){r.packet({type:"ack",args:t.util.toArray(arguments),ackId:e.id})}var r=this;switch(e.type){case"connect":this.$emit("connect");break;case"disconnect":this.name===""?this.socket.onDisconnect(e.reason||"booted"):this.$emit("disconnect",e.reason);break;case"message":case"json":var i=["message",e.data];e.ack=="data"?i.push(n):e.ack&&this.packet({type:"ack",ackId:e.id}),this.$emit.apply(this,i);break;case"event":var i=[e.name].concat(e.args);e.ack=="data"&&i.push(n),this.$emit.apply(this,i);break;case"ack":this.acks[e.ackId]&&(this.acks[e.ackId].apply(this,e.args),delete this.acks[e.ackId]);break;case"error":e.advice?this.socket.onError(e):e.reason=="unauthorized"?this.$emit("connect_failed",e.reason):this.$emit("error",e.reason)}},r.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},r.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(e){t.Transport.apply(this,arguments)}e.websocket=r,t.util.inherit(r,t.Transport),r.prototype.name="websocket",r.prototype.open=function(){var e=t.util.query(this.socket.options.query),r=this,i;return i||(i=n.MozWebSocket||n.WebSocket),this.websocket=new i(this.prepareUrl()+e),this.websocket.onopen=function(){r.onOpen(),r.socket.setBuffer(!1)},this.websocket.onmessage=function(e){r.onData(e.data)},this.websocket.onclose=function(){r.onClose(),r.socket.setBuffer(!0)},this.websocket.onerror=function(e){r.onError(e)},this},t.util.ua.iDevice?r.prototype.send=function(e){var t=this;return setTimeout(function(){t.websocket.send(e)},0),this}:r.prototype.send=function(e){return this.websocket.send(e),this},r.prototype.payload=function(e){for(var t=0,n=e.length;t<n;t++)this.packet(e[t]);return this},r.prototype.close=function(){return this.websocket.close(),this},r.prototype.onError=function(e){this.socket.onError(e)},r.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},r.check=function(){return"WebSocket"in n&&!("__addTask"in WebSocket)||"MozWebSocket"in n},r.xdomainCheck=function(){return!0},t.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(){t.Transport.websocket.apply(this,arguments)}e.flashsocket=n,t.util.inherit(n,t.Transport.websocket),n.prototype.name="flashsocket",n.prototype.open=function(){var e=this,n=arguments;return WebSocket.__addTask(function(){t.Transport.websocket.prototype.open.apply(e,n)}),this},n.prototype.send=function(){var e=this,n=arguments;return WebSocket.__addTask(function(){t.Transport.websocket.prototype.send.apply(e,n)}),this},n.prototype.close=function(){return WebSocket.__tasks.length=0,t.Transport.websocket.prototype.close.call(this),this},n.prototype.ready=function(e,r){function i(){var t=e.options,i=t["flash policy port"],o=["http"+(t.secure?"s":"")+":/",t.host+":"+t.port,t.resource,"static/flashsocket","WebSocketMain"+(e.isXDomain()?"Insecure":"")+".swf"];n.loaded||(typeof WEB_SOCKET_SWF_LOCATION=="undefined"&&(WEB_SOCKET_SWF_LOCATION=o.join("/")),i!==843&&WebSocket.loadFlashPolicyFile("xmlsocket://"+t.host+":"+i),WebSocket.__initialize(),n.loaded=!0),r.call(s)}var s=this;if(document.body)return i();t.util.load(i)},n.check=function(){return typeof WebSocket!="undefined"&&"__initialize"in WebSocket&&!!swfobject?swfobject.getFlashPlayerVersion().major>=10:!1},n.xdomainCheck=function(){return!0},typeof window!="undefined"&&(WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0),t.transports.push("flashsocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window)var swfobject=function(){function e(){if(R)return;try{var e=O.getElementsByTagName("body")[0].appendChild(m("span"));e.parentNode.removeChild(e)}catch(t){return}R=!0;var n=D.length;for(var r=0;r<n;r++)D[r]()}function t(e){R?e():D[D.length]=e}function n(e){if(typeof A.addEventListener!=S)A.addEventListener("load",e,!1);else if(typeof O.addEventListener!=S)O.addEventListener("load",e,!1);else if(typeof A.attachEvent!=S)g(A,"onload",e);else if(typeof A.onload=="function"){var t=A.onload;A.onload=function(){t(),e()}}else A.onload=e}function r(){_?i():s()}function i(){var e=O.getElementsByTagName("body")[0],t=m(x);t.setAttribute("type",C);var n=e.appendChild(t);if(n){var r=0;(function(){if(typeof n.GetVariable!=S){var i=n.GetVariable("$version");i&&(i=i.split(" ")[1].split(","),V.pv=[parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10)])}else if(r<10){r++,setTimeout(arguments.callee,10);return}e.removeChild(t),n=null,s()})()}else s()}function s(){var e=P.length;if(e>0)for(var t=0;t<e;t++){var n=P[t].id,r=P[t].callbackFn,i={success:!1,id:n};if(V.pv[0]>0){var s=v(n);if(s)if(y(P[t].swfVersion)&&!(V.wk&&V.wk<312))w(n,!0),r&&(i.success=!0,i.ref=o(n),r(i));else if(P[t].expressInstall&&u()){var l={};l.data=P[t].expressInstall,l.width=s.getAttribute("width")||"0",l.height=s.getAttribute("height")||"0",s.getAttribute("class")&&(l.styleclass=s.getAttribute("class")),s.getAttribute("align")&&(l.align=s.getAttribute("align"));var c={},h=s.getElementsByTagName("param"),p=h.length;for(var d=0;d<p;d++)h[d].getAttribute("name").toLowerCase()!="movie"&&(c[h[d].getAttribute("name")]=h[d].getAttribute("value"));a(l,c,n,r)}else f(s),r&&r(i)}else{w(n,!0);if(r){var m=o(n);m&&typeof m.SetVariable!=S&&(i.success=!0,i.ref=m),r(i)}}}}function o(e){var t=null,n=v(e);if(n&&n.nodeName=="OBJECT")if(typeof n.SetVariable!=S)t=n;else{var r=n.getElementsByTagName(x)[0];r&&(t=r)}return t}function u(){return!U&&y("6.0.65")&&(V.win||V.mac)&&!(V.wk&&V.wk<312)}function a(e,t,n,r){U=!0,I=r||null,q={success:!1,id:n};var i=v(n);if(i){i.nodeName=="OBJECT"?(j=l(i),F=null):(j=i,F=n),e.id=k;if(typeof e.width==S||!/%$/.test(e.width)&&parseInt(e.width,10)<310)e.width="310";if(typeof e.height==S||!/%$/.test(e.height)&&parseInt(e.height,10)<137)e.height="137";O.title=O.title.slice(0,47)+" - Flash Player Installation";var s=V.ie&&V.win?["Active"].concat("").join("X"):"PlugIn",o="MMredirectURL="+A.location.toString().replace(/&/g,"%26")+"&MMplayerType="+s+"&MMdoctitle="+O.title;typeof t.flashvars!=S?t.flashvars+="&"+o:t.flashvars=o;if(V.ie&&V.win&&i.readyState!=4){var u=m("div");n+="SWFObjectNew",u.setAttribute("id",n),i.parentNode.insertBefore(u,i),i.style.display="none",function(){i.readyState==4?i.parentNode.removeChild(i):setTimeout(arguments.callee,10)}()}c(e,t,n)}}function f(e){if(V.ie&&V.win&&e.readyState!=4){var t=m("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(l(e),t),e.style.display="none",function(){e.readyState==4?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(l(e),e)}function l(e){var t=m("div");if(V.win&&V.ie)t.innerHTML=e.innerHTML;else{var n=e.getElementsByTagName(x)[0];if(n){var r=n.childNodes;if(r){var i=r.length;for(var s=0;s<i;s++)(r[s].nodeType!=1||r[s].nodeName!="PARAM")&&r[s].nodeType!=8&&t.appendChild(r[s].cloneNode(!0))}}}return t}function c(e,t,n){var r,i=v(n);if(V.wk&&V.wk<312)return r;if(i){typeof e.id==S&&(e.id=n);if(V.ie&&V.win){var s="";for(var o in e)e[o]!=Object.prototype[o]&&(o.toLowerCase()=="data"?t.movie=e[o]:o.toLowerCase()=="styleclass"?s+=' class="'+e[o]+'"':o.toLowerCase()!="classid"&&(s+=" "+o+'="'+e[o]+'"'));var u="";for(var a in t)t[a]!=Object.prototype[a]&&(u+='<param name="'+a+'" value="'+t[a]+'" />');i.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+s+">"+u+"</object>",H[H.length]=e.id,r=v(e.id)}else{var f=m(x);f.setAttribute("type",C);for(var l in e)e[l]!=Object.prototype[l]&&(l.toLowerCase()=="styleclass"?f.setAttribute("class",e[l]):l.toLowerCase()!="classid"&&f.setAttribute(l,e[l]));for(var c in t)t[c]!=Object.prototype[c]&&c.toLowerCase()!="movie"&&h(f,c,t[c]);i.parentNode.replaceChild(f,i),r=f}}return r}function h(e,t,n){var r=m("param");r.setAttribute("name",t),r.setAttribute("value",n),e.appendChild(r)}function p(e){var t=v(e);t&&t.nodeName=="OBJECT"&&(V.ie&&V.win?(t.style.display="none",function(){t.readyState==4?d(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function d(e){var t=v(e);if(t){for(var n in t)typeof t[n]=="function"&&(t[n]=null);t.parentNode.removeChild(t)}}function v(e){var t=null;try{t=O.getElementById(e)}catch(n){}return t}function m(e){return O.createElement(e)}function g(e,t,n){e.attachEvent(t,n),B[B.length]=[e,t,n]}function y(e){var t=V.pv,n=e.split(".");return n[0]=parseInt(n[0],10),n[1]=parseInt(n[1],10)||0,n[2]=parseInt(n[2],10)||0,t[0]>n[0]||t[0]==n[0]&&t[1]>n[1]||t[0]==n[0]&&t[1]==n[1]&&t[2]>=n[2]?!0:!1}function b(e,t,n,r){if(V.ie&&V.mac)return;var i=O.getElementsByTagName("head")[0];if(!i)return;var s=n&&typeof n=="string"?n:"screen";r&&(z=null,W=null);if(!z||W!=s){var o=m("style");o.setAttribute("type","text/css"),o.setAttribute("media",s),z=i.appendChild(o),V.ie&&V.win&&typeof O.styleSheets!=S&&O.styleSheets.length>0&&(z=O.styleSheets[O.styleSheets.length-1]),W=s}V.ie&&V.win?z&&typeof z.addRule==x&&z.addRule(e,t):z&&typeof O.createTextNode!=S&&z.appendChild(O.createTextNode(e+" {"+t+"}"))}function w(e,t){if(!X)return;var n=t?"visible":"hidden";R&&v(e)?v(e).style.visibility=n:b("#"+e,"visibility:"+n)}function E(e){var t=/[\\\"<>\.;]/,n=t.exec(e)!=null;return n&&typeof encodeURIComponent!=S?encodeURIComponent(e):e}var S="undefined",x="object",T="Shockwave Flash",N="ShockwaveFlash.ShockwaveFlash",C="application/x-shockwave-flash",k="SWFObjectExprInst",L="onreadystatechange",A=window,O=document,M=navigator,_=!1,D=[r],P=[],H=[],B=[],j,F,I,q,R=!1,U=!1,z,W,X=!0,V=function(){var e=typeof O.getElementById!=S&&typeof O.getElementsByTagName!=S&&typeof O.createElement!=S,t=M.userAgent.toLowerCase(),n=M.platform.toLowerCase(),r=n?/win/.test(n):/win/.test(t),i=n?/mac/.test(n):/mac/.test(t),s=/webkit/.test(t)?parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,o=!1,u=[0,0,0],a=null;if(typeof M.plugins!=S&&typeof M.plugins[T]==x)a=M.plugins[T].description,a&&(typeof M.mimeTypes==S||!M.mimeTypes[C]||!!M.mimeTypes[C].enabledPlugin)&&(_=!0,o=!1,a=a.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),u[0]=parseInt(a.replace(/^(.*)\..*$/,"$1"),10),u[1]=parseInt(a.replace(/^.*\.(.*)\s.*$/,"$1"),10),u[2]=/[a-zA-Z]/.test(a)?parseInt(a.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof A[["Active"].concat("Object").join("X")]!=S)try{var f=new(window[["Active"].concat("Object").join("X")])(N);f&&(a=f.GetVariable("$version"),a&&(o=!0,a=a.split(" ")[1].split(","),u=[parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10)]))}catch(l){}return{w3:e,pv:u,wk:s,ie:o,win:r,mac:i}}(),$=function(){if(!V.w3)return;(typeof O.readyState!=S&&O.readyState=="complete"||typeof O.readyState==S&&(O.getElementsByTagName("body")[0]||O.body))&&e(),R||(typeof O.addEventListener!=S&&O.addEventListener("DOMContentLoaded",e,!1),V.ie&&V.win&&(O.attachEvent(L,function(){O.readyState=="complete"&&(O.detachEvent(L,arguments.callee),e())}),A==top&&function(){if(R)return;try{O.documentElement.doScroll("left")}catch(t){setTimeout(arguments.callee,0);return}e()}()),V.wk&&function(){if(R)return;if(!/loaded|complete/.test(O.readyState)){setTimeout(arguments.callee,0);return}e()}(),n(e))}(),J=function(){V.ie&&V.win&&window.attachEvent("onunload",function(){var e=B.length;for(var t=0;t<e;t++)B[t][0].detachEvent(B[t][1],B[t][2]);var n=H.length;for(var r=0;r<n;r++)p(H[r]);for(var i in V)V[i]=null;V=null;for(var s in swfobject)swfobject[s]=null;swfobject=null})}();return{registerObject:function(e,t,n,r){if(V.w3&&e&&t){var i={};i.id=e,i.swfVersion=t,i.expressInstall=n,i.callbackFn=r,P[P.length]=i,w(e,!1)}else r&&r({success:!1,id:e})},getObjectById:function(e){if(V.w3)return o(e)},embedSWF:function(e,n,r,i,s,o,f,l,h,p){var d={success:!1,id:n};V.w3&&!(V.wk&&V.wk<312)&&e&&n&&r&&i&&s?(w(n,!1),t(function(){r+="",i+="";var t={};if(h&&typeof h===x)for(var v in h)t[v]=h[v];t.data=e,t.width=r,t.height=i;var m={};if(l&&typeof l===x)for(var g in l)m[g]=l[g];if(f&&typeof f===x)for(var b in f)typeof m.flashvars!=S?m.flashvars+="&"+b+"="+f[b]:m.flashvars=b+"="+f[b];if(y(s)){var E=c(t,m,n);t.id==n&&w(n,!0),d.success=!0,d.ref=E}else{if(o&&u()){t.data=o,a(t,m,n,p);return}w(n,!0)}p&&p(d)})):p&&p(d)},switchOffAutoHideShow:function(){X=!1},ua:V,getFlashPlayerVersion:function(){return{major:V.pv[0],minor:V.pv[1],release:V.pv[2]}},hasFlashPlayerVersion:y,createSWF:function(e,t,n){return V.w3?c(e,t,n):undefined},showExpressInstall:function(e,t,n,r){V.w3&&u()&&a(e,t,n,r)},removeSWF:function(e){V.w3&&p(e)},createCSS:function(e,t,n,r){V.w3&&b(e,t,n,r)},addDomLoadEvent:t,addLoadEvent:n,getQueryParamValue:function(e){var t=O.location.search||O.location.hash;if(t){/\?/.test(t)&&(t=t.split("?")[1]);if(e==null)return E(t);var n=t.split("&");for(var r=0;r<n.length;r++)if(n[r].substring(0,n[r].indexOf("="))==e)return E(n[r].substring(n[r].indexOf("=")+1))}return""},expressInstallCallback:function(){if(U){var e=v(k);e&&j&&(e.parentNode.replaceChild(j,e),F&&(w(F,!0),V.ie&&V.win&&(j.style.display="block")),I&&I(q)),U=!1}}}}();(function(){if("undefined"==typeof window||window.WebSocket)return;var e=window.console;if(!e||!e.log||!e.error)e={log:function(){},error:function(){}};if(!swfobject.hasFlashPlayerVersion("10.0.0")){e.error("Flash Player >= 10.0.0 is required.");return}location.protocol=="file:"&&e.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(e,t,n,r,i){var s=this;s.__id=WebSocket.__nextId++,WebSocket.__instances[s.__id]=s,s.readyState=WebSocket.CONNECTING,s.bufferedAmount=0,s.__events={},t?typeof t=="string"&&(t=[t]):t=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(s.__id,e,t,n||null,r||0,i||null)})},0)},WebSocket.prototype.send=function(e){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var t=WebSocket.__flash.send(this.__id,encodeURIComponent(e));return t<0?!0:(this.bufferedAmount+=t,!1)},WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING)return;this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id)},WebSocket.prototype.addEventListener=function(e,t,n){e in this.__events||(this.__events[e]=[]),this.__events[e].push(t)},WebSocket.prototype.removeEventListener=function(e,t,n){if(!(e in this.__events))return;var r=this.__events[e];for(var i=r.length-1;i>=0;--i)if(r[i]===t){r.splice(i,1);break}},WebSocket.prototype.dispatchEvent=function(e){var t=this.__events[e.type]||[];for(var n=0;n<t.length;++n)t[n](e);var r=this["on"+e.type];r&&r(e)},WebSocket.prototype.__handleEvent=function(e){"readyState"in e&&(this.readyState=e.readyState),"protocol"in e&&(this.protocol=e.protocol);var t;if(e.type=="open"||e.type=="error")t=this.__createSimpleEvent(e.type);else if(e.type=="close")t=this.__createSimpleEvent("close");else{if(e.type!="message")throw"unknown event type: "+e.type;var n=decodeURIComponent(e.message);t=this.__createMessageEvent("message",n)}this.dispatchEvent(t)},WebSocket.prototype.__createSimpleEvent=function(e){if(document.createEvent&&window.Event){var t=document.createEvent("Event");return t.initEvent(e,!1,!1),t}return{type:e,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(e,t){if(document.createEvent&&window.MessageEvent&&!window.opera){var n=document.createEvent("MessageEvent");return n.initMessageEvent("message",!1,!1,t,null,null,window,null),n}return{type:e,data:t,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(e){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(e)})},WebSocket.__initialize=function(){if(WebSocket.__flash)return;WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation);if(!window.WEB_SOCKET_SWF_LOCATION){e.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var t=document.createElement("div");t.id="webSocketContainer",t.style.position="absolute",WebSocket.__isFlashLite()?(t.style.left="0px",t.style.top="0px"):(t.style.left="-100px",t.style.top="-100px");var n=document.createElement("div");n.id="webSocketFlash",t.appendChild(n),document.body.appendChild(t),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(t){t.success||e.error("[WebSocket] swfobject.embedSWF failed")})},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var e=0;e<WebSocket.__tasks.length;++e)WebSocket.__tasks[e]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{var t=WebSocket.__flash.receiveEvents();for(var n=0;n<t.length;++n)WebSocket.__instances[t[n].webSocketId].__handleEvent(t[n])}catch(r){e.error(r)}},0),!0},WebSocket.__log=function(t){e.log(decodeURIComponent(t))},WebSocket.__error=function(t){e.error(decodeURIComponent(t))},WebSocket.__addTask=function(e){WebSocket.__flash?e():WebSocket.__tasks.push(e)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var e=window.navigator.mimeTypes["application/x-shockwave-flash"];return!e||!e.enabledPlugin||!e.enabledPlugin.filename?!1:e.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))})(),function(e,t,n){function r(e){if(!e)return;t.Transport.apply(this,arguments),this.sendBuffer=[]}function i(){}e.XHR=r,t.util.inherit(r,t.Transport),r.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},r.prototype.payload=function(e){var n=[];for(var r=0,i=e.length;r<i;r++)n.push(t.parser.encodePacket(e[r]));this.send(t.parser.encodePayload(n))},r.prototype.send=function(e){return this.post(e),this},r.prototype.post=function(e){function t(){this.readyState==4&&(this.onreadystatechange=i,s.posting=!1,this.status==200?s.socket.setBuffer(!1):s.onClose())}function r(){this.onload=i,s.socket.setBuffer(!1)}var s=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),n.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=r:this.sendXHR.onreadystatechange=t,this.sendXHR.send(e)},r.prototype.close=function(){return this.onClose(),this},r.prototype.request=function(e){var n=t.util.request(this.socket.isXDomain()),r=t.util.query(this.socket.options.query,"t="+ +(new Date));n.open(e||"GET",this.prepareUrl()+r,!0);if(e=="POST")try{n.setRequestHeader?n.setRequestHeader("Content-type","text/plain;charset=UTF-8"):n.contentType="text/plain"}catch(i){}return n},r.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},r.check=function(e,r){try{var i=t.util.request(r),s=n.XDomainRequest&&i instanceof XDomainRequest,o=e&&e.options&&e.options.secure?"https:":"http:",u=o!=n.location.protocol;if(i&&(!s||!u))return!0}catch(a){}return!1},r.xdomainCheck=function(e){return r.check(e,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(e){t.Transport.XHR.apply(this,arguments)}e.htmlfile=n,t.util.inherit(n,t.Transport.XHR),n.prototype.name="htmlfile",n.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var e=this.doc.createElement("div");e.className="socketio",this.doc.body.appendChild(e),this.iframe=this.doc.createElement("iframe"),e.appendChild(this.iframe);var n=this,r=t.util.query(this.socket.options.query,"t="+ +(new Date));this.iframe.src=this.prepareUrl()+r,t.util.on(window,"unload",function(){n.destroy()})},n.prototype._=function(e,t){this.onData(e);try{var n=t.getElementsByTagName("script")[0];n.parentNode.removeChild(n)}catch(r){}},n.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},n.prototype.close=function(){return this.destroy(),t.Transport.XHR.prototype.close.call(this)},n.check=function(e){if(typeof window!="undefined"&&["Active"].concat("Object").join("X")in window)try{var n=new(window[["Active"].concat("Object").join("X")])("htmlfile");return n&&t.Transport.XHR.check(e)}catch(r){}return!1},n.xdomainCheck=function(){return!1},t.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(){t.Transport.XHR.apply(this,arguments)}function i(){}e["xhr-polling"]=r,t.util.inherit(r,t.Transport.XHR),t.util.merge(r,t.Transport.XHR),r.prototype.name="xhr-polling",r.prototype.heartbeats=function(){return!1},r.prototype.open=function(){var e=this;return t.Transport.XHR.prototype.open.call(e),!1},r.prototype.get=function(){function e(){this.readyState==4&&(this.onreadystatechange=i,this.status==200?(s.onData(this.responseText),s.get()):s.onClose())}function t(){this.onload=i,this.onerror=i,s.onData(this.responseText),s.get()}function r(){s.onClose()}if(!this.isOpen)return;var s=this;this.xhr=this.request(),n.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=t,this.xhr.onerror=r):this.xhr.onreadystatechange=e,this.xhr.send(null)},r.prototype.onClose=function(){t.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i;try{this.xhr.abort()}catch(e){}this.xhr=null}},r.prototype.ready=function(e,n){var r=this;t.util.defer(function(){n.call(r)})},t.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t,n){function r(e){t.Transport["xhr-polling"].apply(this,arguments),this.index=t.j.length;var n=this;t.j.push(function(e){n._(e)})}var i=n.document&&"MozAppearance"in n.document.documentElement.style;e["jsonp-polling"]=r,t.util.inherit(r,t.Transport["xhr-polling"]),r.prototype.name="jsonp-polling",r.prototype.post=function(e){function n(){r(),i.socket.setBuffer(!1)}function r(){i.iframe&&i.form.removeChild(i.iframe);try{f=document.createElement('<iframe name="'+i.iframeId+'">')}catch(e){f=document.createElement("iframe"),f.name=i.iframeId}f.id=i.iframeId,i.form.appendChild(f),i.iframe=f}var i=this,s=t.util.query(this.socket.options.query,"t="+ +(new Date)+"&i="+this.index);if(!this.form){var o=document.createElement("form"),u=document.createElement("textarea"),a=this.iframeId="socketio_iframe_"+this.index,f;o.className="socketio",o.style.position="absolute",o.style.top="0px",o.style.left="0px",o.style.display="none",o.target=a,o.method="POST",o.setAttribute("accept-charset","utf-8"),u.name="d",o.appendChild(u),document.body.appendChild(o),this.form=o,this.area=u}this.form.action=this.prepareUrl()+s,r(),this.area.value=t.JSON.stringify(e);try{this.form.submit()}catch(l){}this.iframe.attachEvent?f.onreadystatechange=function(){i.iframe.readyState=="complete"&&n()}:this.iframe.onload=n,this.socket.setBuffer(!0)},r.prototype.get=function(){var e=this,n=document.createElement("script"),r=t.util.query(this.socket.options.query,"t="+ +(new Date)+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),n.async=!0,n.src=this.prepareUrl()+r,n.onerror=function(){e.onClose()};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(n,s),this.script=n,i&&setTimeout(function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)},100)},r.prototype._=function(e){return this.onData(e),this.isOpen&&this.get(),this},r.prototype.ready=function(e,n){var r=this;if(!i)return n.call(this);t.util.load(function(){n.call(r)})},r.check=function(){return"document"in n},r.xdomainCheck=function(){return!0},t.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this)})(),define("lib/socket.io.min",function(){}),define("CouchDBBase",["Store","Tools","Promise"],function(t,n,r){function i(e){return typeof e=="object"&&typeof e.event=="function"?!0:!1}function s(e){return typeof e=="object"&&typeof e.request=="function"&&typeof e.listen=="function"?!0:!1}function o(e){return typeof e=="object"&&typeof e.fulfill=="function"&&typeof e.reject=="function"&&typeof e.then=="function"?!0:!1}function u(){var e=null,t="CouchDB",n=null,u,a=new r;this.setPromise=function(t){return o(t)?(a=t,!0):!1},this.getPromise=function(){return a},this.getStateMachine=function(){return e},this.setStateMachine=function(n){return i(n)?(e=n,!0):!1},this.getTransport=function(){return n},this.setTransport=function(t){return s(t)?(n=t,!0):!1},this.getHandlerName=function(){return t},this.setHandlerName=function(n){return typeof n=="string"?(t=n,!0):!1},this.sync=function(){return a=new r,(u=this.setSyncInfo.apply(this,arguments))?(e.event("sync"),a):!1},this.unsync=function(){return e.event("unsync")},this.getSyncInfo=function(){return u},this.onSync=function(){},this.onListen=function(){},this.onUnsync=function(){this.stopListening&&this.stopListening(),delete this.stopListening},this.unsync=function(){e.event("unsync")},this.onChange=function(){},this.onAdd=function(){},this.onRemove=function(){},this.setSyncInfo=function(t){return u=t}}return function(n){return u.prototype=new t(n),new u}}),define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(t,n,r,i,s){function o(){this.setSyncInfo=function(t,n,r){return typeof t=="string"&&typeof n=="string"?!r||typeof r=="object"?{database:t,document:n,query:r||{}}:!1:!1},this.onSync=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/"+t.document,query:t.query},function(e){var t=JSON.parse(e);t._id&&(this.reset(t),this.getStateMachine().event("listen")),this.getPromise().fulfill(t)},this)},this.onListen=function(){var t=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:{feed:"continuous",heartbeat:2e4,descending:!0}},function(e){var n;if(e=="\n")return!1;n=JSON.parse(e),n.id==t.document&&n.changes.pop().rev!=this.get("_rev")&&(n.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)},this.onChange=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/"+t.document},function(e){this.reset(JSON.parse(e))},this)},this.onRemove=function(){this.reset({})},this.upload=function(){var t=new i,n=this.getSyncInfo();return n.document?(this.getStateMachine().event("upload",t),t):!1},this.remove=function(){var t=this.getSyncInfo(),n=new i;return this.getStateMachine().event("removeFromDatabase",n),n},this.databaseCreate=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+n.database+"/"+n.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(e){var n=JSON.parse(e);n.ok?(this.set("_rev",n.rev),this.set("_id",n.id),this.getStateMachine().event("listen"),t.fulfill(n)):t.reject(n)},this)},this.databaseUpdate=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+n.database+"/"+n.document,headers:{"Content-Type":"application/json",Connection:"close"},data:this.toJSON()},function(e){var n=JSON.parse(e);n.ok?(this.set("_rev",n.rev),t.fulfill(n)):t.reject(n)},this)},this.databaseRemove=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+n.database+"/"+n.document,query:{rev:this.get("_rev")}},function(e){var n=JSON.parse(e);n.ok?t.fulfill(n):t.reject(n)})},this.setStateMachine(new s("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(t){return o.prototype=new n(t),new o}}),define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(t,n,r,i){function s(){this.setSyncInfo=function(t,n,r,i){return typeof t=="string"&&typeof n=="string"&&typeof r=="string"?!i||typeof i=="object"?{database:t,design:n,view:r,query:i||{}}:!1:!1},this.onSync=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(e){var n=JSON.parse(e);if(!n.rows)throw new Error("CouchDBStore ["+t.database+", "+t.design+", "+t.view+"].sync() failed: "+e);this.reset(n.rows),typeof n.total_rows=="undefined"&&(t.reducedView=!0),this.getStateMachine().event("listen"),this.getPromise().fulfill(n)},this)},this.onListen=function(){var t=this.getSyncInfo();r.mixin({feed:"continuous",heartbeat:2e4,descending:!0},t.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:t.query},function(e){if(e=="\n")return!1;var n=JSON.parse(e),r;t.reducedView?r="updateReduced":n.deleted?r="remove":n.changes&&n.changes[0].rev.search("1-")==0?r="add":r="change",this.getStateMachine().event(r,n.id)},this)},this.onChange=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_design/"+n.design+"/"+n.view,query:n.query},function(e){var n=JSON.parse(e);n.rows.length==this.getNbItems()?n.rows.some(function(e,n){e.id==t&&this.set(n,e)},this):this.evenDocsInStore.call(this,n.rows,t)},this)},this.evenDocsInStore=function(t,n){var r=this.getNbItems();t.length<r?this.loop(function(e,t){e.id==n&&this.del(t)},this):t.length>r&&t.some(function(e,t){if(e.id==n)return this.alter("splice",t,0,e)},this)},this.onAdd=function(t){var n=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_design/"+n.design+"/"+n.view,query:n.query},function(e){var n=JSON.parse(e);n.rows.some(function(e,n){e.id==t&&this.alter("splice",n,0,e)},this)},this)},this.onRemove=function(t){this.loop(function(e,n){e.id==t&&this.del(n)},this)},this.updateReduced=function(){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(e){var t=JSON.parse(e);this.set(0,t.rows[0])},this)},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(t){return s.prototype=new n(t),new s}}),define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(t,n,r,i,s){function o(){this.setSyncInfo=function(t,n){if(typeof t=="string"&&typeof n=="object"){var r={database:t,query:n||{}};return Array.isArray(r.query.keys)&&(r.keys=r.query.keys,delete r.query.keys),r}return!1},this.onSync=function(){var t=this.getSyncInfo(),n={path:"/"+t.database+"/_all_docs",query:t.query},r;Array.isArray(t.keys)?(n.method="POST",n.data=JSON.stringify({keys:t.keys}),n.headers={"Content-Type":"application/json"},r=n.data):(n.method="GET",r=JSON.stringify(t.query)),t.query.include_docs=!0,this.getTransport().request(this.getHandlerName(),n,function(e){var n=JSON.parse(e);if(!n.rows)throw new Error('CouchDBBulkDocuments.sync("'+t.database+'", '+r+") failed: "+e);this.reset(n.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this)},this)},this.onListen=function(){var t=this.getSyncInfo();r.mixin({feed:"continuous",heartbeat:2e4,descending:!0,include_docs:!0},t.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+t.database+"/_changes",query:t.query},function(e){var t;if(e=="\n")return!1;var t=JSON.parse(e),n;t.changes[0].rev.search("1-")==0?n="add":t.deleted?n="remove":n="change",this.getStateMachine().event(n,t.id,t.doc)},this)},this.onAdd=function(t){var n=this.getSyncInfo();if(!n.query.startkey&&!n.query.endkey)return!1;n.query.include_docs=!0,n.query.update_seq=!0,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+n.database+"/_all_docs",query:n.query},function(e){var n=JSON.parse(e);n.rows.forEach(function(e,n){e.id==t&&this.alter("splice",n,0,e.doc)},this)},this)},this.onChange=function(t,n){this.loop(function(e,r){e.id==t&&this.set(r,n)},this)},this.onRemove=function(t){this.loop(function(e,n){e.id==t&&this.del(n)},this)},this.databaseUpdate=function(t){var n=[],r=this.getSyncInfo();this.loop(function(e){n.push(e.doc)}),this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+r.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:n})},function(e){var n=JSON.parse(e);this.loop(function(e,t){n[t].ok&&(e.doc._rev=n[t].rev)}),t.fulfill(n)},this)},this.upload=function(){var t=new i;return this.getStateMachine().event("upload",t),t},this.setStateMachine(new s("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(t){return o.prototype=new n(t),new o}}),define("CouchDBUser",["CouchDBDocument","Promise"],function(t,n){function r(){var e="_users",t="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(n){return n?(e=n,!0):!1},this.getIdPrefix=function(){return t},this.setIdPrefix=function(n){return n?(t=n,!0):!1},this.setId=function(n){return n?(this.set("_id",t+n),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(r){return this.sync(e,t+r)},this.login=function(){var t=new n,r=this.get("name"),i=this.get("password");return r&&typeof r=="string"&&typeof i=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+r,auth:r+":"+i},t.fulfill,t):t.reject({error:"name & password must be strings"}),t},this.create=function(){var t=new n;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.load(this.get("name")).then(function(){t.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(e){t.fulfill(e)},function(e){t.reject(e)})},this),t}}return function(){return r.prototype=new t,new r}}),define("CouchDBSecurity",["CouchDBDocument"],function(t){function n(){var e="_security";this.setName=function(n){return n?(e=n,!0):!1},this.getName=function(){return e},this.load=function(n){return this.sync(n,e)}}return function(){return n.prototype=new t,new n}}),define("lib/couchdbtools",function(){}),define("Tools",[],function(){function t(e,t,n){var r,i;if(!t)return;return t.forEach(function(t,s){var o=n(t,e);o>=0&&(typeof i=="undefined"||o<i)&&(i=o,r=s)}),r}return{getGlobal:function(){var t=function(){return this};return t.call(null)},mixin:function(t,n,r){return this.loop(t,function(e,i){if(!n[i]||!r)n[i]=t[i]}),n},count:function(t){var n=0;return this.loop(t,function(){n++}),n},compareObjects:function(t,n){var r=function(e){return Object.getOwnPropertyNames(e).sort().join("")};return r(t)==r(n)},compareNumbers:function(t,n){return t>n?1:t<n?-1:0},toArray:function(t){return[].slice.call(t)},loop:function(t,n,r){var i,s;if(t instanceof Object&&n instanceof Function){if(t instanceof Array)for(i=0;i<t.length;i++)n.call(r,t[i],i,t);else for(i in t)t.hasOwnProperty(i)&&n.call(r,t[i],i,t);return!0}return!1},objectsDiffs:function(t,n){if(t instanceof Object&&n instanceof Object){var r=[],i=[],s=[],o=[];return this.loop(n,function(e,n){typeof t[n]=="undefined"?o.push(n):e!==t[n]?i.push(n):e===t[n]&&r.push(n)}),this.loop(t,function(e,t){typeof n[t]=="undefined"&&s.push(t)}),{updated:i,unchanged:r,added:o,deleted:s}}return!1},jsonify:function(t){return t instanceof Object?JSON.parse(JSON.stringify(t)):!1},clone:function(t){return t instanceof Array?t.slice(0):typeof t!="object"||t===null||t instanceof RegExp?!1:this.mixin(t,{})},getNestedProperty:function(t,n){if(t&&t instanceof Object){if(typeof n=="string"&&n!==""){var r=n.split(".");return r.reduce(function(e,t){return e&&e[t]},t)}return typeof n=="number"?t[n]:t}return t},setNestedProperty:function(t,n,r){if(t&&t instanceof Object){if(typeof n=="string"&&n!==""){var i=n.split(".");return i.reduce(function(e,t,n){return e[t]=e[t]||{},i.length==n+1&&(e[t]=r),e[t]},t)}return typeof n=="number"?(t[n]=r,t[n]):t}return t},closest:function(n,r){return t(n,r,function(e,t){return Math.abs(e-t)})},closestGreater:function(n,r){return t(n,r,function(e,t){return e-t})},closestLower:function(n,r){return t(n,r,function(e,t){return t-e})}}}),define("Observable",["Tools"],function(t){return function(){var n={};this.watch=function(t,r,i){if(typeof r=="function"){var s=n[t]=n[t]||[],o=[r,i];return s.push(o),[t,s.indexOf(o)]}return!1},this.unwatch=function(t){var r=t[0],i=t[1];return n[r]&&n[r][i]?(delete n[r][i],n[r].some(function(e){return!!e})||delete n[r],!0):!1},this.notify=function(r){var i=n[r],s=t.toArray(arguments).slice(1);return i?(t.loop(i,function(e){try{e&&e[0].apply(e[1]||null,s)}catch(t){}}),!0):!1},this.hasObserver=function(t){return!!(t&&n[t[0]]&&n[t[0]][t[1]])},this.hasTopic=function(t){return!!n[t]},this.unwatchAll=function(t){return n[t]?delete n[t]:n={},!0}}}),define("StateMachine",["Tools"],function(t){function n(e,n){var i={},s="";this.init=function(t){return i[t]?(s=t,!0):!1},this.add=function(t){if(!i[t]){var n=i[t]=new r;return n}return i[t]},this.get=function(t){return i[t]},this.getCurrent=function(){return s},this.has=function(t){return i.hasOwnProperty(t)},this.advance=function(t){return this.has(t)?(s=t,!0):!1},this.event=function(n){var r;return r=i[s].event.apply(i[s].event,t.toArray(arguments)),r===!1?!1:(r&&(i[s].event("exit"),s=r,i[s].event("entry")),!0)},t.loop(n,function(e,t){var n=this.add(t);e.forEach(function(e){n.add.apply(null,e)})},this),this.init(e)}function r(){var e={};this.add=function(n,r,i,s){var o=[];return e[n]?!1:typeof n=="string"&&typeof r=="function"?(o[0]=r,typeof i=="object"&&(o[1]=i),typeof i=="string"&&(o[2]=i),typeof s=="string"&&(o[2]=s),e[n]=o,!0):!1},this.has=function(n){return!!e[n]},this.get=function(n){return e[n]||!1},this.event=function(r){var i=e[r];return i?(i[0].apply(i[1],t.toArray(arguments).slice(1)),i[2]):!1}}return n}),define("Promise",["Observable","StateMachine"],function(t,n){return function r(){var e=null,i=null,s=new t,o={Pending:[["fulfill",function(n){e=n,s.notify("fulfill",n)},"Fulfilled"],["reject",function(t){i=t,s.notify("reject",t)},"Rejected"],["toFulfill",function(t){s.watch("fulfill",t)}],["toReject",function(t){s.watch("reject",t)}]],Fulfilled:[["toFulfill",function(n){setTimeout(function(){n(e)},0)}]],Rejected:[["toReject",function(t){setTimeout(function(){t(i)},0)}]]},u=new n("Pending",o);this.fulfill=function(t){return u.event("fulfill",t),this},this.reject=function(t){return u.event("reject",t),this},this.then=function(){var n=new r;return arguments[0]instanceof Function?arguments[1]instanceof Function?u.event("toFulfill",this.makeResolver(n,arguments[0])):u.event("toFulfill",this.makeResolver(n,arguments[0],arguments[1])):u.event("toFulfill",this.makeResolver(n,function(){n.fulfill(e)})),arguments[1]instanceof Function&&u.event("toReject",this.makeResolver(n,arguments[1],arguments[2])),arguments[2]instanceof Function&&u.event("toReject",this.makeResolver(n,arguments[2],arguments[3])),!(arguments[1]instanceof Function)&&!(arguments[2]instanceof Function)&&u.event("toReject",this.makeResolver(n,function(){n.reject(i)})),n},this.sync=function(t){if(t instanceof Object&&t.then){var n=function(t){this.fulfill(t)},r=function(t){this.reject(t)};return t.then(n.bind(this),r.bind(this)),!0}return!1},this.makeResolver=function(t,n,r){return function(i){var s;try{s=n.call(r,i),t.sync(s)||t.fulfill(s)}catch(o){t.reject(o)}}},this.getReason=function(){return i},this.getValue=function(){return e},this.getObservable=function(){return s},this.getStateMachine=function(){return u},this.getStates=function(){return o}}}),define("Store",["Observable","Tools"],function(t,n){return function(r){var i=n.clone(r)||{},s=new t,o=new t,u=[],a=function(t){var r=n.objectsDiffs(t,i);["updated","deleted","added"].forEach(function(e){r[e].forEach(function(t){s.notify(e,t,i[t]),o.notify(t,i[t],e)})})};this.getNbItems=function(){return i instanceof Array?i.length:n.count(i)},this.count=this.getNbItems,this.get=function(t){return i[t]},this.has=function(t){return i.hasOwnProperty(t)},this.set=function(t,n){var r,u,a;return typeof t!="undefined"?(r=this.has(t),u=this.get(t),i[t]=n,a=r?"updated":"added",s.notify(a,t,i[t],u),o.notify(t,i[t],a,u),!0):!1},this.update=function(t,r,i){var u;return this.has(t)?(u=this.get(t),n.setNestedProperty(u,r,i),s.notify("updated",r,i),o.notify(t,u,"updated"),!0):!1},this.del=function(t){return this.has(t)?(this.alter("splice",t,1)||(delete i[t],s.notify("deleted",t),o.notify(t,i[t],"deleted")),!0):!1},this.delAll=function(t){return t instanceof Array?(t.sort(n.compareNumbers).reverse().forEach(this.del,this),!0):!1},this.alter=function(t){var r,s;return i[t]?(s=n.clone(i),r=this.proxy.apply(this,arguments),a(s),r):!1},this.proxy=function(t){return i[t]?i[t].apply(i,Array.prototype.slice.call(arguments,1)):!1},this.watch=function(t,n,r){return s.watch(t,n,r)},this.unwatch=function(t){return s.unwatch(t)},this.getStoreObservable=function(){return s},this.watchValue=function(t,n,r){return o.watch(t,n,r)},this.unwatchValue=function(t){return o.unwatch(t)},this.getValueObservable=function(){return o},this.loop=function(t,r){n.loop(i,t,r)},this.reset=function(t){if(t instanceof Object){var r=n.clone(i);return i=n.clone(t)||{},a(r),!0}return!1},this.compute=function(t,r,i,s){var o=[];return typeof t=="string"&&typeof r=="object"&&typeof i=="function"&&!this.isCompute(t)?(u[t]=[],n.loop(r,function(e){u[t].push(this.watchValue(e,function(){this.set(t,i.call(s))},this))},this),this.set(t,i.call(s)),!0):!1},this.removeCompute=function(t){return this.isCompute(t)?(n.loop(u[t],function(e){this.unwatchValue(e)},this),this.del(t),!0):!1},this.isCompute=function(t){return!!u[t]},this.toJSON=function(){return JSON.stringify(i)},this.dump=function(){return i}}}),define("Transport",[],function(){return function(t){var n=null;this.setReqHandlers=function(t){return t instanceof Object?(n=t,!0):!1},this.getReqHandlers=function(){return n},this.request=function(t,r,i,s){return n.has(t)&&typeof r!="undefined"?(n.get(t)(r,function(){i&&i.apply(s,arguments)}),!0):!1},this.listen=function(t,r,i,s){if(n.has(t)&&typeof r!="undefined"&&typeof i=="function"){var o=function(){i.apply(s,arguments)},u;return u=n.get(t)(r,o,o),function(){typeof u=="function"?u():typeof u=="object"&&typeof u.func=="function"&&u.func.call(u.scope)}}return!1},this.setReqHandlers(t)}}),define("lib/emily",function(){}),define("DomUtils",["Tools"],function(e){return{getNodes:function(t,n){return this.isAcceptedType(t)?(t.parentNode||document.createDocumentFragment().appendChild(t),t.parentNode.querySelectorAll(n||"*")):!1},getDataset:function(t){var n=0,r,i={},s,o;if(this.isAcceptedType(t)){if(t.hasOwnProperty("dataset"))return t.dataset;for(r=t.attributes.length;n<r;n++)s=t.attributes[n].name.split("-"),s.shift()=="data"&&(i[o=s.join("-")]=t.getAttribute("data-"+o));return i}return!1},isAcceptedType:function(t){return t instanceof HTMLElement||t instanceof SVGElement?!0:!1},setAttribute:function(t,n,r){return t instanceof HTMLElement?(t[n]=r,!0):t instanceof SVGElement?(t.setAttribute(n,r),!0):!1},matches:function(n,r,i){return e.toArray(this.getNodes(n,r)).indexOf(i)>-1}}}),define("Bind.plugin",["Store","Observable","Tools","DomUtils"],function(t,n,r,i){return function(n,s){function l(e){f[e]&&f[e].forEach(function(e){o.unwatchValue(e)}),delete f[e]}var o=null,u={},a={},f={};this.observers=f,this.setModel=function(n){return n instanceof t?(o=n,!0):!1},this.getModel=function(){return o},this.ItemRenderer=function(t,n){var s=null,u=null,a=null,f=null,c=null;this.setRenderer=function(t){return s=t,!0},this.getRenderer=function(){return s},this.setRootNode=function(t){var n;return i.isAcceptedType(t)?(a=t,n=a.querySelector("*"),this.setRenderer(n),n&&a.removeChild(n),!0):!1},this.getRootNode=function(){return a},this.setPlugins=function(t){return u=t,!0},this.getPlugins=function(){return u},this.items={},this.setStart=function(t){return f=parseInt(t,10)},this.getStart=function(){return f},this.setNb=function(t){return c=t=="*"?t:parseInt(t,10)},this.getNb=function(){return c},this.addItem=function(t){var n,r;return typeof t=="number"&&!this.items[t]?(r=this.getNextItem(t),n=this.create(t),n?(r?a.insertBefore(n,r):a.appendChild(n),!0):!1):!1},this.getNextItem=function(t){var n=Object.keys(this.items).map(function(e){return Number(e)}),i=r.closestGreater(t,n),s=n[i];if(s!=t)return this.items[s];return},this.removeItem=function(t){var n=this.items[t];return n?(a.removeChild(n),delete this.items[t],l(t),!0):!1},this.create=function(t){if(o.has(t)){var n=s.cloneNode(!0),a=i.getNodes(n);return r.toArray(a).forEach(function(e){e.setAttribute("data-"+u.name+"_id",t)}),this.items[t]=n,u.apply(n),n}},this.render=function(){var t=c=="*"?o.getNbItems():c,n=[];if(c!==null&&f!==null){r.loop(this.items,function(e,r){r=Number(r),(r<f||r>=f+t||!o.has(r))&&n.push(r)},this),n.sort(r.compareNumbers).reverse().forEach(this.removeItem,this);for(var i=f,s=t+f;i<s;i++)this.addItem(i);return!0}return!1},this.setPlugins(t),this.setRootNode(n)},this.setItemRenderer=function(t,n){t=t||"default",a[t]=n},this.getItemRenderer=function(t){return a[t]},this.foreach=function(t,n,r,i){var s=new this.ItemRenderer(this.plugins,t);s.setStart(r||0),s.setNb(i||"*"),s.render(),o.watch("added",s.render,s),o.watch("deleted",function(e){s.render(),l(e)},this),this.setItemRenderer(n,s)},this.updateStart=function(t,n){var r=this.getItemRenderer(t);return r?(r.setStart(n),!0):!1},this.updateNb=function(t,n){var r=this.getItemRenderer(t);return r?(r.setNb(n),!0):!1},this.refresh=function(t){var n=this.getItemRenderer(t);return n?(n.render(),!0):!1},this.bind=function(t,n,s){s=s||"";var u=t.getAttribute("data-"+this.plugins.name+"_id"),a=s.split("."),f=u||a.shift(),l=u?s:a.join("."),c=r.getNestedProperty(o.get(f),l),h=r.toArray(arguments).slice(3);if(c||c===0||c===!1)this.execBinding.apply(this,[t,n,c].concat(h))||i.setAttribute(t,n,c);this.hasBinding(n)||t.addEventListener("change",function(e){o.has(f)&&(l?o.update(f,s,t[n]):o.set(f,t[n]))},!0),this.observers[f]=this.observers[f]||[],this.observers[f].push(o.watchValue(f,function(e){this.execBinding.apply(this,[t,n,r.getNestedProperty(e,l)].concat(h))||i.setAttribute(t,n,r.getNestedProperty(e,l))},this))},this.set=function(t){return i.isAcceptedType(t)&&t.name?(o.set(t.name,t.value),!0):!1},this.getItemIndex=function(t){var n=i.getDataset(t);return n&&typeof n[this.plugins.name+"_id"]!="undefined"?+n[this.plugins.name+"_id"]:!1},this.form=function c(c){if(c&&c.nodeName=="FORM"){var e=this;return c.addEventListener("submit",function(t){r.toArray(c.querySelectorAll("[name]")).forEach(e.set,e),t.preventDefault()},!0),!0}return!1},this.addBinding=function(t,n){return t&&typeof t=="string"&&typeof n=="function"?(u[t]=n,!0):!1},this.execBinding=function(t,n){return this.hasBinding(n)?(u[n].apply(t,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(t){return u.hasOwnProperty(t)},this.getBinding=function(t){return u[t]},this.addBindings=function(t){return r.loop(t,function(e,t){this.addBinding(t,e)},this)},this.setModel(n),this.addBindings(s)}}),define("Event.plugin",["DomUtils"],function(t){return function(n,r){var i=null,s={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},o=!!r;this.addEventListener=function(t,n,r,i){t.addEventListener(this.map(n),r,!!i)},this.listen=function(t,n,r,s){this.addEventListener(t,n,function(e){i[r].call(i,e,t)},!!s)},this.delegate=function(n,r,s,o,u){this.addEventListener(n,s,function(e){t.matches(n,r,e.target)&&i[o].call(i,e,n)},!!u)},this.getParent=function(){return i},this.setParent=function(t){return t instanceof Object?(i=t,!0):!1},this.map=function(t){return o?s[t]||t:t},this.setMap=function(t,n){return typeof t=="string"&&typeof n=="string"?(s[t]=n,!0):!1},this.setParent(n)}}),define("LocalStore",["Store","Tools"],function(t,n){function r(){var e=null,t=localStorage,r=function(){t.setItem(e,this.toJSON())};this.setLocalStorage=function(n){return n&&n.setItem instanceof Function?(t=n,!0):!1},this.getLocalStorage=function(){return t},this.sync=function(s){var o;return typeof s=="string"?(e=s,o=JSON.parse(t.getItem(s)),n.loop(o,function(e,t){this.has(t)||this.set(t,e)},this),r.call(this),this.watch("added",r,this),this.watch("updated",r,this),this.watch("deleted",r,this),!0):!1}}return function(n){return r.prototype=new t(n),new r}}),define("Plugins",["Tools","DomUtils"],function(t,n){return function(r){var i={},s=function(t){return t.trim()},o=function(t,n,r){n.split(";").forEach(function(e){var n=e.split(":"),o=n[0].trim(),u=n[1]?n[1].split(",").map(s):[];u.unshift(t),i[r]&&i[r][o]&&i[r][o].apply(i[r],u)})};this.add=function(t,n){var r=this,s="plugins";return typeof t=="string"&&typeof n=="object"&&n?(i[t]=n,n[s]={name:t,apply:function(){return r.apply.apply(r,arguments)}},!0):!1},this.addAll=function(n){return t.loop(n,function(e,t){this.add(t,e)},this)},this.get=function(t){return i[t]},this.del=function(t){return delete i[t]},this.apply=function(r){var i;return n.isAcceptedType(r)?(i=n.getNodes(r),t.loop(t.toArray(i),function(e){t.loop(n.getDataset(e),function(t,n){o(e,t,n)})}),r):!1},this.addAll(r)}}),define("OObject",["StateMachine","Store","Plugins","DomUtils","Tools"],function(t,n,r,i,s){return function(o){var u=function(t){var n=l||document.createElement("div");if(!t.template)throw Error("UI.template must be set prior to render");typeof t.template=="string"?n.innerHTML=t.template.trim():i.isAcceptedType(t.template)&&n.appendChild(t.template);if(n.childNodes.length>1)throw Error("UI.template should have only one parent node");t.dom=n.childNodes[0],t.plugins.apply(t.dom)},a=function h(e,h,t){h&&(t?h.insertBefore(e.dom,t):h.appendChild(e.dom),l=h)},f=function(t,n){u(t),a.apply(null,s.toArray(arguments))},l=null,c=new t("Init",{Init:[["render",u,this,"Rendered"],["place",f,this,"Rendered"]],Rendered:[["place",a,this],["render",u,this]]});this.model=o instanceof n?o:new n,this.plugins=new r,this.template=null,this.dom=null,this.place=function(t,n){c.event("place",this,t,n)},this.render=function(){c.event("render",this)},this.setTemplateFromDom=function(t){return i.isAcceptedType(t)?(this.template=t,!0):!1},this.alive=function(t){return i.isAcceptedType(t)?(this.setTemplateFromDom(t),this.place(t.parentNode,t.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return l}}}),define("Place.plugin",["OObject","Tools"],function(t,n){return function(r){var i={};this.place=function(n,r){if(!(i[r]instanceof t))throw new Error(r+" is not an OObject UI in place:"+r);i[r].place(n)},this.set=function(n,r){return typeof n=="string"&&r instanceof t?(i[n]=r,!0):!1},this.setAll=function(t){n.loop(t,function(e,t){this.set(t,e)},this)},this.get=function(t){return i[t]},this.setAll(r)}}),define("SocketIOTransport",["Observable","Tools"],function(t,n){return function(t){var n=null;this.setSocket=function(t){return t&&typeof t.emit=="function"?(n=t,!0):!1},this.getSocket=function(){return n},this.on=function(t,r){return n.on(t,r)},this.once=function(t,r){return n.once(t,r)},this.emit=function(t,r,i){return n.emit(t,r,i)},this.removeListener=function(t,r,i){return n.removeListener(t,r,i)},this.request=function(t,n,r,i){if(typeof t=="string"&&typeof n!="undefined"){var s={eventId:Date.now()+Math.floor(Math.random()*1e6),data:n},o=function(){r&&r.apply(i||null,arguments)};return this.once(s.eventId,o),this.emit(t,s),!0}return!1},this.listen=function(t,n,r,i){if(typeof t=="string"&&typeof n!="undefined"&&typeof r=="function"){var s={eventId:Date.now()+Math.floor(Math.random()*1e6),data:n,keepAlive:!0},o=function(){r&&r.apply(i||null,arguments)},u=this;return this.on(s.eventId,o),this.emit(t,s),function(){u.emit("disconnect-"+s.eventId),u.removeListener(s.eventId,o)}}return!1},this.setSocket(t)}}),define("lib/olives",function(){}),define("Amy/DomUtils",["DomUtils","Tools"],function(e,t){return{hasQuerySelector:function(n,r,i){return t.toArray(e.getNodes(n,i)).indexOf(r)>-1}}}),define("Amy/TestUtils",[],function(){var e=function(e){return typeof e=="string"},t=function(t,n){throw new Error(e(n)?n:t)};return{assertIsObject:function(e,n){return e instanceof Object||t("Is not Object",n),!0},assertIsObservable:function(e,n){return(!e||typeof e["watch"]!="function"||typeof e["notify"]!="function")&&t("Is not Observable",n),!0},assertIsString:function(n,r){return e(n)||t("Is not String",r),!0}}}),define("Amy/Stack-plugin",["Amy/Stack-service"],function(e){return function(n,r){var i=new e(n,r);this.getStack=function(){return i},this.destination=function(e){i.setDestination(e)},this.hide=function(){i.hide()},this.show=function(e,t,n,r){e.addEventListener(t,function(e){i.show(e.target.getAttribute(n))},r=="true")}}}),define("Amy/Event-controller",["Amy/TestUtils","Tools"],function(e,t){return function(n,r){var i=n instanceof Object?n:null,s=function(e){return typeof e=="boolean"?e:!1},o=function(){var e=!0,t;for(t=arguments.length;t>=0;t--)e=e&&typeof arguments[t]=="string";return e},u=s(r),a={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"};this.addListener=function(e,t,n,r){e.addEventListener(this.map(t),n,r)},this.call=function(e){i[e].apply(i,t.toArray(arguments).slice(1))},this.isTouch=function(){return u},this.setTouch=function(e){return s(e)?(u=e,!0):!1},this.setMap=function(e,t){return o(e,t)?(a[e]=t,!0):!1},this.map=function(e){var t=a[e];return t&&u?t:e},this.setScope=function(e){return i=e,!0},this.scope=function(){return i}}}),define("Amy/Delegate-plugin",["Amy/Event-controller","Amy/DomUtils"],function(e,t){function n(){this.listen=function(e,t,n,r){var i=this;this.addListener(e,t,function(t){i.call(n,t,e)},r=="true")},this.selector=function(e,n,r,i,s){var o=this;this.addListener(e,r,function(r){t.hasQuerySelector(e,r.target,n)&&o.call(i,r,e)},s=="true")}}return function(r,i){return n.prototype=new e(r,i),new n}}),define("Amy/Control-plugin",["Amy/Event-controller","Amy/DomUtils"],function(e,t){function n(){var e=null;this.init=function(t){e=t},this.radio=function(n,r,i,s,o,u){var a=this;this.addListener(n,s,function(s){var u=s.target;t.hasQuerySelector(n,u,r)&&(a.radioClass(u,e,i),e=u,a.call(o,s))},u=="true")},this.radioClass=function(e,t,n){e.classList.add(n),t&&t!=e&&t.classList.remove(n)},this.toggleClass=function(e,t){return e.classList.toggle(t)},this.toggle=function(e,n,r,i,s,o){var u=this;this.addListener(e,i,function(i){var o=i.target;t.hasQuerySelector(e,o,n)&&(u.toggleClass(o,r),u.call(s,i))},o=="true")}}return function(r,i){return n.prototype=new e(r,i),new n}}),define("Amy/Stack-service",["Store","OObject","DomUtils","Tools"],function(t,n,r,i){return function(i,s){var o=new t(i),u=s,a="",f=null;this.setDestination=function(t){return r.isAcceptedType(t)?(u=t,!0):!1},this.getDestination=function(){return u},this.setCurrentScreen=function(t){f=t},this.getCurrentScreen=function(){return f},this.add=function(t,r){return typeof t=="string"&&r instanceof n?(o.set(t,r),this.hide(r),!0):!1},this.get=function(t){return o.get(t)},this.del=function(t){return o.del(t)},this.reset=function(t){return o.reset(t)},this.getCurrentName=function(){return a},this.show=function(t){var n=this.get(t);return n&&t!==a?(n.place(u),f&&this.hide(f),this.setCurrentScreen(n),a=t,!0):!1},this.hide=function(t){t.place(document.createDocumentFragment())}}}),define("lib/amy2",function(){}),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("lib/spin.min",t):e.Spinner=t()}(this,function(){function r(e,t){var n=document.createElement(e||"div"),r;for(r in t)n[r]=t[r];return n}function i(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function o(e,r,i,o){var u=["opacity",r,~~(e*100),i,o].join("-"),a=.01+i/o*100,f=Math.max(1-(1-e)/r*(100-a),e),l=n.substring(0,n.indexOf("Animation")).toLowerCase(),c=l&&"-"+l+"-"||"";return t[u]||(s.insertRule("@"+c+"keyframes "+u+"{"+"0%{opacity:"+f+"}"+a+"%{opacity:"+e+"}"+(a+.01)+"%{opacity:1}"+(a+r)%100+"%{opacity:"+e+"}"+"100%{opacity:"+f+"}"+"}",s.cssRules.length),t[u]=1),u}function u(t,n){var r=t.style,i,s;if(r[n]!==undefined)return n;n=n.charAt(0).toUpperCase()+n.slice(1);for(s=0;s<e.length;s++){i=e[s]+n;if(r[i]!==undefined)return i}}function a(e,t){for(var n in t)e.style[u(e,n)||n]=t[n];return e}function f(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]===undefined&&(e[r]=n[r])}return e}function l(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function h(e){if(typeof this=="undefined")return new h(e);this.opts=f(e||{},h.defaults,c)}function p(){function e(e,t){return r("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}s.addRule(".spin-vml","behavior:url(#default#VML)"),h.prototype.lines=function(t,n){function o(){return a(e("group",{coordsize:s+" "+s,coordorigin:-r+" "+ -r}),{width:s,height:s})}function c(t,s,u){i(f,i(a(o(),{rotation:360/n.lines*t+"deg",left:~~s}),i(a(e("roundrect",{arcsize:n.corners}),{width:r,height:n.width,left:n.radius,top:-n.width>>1,filter:u}),e("fill",{color:n.color,opacity:n.opacity}),e("stroke",{opacity:0}))))}var r=n.length+n.width,s=2*r,u=-(n.width+n.length)*2+"px",f=a(o(),{position:"absolute",top:u,left:u}),l;if(n.shadow)for(l=1;l<=n.lines;l++)c(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=n.lines;l++)c(l);return i(t,f)},h.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}}var e=["webkit","Moz","ms","O"],t={},n,s=function(){var e=r("style",{type:"text/css"});return i(document.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),c={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};h.defaults={},f(h.prototype,{spin:function(e){this.stop();var t=this,i=t.opts,s=t.el=a(r(0,{className:i.className}),{position:i.position,width:0,zIndex:i.zIndex}),o=i.radius+i.length+i.width,u,f;e&&(e.insertBefore(s,e.firstChild||null),f=l(e),u=l(s),a(s,{left:(i.left=="auto"?f.x-u.x+(e.offsetWidth>>1):parseInt(i.left,10)+o)+"px",top:(i.top=="auto"?f.y-u.y+(e.offsetHeight>>1):parseInt(i.top,10)+o)+"px"})),s.setAttribute("role","progressbar"),t.lines(s,t.opts);if(!n){var c=0,h=(i.lines-1)*(1-i.direction)/2,p,d=i.fps,v=d/i.speed,m=(1-i.opacity)/(v*i.trail/100),g=v/i.lines;(function y(){c++;for(var e=0;e<i.lines;e++)p=Math.max(1-(c+(i.lines-e)*g)%v*m,i.opacity),t.opacity(s,e*i.direction+h,p,i);t.timeout=t.el&&setTimeout(y,~~(1e3/d))})()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=undefined),this},lines:function(e,t){function l(e,n){return a(r(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*s+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.corners*t.width>>1)+"px"})}var s=0,u=(t.lines-1)*(1-t.direction)/2,f;for(;s<t.lines;s++)f=a(r(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:n&&o(t.opacity,t.trail,u+s*t.direction,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&i(f,a(l("#000","0 0 4px #000"),{top:"2px"})),i(e,i(f,l(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}});var d=a(r("group"),{behavior:"url(#default#VML)"});return!u(d,"transform")&&d.adj?p():n=u(d,"animation"),h}),define("service/map",["Store"],function(e){return new e({body:document.body,login:document.getElementById("login"),"login-form":document.getElementById("login-form"),"signup-form":document.getElementById("signup-form"),loading:document.getElementById("loading"),serverdown:document.getElementById("serverdown"),nointernet:document.getElementById("nointernet"),dock:document.getElementById("wrapper"),notify:document.getElementById("notify"),"notify-popup":document.getElementById("notify-popup"),"newidea-popup":document.getElementById("newidea-popup"),"new2q-popup":document.getElementById("new2q-popup"),"new2c-popup":document.getElementById("new2c-popup"),"help-popup":document.getElementById("help-popup"),"tip-popup":document.getElementById("tip-popup"),cache:document.getElementById("cache"),"public":document.getElementById("public"),"public-menu":document.getElementById("public-menu"),"public-detail":document.getElementById("public-detail"),"public-writetwocents":document.getElementById("public-writetwocents"),"public-twocents":document.getElementById("public-twocents"),"public-edit":document.querySelector("#public-detail .idea-edit"),"public-sendmail":document.querySelector("#public-detail .idea-sendmail"),"public-share":document.querySelector("#public-detail .idea-share"),brainstorm:document.getElementById("brainstorm"),"brainstorm-menu":document.getElementById("brainstorm-menu"),"ideafy-menu":document.getElementById("ideafy-menu"),"ideafy-quick":document.getElementById("ideafy-quick"),"ideafy-multi":document.getElementById("ideafy-multi"),quickstart:document.getElementById("quickstart"),mustart:document.getElementById("mustart"),quicksetup:document.getElementById("quicksetup"),quickscenario:document.getElementById("quickscenario"),"scenario-whiteboard":document.getElementById("scenario-whiteboard"),quicktech:document.getElementById("quicktech"),quickidea:document.getElementById("quickidea"),quickwrapup:document.getElementById("quickwrapup"),library:document.getElementById("library"),"library-menu":document.getElementById("library-menu"),ideas:document.getElementById("ideas"),"ideas-detail":document.getElementById("ideas-detail"),"library-idea":document.querySelector("library-idea"),"library-writetwocents":document.getElementById("library-writetwocents"),"library-twocents":document.getElementById("library-twocents"),"library-edit":document.querySelector("#ideas-detail .idea-edit"),"library-sendmail":document.querySelector("#ideas-detail .idea-sendmail"),"library-share":document.querySelector("#ideas-detail .idea-share"),sessions:document.getElementById("sessions"),decks:document.getElementById("decks"),decklist:document.getElementById("decklist"),deckview:document.getElementById("deckview"),connect:document.getElementById("connect"),"connect-menu":document.getElementById("connect-menu"),"connect-messages":document.getElementById("connect-messages"),msgdetail:document.getElementById("msgdetail"),"connect-contacts":document.getElementById("connect-contacts"),contactdetails:document.getElementById("contactdetails"),"connect-twocents":document.getElementById("connect-twocents"),dashboard:document.getElementById("dashboard"),"dashboard-menu":document.getElementById("dashboard-menu"),"dashboard-profile":document.getElementById("dashboard-profile"),leaderboard:document.getElementById("leaderboard"),"dashboard-settings":document.getElementById("dashboard-settings"),"dashboard-about":document.getElementById("dashboard-about")})}),define("service/config",["Store","SocketIOTransport","CouchDBDocument","Observable"],function(e,t,n,r){var i,s,o,u,a=new e,f;return this.reset=function(){i="http://8.19.34.68:1664",f=io.connect(i),s=new t(f),o=new n,u=new r,o.setTransport(s),a.reset({location:i,socket:f,transport:s,db:"ideafy",user:o,observer:u,polling_interval:6e4,userTemplate:{lastname:"",firstname:"",address:{street1:"",street2:"",zip:null,state:"",city:"",country:""},gender:1,lang:"en-us",birthdate:[],connections:[],taiaut_decks:["INT"],custom_decks:[],active_deck:"INT",occupation:{situation:"",job:"",organization:""},family:{couple:null,children:null},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],type:7,notifications:[],sentMessages:[],facebook:"",twitter:"",gplus:"",linkedin:"",username:"",sessionInProgress:{},organization:"",rated:[],rated_ideas:[],favorites:[],ip:0,picture_file:"img/avatars/deedee0.png",intro:"Ideafyer",title:null,achievements:[],ideas_count:0,su_sessions_count:0,mu_sessions_count:0,twocents_count:0,twoquestions_count:0,tutorial_complete:!1,profile_complete:!1,news:[],twocents:[],twoquestions:[],settings:{notifyPopup:!0,useascharacter:!1,ccme:!1,privacy_lvl:0,showTips:!0,startupScreen:"#public",listSize:null,polling_interval:6e4}},ideaTemplate:{title:"",sessionId:"",sessionReplay:!1,authors:[],description:"",solution:"",creation_date:[],character:"",problem:"",lang:"en-us",context:"",techno:[],type:6,sharedwith:[],modification_date:[],inspired_by:"",visibility:"private",votes:[],rating:"",authornames:"",twocents:[]},TQTemplate:{author:[],question:"",creation_date:[],lang:"en-us",type:10,modification_date:[],votes:[],rating:"",username:"",twocents:[]},sessionTemplate:{title:"",description:"",initiator:{id:"",username:"",picture_file:""},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"",type:8,deck:"",status:"in progress",step:"",lang:"en-us",characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:0,sessionReplay:!1},avatars:new e({}),avatar:null,defaultLabels:{language:"en-us",emailplaceholder:"Email",passwordplaceholder:"Password",repeatpasswordplaceholder:"Confirm password",loginbutton:"Log in",newuserbutton:"New user",invalidlogin:"Invalid username or password",missingloginparam:"Please enter both username and password or register",signupmissingemail:"Please enter your email address in the field above",signupmissingpwd:"A password is required",signupmissingpwdok:"Please confirm your password",signupmissingfn:"Please enter your first name",signupmisingln:"Please enter your last name",signupinvalidemail:"Invalid email address",signuppwdnomatch:"Passwords do not match",signupwelcomeobject:"Welcome to Ideady",signupwelcomebody:"Thank you for trying Ideafy. We hope you'll enjoy it. We designed it so you can manage ideas that matter to you or just play around. But don't keep what you're doing to yourself.",signupbutton:"Sign up",Initialization:"Initializing user data. Please wait ...",firstnameplaceholder:"First name",lastnameplaceholder:"Last name",createidealbl:"Enter a new idea",ideatitleplaceholder:"Enter a title for your idea",ideadescplaceholder:"Enter a description of your idea in non technical terms",ideasolplaceholder:"Describe how your idea would work, what components, products, services or technologies you would  use",privatelbl:"Private",publiclbl:"Public",ideavisiblelbl:"Your idea is ",setideavisiblelbl:"Change status:",ideafyreplaylbl:"Ideafy Replay is",ideafysetreplaylbl:"Change Ideafy Replay status: ",enabledreplaylbl:"Enabled",disabledreplaylbl:"Disabled",enablereplaylbl:"Enable",disablereplaylbl:"Disable",oklbl:"Ok",continuelbl:"Continue",setpublicquestion:"Warning, every Ideafy user will be able to view your idea. This operation is irreversible. Do you want to proceed?",publicideasheadertitle:"Public Ideas",publicdetailsheadertitle:"Idea overview",searchpublicplaceholder:"Search public ideas...",ideadetailsheadertitle:"Idea Overview",idealistheadertitle:"My Ideas",searchprivateplaceholder:"Search your ideas...",modifyidealbl:"Modify your idea",sendidealbl:"Email your idea",sharedwith:"Shared with ",ideafyer:" Ideafyer",ideafyers:" Ideafyers",votebuttonlbl:"Vote",novotesyet:"No vote yet",onevote:"1 vote",votes:"votes",ideawrotelbl:" wrote : ",twocentcommentlbl:"commented :",youwrotelbl:"wrote :",theywrotelbl:"wrote :",youcommentedlbl:"commented :",youlbl:"You",hidetwocentreplies:"Hide replies",showonetcreply:"Reply",showtcrepliesbefore:"",showtcrepliesafter:" Replies",twocentreplycommentlbl:"replied :",yourepliedlbl:"replied :",addtwocentplaceholder:"Add your two cents",addtwocentreplyplaceholder:"Respond to this comment",twocentcreationdate:"Creation date: ",twocentmodificationdate:"Last modified: ",cancellbl:"Cancel",publishlbl:"Publish",titlefield:"Title field",descriptionfield:"Description field",solutionfield:"Solution field",emptyfielderror:" cannot be left empty",somethingwrong:"Something went wrong, please try again later",thankyou:"Thank you",loadingmessage:"Application loading, please wait...",maintenancemessage:"We're sorry. The server is currently unavailable. Please come back later.","library-ideas":"My Ideas","library-sessions":"My Ideafy Sessions",sbytitle:"Session title",sbydate:"Date",sbyidea:"Idea title",sbyscore:"Score",searchsessions:"Search previous sessions...",foundlbl:"Found",matchingsessions:"matching session(s)",noideayet:"---",completed:"completed",inprogress:"in progress",noscore:"no score yet",deletereplay:"This session has the Ideafy replay feature enabled. Are you sure you want to delete it?","library-decks":"My Ideafy decks",brainstormheadertitle:"Brainstorm",brainstormchoosemode:"Choose your Ideafy mode",continuesession:"Continue last session",quickbmode:"Quick mode session",quickstart:"Describe your session",quickstarthelp:"<h2>Why is this step important?</h2><p>Giving your session a name and other background information will make it easier to retrieve later on from your library. Besides, it's always interesting to keep track of the particular context in which ideas or other contents were generated. If you are setting up a multi-user session, this will provide important context information to invitees and may persuade them to join.</p>",quickstarttitle:"Name your session",quickstarttitleplaceholderpre:"",quickstarttitleplaceholderpost:"'s session",quickstartdesc:"Enter a description of your session",quickstartdescplaceholder:"Date, context, purpose, ...",nextbutton:"Next",finishbutton:"Ready",quicksetup:"Set up a situation",quicksetuphelp:"<h2>Setting the stage</h2><p>This step lets you setup a random situation. Draw and select one card of each of the following categories: character, context, problem. They will be the starting point of your session. You can zoom in on each card to get additional information, select a different one by clicking on the deck icon at the top or accept it (thumbs-up button).</p><p>Which is it going to be ? Will you let fortune decide what situation you are going to deal with or will you work the stacks until you get one you are comfortable with? Ideafy encourages you to pick random situations because they force you to think outside the box.</p><p>Note that when you start a <i>Custom session</i> you can specify one or more of your starting cards to address specific situations.</p>",credits:"Credits : ",source:"Source : ",dyknow:"Did you know ?",agelbl:" year old",hobbieslbl:"Leisure activities",interestslbl:"Centers of interest",commentslbl:"Comments",singlelbl:"single",marriedlbl:"married",divorcedlbl:"divorced",widowlbl:"widow",nochildlbl:"no children",onechildlbl:" child",childrenlbl:" children",siblingslbl:" siblings",onesiblinglbl:" sibling",quickscenario:"Write your story",quickscenariohelp:"<p>This is your <strong>whiteboard.</strong></p><p>Now is the time to show your creativity and imagination. The cards you just picked give you a scope, a set of directions to project your thoughts. Use them as hints but do not feel overly constrained: they are here to help you <strong>write your own story and describe your own use case</strong>.</p><p>Finding the problem to solve is often the most important step of an innovation. So get started and use the tools below to <strong>post any thought, drawing or picture that will help you focus on a story.</strong></p><br><p>When you are done, click on the <strong>ready</strong> button at the bottom to write up your story.</p>",choosecolorlbl:"Choose a color",importlbl:"Choose a picture",importpiclbl:"Choose a picture",importcameralbl:"Take a picture",pencilsizelbl:"Size",pencilcolorlbl:"Color",drawbgcolorlbl:"Background",cleardrawinglbl:"Clear",storytitleplaceholder:"Enter the title of your story",storydescplaceholder:"Tell your story, describe the problem your character is facing",storysolplaceholder:"How would you plan to fix this problem ?",quicktech:"Assign technologies",quicktechhelp:"<h2>Draw technologies</h2><p>The next phase of your session consists in finding a way to implement your solution using state of the art technologies. In this step you will draw three technology cards that you will try to include in your design.</p>",tech1lbl:"Techno 1",tech2lbl:"Techno 2",tech3lbl:"Techno 3",scenariolbl:"Scenario",storytitlelbl:"Your Story",cdtitlelbl:"Title : &nbsp",scenariodesclbl:"Scenario description",soldesclbl:"Solution description",quickidea:"Describe your idea",quickideahelp:"<p>Welcome back to your <strong>whiteboard.</strong></p><p>Your goal now is to try to apply the technologies that you just picked to design a solution to the use case described in your scenario.</p><p>Again do not feel too constrained: at this stage you can either alter your scenario to accomodate a technology, add additional technologies to the ones you have drawn to complete your solution or skip some of these if they do not fit in your design.</p><p>You are almost done: at the end of this step you will be able to refine your use case and turn it into an <strong>idea</strong>. You will be asked to provide a description in layman terms and also to describe how you would implement it with your chosen technologies.</p><br><p>When you are done, clik on the <strong>ready</strong> button at the bottom to write up your story.</p>",quickwrapup:"Summary",quickstepstart:"Session description",quickstepsetup:"Setup",quickstepscenario:"Scenario",quicksteptech:"Technologies",quickstepidea:"Solution",quickstepwrapup:"Summary",congratulations:"Congratulations !",sessioncompleted:"You successfully completed your Ideafy session",ideatitlelbl:"Your Idea",scenarioheader:"Scenario",scenariosolution:"Solution",ideadescription:"Idea description",ideaimplementation:"Technical implementation",yourtime:"Your time",yourscore:"Your score",musession:"Multi-user session",customsession:"Custom session",ideafytutorial:"ideafy tutorial","connect-contacts":"Contacts","connect-messages":"Messages","connect-twocents":"Two cents","dashboard-profile":"My profile","dashboard-settings":"Settings","dashboard-about":"About Ideafy",tolbl:"To : ",subjectlbl:"Subject : ",yourmessage:"Your message to ",sentok:" has been sent.",sentdocmsg:" sent you an Ideafy document",notavalidaddress:" is not a valid email address",norecipient:"No email address specified",sendlbl:"Send",sharelbl:"Share",msglistheadertitle:"My Messages",notificationlbl:"Notifications",allbtn:"View all",msgbtn:"Messages",notifbtn:"Notifications",unreadbtn:"Unread",searchmsgplaceholder:"Search ...",messageview:"Message panel",replyalllbl:"Reply all",forwardlbl:"Forward",deletelbl:"Delete",newmsg:"New message",cclbl:"Cc :",tocontactlbl:"Contact :",entersubjectlbl:"Please enter a subject",notavalidcontact:" is not a contact",messagesentok:"Your message has been sent",on:"On ",contactview:"Contact panel",contactlistheadertitle:"My Contacts",usrbtn:"Users",grpbtn:"Groups",newcontactlbl:"New contact",addcontactnow:"Add your contact now",lookup:"Or look up the Ideafy database",beforecount:"The <strong>Ideafy community</strong> now counts <strong>",aftercount:" <strong>users </strong> merrily crafting and exchanging ideas.<br>Look up your acquaintances and friends in the community and connect.",addcontactrightintro:"Building up your address book is the best and fastest way to increase exposure of your ideas and thoughts, but also to get access to a much broader content.",searchcontactplaceholder:"Enter email address of the person you wish to connect with ...",clearemailfirst:"Please clear the email field first",needbothfnln:"Both first and last names are required",selectcontact:"Select contact and press + to invite",noentryfound:"No matching entry in the database",cannotaddself:"You cannot add a connection to yourself",alreadyconnected:" is already a contact",alreadysentCXR:"You already sent a connection request to ",CXRobject:" wants to be a connection",CXRsent:"Your connection request has been sent",addamessage:"Add a message",accept:"Accept",reject:"Reject",acceptedCXR:" has accepted your connection request",rejectedCXR:" has declined your connection request",CXRaccepted:"Request accepted, ",CXRrejected:"Contact request rejected",isnowacontact:" is now a contact",isnolongeracontact:" is no longer a contact",canceledCX:" has canceled your connection",newfolderlbl:"New group",groupnamelbl:"Group name",groupdesclbl:"Group description",colortouch:"A colorful touch is always nice","char":"Character",context:"Context",problem:"Problem",grpcontacts:"Group contacts",addgrpcontacts:"Add contacts",nogrpname:"Please enter a group name",nogrpintro:"Please provide a group description",grpnameexists:"A group with this name already exists",nocontactselected:"Please add at least one contact to your group",profilelbl:"My Profile",aboutlbl:"About Ideafy",settingslbl:"Application parameters",completionprefix:"Your profile is ",completionsuffix:"% complete",info:"information",leaderboard:"leaderboard",enterbirthdate:"Provide your date of birth",entergender:"Indicate your gender",enterfamily:"Complete your family status",enteraddress:"Specify your address",enterintro:"Change your introduction",enteroccupation:"Describe your occupation",enterleisure:"Provide at least two leisure activities",enterinterest:"Provide at least two areas of interest",entersocialnw:"Add a social network",enterownpic:"Customize your avatar",completeprofile:"<i>Complete your profile</i>",mystatslbl:"My Stats",ideaslbl:"Public Ideas",sessionslbl:"Sessions",contactslbl:"Contacts",toquestionslbl:"Twoquestions",recentactivitylbl:"Recent Activity",enterednewidea:"You entered a new idea: ",reachedrank:"Congratulations ! You made a new rank :",gotaward:"You received an award : ",posted2q:"You posted a TwoQuestion :",commentedon:"You commented on : ",by:" by ",profileintro:"Profile introduction",shortprofiledesc:"Short profile description",day:"Day",dob:"Date of birth",jan:"January",feb:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December",year:"Year",mailaddress:"My Address",street:"Street",city:"City",state:"State",zip:"ZIP code",country:"Country",myfamily:"My Family",single:"Single",married:"Married",divorced:"Divorced",widow:"Widow",relation:"In a relationship",children:"Children",myoccupation:"My Occupation",student:"Student",active:"Active",retired:"Retired",unemployed:"Unemployed",stayathome:"Stay at home parent",jobtitle:"Job title",organization:"Organization",name:"Name",comment:"Comment",field:"Field",updatelbl:"Update",selectavatar:"Or select an avatar",uploadcomplete:"Upload complete",mynotes:"My Notes",writesomething:"Write something",stats:"Stats",achievements:"Achievements",decklistheadertitle:"My Decks",ideafypoints:" Ideafy Points",version:"Version : ",groupupdated:"Group updated",socialnwlbl:"Social networks",designedby:"Designed by : ",mtcheadertitle:"My Two Cents Wall",userpref:"User Preferences",brainstormsettings:"Brainstorm Settings",aboutIdeafy:"About Ideafy",faq:"FAQ",tutorials:"Tutorials",userguide:"User Guide",support:"Support",eula:"View License Agreement",page:"Page ",supportlegend:"A question or an issue?",supportplaceholder:"Enter your text and send",requestsent:"Thank you ! Your request has been sent",createquestion:"New TwoQuestion",questionplaceholder:"Enter your question",noquestion:"Please enter a question",lengthexceeded:"Maximum question length reached",characters:" characters",publicidealbl:"Public Idea",privateidealbl:"Private Idea",publicwarning:"<b>WARNING :</b> publishing your idea as a public one is irreversible. Visit Ideafy's dashboard to learn more.",uploadinprogress:"Upload in progress",notifyingcontacts:" Notifying contacts",askednew:" has asked a new TwoQuestion",melbl:"Me",nowconnected:" are now connected with ",noreplyyet:"No reply yet",mytwoquestions:"My TwoQuestions",mytwocents:"My Twocents",twoqprefix:"",twoqsuffix:"'s TwoQuestions",notwoqyet:"This Ideafyer has not posted any TwoQuestion yet",mytqdetailheader:"My TwoQuestion",tqheaderprefix:"",tqheadersuffix:"'s TwoQuestion",selecttq:"Select a contact to diplay TwoQuestions",mytwocentwall:"My Twocent Wall",sendtcprefix:"Send a Twocent to ",sendtcsuffix:"",twocentplaceholder:"Write your two cents",nomessage:"Please enter a message",sendinginprogress:"Sending in progress",senttc:" wrote you a new Twocent",selectall:"Select all",shareok:"Document shared successfully",signaturelbl:"Signature",sharing:"Sharing : ",messagecenter:"Message Center",twocentview:"Twocent Center",twocentcenter:"TwoQuestions & Twocents","about-taiaut":"About Taiaut",ideafydesc:"Look at Ideafy as your personal accelerator of ideas. You need ideas? Browse the database of ideas shared by other Ideafyers, ask your network or craft new ones using the embedded brainstorming engine. You have creative ideas? Ideafy makes it easy to share them with your network or to expose them to a community of innovative minds. Start discussions, ask questions or just give your two cents. Your Ideafyer friends want to find out what is on your mind. Ideation is fun. Get started and earn as many Ideafy Points and achievements as you can. Will you be the King of Ideas?",taiautdesc:"Taiaut was founded in May 2012 by three partners passionate about innovation and new technology. The aim of the company is to take advantage of leading edge communication technologies to advance creative ideas and best innovation practices globally. The company is headquartered in Boersch, France",solene:"Solène Troussé",oliviers:"Olivier Scherrer",olivierw:"Olivier Wietrich",vincent:"Vincent Weyl",contribsolene:"User interface design",contribscherrer:"Framework design and development",contribwietrich:"User Interface development and software packaging",contribvincent:"Application conception & lead developer","public":"Public wall",library:"My Library",brainstorm:"Brainstorming center",connect:"Communication Center",dashboard:"Dashboard",notips:"Do not show tips at startup",showtips:"Show tips at startup",shownotif:"Show notification popup",setlang:"Choose your language",choosestartup:"Choose your startup screen",usechar:"Allow my profile to be used as an Ideafy character (my name will not be shown)",changepwd:"Change password",changelbl:"Change",brainstormtutorial:"Brainstorming tutorial",twoway:"Support is a two-way street",supportusintro:"Ideafy is a free application and we intend to keep it that way. We are committed to bringing you the best experience. Here are a few things you can do to help us support you better:",asanideafyer:"As an Ideafyer",asanexec:"As a business executive",asadev:"As a developer",asaninvest:"As an investor",ideafyerhelp:"Tell us how you feel by rating the application. If you encounter an issue please use the form above and we will try to fix it speedily. All your feedback is welcome and really helps us improve Ideafy.",exechelp:'If you feel like your business could become even more innovative by using such a platform internally or with your partners, we do propose standalone deployments or dedicated instances. This will not be free but we offer ultra competitive conditions. Contact us with the form above or via our <a onclick=\'window.open("http://www.taiaut.com", "_system");\'>website</a>',devhelp:'Ideafy exists thanks to three javascript libraries written by the company partners. They are released under MIT licenses and are available here : <a onclick=\'window.open("http://github.com/flams/emily", "_system");\'>emily</a>, <a onclick=\'window.open("http://github.com/flams/olives", "_system");\'>olives</a> and <a onclick=\'window.open("http://http://github.com/flams/CouchDB-emily-tools", "_system");\'>couchdb-emily-tools</a>. Check them out and if you are up for it help us make them even better.',investhelp:"We have plenty of ideas to expand the Ideafy service and we are constantly looking for funding opportunities. If you are interested, want to find out about our future and be part of it please contact us.",toc:"Table of contents",backtotop:"Back to top",choosepolling:"Poll new public ideas",everymin:"Every minute",everyfive:"Every 5 minutes",everyfifteen:"Every 15 minutes",never:"Disabled",nointernet:"Your device is not connected: please check your Internet access and try again.",schedmaintenance:"Scheduled maintenance",nextmaintenance:"The next maintenance will take place on : ",startnewmub:"Start a new session",joinmub:"Join a session",selectmode:"Select mode",roulette:"Roulette",campfire:"Campfire",boardroom:"Boardroom",rouletteinfo:"Any other Ideafyer may join this session",campfireinfo:"Anyone from your contact list may join this session (no notification)",boardroominfo:"Invitation only: invited contacts are notified and may join this session",clear:"Clear",create:"Create",nofriendtoinvite:"No contact to invite: please add contacts to your list or select an other mode",inviteatleastone:"You must select at least one contact to invite",providesessioninfo:"You must enter a meaningful title and description",sendinginvites:"Sending invitations...",invitesent:"Invitations sent",INVObject:" invited you to an Ideafy session",nolongerjoin:"You can no longer join this session : it is already underway or completed.",clicktojoin:"Push the button below to join session.",selectsession:"Select a session",participantleave:"Are you sure you want to leave? You will not be able to re-join nor will you get credited for any outcome  of the session",leaderleave:"Are you sure you want to cancel this session? This will end it for all participants.",canceledbyleader:"Session canceled by leader: ending now",participantsleft:"All participants have left: the session is canceled",waitingroomlbl:"Waiting room",joinedsession:"<i>You joined this session.</i>",deletingsession:"Deleting session : ",participants:"Participants",startbutton:"Start",joinbutton:"Join",nosessionfound:"No session found",allmodes:"All modes",all:"All",mode:"Mode",lang:"Lang",title:"Title",leader:"Session leader",sessionfull:"The session is full",sessionstarted:"This session is already started",sessiondeleted:"This session has been canceled",chatmsg0:" has initiated the session",chatmsg1:" has joined the session",chatmsg2:" has left the session",chatmsg3:" has canceled the session",chatmsg4:"Your session is starting now",chatmsg5:"Beginning new step : ",chatmsg6:"This concludes the current step. Moving on to the next screen...",typemsg:"Enter your text",said:" said :",noresult:"No result found",clicktoview:"Press the button below or visit your library to view",skiplbl:"Skip",submitlbl:"Submit",decidemsg:"Decide how you want to share your work",unanimity:"(unanimity is required)",setpublic:"Make the idea public",enablereplay:"Enable session replay",yeslbl:"Yes",nolbl:"No",accepted:"ACCEPTED",rejected:"REJECTED"},lang:"en-us",labels:new e({})})},this.reset(),a}),define("service/utils",["service/config","Observable","Promise","LocalStore"],function(e,t,n,r){return{formatDate:function(e){var t=e[1]+1;return t<10&&(t="0"+t),e[2]+"/"+t+"/"+e[0]},formatDuration:function(e){var t,n,r,i,s,o;return e?(t=Math.round(e/1e3),n=Math.floor(t/86400),r=Math.floor(t%86400/3600),i=Math.floor(t%86400%3600/60),s=Math.floor(t%86400%3600%60),n>0?o=n+"d ":o="",r>0?o+=r+":":o+="",i>0?o+=(r>0&&i<10?"0":"")+i+":":o+="0:",s<10?o+="0"+s:o+=s):o="",o},formatTime:function(e){var t=new Date(e),n=t.getHours(),r=t.getMinutes(),i=t.getSeconds(),s="";return s+=n+":",r>0?s+=(n>0&&r<10?"0":"")+r+":":s+="00:",i<10?s+="0"+i:s+=i,s},displayFirstSentence:function(e,t){var n=[];return n=t.split("."[0],1),n[0].length>140&&(e.innerHTML=n[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")),e.innerHTML},truncate:function(e,t){e.innerHTML=t;while(e.scrollHeight>e.offsetHeight){var n=e.innerHTML;e.innerHTML=n.replace(/\W*\s(\S)*$/,"...")}return e.innerHTML},setRating:function(e,t){var n="<img src = 'img/wall/disableIdeaVote.png'>",r="<img src = 'img/wall/semi-activeIdeaVote.png'>",i="<img src = 'img/wall/activeIdeaVote.png'>",s="",o;if(!t)for(o=0;o<5;o++)s+=n;else{o=0;while(o<Math.floor(t))s+=i,o++;o<5&&(Math.round(t-Math.floor(t))?s+=r:s+=n,o++);while(o<5)s+=n,o++}e.innerHTML=s},searchArray:function(t,n){var r=n.toLowerCase().split(" "),i=[],s,o,u,a;for(s=0,l=t.length;s<l;s++){u=JSON.stringify(t[s]).toLowerCase(),a=0;for(o=0;o<r.length;o++){if(!(u.search(r[o])>-1))break;a++}a===r.length&&i.push(t[s])}return i},sortByProperty:function i(e,t,n){switch(t){case"idea":e.sort(function(e,r){var s=e[t],o=r[t],u,a;return n?(!!s&&s instanceof Array&&!!s.length?(i(s,"title",!0),u=s[0].title):u="",!!o&&o instanceof Array&&!!o.length?(i(o,"title",!0),a=o[0].title):a="",u<a?1:u>a?-1:0):(!!s&&s instanceof Array&&!!s.length?(i(s,"title",!1),u=s[0].title):u="",!!o&&o instanceof Array&&!!o.length?(i(o,"title",!1),a=o[0].title):a="",u<a?-1:u>a?1:0)});break;case"date":e.sort(function(e,r){var i=e[t],s=r[t],o=new Date(i[0],i[1],i[2]),u=new Date(s[0],s[1],s[2]);return n?o<u?1:o>u?-1:0:o<u?-1:o>u?1:0});break;default:e.sort(function(e,r){var i=e[t],s=r[t];return typeof i=="string"||typeof s=="string"?(i&&i.toLowerCase&&(i=i.toLowerCase()),s&&s.toLowerCase&&(s=s.toLowerCase()),n?i<s?1:i>s?-1:0:i<s?-1:i>s?1:0):n?i<s?1:i>s?-1:0:i<s?-1:i>s?1:0})}},uploadFile:function(t,n,r,i){var s=new XMLHttpRequest;s.open("POST",e.get("location")+t),s.onreadystatechange=function(){s.readyState===4&&i&&i(s)},s.upload.onprogress=function(e){e.lengthComputable&&r&&r.set("status",Math.round(e.loaded/e.total*100))},s.send(n)},checkServerStatus:function(){var t=new n,r=new XMLHttpRequest;return r.open("GET",e.get("location")),r.onreadystatechange=function(){r.readyState===4&&(r.status===200?t.fulfill():t.reject())},r.send(),t},checkSocketStatus:function(){var t=e.get("socket");t.socket.connected||(t.socket.connect(e.get("location")),e.get("observer").notify("reconnect"))},disconnectSocket:function(){e.get("socket").socket.disconnect(),e.get("observer").notify("disconnect")},updateLabels:function(t){var i={lang:t},s=new r,o=e.get("labels"),u=new n;return s.sync("ideafy-data"),e.get("transport").request("Lang",i,function(t){t==="nok"?(s.set("labels",e.get("defaultLabels")),e.set("lang","en-us")):(s.set("labels",t),e.set("lang",t.language)),s.sync("ideafy-data"),o.reset(s.get("labels")),u.fulfill()}),u},getAvatarById:function(t){var i=new n,s=new r,o=e.get("avatars");if(o.get(t)&&o.get(t)!=="in progress")i.fulfill(o.get(t));else{if(o.get(t)!=="in progress")return o.set(t,"in progress"),e.get("transport").request("GetAvatar",{id:t},function(e){if(e.error)i.reject();else{if(o.getNbItems()<100)o.set(t,e);else{var n=o.toJSON(),r=n.keys();o.del(r[0]),o.set(t,e)}i.fulfill(e)}}),i;o.watchValue(t,function(e){e&&e!=="in progress"&&(o.unwatch(t),i.fulfill(e))})}},getAvatarByFileName:function(t,n){e.get("transport").request("GetAvatar",{file:t},function(e){n(e)})},getGrade:function(t,n){var r=e.get("transport"),i=e.get("user");r.request("GetGrade",{ip:t,lang:i.get("lang")},function(e){n(e)})},getAchievements:function(t,n){var r=e.get("transport"),i=e.get("user");r.request("GetAchievements",{userid:t,lang:i.get("lang")},function(e){n(e)})},getUserDetails:function(t,n){var r=e.get("transport");r.request("GetUserDetails",{userid:t},function(e){n(e)})},getUserContactIds:function(){var t=[],n=e.get("user").get("connections");return n.forEach(function(e){e.type==="user"&&t.push(e.userid)}),t},checkProfileCompletion:function(){var t=e.get("user"),n=e.get("labels"),r={percentage:0,missing:[]};return t.get("firstname")&&t.get("lastname")&&(r.percentage+=10),t.get("birthdate").length===3?r.percentage+=10:r.missing.push(n.get("enterbirthdate")),t.get("family").couple!==null&&t.get("family").children!==null?r.percentage+=10:r.missing.push(n.get("enterfamily")),t.get("address").city&&t.get("address").country?r.percentage+=10:r.missing.push(n.get("enteraddress")),t.get("intro")&&t.get("intro")!=="Ideafyer"?r.percentage+=10:r.missing.push(n.get("enterintro")),t.get("occupation").situation>=0&&t.get("occupation").job&&t.get("occupation").organization?r.percentage+=10:r.missing.push(n.get("enteroccupation")),t.get("leisure_activities")[0].name&&t.get("leisure_activities")[1].name?r.percentage+=10:r.missing.push(n.get("enterleisure")),t.get("interests")[0].name&&t.get("interests")[1].name?r.percentage+=10:r.missing.push(n.get("enterinterest")),t.get("twitter")||t.get("facebook")||t.get("gplus")||t.get("linkedin")?r.percentage+=10:r.missing.push(n.get("entersocialnw")),t.get("picture_file").search("img/avatars/deedee")<0?r.percentage+=10:r.missing.push(n.get("enterownpic")),r},stringToBytes:function(e){var t,n,r=[],i,s=0,o;for(i=0;i<e.length;i++){t=e.charCodeAt(i);if(t<127)r[s++]=t&255;else{n=[];do n.unshift(t&255),t>>=8;while(t);for(o=0;o<n.length;o++)r[s++]=n[o]}}return r},changeStyle:function(e){var t=document.querySelector(".currentStyle"),n=t.getAttribute("href");n!=="css/"+e&&t.setAttribute("href","css/"+e)},exitListener:function(e,t){var n=function(n){var r;for(r=n.target;r;r=r.parentNode)if(r.id===e)return;!n.target.classList.contains("deedee")&&!n.target.classList.contains("notify-header")&&n.target.id!=="dock"&&!n.target.classList.contains("close-help")&&(n.stopPropagation(),t(n.target))};return document.addEventListener("mousedown",n,!0),n}}}),define("service/avatar",["OObject","Bind.plugin","Event.plugin","service/config","Store","service/utils"],function(e,t,n,r,i,s){function o(e){var o=new i,u=r.get("avatars"),a=e[0];this.plugins.addAll({avatar:new t(o,{setStyle:function(e){e&&e!=="in progress"&&this.setAttribute("style","background-image: url('"+e+"');")}}),event:new n(this)}),this.template='<div class="avatar" data-avatar="bind: setStyle, img"></div>',e.length>1?o.set("img","img/avatars/deedee6.png"):a===r.get("user").get("_id")?(o.set("img",r.get("avatar")),r.watchValue("avatar",function(){o.set("img",r.get("avatar"))})):a==="ideafy@taiaut.com"||a==="IDEAFY"?o.set("img","img/avatars/doctordeedee.png"):u.get(a)?u.get(a)==="in progress"?u.watchValue(a,function(e){e&&e!=="in progress"&&o.set("img",e)}):o.set("img",u.get(a)):s.getAvatarById(a).then(function(e){o.set("img",u.get(a))})}return function(n){return o.prototype=new e,new o(n)}}),define("twocents/writetwocent",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils"],function(e,t,n,r,i,s){return function(u){var a=new e,f=t.get("user"),l=t.get("transport"),c=new Date,h=new i({author:f.get("_id"),message:"",firstname:f.get("firstname"),date:[c.getFullYear(),c.getMonth(),c.getDate()],datemod:"",plusones:0,replies:[]}),p,d,v=u||"public",m="new",g=0;return a.plugins.addAll({twocent:new n(h,{date:function(e){e&&(this.innerHTML=s.formatDate(e))},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new n(t,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),labels:new n(t.get("labels")),twocentevent:new r(a)}),a.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: mousedown, press; listen: mouseup, publish">Publish</div></div></div>',a.reset=function(t,n,r,i){var s=new Date,o={author:f.get("_id"),message:"",firstname:f.get("firstname"),date:"",datemod:"",plusones:0,replies:[]};t&&(p=t),n?(h.reset(n),m=n,g=r,h.set("datemod",[s.getFullYear(),s.getMonth(),s.getDate()])):(h.reset(o),h.set("date",[s.getFullYear(),s.getMonth(),s.getDate()]),m="new"),i&&(d=i)},a.cancel=function(e,t){t.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),d?d():document.getElementById(v+"-writetwocents").classList.add("invisible")},a.publish=function(e,n){n.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;");if(h.get("message")){var r=JSON.parse(h.toJSON()),i,s;m==="new"?s="new":s="edit",i={docId:p,type:s,position:g,twocent:r},l.request("WriteTwocent",i,function(e){e!=="ok"?alert(t.get("labels").get("somethingwrong")):(m==="new"?document.getElementById(v+"-writetwocents").classList.add("invisible"):d(),a.reset(p))},a)}},a.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")},a}}),define("twocents/writetwocentreply",["OObject","Store","Bind.plugin","Event.plugin","service/config","service/utils"],function(e,t,n,r,i,s){function o(e){var o=i.get("user"),u=i.get("transport"),a,f,l,c,h=new Date,p,d={author:o.get("_id"),message:"",firstname:o.get("firstname"),date:"",datemod:"",plusones:0},v=new t(d);this.plugins.addAll({model:new n(v,{date:function m(m){this.innerHTML=s.formatDate(m)}}),config:new n(i,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),writereplyevent:new r(this),labels:new n(i.get("labels"))}),this.template='<div class="writeTwocent writeTwocentReply"><div class="replyAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText replyMessage" data-labels="bind: placeholder, addtwocentreplyplaceholder" data-model="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-model="bind: date, date"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, publish;">Publish</div></div></div>',this.reset=function(e,t,n,r,i,s){var o=new Date;e&&t&&(a=e,f=t),i?c=i:c="",n?(v.reset(n),editTCR=n,l=r,v.set("datemod",[o.getFullYear(),o.getMonth(),o.getDate()])):(v.reset(d),v.set("date",[o.getFullYear(),o.getMonth(),o.getDate()]),editTCR="newreply"),p=s},this.cancel=function(t,n){n.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),v.reset(d),p?p():e.classList.add("invisible")},this.publish=function(t,n){n.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;");if(v.get("message")){var r=JSON.parse(v.toJSON()),s,o;editTCR==="newreply"?o=editTCR:o="editreply",c&&(r.message="@ "+c+" : "+r.message),s={docId:a,type:o,position:l,twocent:f,reply:r},u.request("WriteTwocent",s,function(t){t!=="ok"?alert(i.get("labels").get("somethingwrong")):e.classList.add("invisible")})}},this.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")}}return function(n){return o.prototype=new e,new o(n)}}),define("twocents/twocentreplylist",["OObject","Store","Bind.plugin","Event.plugin","service/utils","service/config","twocents/writetwocentreply","service/avatar"],function(e,t,n,r,i,s,o,u){function a(e,a,f,l){var c=new t(e),h=this,p,d=s.get("user"),v=s.get("labels"),m=s.get("transport");h.plugins.addAll({reply:new n(c,{date:function g(g){g&&(this.innerHTML=i.formatDate(g))},setFirstname:function(e){var t=this.getAttribute("data-reply_id");this.innerHTML=e,c.get(t).author===d.get("_id")&&(this.innerHTML=v.get("youlbl"))},setReplylbl:function(e){var t=this.getAttribute("data-reply_id");this.innerHTML=v.get("twocentreplycommentlbl"),c.get(t).author===d.get("_id")&&(this.innerHTML=v.get("yourepliedlbl"))},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u([t]);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setVisible:function(e){e&&e===d.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")},setInVisible:function(e){e&&e===d.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;")}}),replyevent:new r(h),labels:new n(v)}),h.template='<ul class="replies" data-reply="foreach"><li class="twocentReply"><div class="twocentHeader"><div class="replyAvatar" data-reply="bind:setAvatar, author"></div><div class="twocentAuthor" data-reply="bind: setFirstname, firstname"></div><span class="commentLabel" data-labels="bind: setReplylbl, firstname"></span><br/><div class="twocentDate date" data-reply="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, deleteTwocentReply"></div><div class="twocentButton twocentReplyButton" data-reply="bind: setInVisible, author" data-replyevent="listen:mousedown, reply"></div></div></div><p class="twocentMessage replyMessage" data-reply="bind: innerHTML, message"></p><div class="writePublicTwocentReply replyToReply invisible"></div></li></ul>',h.edit=function(t,n){var r=n.getAttribute("data-reply_id"),i=h.dom.children[r],s=new o,u=function(){h.dom.replaceChild(i,s.dom)},l=document.createDocumentFragment();s.reset(a,f,e[r],r,null,u),s.render(),s.place(l),h.dom.replaceChild(l,i),UI=h.dom},h.deleteTwocentReply=function(e,t){var n=t.getAttribute("data-reply_id"),r={docId:a,type:"deltcreply",twocent:f,position:n};m.request("WriteTwocent",r,function(e){e!=="ok"&&alert(s.get("labels").get("somethingwrong"))})},h.reply=function(t,n){var r=n.getAttribute("data-reply_id"),i=document.querySelector(".twocent[data-twocents_id='"+f+"']"),s=i.querySelector(".writePublicTwocentReply[data-reply_id='"+r+"']"),u=document.createDocumentFragment(),l=new o(s);l.reset(a,f,null,r,e[r].firstname),l.render(),l.place(u),s.hasChildNodes()||s.appendChild(u),s.classList.remove("invisible")}}return function(n,r,i,s){return a.prototype=new e,new a(n,r,i,s)}}),define("twocents/twocentlist",["OObject","service/config","CouchDBDocument","Store","Promise","service/utils","Bind.plugin","Event.plugin","twocents/twocentreplylist","twocents/writetwocent","twocents/writetwocentreply","service/avatar"],function(e,t,n,r,i,s,o,u,a,f,l,c){function h(e){var h=this,p=new n,d=t.get("labels"),v=new r([]),m=t.get("transport"),g=t.get("user"),y,b=e;p.setTransport(m),h.plugins.addAll({labels:new o(t.get("labels")),twocents:new o(v,{date:function w(w){w&&(this.innerHTML=s.formatDate(w))},setFirstName:function(e){var n;e&&(e!==g.get("firstname")?this.innerHTML=e:(n=this.getAttribute("data-twocents_id"),v.get(n).author===g.get("_id")?this.innerHTML=t.get("labels").get("youlbl"):this.innerHTML=e))},setCommentlbl:function(e){var t;e&&(e!==g.get("firstname")?this.innerHTML=d.get("twocentcommentlbl"):(t=this.getAttribute("data-twocents_id"),v.get(t).author===g.get("_id")?this.innerHTML=d.get("youcommentedlbl"):this.innerHTML=d.get("twocentcommentlbl")))},setVisible:function(e){e&&(e===g.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},setInVisible:function(e){e&&(e===g.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;"))},deleteOK:function(e){var t;e&&e.length>0?this.setAttribute("style","display: none;"):(t=this.getAttribute("data-twocents_id"),g.get("_id")===v.get(t).author?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},toggleHideButton:function(e){!e||!e.length?this.classList.add("invisible"):(this.classList.remove("invisible"),e.length===1?this.innerHTML=t.get("labels").get("showonetcreply"):this.innerHTML=t.get("labels").get("showtcrepliesbefore")+e.length+t.get("labels").get("showtcrepliesafter"))},displayReplies:function(e){var t,n,r;!e||!e.length?this.classList.add("invisible"):(t=this.getAttribute("data-twocents_id"),n=new a(e,y,t,b),r=document.createDocumentFragment(),n.render(),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r),this.classList.remove("invisible"))},setAvatar:function(t){var n,r;t&&(n=document.createDocumentFragment(),r=new c([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))}}),twocentevent:new u(h)}),h.template='<ul class="twocentList" data-twocents="foreach"><li class="twocent"><div class="twocentHeader"><div class="twocentAvatar" data-twocents="bind: setAvatar, author"></div><div class="twocentAuthor"data-twocents="bind: setFirstName, firstname"></div><span class="commentLabel" data-twocents="bind: setCommentlbl, firstname"></span><br/><div class="twocentDate date" data-twocents="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-twocents="bind: setVisible, author" data-twocentevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-twocents="bind: deleteOK, replies" data-twocentevent="listen: mousedown, deleteTwocent"></div><div class="twocentButton twocentReplyButton" data-twocents="bind: setInVisible, author" data-twocentevent="listen: mousedown, reply"></div></div></div><div class="twocentBody"><p class="twocentMessage" data-twocents="bind: innerHTML, message"></p><div class="repliesButton hideReplies" name="hide" data-twocents="bind: toggleHideButton, replies" data-twocentevent="listen: mousedown, toggleReplies" data-labels="bind:innerHTML, hidetwocentreplies"></div></div><div class="writePublicTwocentReply invisible"></div><div class="displayReplies" data-twocents="bind: displayReplies, replies"></div></li></ul>',h.edit=function(e,t){var n=t.getAttribute("data-twocents_id"),r=h.dom.children[n],i=new f,s=document.createDocumentFragment(),o=function(){h.dom.replaceChild(r,i.dom)};i.reset(y,v.get(n),n,o),i.render(),i.place(s),h.dom.replaceChild(s,r)},h.reset=function(n){var r=new i;return y=n,v.reset([]),p.unsync(),p.reset({}),p.sync(t.get("db"),y).then(function(){var e=p.get("twocents");e.length&&v.reset(p.get("twocents")),p.watchValue("twocents",function(e){v.reset(e)}),r.fulfill()},function(e){console.log(e)}),r},h.deleteTwocent=function(e,n){var r=n.getAttribute("data-twocents_id"),i={docId:y,type:"delete",position:r,twocent:{author:g.get("_id")}};alert("Are you sure?"),m.request("WriteTwocent",i,function(e){e!=="ok"&&alert(t.get("labels").get("somethingwrong"))})},h.reply=function(e,t){var n=t.getAttribute("data-twocents_id"),r=document.querySelector(".writePublicTwocentReply[data-twocents_id='"+n+"']"),i=new l(r),s=document.createDocumentFragment();i.reset(y,n),i.render(),i.place(s),r.hasChildNodes()||r.appendChild(s),r.classList.remove("invisible")},h.toggleReplies=function(e,t){var n=t.getAttribute("data-twocents_id"),r=v.get(n).replies,i=t.getAttribute("name"),s=document.querySelector(".displayReplies[data-twocents_id='"+n+"']");i==="show"?(s.classList.remove("invisible"),t.setAttribute("name","hide"),t.classList.remove("showReplies"),t.classList.add("hideReplies")):(s.classList.add("invisible"),t.setAttribute("name","show"),t.classList.remove("hideReplies"),t.classList.add("showReplies"))}}return function(n){return h.prototype=new e,new h(n)}}),define("public/detail-stack/public-idea",["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(v){var m=new e,g=new a,y=new f("public"),b=u.get("labels"),w=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),E=!1,S=u.get("user"),x=u.get("transport"),T=new h,N=i.get("public-detail"),C,k=new l;return T.setTransport(x),m.plugins.addAll({label:new n(b),publicdetail:new n(T,{toggleRateEdit:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#public-edit"):this.setAttribute("href","#public-favorites")},toggleTwocentShare:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#public-share"):this.setAttribute("href","#public-2cents")},displayWriteTwocent:function(e){e.indexOf(S.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("public-writetwocents").classList.add("invisible")},date:function L(L){L&&(this.innerHTML=s.formatDate(L))},setAuthor:function(e){e===S.get("username")&&T.get("authors").indexOf(S.get("_id"))>-1?this.innerHTML=b.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e.length===1&&e[0]===S.get("_id")?this.innerHTML=b.get("youwrotelbl"):e.length>1?this.innerHTML=b.get("theywrotelbl"):this.innerHTML=b.get("ideawrotelbl")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new o(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setRating:function(t){t.length===0?this.innerHTML="":this.innerHTML=Math.round(t.reduce(function(e,t){return e+t})/t.length*100)/100},setDescription:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},setSolution:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=T.get("_id"),n=T.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),S.get("rated_ideas").indexOf(t)<0&&n.indexOf(S.get("_id"))<0&&!E?(this.setAttribute("name","vote"),this.innerHTML=b.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(E=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),e.length===0?this.innerHTML="("+b.get("novotesyet")+")":e.length===1?this.innerHTML="("+b.get("onevote")+")":this.innerHTML="("+e.length+" "+b.get("votes")+")",this.classList.add("votes"))}}),vote:new n(w,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new p({PublicTwocentUI:y}),publicdetailevent:new r(m)}),m.template='<div class="public-idea"><div class="header blue-dark"><a href="#public-2cents" data-publicdetail="bind: toggleTwocentShare, authors" data-publicdetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, publicdetailsheadertitle"></span><a href="#public-favorites" data-publicdetail="bind: toggleRateEdit, authors" data-publicdetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-publicdetail="bind:setAvatar, authors"></div><h2 data-publicdetail="bind:innerHTML,title"></h2><span class="date" data-publicdetail="bind:date, creation_date"></span><br><span class="author" data-publicdetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-publicdetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><p data-publicdetail="bind:setDescription,description"></p><p data-publicdetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class ="rateIdea"><a class="item-acorn"></a><div class="rating" data-publicdetail="bind:setRating,votes"></div><div class="publicButton" data-publicdetail="bind:toggleVoteButton, votes" name="vote" data-publicdetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-publicdetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="public-writetwocents" class="invisible" data-publicdetail="bind: displayWriteTwocent, authors"></div><div id="public-twocents" class="twocents" data-publicdetail="bind: displayTwocentList, twocents" data-place="place: PublicTwocentUI"></div></div>',m.showCache=function(){m.dom.querySelector("#idea-cache").classList.remove("invisible")},m.hideCache=function(){m.dom.querySelector("#idea-cache").classList.add("invisible")},m.reset=function(t,n){var r=t.get(n).id,i=new c;return w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),m.getIdea(r).then(function(){E=!1,g.reset(T.get("_id")),y.reset(T.get("_id")),C=document.getElementById("public-writetwocents"),g.place(C),i.fulfill()}),i},m.getIdea=function(t){return T.unsync(),T.reset(),T.sync(u.get("db"),t)},m.action=function(e,t){var n=t.getAttribute("href");n==="#public-2cents"?(g.reset(T.get("_id")),C.classList.remove("invisible")):v(n)},m.edit=function(){_stack.getStack().show("#public-edit")},m.press=function(e,t){t.classList.add("pressed")},m.vote=function(e,t){E||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},m.previewVote=function(e,t){var n=0,r=t.getAttribute("data-vote_id");w.loop(function(e,t){t<=r?w.update(t,"active",!0):w.update(t,"active",!1)})},m.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,r=T.get("_id"),i={id:r,vote:n,voter:S.get("_id")};E||(E=!0,x.request("Vote",i,function(e){var t=S.get("rated_ideas")||[];e!=="ok"?(console.log(e,"something went wrong, please try again later"),E=!1):(t.unshift(r),S.set("rated_ideas",t),alert(u.get("labels").get("thankyou")),u.get("observer").notify("update-polling"),document.getElementById("ratingPopup").classList.remove("appear"),w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},m.place(N),m}}),define("service/confirm",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){function o(e,o,u,a){var f=i.get("labels"),l=this,c=new s({question:o}),h=u;l.plugins.addAll({label:new n(f),confirm:new n(c),confirmevent:new r(this)}),l.template='<div class = "confirm"><div class="help-doctor"></div><p class="confirm-question" data-confirm="bind:innerHTML,question"></p><div class="option left" data-confirmevent="listen:mousedown, press; listen:mouseup, ok" data-label="bind: innerHTML, continuelbl">Continue</div><div class="option right" data-confirmevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl">Cancel</div></div>',l.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},l.ok=function(e,n){n.classList.remove("pressed"),t.get("cache").classList.remove("appear"),h&&h(!0)},l.cancel=function(e,n){n&&n.classList.remove("pressed"),t.get("cache").classList.remove("appear"),h&&h(!1)},l.close=function(){t.get("cache").classList.remove("appear"),e&&e.removeChild(e.lastChild)},l.hide=function(){t.get("cache").classList.remove("appear"),l.dom.classList.add("invisible")},l.show=function(){t.get("cache").classList.add("appear"),l.dom.classList.remove("invisible")},l.reset=function(t,n){c.set("question",t),h=n},l.render(),e&&l.place(e),a&&l.dom.classList.add(a),o?c.set("question",o):l.hide(),setTimeout(function(){l.close},15e3)}return function(n,r,i,s){return o.prototype=new e,new o(n,r,i,s)}}),define("public/detail-stack/public-edit",["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new r,p=o.get("labels"),d=new n({error:""}),v;return h.setTransport(o.get("transport")),c.plugins.addAll({editlabel:new i(p),editidea:new i(h,{setVisibility:function(e){e==="public"?this.innerHTML=p.get("publiclbl"):this.innerHTML=p.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=p.get("enabledreplaylbl"):this.innerHTML=p.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=p.get("disablereplaylbl"):this.innerHTML=p.get("enablereplaylbl")}}),editevent:new s(c),errormsg:new i(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;case"nosol":this.innerHTML=p.get("solutionfield")+p.get("emptyfielderror");break;default:this.innerHTML=""}}})}),c.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl">Modify your idea</span></div><form class="form"><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, upload">Publish</label><label class="cancel pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, cancel">Cancel</label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',c.place(t.get("public-edit")),c.reset=function(t){h.unsync(),h.reset(),h.sync(o.get("db"),t),v=!1},c.editVisibility=function(e,t){var n=new u(t,p.get("setpublicquestion"),function(e){e?h.set("visibility","public"):h.set("visibility","private"),n.close()})},c.press=function(e,t){t.classList.add("pressed")},c.enableReplay=function(e,t){setTimeout(function(){h.get("sessionReplay")?h.set("sessionReplay",!1):h.set("sessionReplay",!0),v=!0,t.classList.remove("pressed")},300)},c.updateSessionReplay=function(t){var n=new a,i=new r;return i.setTransport(o.get("transport")),i.sync(o.get("db"),h.get("sessionId")).then(function(){var e=i.get("replayIdeas")||[],n;if(t)e.push(h.get("_id"));else for(n=e.length-1;n>=0;n--)e[n]===h.get("_id")&&e.splice(n,1);return i.set("replayIdeas",e),i.upload()}).then(function(){n.fulfill(),i.unsync()}),n},c.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];h.get("title")===""?d.set("error","notitle"):h.get("description")===""?d.set("error","nodesc"):h.get("solution")===""?d.set("error","nosol"):(h.set("modification_date",r),h.upload().then(function(){v&&c.updateSessionReplay(h.get("sessionReplay")).then(null,function(e){console.log(e)}),l("close")})),t.classList.remove("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),l("close")},c}}),define("public/detail-stack/public-sendmail",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new o({errormsg:""}),d=n.get("user"),v=n.get("transport"),m=n.get("labels"),g=new o({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:!1});return h.plugins.addAll({labels:new r(m),mail:new r(g,{setUserAvatar:function(e){e&&this.setAttribute("style","background: url('"+n.get("avatar")+"') no-repeat center center;")},date:function y(y){y&&(this.innerHTML=a.formatDate(y))},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setRating:function(e){},setVotes:function(e){}}),mailevent:new s(h),errormsg:new r(p)}),h.template='<div class="idea-sendmail"><div class="header blue-dark"><a href="#public-2cents" class="option left"></a><span data-labels="bind:innerHTML, sendidealbl"></span><a href="#public-favorites" class="option right"></a></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment. votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',h.place(t.get("public-sendmail")),h.reset=function(t){p.reset({errormsg:""}),g.reset({toField:"",from:d.get("username"),subject:"",body:"",signature:d.get("username")+" <"+d.get("_id"),attachment:t,sent:!1}),d.get("signature")&&g.set("signature",d.get("signature")),json={}},h.validateAddress=function(t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,r=t.toLowerCase().split(/,|;/),s=!0;for(i=0,l=r.length;i<l;i++)if(!n.test(r[i].trim())){p.set("errormsg",r[i]+m.get("notavalidaddress")),s=!1;break}return s},h.validateMessage=function(){return g.get("toField")?h.validateAddress(g.get("toField")):p.set("errormsg",m.get("norecipient")),p.get("errormsg")===""},h.sendMail=function(){json.type="doc",json.recipient=g.get("toField"),json.cc=d.get("_id"),json.replyTo=d.get("_id"),json.subject=d.get("username")+m.get("sentdocmsg"),json.header=g.get("subject"),json.body=g.get("body"),json.signature=g.get("signature"),json.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+g.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+g.get("attachment").authornames+", <span style='color:black';>"+a.formatDate(g.get("attachment").creation_date)+"</span></p></div>",json.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").solution+"</p></div>",v.request("SendMail",json,function(e){e.sendmail==="ok"?(p.set("errormsg",m.get("yourmessage")+e.recipient+m.get("sentoklbl")),setTimeout(function(){c("close")},350)):(p.set("errormsg",m.get("somethingwrong")),g.set("sent",!1),console.log("error",e.error),console.log("response",e.response))})},h.press=function(e,t){(!t.classList.contains("sendmail")||!g.get("sent"))&&t.classList.add("pressed")},h.send=function(e,t){g.get("sent")||(g.set("sent",!0),p.set("errormsg",""),t.classList.remove("pressed"),h.validateMessage()?h.sendMail():g.set("sent",!1))},h.cancel=function(e,t){t.classList.remove("pressed"),c("close")},h}}),define("service/autocontact",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,s,o){function u(e,t,u){var a=this,f=s.get("user"),c=!1,h=new o([]);a.plugins.addAll({auto:new n(h,{setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")},setType:function(e){e==="group"?this.classList.add("group"):this.classList.remove("group")}}),select:new r(a)}),a.template='<div class = "autocontact"><div class="autoclose" data-select="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:setType, type; bind:setSelected, selected" data-select="listen:mousedown, select"></li></ul></div>',a.init=function(){var n=f.get("connections"),r=[],s=[],o={};h.reset([]);for(i=0,l=n.length;i<l;i++)r.push(n[i].username),o[n[i].username]=n[i].type;r.sort().forEach(function(e){h.alter("push",{username:e,type:o[e]})});if(t.value){s=t.value.split(/,|;/);for(i=0,l=s.length;i<l;i++)s[i]=s[i].trim()}h.loop(function(e,t){s.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})},a.updateList=function(){var n,r,s=[],o={};if(t.value){c=!0,n=t.value.split(/,|;/),r=n[n.length-1].trim().toLowerCase(),h.reset([]),f.get("connections").forEach(function(e){e.username.toLowerCase().search(r)===0&&h.alter("push",{username:e.username,type:e.type})});if(t.value){currentList=t.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++)currentList[i]=currentList[i].trim()}h.loop(function(e,t){currentList.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})}},a.close=function(t,n){t.stopPropagation(),e.classList.add("invisible")},a.select=function(e,t){var n=t.getAttribute("data-auto_id"),r=h.get(n).selected;h.update(n,"selected",!r),r?a.remove(h.get(n)):a.add(h.get(n))},a.add=function(n){var r;if(n.type==="user")if(!c)t.value?t.value+=", "+n.username:t.value=n.username;else{var s=t.value.split(/,|;/),o="";s.forEach(function(e){e=e.trim()}),s.pop();for(i=0,l=s.length;i<l;i++)o+=s[i]+", ";o+=n.username,t.value=o,c=!1}else f.get("connections").forEach(function(e){e.username===n.username&&(r=e.contacts)}),r.forEach(function(e){t.value.search(e.username)<0&&(a.add(e),h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!0)}))});u(t.value)},a.remove=function(n){var r,s="";if(n.type==="user"){r=t.value.split(/,|;/);for(i=0,l=r.length;i<l;i++)r[i]=r[i].trim();r.splice(r.indexOf(n.username),1),r.forEach(function(e){s+=e+", "}),t.value=s.substr(0,s.length-2),u(s.substr(0,s.length-2)),h.loop(function(e,t){e.type==="group"&&e.selected&&f.get("connections").forEach(function(r){r.username===e.username&&JSON.stringify(r).search(n.username)>-1&&h.update(t,"selected",!1)})})}else f.get("connections").forEach(function(e){e.username===n.username&&e.contacts.forEach(function(e){h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!1)}),a.remove(e)})})},a.init(),a.render(),a.place(e)}return function(n,r,i){return u.prototype=new e,new u(n,r,i)}}),define("public/detail-stack/public-share",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(a){var f=new e,p=new o({errormsg:""}),d=n.get("user"),v=n.get("transport"),m=n.get("labels"),g=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:d.get("signature")}),y=new o([]),b=new o([]),w=!1,E=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return f.plugins.addAll({labels:new r(m),share:new r(g,{setHeader:function(e){this.innerHTML=m.get("sharing")+e}}),contacts:new r(b,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(y,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(f),errormsg:new r(p)}),f.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',f.reset=function(t){p.reset({errormsg:""}),g.reset({body:"",docId:t,docType:"",docTitle:"",signature:d.get("username")+" <"+d.get("_id")+">"}),f.getIdeaDetails(t),d.get("signature")&&g.set("signature",d.get("signature")),b.reset([]),y.reset(d.get("connections").concat())},f.getIdeaDetails=function(t){var r=new l({});r.setTransport(v),r.sync(n.get("db"),t).then(function(){g.set("docType",r.get("type")),g.set("docTitle",r.get("title")),r.unsync()})},f.updateAutoContact=function(e,t){var n=JSON.parse(y.toJSON()),r=d.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")y.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);y.reset(n)}y.loop(function(e,t){b.toJSON().search(e.userid)>-1&&y.update(t,"selected",!0)})},f.close=function(t,n){n.parentNode.classList.add("invisible")},f.displayAutoContact=function(e,t){f.dom.querySelector("#sharelistauto").classList.remove("invisible"),y.reset(d.get("connections").concat())},f.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=b.get(n).userid;b.alter("splice",n,1),y.loop(function(e,t){e.userid===r&&setTimeout(function(){y.update(t,"selected",!1)},200)}),f.unselectGroup(r)},f.select=function(e,t){var n=t.getAttribute("data-auto_id");y.get(n).selected?(f.removeContact(y.get(n)),setTimeout(function(){y.update(n,"selected",!1),f.dom.querySelector("#sharelistauto").classList.add("invisible")},200)):(f.addContact(y.get(n)),f.selectGroup(),setTimeout(function(){y.update(n,"selected",!0),f.dom.querySelector("#sharelistauto").classList.add("invisible")},200))},f.selectAll=function(e,t){t.classList.remove("pressed"),b.reset([]),y.reset(d.get("connections")),y.loop(function(e,t){y.update(t,"selected",!0),e.type==="user"&&b.alter("push",e)})},f.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)f.removeContact(e.contacts[j]);else b.loop(function(t,n){t.userid===e.userid&&b.alter("splice",n,1)}),f.unselectGroup(e.userid),y.loop(function(t,n){t.userid===e.userid&&y.update(n,"selected",!1)})},f.selectGroup=function(){var e,t=!1;y.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(b.toJSON().search(e[j].userid)<0){t=!1;break}t&&y.update(r,"selected",!0)}})},f.unselectGroup=function(e){y.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&y.update(n,"selected",!1)})},f.addContact=function(e){var t,n,r=!0;if(e.type==="user")b.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)b.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(b.alter("push",e.contacts[t]),y.loop(function(n,r){n.userid===e.contacts[t].userid&&y.update(r,"selected",!0)}))},f.press=function(e,t){t.classList.add("pressed")},f.share=function(e,t){var n=new Date,r={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:d.get("_id"),username:d.get("username"),firstname:d.get("firstname"),toList:"",ccList:"",object:"",body:g.get("body"),signature:g.get("signature"),docId:g.get("docId"),docType:g.get("docType"),docTitle:g.get("docTitle"),dest:[]};w||(w=!0,E.spin(t),f.buildRecipientList(r.docId,r.dest).then(function(){r.dest.length?v.request("Notify",r,function(e){p.set("errormsg",m.get("shareok")),t.classList.remove("pressed"),w=!1,setTimeout(function(){E.stop(),f.reset(r.docId),f.dom.querySelector("#sharelistauto").classList.add("invisible"),y.reset(d.get("connections").concat()),a("close")},2e3)}):(p.set("errormsg","intented recipients already have this idea"),t.classList.remove("pressed"),w=!1,setTimeout(function(){E.stop(),f.reset(r.docId),f.dom.querySelector("#sharelistauto").classList.add("invisible"),y.reset(d.get("connections").concat()),a("close")},2500))}))},f.cancel=function(e,t){t.classList.remove("pressed"),a("close")},f.buildRecipientList=function(t,r){var i=new c,s=new l;return s.setTransport(v),s.sync(n.get("db"),t).then(function(){var e=s.get("sharedwith")||[],t=s.get("authors"),n;return b.loop(function(n,i){t.indexOf(n.userid)<0&&(e.length?e.indexOf(n.userid)<0&&(e.push(n.userid),r.push(n.userid)):(e.push(n.userid),r.push(n.userid)))}),s.set("sharedwith",e),s.upload()}).then(function(){i.fulfill()}),i},f.place(t.get("public-share")),f}}),define("public/public-stack",["OObject","service/map","Amy/Stack-plugin","./detail-stack/public-idea","./detail-stack/public-edit","./detail-stack/public-sendmail","./detail-stack/public-share","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){return function(){var l=new e,c,h,p,d,v=new n,m=u.get("observer"),g=new a,y=0,b=(new f({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return l.plugins.addAll({detailstack:v}),l.template='<div class="detail-stack" data-detailstack="destination"></div>',l.reset=function(t,n){g=t,y=n,v.getStack().show("#public-ideadetail"),c.hideCache(),b.spin(l.dom),c.reset(t,n).then(function(){b.stop(),cache.classList.add("invisible")})},l.action=function(t){switch(t){case"#public-edit":d.reset(g.get(y).id),v.getStack().show("#public-edit");break;case"#public-favorites":break;case"#public-share":p.reset(g.get(y).id),v.getStack().show("#public-share");break;case"close":v.getStack().show("#public-ideadetail");break;default:v.getStack().show("#public-ideadetail")}},l.edit=function(t){d.reset(t),v.getStack().show("#public-edit")},l.sendMail=function(t){h.reset(t),v.getStack().show("#public-sendmail")},l.share=function(t){p.reset(t._id),v.getStack().show("#public-share")},c=new r(l.action),d=new i(l.action),h=new s(l.action),p=new o(l.action),v.getStack().add("#public-ideadetail",c),v.getStack().add("#public-edit",d),v.getStack().add("#public-sendmail",h),v.getStack().add("#public-share",p),m.watch("public-viewidea",function(e){l.viewIdea(e)}),m.watch("public-edit",function(e){l.edit(e)}),m.watch("public-sendmail",function(e){l.sendMail(e)}),m.watch("public-share",function(e){l.share(e)}),l}}),define("service/new2c",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){return new function(){var u=new e,a=new s({userid:"",username:""}),f=i.get("user"),l=new s,c=i.get("labels"),h=i.get("transport"),p,d=!1,v=new s({error:""});return u.plugins.addAll({new2c:new n(l),dest:new n(a,{setHeader:function(e){this.innerHTML=c.get("sendtcprefix")+e+c.get("sendtcsuffix")}}),labels:new n(c),errormsg:new n(v),new2cevent:new r(u)}),u.template='<div><div class = "header blue-dark"><span data-dest="bind: setHeader, username"></span><div class="close-popup" data-new2cevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, twocentplaceholder" data-new2c="bind: value, message"></textarea></p><div><span class="errormsg" data-errormsg="bind:innerHTML, error"></span><div class="sendmail" data-new2cevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, sendlbl"></div></div></form></div>',u.render(),u.place(t.get("new2c-popup")),u.press=function(e,t){t.classList.add("pressed")},u.closePopup=function(){document.getElementById("new2c-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),l.reset(),a.reset(),v.reset({error:""})},u.reset=function(n){p=n,t.get("new2c-popup").classList.add("appear"),t.get("cache").classList.add("appear"),a.set("userid",p.userid),a.set("username",p.username),l.reset({author:f.get("_id"),message:"",firstname:f.get("firstname"),username:f.get("username"),date:[],datemod:"",plusones:0,replies:[]}),d=!1},u.cancel=function(e,t){u.closePopup()},u.upload=function(e,t){var n=new Date,r={},i;l.get("message")?(d=!0,i=setInterval(function(){v.get("error")===c.get("sendinginprogress")?v.set("error",c.get("sendinginprogress")+" ..."):v.set("error",c.get("sendinginprogress"))},150),l.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),r.tc=JSON.parse(l.toJSON()),r.userid=a.get("userid"),r.username=a.get("username"),h.request("SendTwocent",r,function(e){var n=p.twocents||[],s,o=f.get("connections");if(e==="ok"){n.unshift(r.tc),p.twocents=n;for(s=o.length-1;s>=0;s--)o[s].type==="user"&&o[s].userid===p.userid&&o.splice(s,1,p);f.set("connections",o),f.upload().then(function(){clearInterval(i),t.classList.remove("pressed"),u.closePopup()})}else v.set("error","something went wrong - try again later"),clearInterval(i),t.classList.remove("pressed")})):(v.set("error",c.get("nomessage")),t.classList.remove("pressed"))},u}}),define("service/actionbar",["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min","service/confirm"],function(e,t,n,r,i,s,o,u,a,f,c){function h(e,h,p){var d=new i([]),v=h.offsetHeight,m=new i({height:v}),g=10,y=r.get("user"),b=r.get("labels"),w=r.get("observer"),E=r.get("transport"),S=r.get("db"),x,T=this,N=(new f({color:"#9AC9CD",lines:10,length:10,width:8,radius:10})).spin();this.plugins.addAll({buttons:new t(d,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(m,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-g)+"px;")},setButtons:function(e){var t=Math.floor((e-g-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new n(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:mouseup, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:mousedown, press; listen:mouseup, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(){var e=T.dom.parentElement;e&&e.removeChild(e.lastChild)},this.getParent=function(){return h},this.press=function(e,t){e.stopPropagation(),t.classList.add("pressed"),N.el=document.getElementById("abspinner")},this.action=function(e,t){var n=t.getAttribute("data-buttons_id"),i=d.get(n).name;e.stopPropagation(),t.classList.remove("pressed");switch(i){case"delete":this.deleteItem().then(function(){T.hide()});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":r.get("observer").notify("replay-session",p.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();default:}},x=function(e,t){var n;switch(e){case"idea":n=new s,n.setTransport(E),n.sync(S,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){t=n.get(0).doc,p=n.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&d.alter("push",{name:"edit",icon:"img/wall/35modify.png"});if(t.sessionId&&t.sessionId!==""&&t.sessionId.search("deleted")===-1)if(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1){var e=new s;e.setTransport(r.get("transport")),e.sync(r.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){e.get(0)&&d.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),t.authors.length===1&&t.authors[0]===y.get("_id")&&!t.twocents.length&&!t.sharedwith.length&&t.visibility!=="public"&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),t.authors.indexOf(y.get("_id"))===-1&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"deck":var i=new o;i.setTransport(E),i.sync(S,p).then(function(){i.get("created_by")===y.get("_id")&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),y.get("taiaut_decks").length+y.get("custom_decks").length>1&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.type==="user"&&d.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:}},this.deleteItem=function(){var n=new u,i=new o,s=this;i.setTransport(E);switch(e){case"idea":p.authors.length===1&&p.authors[0]===y.get("_id")?i.sync(r.get("db"),p._id).then(function(){return i.remove()}).then(function(){n.fulfill()}):E.request("RemoveFromLibrary",{id:p._id,userid:y.get("_id")},function(e){n.fulfill()});break;case"deck":y.get("active_deck")===p?(alert(b.get("cannotdelactivedeck")),s.hide()):(document.getElementById("cache").classList.add("appear"),confirmUI=new c(document.body,b.get("deldeckwarning"),function(e){var t=(new f({lines:10,length:20,width:8,radius:10})).spin();if(!e)s.hide();else{t.spin(document.getElementById("deckview")),document.getElementById("cache").classList.add("appear");if(y.get("taiaut_decks").indexOf(p)>-1){var r=y.get("taiaut_decks");r.splice(r.indexOf(p),1),y.set("taiaut_decks",r),y.upload().then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})}else i.sync(S,p).then(function(){var e=i.get("sharedwith")||[],r=y.get("custom_decks").concat();e.length&&e.indexOf(y.get("_id"))>-1?(e.splice(e.indexOf(y.get("_id")),1),i.set("sharedwith",e),i.upload.then(function(){return r.splice(r.indexOf(p),1),y.set("custom_decks",r),y.upload()}).then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})):i.get("created_by")===y.get("_id")&&E.request("DeleteDeck",{id:p,userid:y.get("_id")},function(e){e==="ok"?(r.splice(r.indexOf(p),1),y.set("custom_decks",r),y.upload().then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})):console.log(e)})})}document.body.removeChild(document.querySelector(".confirm"))},"importcard-confirm"));break;case"message":var a=y.get("notifications"),h,d;for(h=0,l=a.length;h<l;h++)if(JSON.stringify(a[h])===JSON.stringify(p)){d=h;break}a.splice(d,1),y.set("notifications",a),y.upload();break;case"contact":var a=y.get("connections"),v=new Date,m=[v.getFullYear(),v.getMonth(),v.getDate(),v.getHours(),v.getMinutes(),v.getSeconds()];if(p.type==="user"){for(h=a.length-1;h>=0;h--)if(a[h].type==="user"&&a[h].userid===p.userid)a.splice(h,1);else if(a[h].type==="group"){var g=a[h].contacts;for(j=g.length-1;j>=0;j--)g[j].userid===p.userid&&g.splice(j,1)}}else for(h=a.length-1;h>=0;h--)a[h].username===p.username&&a.splice(h,1);y.set("connections",a),p.type==="user"&&y.get("news").unshift({type:"CX-",date:m,content:{userid:p.userid,username:p.username}}),y.upload().then(function(){if(p.type==="user"){var e=new Date,t={dest:[p.userid],date:m,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:p.username,ccList:"",object:y.get("username")+b.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};E.request("Notify",t,function(e){console.log(e)})}w.notify("contact-deleted")});break;default:}return n},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-edit",p._id):w.notify("library-edit",p._id);break;default:}N.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-sendmail",p):w.notify("library-sendmail",p);break;case"message":break;case"contact":w.notify("message-contact",p);break;default:}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-share",p):w.notify("library-share",p);break;case"deck":w.notify("deck-share",p);break;case"message":break;case"contact":break;default:}},this.sendTwocent=function(){a.reset(p)},x(e,p)}return function(n,r,i){return h.prototype=new e,new h(n,r,i)}}),define("public/lists/list-public",["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h=!1,p=null,d={db:e,view:f,design:o,query:{descending:!0,limit:50}};c.setTransport(n.get("transport")),l&&(d.query=l),this.template="<div><div id='noresult' class='date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:innerHTML,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul></div>",d.query.q&&(this.template="<div><div id='noresult' class='date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div><h2 data-listideas='bind:innerHTML,doc.authornames'></h2><span class='date' data-listideas='bind:date,doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3><p data-listideas='bind:setDesc,doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, rating'></span> </div></li></ul></div>"),this.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function v(v){this.innerHTML=s.formatDate(v)},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=c.get(n).doc.votes||[];r.length===0?this.innerHTML="":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=t},setAvatar:function(t){var n,r}}),listevent:new i(this)}),this.getModel=function(){return c},this.resetQuery=function(e){var t=new a;return d.query=e,c.unsync(),c.reset([]),c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){p&&p.hide()},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=!1,i,s=document.getElementById("public");p&&p.getParent()===t&&(r=!0),!s.classList.contains("mosaic")&&!r&&(p=new u("idea",t,c.get(n).id),i=document.createDocumentFragment(),p.place(i),t.appendChild(i),r=!0)},this.init=function(){var t=new a;return c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t}}return function(n,r,i,s){return f.prototype=new e,new f(n,r,i,s)}}),define("public/lists/list-polling",["OObject","CouchDBView","Store","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,n,u,l){var c=new t([]),h,p=!1,d=null,v=r.get("user"),m={db:e,view:u,design:n,query:{descending:!0,limit:50}},g=this;this.template="<ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:setDesc,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul>",this.plugins.addAll({listideas:new i(c,{date:function(t){this.innerHTML=o.formatDate(t)},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=c.get(n).doc.votes||[];r.length===0?this.innerHTML="":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=t},setAvatar:function(t){var n,r}}),listevent:new s(this)}),this.getModel=function(){return c},g.resetQuery=function(n){var i=new f,s=v.get("settings").polling_interval||r.get("polling_interval"),o=new t;return n&&(m.query=n),clearInterval(h),o.setTransport(r.get("transport")),o.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(o.toJSON())),o.unsync(),h=setInterval(function(){o.reset([]),o.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(o.toJSON())),o.unsync()})},s),i.fulfill()}),i},this.setStart=function(e,t){d&&d.hide()},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=!1,i,s=document.getElementById("public");d&&d.getParent()===t&&(r=!0),!s.classList.contains("mosaic")&&!r&&(d=new a("idea",t,c.get(n).id),i=document.createDocumentFragment(),d.place(i),t.appendChild(i),r=!0)},l&&(m.query=l),this.init=function(){var n=new f,i=v.get("settings").polling_interval||r.get("polling_interval"),s=new t;return s.setTransport(r.get("transport")),s.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(s.toJSON())),s.unsync(),h=setInterval(function(){s.reset([]),s.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(s.toJSON())),s.unsync()})},i),n.fulfill()}),n},v.watchValue("settings",function(){var e=new t,n;v.get("settings").polling_interval!==r.get("polling_interval")&&(r.set("polling_interval",v.get("settings").polling_interval),n=r.get("polling_interval"),clearInterval(h),e.setTransport(r.get("transport")),h=setInterval(function(){e.reset(),e.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(e.toJSON())),e.unsync()})},n))}),r.get("observer").watch("update-polling",function(){g.resetQuery()})}return function(n,r,i,s){return l.prototype=new e,new l(n,r,i,s)}}),define("service/submenu",["OObject","Bind.plugin","Amy/Control-plugin","service/config"],function(e,t,n,r){function i(e,i){var s=!1,o,u,a,f,l,c=new n(this),h=function(t){t?e.setAttribute("style","display : block;"):e.setAttribute("style","display : none;"),s=t};o="<div></div>",u='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#ideas" data-menucontrol="init"><a class="library-item" href="#ideas" data-label="bind:innerHTML, library-ideas"></a></li><li class="menu-item" name="#sessions"><a class="library-item" href="#sessions" data-label="bind:innerHTML, library-sessions"></a></li><li class="menu-item" name="#decks"><a class="library-item" href="#decks" data-label="bind:innerHTML, library-decks"></a></li></ul></div>',a="<div></div>",f='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" data-menucontrol="init" name="#messages"><a class="connect-item" href="#connect-messages" data-label="bind:innerHTML, connect-messages"></a></li><li class="menu-item" name="#contacts"><a class="connect-item" href="#connect-contacts" data-label="bind:innerHTML, connect-contacts"></a></li><li class="menu-item" name="#twocents"><a class="connect-item" href="#connect-twocents" data-label="bind:innerHTML, connect-twocents"></a></li></ul></div>',l='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#profile" data-menucontrol="init"><a class="dashboard-item" href="#dashboard-profile" data-label="bind:innerHTML, dashboard-profile"></a></li><li class="menu-item" name="#settings"><a class="dashboard-item" href="#dashboard-settings" data-label="bind:innerHTML, dashboard-settings">Settings</a></li><li class="menu-item" name="#about"><a class="dashboard-item" href="#dashboard-about" data-label="bind:innerHTML, dashboard-about">About Ideafy</a></li></ul></div>',e.id.search("public")>-1&&(this.template=o),e.id.search("library")>-1&&(this.template=u),e.id.search("brainstorm")>-1&&(this.template=a),e.id.search("connect")>-1&&(this.template=f),e.id.search("dashboard")>-1&&(this.template=l),this.plugins.addAll({label:new t(r.get("labels")),menucontrol:c}),this.getState=function(){return s},this.toggleActive=function(e){h(e)},this.setCurrentWidget=function(t){var n=t.target.getAttribute("name");i&&i(n),setTimeout(function(){h(!1)},200)},this.setWidget=function(t){var n=this.dom.querySelector('li[name="'+t+'"]');i(t),n.parentNode.querySelector(".selected").classList.remove("selected"),n.classList.add("selected"),c.init(this.dom.querySelector('li[name="'+t+'"]'))},this.reset=function(){var t=this.dom.querySelector(".menu-list");t&&(t.querySelector(".selected").classList.remove("selected"),t.firstChild.classList.add("selected"),c.init(t.firstChild))},this.render(),this.place(e)}return function(n,r){return i.prototype=new e,new i(n,r)}}),define("public/public",["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","service/map","service/config","./public-stack","service/utils","./lists/list-public","./lists/list-polling","Amy/Stack-plugin","service/submenu","Promise"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(){var p=new e,d,v,m,g=o.get("db"),y=new t(p),b=new u,w,E,S,x,T=new c;return p.template='<div id="public"><div id = "public-menu"></div><div id="public-list" class="list"><div class="header blue-light"><div class="option left" data-publiccontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, publicideasheadertitle"></span><div class="option right" data-publicevent="listen: mousedown, plus"></div></div><div data-liststack="destination" data-publiccontrol="radio:li,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-label="bind: placeholder, searchpublicplaceholder" data-publicevent="listen: keypress, search"><div name="#list-date" class="tools-button bydate pushed" data-publicevent="listen:mousedown,show"></div><div name="#list-rating" class="tools-button byrating" data-publicevent="listen:mousedown,show"></div></div></div></div><div id="public-detail" class="details" data-publicplace="place:details"></div></div>',p.plugins.addAll({liststack:T,label:new n(o.get("labels")),publicevent:new i(p),publicplace:new r({details:b}),publiccontrol:y}),p.place(s.get("public")),p.selectStart=function(e){var t=T.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");b.reset(t,n)},p.displayHighlightedIdea=function(){var t=T.getStack().getCurrentScreen(),n=t.dom.querySelector(".list-item.selected")||t.dom.querySelector("li[data-listideas_id='0']");id=n.getAttribute("data-listideas_id"),n.classList.add("selected"),n.scrollIntoView(),y.init(n),b.reset(t.getModel(),id)},p.show=function(e,t){var n=d.querySelector(".bydate"),r=d.querySelector(".byrating"),i=t.getAttribute("name");i!==T.getStack().getCurrentName&&(T.getStack().show(i),i==="#list-date"?(r.classList.remove("pushed"),n.classList.add("pushed")):(r.classList.add("pushed"),n.classList.remove("pushed")),p.displayHighlightedIdea())},p.mosaic=function(){var e=document.getElementById("public-detail");d.classList.toggle("mosaic"),e.classList.contains("invisible")&&(e.classList.remove("invisible"),b.reset(E.getModel(),0))},p.plus=function(){s.get("newidea-popup").classList.add("appear"),s.get("cache").classList.add("appear")},p.search=function(e,t){e.keyCode===13&&(t.value===""?E.resetQuery().then(function(){v.setAttribute("style","display: inline-block;"),m.setAttribute("style","display: inline-block;"),T.getStack().show("#list-date"),v.classList.add("pushed"),m.classList.remove("pushed"),p.displayHighlightedIdea()}):p.searchIdea(t.value),t.blur())},p.searchIdea=function(t){v.setAttribute("style","display: none;"),m.setAttribute("style","display: none;"),x.resetQuery({q:t,sort:"\\creation_date<date>",include_docs:!0}).then(function(){T.getStack().show("#list-search"),x.getModel().getNbItems()>0?(document.getElementById("noresult").classList.add("invisible"),p.displayHighlightedIdea()):document.getElementById("noresult").classList.remove("invisible")})},p.reset=function(){S.init(b.reset),E.init(b.reset).then(function(){T.getStack().show("#list-date"),b.reset(E.getModel(),0)})},p.showMenu=function(){w.toggleActive(!0)},p.hideMenu=function(){w.toggleActive(!1)},w=new h(p.dom.querySelector("#public-menu")),w.toggleActive(!1),d=p.dom,v=d.querySelector(".bydate"),m=d.querySelector(".byrating"),E=new l(g,"library","_view/publicideas"),S=new f(g,"ideas","_view/ideasbyvotes"),x=new f("_fti/local/"+g,"indexedideas","publicbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:60,include_docs:!0}),T.getStack().add("#list-rating",S),T.getStack().add("#list-search",x),T.getStack().add("#list-date",E),S.init(),E.init().then(function(){T.getStack().show("#list-date"),p.displayHighlightedIdea()}),p}}),define("library/ideas/detail-stack/library-idea",["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(v){var m=new e,g=new f("library"),y=new a("library"),b=u.get("labels"),w=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),E=!1,S=u.get("user"),x=u.get("transport"),T=new h,N=new t([]),C=i.get("ideas-detail"),k=i.get("library-writetwocents"),L=new l;return T.setTransport(x),m.plugins.addAll({label:new n(b),ideadetail:new n(T,{toggleRateEdit:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#library-edit"):this.setAttribute("href","#library-favorites")},toggleTwocentShare:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#library-share"):this.setAttribute("href","#library-2cents")},displayWriteTwocent:function(e){e.indexOf(S.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("library-writetwocents").classList.add("invisible")},date:function A(A){A&&(this.innerHTML=s.formatDate(A))},setAuthor:function(e){e===S.get("username")&&T.get("authors").indexOf(S.get("_id"))>-1?this.innerHTML=b.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e.length===1&&e[0]===S.get("_id")?this.innerHTML=b.get("youwrotelbl"):e.length>1?this.innerHTML=b.get("theywrotelbl"):this.innerHTML=b.get("ideawrotelbl")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new o(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},hideRating:function(e){e.search("I:WELCOME")>-1?this.classList.add("invisible"):this.classList.remove("invisible")},setRating:function(t){t.length===0?this.innerHTML="":this.innerHTML=Math.round(t.reduce(function(e,t){return e+t})/t.length*100)/100},setDescription:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},setSolution:function(t){this.innerHTML=t.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=T.get("_id"),n=T.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),S.get("rated_ideas").indexOf(t)<0&&n.indexOf(S.get("_id"))<0&&!E?(this.setAttribute("name","vote"),this.innerHTML=b.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(E=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),e.length===0?this.innerHTML="("+b.get("novotesyet")+")":e.length===1?this.innerHTML="("+b.get("onevote")+")":this.innerHTML="("+e.length+" "+b.get("votes")+")",this.classList.add("votes"))},setSharedWith:function(e){T.get("_id").search("I:WELCOME")<0&&e&&e.length?(this.classList.remove("invisible"),e.length===1?this.innerHTML=b.get("sharedwith")+"<b><u>"+1+b.get("ideafyer")+"</u></b>":this.innerHTML=b.get("sharedwith")+"<b><u>"+e.length+b.get("ideafyer")+"</u></b>"):this.classList.add("invisible")}}),share:new n(N),vote:new n(w,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new p({LibraryTwocentUI:g}),ideadetailevent:new r(m)}),m.template='<div class="library-idea"><div class="header blue-dark"><a href="#library-2cents" data-ideadetail="bind: toggleTwocentShare, authors" data-ideadetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, ideadetailsheadertitle"></span><a href="#library-favorites" data-ideadetail="bind: toggleRateEdit, authors" data-ideadetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache" class="invisible"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-ideadetail="bind:setAvatar, authors"></div><h2 data-ideadetail="bind:innerHTML,title"></h2><span class="date" data-ideadetail="bind:date, creation_date"></span><br><span class="author" data-ideadetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-ideadetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><p data-ideadetail="bind:setDescription,description"></p><p data-ideadetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class="sharedwith invisible" data-ideadetail="bind: setSharedWith, sharedwith" data-ideadetailevent="listen:mousedown, displayList"></div><div id="sharelist" class="autocontact invisible"><div class="autoclose" data-ideadetailevent="listen:mousedown,close"></div><ul data-share="foreach"><li data-share="bind:innerHTML, value.username"></li></ul></div><div class ="rateIdea" data-ideadetail="bind:hideRating, id"><a class="item-acorn"></a><div class="rating" data-ideadetail="bind:setRating,votes"></div><div class="publicButton" data-ideadetail="bind: toggleVoteButton, votes" name="vote" data-ideadetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-ideadetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="library-writetwocents" class="invisible" data-ideadetail="bind: displayWriteTwocent, authors"></div><div id="library-twocents" class="twocents" data-ideadetail="bind: displayTwocentList, twocents" data-place="place: LibraryTwocentUI"></div></div>',m.showCache=function(){m.dom.querySelector("#idea-cache").classList.remove("invisible")},m.hideCache=function(){m.dom.querySelector("#idea-cache").classList.add("invisible")},m.reset=function(t,n){var r=t.get(n).id,i=new c;return w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),m.getIdea(r).then(function(){E=!1,y.reset(T.get("_id")),g.reset(T.get("_id")),k=document.getElementById("library-writetwocents"),y.place(k),i.fulfill()}),i},m.getIdea=function(t){return T.unsync(),T.reset(),T.sync(u.get("db"),t)},m.action=function(e,t){var n=t.getAttribute("href");n==="#library-2cents"?(y.reset(T.get("_id")),k.classList.remove("invisible")):v(n)},m.edit=function(){_stack.getStack().show("#public-edit")},m.press=function(e,t){t.classList.add("pressed")},m.vote=function(e,t){E||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},m.previewVote=function(e,t){var n=0,r=t.getAttribute("data-vote_id");w.loop(function(e,t){t<=r?w.update(t,"active",!0):w.update(t,"active",!1)})},m.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,r=T.get("_id"),i={id:r,vote:n,voter:S.get("_id")};E||(E=!0,x.request("Vote",i,function(e){var t=S.get("rated_ideas")||[];e!=="ok"?(console.log(e,"something went wrong, please try again later"),E=!1):(t.unshift(r),S.set("rated_ideas",t),alert(u.get("labels").get("thankyou")),document.getElementById("ratingPopup").classList.remove("appear"),w.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},m.close=function(t,n){n.parentNode.classList.add("invisible")},m.displayList=function(e,t){x.request("GetUserNames",{list:T.get("sharedwith")},function(e){N.reset(e),document.getElementById("sharelist").classList.remove("invisible")})},m.place(C),m}}),define("library/ideas/detail-stack/library-edit",["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new r,p=o.get("labels"),d=new n({error:""}),v;return h.setTransport(o.get("transport")),c.plugins.addAll({editlabel:new i(p),editidea:new i(h,{setVisibility:function(e){e==="public"?this.innerHTML=p.get("publiclbl"):this.innerHTML=p.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=p.get("enabledreplaylbl"):this.innerHTML=p.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=p.get("disablereplaylbl"):this.innerHTML=p.get("enablereplaylbl")}}),editevent:new s(c),errormsg:new i(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;case"nosol":this.innerHTML=p.get("solutionfield")+p.get("emptyfielderror");break;default:this.innerHTML=""}}})}),c.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl"></span></div><form class="form"><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editlabel="bind:innerHTML, publishlbl" data-editevent="listen: mousedown, press; listen:mouseup, upload"></label><label class="cancel pressed-btn" data-editlabel="bind:innerHTML, cancellbl" data-editevent="listen: mousedown, press;listen:mouseup, cancel"></label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',c.place(t.get("library-edit")),c.reset=function(t){h.unsync(),h.reset(),h.sync(o.get("db"),t),v=!1},c.editVisibility=function(e,t){var n=new u(t,p.get("setpublicquestion"),function(e){e?h.set("visibility","public"):h.set("visibility","private"),n.close()})},c.press=function(e,t){t.classList.add("pressed")},c.enableReplay=function(e,t){setTimeout(function(){h.get("sessionReplay")?h.set("sessionReplay",!1):h.set("sessionReplay",!0),v=!0,t.classList.remove("pressed")},300)},c.updateSessionReplay=function(t){var n=new a,i=new r;return i.setTransport(o.get("transport")),i.sync(o.get("db"),h.get("sessionId")).then(function(){var e=i.get("replayIdeas")||[],r;if(t)e.push(h.get("_id"));else for(r=e.length-1;r>=0;r--)e[r]===h.get("_id")&&e.splice(r,1);i.set("replayIdeas",e),i.upload().then(function(){n.fulfill(),i.unsync()})}),n},c.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];h.get("title")===""?d.set("error","notitle"):h.get("description")===""?d.set("error","nodesc"):h.get("solution")===""?d.set("error","nosol"):(h.set("modification_date",r),h.upload().then(function(){v&&c.updateSessionReplay(h.get("sessionReplay")).then(null,function(e){console.log(e)}),l("close")})),t.classList.remove("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),l("close")},c}}),define("library/ideas/detail-stack/library-sendmail",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new o({errormsg:""}),d=n.get("user"),v=n.get("transport"),m=n.get("labels"),g=new o({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:!1});return h.plugins.addAll({labels:new r(m),mail:new r(g,{setUserAvatar:function(e){e&&this.setAttribute("style","background: url('"+n.get("avatar")+"') no-repeat center center; background-size: cover")},date:function y(y){y&&(this.innerHTML=a.formatDate(y))},setAvatar:function(t){if(t){var n=document.createDocumentFragment(),r=new u(t);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)}},setRating:function(e){},setVotes:function(e){}}),mailevent:new s(h),errormsg:new r(p)}),h.template='<div class="idea-sendmail"><div class="header blue-dark"><span data-labels="bind:innerHTML, sendidealbl"></span></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment.votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',h.reset=function(t){p.reset({errormsg:""}),g.reset({toField:"",from:d.get("username"),subject:"",body:"",signature:d.get("username")+" <"+d.get("_id"),attachment:t,sent:!1}),d.get("signature")&&g.set("signature",d.get("signature"))},h.validateAddress=function(t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,r=t.toLowerCase().split(/,|;/),s=!0;for(i=0,l=r.length;i<l;i++)if(!n.test(r[i].trim())){p.set("errormsg",r[i]+m.get("notavalidaddress")),s=!1;break}return s},h.validateMessage=function(){return g.get("toField")?h.validateAddress(g.get("toField")):p.set("errormsg",m.get("norecipient")),p.get("errormsg")===""},h.sendMail=function(){var t={};t.type="doc",t.recipient=g.get("toField"),t.cc=d.get("_id"),t.replyTo=d.get("_id"),t.subject=d.get("username")+m.get("sentdocmsg"),t.header=g.get("subject"),t.body=g.get("body"),t.signature=g.get("signature"),t.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+g.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+g.get("attachment").authornames+", <span style='color:black';>"+a.formatDate(g.get("attachment").creation_date)+"</span></p></div>",t.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+g.get("attachment").solution+"</p></div>",v.request("SendMail",t,function(e){e.sendmail==="ok"?(p.set("errormsg",m.get("yourmessage")+e.recipient+m.get("sentoklbl")),setTimeout(function(){c("close")},350)):(p.set("errormsg",m.get("somethingwrong")),g.set("sent",!1),console.log("error",e.error),console.log("response",e.response))})},h.press=function(e,t){(!t.classList.contains("sendmail")||!g.get("sent"))&&t.classList.add("pressed")},h.send=function(e,t){g.get("sent")||(g.set("sent",!0),p.set("errormsg",""),t.classList.remove("pressed"),h.validateMessage()?h.sendMail():g.set("sent",!1))},h.cancel=function(e,t){t.classList.remove("pressed"),c("close")},h.place(t.get("library-sendmail")),h}}),define("library/ideas/detail-stack/library-share",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(a){var f=new e,p=new o({errormsg:""}),d=n.get("user"),v=n.get("transport"),m=n.get("labels"),g=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:d.get("signature")}),y=new o([]),b=new o([]),w=!1,E=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return f.plugins.addAll({labels:new r(m),share:new r(g,{setHeader:function(e){this.innerHTML=m.get("sharing")+e}}),contacts:new r(b,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(y,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(f),errormsg:new r(p)}),f.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',f.reset=function(t){p.reset({errormsg:""}),g.reset({body:"",docId:t,docType:"",docTitle:"",signature:d.get("username")+" <"+d.get("_id")+">"}),f.getIdeaDetails(t),d.get("signature")&&g.set("signature",d.get("signature")),b.reset([]),y.reset(d.get("connections").concat())},f.getIdeaDetails=function(t){var r=new l({});r.setTransport(v),r.sync(n.get("db"),t).then(function(){g.set("docType",r.get("type")),g.set("docTitle",r.get("title")),r.unsync()})},f.updateAutoContact=function(e,t){var n=JSON.parse(y.toJSON()),r=d.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")y.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);y.reset(n)}y.loop(function(e,t){b.toJSON().search(e.userid)>-1&&y.update(t,"selected",!0)})},f.close=function(t,n){n.parentNode.classList.add("invisible")},f.displayAutoContact=function(e,t){f.dom.querySelector("#sharelistauto").classList.remove("invisible"),y.reset(d.get("connections").concat())},f.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=b.get(n).userid;b.alter("splice",n,1),y.loop(function(e,t){e.userid===r&&setTimeout(function(){y.update(t,"selected",!1)},200)}),f.unselectGroup(r)},f.select=function(e,t){var n=t.getAttribute("data-auto_id");y.get(n).selected?(f.removeContact(y.get(n)),setTimeout(function(){y.update(n,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(f.addContact(y.get(n)),f.selectGroup(),setTimeout(function(){y.update(n,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},f.selectAll=function(e,t){t.classList.remove("pressed"),b.reset([]),y.reset(d.get("connections")),y.loop(function(e,t){y.update(t,"selected",!0),e.type==="user"&&b.alter("push",e)})},f.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)f.removeContact(e.contacts[j]);else b.loop(function(t,n){t.userid===e.userid&&b.alter("splice",n,1)}),f.unselectGroup(e.userid),y.loop(function(t,n){t.userid===e.userid&&y.update(n,"selected",!1)})},f.selectGroup=function(){var e,t=!1;y.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(b.toJSON().search(e[j].userid)<0){t=!1;break}t&&y.update(r,"selected",!0)}})},f.unselectGroup=function(e){y.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&y.update(n,"selected",!1)})},f.addContact=function(e){var t,n,r=!0;if(e.type==="user")b.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)b.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(b.alter("push",e.contacts[t]),y.loop(function(n,r){n.userid===e.contacts[t].userid&&y.update(r,"selected",!0)}))},f.press=function(e,t){t.classList.add("pressed")},f.share=function(e,t){var n=new Date,r={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:d.get("_id"),username:d.get("username"),firstname:d.get("firstname"),toList:"",ccList:"",object:"",body:g.get("body"),signature:g.get("signature"),docId:g.get("docId"),docType:g.get("docType"),docTitle:g.get("docTitle"),dest:[]};w||(w=!0,E.spin(t),f.buildRecipientList(r.docId,r.dest).then(function(){r.dest.length?v.request("Notify",r,function(e){p.set("errormsg",m.get("shareok")),t.classList.remove("pressed"),w=!1,setTimeout(function(){E.stop(),f.reset(r.docId),f.dom.querySelector("#sharelistauto").classList.add("invisible"),y.reset(d.get("connections").concat()),a("close")},2500)}):(p.set("errormsg","intented recipients already have this idea"),t.classList.remove("pressed"),w=!1,setTimeout(function(){E.stop(),f.reset(r.docId),f.dom.querySelector("#sharelistauto").classList.add("invisible"),y.reset(d.get("connections").concat()),a("close")},2500))}))},f.cancel=function(e,t){t.classList.remove("pressed"),a("close")},f.buildRecipientList=function(t,r){var i=new c,s=new l;return s.setTransport(v),s.sync(n.get("db"),t).then(function(){var e=s.get("sharedwith")||[],t=s.get("authors"),n;return b.loop(function(n,i){t.indexOf(n.userid)<0&&(e.length?e.indexOf(n.userid)<0&&(e.push(n.userid),r.push(n.userid)):(e.push(n.userid),r.push(n.userid)))}),s.set("sharedwith",e),s.upload()}).then(function(){i.fulfill()}),i},f.place(t.get("library-share")),SHARESPIN=E,f}}),define("library/ideas/idea-stack",["OObject","service/map","Amy/Stack-plugin","./detail-stack/library-idea","./detail-stack/library-edit","./detail-stack/library-sendmail","./detail-stack/library-share","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){return function(){var l=new e,c,h,p,d,v=new n,m=u.get("observer"),g=new a,y=0,b=(new f({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return l.plugins.addAll({detailstack:v}),l.template='<div class="detail-stack" data-detailstack="destination"></div>',l.reset=function(t,n){var r;g=t,y=n,v.getStack().show("#library-ideadetail"),c.hideCache(),b.spin(l.dom),c.reset(t,n).then(function(){b.stop(),r.classList.add("invisible")})},l.action=function(t){switch(t){case"#library-edit":d.reset(g.get(y).id),v.getStack().show("#library-edit");break;case"#library-favorites":break;case"#library-share":console.log(g.get(y)),p.reset(g.get(y).id),v.getStack().show("#library-share");break;case"close":v.getStack().show("#library-ideadetail");break;default:v.getStack().show("#library-ideadetail")}},l.edit=function(t){d.reset(t),v.getStack().show("#library-edit")},l.sendMail=function(t){h.reset(t),v.getStack().show("#library-sendmail")},l.share=function(t){p.reset(t._id),v.getStack().show("#library-share")},c=new r(l.action),d=new i(l.action),h=new s(l.action),p=new o(l.action),v.getStack().add("#library-ideadetail",c),v.getStack().add("#library-edit",d),v.getStack().add("#library-sendmail",h),v.getStack().add("#library-share",p),m.watch("library-viewidea",function(e){l.viewIdea(e)}),m.watch("library-edit",function(e){l.edit(e)}),m.watch("library-sendmail",function(e){l.sendMail(e)}),m.watch("library-share",function(e){l.share(e)}),l}}),define("library/ideas/lists/idealist",["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h=!1,p=null,d={db:e,view:f,design:o,query:{descending:!0}};c.setTransport(n.get("transport")),l&&(d.query=l),this.template='<div><div id="noresult" class="date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,value.doc.authors"></div><h2 data-listideas="bind:innerHTML,value.doc.authornames"></h2><span class="date" data-listideas="bind:date, value.doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,value.doc.title"></h3><p data-listideas="bind:innerHTML, value.doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, value.doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul></div>',d.query.q&&(this.template='<div><div id="noresult" class="date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames"></h2><span class="date" data-listideas="bind:date, doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:setDesc, doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, rating"></span></div></li></ul></div>'),this.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function v(v){v?this.innerHTML=s.formatDate(v):this.innerHTML=""},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=c.get(n).doc.votes||[];r.length===0?this.innerHTML="0":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=Math.round(t*100)/100},setAvatar:function(t){var n,r},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),listevent:new i(this)}),this.getModel=function(){return c},this.resetQuery=function(e){var t=new a;return d.query=e,c.unsync(),c.reset([]),c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){p&&p.hide()},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=!1,i,s=document.getElementById("ideas");p&&p.getParent()===t&&(r=!0),!s.classList.contains("mosaic")&&!r&&(p=new u("idea",t,c.get(n).id),i=document.createDocumentFragment(),p.place(i),t.appendChild(i),r=!0)},this.init=function(){var t=new a;return c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t}}return function(n,r,i,s){return f.prototype=new e,new f(n,r,i,s)}}),define("library/ideas/ideas",["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","Store","service/map","service/config","./idea-stack","./lists/idealist","Amy/Stack-plugin"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var h=new e,p,d,v,m=new s({search:""}),g=u.get("db"),y=u.get("observer"),b=new t(h),w=new a,E,S,x,T=new l;return h.template='<div id = "ideas"><div id="idea-list" class="list"><div class="header blue-light"><div class="option left" data-ideascontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, idealistheadertitle">My Ideas</span><div class="option right" data-ideasevent="listen: mousedown, plus"></div></div><div class="overflow" data-idealiststack="destination" data-ideascontrol="radio:li,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-search="bind: value, search" data-label="bind: placeholder, searchprivateplaceholder" data-ideasevent="listen: keypress, search"><div name="#list-date" class="tools-button bydate pushed" data-ideasevent="listen:mousedown,show"></div><div name="#list-rating" class="tools-button byrating" data-ideasevent="listen:mousedown,show"></div></div></div></div><div id="ideas-detail" class="details" data-ideaplace="place:details"></div></div>',h.plugins.addAll({idealiststack:T,search:new n(m),ideasevent:new i(h),ideaplace:new r({details:w}),ideascontrol:b}),h.place(o.get("ideas")),h.selectStart=function(e){var t=T.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");w.reset(t,n),m.set("search","")},h.displayHighlightedIdea=function(){var t=T.getStack().getCurrentScreen(),n=t.dom.querySelector(".list-item.selected")||t.dom.querySelector("li[data-listideas_id='0']");id=n.getAttribute("data-listideas_id"),n.classList.add("selected"),n.scrollIntoView(),b.init(n),w.reset(t.getModel(),id)},h.show=function(e,t){var n=p.querySelector(".bydate"),r=p.querySelector(".byrating"),i=t.getAttribute("name");i!==T.getStack().getCurrentName&&(T.getStack().show(i),i==="#list-date"?(r.classList.remove("pushed"),n.classList.add("pushed")):(r.classList.add("pushed"),n.classList.remove("pushed")),h.displayHighlightedIdea())},h.mosaic=function(){var e=document.getElementById("ideas-detail");p.classList.toggle("mosaic"),e.classList.contains("invisible")?(e.classList.remove("invisible"),w.reset(E.getModel(),0)):e.classList.add("invisible")},h.plus=function(){o.get("newidea-popup").classList.add("appear"),o.get("cache").classList.add("appear")},h.search=function(e,t){var n;e.keyCode===13&&(t.value===""?(d.setAttribute("style","display: inline-block;"),v.setAttribute("style","display: inline-block;"),T.getStack().show("#list-date"),d.classList.add("pushed"),v.classList.remove("pushed"),h.displayHighlightedIdea()):(n=u.get("user").get("_id").replace(/@/,"at"),h.searchIdea("users:"+n+" AND "+t.value)),t.blur())},h.searchIdea=function(t){d.setAttribute("style","display: none;"),v.setAttribute("style","display: none;"),x.resetQuery({q:t,sort:"\\creation_date<date>",include_docs:!0}).then(function(){T.getStack().show("#list-search"),x.getModel().getNbItems()>0?(m.set("search",x.getModel().get(0).doc.title),document.getElementById("noresult").classList.add("invisible"),h.displayHighlightedIdea()):document.getElementById("noresult").classList.remove("invisible")})},h.reset=function(){m.set("search",""),x.resetQuery({q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),S.resetQuery({startkey:'["'+u.get("user").get("_id")+'",{}]',endkey:'["'+u.get("user").get("_id")+'"]',descending:!0,include_docs:!0}),E.resetQuery({key:u.get("uid"),descending:!0,include_docs:!0}).then(function(){T.getStack().show("#list-date"),h.displayHighlightedIdea()})},p=h.dom,d=p.querySelector(".bydate"),v=p.querySelector(".byrating"),E=new f(g,"library","_view/ideas",{key:u.get("uid"),descending:!0}),x=new f("_fti/local/"+g,"indexedideas","userbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),S=new f(g,"ideas","_view/privatebyvotes",{startkey:'["'+u.get("user").get("_id")+'",{}]',endkey:'["'+u.get("user").get("_id")+'"]',descending:!0}),T.getStack().add("#list-date",E),T.getStack().add("#list-rating",S),T.getStack().add("#list-search",x),S.init(),E.init().then(function(){T.getStack().show("#list-date"),h.displayHighlightedIdea()}),h}}),define("service/avatarlist",["OObject","Bind.plugin","Event.plugin","service/config","service/utils","Store"],function(e,t,n,r,i,s){function o(e){var i=new s([]),o,u=r.get("avatars");this.plugins.addAll({avatar:new t(i,{setAvatar:function(e){this.setAttribute("style","background-image: url('"+e+"');")}}),event:new n(this)}),this.template='<ul data-avatar="foreach"><li data-avatar="bind: setAvatar, img; bind: name, id"></li></ul>';for(o=0;o<e.length;o++)e[o]===r.get("user").get("_id")?i.alter("push",{id:e[o],img:r.get("avatar")}):u.get(e[o])?i.alter("push",{id:e[o],img:u.get(e[o])}):r.get("transport").request("GetAvatar",{id:e[o]},function(t){t.error||i.alter("push",{id:e[o],img:t})})}return function(n){return o.prototype=new e,new o(n)}}),define("library/sessions/sessions",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBView","CouchDBDocument","Store","service/utils","service/avatarlist","service/confirm","lib/spin.min","Promise"],function(e,t,n,r,s,o,u,a,f,l,c,h,p){return function(){var v=new e,m=new e,g=t.get("sessions"),y=new a,b=s.get("db"),w=s.get("transport"),E=s.get("user"),S=s.get("avatars"),x=s.get("labels"),T=new a({}),N="sbydate",C=[],k=[],L="",A=new o,O=(new h({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330})).spin(),M,_;return A.setTransport(w),v.plugins.addAll({label:new n(x),sort:new n(T,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(y,{setMode:function(e){switch(e){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');")}},formatDate:function(e){e&&e.length&&(this.innerHTML=f.formatDate(e))},formatIdeas:function(e){if(e&&e.length===1)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=x.get("noideayet")},setAvatars:function(e){var t,n;e&&(t=new l(e),n=document.createDocumentFragment(),node=this,t.place(n),node.hasChildNodes()?node.replaceChild(n,node.firstChild):node.appendChild(n))},setStatus:function(e){e==="completed"?this.innerHTML=x.get("completed"):this.innerHTML=x.get("inprogress")},setScore:function(e){e>=0?this.innerHTML=e:this.innerHTML=""},setSuffix:function(e){e===undefined||e===""||e===null?this.innerHTML=x.get("noscore"):this.innerHTML="ip"}}),sortevent:new r(v),sessionevent:new r(v)}),v.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen: dblclick, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>',v.sort=function(t,n){var r=n.getAttribute("id");T.get(r).selected?T.set(r,{selected:!0,descending:!T.get(r).descending}):(T.set(N,{selected:!1,descending:T.get(N).descending}),T.set(r,{selected:!0,descending:T.get(r).descending}),N=r),v.sortSessions(r)},v.sortSessions=function(t){var n;L?n=k:n=C;if(n.length)switch(t){case"sbytitle":f.sortByProperty(n,"title",T.get("sbytitle").descending);break;case"sbydate":f.sortByProperty(n,"date",T.get("sbydate").descending);break;case"sbyidea":f.sortByProperty(n,"idea",T.get("sbyidea").descending);break;case"sbyscore":f.sortByProperty(n,"score",T.get("sbyscore").descending)}y.reset(n)},v.acceptinput=function(e,t){t.removeAttribute("readonly")},v.search=function(t,n){var r=document.getElementById("sessionsearchresult");r.innerHTML="",t.keyCode===13&&(L=n.value,L===""?(v.sortSessions(N),y.reset(C)):(k=f.searchArray(C,L),r.innerHTML=x.get("foundlbl")+" "+k.length+" "+x.get("matchingsessions"),y.reset(k)))},v.displayActionBar=function(e,t){var n=t.getAttribute("data-sessions_id"),r=t.offsetHeight,i=y.get(n);t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+r+"px;height: "+r+"px;"),i.participants.length>1||i.participants[0]!=E.get("_id")||i.id===E.get("sessionInProgress").id?t.querySelector(".deletesession").setAttribute("style","display: none;"):t.querySelector(".deletesession").setAttribute("style","display: inline-block;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3)},v.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},v.press=function(e,t){var n=t.getAttribute("data-sessions_id");t.classList.add("pressed"),n&&O.spin(document.getElementById("sessionlistspinner"))},v.replay=function(e,t){var n=t.getAttribute("data-sessions_id"),r=y.get(n).id,i=y.get(n).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),O.stop(),s.get("observer").notify("replay-session",r,i)},v.deleteSession=function(e,t){var n=t.getAttribute("data-sessions_id"),r=y.get(n).id,i=function(e){var t=new u,n=new p;return t.setTransport(w),t.sync(b,e).then(function(){var e=t.get("replayIdeas")||[];e.forEach(function(e){var t=new u;t.setTransport(w),t.sync(b,e).then(function(){return t.set("sessionId",t.get("sessionId")+"_deleted"),t.set("sessionReplay",!1),t.upload()}).then(function(){t.unsync()},function(e){console.log(e)})}),w.request("cleanUpSession",r,function(e){e.err&&console.log(e.err),t.remove().then(function(){t.unsync(),n.fulfill()})})}),n},s,o=x.get("deletereplay"),a=function(e){e?(O.spin(document.getElementById("sessionlistspinner")),i(r).then(function(){O.stop(),s.close()})):s.close()};t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;"),y.get(n).replayIdeas&&y.get(n).replayIdeas.length?(O.stop(),s=new c(document.getElementById("session-list"),o,a),s.show()):i(r).then(function(){O.stop()})},v.resetSessionData=function(){C=[],A.loop(function(e,t){var n={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode,replayIdeas:e.value.replayIdeas};n.participants.push(e.value.initiator.id),n.usernames.push(e.value.initiator.username);for(j=0;j<e.value.participants.length;j++)n.participants.push(e.value.participants[j].id),n.usernames.push(e.value.participants[j].username);n.idea&&n.idea.length>1&&f.sortByProperty(n.idea,"title",!1),C.push(n)}),v.sortSessions("sbydate")},v.getMode=function(t){var n;return A.loop(function(e,r){e.id===t&&(n=e.value.mode)}),n},v.place(g),v.reset=function(){A.unsync(),A.reset(),y.reset([]),T.reset({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),N="sbydate",C=[],k=[],L="",A.sync(b,"library","_view/sessions",{key:s.get("uid"),descending:!0}).then(function(){v.resetSessionData()})},["added","deleted","updated"].forEach(function(e){A.watch(e,function(e,t){v.resetSessionData(),v.sortSessions(N)})}),v.reset(),v}}),define("library/decks/decklist/decklist",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","Promise","service/utils","service/actionbar"],function(e,t,n,r,i,s,o,u,a,f){return function(u){var l=new e,c=n.get("labels"),h=n.get("user"),p=new s([]),d=null;return l.plugins.addAll({labels:new r(c),active:new r(h,{}),decks:new r(p,{setVersion:function(e){e?this.innerHTML=c.get("version")+e:this.innerHTML=""},setAuthor:function(e){e==="Taiaut"?(this.innerHTML="",this.setAttribute("style","background-image:url('img/logo.png');")):this.innerHTML=e},date:function(e){e?this.innerHTML=a.formatDate(e):this.innerHTML=""}}),decklistevent:new i(l)}),l.template='<ul id="deck-list" data-decks="foreach"><li class="list-item" data-decklistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>',l.setStart=function(e,t){console.log("set Start node :",t),d&&d.hide()},l.showActionBar=function(e,t){console.log("doubleclick node :",t);var n=t.getAttribute("data-decks_id"),r=!1,i;d&&d.getParent()===t&&(r=!0),r||(d=new f("deck",t,p.get(n)._id),i=document.createDocumentFragment(),d.place(i),t.appendChild(i),r=!0)},l.reset=function(t){var n=t||null;p.reset([]),l.getDecks(u,n),display=!1},l.getModel=function(){return p},l.getDecks=function(t,r){var i=new o,s=[];switch(t){default:s=h.get("taiaut_decks").concat(h.get("custom_decks"))}i.setTransport(n.get("transport")),i.sync(n.get("db"),{keys:s}).then(function(){var e=h.get("lang"),t=[];i.loop(function(n,r){!n.doc.default_lang||n.doc.default_lang===e?t.push(n.doc):n.doc.translations&&n.doc.translations[e]?t.push(n.doc.translations[e]):t.push(n.doc)}),t.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),p.reset(t),r&&r("ok"),i.unsync()})},l.initSelected=function(t,n){var r=l.dom,i=r.querySelector(".list-item[data-decks_id='"+n+"']");t(i),i.classList.add("selected")},l.highlightDeck=function(t,n){var r=l.dom,i,s;return n===0?(i=r.querySelector(".list-item[data-decks_id='0']"),s=0):(p.loop(function(e,t){e._id===n&&(s=t)}),i=r.querySelector(".list-item[data-decks_id='"+s+"']")),t(i),i.classList.add("selected"),i.scrollIntoView(),s},l.init=function(t){l.reset(t)},h.watchValue("lang",function(){l.getDecks(u)}),l}}),define("library/decks/deckview/deckdetails",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","CouchDBDocument","CouchDBView","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new i,p=new i({max:0}),d=new i([]),v=new u,m=(new a({top:255,left:297,lines:8,radius:6,color:"#cccccc"})).spin(),g=t.get("user"),y=t.get("labels"),b,w=60,E=60,S=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=w/t,t=w):(t*=E/n,n=E),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},x=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=w,o=E,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},T=function(){var e="/upload",t=new FormData,n="deckpic",r=b;t.append("type",n),t.append("dir","decks"),t.append("filename",h.get("_id")),t.append("dataString",r),s.uploadFile(e,t,null,function(e){return e})};return v.setTransport(t.get("transport")),c.plugins.addAll({labels:new n(y),range:new n(p,{setCursorWidth:function(e){}}),cards:new n(d,{setStyle:function(e){e&&e==="null"?this.classList.add("invisible"):this.classList.remove("invisible")},formatTitle:function(e){var t,n=this;e&&(t=n.getAttribute("data-cards_id"),d.get(t).type&&d.get(t).type!==4?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?this.setAttribute("style","background-image:url('"+e+"');"):e?(i=(new a({color:"#657b99"})).spin(r),n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');"),i.stop()})):this.setAttribute("style","background-image: none;")}}),deckdetails:new n(h,{formatDate:function(e){e?this.innerHTML=s.formatDate(e):this.innerHTML=""},setPic:function(e){var n,r=this,i;e===""?this.setAttribute("style","background-image:url('img/connect/graygroup.png');"):e==="img/logo.png"?this.setAttribute("style","background-image:url('img/logo.png');"):e==="decklogo"&&(i=(new a({color:"#657b99"})).spin(r),n={dir:"decks",filename:h.get("_id")},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');"),i.stop()})),h.get("created_by")===g.get("_id")&&r.querySelector("input").classList.remove("invisible")},edit:function(e){e===g.get("_id")?(this.setAttribute("contenteditable",!0),this.classList.add("editable")):(this.setAttribute("contenteditable",!1),this.classList.remove("editable"))}}),carouselevent:new r(c),editevent:new r(c)}),c.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: mousedown, editPic"><input class="invisible" type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: change, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" ></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"></div><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider invisible" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div>',c.displayCards=function(t){var n,r=[];d.reset([]);for(n=0;n<5;n++)v.get(t-2+n)?r[n]=v.get(t-2+n).value:r[n]={style:"null"};d.reset(r),m.stop()},c.updateCards=function(e,t){c.displayCards(t.value)},c.displayButtons=function(e,t){c.dom.querySelector(".cancelmail").classList.remove("invisible"),c.dom.querySelector(".sendmail").classList.remove("invisible")},c.hideButtons=function(){c.dom.querySelector(".cancelmail").classList.add("invisible"),c.dom.querySelector(".sendmail").classList.add("invisible")},c.editPic=function(e,t){h.get("created_by")===g.get("_id")&&t.setAttribute("style","background-image: url('img/brainstorm/reload.png')")},c.changePic=function(e,t){var n=new FileReader,r=new Image,i=c.dom.querySelector(".decklogo"),s=(new a({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){x(S(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),b=e,c.displayButtons()})},300)},n.readAsDataURL(t.files[0])},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){var n=JSON.parse(h.toJSON());h.reset({}),h.reset(n),c.hideButtons(),t.classList.remove("pressed")},c.upload=function(e,n){var r=new o,i=c.dom.querySelector(".deckheader h2").innerHTML,s=c.dom.querySelector(".deckdescription").innerHTML,u=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30})).spin(n);n.classList.add("invisible"),r.setTransport(t.get("transport")),r.sync(t.get("db"),h.get("_id")).then(function(){var e=new Date;return b&&(T(),r.set("picture_file","decklogo")),r.set("title",i),r.set("description",s),r.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),r.upload()}).then(function(){l("updated",r.get("_id")),c.hideButtons(),n.classList.remove("pressed"),u.stop()}),b&&T()},c.reset=function(n){var r=c.dom.querySelector(".deckslider");c.dom.querySelector(".cancelmail").classList.add("invisible"),c.dom.querySelector(".sendmail").classList.add("invisible"),b=null,h.reset(n),m.spin(c.dom.querySelector(".deckcarousel")),p.set("max",0),v.reset([]),v.sync(t.get("db"),"library","_view/cards",{key:'"'+h.get("_id")+'"'}).then(function(){v.getNbItems()?r.classList.remove("invisible"):r.classList.add("invisible"),v.getNbItems()&&p.set("max",v.getNbItems()-1),v.unsync(),v.alter("sort",function(e,t){var n=e.value.title,r=t.value.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),c.displayCards(0)})},c}}),define("service/cardpopup",["OObject","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i){function s(e){var s=new i,o=r.get("labels"),u,a={x:0,y:0},f='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatName, firstname"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><ul><li><span class="cd-agelbl"></span><span data-carddetails="bind:innerHTML, age"></span><span class="agesuffix" data-label="bind:innerHTML, agelbl"></span></li><li><span class="cd-locationlbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, location"></span></li><li><span class="cd-joblbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, occupation.description"></span></li><li><span class="cd-familylbl"></span><span class="cd-info" data-carddetails="bind: setFamily, family"></span></li><li><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit"></span></li></ul></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl">Hobbies</span><p class = "charinfo" data-carddetails="bind:setLeisure, leisure_activities">hobbies</p><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "charinfo" data-carddetails="bind: setInterests, interests">Centers of interest</p><span class="contentTitle" data-label="bind: innerHTML, commentslbl">Comments</span><p class = "charinfo" data-carddetails="bind:setComments, comments"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',l='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatTitle, title"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><p><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit">Picture credits</span><br/><span class="cd-sourcelbl" data-label="bind:innerHTML, source">Source : </span><span class="cd-info" data-carddetails="bind: setSources, sources"></span></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><p class = "dyknow" data-carddetails="bind:innerHTML,didYouKnow"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',c='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark story"> <div class="storytitlelbl" data-label="bind:innerHTML, storytitlelbl"></div><div class="storytitle"><span data-label="bind:innerHTML, cdtitlelbl"></span> <span data-carddetails="bind: formatTitle, title"></span></div><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-contentarea story"><span class="contentTitle" data-label="bind: innerHTML, scenariodesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,story"></p><span class="contentTitle" data-label="bind: innerHTML, soldesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,solution"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>';this.plugins.addAll({label:new t(o),carddetails:new t(s,{setPosition:function(e){e&&this.setAttribute("style","left:"+e.x+"px; top:"+e.y+"px;")},setCaret:function(e){var t,n=s.get("position").y;n>340?t=240:t=60,e?this.setAttribute("style","display: inline-block; margin-top:"+t+"px;"):this.setAttribute("style","display: none;")},setPic:function(e){var t,n=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(t={dir:"cards",filename:e},r.get("transport").request("GetFile",t,function(e){n.setAttribute("style","background:white; background-image: url('"+e+"');")})):this.setAttribute("style","background-image: none;")},setSources:function(e){e&&e.length?e instanceof Array?this.innerHTML=e.join(", "):this.innerHTML=e:this.innerHTML=""},formatTitle:function(e){e&&(this.innerHTML=e.toUpperCase())},formatName:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase()+"  "+s.get("lastname").toUpperCase())},setFamily:function(e){var t=e.couple,n=e.children,r,i;t===0?r=o.get("singlelbl"):t===1?r=o.get("marriedlbl"):t===2?r=o.get("divorcedlbl"):t===3&&(r=o.get("widowlbl")),n===0?i="":(s.get("age")<20?n===1?i=n+o.get("onesiblinglbl"):i=n+o.get("siblingslbl"):n===1?i=n+o.get("onechildlbl"):i=n+o.get("childrenlbl"),i=", "+i),this.innerHTML=r+i},setLeisure:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)e[n].comment?t+="<li>"+e[n].name+" ("+e[n].comment+")</li>":t+="<li>"+e[n].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},setInterests:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)e[n].comment?t+="<li>"+e[n].name+" ("+e[n].comment+")</li>":t+="<li>"+e[n].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},setComments:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)t+="<li>"+e[n]+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""}}),popupevent:new n(this)}),this.close=function(t,n){u.classList.add("invisible"),e()},this.reset=function(t,n,r,i){u=i,this.template="",typeof t=="string"?s.reset(JSON.parse(t)):s.reset(t),s.set("position",n),r==="left"?s.set("caret",{left:!0,right:!1}):s.set("caret",{left:!1,right:!0}),s.get("type")===1?this.template=f:s.get("type")===5?this.template=c:this.template=l,this.render(),this.place(u),u.classList.remove("invisible")}}return function(n){return s.prototype=new e,new s(n)}}),define("library/decks/deckview/cardlist",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBBulkDocuments","CouchDBDocument","Store","service/cardpopup","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l,c,h){var p=new e,d=new o([]),v=new o([]),m=new o({currentPage:0,nbPages:0}),g,y=t.get("labels"),b=t.get("user"),w=null,E=null;return p.plugins.addAll({pagination:new n(m,{setPage:function(e){var t=e+1;m.get("nbPages")>1?this.innerHTML=y.get("page")+t+" / "+m.get("nbPages"):this.innerHTML=""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<m.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(v,{formatTitle:function(e){e?(this.classList.remove("newcard"),l!=="techno"?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;"))):this.classList.add("newcard")},setPic:function(e){var n,r=this;if(e&&e.search("img/decks/")>-1)this.setAttribute("style","background-image:url('"+e+"');");else if(e)n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});else switch(l){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}),cardlistevent:new r(p)}),p.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:mousedown, setStart; listen:dblclick, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn" data-cardlistevent="listen: mousedown, press; listen:mouseup, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: mousedown, press; listen:mouseup, deleteCard"></div></div></li></ul></div></div>',p.reset=function(t){E=null,p.dom.querySelector("#cardlist-popup").classList.add("invisible"),w=t,p.getCardList(t.content[l])},p.getCardList=function(n){var r=new i,s=n;n[0]==="newcard"&&(s=n.slice(1,n.length)),s.length?(r.setTransport(t.get("transport")),r.sync(t.get("db"),{keys:s}).then(function(){n[0]==="newcard"?d.reset([{_id:"newcard",title:"",picture_file:""}]):d.reset([]),r.loop(function(e,t){d.alter("push",e.doc)}),m.set("nbPages",Math.ceil(d.getNbItems()/12)),p.displayPage(0),r.unsync()})):(d.reset([{_id:"newcard",title:"",picture_file:""}]),m.set("nbPages",1),p.displayPage(0))},p.displayPage=function(t){var n,r=d.getNbItems()-12*t;m.set("currentPage",t),v.reset([]);for(n=0;n<r;n++)v.alter("push",d.get(t*12+n))},p.removeCard=function(n){var r=new s,i=new s,o,u,f,c,p=!0;if(b.get("active_deck")===w._id){o=w.content.characters.length,u=w.content.contexts.length,f=w.content.problems.length,c=w.content.techno.length;if(o<=2||u<=2||f<=2||c<=4)p=!1,alert(y.get("cannotremovecard"))}p&&(r.setTransport(t.get("transport")),i.setTransport(t.get("transport")),r.sync(t.get("db"),w._id).then(function(){var e=r.get("content"),t=e[l];return t.splice(t.indexOf(n),1),e[l]=t,r.set("content",e),r.upload()}).then(function(){return h("updated",w._id,l),r.unsync(),i.sync(t.get("db"),n)}).then(function(){var e=i.get("deck"),n=new a,r,s=i.get("picture_file");return e.splice(e.indexOf(w._id),1),e.length?(i.set("deck",e),i.upload().then(function(){n.fulfill()})):(s.search("img/decks")===-1&&(r={type:"card",file:s},t.get("transport").request("DeleteAttachment",r,function(e){e!=="ok"&&console.log(e)})),i.remove().then(function(){n.fulfill()})),n}))},p.push=function(e,t){t.classList.add("invisible"),e.stopPropagation()},p.press=function(e,t){t.classList.add("pressed")},p.previousPage=function(e,t){p.displayPrevious()},p.nextPage=function(e,t){p.displayNext()},p.displayPrevious=function(){var t=m.get("currentPage");t>0&&p.displayPage(t-1)},p.displayNext=function(){var t=m.get("currentPage");t<m.get("nbPages")-1&&p.displayPage(t+1)},p.changePage=function(e,t){var n=[e.pageX,e.pageY];n[0]>(document.width+301)/2?p.displayNext():p.displayPrevious()},p.highlight=function(e,t){E!==null&&document.querySelector("li[data-cards_id='"+E+"']").classList.remove("highlighted"),E=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},p.zoom=function(e,t){var n=t.getAttribute("data-cards_id");v.get(n)._id==="newcard"?(c("newcard",l),t.classList.remove("highlighted")):(p.setPopup(n),b.get("_id")===w.created_by&&(t.querySelector(".cardbtnbar").classList.remove("invisible"),v.get(n).created_by===b.get("_id")?t.querySelector(".editcardbtn").classList.remove("invisible"):t.querySelector(".editcardbtn").classList.add("invisible")))},p.editCard=function(t,n){var r=n.getAttribute("data-cards_id");t.stopPropagation(),g.close(),n.parentNode.classList.add("invisible"),c(v.get(r)._id,l)},p.deleteCard=function(t,n){var r=n.getAttribute("data-cards_id");t.stopPropagation(),g.close(),n.parentNode.classList.add("invisible"),p.removeCard(v.get(r)._id)},p.setPopup=function(t){var n,r={x:0,y:0},i="";n=t%12;switch(n){case 1:r.x=304,r.y=157,i="left";break;case 2:r.x=23,r.y=157,i="right";break;case 3:r.x=170,r.y=157,i="right";break;case 4:r.x=157,r.y=339,i="left";break;case 5:r.x=304,r.y=339,i="left";break;case 6:r.x=23,r.y=339,i="right";break;case 7:r.x=170,r.y=339,i="right";break;case 8:r.x=157,r.y=350,i="left";break;case 9:r.x=304,r.y=350,i="left";break;case 10:r.x=23,r.y=350,i="right";break;case 11:r.x=170,r.y=350,i="right";break;default:r.x=157,r.y=157,i="left"}g.reset(v.get(t),r,i,document.getElementById("cardlist-popup"))},p.closePopup=function(){p.dom.querySelector("li[data-cards_id='"+E+"']").classList.remove("highlighted"),p.dom.querySelector("li[data-cards_id='"+E+"']").querySelector(".cardbtnbar").classList.add("invisible"),E=null},g=new u(p.closePopup),p}}),define("library/decks/deckview/cardeditor/editchar",["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(f,l){var c=new e,h=t.get("user"),p=t.get("labels"),d={_id:"",default_lang:h.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:h.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},v=new n,m={},g=new s({error:""}),y,b=87,w=87,E=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=b/t,t=b):(t*=w/n,n=w),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},S=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=b,o=w,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},x=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=y;t.append("type",n),t.append("dir",r),t.append("filename",v.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){e.response!=="ok"&&console.log(e)})},T=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return v.setTransport(t.get("transport")),c.plugins.addAll({label:new r(p),model:new r(v,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=p.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))},setAge:function(e){!e&&e!==0&&(this.innerHTML="",this.setAttribute("placeholder","age"))},setCity:function(e){var t="";e&&e.length?(t=e.split(",")[0].trim(),this.value=t):this.value=""},setCountry:function(e){var t="";e&&e.length?(t=e.split(",").slice(1,e.length).join().trim(),this.value=t):this.value=""},setFamilyStatus:function(e){if(e||e===0)this.selectedIndex=e},setChildren:function(e){if(e||e===0)this.selectedIndex=e},setChildrenlbl:function(e){e&&e==="1"?this.innerHTML=p.get("onechildlbl"):this.innerHTML=p.get("childrenlbl")},setSituation:function(e){e&&e.length&&(this.selectedIndex=e[0])},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setComment:function(e){var t=this,n=t.getAttribute("name");[0,1].forEach(function(r){e&&e[r]&&n.search(r)>0&&(t.value=e[r])})}}),error:new r(g),editevent:new i(c)}),c.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl"></div></span><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl"></div></div></div>',c.reset=function(n,r){var i=new Date;y=null,g.set("error",""),m={},v.reset(),r==="newcard"?(v.reset(d),v.set("_id","C:"+i.getTime()),v.set("created_on",[i.getFullYear(),i.getMonth(),i.getDate()]),v.set("deck",[n])):v.sync(t.get("db"),r)},c.clearDefault=function(t,n){var r=n.getAttribute("name");v.get(r)===""&&(n.innerHTML="")},c.updateTitle=function(t,n){var r=n.innerHTML;r=r.charAt(0).toUpperCase()+r.slice(1),v.set("title",r)},c.selectpress=function(e,t){t.value=""},c.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},c.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=c.dom.querySelector(".cardpicture"),s=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){S(E(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),y=e})},300)},n.readAsDataURL(t.files[0])},c.updateField=function(e,t){var n=t.getAttribute("name"),r,i,s;m[n]=t.value},c.updateLocation=function(e,t){var n=v.get("location"),r,i;r=c.dom.querySelector("input[name='city']").value||"",i=c.dom.querySelector("input[name='country']").value||"",r&&i?n=r+", "+i:n=r+i,m.location=n},c.updateFamily=function(e,t){var n=t.getAttribute("name"),r=v.get("family");r[n]=t.selectedIndex,m.family=r},c.updateJob=function(e,t){var n=v.get("occupation"),r=t.getAttribute("name"),i;switch(r){case"situation":n.details[0]=t.selectedIndex;break;case"job":n.details[1]=t.value;break;case"organization":n.details[2]=t.value;break;default:n.description=t.value}m.occupation=n},c.updateLeisureName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("leisure_activities");i[r].name=t.value,m.leisure_activities=i},c.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("leisure_activities");i[r].comment=t.value,m.leisure_activities=i},c.updateInterestName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("interests");i[r].name=t.value,m.interests=i},c.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("interests");i[r].comment=t.value,m.interests=i},c.updateComments=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("comments");i[r]=t.value,m.comments=i},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){l()},c.upload=function(e,n){var r=new Date,i=v.get("firstname"),s=v.get("lastname");n.classList.remove("pressed"),g.set("error",""),T.spin(n),v.get("title")||(i&&s?v.set("title",i+" "+s):(i||s)&&v.set("title",i+s)),v.get("title")||g.set("error",p.get("titlerequired")),g.get("error")?T.stop():v.get("_rev")?(v.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),c.uploadCard(n)):v.sync(t.get("db"),v.get("_id")).then(function(){console.log("new card created : ",v.toJSON()),c.uploadCard()})},c.uploadCard=function(t){var n;y&&(x(),v.set("picture_file",v.get("_id")));if(m!=={})for(n in m)v.set(n,m[n]);v.upload().then(function(){return console.log("card upload successful :",v.get("_rev")),f(v.get("type"),v.get("_id"))}).then(function(){T.stop(),l(),v.unsync(),v.reset({})})},MODEL=v,c}}),define("library/decks/deckview/cardeditor/editcard",["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(f,l){var c=new e,h=t.get("user"),p=t.get("labels"),d={_id:"",default_lang:h.get("lang"),title:"",didYouKnow:"",deck:[],category:"",coefficient:1,sources:[],created_by:h.get("_id"),created_on:[],picture_credit:"",type:null,picture_file:""},v=new n,m=new s({error:""}),g,y=87,b=87,w=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=y/t,t=y):(t*=b/n,n=b),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},E=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=y,o=b,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},S=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=g;t.append("type",n),t.append("dir",r),t.append("filename",v.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){e.response!=="ok"&&console.log(e)})},x=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return v.setTransport(t.get("transport")),c.plugins.addAll({label:new r(p),model:new r(v,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=p.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},formatTitle:function(e){switch(e){case 2:this.setAttribute("style","background: #5f8f28");break;case 3:this.setAttribute("style","background: #bd262c");break;case 4:this.setAttribute("style","background: #f27b3d");break;default:}},setSources:function(e){e&&e.length?e instanceof Array?this.innerHTML=e.join(", "):this.innerHTML=e:this.innerHTML=""},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))}}),error:new r(m),editevent:new i(c)}),c.template='<div class="cardpopup editcard"><div class="card-detail"><div class="cd-header blue-dark" data-model="bind:formatTitle, type"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class ="cardpicture" data-model="bind:setPic, picture_file"></div><div class="picinfo"><span class="cd-creditslbl"data-label="bind:innerHTML, credits"></span><input type="text" class="input editcredit" data-label="bind: placeholder, picturecredit" data-model="bind:value, picture_credit"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editevent="listen:mousedown, press; listen:mouseup, release"></div></span></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><textarea class="input enterdyknow" data-label="bind: placeholder, enterdyknow" data-model="bind:value,didYouKnow"></textarea><span class="cd-sourcelbl" data-label="bind:innerHTML, source"></span><textarea class="input entersources" data-label="bind: placeholder, dyknowsources" data-model="bind: value, sources"></textarea></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl">Save</div></div></div>',c.reset=function(n,r,i){var s=new Date;g=null,m.set("error",""),v.reset(),r==="newcard"?(v.reset(d),v.set("_id","C:"+s.getTime()),v.set("created_on",[s.getFullYear(),s.getMonth(),s.getDate()]),v.set("deck",[n]),i==="contexts"&&(v.set("type",2),v.set("picture_file","img/decks/context.png")),i==="problems"&&(v.set("type",3),v.set("picture_file","img/decks/problem.png")),i==="techno"&&(v.set("type",4),v.set("picture_file","img/decks/technology.png"))):v.sync(t.get("db"),r)},c.changeType=function(t){switch(t){case 1:v.set("type",2),v.set("picture_file","img/decks/context.png");break;case 2:v.set("type",3),v.set("picture_file","img/decks/problem.png");break;case 3:v.set("type",4),v.set("picture_file","img/decks/technology.png");break;default:v.set("type",2),v.set("picture_file","img/decks/context.png")}},c.clearDefault=function(t,n){var r=n.getAttribute("name");v.get(r)===""&&(n.innerHTML="")},c.updateTitle=function(t,n){var r=n.innerHTML;v.get("type")===4?r=r.toUpperCase():r=r.charAt(0).toUpperCase()+r.slice(1),v.set("title",r)},c.selectpress=function(e,t){t.value=""},c.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},c.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=c.dom.querySelector(".cardpicture"),s=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){E(w(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),g=e})},300)},n.readAsDataURL(t.files[0])},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),l(),v.unsync(),v.reset({})},c.upload=function(e,n){var r=new Date;n.classList.remove("pressed"),m.set("error",""),x.spin(n),(!v.get("title")||v.get("title")==="<br>")&&m.set("error",p.get("titlerequired")),m.get("error")?x.stop():v.get("_rev")?(v.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),c.uploadCard(n)):v.sync(t.get("db"),v.get("_id")).then(function(){c.uploadCard()})},c.uploadCard=function(t){g&&(S(),v.set("picture_file",v.get("_id"))),v.upload().then(function(){return f(v.get("type"),v.get("_id"))}).then(function(){x.stop(),l(),v.unsync(),v.reset({})})},c}}),define("library/decks/deckview/cardeditor/importcard",["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","CouchDBView","Promise","lib/spin.min","service/confirm","service/map"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p){var d=new e,v=t.get("labels"),m=t.get("user"),g=t.get("transport"),y=t.get("db"),b=new i([]),w=new i([]),E=[],S,x=new i,T;return d.template='<div class="importcard"><div class="importfrom"><label data-label="bind:innerHTML, importfrom"></label><select data-model="bind:setDecks, decks" data-importevent="listen: change, updateSelect"></select></div><div class="importlist"><legend data-label="bind:innerHTML, seldeck"></legend><ul name="selected" data-selected="foreach"><li name="selected" data-selected="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="importarea"><button class="addremove invisible" data-model="bind: setVisible, sel; bind: setDirection, direction" data-importevent="listen: mouseup , addRemoveSelected">Add/remove</button><button class="invisible" data-label="bind:innerHTML, selall" data-model="bind:setVisible, sel" data-importevent="listen: mouseup , selectAll"></button><button class="invisible" data-label="bind:innerHTML, clearsel" data-model="bind: setVisible, sel" data-importevent="listen: mouseup , clearSelected">Clear selection</button></div><div class="importlist"><legend data-label="bind:innerHTML, workdeck"></legend><ul data-current="foreach"><li name="current" data-current="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="cancelmail" data-importevent="listen:mousedown, press; listen:mouseup , cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-importevent="listen:mousedown, press; listen:mouseup , upload" data-label="bind:innerHTML, savelbl">Save</div></div>',d.plugins.addAll({label:new n(v),model:new n(x,{setDecks:function(e){var t,n,r="",i,s;if(e)for(t=0,n=e.length;t<n;t++)e[t]._id!==S&&(r+="<option>"+e[t].title+"</option>");this.innerHTML=r},setDirection:function(e){e?node.classList.remove("invisible"):node.classList.add("invisible"),e==="remove"?this.innerHTML=v.get("remsel"):this.innerHTML=v.get("impsel")},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),current:new n(b,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;");break;default:}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),selected:new n(w,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;");break;default:}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),importevent:new r(d)}),d.cancel=function(e,t){t.classList.remove("pressed"),p()},d.upload=function(e,t){var n=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin(t),r=["newcard"],i=["newcard"],s=["newcard"],o=["newcard"];E.length&&g.request("DeleteCards",{idList:E},function(e){return e}),b.loop(function(e,t){switch(e.type){case 1:r.push(e.id);break;case 2:i.push(e.id);break;case 3:s.push(e.id);break;case 4:o.push(e.id);break;default:r.push(e.id)}}),h({characters:r,contexts:i,problems:s,techno:o}).then(function(){n.stop(),t.classList.remove("pressed"),p()})},d.press=function(e,t){t.classList.add("pressed")},d.updateSelect=function(e,t){var n=t.selectedIndex;w.reset([]),d.getDeckCards(x.get("decks")[n]._id,w)},d.toggleSelect=function(e,t){var n=t.getAttribute("name"),r=t.getAttribute("data-"+n+"_id"),i,s=x.get("sel")||0;n==="current"?(i=b,x.get("direction")!=="remove"&&(d.clearSelection("selected"),x.set("direction","remove"),s=0)):(i=w,x.get("direction")!=="add"&&(d.clearSelection("current"),x.set("direction","add"),s=0)),i.get(r).selected?(i.update(r,"selected",!1),x.set("sel",s-1)):(i.update(r,"selected",!0),x.set("sel",s+1))},d.selectAll=function(e,t){var n;x.get("direction")==="add"?n=w:n=b,n.loop(function(e,t){n.update(t,"selected",!0)})},d.clearSelected=function(e,t){var n;x.get("direction")==="add"?n=w:n=b,n.loop(function(e,t){n.update(t,"selected",!1)}),x.set("sel",0)},d.addRemoveSelected=function(e,t){var n=x.get("direction");n==="add"?d.addSelected():d.removeSelected()},d.addSelected=function(){var t=b.toJSON(),n=JSON.parse(t),r=d.dom.querySelector("ul[name='current']"),i=(new a).spin(r);b.reset([]),w.loop(function(e,r){e.selected&&t.search(e.id)===-1&&n.push({id:e.id,type:e.type,title:e.title,deck:e.deck.concat(),selected:e.selected})}),n.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),b.reset(n),i.stop(),d.clearSelection("selected"),x.set("direction","remove")},d.removeSelected=function(){var t=[],n=[],r="";b.loop(function(e,r){e.selected&&(t.push(r),e.deck.length===1&&e.deck[0]===S&&n.push({title:e.title.toUpperCase(),id:e.id}))}),n.length?(l.get("cache").classList.add("appear"),n.forEach(function(e){r+=e.title+", "}),r=r.slice(0,-2),T=new f(document.body,v.get("delcardwarning")+r,function(e){e&&(b.delAll(t),d.clearSelection("current"),x.set("sel",0),n.forEach(function(e){E.push(e.id)})),document.body.removeChild(document.querySelector(".confirm")),l.get("cache").classList.remove("appear")},"importcard-confirm")):(b.delAll(t),d.clearSelection("current"),x.set("sel",0))},d.clearSelection=function(e){var t;e==="current"?t=b:t=w,t.loop(function(e,n){e.selected&&e.selected===!0&&t.update(n,"selected",!1)})},d.getDecks=function(t){var n=new s,r=m.get("taiaut_decks").concat(m.get("custom_decks")),i=new u;return n.setTransport(g),n.sync(y,{keys:r}).then(function(){var e=m.get("lang"),r=[],s;n.loop(function(t,n){if(t.doc.public||t.doc.created_by===m.get("_id")||t.doc.sharedwith&&t.doc.sharedwith.indexOf(m.get("_id")))!t.doc.default_lang||t.doc.default_lang===e?r.push(t.doc):t.doc.translations&&t.doc.translations[e]?r.push(t.doc.translations[e]):r.push(t.doc)});for(s=r.length-1;s>=0;s--)r[s]._id===t&&r.splice(s,1);r.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),x.set("decks",r.concat()),i.fulfill(),n.unsync()}),i},d.getDeckCards=function(t,n){var r=new o,i=new u,s=d.dom.querySelector("ul[name='selected']"),f=(new a).spin(s);return r.setTransport(g),r.sync(y,"library","_view/cards",{key:'"'+t+'"'}).then(function(){var e=[];r.loop(function(t,n){e.push({id:t.value._id,type:t.value.type,title:t.value.title,deck:t.value.deck})}),e.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),f.stop(),n.reset(e),i.fulfill()}),i},d.reset=function(t){x.reset({}),b.reset([]),w.reset([]),E=[],d.dom.querySelector("select").selectedIndex=0,S=t,d.getDecks(S).then(function(){d.getDeckCards(S,b),d.getDeckCards(x.get("decks")[0]._id,w)})},m.watchValue("taiaut_decks",function(){d.getDecks()}),m.watchValue("custom_decks",function(){d.getDecks()}),m.watchValue("lang",function(){d.getDecks()}),d}}),define("library/decks/deckview/cardeditor/newcard",["OObject","Bind.plugin","Event.plugin","Amy/Stack-plugin","service/config","Store","CouchDBDocument","./editchar","./editcard","./importcard","Promise"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h){var p=new e,d=new r,v=new s;return cardCDB=new o,labels=i.get("labels"),user=i.get("user"),transport=i.get("transport"),close=function(){p.dom.classList.add("invisible")},updateDeck=function(e,t){var n=new l,r=v.get("deckId"),s=new o,u="characters";switch(e){case 1:u="characters";break;case 2:u="contexts";break;case 3:u="problems";break;case 4:u="techno";break;default:console.log("no type detected")}return s.setTransport(transport),s.sync(i.get("db"),r).then(function(){var e=new Date,n=s.get("content"),r=n[u];return r.indexOf(t)<0&&(r.push(t),n[u]=r,s.set("content",n)),s.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),s.upload()}).then(function(){s.unsync(),h("updated",r,e),n.fulfill()}),n},removeCard=function(e){var t=new o,n=new l;return t.setTransport(transport),t.sync(i.get("db"),e).then(function(){var e=t.get("deck")||[],n=new l;return e.splice(e.indexOf(v.get("deckId")),1),e.length?(t.set("deck",e),t.upload().then(function(){n.fulfill()})):(file.search("img/decks")===-1&&(json={type:"card",file:file},transport.request("DeleteAttachment",json,function(e){e!=="ok"&&console.log(e)})),t.remove().then(function(){n.fulfill()})),n}).then(function(){return n}),n},addToDeck=function(e){var t=new o,n=new l;return t.setTransport(transport),t.sync(i.get("db"),e).then(function(){var e=t.get("deck")||[],n=v.get("deckId");return e.indexOf(n)<0&&e.push(n),t.set("deck",e),t.upload()}).then(function(){n.fulfill(),t.unsync()}),n},updateImport=function(e){var t=new l,n=v.get("deckId"),r=new o,s=[],u=[],a=new Date;return r.setTransport(transport),r.sync(i.get("db"),n).then(function(){var t={},n={characters:e.characters.concat(),contexts:e.contexts.concat(),problems:e.problems.concat(),techno:e.techno.concat()},i,o=!1;return r.get("translations")?i=r.get("translations"):i={},i.hasOwnProperty(user.get("lang"))&&(o=!0),o?(["characters","contexts","problems","techno"].forEach(function(e){t[e]=i[user.get("lang")].content[e].concat()}),i[user.get("lang")].content=n,r.set("translations",i)):(["characters","contexts","problems","techno"].forEach(function(e){t[e]=r.get("content")[e].concat()}),r.set("content",n)),["characters","contexts","problems","techno"].forEach(function(e){var r=t[e],i=n[e],o,a,f,l;for(o=0,l=r.length;o<l;o++)i.indexOf(r[o])<0&&u.push(r[o]);for(a=0,f=i.length;a<f;a++)r.indexOf(i[a])<0&&s.push(i[a])}),s.forEach(function(e){addToDeck(e)}),u.forEach(function(e){removeCard(e)}),(s.length||u.length)&&r.set("last_updated",[a.getFullYear(),a.getMonth(),a.getDate()]),r.upload()}).then(function(){h("updated",n,null),t.fulfill()}),t},editCard=new a(updateDeck,close),editChar=new u(updateDeck,close),importCard=new f(updateImport,close),p.template='<div id="card_creation" class="invisible"><div class="header blue-dark" data-label="bind: innerHTML, cardeditor"></div><div class="create_header"><label data-label="bind:innerHTML, createnew"></label><select class="changetype" data-setup="bind: selectedIndex, type" data-newcardevent="listen: change, changeType"><option data-label="bind:innerHTML, char"></option><option data-label="bind:innerHTML, context"></option><option data-label="bind:innerHTML, problem"></option><option data-label="bind:innerHTML, techno"></option><option data-label="bind:innerHTML, importcard"></option></select></div><div class="createcontentstack" data-newcardcontentstack="destination"></div></div>',p.plugins.addAll({label:new t(labels),setup:new t(v),newcardcontentstack:d,newcardevent:new n(p)}),p.close=close,p.reset=function(t,n,r,i){document.getElementById("card_creation").classList.remove("invisible"),v.reset({deckId:r,title:i,type:["characters","contexts","problems","techno"].indexOf(n)}),n==="characters"?(editChar.reset(r,t),d.getStack().show("editchar")):(editCard.reset(r,t,n),d.getStack().show("editcard"))},p.press=function(e,t){t.classList.add("pressed")},p.changeType=function(e,t){var n=t.selectedIndex;n===4?(importCard.reset(v.get("deckId")),d.getStack().show("importcard")):n===0?(editChar.reset(v.get("deckId"),"newcard"),d.getStack().show("editchar")):(editCard.reset(v.get("deckId"),"newcard",v.get("type")),d.getStack().show("editcard"),editCard.changeType(n))},p.init=function(){d.getStack().add("editchar",editChar),d.getStack().add("editcard",editCard),d.getStack().add("importcard",importCard)},p.init(),p}}),define("library/decks/deckview/deck-share",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(u){var a=new e,f=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:p.get("signature")}),g=new o([]),y=new o([]),b=!1,w=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return a.plugins.addAll({labels:new r(v),share:new r(m,{setHeader:function(e){this.innerHTML=v.get("sharing")+e}}),contacts:new r(y,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(g,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(a),errormsg:new r(f)}),a.template='<div class="deck-share invisible"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: touchstart, press; listen:touchend, selectAll">Select all</div><input class="search" data-shareevent="listen:touchstart, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:touchstart,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:touchend, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:touchstart, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: touchstart, press; listen:touchend, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:touchstart, press; listen:touchend, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',a.show=function(){a.dom.classList.remove("invisible"),document.getElementById("deckview").setAttribute("style","overflow-y: scroll;")},a.hide=function(){a.dom.classList.add("invisible"),document.getElementById("deckview").setAttribute("style","overflow-y: none;"),m.reset({body:"",docId:"",docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),f.reset({errormsg:""}),y.reset([]),g.reset(p.get("connections").concat())},a.reset=function(t){f.reset({errormsg:""}),m.reset({body:"",docId:t,docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),a.getDocDetails(t),p.get("signature")&&m.set("signature",p.get("signature")),y.reset([]),g.reset(p.get("connections").concat())},a.getDocDetails=function(t){var r=new l({});r.setTransport(d),r.sync(n.get("db"),t).then(function(){m.set("docType",r.get("type")),m.set("docTitle",r.get("title")),r.unsync()})},a.updateAutoContact=function(e,t){var n=JSON.parse(g.toJSON()),r=p.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")g.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);g.reset(n)}g.loop(function(e,t){y.toJSON().search(e.userid)>-1&&g.update(t,"selected",!0)})},a.close=function(t,n){n.parentNode.classList.add("invisible")},a.displayAutoContact=function(e,t){a.dom.querySelector("#sharelistauto").classList.remove("invisible"),g.reset(p.get("connections").concat())},a.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=y.get(n).userid;y.alter("splice",n,1),g.loop(function(e,t){e.userid===r&&setTimeout(function(){g.update(t,"selected",!1)},200)}),a.unselectGroup(r)},a.select=function(e,t){var n=t.getAttribute("data-auto_id");g.get(n).selected?(a.removeContact(g.get(n)),setTimeout(function(){g.update(n,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(a.addContact(g.get(n)),a.selectGroup(),setTimeout(function(){g.update(n,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},a.selectAll=function(e,t){t.classList.remove("pressed"),y.reset([]),g.reset(p.get("connections").concat()),g.loop(function(e,t){g.update(t,"selected",!0),e.type==="user"&&y.alter("push",e)})},a.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)a.removeContact(e.contacts[j]);else y.loop(function(t,n){t.userid===e.userid&&y.alter("splice",n,1)}),a.unselectGroup(e.userid),g.loop(function(t,n){t.userid===e.userid&&g.update(n,"selected",!1)})},a.selectGroup=function(){var e,t=!1;g.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(y.toJSON().search(e[j].userid)<0){t=!1;break}t&&g.update(r,"selected",!0)}})},a.unselectGroup=function(e){g.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&g.update(n,"selected",!1)})},a.addContact=function(e){var t,n,r=!0;if(e.type==="user")y.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)y.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(y.alter("push",e.contacts[t]),g.loop(function(n,r){n.userid===e.contacts[t].userid&&g.update(r,"selected",!0)}))},a.press=function(e,t){t.classList.add("pressed")},a.share=function(e,t){var n=new Date,r=new c,i={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:p.get("_id"),username:p.get("username"),firstname:p.get("firstname"),toList:"",ccList:"",object:"",body:m.get("body"),signature:m.get("signature"),docId:m.get("docId"),docType:m.get("docType"),docTitle:m.get("docTitle"),dest:[]};b||(b=!0,w.spin(t),a.buildRecipientList(i.docId,i.dest).then(function(){i.dest.length?(d.request("ShareDeck",{idList:i.dest,docId:i.docId},function(e){e==="ok"&&r.fulfill()}),r.then(function(){d.request("Notify",i,function(e){f.set("errormsg",v.get("shareok")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(i.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),a.hide()},2500)})})):(f.set("errormsg",v.get("alreadyshared")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(i.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),a.hide()},2500))}))},a.cancel=function(e,t){t.classList.remove("pressed"),a.hide()},a.buildRecipientList=function(t,r){var i=new c,s=new l;return s.setTransport(d),s.sync(n.get("db"),t).then(function(){var e=s.get("sharedwith")||[],t;return y.loop(function(t,n){e.length?e.indexOf(t.userid)<0&&(e.push(t.userid),r.push(t.userid)):(e.push(t.userid),r.push(t.userid))}),s.set("sharedwith",e),s.upload()}).then(function(){i.fulfill()}),i},a}}),define("library/decks/deckview/deckview",["OObject","Bind.plugin","Event.plugin","Place.plugin","Amy/Stack-plugin","Store","service/map","./deckdetails","./cardlist","service/config","./cardeditor/newcard","./deck-share"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(h){var p=new e,d=new l(h),v=new c,m=new s([{name:"characters",active:!1,count:0},{name:"contexts",active:!1,count:0},{name:"problems",active:!1,count:0},{name:"techno",active:!1,count:0}]),g=new i,y="",b="";return p.plugins.addAll({cardmenu:new t(m,{setClass:function(e){this.classList.add(e)},setActive:function(e){e?this.classList.add("active"):this.classList.remove("active")}}),place:new r({newCard:d,shareDeck:v}),deckviewstack:g,deckviewevent:new n(p)}),p.template='<div><div data-place="place: newCard"></div><div data-place="place: shareDeck"></div><ul class="card-menu" data-cardmenu="foreach"><li><div class="card-type" data-cardmenu = "bind: setClass, name; bind:setActive, active" data-deckviewevent="listen: mousedown, viewCards"></div><div class="card-count" data-cardmenu="bind:innerHTML, count"></div></li></li></ul><div id="deckviewstack" data-deckviewstack="destination"></div></div>',p.viewCards=function(e,t){var n=t.getAttribute("data-cardmenu_id");m.loop(function(e,t){t===parseInt(n)?m.update(t,"active",!0):m.update(t,"active",!1)}),g.getStack().show(m.get(n).name)},p.editCard=function(t,n){d.reset(t,n,b,y)},p.hideEditView=function(){d.close()},p.reset=function(t,n){console.log("deck view reset function: ",t),p.hideEditView(),v.hide(),console.log("calling all ui reset functions"),["details","characters","contexts","problems","techno"].forEach(function(e){g.getStack().get(e).reset(t)}),b=t._id,y=t.title,m.reset([]),["characters","contexts","problems","techno"].forEach(function(e){t.content[e][0]==="newcard"?m.alter("push",{name:e,active:!1,count:t.content[e].length-1}):m.alter("push",{name:e,active:!1,count:t.content[e].length})}),n?g.getStack().show(n):g.getStack().show("details")},p.init=function(){var t=new u(h);console.log("deck details ok"),g.getStack().add("details",t),["characters","contexts","problems","techno"].forEach(function(e){var t=new a(e,p.editCard,h);console.log(e,"ui init ok"),g.getStack().add(e,t)})},f.get("observer").watch("deck-share",function(e){v.reset(e),v.show()}),p}}),define("library/decks/newdeck",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min","service/utils"],function(e,t,n,r,i,s,o,u){return function(a){var f=new e,l=new s({}),c=i.get("user"),h=i.get("transport"),p=i.get("labels"),d=new s({error:""}),v=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),m,g=60,y=60,b=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=g/t,t=g):(t*=y/n,n=y),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},w=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=g,o=y,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},E=function(){var e="/upload",t=new FormData,n="deckpic",r="decks",i=m;t.append("type",n),t.append("dir",r),t.append("filename",l.get("_id")),t.append("dataString",i),u.uploadFile(e,t,null,function(e){console.log(e)})};return l.setTransport(i.get("transport")),f.plugins.addAll({newdeck:new n(l),labels:new n(p),errormsg:new n(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new r(f)}),f.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:mousedown, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend data-labels="bind: innerHTML, setdecklogo"></legend><div class="deckicon"><div class="decklogo"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-newdeckevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-labels="bind:innerHTML, importlbl" data-newdeckevent="listen: mousedown, press; listen: mouseup, release"></div></span></div><div class="newidea-footer"><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>',f.reset=function(t){l.reset({_id:"",type:9,description:"",default_lang:c.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:c.get("_id"),author:c.get("username"),"public":!1,sharedwith:[]}),m=null},f.show=function(){f.reset(),document.querySelector("#library .cache").classList.add("appear"),f.dom.classList.add("appear")},f.press=function(e,t){t.classList.add("pressed")},f.selectpress=function(e,t){t.value=""},f.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},f.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=f.dom.querySelector(".decklogo"),s=(new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none;"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){w(b(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),m=e,l.set("picture_file","decklogo")})},300)},n.readAsDataURL(t.files[0])},f.closePopup=function(){f.dom.classList.remove("appear"),document.querySelector("#library .cache").classList.remove("appear"),l.unsync(),f.reset(),d.reset({error:""})},f.resetError=function(e,t){var n;t.scrollTop=99999,d.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",d.get("error")===n&&t.value&&d.set("error",""))},f.cancel=function(e,t){f.closePopup()},f.upload=function(e,t){var n=new Date,r="D:"+n.getTime();t.classList.remove("pressed"),l.get("title")?l.get("description")||d.set("error","nodesc"):d.set("error","notitle"),!d.get("error")&&!l.get("_id")&&(t.classList.add("invisible"),v.spin(t.parentNode),l.set("_id",r),l.set("date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),l.sync(i.get("db"),r).then(function(){return l.get("picture_file")&&E(),l.upload()}).then(function(){a("new",r);var e=c.get("custom_decks")||[];return e.unshift(r),c.set("custom_decks",e),c.upload()}).then(function(){v.stop(),t.classList.remove("invisible"),f.closePopup()}))},f.reset(),f}}),define("library/decks/decks",["OObject","Bind.plugin","Amy/Stack-plugin","Amy/Control-plugin","Event.plugin","Place.plugin","service/config","service/map","./decklist/decklist","./deckview/deckview","./newdeck"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var c=new e,h=new r(c),p=o.get("user"),d,v=new n,m,g,y,b=function(e){var t=v.getStack().getCurrentScreen(),n=t.getModel();d=t.highlightDeck(h.init,e),x.reset(n.get(d))},w=!1,E,S=function(e,t,n){var r;E=t,e==="new"&&(w=!0,E=t),e==="updated"&&(r=v.getStack().getCurrentScreen(),r.reset(function(e){e&&(r.highlightDeck(h.init,t),x.reset(r.getModel().get(d),n))}))},x=new f(S),T=new l(S);return c.plugins.addAll({label:new t(o.get("labels")),deckliststack:v,decksevent:new i(c),deckplace:new s({deckView:x,newDeck:T}),deckscontrol:h}),c.template='<div id="decks"><div id="decklist" class="list"><div class="header blue-light"><div class="option left" data-deckscontrol=""></div><span data-label="bind: innerHTML, decklistheadertitle"></span><div class="option right" data-decksevent="listen: mousedown, plus"></div></div><div class="overflow" data-deckliststack="destination" data-deckscontrol="radio:li,selected,mousedown,selectStart"></div></div><div id="deckview" data-deckplace="place:deckView" class="details"></div><div data-deckplace="place:newDeck"></div></div>',c.reset=function(){m.reset(function(e){e&&(v.getStack().show("ideafy"),m.highlightDeck(h.init,0),x.reset(m.getModel().get(0)),d=0)})},c.displayDeck=b,c.init=function(){console.log("deck init"),m=new a("all_decks"),v.getStack().add("ideafy",m),console.log("list added to stack"),m.init(function(e){console.log("ideafy deck init called"),e&&(v.getStack().show("ideafy"),x.init(),consle.log("after deckview init"),m.highlightDeck(h.init,0),x.reset(m.getModel().get(0)),console.log("after deckview reset call"),d=0)})},c.selectStart=function(e){var t=v.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-decks_id");x.reset(t.get(n)),d=n},c.plus=function(e,t){T.show()},c.init(),p.watchValue("lang",function(){var e=v.getStack().getCurrentName(),t,n=v.getStack().getCurrentScreen();switch(e){case"taiaut":t="taiaut_decks";case"custom":t="custom_decks";break;default:t="all_decks"}n.getDecks(t,function(e){e&&(n.initSelected(h.init,d),x.reset(n.getModel().get(d)))})}),p.watchValue("custom_decks",function(e,t,n){m.reset(function(t){var r;t&&w?b(E):t&&e.length<n.length&&(r=m.getModel(),r.getNbItems()&&(m.initSelected(h.init,0),x.reset(r.get(0)),d=0)),w=!1})}),p.watchValue("taiaut_decks",function(e,t,n){m.reset(function(e){e&&(m.initSelected(h.init,0),x.reset(m.getModel().get(0)))})}),c}}),define("library/library",["OObject","Amy/Stack-plugin","service/map","service/submenu","./ideas/ideas","./sessions/sessions","./decks/decks","service/config"],function(e,t,n,r,i,s,o,u){return function(){var f=new e,l=new t,c,h,p,d=u.get("observer"),v=function(t){l.getStack().show(t)},m;return f.plugins.add("librarystack",l),f.template='<div id="library"><div class="cache"></div><div id="library-menu"></div><div class="stack" data-librarystack="destination"></div></div>',f.place(n.get("library")),f.showMenu=function(){m.toggleActive(!0)},f.hideMenu=function(){m.toggleActive(!1)},f.reset=function(){c.reset(),p.reset(),h.reset(),m.reset(),l.getStack().show("#ideas")},m=new r(f.dom.querySelector("#library-menu"),v),m.toggleActive(!1),c=new i,h=new s,p=new o,l.getStack().add("#ideas",c),l.getStack().add("#sessions",h),l.getStack().add("#decks",p),console.log("deck UI added to stack"),l.getStack().show("#ideas"),d.watch("display-doc",function(e,t){switch(t){case 6:var n=l.getStack().get("#ideas");n.searchIdea(e.substr(2)),l.getStack().getCurrentScreen()!==n&&l.getStack().show("#ideas");break;case 9:l.getStack().show("#decks");break;default:}}),f}}),define("brainstorm/ideafy-menu",["OObject","service/map","Store","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r,i,s){return function(u){var a=new e,f=s.get("user"),l=s.get("labels"),c=new n,h={name:"continue",active:!0,selected:!1,label:l.get("continuesession"),bg:"continuesession.png",bgselected:"continueactive.png"},p="";return a.plugins.addAll({ideafymenu:new r(c,{setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")},setBg:function(e){var t=this.getAttribute("data-ideafymenu_id");e?this.setAttribute("style","background-image:url('img/brainstorm/"+c.get(t).bgselected+"');color:white;"):this.setAttribute("style","background-image:url('img/brainstorm/"+c.get(t).bg+"');color:#4D4D4D;")}}),labels:new r(l),ideafyevent:new i(this)}),a.template='<div id="ideafy-menu"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, brainstormchoosemode"></div><ul class="menu" data-ideafymenu = "foreach"><li data-ideafymenu="bind:innerHTML, label; bind: setActive, active; bind:setBg, selected" data-ideafyevent="listen:mousedown, press; listen: mouseup, start"></li></ul></div>',a.place(t.get("ideafy-menu")),this.press=function(e,t){var n=t.getAttribute("data-ideafymenu_id");c.update(n,"selected",!0),t.classList.add("pressed")},this.start=function(e,t){var n=t.getAttribute("data-ideafymenu_id");c.get(n).name==="continue"?u("continue",p):u(c.get(n).name),t.classList.remove("pressed"),c.update(n,"selected",!1)},a.addContinue=function(t){var n=JSON.parse(c.toJSON());c.get(0).name!=="continue"&&(n.unshift(h),c.reset(n)),p=t},a.removeContinue=function(){var t=JSON.parse(c.toJSON());t[0].name==="continue"&&t.splice(0,1),c.reset(t),p=""},a.reset=function(){c.reset([{name:"quick",active:!0,selected:!1,label:l.get("quickbmode"),bg:"quick.png",bgselected:"quickactive.png"},{name:"musession",active:!0,selected:!1,label:l.get("musession"),bg:"multiuser.png",bgselected:"multiuseractive.png"},{name:"customb",active:!1,selected:!1,label:l.get("customsession"),bg:"customb.png",bgselected:"custombactive.png"},{name:"tutorial",active:!0,selected:!1,label:l.get("ideafytutorial"),bg:"tutorial.png",bgselected:"tutorialactive.png"}]),f.get("sessionInProgress")&&f.get("sessionInProgress").id&&a.addContinue(f.get("sessionInProgress"))},a.reset(),f.watchValue("sessionInProgress",function(e){e.id&&e.type?a.addContinue(e):a.removeContinue()}),f.watchValue("lang",function(){var e=s.get("labels");c.loop(function(t,n){switch(t.name){case"continue":c.update(n,"label",e.get("continuesession"));break;case"quick":c.update(n,"label",e.get("quickbmode"));break;case"musession":c.update(n,"label",e.get("musession"));break;case"customb":c.update(n,"label",e.get("customsession"));break;case"tutorial":c.update(n,"label",e.get("ideafytutorial"))}})}),a}}),define("service/help",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){return new function(){var u=new e,a=i.get("labels"),f=new s({html:""});return u.plugins.addAll({help:new n(f),helpevent:new r(u)}),u.template='<div><div class="help-doctor"></div><div class="close-help" data-helpevent="listen:mousedown, closeHelp"></div><div class="help-screen" data-help="bind:innerHTML,html"></div></div>',u.render(),u.place(t.get("help-popup")),u.setContent=function(t){f.set("html",a.get(t))},u.closeHelp=function(e,t){document.getElementById("help-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear")},u}}),define("brainstorm/quickb/quickstart",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","Promise"],function(e,t,n,r,i,s,o,u){return function(f,l,c,h){var p=new e,d=i.get("user"),v=i.get("db"),m=i.get("labels"),g="step",y=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return p.plugins.addAll({labels:new n(m),model:new n(f,{setTitle:function(e){var t=new Date;e&&e.username&&this.setAttribute("placeholder",m.get("quickstarttitleplaceholderpre")+e.username+m.get("quickstarttitleplaceholderpost"))}}),quickstartevent:new r(p)}),p.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:mousedown, help"></div><form class="quickstart-form"><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: mousedown, press; listen:mouseup, next"></div></form><div>',p.place(t.get("quickstart")),p.press=function(e,t){t.classList.add("pressed")},p.next=function(e,t){y.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),g==="step"?(g="screen",f.get("title")===""&&f.set("title",m.get("quickstarttitleplaceholderpre")+f.get("initiator").username+m.get("quickstarttitleplaceholderpost")),f.set("lang",d.get("lang")),f.set("_id","S:QUICK:"+f.get("startTime")),f.sync(v,f.get("_id")).then(function(){return d.set("sessionInProgress",{id:f.get("_id"),type:"quick"}),d.upload()}).then(function(){c("quickstart")})):c("quickstart")},p.stopSpinner=function(){y.stop(),p.dom.querySelector(".next-button").classList.remove("invisible")},p.prev=function(e,t){t.classList.remove("pressed"),l("quickstart")},p.toggleProgress=function(e,t){h()},p.reset=function(t){var n=new Date,r=f.get("step"),i=new u;t?(r==="quickstart"?g="step":g="screen",r!=="quickwrapup"&&f.set("resumeTime",n.getTime())):(f.set("startTime",n.getTime()),f.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),g="step")},p.help=function(e,t){s.setContent("quickstarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},p}}),define("brainstorm/quickb/quicksetup",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Store","Promise","service/cardpopup","service/help","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b,w=t.get("quicksetup"),E=i.get("labels"),S=i.get("transport"),x=i.get("db"),T=i.get("user"),N={},C=new o({timer:null,display:!1}),k,L=new o({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),A=new o({"char":{id:"",title:E.get("char"),pic:""},context:{id:"",title:E.get("context"),pic:""},problem:{id:"",title:E.get("problem"),pic:""}}),O={"char":0,context:0,problem:0},M=!0,_={"char":new o,context:new o,problem:new o},D="",P=null,H=0,B="step",j=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373})).spin();return y.plugins.addAll({labels:new n(E),quicksetup:new n(L,{setReload:function(e){e===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){L.get("char").selected&&L.get("context").selected&&L.get("problem").selected?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),quicksetuptimer:new n(C,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicksetupcards:new n(A,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():this.innerHTML=e},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),quicksetupevent:new r(y)}),y.template='<div id = "quicksetup"><div class="previousbutton" data-quicksetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicksetup-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicksetup" data-quicksetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicksetuptimer="bind:setTime, timer; bind: displayTimer, display" data-quicksetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicksetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, char.pic" data-quicksetup="bind: popup, char.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, context.pic" data-quicksetup="bind: popup, context.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, problem.pic" data-quicksetup="bind: popup, problem.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-quicksetup="bind:setSelected, char.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="context" data-quicksetup="bind:setSelected, context.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="problem" data-quicksetup="bind:setSelected, problem.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-quicksetupevent="listen: mousedown, press; listen:mouseup, next" data-quicksetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div></div>',y.place(w),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),B==="step"?(B="screen",d.set("characters",A.get("char")),d.set("contexts",A.get("context")),d.set("problems",A.get("problem")),clearInterval(k),C.set("display",!0),y.updateSessionScore(C.get("timer")).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){p.set("elapsedTimers",{quicksetup:C.get("timer")}),p.set("characters",[A.get("char").id]),p.set("contexts",[A.get("context").id]),p.set("problems",[A.get("problem").id]),m("quicksetup")})):m("quicksetup")},y.stopSpinner=function(){j.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.help=function(e,t){f.setContent("quicksetuphelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},y.prev=function(e,t){t.classList.remove("pressed"),v("quicksetup")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){C.set("display",!C.get("display"))},y.push=function(e,t){B!=="screen"&&t.classList.add("pushed")},y.draw=function(e,t){var n=t.getAttribute("name"),r=L.get(n);_now=new Date,B==="step"&&M&&(r.left===0&&(N[n]=d.get("deck")[n].concat(),r.left=N[n].length,L.set(n,r)),r.selected&&alert("please unlock selected card first"),M&&!r.selected&&(M=!1,r.selected===!1?y.drawCard(n).then(function(){var e=!1;t.classList.remove("pushed"),M=!0,L.loop(function(t,n){t.popup===!0&&(e=!0)}),e&&y.setPopup(n)}):(t.classList.remove("pushed"),M=!0)))},y.accept=function(e,t){var n=t.getAttribute("name"),r=L.get(n);B==="step"&&(A.get(n).id?r.selected?(r.selected=!1,L.set(n,r)):(r.selected=!0,L.set(n,r)):(r.selected=!1,L.set(n,r)))},y.zoom=function(e,t){var n=t.getAttribute("name");y.setPopup(n)},y.setPopup=function(t){var n={x:0,y:337},r="left",i=L.get(D)||"",s=L.get(t);i&&(i.popup=!1,L.set(D,i)),s.popup=!0,L.set(t,s),D=t,t==="char"&&(n.x=382),t==="context"&&(n.x=102,r="right"),t==="problem"&&(n.x=249,r="right"),_[t].getNbItems()&&b.reset(_[t].toJSON(),n,r,document.getElementById("quicksetup-popup"))},y.closePopup=function(){var t=L.get(D);t.popup=!1,L.set(D,t),D=""},b=new a(y.closePopup),y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;C.set("display",!1),C.set("timer",r),p.get("step")==="quicksetup"&&(k=setInterval(function(){var e=new Date;C.set("timer",r+e.getTime()-n)},1e3))},y.reset=function(t){B="step",t?(H=p.get("elapsedTimers").quicksetup||0,p.get("characters").length?(B="screen",L.reset({"char":{selected:!0,left:1,popup:!1},context:{selected:!0,left:1,popup:!1},problem:{selected:!0,left:1,popup:!1}}),D="",C.set("timer",H),C.set("display",!0),y.getDeck(p.get("deck")).then(function(){return y.getCard(p.get("characters")[0],_.char)}).then(function(){var e=_.char;return A.set("char",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("characters",A.get("char")),y.getCard(p.get("contexts")[0],_.context)}).then(function(){var e=_.context;return A.set("context",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("contexts",A.get("context")),y.getCard(p.get("problems")[0],_.problem)}).then(function(){var e=_.problem;A.set("problem",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("problems",A.get("problem"))})):(y.init(),y.initTimer(H))):y.init()},y.getDeck=function(t){var n=new u,r=new s;return r.setTransport(S),r.sync(x,t).then(function(){var e,t={},s=i.get("user").get("lang");!r.get("default_lang")||r.get("default_lang")===s?e=JSON.parse(r.toJSON()):r.get("translations")&&r.get("translations")[s]?e=r.get("translations")[s]:e=JSON.parse(r.toJSON()),t.char=e.content.characters,t.context=e.content.contexts,t.problem=e.content.problems,t.techno=e.content.techno,["char","context","problem","techno"].forEach(function(e){t[e][0]==="newcard"&&t[e].shift()}),d.set("deck",t),n.fulfill(),setTimeout(function(){r.unsync()},2e3)}),n},y.getCard=function(t,n){var r=new u,i=new s;return i.setTransport(S),i.sync(x,t).then(function(){n.reset(JSON.parse(i.toJSON())),r.fulfill(),i.unsync()}),r},y.drawCard=function(t){var n=new u,r=L.get(t),i=A.get(t),s=Math.floor(Math.random()*N[t].length),o=N[t][s];return y.getCard(o,_[t]).then(function(){var e=_[t];O[t]++,N[t].splice(s,1),i.id=o,i.title=e.get("title"),i.pic=e.get("picture_file"),A.set(t,i),r.left=N[t].length,L.set(t,r),n.fulfill()}),n},y.updateSessionScore=function(t){var n=new u,r={sid:p.get("_id"),step:"quicksetup",time:t,cards:O.char+O.context+O.problem};return S.request("UpdateSessionScore",r,function(e){e.res==="ok"?n.fulfill():n.reject()}),n},y.init=function(){y.getDeck(i.get("user").get("active_deck")).then(function(){var e=d.get("deck");N.char=e.char.concat(),N.context=e.context.concat(),N.problem=e.problem.concat(),O.char=0,O.context=0,O.problem=0,_={"char":new o,context:new o,problem:new o},D="",M=!0,P=null,A.reset({"char":{id:"",title:E.get("char"),pic:""},context:{id:"",title:E.get("context"),pic:""},problem:{id:"",title:E.get("problem"),pic:""}}),L.reset({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}})})},y}}),define("brainstorm/whiteboard/wbdefault",["OObject","service/config","Bind.plugin"],function(e,t,n){return function(i,s){var o=new e,u="",a=t.get("labels"),f="quick";return o.plugins.add("labels",new n(a)),s?f=s:f="quick",i==="scenario"?u=f+"scenariohelp":u=f+"ideahelp",o.template='<div id="whiteboard-default" class="defaultcontent"><div class="doctor-deedee"></div><div class="help" data-labels="bind:innerHTML,'+u+'"></div></div>',o}}),define("brainstorm/whiteboard/wbmain",["OObject","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r){return function(s,o,u){var a=new e,f,l=!0,c=!1,h=r.get("transport");return a.plugins.addAll({wbmain:new t(s,{displayPost:function(e){var t=this,n=t.getAttribute("data-wbmain_id"),r=s.get(n).content,i=s.get(n).style,o=s.get(n).background,u,a;switch(e){case"postit":t.classList.remove("photo"),t.classList.remove("drawing"),t.innerHTML='<div class="inner-postit">'+r.replace(/\n/g,"<br>")+"</div>",t.setAttribute("style","background:url('img/brainstorm/"+i.img+"') no-repeat center center; background-size: contain; color:"+i.marker+";");break;case"import":t.classList.add("photo"),t.classList.remove("drawing"),this.innerHTML="",u="sessions/"+f,a={dir:u,filename:r},h.request("GetFile",a,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});break;case"drawing":t.classList.remove("photo"),t.classList.add("drawing"),this.innerHTML="",u="sessions/"+f,a={dir:u,filename:r},h.request("GetFile",a,function(e){t.setAttribute("style","background:"+o+"; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});break;default:}}}),wbevent:new n(a)}),a.template='<div class="wbmain"><ul class="wblist" data-wbmain="foreach"><li class="wb-item postit" data-wbmain="bind: displayPost, type" data-wbevent="listen: mouseup, edit; listen:dblclick, cancelEdit"></li><ul><div>',a.edit=function(e,t){var n=t.getAttribute("data-wbmain_id"),r=s.get(n).type;l?c?s.get(n).type!=="postit"&&(t.classList.contains("enlarge")?t.classList.remove("enlarge"):t.classList.add("enlarge")):(o.set(r,"active"),u(r,n)):l=!0},a.cancelEdit=function(e,t){e.stopPropagation(),l=!1},a.setSessionId=function(e){f=e},a.setReadonly=function(e){c=e},a}}),define("brainstorm/whiteboard/wbpostit",["OObject","Store","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r,i){return function(o,u){var a=new e,f=i.get("labels"),l="#4D4D4D",c=[{name:"blue",color:"#657B99",img:"postItBlue.png",selected:!1},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:!1},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:!0},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:!1}],h=new t(c),p=null,d=new t({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"}});return a.plugins.addAll({labels:new n(f),postit:new n(d,{setStyle:function(e){var t=e.marker,n=e.img;this.setAttribute("style","background-image:url('img/brainstorm/"+n+"'); color:"+t+";")}}),colors:new n(h,{setBg:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),postitevent:new r(a)}),a.template='<div class="wbpostit"><div class="postit-cancel postit-close" data-postitevent="listen:mousedown,cancel"></div><div class="postit" data-postit="bind:setStyle, style"><textarea data-postit="bind: value, content"></textarea></div><span class="choosecolorlbl" data-labels="bind:innerHTML, choosecolorlbl"></span><ul class="postitcolors" data-colors="foreach"><li class="postitcolor" data-postitevent="listen:mousedown,choose" data-colors="bind:setBg, color;bind:setSelected, selected"></li></ul><div name="post" class = "postpostit" data-postitevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-postitevent="listen:mousedown, press;listen:mouseup, del"></div></div>',a.cancel=function(e,t){u("postit")},a.choose=function(e,t){var n=t.getAttribute("data-colors_id");h.loop(function(e,t){t===parseInt(n,10)?h.update(t,"selected",!0):h.update(t,"selected",!1)}),d.set("style",{postit:h.get(n).name,marker:l,img:h.get(n).img})},a.press=function(e,t){t.classList.add("pressed")},a.post=function(e,t){!p&&p!==0?o.alter("push",JSON.parse(d.toJSON())):o.alter("splice",p,1,JSON.parse(d.toJSON())),t.classList.remove("pressed"),u("postit"),a.reset()},a.reset=function(t){p=t,!p&&p!==0?(d.reset({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"}}),h.reset([{name:"blue",color:"#657B99",img:"postItBlue.png",selected:!1},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:!1},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:!0},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:!1}])):d.reset(o.get(p))},a.del=function(e,t){p&&o.del(p),t.classList.remove("pressed"),a.reset(),u("postit")},a}}),define("brainstorm/whiteboard/wbimport",["OObject","service/map","service/config","Bind.plugin","Event.plugin","service/utils","Store","Promise"],function(e,t,n,r,i,s,o,u){return function(a,f){var l=new e,c=n.get("labels"),h=new FileReader,p=new o({status:null}),d=null,v=new o({type:"import",content:""}),m,g=400,y=300,b=function(e){var t,n,r=document.getElementById("preview"),i=r.getContext("2d");t=e.width,n=e.height,t>n?t>g&&(n*=g/t,t=g):n>y&&(t*=y/n,n=y),r.width=t,r.height=n,i.drawImage(e,0,0,t,n)},w=function(e){var t=new u,r="/upload",i=new FormData,o="postit",a="sessions/"+m,f=document.getElementById("preview"),l=f.toDataURL("image/png"),c=new Date,h=e||n.get("user").get("_id")+"_"+c.getTime();return i.append("type",o),i.append("dir",a),i.append("filename",h),i.append("dataString",l),s.uploadFile(r,i,p,function(e){v.set("content",h),t.fulfill()}),t},E=function(){var e=document.getElementById("preview"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)};return l.template='<div class="import"><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/*" data-importevent="listen: mousedown, selectpress; listen:mouseup, check; listen: change, preview"><div data-labels="bind:innerHTML, importlbl" data-importevent="listen: mousedown, press; listen: mouseup, release"></div></span><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:mousedown,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-importevent="listen:mousedown, press;listen:mouseup, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>',l.plugins.addAll({labels:new r(c),importmodel:new r(v,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(e){var t,r=this,i=n.get("transport");e?(t={dir:"sessions/"+m,filename:e},i.request("GetFile",t,function(e){var t=new Image,n=r.getContext("2d");t.src=e,r.width=t.width,r.height=t.height,n.drawImage(t,0,0),l.dom.querySelector("#postpic").scrollIntoView()})):this.innerHTML=""}}),importprogress:new r(p,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),importevent:new i(l)}),l.cancel=function(e,t){t.parentNode.classList.add("invisible"),f("import")},l.check=function(e,t){t.classList.remove("pressed"),t.files.length&&l.preview("change",t)},l.preview=function(e,t){var n=new Image,r=new FileReader;r.onloadend=function(e){n.src=e.target.result,setTimeout(function(){b(n),document.getElementById("postpic").classList.remove("invisible")},300)},r.readAsDataURL(t.files[0])},l.selectpress=function(e,t){t.value=""},l.press=function(e,t){t.classList.add("pressed")},l.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},l.post=function(e,t){w(v.get("content")).then(function(){!d&&d!==0?a.alter("push",JSON.parse(v.toJSON())):a.alter("splice",d,1,JSON.parse(v.toJSON())),t.classList.remove("pressed"),l.reset(),p.reset({status:""}),E(),l.dom.querySelector(".importbutton").classList.remove("invisible"),f("import")})},l.reset=function(t){d=t,v.reset({type:"import",content:""});if(d||d===0)v.reset(a.get(t)),l.dom.querySelector("#postpic").scrollIntoView()},l.setSessionId=function(e){m=e},l.del=function(e,t){(d||d===0)&&a.del(d),t.classList.remove("pressed"),t.parentNode.classList.add("invisible"),l.reset(),E(),document.getElementById("importbuttons").classList.remove("invisible"),f("import")},l}}),define("brainstorm/whiteboard/wbdrawing",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,n,r,i,s,o,u){return function(a,f){var l=new e,c=null,h={},p=new s({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),d=new s([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v=new s([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),m=n.get("labels"),g=new s({status:null}),y=new s({type:"drawing",content:"",background:""}),b=function(e){var t=new o,r="/upload",i=new FormData,s="postit",a="sessions/"+w,f=l.dom.querySelector(".drawingcanvas"),c=f.toDataURL("image/png"),h=new Date,d=e||n.get("user").get("_id")+"_"+h.getTime();return i.append("type",s),i.append("dir",a),i.append("filename",d),i.append("dataString",c),u.uploadFile(r,i,g,function(e){y.set("content",d),y.set("background",p.get("bg")),t.fulfill()}),t},w,E=!1,S=(document.body.clientWidth-1024)/2,x=(document.body.clientHeight-748)/2,T=93;return l.plugins.addAll({labels:new r(m),color:new r(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),pencil:new r(p,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){e==="pencil"?this.setAttribute("fill",p.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){p.get("mode")==="pencil"?this.setAttribute("fill",e):this.setAttribute("fill",p.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new r(v,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),uploadprogress:new r(g,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),drawing:new r(y,{draw:function(e){var t=n.get("transport"),r=this,i;e&&(i={dir:w,filename:e},t.request("GetFile",i,function(e){var t=new Image,n=r.getContext("2d");t.src=e,n.drawImage(t,0,0)}))}}),drawingevent:new i(l)}),l.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',l.setSessionId=function(e){w=e},l.clear=function(e,t){var n=l.dom.querySelector(".drawingcanvas"),r=n.getContext("2d");r.clearRect(0,0,n.width,n.height),t.classList.remove("selected")},l.resetColors=function(){p.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),d.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},l.erase=function(e,t){p.set("mode","erase"),p.set("color",p.get("bg"))},l.drawactive=function(e,t){p.set("mode","pencil"),d.loop(function(e,t){e.active&&p.set("color",e.color)})},l.expand=function(e,t){var n=t.getAttribute("name"),r=document.getElementById(n);r.classList.contains("invisible")?r.classList.remove("invisible"):r.classList.add("invisible")},l.stop=function(e,t){e.stopPropagation()},l.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},l.select=function(e,t){t.classList.add("selected")},l.getColor=function(e,t){var n=t.getAttribute("data-color_id");e.stopPropagation(),d.loop(function(e,t){t===parseInt(n)?d.update(t,"active",!0):d.update(t,"active",!1)}),p.set("color",d.get(n).color),p.set("mode","pencil"),t.parentNode.classList.add("invisible")},l.getBgColor=function(e,t){var n=t.getAttribute("data-bgcolor_id");e.stopPropagation(),v.loop(function(e,t){t===parseInt(n)?v.update(t,"active",!0):v.update(t,"active",!1)}),p.set("bg",v.get(n).color),t.parentNode.classList.add("invisible")},l.cancel=function(e,t){l.clear(e,t),l.resetColors(),y.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),f("drawing")},l.deletedrawing=function(e,t){(c||c===0)&&a.del(c),l.cancel(e,t)},l.post=function(e,t){t.classList.add("selected"),b(y.get("content")).then(function(){!c&&c!==0?a.alter("push",JSON.parse(y.toJSON())):a.alter("splice",c,1,JSON.parse(y.toJSON())),t.classList.remove("selected"),l.cancel(e,t),g.reset({status:""})})},l.reset=function(t){var n=l.dom.querySelector(".drawingcanvas");c=t,l.resetColors(),_lines=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&n.setAttribute("height",380),!c&&c!==0?y.reset({type:"drawing",content:"",background:""}):(y.reset(a.get(t)),p.set("bg",y.get("background")),v.loop(function(e,t){e.color===y.get("background")?v.update(t,"active",!0):v.update(t,"active",!1)}))},l.start=function(e,t){var n=t.offsetLeft-T;h={x:e.pageX-n-S,y:e.pageY-t.offsetTop-x},E=!0,e.preventDefault()},l.end=function(e,t){E=!1},l.move=function(e,t){var n,r,i,s=t.offsetLeft-T;E&&(n=e.pageX-s-S-h.x,r=e.pageY-t.offsetTop-x-h.y,i=l.draw(t,n,r),h={x:i.x,y:i.y}),e.preventDefault()},l.draw=function(e,t,n){var r=e.getContext("2d");return r.lineWidth=p.get("size"),r.strokeStyle=p.get("color"),r.lineCap=p.get("cap"),r.beginPath(),r.moveTo(h.x,h.y),r.lineTo(h.x+t,h.y+n),r.stroke(),r.closePath(),{x:h.x+t,y:h.y+n}},l}}),define("brainstorm/whiteboard/whiteboard",["Amy/Stack-plugin","./wbdefault","./wbmain","./wbpostit","./wbimport","./wbdrawing","Store"],function(e,t,n,r,i,s,o){function u(e,u,a,f){var l=new o([]),c=this;this.selectScreen=function(t,n){var r=c.getStack().get(t);r.reset&&r.reset(n),c.getStack().show(t)},this.exitScreen=function(t){u.getNbItems()?c.getStack().show("main"):c.getStack().show("default"),a.set(t,"inactive")},this.getContent=function(){return l},this.setSessionId=function(e){c.getStack().get("main").setSessionId(e),c.getStack().get("import").setSessionId(e),c.getStack().get("drawing").setSessionId(e)},this.setReadonly=function(e){c.getStack().get("main").setReadonly(e)},this.getStack().add("default",new t(e,f)),this.getStack().add("main",new n(u,a,this.selectScreen)),this.getStack().add("postit",new r(u,this.exitScreen)),this.getStack().add("import",new i(u,this.exitScreen)),this.getStack().add("drawing",new s(u,this.exitScreen))}return function(n,r,i,s){return u.prototype=new e,new u(n,r,i,s)}}),define("brainstorm/quickb/quickscenario",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../whiteboard/whiteboard","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b,w,E=i.get("labels"),S=new s,x=new s,T=new s,N=new s({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),C={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},k=new s(C),L=new s({timer:null,display:!1}),A,O=new s({title:"",story:"",solution:""}),M=new s([]),_=new a("scenario",M,k),D,P=0,H="step",B=i.get("transport"),j=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return y.plugins.addAll({labels:new n(E,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(N,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new n(k,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new n(L,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(O),wbstack:_,quickscenarioevent:new r(y)}),y.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:mousedown,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',y.place(t.get("quickscenario")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),H==="step"?(H="screen",clearInterval(A),L.set("display",!0),d.set("scenario",JSON.parse(O.toJSON())),y.updateSessionScore(L.get("timer")).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quickscenario=L.get("timer"),p.set("scenario",[JSON.parse(O.toJSON())]),p.set("elapsedTimers",e),k.set("readonly",!0),m("quickscenario")})):m("quickscenario")},y.stopSpinner=function(){j.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),v("quickscenario")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){L.set("display",!L.get("display"))},y.push=function(e,t){var n=t.getAttribute("name");k.set(n,"active")},y.zoom=function(e,t){var n=t.getAttribute("name");y.setPopup(n)},y.setPopup=function(t){var n={x:147,y:130},r="left",s=N.get(t),u=k.get("cardpopup"),a="",f;w&&(u[w]=!1),u[t]=!0,k.set("cardpopup",u),w=t,t==="char"&&(n.y=120,s.id===S.get("_id")&&(a=S.toJSON())),t==="context"&&(n.y=290,s.id===x.get("_id")&&(a=x.toJSON())),t==="problem"&&(n.y=350,s.id===T.get("_id")&&(a=T.toJSON())),a?b.reset(a,n,r,document.getElementById("quickscenario-popup")):(f=new o,f.setTransport(B),f.sync(i.get("db"),s.id).then(function(){a=f.toJSON(),b.reset(a,n,r,document.getElementById("quickscenario-popup")),t==="char"&&S.reset(JSON.parse(f.toJSON())),t==="context"&&x.reset(JSON.parse(f.toJSON())),t==="problem"&&T.reset(JSON.parse(f.toJSON()))}))},y.closePopup=function(){var t=k.get("cardpopup");t[w]=!1,k.set("cardpopup",t),w=""},b=new u(y.closePopup),y.post=function(e,t){_.selectScreen("postit"),k.set("import","inactive"),k.set("drawing","inactive")},y.importpic=function(e,t){_.selectScreen("import"),k.set("postit","inactive"),k.set("drawing","inactive")},y.draw=function(e,t){_.selectScreen("drawing"),k.set("import","inactive"),k.set("postit","inactive")},y.exitTool=function(t){k.set(t,"inactive")},y.finish=function(e,t){_.setReadonly(!0),k.set("ready",!1),k.set("showstory",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new f,n={sid:p.get("_id"),step:"quickscenario",time:e,wbcontent:M.toJSON(),scenario:O.toJSON()};return B.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},y.reset=function(t){k.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),_.setSessionId(p.get("_id")),M.reset(p.get("scenarioWB")),M.getNbItems()?_.selectScreen("main"):_.selectScreen("default"),p.get("scenario").length?(H="screen",k.set("ready",!1),k.set("showstory",!0),_.setReadonly(!0),O.reset(p.get("scenario")[0]),d.set("scenario",p.get("scenario")[0]),k.set("readonly",!0),k.set("shownext",!0)):(O.reset({title:"",story:"",solution:""}),M.getNbItems()?k.set("ready",!0):k.set("ready",!1),_.setReadonly(!1),H="step"),p.get("elapsedTimers").quickscenario&&(P=p.get("elapsedTimers").quickscenario,L.set("timer",P)),H==="screen"?L.set("display",!0):y.initTimer(P)},y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;L.set("display",!1),L.set("timer",r),p.get("step")==="quickscenario"&&(clearInterval(A),A=setInterval(function(){var e=new Date;L.set("timer",r+e.getTime()-n)},1e3))},d.watchValue("characters",function(e){N.set("char",e)}),d.watchValue("contexts",function(e){N.set("context",e)}),d.watchValue("problems",function(e){N.set("problem",e)}),p.watchValue("_id",function(e){_.setSessionId(e)}),["added","deleted","updated"].forEach(function(e){M.watch(e,function(){JSON.stringify(p.get("scenarioWB"))!==M.toJSON()&&(p.set("scenarioWB",JSON.parse(M.toJSON())),p.upload()),M.getNbItems()&&H==="step"?k.set("ready",!0):k.set("ready",!1)})}),O.watch("updated",function(){O.get("title")&&O.get("story")&&O.get("solution")?k.set("shownext",!0):k.set("shownext",!1)}),TIM=L,y}}),define("brainstorm/quickb/quicktech",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b=null,w=null,E,S=new o({timer:null,display:!1}),x=i.get("transport"),T=i.get("user"),N=i.get("labels"),C,k,L={left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}},A=new o(L),O=[],M=!0,_=new o,D=new o,P=new o,H={tech1:_,tech2:D,tech3:P},B=0,j=new o([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),F="step",I=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373})).spin();return y.plugins.addAll({labels:new n(N),display:new n(A,{setReload:function(e){!e&&B>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){A.get("tech1").selected&&A.get("tech2").selected&&A.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new n(j,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.toUpperCase():this.innerHTML=N.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),quicktechtimer:new n(S,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new r(y)}),y.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:mousedown, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-quicktechevent="listen: mousedown,  accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-quicktechevent="listen: mousedown, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-quicktechevent="listen: mousedown, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>',y.place(t.get("quicktech")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var n=new Date,r=n.getTime()-b;I.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),F==="step"?(F="screen",d.set("techno",j),clearInterval(E),S.set("display",!0),y.updateSessionScore(S.get("timer")).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quicktech=S.get("timer"),p.set("elapsedTimers",e),p.set("techno",[[j.get(0).id,j.get(1).id,j.get(2).id]]),m("quicktech")})):m("quicktech")},y.stopSpinner=function(){I.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.help=function(e,t){s.setContent("quicktechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},y.prev=function(e,t){t.classList.remove("pressed"),v("quicktech")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){S.set("display",!S.get("display"))},y.select=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||B>0||F==="screen")&&t.classList.add("highlighted")},y.zoom=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||B>0||F==="screen")&&y.setPopup(n)},y.setPopup=function(t){var n={x:0,y:337},r="left",i=A.get(k)||"",s=new o,u,a=A.get(t);i&&(i.popup=!1,A.set(k,i)),a.popup=!0,A.set(t,a),k=t,t==="scenario"?(n.x=147,n.y=275,s.reset(p.get("scenario")[0]),s.set("type",5),u=s.toJSON()):(t==="tech1"&&(n.x=467),t==="tech2"&&(n.x=186,r="right"),t==="tech3"&&(n.x=333,r="right"),H[t].get("_id")&&(u=H[t].toJSON())),u&&C.reset(u,n,r,document.getElementById("quicktech-popup"))},y.closePopup=function(){var t=A.get(k);t.popup=!1,A.set(k,t),k=""},y.push=function(e,t){var n=t.getAttribute("name");t.classList.contains("drawok")?H[n].get("_id")&&F==="step"&&t.classList.add("pushed"):t.classList.add("pushed")},y.draw=function(e,t){var n=[];F==="step"&&M&&(M=!1,["tech1","tech2","tech3"].forEach(function(e){A.get(e).selected||n.push(e)}),y.drawTech(n).then(function(){t.classList.remove("pushed"),M=!0}))},y.drawTech=function(t){var n,r=[],i=new a;return t.forEach(function(e){O.length<=0&&(O=d.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){A.get(e).selected&&r.push(j.get(t).id)}),O.filter(function(e){return!(r.indexOf(e)>-1)})),n=Math.floor(Math.random()*O.length),y.getCardDetails(O[n],e),A.set("left",O.length),B++,O.splice(n,1)}),i.fulfill(),i},y.getCardDetails=function(t,n){var r=new u,s=["tech1","tech2","tech3"].indexOf(n),o=new a;return r.setTransport(x),r.sync(i.get("db"),t).then(function(){H[n].reset(JSON.parse(r.toJSON())),j.update(s,"id",t),j.update(s,"title",r.get("title")),j.update(s,"pic",r.get("picture_file")),o.fulfill(),r.unsync()}),o},y.accept=function(e,t){var n=t.getAttribute("name"),r=["tech1","tech2","tech3"].indexOf(n),i=A.get(n);F==="step"&&(j.get(r).id?(i.selected=!i.selected,A.set(n,i)):alert("please draw a card first"))},y.reset=function(e){var t=p.get("techno")[0];A.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),j.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),F="step",e&&t&&t.length?(F="screen",y.getCardDetails(t[0],"tech1").then(function(){return y.getCardDetails(t[1],"tech2")}).then(function(){return y.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){A.set(e,{popup:!1,selected:!0})}),d.set("techno",j)})):(O=[],B=0,_.reset(),D.reset(),P.reset(),j.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),p.get("elapsedTimers").quicktech?w=p.get("elapsedTimers").quicktech:w=0,S.set("timer",w),F==="screen"?S.set("display",!0):y.initTimer(w)},y.updateSessionScore=function(t){var n=new a,r={sid:p.get("_id"),step:"quicktech",time:t,cards:B};return x.request("UpdateSessionScore",r,function(e){e.res==="ok"?n.fulfill():n.reject()}),n},y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;S.set("display",!1),S.set("timer",r),p.get("step")==="quicktech"&&(E=setInterval(function(){var e=new Date;S.set("timer",r+e.getTime()-n)},1e3))},C=new f(y.closePopup),d.watchValue("deck",function(e){O=e.techno.concat(),A.set("left",O.length)}),y}}),define("brainstorm/quickb/quickidea",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/cardpopup","../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b,w,E="step",S,x=0,T,N=new u({timer:null,display:!1}),C=new u({title:"",description:"",solution:"",visibility:"private"}),k=new u,L=new u([]),A=[],O={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},M=new u(O),_=new u([]),D=new o("idea",_,M),P=i.get("transport"),H=i.get("labels"),B=i.get("user"),j=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return y.plugins.addAll({labels:new n(H,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(k),techs:new n(L,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new n(M,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),quickideatimer:new n(N,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(C,{setVisibility:function(e){e==="public"?(this.value=0,this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")):(this.value=1,this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))}}),wbstack:D,quickideaevent:new r(y)}),y.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:mousedown,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:mouseup, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',y.place(t.get("quickidea")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var n=new Date,r,s;j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),E==="step"?(E="screen",clearInterval(T),N.set("display",!0),s=y.getSessionDuration(),d.set("idea",JSON.parse(C.toJSON())),y.createIdeaDoc().then(function(){return y.updateSessionScore(N.get("timer"))}).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");return e.quickidea=N.get("timer"),p.set("idea",[JSON.parse(C.toJSON())]),p.set("elapsedTimers",e),p.set("duration",s),p.set("status","completed"),M.set("readonly",!0),m("quickidea")}).then(function(){B.set("sessionInProgress",{}),user.upload()})):m("quickidea")},y.stopSpinner=function(){j.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),v("quickidea")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){N.set("display",!N.get("display"))},y.toggleVisibility=function(e,t){E==="step"&&(C.get("visibility")==="public"?C.set("visibility","private"):C.set("visibility","public"))},y.push=function(e,t){var n=t.getAttribute("name");M.set(n,"active")},y.select=function(e,t){t.classList.add("higlighted")},y.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),y.setPopup(n,r)},y.setPopup=function(t,n){var r={x:147,y:30},s="left",o=M.get("cardpopup"),f=new u,l="",c,h;w&&(w.type==="scenario"?o.scenario=!1:o.techs[w.id]=!1,M.set("cardpopup",o)),t==="scenario"?o.scenario=!0:o.techs[n]=!0,M.set("cardpopup",o),w={type:t,id:n},t==="scenario"?(r.y=55,f.reset(d.get("scenario")),f.set("type",5),l=f.toJSON(),b.reset(l,r,s,document.getElementById("quickidea-popup"))):(n==0&&(r.y=200),n==1&&(r.y=260),n==2&&(r.y=350),A[n]?(l=A[n],b.reset(l,r,s,document.getElementById("quickidea-popup"))):(h=new a,h.setTransport(P),h.sync(i.get("db"),d.get("techno").get(n).id).then(function(){l=h.toJSON(),b.reset(l,r,s,document.getElementById("quickidea-popup")),A[n]=l})))},y.closePopup=function(){var t=M.get("cardpopup");t[w]=!1,M.set("cardpopup",t),w=""},b=new s(y.closePopup),y.post=function(e,t){D.selectScreen("postit"),M.set("import","inactive"),M.set("drawing","inactive")},y.importpic=function(e,t){D.selectScreen("import"),M.set("postit","inactive"),M.set("drawing","inactive")},y.draw=function(e,t){D.selectScreen("drawing"),M.set("import","inactive"),M.set("postit","inactive")},y.exitTool=function(t){M.set(t,"inactive")},y.finish=function(e,t){D.setReadonly(!0),M.set("ready",!1),M.set("showidea",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new f,n={sid:p.get("_id"),step:"quickidea",time:e,wbcontent:_.toJSON(),idea:C.toJSON()};return P.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},y.getSessionDuration=function(){var t=p.get("elapsedTime"),n=p.get("resumeTime")||p.get("startTime");return now=new Date,now.getTime()-n+t},y.createIdeaDoc=function(){var t=new a(i.get("ideaTemplate")),n=new Date,r="I:"+n.getTime(),s=new f;return t.setTransport(P),t.set("title",C.get("title")),t.set("sessionId",p.get("_id")),t.set("authors",[p.get("initiator").id]),t.set("description",C.get("description")),t.set("solution",C.get("solution")),t.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),t.set("character",p.get("characters")[0]),t.set("problem",p.get("problems")[0]),t.set("context",p.get("contexts")[0]),t.set("techno",p.get("techno")[0]),t.set("visibility",C.get("visibility")),t.set("authornames",p.get("initiator").username),t.set("lang",p.get("lang")),t.set("_id",r),t.sync(i.get("db"),r).then(function(){return t.upload()}).then(function(){t.get("visibility")==="public"&&P.request("UpdateUIP",{userid:B.get("_id"),type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(e){e!=="ok"&&console.log(e)}),s.fulfill(),t.unsync()}),s},y.reset=function(t){M.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),L.reset(),D.setSessionId(p.get("_id")),_.reset(p.get("ideaWB")),_.getNbItems()?D.selectScreen("main"):D.selectScreen("default"),clearInterval(T),p.get("idea").length?(D.setReadonly(!0),M.set("ready",!1),M.set("showidea",!0),C.reset(p.get("idea")[0]),d.set("idea",p.get("idea")[0]),M.set("readonly",!0),M.set("shownext",!0),E="screen"):(C.reset({title:"",description:"",solution:"",visibility:"private"}),_.getNbItems()?M.set("ready",!0):M.set("ready",!1),D.setReadonly(!1),E="step"),p.get("elapsedTimers").quickidea&&(x=p.get("elapsedTimers").quickidea,N.set("timer",x)),E==="screen"?N.set("display",!0):y.initTimer(x)},y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;N.set("display",!1),N.set("timer",r),p.get("step")==="quickidea"&&(clearInterval(T),T=setInterval(function(){var e=new Date;N.set("timer",r+e.getTime()-n)},1e3))},p.watchValue("_id",function(e){D.setSessionId(e)}),d.watchValue("scenario",function(e){k.reset(d.get("scenario"))}),d.watchValue("techno",function(e){L.reset(JSON.parse(d.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){_.watch(e,function(){JSON.stringify(p.get("ideaWB"))!==_.toJSON()&&(p.set("ideaWB",JSON.parse(_.toJSON())),p.upload()),_.getNbItems()?M.set("ready",!0):M.set("ready",!1)})}),C.watch("updated",function(){C.get("title")&&C.get("description")&&C.get("solution")?M.set("shownext",!0):M.set("shownext",!1)}),y}}),define("brainstorm/quickb/quickwrapup",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils"],function(e,t,n,r,i,s,o){return function(a,f,l,c,h){var p=new e,d=new s,v=new s([]),m=i.get("labels");return p.plugins.addAll({labels:new n(m),wrapup:new n(d,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setScore:function(e){e&&(this.innerHTML=e+" ip")},setTime:function(e){e&&(this.innerHTML=o.formatDuration(e))}}),cards:new n(v,{formatTitle:function(e){var t=this.getAttribute("data-cards_id");e&&(t<3?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),quickwrapupevent:new r(p)}),p.template='<div id = "quickwrapup"><div class="previousbutton" data-quickwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickwrapup" data-quickwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div></div><div class="sessioncards" data-quickwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div></div>',p.place(t.get("quickwrapup")),p.press=function(e,t){t.classList.add("pressed")},p.next=function(e,t){t.classList.remove("pressed"),c("quickwrapup")},p.prev=function(e,t){t.classList.remove("pressed"),l("quickwrapup")},p.toggleProgress=function(e,t){h()},p.toggleCards=function(e,t){t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")},p.reset=function(t){v.reset([]),d.reset()},f.watchValue("scenario",function(e){d.set("scenario",e)}),f.watchValue("idea",function(e){d.set("idea",e)}),["characters","contexts","problems","techno"].forEach(function(e){f.watchValue(e,function(t){switch(e){case"characters":v.set(0,t);break;case"contexts":v.set(1,t);break;case"problems":v.set(2,t);break;case"techno":t.loop(function(e,t){v.set(t+3,e)})}})}),a.watchValue("score",function(e){d.set("score",e)}),a.watchValue("duration",function(e){d.set("duration",e)}),p}}),define("brainstorm/quickb/quickb",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./quickstart","./quicksetup","./quickscenario","./quicktech","./quickidea","./quickwrapup","CouchDBDocument","CouchDBView","service/config","Promise","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return function(y,b){var w=new e,E=new e,S=document.createDocumentFragment(),x=new n,T=p.get("labels"),N=new v([{name:"quickstart",label:T.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:T.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:T.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:T.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:T.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:T.get("quickstepwrapup"),currentStep:!1,status:null}]),C=p.get("user"),k=new c,L=new v,A=(new m({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin();return w.plugins.add("quickstack",x),w.template='<div id="ideafy-quick"><div class="stack" data-quickstack="destination"></div></div>',w.place(t.get("ideafy-quick")),E.plugins.addAll({labels:new r(T),step:new r(N,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(E)}),E.template='<div class = "progressbar invisible"><ul id = "quicksteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, highlightStep; listen:mouseup, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',E.place(w.dom),E.highlightStep=function(e,t){t.classList.toggle("inactive")},E.changeStep=function(e,t){var n=t.getAttribute("data-step_id");N.get(n).status?(N.loop(function(e,t){n==t?N.update(t,"currentStep",!0):N.update(t,"currentStep",!1)}),x.getStack().show(N.get(n).name)):e.stopImmediatePropagation(),E.dom.classList.add("invisible")},E.press=function(e,t){t.classList.add("pressed")},E.exit=function(e,t){t.classList.remove("pressed"),E.dom.classList.add("invisible"),b()},w.retrieveSession=function(t){console.log(t),A.spin(document.getElementById("brainstorm")),L.reset(),k.unsync(),k.reset(),w.sessionExists(t.id).then(function(){return k.sync(p.get("db"),t.id)}).then(function(){console.log(k.toJSON());var e=k.get("step"),n=1e4,r=N.getNbItems();x.getStack().get("quickstart").reset(t),x.getStack().get("quicksetup").reset(t),x.getStack().get("quickscenario").reset(t),x.getStack().get("quicktech").reset(t),x.getStack().get("quickidea").reset(t),x.getStack().get("quickwrapup").reset(t),N.loop(function(t,r){r<n&&(t.name===e?(n=r,N.update(r,"currentStep",!0),t.name==="quickwrapup"?N.update(r,"status","done"):N.update(r,"status","ongoing")):N.update(r,"status","done"))}),e==="quickwrapup"?(A.stop(),x.getStack().show("quickwrapup"),N.update(0,"currentStep",!1)):(N.update(0,"currentStep",!0),N.update(n,"currentStep",!1),A.stop(),x.getStack().show("quickstart"),k.get("status")!=="completed"&&(C.set("sessionInProgress",t),C.upload()))},function(e){A.stop(),alert("session could not be retrieved")})},w.startNewSession=function(){k.unsync(),k.reset(p.get("sessionTemplate")),L.reset({}),k.set("initiator",{id:C.get("_id"),username:C.get("username"),picture_file:C.get("picture_file")}),k.set("mode","quick"),k.set("step","quickstart"),k.set("deck",C.get("active_deck")),x.getStack().get("quickstart").reset(),x.getStack().get("quicksetup").reset(),x.getStack().get("quickscenario").reset(),x.getStack().get("quicktech").reset(),x.getStack().get("quickidea").reset(),x.getStack().get("quickwrapup").reset(),x.getStack().show("quickstart")},w.sessionExists=function(t){var n=new d,r=new h;return r.setTransport(p.get("transport")),r.sync(p.get("db"),"library","_view/sessioncount",{key:'"'+t+'"'}).then(function(){r.getNbItems()?n.fulfill():n.reject("not found")}),n},w.reset=function(t){N.reset([{name:"quickstart",label:T.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:T.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:T.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:T.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:T.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:T.get("quickstepwrapup"),currentStep:!1,status:null}]),t?w.retrieveSession(t):w.startNewSession()},w.prev=function(t){var n;N.loop(function(e,r){e.name===t&&(n=r)}),n>0?(N.update(n,"currentStep",!1),N.update(n-1,"currentStep",!0),x.getStack().show(N.get(n-1).name)):(alert("Exiting session"),b())},w.next=function(t){var n,r,i=x.getStack().get(t),s=new d;return N.loop(function(e,r){e.name===t&&(n=r)}),n<N.getNbItems()-1&&(N.update(n,"currentStep",!1),N.update(n+1,"currentStep",!0),N.get(n).status!=="done"?(N.update(n,"status","done"),N.update(n+1,"status","ongoing"),k.set("step",N.get(n+1).name),k.upload().then(function(){r=x.getStack().get(N.get(n+1).name),r.initTimer&&r.initTimer(),i.stopSpinner(),x.getStack().show(N.get(n+1).name),s.fulfill()})):(i.stopSpinner(),x.getStack().show(N.get(n+1).name),s.fulfill())),s},w.toggleProgress=function(){E.dom.classList.toggle("invisible")},w.init=function(t){k.setTransport(p.get("transport")),x.getStack().add("quickstart",new s(k,w.prev,w.next,w.toggleProgress)),x.getStack().add("quicksetup",new o(k,L,w.prev,w.next,w.toggleProgress)),x.getStack().add("quickscenario",new u(k,L,w.prev,w.next,w.toggleProgress)),x.getStack().add("quicktech",new a(k,L,w.prev,w.next,w.toggleProgress)),x.getStack().add("quickidea",new f(k,L,w.prev,w.next,w.toggleProgress)),x.getStack().add("quickwrapup",new l(k,L,w.prev,w.next,w.toggleProgress)),w.reset(t)},w.init(y),p.get("observer").watch("reconnect",function(){k.get("_id")&&(k.unsync(),k.sync(p.get("db"),k.get("_id")))}),w}}),define("brainstorm/multi/init/newmub",["OObject","Bind.plugin","Event.plugin","CouchDBDocument","service/config","Promise","Store","service/utils","lib/spin.min"],function(e,t,n,r,s,o,u,a,f){return function(c){var h=new e,p=new u({}),d=new u([]),v=new u([]),m=new u({errormsg:""}),g=s.get("labels"),y=s.get("user"),b={title:"",description:"",initiator:{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:y.get("active_deck"),status:"waiting",step:"mustart",lang:y.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]},w=(new f({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:660})).spin();return h.plugins.addAll({labels:new t(g),newmub:new t(p,{initSessionMode:function(e){switch(e){case"campfire":this.selectedIndex=1,this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2,this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0,this.setAttribute("style","color: #5F8F28;")}},setSessionInfo:function(e){switch(e){case"campfire":this.innerHTML=g.get("campfireinfo");break;case"boardroom":this.innerHTML=g.get("boardroominfo");break;default:this.innerHTML=g.get("rouletteinfo")}},displayInvitations:function(e){e==="boardroom"?this.classList.remove("invisible"):this.classList.add("invisible")},setTitle:function(e){var t=new Date;e&&e.username&&this.setAttribute("placeholder",g.get("quickstarttitleplaceholderpre")+e.username+g.get("quickstarttitleplaceholderpost"))}}),auto:new t(d,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),invited:new t(v,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),errormsg:new t(m),newmubevent:new n(h)}),h.template='<div id="newmub"><div id="newmub-content"><form><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label></label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-newmubevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:mouseup, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:mousedown, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=60 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: mousedown, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: mousedown, press; listen:mouseup, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:mousedown, press; listen:mouseup, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>',h.place(document.getElementById("newmub")),h.reset=function(){var t={title:"",description:"",initiator:{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:y.get("active_deck"),status:"waiting",step:"",lang:y.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]};p.reset(t),p.set("lang",y.get("lang")),p.set("deck",y.get("active_deck")),p.set("initiator",{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")}),v.reset([]),m.set("errormsg",""),d.reset(y.get("connections").concat())},h.changeSessionMode=function(e,t){var n=t.selectedIndex,r=t.childNodes[n],i=r.getAttribute("name");d.reset(y.get("connections")),v.reset([]),p.set("mode",i)},h.displayAutoContact=function(e,t){document.getElementById("invitelistauto").classList.remove("invisible"),d.reset(y.get("connections").concat())},h.updateAutoContact=function(e,t){var n=JSON.parse(d.toJSON()),r=y.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")d.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);d.reset(n)}d.loop(function(e,t){v.toJSON().search(e.contact.userid)>-1&&d.update(t,"selected",!0)})},h.close=function(t,n){n.parentNode.classList.add("invisible")},h.discardContact=function(e,t){var n=t.getAttribute("data-invited_id"),r=v.get(n).userid;v.alter("splice",n,1),d.loop(function(e,t){e.userid===r&&setTimeout(function(){d.update(t,"selected",!1)},200)}),h.unselectGroup(r)},h.select=function(e,t){var n=t.getAttribute("data-auto_id");d.get(n).selected?(h.removeContact(d.get(n)),setTimeout(function(){d.update(n,"selected",!1),document.getElementById("invitelistauto").classList.add("invisible")},200)):(h.addContact(d.get(n)),h.selectGroup(),setTimeout(function(){d.update(n,"selected",!0),document.getElementById("invitelistauto").classList.add("invisible")},200))},h.selectAll=function(e,t){t.classList.remove("pressed"),v.reset([]),d.reset(y.get("connections")),d.loop(function(e,t){d.update(t,"selected",!0),e.type==="user"&&v.alter("push",e)})},h.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)h.removeContact(e.contacts[j]);else v.loop(function(t,n){t.userid===e.userid&&v.alter("splice",n,1)}),h.unselectGroup(e.userid),d.loop(function(t,n){t.userid===e.userid&&d.update(n,"selected",!1)})},h.selectGroup=function(){var e,t=!1;d.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(v.toJSON().search(e[j].userid)<0){t=!1;break}t&&d.update(r,"selected",!0)}})},h.unselectGroup=function(e){d.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&d.update(n,"selected",!1)})},h.addContact=function(e){var t,n,r=!0;if(e.type==="user")v.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)v.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(v.alter("push",e.contacts[t]),d.loop(function(n,r){n.userid===e.contacts[t].userid&&d.update(r,"selected",!0)}))},h.removeReadonly=function(e,t){t.removeAttribute("readonly")},h.press=function(e,t){t.classList.add("pressed")},h.clear=function(e,t){t.classList.remove("pressed"),h.reset()},h.create=function(e,t){t.classList.remove("pressed"),m.set("errormsg",""),p.get("title").length<3||p.get("description").length<3?m.set("errormsg",g.get("providesessioninfo")):p.get("mode")!=="roulette"&&y.get("connections").length<1?m.set("errormsg",g.get("nofriendtoinvite")):p.get("mode")==="boardroom"&&!v.getNbItems()?m.set("errormsg",g.get("inviteatleastone")):(t.classList.add("invisible"),w.spin(t.parentNode),h.uploadSession().then(function(){w.stop(),t.classList.remove("invisible"),h.reset()}))},h.createChat=function(t){var n=new r,i=(new Date).getTime(),u=new o;return n.setTransport(s.get("transport")),n.set("users",[{username:y.get("username"),userid:y.get("_id")}]),n.set("msg",[{user:"SYS",type:0,arg:0,time:i}]),n.set("sid",p.get("_id")),n.set("lang",p.get("lang")),n.set("readonly",!1),n.set("step",0),n.set("type",17),n.sync(s.get("db"),t).then(function(){return n.upload()}).then(function(){u.fulfill(),n.unsync()}),u},h.uploadSession=function(){var t=new r,n=new Date,i,u=p.get("chat")||[],f=new o;return p.set("_id","S:MU:"+n.getTime()),p.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),p.get("mode")==="boardroom"&&v.loop(function(e,t){p.get("invited").push(e.userid)}),p.get("mode")==="campfire"&&p.set("invited",a.getUserContactIds()),i=p.get("_id")+"_0",u.push(i),p.set("chat",u),t.reset(JSON.parse(p.toJSON())),t.setTransport(s.get("transport")),t.sync(s.get("db"),t.get("_id")).then(function(){return h.createChat(i)}).then(function(){return t.upload()}).then(function(){t.get("mode")==="boardroom"?(m.set("errormsg",g.get("sendinginvites")),h.sendInvites(t.get("invited"),t.get("_id"),t.get("title")).then(function(){s.get("observer").notify("start-mu_session",t.get("_id")),f.fulfill(),t.unsync()})):(s.get("observer").notify("start-mu_session",t.get("_id")),f.fulfill(),t.unsync())}),f},h.sendInvites=function(t,n,r){var i=new o,u=new Date,a={type:"INV",status:"unread",date:[u.getFullYear(),u.getMonth(),u.getDate(),u.getHours(),u.getMinutes(),u.getMinutes()],author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:n,docTitle:r,dest:t};return s.get("transport").request("Notify",a,function(e){m.set("errormsg",g.get("invitesent")),i.fulfill()}),i},h.reset(),y.watchValue("lang",function(){var e=JSON.parse(p.toJSON()),t=JSON.parse(m.toJSON());p.reset({}),p.reset(e),m.reset({}),m.reset(t)}),h}}),define("brainstorm/multi/init/mupreview",["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(){var f=new e,l=t.get("labels"),c=new n,h=new r({msg:""}),p=new r([]),d=(new a({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin(),v;return c.setTransport(t.get("transport")),f.plugins.addAll({labels:new i(l),model:new i(c,{setTitle:function(e){this.innerHTML=e,user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(t){var n,r;this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new o([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),participant:new i(p,{setAvatar:function(t){var n,r;this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new o([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(h),previewevent:new s(f)}),f.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:mousedown, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button" data-labels="bind:innerHTML, joinbutton" data-previewevent="listen: mousedown, press; listen:mouseup, join"></div><div class="infopreview invisible" data-info="bind:innerHTML, msg"></div></div></div>',f.reset=function(n){document.getElementById("mupreview").classList.remove("invisible"),c.sync(t.get("db"),n).then(function(){p.reset(c.get("participants"))})},f.closePreview=function(t,n){f.dom.classList.add("invisible"),c.unsync(),c.reset(),v()},f.press=function(t,n){n.classList.add("pressed")},f.join=function(n,r){r.classList.add("invisible"),r.classList.remove("pressed"),d.spin(r.parentNode),t.get("observer").notify("join-musession",c.get("_id")),setTimeout(function(){d.stop(),f.dom.classList.add("invisible"),c.unsync(),c.reset()},15e3)},f.init=function(t){v=t},c.watchValue("participants",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");p.reset(e),e.length<3&&c.get("status")==="waiting"?(n.classList.remove("invisible"),r.classList.add("invisible")):(e.length===3&&c.get("status")==="waiting"&&h.set("msg",l.get("sessionfull")),n.classList.add("invisible"),r.classList.remove("invisible"))}),c.watchValue("status",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");e==="waiting"&&c.get("participants").length<3?(n.classList.remove("invisible"),r.classList.add("invisible")):(c.get("participants").length===3&&e==="waiting"&&h.set("msg",l.get("sessionfull")),e==="in progress"&&(h.set("msg",l.get("sessionstarted")),c.unsync()),e==="deleted"&&(h.set("msg",l.get("sessiondeleted")),c.unsync()),n.classList.add("invisible"),r.classList.remove("invisible"))}),SPIP=d,f}}),define("brainstorm/multi/init/mulist",["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h){var p=new e,d=i.get("labels"),v=i.get("user"),m=i.get("db"),g=i.get("transport"),y=new o([]),b=new o([]),w=new l,E=new o([]),S=new o({lang:[d.get("all")],modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"}),x="mulistall",T=u.getUserContactIds(),N=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200})).spin();return p.plugins.addAll({labels:new t(d),options:new t(S,{setLang:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t]+"</option>";this.innerHTML=r},setMode:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+d.get(e[t])+"</option>";this.innerHTML=r}}),muall:new t(y,{setParticipants:function(e){var t=e.length+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),musearch:new t(b,{setParticipants:function(e){var t=parseInt(e,10)+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),mupreview:new f({preview:w}),mulistevent:new n(p)}),p.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><select data-options="bind: setLang, lang" data-mulistevent="listen:change, filterLang"></select></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div id="noresult" class="invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',p.reset=function(){x="mulistall",N.spin(document.getElementById("mulistspinner")),S.set("selectedLang","all"),S.set("selectedMode","allmodes"),p.buildList(x).then(function(){N.stop()})},p.buildList=function(t,n){console.log("building list :",t,n);var r=[],i=new s;return t==="mulistall"&&(y.reset([]),p.addSessions(r,"roulette").then(function(){return console.log("roulette ok"),p.addSessions(r,"campfire")}).then(function(){return console.log("campfire ok"),p.addSessions(r,"boardroom")}).then(function(){console.log("after last query",r,p.dom.querySelector("#noresult")),r.length?p.dom.querySelector("#noresult").classList.add("invisible"):p.dom.querySelector("#noresult").classList.remove("invisible"),y.reset(r),i.fulfill()})),t==="musearch"&&(b.reset([]),p.syncSearch(r,n).then(function(){r.length?p.dom.querySelector("#noresult").classList.add("invisible"):p.dom.querySelector("#noresult").classList.remove("invisible"),b.reset(r),i.fulfill()})),i},p.syncSearch=function(t,n,i){var o=new s,u=new r;return u.setTransport(g),u.sync("_fti/local/"+m,"indexedsessions","waiting",{q:n,descending:!0}).then(function(){u.loop(function(e,n){var r=!1;e.fields.mode==="roulette"?r=!0:e.fields.mode==="campfire"&&T.indexOf(e.fields.initiator.id)>-1?r=!0:e.fields.mode==="boardroom"&&e.fields.invited.search(v.get("_id"))>-1&&(r=!0),r&&(i?e.fields.mode.search(i.mode)>-1&&e.fields.lang.search(i.lang)>-1&&t.push(e):t.push(e))}),o.fulfill()}),o},p.addSessions=function(t,n){var o=new s,u=new r,a="_view/"+n,f={};return u.setTransport(g),n==="roulette"?f={descending:!1,limit:50}:f={key:i.get("uid"),descending:!1},u.sync(m,"library",a,f).then(function(){console.log("query result for : ",n,u.toJSON()),u.loop(function(e,n){t.unshift(e)}),o.fulfill(),u.unsync()},function(e){console.log(e,n)}),o},p.search=function(e,t){e.keyCode===13&&(t.value===""?p.toggleList("mulistall"):p.toggleList("musearch"))},p.filterLang=function(e,t){var n=t.selectedIndex;n===0?S.set("selectedLang","all"):S.set("selectedLang",S.get("lang")[n]),N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.filterMode=function(e,t){var n=t.selectedIndex;S.set("selectedMode",S.get("modes")[n]);switch(n){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.filterList=function(){var t=[],n=document.getElementById("mulist-content").querySelector("input").value,r=new s,i="",o="";return S.get("selectedMode")!=="allmodes"&&(i=S.get("selectedMode")),S.get("selectedLang")!=="all"&&(o=S.get("selectedLang")),i===""&&o===""?p.buildList(x,n).then(function(){r.fulfill()}):x==="mulistall"?(y.reset([]),i?p.addSessions(t,i,{lang:o}).then(function(){y.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()}):p.addSessions(t,"roulette",{lang:o}).then(function(){return p.addSessions(t,"campfire",{lang:o})}).then(function(){return p.addSessions(t,"boardroom",{lang:o})}).then(function(){y.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()})):(b.reset([]),p.syncSearch(t,n,{mode:i,lang:o}).then(function(){b.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()})),r},p.zoom=function(e,t){var n;t.classList.add("pressed"),x==="mulistall"?(n=parseInt(t.getAttribute("data-muall_id"),10),w.reset(y.get(n).id)):x==="musearch"&&(n=t.getAttribute("data-musearch_id"),w.reset(b.get(n).id))},p.toggleList=function(t){t!==x&&(document.getElementById(x).classList.add("invisible"),document.getElementById(t).classList.remove("invisible"),x=t),N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.refreshList=function(){p.toggleList(x)},g.request("GetLanguages",{},function(e){S.set("lang",[d.get("all")].concat(e))}),w.init(p.refreshList),v.watchValue("lang",function(){var e;S.set("modes",["allmodes","roulette","campfire","boardroom"]),e=S.get("lang"),e.splice(0,1,d.get("all")),S.set("lang",e)}),MUALL=y,MUSEARCH=b,MUOPTIONS=S,p}}),define("brainstorm/multi/mubinit",["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","service/config","Promise","Store","./init/newmub","./init/mulist"],function(e,t,n,r,i,s,o,u,a){return function(o){var f=new e,l=new u(o),c=new a(o),h=new t,p=i.get("labels");return f.plugins.addAll({labels:new n(p),muinitstack:h,muinitevent:new r(f)}),f.template='<div id="mub-init"><div id="muinitsliderlbl"><label data-labels="bind:innerHTML, startnewmub"></label><label data-labels="bind:innerHTML, joinmub"></label></div><input id="muinitslider" type="range" min="0" max="1" value ="1" data-muinitevent="listen: mouseup, toggleMode"><div class="exit-brainstorm" data-muinitevent="listen: mousedown, press; listen: mouseup, exit"></div><div class="stack" data-muinitstack="destination"></div></div>',f.place(document.getElementById("mub-init")),f.toggleMode=function(e,t){var n;t.value==="1"?n="new":n="list",h.getStack().show(n),h.getStack().get(n).reset()},f.press=function(e,t){t.classList.add("pressed")},f.exit=function(e,t){t.classList.remove("pressed"),o()},f.reset=function(){l.reset(),c.reset()},h.getStack().add("new",l),h.getStack().add("list",c),h.getStack().show("new"),f}}),define("brainstorm/multi/session/mubchat",["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(){var e=this,l=new r([]),c=new n,h=t.get("labels"),p=t.get("user"),d="null",v=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:20})).spin();c.setTransport(t.get("transport")),e.plugins.addAll({labels:new i(h),model:new i(c,{setReadonly:function(e){e?(this.setAttribute("contenteditable",!1),this.setAttribute("style","display:none;")):(this.setAttribute("style","disaply:table-cell;"),this.setAttribute("contenteditable",!0))},setHeight:function(e){e?this.classList.add("extended"):this.classList.remove("extended")}}),chat:new i(l,{setLiStyle:function(e){e===d?this.setAttribute("style","text-align: right;"):this.setAttribute("style","text-align: left;")},setInnerMsgStyle:function(e){e==="SYS"?this.setAttribute("style","background: none; border: none"):e===d?this.setAttribute("style","background: #9AC9CD; border: 1px solid #808080; border-radius: 5px;"):this.setAttribute("style","background: #E6E6E6; border: 1px solid #808080; border-radius: 5px;float: left;max-width: 556px;")},setTime:function(e){e&&(this.innerHTML=u.formatTime(e))},setAvatar:function(e){var t,n,r;e==="SYS"?(this.classList.remove("invisible"),this.classList.add("doctor-deedee")):e===d?this.classList.add("invisible"):typeof e=="number"&&(this.classList.remove("invisible"),t=document.createDocumentFragment(),r=c.get("users")[e].userid,n=new o([r]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setUserName:function(e){typeof e=="number"&&e!==d&&(this.innerHTML=" "+c.get("users")[e].username+h.get("said"))},setMsg:function(e){var t,n;e?(this.innerHTML=e,this.setAttribute("style","color: #292929; font-size: 14px;")):(this.setAttribute("style","color: #CCCCCC; font-size: 12px;"),t=this.getAttribute("data-chat_id"),n=l.get(t).type,n<=3?this.innerHTML=c.get("users")[l.get(t).arg].username+h.get("chatmsg"+n):n===5?this.innerHTML=h.get("chatmsg"+n)+h.get(l.get(t).arg):this.innerHTML=h.get("chatmsg"+n))}}),chatevent:new s(e)}),e.template='<div class="mubchat"><div id="chatspinner"></div><div class="chatread" data-model="bind:setHeight, readonly"><ul class="chatmessages" data-chat="foreach"><li data-chat="bind:setLiStyle, user"><div class="container" data-chat="bind:setAvatar, user"></div><div class="innerchatmsg" data-chat="bind:setInnerMsgStyle, user"><span class="time" data-chat="bind: setTime, time"></span><span class="username" data-chat="bind:setUserName, user"></span><br/><span class="chatmsg" data-chat="bind: setMsg, msg"></span></div></li></ul></div><div class="chatwrite placeholder" data-model="bind:setReadonly, readonly" data-labels="bind:innerHTML, typemsg" data-chatevent = "listen:mousedown, removePlaceholder; listen: keypress, post"></div></div>',e.removePlaceholder=function(e,t){t.innerHTML===h.get("typemsg")&&(t.innerHTML="",t.classList.remove("placeholder"))},e.post=function(t,n){var r,i,s;t.keyCode===13&&n.innerHTML!==""&&(r=(new Date).getTime(),i=c.get("msg"),l.alter("push",{user:d,time:r,msg:n.innerHTML}),s=l.getNbItems()-1,e.dom.querySelector("li[data-chat_id='"+s+"']").scrollIntoView(),i.push({user:d,time:r,msg:n.innerHTML}),c.set("msg",i),n.innerHTML=h.get("typemsg"),n.classList.add("placeholder"),n.blur(),c.upload())},e.setReadonly=function(){c.set("readonly",!0)},e.conclude=function(n){e.setReadonly(),e.setMessage(n)},e.setMessage=function(n,r){var i=(new Date).getTime(),s=c.get("msg"),o,u,a=new f;switch(n){case"start":u={user:"SYS",time:i,type:4};break;case"leave":u={user:"SYS",type:2,time:i,arg:d};break;case"next":u={user:"SYS",type:6,time:i};break;case"initStep":u={user:"SYS",type:5,time:i,arg:r};break;default:}return l.alter("push",u),o=l.getNbItems()-1,e.dom.querySelector("li[data-chat_id='"+o+"']").scrollIntoView(),s.push(u),c.set("msg",s),c.upload().then(function(){a.fulfill()}),a},e.clear=function(){l.reset([])},e.reset=function(r){var i=new f;return d="null",e.dom.querySelector(".chatwrite").classList.add("placeholder"),e.dom.querySelector(".chatwrite").innerHTML=h.get("typemsg"),c.unsync(),c.reset({}),l.reset([]),v.spin(e.dom.querySelector("#chatspinner")),c.sync(t.get("db"),r).then(function(){var t,n=c.get("users");for(t=0;t<n.length;t++)if(n[t].userid===p.get("_id")){d=t;break}isNaN(d)&&!c.get("readonly")?e.joinChat().then(function(){v.stop(),i.fulfill()}):(l.reset(c.get("msg")),v.stop(),i.fulfill())}),i},e.joinChat=function(){var t=new f,n=c.get("users"),r=n.length,i=(new Date).getTime(),s=c.get("msg");return n.push({username:p.get("username"),userid:p.get("_id")}),c.set("users",n),c.get("_id").search("_0")>-1&&(s.push({user:"SYS",time:i,type:1,arg:r}),c.set("msg",s),l.reset(s)),c.upload().then(function(){d=r,t.fulfill()}),t},e.leave=function(){var n=new f,r=null,i,s=c.get("users");return e.setMessage("leave").then(function(){for(i=0;i<s.length;i++)if(s[i].userid===p.get("_id")){r=i;break}return s.splice(r,1),c.set("users",s),c.upload()}).then(function(){n.fulfill(),c.unsync(),c.reset(),l.reset([])}),n},e.cancel=function(){c.remove(),c.unsync(),c.reset({}),l.reset([])},e.getModel=function(){return c},c.watchValue("msg",function(t){var n=t.length-1;l.reset(t),e.dom.querySelector("li[data-chat_id='"+n+"']").scrollIntoView()})}return function(){return l.prototype=new e,new l}}),define("brainstorm/multi/mubwait",["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(v,m){var g=new e,y=new n,b=new t,w=new t({msg:""}),E=u.get("user"),S=u.get("labels"),x=new p,T,N,C={listener:null},k,L=(new d({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin();return y.setTransport(u.get("transport")),g.plugins.addAll({labels:new i(S),model:new i(y,{setTitle:function(e){e&&(this.innerHTML=e),E.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),E.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new h([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},showStartButton:function(e){e&&e.length&&E.get("_id")===y.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new i(b,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new h([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(w),place:new o({chat:x}),mubwaitevent:new s(g)}),g.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',g.place(document.getElementById("mubwait")),g.help=function(e,t){a.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},T=new l(document.body,null,null,"musession-confirm"),g.reset=function(t){x.clear(),y.unsync(),y.reset({}),b.reset([]),N=function(e){e?(E.set("sessionInProgress",""),E.upload(),y.get("initiator").id===E.get("_id")?g.cancelSession():g.leaveSession()):T.hide()},C.listener=f.exitListener("mubwait",g.leave),y.sync(u.get("db"),t).then(function(){y.get("initiator").id===E.get("_id")?T.reset(S.get("leaderleave"),N):T.reset(S.get("participantleave"),N),b.reset(y.get("participants")),x.reset(y.get("chat")[0]),E.set("sessionInProgress",{id:t,type:"musession",mode:"join"}),E.upload()})},g.leave=function(t){k=t.getAttribute("href")||t,T.show()},g.leaveSession=function(){var t=y.get("participants"),n;for(n=t.length-1;n>=0;n--)if(t[n].id===E.get("_id")){t.splice(n,1);break}y.set("participants",t),y.set("status","waiting"),y.upload().then(function(){return x.leave()}).then(function(){y.unsync(),y.reset({})}),g.goToScreen()},g.cancelSession=function(){var t=5e3;y.get("participants").length||(t=2e3),g.displayInfo("deleting",t).then(function(){y.remove(),g.goToScreen()})},g.displayInfo=function(t,n){var r,i=document.querySelector(".sessionmsg"),s=new c,o=function(){i.classList.add("invisible"),clearInterval(r),w.set("msg",""),s.fulfill()};return T.hide(),document.body.removeChild(document.querySelector(".confirm")),i.classList.remove("invisible"),r=setInterval(function(){t!=="deleting"?w.set("msg",t):w.set("msg",S.get("deletingsession")+n/1e3+"s"),n<=0&&o(),n-=1e3},1e3),t==="deleting"&&(y.set("status","deleted"),y.upload().then(function(){x.cancel()})),s},g.goToScreen=function(){var t;k.getAttribute&&k.getAttribute("data-notify_id")?(T.hide(),document.body.removeChild(document.querySelector(".confirm")),v(),u.get("observer").notify("goto-screen","#connect"),document.removeEventListener("mousedown",C.listener,!0),t=k.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(t,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){k===e&&(T.hide(),document.body.removeChild(document.querySelector(".confirm")),v(),u.get("observer").notify("goto-screen",e),document.removeEventListener("mousedown",C.listener,!0))}),b.reset([]),y.reset({})},g.checkUpdate=function(e,t){var n=t.getAttribute("name");e.keyCode===13&&(g.updateSession(n,t.innerHTML),t.blur())},g.updateField=function(e,t){var n=t.getAttribute("name");g.updateSession(n,t.innerHTML)},g.updateSession=function(t,n){y.get(t)!==n&&(y.set(t,n),y.upload())},g.press=function(e,t){t.classList.add("pressed")},g.start=function(e,t){var n=new Date,r=y.get("chat");document.body.removeChild(document.querySelector(".confirm")),x.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),L.spin(t.parentNode),y.set("status","in progress"),y.set("step","musetup"),y.set("startTime",n.getTime()),y.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),r.push(y.get("_id")+"_1"),y.set("chat",r),g.createChat(y.get("chat")[1]).then(function(){return y.upload()}).then(function(){document.removeEventListener("mousedown",C.listener,!0),y.unsync(),L.stop(),t.classList.remove("invisible"),m(y.get("_id"))})},g.createChat=function(t){var r=new n,i=(new Date).getTime(),s=new c;return r.setTransport(u.get("transport")),r.set("users",x.getModel().get("users")),r.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:i}]),r.set("sid",y.get("_id")),r.set("lang",y.get("lang")),r.set("readonly",!1),r.set("step",1),r.set("type",17),r.sync(u.get("db"),t).then(function(){return r.upload()}).then(function(){s.fulfill(),r.unsync()}),s},y.watchValue("status",function(e){e==="deleted"&&y.get("initiator").id!==E.get("_id")&&g.displayInfo(S.get("canceledbyleader"),2e3).then(function(){y.unsync(),v(),document.removeEventListener("mousedown",C.listener,!0)}),e==="in progress"&&y.get("initiator").id!==E.get("_id")&&(console.log("session in progress -- starting any moment now"),document.removeEventListener("mousedown",C.listener,!0),y.unsync(),m(y.get("_id")),y.reset({}),b.reset([]))}),y.watchValue("participants",function(e){b.reset(e)}),g}}),define("brainstorm/multi/session/mustart",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","service/avatar","./mubchat","Store","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v){var m=new e,g=i.get("user"),y=i.get("db"),b=i.get("labels"),w="step",E=new f([]),S=new a,x=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return m.plugins.addAll({labels:new n(b),model:new n(h,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new u([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")}}),participant:new n(E,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new u([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),place:new l({chat:S}),mustartevent:new r(m)}),m.template='<div id = "mustart"><div class="previousbutton" data-mustartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-mustartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-mustartevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:innerHTML, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants"></label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div></form><div class="sessionchat" data-place="place:chat"></div><div>',m.place(t.get("mustart")),m.press=function(e,t){t.classList.add("pressed")},m.next=function(e,t){x.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),d("mustart")},m.prev=function(e,t){t.classList.remove("pressed"),p("quickstart")},m.toggleProgress=function(e,t){v()},m.reset=function(t){w="step",E.reset(h.get("participants")),S.reset(h.get("chat")[0]).then(function(){S.setReadonly(),t&&S.dom.querySelector(".chatread").classList.add("extended")})},m.help=function(e,t){s.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},h.watchValue("participants",function(e){E.reset(e)}),m}}),define("brainstorm/multi/session/musetup",["OObject","service/map","Bind.plugin","Place.plugin","Event.plugin","service/config","CouchDBDocument","Store","Promise","service/cardpopup","service/help","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(d,v,m,g,y){var b=new e,w,E=new p,S=s.get("labels"),x=s.get("transport"),T=s.get("db"),N=s.get("user"),C={},k=new u({timer:null,display:!1}),L,A=new u({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),O=new u({"char":{id:"",title:S.get("char"),pic:""},context:{id:"",title:S.get("context"),pic:""},problem:{id:"",title:S.get("problem"),pic:""}}),M={"char":0,context:0,problem:0},_=!0,D={"char":new u,context:new u,problem:new u},P="",H=null,B=0,j="step",F=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:337,left:490})).spin(),I={};return b.plugins.addAll({labels:new n(S),musetup:new n(A,{setReload:function(e){e===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){j==="step"&&A.get("char").selected&&A.get("context").selected&&A.get("problem").selected&&N.get("_id")===d.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),musetuptimer:new n(k,{setTime:function(e){e&&(this.innerHTML=c.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),musetupcards:new n(O,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():this.innerHTML=e},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},s.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),place:new r({chat:E}),musetupevent:new i(b)}),b.template='<div id = "musetup"><div class="previousbutton" data-musetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="musetup-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, musetup" data-musetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-musetuptimer="bind:setTime, timer; bind: displayTimer, display" data-musetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-musetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, char.pic" data-musetup="bind: popup, char.popup"><div class="cardpicture" data-musetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, context.pic" data-musetup="bind: popup, context.popup"><div class="cardpicture" data-musetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, problem.pic" data-musetup="bind: popup, problem.popup"><div class="cardpicture" data-musetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-musetup="bind:setSelected, char.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="context" data-musetup="bind:setSelected, context.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="problem" data-musetup="bind:setSelected, problem.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-musetupevent="listen: mousedown, press; listen:mouseup, next" data-musetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',b.press=function(e,t){t.classList.add("pressed")},b.next=function(e,t){F.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),j==="step"?(j="screen",v.set("characters",O.get("char")),v.set("contexts",O.get("context")),v.set("problems",O.get("problem")),clearInterval(L),k.set("display",!0),b.updateSessionScore(k.get("timer")).then(function(){return d.unsync(),d.sync(s.get("db"),d.get("_id"))}).then(function(){E.conclude("next"),d.set("elapsedTimers",{musetup:k.get("timer")}),d.set("characters",[O.get("char").id]),d.set("contexts",[O.get("context").id]),d.set("problems",[O.get("problem").id]),g("musetup")})):g("musetup")},b.stopSpinner=function(){F.stop()},b.help=function(e,t){l.setContent("musetuphelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},b.prev=function(e,t){t.classList.remove("pressed"),m("musetup")},b.toggleProgress=function(e,t){y()},b.toggleTimer=function(e,t){d.get("initiator").id===N.get("_id")&&k.set("display",!k.get("display"))},b.push=function(e,t){j!=="screen"&&N.get("_id")===d.get("initiator").id&&t.classList.add("pushed")},b.draw=function(e,t){var n=t.getAttribute("name"),r=A.get(n);_now=new Date,N.get("_id")===d.get("initiator").id&&j==="step"&&_&&(_=!1,r.left===0&&(C[n]=v.get("deck")[n].concat(),r.left=C[n].length,A.set(n,r)),r.selected?(_=!0,alert("please unlock selected card first")):r.selected===!1?b.drawCard(n).then(function(){var e=!1;t.classList.remove("pushed"),_=!0,A.loop(function(t,n){t.popup===!0&&(e=!0)}),e&&b.setPopup(n)}):(t.classList.remove("pushed"),_=!0))},b.pushOk=function(e,t){var n=I[t.getAttribute("name")]||null;N.get("_id")===d.get("initiator").id&&j==="step"&&(n?I[t.getAttribute("name")].spin(t):I[t.getAttribute("name")]=(new h).spin(t))},b.accept=function(e,t){var n=t.getAttribute("name"),r=A.get(n);j==="step"&&d.get("initiator").id===N.get("_id")&&(O.get(n).id?r.selected=!r.selected:r.selected=!1,d.unsync(),d.sync(s.get("db"),d.get("_id")).then(function(){return d.set("selected_"+n,r.selected),d.upload()}).then(function(){I[t.getAttribute("name")].stop(),selection.set(n,r)}))},b.zoom=function(e,t){var n=t.getAttribute("name");b.setPopup(n)},b.setPopup=function(t){var n={x:0,y:257},r="left",i=A.get(P)||"",s=A.get(t);i&&(i.popup=!1,A.set(P,i)),s.popup=!0,A.set(t,s),P=t,t==="char"&&(n.x=382),t==="context"&&(n.x=102,r="right"),t==="problem"&&(n.x=249,r="right"),D[t].getNbItems()&&w.reset(D[t].toJSON(),n,r,document.getElementById("musetup-popup"))},b.closePopup=function(){var t=A.get(P);t.popup=!1,A.set(P,t),P=""},w=new f(b.closePopup),b.getChatUI=function(){return E},b.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;k.set("timer",r),d.get("step")==="musetup"&&(clearInterval(L),L=setInterval(function(){var e=new Date;k.set("timer",r+e.getTime()-n)},1e3))},b.reset=function(t){E.clear(),d.get("chat")[1]&&E.reset(d.get("chat")[1]),t?(j="screen",E.dom.querySelector(".chatread").classList.add("extended"),B=d.get("elapsedTimers").musetup||0,A.reset({"char":{selected:!0,left:1,popup:!1},context:{selected:!0,left:1,popup:!1},problem:{selected:!0,left:1,popup:!1}}),P="",k.set("timer",B),k.set("display",!0),d.get("characters").length&&b.getDeck(d.get("deck")).then(function(){return b.getCard(d.get("characters")[0],D.char)}).then(function(){var e=D.char;return O.set("char",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),v.set("characters",O.get("char")),b.getCard(d.get("contexts")[0],D.context)}).then(function(){var e=D.context;return O.set("context",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),v.set("contexts",O.get("context")),b.getCard(d.get("problems")[0],D.problem)}).then(function(){var e=D.problem;O.set("problem",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),v.set("problems",O.get("problem"))})):b.init()},b.getDeck=function(t){var n=new a,r=new o;return r.setTransport(x),r.sync(T,t).then(function(){var e,t={},i=s.get("user").get("lang");!r.get("default_lang")||r.get("default_lang")===i?e=JSON.parse(r.toJSON()):r.get("translations")&&r.get("translations")[i]?e=r.get("translations")[i]:e=JSON.parse(r.toJSON()),t.char=e.content.characters,t.context=e.content.contexts,t.problem=e.content.problems,t.techno=e.content.techno,["char","context","problem","techno"].forEach(function(e){t[e][0]==="newcard"&&t[e].shift()}),v.set("deck",t),n.fulfill(),r.unsync()}),n},b.getCard=function(t,n){var r=new a,i=new o;return i.setTransport(x),i.sync(T,t).then(function(){n.reset(JSON.parse(i.toJSON())),r.fulfill(),i.unsync()}),r},b.drawCard=function(t){var n=new a,r=Math.floor(Math.random()*C[t].length),i=C[t][r];return d.set("drawn_"+t,i),d.upload().then(function(){M[t]++,C[t].splice(r,1),n.fulfill()}),n},b.updateDrawnCard=function(t,n){var r,i,s=new a;return t&&n&&(r=A.get(t),i=O.get(t),b.getCard(n,D[t]).then(function(){var e=D[t];i.id=n,i.title=e.get("title"),i.pic=e.get("picture_file"),O.set(t,i),r.left=C[t].length,A.set(t,r),s.fulfill()})),s},b.updateSessionScore=function(t){var n=new a,r={sid:d.get("_id"),step:"musetup",time:t,cards:M.char+M.context+M.problem};return console.log("before transport request : ",r),x.request("UpdateSessionScore",r,function(e){console.log(e),e.res==="ok"?n.fulfill():n.reject()}),n},b.init=function(){O.reset({"char":{id:"",title:S.get("char"),pic:""},context:{id:"",title:S.get("context"),pic:""},problem:{id:"",title:S.get("problem"),pic:""}}),A.reset({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),M.char=0,M.context=0,M.problem=0,D={"char":new u,context:new u,problem:new u},P="",N.get("_id")===d.get("initiator").id?b.getDeck(d.get("deck")).then(function(){var e=v.get("deck");C.char=e.char.concat(),C.context=e.context.concat(),C.problem=e.problem.concat(),_=!0,b.initTimer()}):k.set("display",!1),j="step"},d.watchValue("drawn_char",function(e){e&&b.updateDrawnCard("char",e)}),d.watchValue("drawn_context",function(e){e&&b.updateDrawnCard("context",e)}),d.watchValue("drawn_problem",function(e){e&&b.updateDrawnCard("problem",e)}),d.watchValue("selected_char",function(e){var t;t=A.get("char"),t.selected=e,A.set("char",t),e&&v.set("characters",O.get("char"))}),d.watchValue("selected_context",function(e){var t;t=A.get("context"),t.selected=e,A.set("context",t),e&&v.set("contexts",O.get("context"))}),d.watchValue("selected_problem",function(e){var t;t=A.get("problem"),t.selected=e,A.set("problem",t),e&&v.set("problems",O.get("problem"))}),d.watchValue("elapsedTimers",function(e){e.musetup&&(k.set("timer",e.musetup),k.set("display",!0))}),b}}),define("brainstorm/multi/session/muscenario",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../../whiteboard/whiteboard","Promise","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(v,m,g,y,b){var w=new e,E,S,x=new p,T=s.get("labels"),N=s.get("user"),C=s.get("db"),k=new o,L=new o,A=new o,O=new o({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),M={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},_=new o(M),D=new o({timer:null,display:!1}),P,H,B=new o({title:"",story:"",solution:""}),j=new o([]),F=new f("scenario",j,_,"mu"),I,q=0,R="step",U=s.get("transport"),z=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670})).spin();return w.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===N.get("_id")},w.plugins.addAll({labels:new n(T,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(O,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},s.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new n(_,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){w.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showStory:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),muscenariotimer:new n(D,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(B),wbstack:F,place:new i({chat:x}),muscenarioevent:new r(w)}),w.template='<div id = "muscenario"><div class="previousbutton" data-muscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muscenario" data-muscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-muscenarioevent="listen:mousedown,toggleTimer"></div><div id="muscenario-left"><div class="scenario-cards leftarea folded" data-muscenarioevent="listen:mousedown, fold"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div><div class="caret"></div></div><div id="muscenario-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard" data-muscenarioevent = "listen:mousedown, toggleView"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muscenarioevent="listen:mousedown, toggleCaret"></div></div><div id = "muscenario-writeup" class="writeup invisible" data-wbtools="bind: showStory,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',w.place(t.get("muscenario")),w.press=function(e,t){t.classList.add("pressed")},w.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===N.get("_id")},w.next=function(e,t){z.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),R==="step"?(R="screen",_.set("readonly",!0),clearInterval(P),D.set("display",!0),clearInterval(H),m.set("scenario",JSON.parse(B.toJSON())),v.unsync(),v.sync(C,v.get("_id")).then(function(){var e;return x.conclude("next"),e=v.get("elapsedTimers"),e.muscenario=D.get("timer"),v.set("elapsedTimers",e),v.set("scenario",[m.get("scenario")]),v.upload()}).then(function(){return w.updateSessionScore(D.get("timer"))}).then(function(){y("muscenario")})):y("muscenario")},w.stopSpinner=function(){z.stop()},w.prev=function(e,t){t.classList.remove("pressed"),g("muscenario")},w.toggleProgress=function(e,t){b()},w.toggleTimer=function(e,t){w.isLeader()&&D.set("display",!D.get("display"))},w.push=function(e,t){var n=t.getAttribute("name");_.set(n,"active")},w.zoom=function(e,t){e.stopPropagation();var n=t.getAttribute("name");w.setPopup(n)},w.fold=function(e,t){v.get("scReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),S&&E.close())},w.setPopup=function(t){var n={x:147,y:130},r="left",i=O.get(t),s=_.get("cardpopup"),o="",a;S&&(s[S]=!1),s[t]=!0,_.set("cardpopup",s),S=t,t==="char"&&(n.y=120,i.id===k.get("_id")&&(o=k.toJSON())),t==="context"&&(n.y=290,i.id===L.get("_id")&&(o=L.toJSON())),t==="problem"&&(n.y=350,i.id===A.get("_id")&&(o=A.toJSON())),o?E.reset(o,n,r,document.getElementById("muscenario-popup")):(a=new u,a.setTransport(U),a.sync(C,i.id).then(function(){o=a.toJSON(),E.reset(o,n,r,document.getElementById("muscenario-popup")),t==="char"&&k.reset(JSON.parse(a.toJSON())),t==="context"&&L.reset(JSON.parse(a.toJSON())),t==="problem"&&A.reset(JSON.parse(a.toJSON()))}))},w.closePopup=function(){var t=_.get("cardpopup");t[S]=!1,_.set("cardpopup",t),S=""},E=new a(w.closePopup),w.getChatUI=function(){return x},w.post=function(e,t){F.selectScreen("postit"),_.set("import","inactive"),_.set("drawing","inactive")},w.importpic=function(e,t){F.selectScreen("import"),_.set("postit","inactive"),_.set("drawing","inactive")},w.draw=function(e,t){F.selectScreen("drawing"),_.set("import","inactive"),_.set("postit","inactive")},w.exitTool=function(t){_.set(t,"inactive")},w.finish=function(e,t){var n=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50})).spin();n.spin(t.parentNode),t.classList.add("invisible"),v.unsync(),v.sync(C,v.get("_id")).then(function(){return v.set("scReady",!0),v.upload()}).then(function(){n.stop(),t.classList.remove("pressed"),_.set("ready",!1),w.displayStory(),w.updateScenario()})},w.updateField=function(t,n){n.classList.contains("enterTitle")&&B.set("title",n.value),n.classList.contains("enterDesc")&&B.set("story",n.value),n.classList.contains("enterSol")&&B.set("solution",n.value)},w.displayStory=function(){F.setReadonly(!0),_.set("showstory",!0),w.dom.querySelector(".scenario-cards").classList.remove("folded"),w.dom.querySelector(".scenario-cards .caret").classList.add("invisible"),w.dom.querySelector(".writeup").scrollIntoView(),w.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},w.hideStory=function(){w.dom.querySelector(".scenario-cards").classList.add("folded"),w.dom.querySelector(".scenario-cards .caret").classList.remove("invisible"),w.dom.querySelector(".whiteboard .caret").classList.add("invisible")},w.toggleCaret=function(e,t){e.stopPropagation();var n=w.dom.querySelector(".writeup"),r=w.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?n.scrollIntoView():r.scrollIntoView()},w.toggleView=function(e,t){var n=t.querySelector(".caret"),r=w.dom.querySelector(".writeup"),i=w.dom.querySelector(".whiteboard");n.classList.contains("descending")?(n.classList.remove("descending"),i.scrollIntoView()):e.pageY-t.scrollHeight>0&&(n.classList.add("descending"),r.scrollIntoView())},w.updateScenario=function(){H=setInterval(function(){var e=v.get("scenario")[0]||{title:"",story:"",solution:""},t=e.title,n=e.story,r=e.solution,i={};if(B.get("title")!==t||B.get("story")!==n||B.get("solution")!==r)i.title=B.get("title"),i.story=B.get("story"),i.solution=B.get("solution"),v.set("scenario",[i]),v.upload().then(function(e){return console.log("scenario updated in CouchDB"),!0},function(e){console.log("failed to update scenario",e)})},8e3)},w.updateSessionScore=function(e){var t=new l,n={sid:v.get("_id"),step:"muscenario",time:e,wbcontent:j.toJSON(),scenario:B.toJSON()};return U.request("UpdateSessionScore",n,function(e){console.log(e),e.res==="ok"?(v.unsync(),v.sync(C,v.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},w.reset=function(t){x.clear(),v.get("chat")[2]&&x.reset(v.get("chat")[2]),_.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),F.setSessionId(v.get("_id")),j.reset(v.get("scenarioWB")),j.getNbItems()?F.selectScreen("main"):F.selectScreen("default"),t||v.get("scenario").length?(R="screen",x.dom.querySelector(".chatread").classList.add("extended"),_.set("ready",!1),w.displayStory(),_.set("readonly",!0),_.set("shownext",!1),B.reset(v.get("scenario")[0]),m.set("scenario",v.get("scenario")[0])):(B.reset({title:"",story:"",solution:""}),j.getNbItems()?_.set("ready",!0):_.set("ready",!1),F.setReadonly(!1),w.hideStory(),R="step"),v.get("elapsedTimers").muscenario&&(q=v.get("elapsedTimers").muscenario,D.set("timer",q),R==="screen"?D.set("display",!0):w.isLeader()&&w.initTimer(q))},w.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;D.set("display",!1),D.set("timer",r),v.get("step")==="muscenario"&&(clearInterval(P),P=setInterval(function(){var e=new Date;D.set("timer",r+e.getTime()-n)},1e3))},m.watchValue("characters",function(e){O.set("char",e)}),m.watchValue("contexts",function(e){O.set("context",e)}),m.watchValue("problems",function(e){O.set("problem",e)}),v.watchValue("_id",function(e){F.setSessionId(e)}),v.watchValue("chat",function(e){e.length===3&&x.getModel().get("_id")!==e[2]&&x.reset(e[2])}),["added","deleted","updated"].forEach(function(e){j.watch(e,function(e){if(!_.get("showstory")){if(v.get("scenarioWB").length!==j.getNbItems()||JSON.stringify(v.get("scenarioWB"))!==j.toJSON())v.set("scenarioWB",JSON.parse(j.toJSON())),v.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)});j.getNbItems()&&R==="step"?_.set("ready",!0):_.set("ready",!1)}})}),v.watchValue("scenarioWB",function(e){v.get("step")==="muscenario"&&!_.get("showstory")&&(e.length&&F.getStack().getCurrentName()==="default"&&F.selectScreen("main"),e.length||F.selectScreen("default"),(e.length!==j.getNbItems()||JSON.stringify(e)!==j.toJSON())&&j.reset(e))}),v.watchValue("scReady",function(e){v.get("step")==="muscenario"&&e&&!w.isLeader()&&(_.set("readonly",!0),w.displayStory())}),v.watchValue("scenario",function(e){w.isLeader()||(B.reset(e[0]),m.set("scenario",JSON.parse(B.toJSON())))}),B.watch("updated",function(){w.isLeader()&&B.get("title")&&B.get("story")&&B.get("solution")?_.set("shownext",!0):_.set("shownext",!1)}),SCWHITEB=F,SCCONTENT=j,SC=B,w}}),define("brainstorm/multi/session/mutech",["OObject","service/map","Place.plugin","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(v,m,g,y,b){var w=new e,E=null,S=null,x,T=new u({timer:null,display:!1}),N=s.get("transport"),C=s.get("user"),k=s.get("db"),L=s.get("labels"),A,O,M=new p,_=new u({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),D=[],P=!0,H=new u,B=new u,j=new u,F={tech1:H,tech2:B,tech3:j},I=0,q=new u([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),R="step",U=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:336,left:481})).spin(),z={};return w.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===C.get("_id")},w.plugins.addAll({labels:new r(L),display:new r(_,{setReload:function(e){!e&&I>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){w.isLeader()&&_.get("tech1").selected&&_.get("tech2").selected&&_.get("tech3").selected&&R==="step"?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new r(q,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.toUpperCase():this.innerHTML=L.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},s.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),mutechtimer:new r(T,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),place:new n({chat:M}),mutechevent:new i(w)}),w.template='<div id = "mutech"><div class="previousbutton" data-mutechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="mutech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, mutech" data-mutechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-mutechtimer="bind:setTime, timer; bind: displayTimer, display" data-mutechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-mutechevent="listen:mousedown, help"></div><div id="mutech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-mutechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-mutechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-mutechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',w.place(t.get("mutech")),w.press=function(e,t){t.classList.add("pressed")},w.next=function(e,t){var n=new Date,r=n.getTime()-E;U.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),R==="step"?(R="screen",m.set("techno",q),clearInterval(x),T.set("display",!0),w.updateSessionScore(T.get("timer")).then(function(){v.unsync(),v.sync(k,v.get("_id")).then(function(){var e=v.get("elapsedTimers");M.conclude("next"),e.mutech=T.get("timer"),v.set("elapsedTimers",e),v.set("techno",[[q.get(0).id,q.get(1).id,q.get(2).id]]),y("mutech")})})):y("mutech")},w.stopSpinner=function(){U.stop()},w.help=function(e,t){o.setContent("mutechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},w.prev=function(e,t){t.classList.remove("pressed"),g("mutech")},w.toggleProgress=function(e,t){b()},w.toggleTimer=function(e,t){w.isLeader()&&T.set("display",!T.get("display"))},w.select=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||I>0||R==="screen")&&t.classList.add("highlighted")},w.zoom=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||I>0||R==="screen")&&w.setPopup(n)},w.setPopup=function(t){var n={x:0,y:257},r="left",i=_.get(O)||"",s=new u,o,a=_.get(t);i&&(i.popup=!1,_.set(O,i)),a.popup=!0,_.set(t,a),O=t,t==="scenario"?(n.x=147,n.y=275,s.reset(v.get("scenario")[0]),s.set("type",5),o=s.toJSON()):(t==="tech1"&&(n.x=467),t==="tech2"&&(n.x=186,r="right"),t==="tech3"&&(n.x=333,r="right"),F[t].get("_id")&&(o=F[t].toJSON())),o&&A.reset(o,n,r,document.getElementById("mutech-popup"))},w.closePopup=function(){var t=_.get(O);t.popup=!1,_.set(O,t),O=""},w.push=function(e,t){var n=t.getAttribute("name");t.classList.contains("drawok")?F[n].get("_id")&&R==="step"&&w.isLeader()&&t.classList.add("pushed"):t.classList.add("pushed")},w.draw=function(e,t){var n=[];w.isLeader()&&R==="step"&&P?(P=!1,["tech1","tech2","tech3"].forEach(function(e){_.get(e).selected||n.push(e)}),w.drawTech(n).then(function(){t.classList.remove("pushed"),P=!0})):t.classList.remove("pushed")},w.drawTech=function(t){var n,r=[],i=new f,s=new u({count:t.length});return t.length?(t.forEach(function(e){D.length<=0&&(D=m.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){_.get(e).selected&&r.push(q.get(t).id)}),D.filter(function(e){return!(r.indexOf(e)>-1)})),n=Math.floor(Math.random()*D.length),w.getCardDetails(D[n],e).then(function(){var e=s.get("count");e--,s.set("count",e)}),_.set("left",D.length),I++,D.splice(n,1)}),s.watchValue("count",function(e){e||(v.unsync(),v.sync(k,v.get("_id")).then(function(){return["tech1","tech2","tech3"].forEach(function(e,t){v.set("drawn"+e,q.get(t).id)}),v.upload()}).then(function(){i.fulfill()}))})):i.fulfill(),DRS=s,i},w.getCardDetails=function(t,n){var r=new a,i=["tech1","tech2","tech3"],s=i.indexOf(n),o=new f;return r.setTransport(N),r.sync(k,t).then(function(){F[n].reset(JSON.parse(r.toJSON())),q.update(s,"id",t),q.update(s,"title",r.get("title")),q.update(s,"pic",r.get("picture_file")),o.fulfill(),r.unsync()}),o},w.pushOk=function(e,t){var n=z[t.getAttribute("name")]||null;w.isLeader()&&R==="step"&&(n?z[t.getAttribute("name")].spin(t):z[t.getAttribute("name")]=(new h).spin(t))},w.accept=function(e,t){var n=t.getAttribute("name"),r=["tech1","tech2","tech3"],i=r.indexOf(n),s=_.get(n);R==="step"&&w.isLeader()&&(q.get(i)&&q.get(i).id?s.selected=!s.selected:s.selected=!1,v.unsync(),v.sync(k,v.get("_id")).then(function(){return v.set("selected_"+n,s.selected),v.upload()}).then(function(){z[t.getAttribute("name")].stop(),_.set(n,s)}))},w.reset=function(t){var n=v.get("techno")[0];M.clear(),v.get("chat")[3]&&M.reset(v.get("chat")[3]),_.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),t||n.length?(R="screen",M.dom.querySelector(".chatread").classList.add("extended"),w.getCardDetails(n[0],"tech1").then(function(){return w.getCardDetails(n[1],"tech2")}).then(function(){return w.getCardDetails(n[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){_.set(e,{popup:!1,selected:!0})}),m.set("techno",q)})):(D=[],I=0,R="step",H.reset(),B.reset(),j.reset(),q.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),v.get("elapsedTimers").mutech&&(S=v.get("elapsedTimers").mutech,T.set("timer",S),R==="screen"?T.set("display",!0):w.isLeader()&&w.initTimer(S))},w.updateSessionScore=function(t){var n=new f,r={sid:v.get("_id"),step:"mutech",time:t,cards:I};return N.request("UpdateSessionScore",r,function(e){e.res==="ok"?n.fulfill():n.reject()}),n},w.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;T.set("display",!1),T.set("timer",r),v.get("step")==="mutech"&&(clearInterval(x),x=setInterval(function(){var e=new Date;T.set("timer",r+e.getTime()-n)},1e3))},A=new l(w.closePopup),w.getChatUI=function(){return M},v.watchValue("chat",function(e){e.length===4&&M.getModel().get("_id")!==e[3]&&M.reset(e[3])}),m.watchValue("deck",function(e){D=e.techno.concat(),_.set("left",D.length)}),["tech1","tech2","tech3"].forEach(function(e){v.watchValue("drawn"+e,function(t){w.isLeader()||w.getCardDetails(t,e)}),v.watchValue("selected_"+e,function(t){var n;w.isLeader()||(n=_.get(e),n.selected=t,_.set(e,n),t&&m.set("techno",q))})}),w}}),define("brainstorm/multi/session/muvote",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var a=new e,f=i.get("labels"),l=new s,c=i.get("user"),h=null,p=!1,d;return a.plugins.addAll({label:new n(f),model:new n(l,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setButton:function(e){e?this.setAttribute("style","display: inline-block;"):this.setAttribute("style","display:none;")},displayVote:function(e){var t=this.getAttribute("name"),n=l.get(t+"Votes"),r=this.querySelector(".yesvote"),i=this.querySelector(".novote");e?n.indexOf(c.get("_id"))>-1?i.classList.add("invisible"):r.classList.add("invisible"):(r.classList.remove("invisible"),i.classList.remove("invisible"))},setResult:function(e){e?this.innerHTML=f.get(e):this.innerHTML=""}}),event:new r(a)}),a.template='<div class = "confirm invisible"><legend><span data-label="bind:innerHTML, decidemsg"></span><span class="unanimity" data-label="bind: innerHTML, unanimity"></span></legend><div class="votingitem invisible" name="public" data-model="bind:setVisible,public; bind: displayVote, publicVote"><div class="sessionquestion" data-label="bind:innerHTML,setpublic"></div><div class = "votingbuttons" name="public"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, publicResult"></div></div><div class="votingitem invisible" name = "replay" data-model="bind:setVisible,replay; bind: displayVote, replayVote"><div class="sessionquestion" data-label="bind:innerHTML,enablereplay"></div><div class = "votingbuttons" name="replay"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, replayResult"></div></div><div id="muvotespinner"></div><div class="option left votebutton" data-event="listen:mousedown, press; listen:mouseup, submit" data-model="bind:setButton, submit" data-label="bind: innerHTML, submitlbl">Submit</div><div class="option right votebutton" data-event="listen:mousedown, press; listen:mouseup, skip" data-model="bind:setButton, skip" data-label="bind:innerHTML, skiplbl">Skip</div></div>',a.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},a.push=function(e,t){var n=t.parentNode,r=n.getAttribute("name");!l.get(r+"Vote")&&!l.get(r+"Result")&&t.setAttribute("style","-webkit-box-shadow: 0px 0px 2px #657B99;")},a.vote=function(t,n){var r=n.parentNode,i=r.getAttribute("name");n.setAttribute("style","-webkit-box-shadow: none;");if(l.get("leader"))n.classList.toggle("voted"),n.classList.contains("yesvote")?n.classList.contains("voted")?(l.set(i+"Votes",[c.get("_id")]),r.querySelector(".novote").classList.remove("voted")):l.set(i+"Votes",[]):(r.querySelector(".yesvote").classList.remove("voted"),l.set(i+"Votes",[])),!l.get("publicVotes").length&&!l.get("replayVotes").length?l.set("submit",!1):l.set("submit",!0);else if(!l.get(i+"Vote")){var s=l.get(i+"Votes");n.classList.contains("novote")?(i==="public"&&l.set("publicResult","rejected"),i==="replay"&&l.set("replayResult","rejected")):(s.push(c.get("_id")),l.set(i+"Votes",s),s.length===h.get("participants").length+1&&(i==="public"&&l.set("publicResult","accepted"),i==="replay"&&l.set("replayResult","accepted"))),n.classList.add("voted"),l.set(i+"Vote",!0),p?setTimeout(a.uploadVote,3e3):a.uploadVote()}},a.uploadVote=function(){var t;l.get("leader")||(t=h.get("vote"),p=!0,t.public&&(t.publicVotes=l.get("publicVotes"),t.publicResult=l.get("publicResult")),t.replay&&(t.replayVotes=l.get("replayVotes"),t.replayResult=l.get("replayResult")),h.set("vote",t),h.upload().then(function(){console.log("upload ok"),p=!1},function(e){console.log(e)}))},a.submit=function(e,t){var n={};t.classList.remove("pressed"),l.set("skip",!1),l.set("submit",!1),["public","replay"].forEach(function(e){l.get(e+"Votes").length?(n[e]=!0,n[e+"Votes"]=[c.get("_id")]):l.get(e+"Vote")?l.set(e+"Result","rejected"):l.set(e,!1),l.set(e+"Vote",!0)}),h.set("vote",n),h.upload().then(function(){console.log("VOTE : leader upload successful")},function(e){console.log(e)})},a.skip=function(e,t){t&&t.classList.remove("pressed"),a.close(),d({visibility:"private",replay:!1})},a.close=function(){t.get("cache").classList.remove("votingcache"),a.dom.classList.add("invisible"),h=null},a.isActive=function(){return h!==null},a.show=function(){t.get("cache").classList.add("votingcache"),a.dom.classList.remove("invisible")},a.reset=function(n,r){var i;h=n,d=r,l.reset({}),h.get("vote")&&l.reset(h.get("vote")),h.get("initiator").id===c.get("_id")?(l.set("leader",!0),l.set("submit",!1),l.set("skip",!0),["public","replay"].forEach(function(e){l.set(e,!0),l.set(e+"Vote",!1),l.set(e+"Votes",[]),l.set(e+"Result","")})):(l.set("leader",!1),l.set("submit",!1),l.set("skip",!1)),l.set("publicVote",!1),l.set("replayVote",!1),a.show(),i=h.watchValue("vote",function(e){var n={},r=new o({lines:10,length:8,width:4,radius:8,top:10});exitVote=function(){h.unwatch(i),r.spin(a.dom.querySelector("#muvotespinner")),setTimeout(function(){r.stop(),t.get("cache").classList.remove("votingcache"),d&&d(n)},5e3)},e&&e.public&&e.replay?(l.set("publicResult",e.publicResult),l.set("replayResult",e.replayResult),e.publicResult&&e.replayResult&&(e.publicResult==="accepted"?n.visibility="public":n.visibility="private",e.replayResult==="accepted"?n.replay=!0:n.replay=!1,exitVote())):e&&e.public?(l.set("publicResult",e.publicResult),n.replay=!1,e.publicResult&&(e.publicResult==="accepted"?n.visibility="public":n.visibility="private",n.replay=!1,exitVote())):e&&e.replay&&(l.set("replayResult",e.replayResult),n.visibility="private",e.replayResult&&(e.replayResult==="accepted"?n.replay=!0:n.replay=!1,exitVote()))})},VOTE=l,VOTEUI=a,a}}),define("brainstorm/multi/session/muidea",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/cardpopup","../../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min","./mubchat","./muvote"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(m,g,y,b,w){var E=new e,S,x,T=new p,N=new d,C="step",k,L=0,A,O,M=new a({timer:null,display:!1}),_=new a({title:"",description:"",solution:"",visibility:"private"}),D=new a,P=new a([]),H=[],B={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},j=new a(B),F=new a([]),I=new u("idea",F,j,"mu"),q=s.get("transport"),R=s.get("user"),U=s.get("db"),z=s.get("labels"),W=!1,X=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670})).spin();return E.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===R.get("_id")},E.plugins.addAll({labels:new n(z,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(D),techs:new n(P,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},s.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new n(j,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){E.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showIdea:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),muideatimer:new n(M,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(_),wbstack:I,place:new i({chat:T,vote:N}),muideaevent:new r(E)}),E.template='<div id = "muidea"><div class="previousbutton" data-muideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muidea" data-muideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muideatimer="bind:setTime, timer; bind: displayTimer, display" data-muideaevent="listen:mousedown,toggleTimer"></div><div id="muidea-left"><div class="idea-cards leftarea folded" data-muideaevent="listen:mousedown, fold"><div class="card defaultscenario" name="scenario" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul><div class="caret"></div></div><div id="muidea-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muideaevent="listen:mousedown, toggleCaret"></div></div><div id = "muidea-writeup" class="writeup invisible" data-wbtools="bind: showIdea,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionvote" data-place="place:vote"></div><div class="sessionchat" data-place="place:chat"></div></div>',E.place(t.get("muidea")),E.press=function(e,t){t.classList.add("pressed")},E.next=function(e,t){var n=new Date,r,i,s,o,u=new l;t.classList.add("invisible"),t.classList.remove("pressed"),C==="step"?(C="screen",j.set("readonly",!0),clearInterval(A),M.set("display",!0),clearInterval(O),i=E.getSessionDuration(),N.reset(m,function(e){W=!0,s=e.visibility,o=e.replay,_.set("visibility",s),_.set("sessionReplay",o),u.fulfill(),N.close()}),u.then(function(){return X.spin(t.parentNode),g.set("idea",JSON.parse(_.toJSON())),E.createIdeaDoc()}).then(function(){return m.unsync(),m.sync(U,m.get("_id"))}).then(function(){var e=m.get("elapsedTimers");return T.conclude("next"),e.muidea=M.get("timer"),m.set("idea",[JSON.parse(_.toJSON())]),o&&m.set("replayIdeas",[]),m.set("elapsedTimers",e),m.set("duration",i),m.set("status","completed"),m.set("idea",[g.get("idea")]),m.upload()}).then(function(){return E.updateSessionScore(M.get("timer"))}).then(function(){b("muidea")})):b("muidea")},E.stopSpinner=function(){X.stop()},E.prev=function(e,t){t.classList.remove("pressed"),y("muidea")},E.toggleProgress=function(e,t){w()},E.toggleTimer=function(e,t){E.isLeader()&&M.set("display",!M.get("display"))},E.toggleVisibility=function(e,t){C==="step"&&E.isLeader()&&(_.get("visibility")==="public"?_.set("visibility","private"):_.set("visibility","public"))},E.push=function(e,t){var n=t.getAttribute("name");j.set(n,"active")},E.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),E.setPopup(n,r)},E.fold=function(e,t){m.get("ideaReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),x&&S.close())},E.setPopup=function(t,n){var r={x:147,y:30},i="left",o=j.get("cardpopup"),u=new a,l="",c,h;x&&(x.type==="scenario"?o.scenario=!1:o.techs[x.id]=!1,j.set("cardpopup",o)),t==="scenario"?o.scenario=!0:o.techs[n]=!0,j.set("cardpopup",o),x={type:t,id:n},t==="scenario"?(r.y=55,u.reset(g.get("scenario")),u.set("type",5),l=u.toJSON(),S.reset(l,r,i,document.getElementById("muidea-popup"))):(n==0&&(r.y=200),n==1&&(r.y=260),n==2&&(r.y=350),H[n]?(l=H[n],S.reset(l,r,i,document.getElementById("muidea-popup"))):(h=new f,h.setTransport(q),h.sync(s.get("db"),g.get("techno").get(n).id).then(function(){l=h.toJSON(),S.reset(l,r,i,document.getElementById("muidea-popup")),H[n]=l})))},E.closePopup=function(){var t=j.get("cardpopup");t[x]=!1,j.set("cardpopup",t),x=""},S=new o(E.closePopup),E.getChatUI=function(){return T},E.post=function(e,t){I.selectScreen("postit"),j.set("import","inactive"),j.set("drawing","inactive")},E.importpic=function(e,t){I.selectScreen("import"),j.set("postit","inactive"),j.set("drawing","inactive")},E.draw=function(e,t){I.selectScreen("drawing"),j.set("import","inactive"),j.set("postit","inactive")},E.exitTool=function(t){j.set(t,"inactive")},E.finish=function(e,t){var n=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50})).spin();n.spin(t.parentNode),t.classList.add("invisible"),m.unsync(),m.sync(U,m.get("_id")).then(function(){return m.set("ideaReady",!0),m.upload()}).then(function(){n.stop(),t.classList.remove("pressed"),j.set("ready",!1),E.displayIdea(),E.updateIdea()})},E.updateField=function(t,n){n.classList.contains("enterTitle")&&_.set("title",n.value),n.classList.contains("enterDesc")&&_.set("description",n.value),n.classList.contains("enterSol")&&_.set("solution",n.value)},E.displayIdea=function(){I.setReadonly(!0),j.set("showidea",!0),E.dom.querySelector(".idea-cards").classList.remove("folded"),E.dom.querySelector(".idea-cards .caret").classList.add("invisible"),E.dom.querySelector(".writeup").scrollIntoView(),E.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},E.hideIdea=function(){E.dom.querySelector(".idea-cards").classList.add("folded"),E.dom.querySelector(".idea-cards .caret").classList.remove("invisible"),E.dom.querySelector(".whiteboard .caret").classList.add("invisible")},E.toggleCaret=function(e,t){e.stopPropagation();var n=E.dom.querySelector(".writeup"),r=E.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?n.scrollIntoView():r.scrollIntoView()},E.toggleView=function(e,t){var n=t.querySelector(".caret"),r=E.dom.querySelector(".writeup"),i=E.dom.querySelector(".whiteboard");n.classList.contains("descending")?(n.classList.remove("descending"),i.scrollIntoView()):e.pageY-t.scrollHeight>0&&(n.classList.add("descending"),r.scrollIntoView())},E.updateIdea=function(t,n){O=setInterval(function(){var e=m.get("idea")[0]||{title:"",description:"",solution:""},t=e.title,n=e.description,r=e.solution,i={};if(_.get("title")!==t||_.get("description")!==n||_.get("solution")!==r)i.title=_.get("title"),i.description=_.get("description"),i.solution=_.get("solution"),m.set("idea",[i]),m.upload().then(function(e){return console.log("idea updated in CouchDB"),!0},function(e){console.log("failed to update idea",e)})},8e3)},E.updateSessionScore=function(e){var t=new l,n={sid:m.get("_id"),step:"muidea",time:e,wbcontent:F.toJSON(),idea:_.toJSON()};return q.request("UpdateSessionScore",n,function(e){e.res==="ok"?(m.unsync(),m.sync(U,m.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},E.getSessionDuration=function(){var t=m.get("elapsedTime"),n=m.get("resumeTime")||m.get("startTime");return now=new Date,now.getTime()-n+t},E.createIdeaDoc=function(){var t=new f(s.get("ideaTemplate")),n=new Date,r="I:"+n.getTime(),i=[],o=[],u=new l;return i.push(m.get("initiator").id),o.push(m.get("initiator").username),m.get("participants").forEach(function(e){i.push(e.id),o.push(e.username)}),t.setTransport(q),t.set("title",_.get("title")),t.set("sessionId",m.get("_id")),t.set("authors",i),t.set("description",_.get("description")),t.set("solution",_.get("solution")),t.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),t.set("character",m.get("characters")[0]),t.set("problem",m.get("problems")[0]),t.set("context",m.get("contexts")[0]),t.set("techno",m.get("techno")[0]),t.set("visibility",_.get("visibility")),t.set("sessionReplay",_.get("sessionReplay")),t.set("authornames",o.join(", ")),t.set("lang",m.get("lang")),t.set("_id",r),t.sync(s.get("db"),r).then(function(){return t.upload()}).then(function(){t.get("visibility")==="public"&&(q.request("UpdateUIP",{userid:R.get("_id"),type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(e){e!=="ok"&&console.log(e)}),m.get("participants").forEach(function(e){q.request("UpdateUIP",{userid:e.id,type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(t){t!=="ok"&&console.log(e.id," "+t)})})),u.fulfill(),t.unsync()}),u},E.reset=function(t){T.clear(),m.get("chat")[4]&&T.reset(m.get("chat")[4]),j.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),P.reset(),I.setSessionId(m.get("_id")),F.reset(m.get("ideaWB")),F.getNbItems()?I.selectScreen("main"):I.selectScreen("default"),clearInterval(A),t||m.get("idea").length?(C="screen",T.dom.querySelector(".chatread").classList.add("extended"),j.set("ready",!1),E.displayIdea(),_.reset(m.get("idea")[0]),g.set("idea",m.get("idea")[0]),j.set("readonly",!0),j.set("shownext",!1)):(_.reset({title:"",description:"",solution:"",visibility:"private"}),F.getNbItems()?j.set("ready",!0):j.set("ready",!1),I.setReadonly(!1),C="step",W=!1),m.get("elapsedTimers").muidea&&(L=m.get("elapsedTimers").muidea,M.set("timer",L),C==="screen"?M.set("display",!0):E.isLeader()&&E.initTimer(L))},E.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;M.set("display",!1),M.set("timer",r),m.get("step")==="muidea"&&(A=setInterval(function(){var e=new Date;M.set("timer",r+e.getTime()-n)},1e3))},m.watchValue("_id",function(e){I.setSessionId(e)}),m.watchValue("chat",function(e){e.length===5&&T.getModel().get("_id")!==e[4]&&T.reset(e[4])}),g.watchValue("scenario",function(e){D.reset(g.get("scenario"))}),g.watchValue("techno",function(e){P.reset(JSON.parse(g.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){F.watch(e,function(e){if(!j.get("showidea")){if(m.get("ideaWB").length!==F.getNbItems()||JSON.stringify(m.get("ideaWB"))!==F.toJSON())m.set("ideaWB",JSON.parse(F.toJSON())),m.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)});F.getNbItems()?j.set("ready",!0):j.set("ready",!1)}})}),m.watchValue("ideaWB",function(e){m.get("step")==="muidea"&&!j.get("showidea")&&(e.length&&I.getStack().getCurrentName()==="default"&&I.selectScreen("main"),e.length||I.selectScreen("default"),(e.length!==F.getNbItems()||JSON.stringify(e)!==F.toJSON())&&F.reset(e))}),m.watchValue("ideaReady",function(e){m.get("step")==="muidea"&&e&&!E.isLeader()&&(j.set("readonly",!0),E.displayIdea())}),m.watchValue("idea",function(e){E.isLeader()||(_.reset(e[0]),g.set("idea",JSON.parse(_.toJSON())))}),_.watch("updated",function(){E.isLeader()&&_.get("title")&&_.get("description")&&_.get("solution")?j.set("shownext",!0):j.set("shownext",!1)}),m.watchValue("vote",function(e){e&&!W&&!E.isLeader()&&!N.isActive()&&(N.reset(m,function(e){e&&N.close()}),W=!0)}),E}}),define("brainstorm/multi/session/muwrapup",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","service/utils","./mubchat"],function(e,t,n,r,i,s,o,u,a){return function(l,c,h,p,d){var v=new e,m=new o,g=new o([]),y=s.get("labels"),b=new a,w;return v.plugins.addAll({labels:new n(y),wrapup:new n(m,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setScore:function(e){e&&(this.innerHTML=e+" ip")},setTime:function(e){e&&(this.innerHTML=u.formatDuration(e))},alertMsg:function(e){var t=this;e&&v.dom.querySelector(".sessionchat").classList.contains("folded")?w=setInterval(function(){t.classList.toggle("flashing")},300):w&&clearInterval(w)},setVisibility:function(e){e&&e==="public"?this.classList.add("publicwrapup"):this.classList.remove("publicwrapup")},setReplay:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(g,{formatTitle:function(e){var t=this.getAttribute("data-cards_id");e&&(t<3?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},s.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),place:new i({chat:b}),muwrapupevent:new r(v)}),v.template='<div id = "muwrapup"><div class="previousbutton" data-muwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muwrapup" data-muwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div><div class="wrapupvisibility" data-wrapup="bind:setVisibility, idea.visibility"></div><div class="wrapupreplay invisible" data-wrapup="bind:setReplay, idea.sessionReplay"></div></div><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessioncards" data-muwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div><div class="togglechat" data-wrapup="bind:alertMsg, newmsg" data-muwrapupevent="listen: mousedown, toggleChat"></div><div class="sessionchat folded" data-place="place:chat"></div></div>',v.place(t.get("muwrapup")),v.press=function(e,t){t.classList.add("pressed")},v.next=function(e,t){t.classList.remove("pressed"),p("muwrapup")},v.exit=function(){d(!0)},v.prev=function(e,t){t.classList.remove("pressed"),h("muwrapup")},v.toggleProgress=function(e,t){d()},v.toggleCards=function(e,t){t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")},v.toggleChat=function(t,n){m.set("newmsg",!1),v.dom.querySelector(".sessionchat").classList.toggle("folded")},v.getChatUI=function(){return b},v.reset=function(t){g.reset([]),m.reset(),b.clear(),l.get("chat")[5]&&b.reset(l.get("chat")[5]).then(function(){b.getModel().watchValue("msg",function(e){e.length>1&&!t&&(m.set("newmsg",!0),setTimeout(function(){clearInterval(w)},2500))}),t&&b.dom.querySelector(".chatread").classList.add("replayed")}),m.set("scenario",c.get("scenario")),m.set("idea",c.get("idea")),m.set("score",l.get("score")),m.set("duration",l.get("duration")),g.reset([]),t?["characters","contexts","problems","techno"].forEach(function(e){c.watchValue(e,function(t){switch(e){case"characters":g.set(0,t);break;case"contexts":g.set(1,t);break;case"problems":g.set(2,t);break;case"techno":t.loop(function(e,t){g.set(t+3,e)})}})}):g.reset([c.get("characters"),c.get("contexts"),c.get("problems"),c.get("techno").get(0),c.get("techno").get(1),c.get("techno").get(2)])},c.watchValue("scenario",function(e){m.set("scenario",e)}),c.watchValue("idea",function(e){m.set("idea",e)}),l.watchValue("score",function(e){m.set("score",e)}),l.watchValue("duration",function(e){m.set("duration",e)}),l.watchValue("chat",function(e){e.length===6&&b.getModel().get("_id")!==e[5]&&(b.reset(e[5]),b.getModel().watchValue("msg",function(e){e.length>1&&m.set("newmsg",!0)}))}),v}}),define("brainstorm/multi/session/mucontroller",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./mustart","./musetup","./muscenario","./mutech","./muidea","./muwrapup","CouchDBDocument","service/config","Promise","Store","lib/spin.min","Place.plugin","service/confirm"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){return function(y){var b=new e,w=new e,E=document.createDocumentFragment(),S=new n,x=h.get("labels"),T=[{name:"mustart",label:x.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:x.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:x.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:x.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:x.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:x.get("quickstepwrapup"),currentStep:!1,status:null}],N,C,k,L,A,O,M=new d(T),_=h.get("user"),D=h.get("db"),P=new c,H=new d,B=new d({msg:""}),j,F,I=(new v({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin();return w.plugins.addAll({labels:new r(x),step:new r(M,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(w)}),w.template='<div class = "progressbar invisible"><ul id = "musteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',w.changeStep=function(e,t){var n=t.getAttribute("data-step_id");M.get(n).status?(M.loop(function(e,t){n==t?M.update(t,"currentStep",!0):M.update(t,"currentStep",!1)}),S.getStack().show(M.get(n).name)):e.stopImmediatePropagation()},w.press=function(e,t){t.classList.add("pressed")},w.exit=function(e,t){t.classList.remove("pressed"),_.get("sessionInProgress").id!==P.get("_id")?y():P.get("step")==="muwrapup"?(O.getChatUI().leave(),P.get("initiator").id===_.get("_id")&&O.getChatUI().setReadonly(),_.set("sessionInProgress",""),_.upload().then(function(){y()})):j.show()},b.template='<div id="musession"><div data-place="place:progress"></div><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></div><div class="stack" data-musessionstack="destination"></div></div>',b.plugins.addAll({musessionstack:S,place:new m({progress:w}),info:new r(B)}),b.toggleProgress=function(t){t?w.exit():w.dom.classList.toggle("invisible")},b.leaveSession=function(){var t=P.get("participants"),n,r=S.getStack().get(P.get("step"));for(n=t.length-1;n>=0;n--)if(t[n].id===_.get("_id")){t.splice(n,1);break}P.set("participants",t),P.upload().then(function(){r.getChatUI().leave(),P.unsync(),j.hide(),document.body.removeChild(document.querySelector(".confirm"))}),_.set("sessionInProgress",""),_.upload().then(function(){y()})},b.cancelSession=function(){var t=5e3;b.displayInfo("deleting",t).then(function(){y()})},b.displayInfo=function(t,n){var r,i=document.querySelector(".sessionmsg"),s=new p,o=function(){i.classList.add("invisible"),clearInterval(r),B.set("msg",""),s.fulfill()};j.hide(),document.body.removeChild(document.querySelector(".confirm")),i.classList.remove("invisible"),r=setInterval(function(){switch(t){case"deleting":B.set("msg",x.get("deletingsession")+n/1e3+"s");break;case"participantsleft":B.set("msg",x.get("participantsleft")+" "+n/1e3+"s");break;default:t!==B.get("msg")&&B.set("msg",t)}n<=0&&o(),n-=1e3},1e3);if(t==="deleting"||t==="participantsleft")P.set("status","deleted"),P.upload().then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){var e=P.get("chat"),t=e.length,n=new p;return t?e.forEach(function(e){var r=new c;r.setTransport(h.get("transport")),r.sync(D,e).then(function(){return r.remove()}).then(function(){t--,t<=0&&n.fulfill})}):n.fulfill(),n}).then(function(){P.remove()});return s},b.createChat=function(t){var n=new c,r=(new Date).getTime(),i=[],s,o,u=new p;i.push({username:P.get("initiator").username,userid:P.get("initiator").id}),P.get("participants").forEach(function(e){i.push({username:e.username,userid:e.id})}),n.set("users",i);switch(t){case 1:s="quicksetup";break;case 2:s="quickscenario";break;case 3:s="quicktech";break;case 4:s="quickidea";break;case 5:s="quickwrapup";break;default:s="quickstart"}return n.set("msg",[{user:"SYS",type:5,arg:s,time:r}]),n.set("sid",P.get("_id")),n.set("lang",P.get("lang")),n.set("readonly",!1),n.set("step",t),n.set("type",17),o=n.get("sid")+"_"+t,n.setTransport(h.get("transport")),n.sync(D,o).then(function(){return n.upload()}).then(function(){var e=P.get("chat").concat();n.unsync(),e.push(o),P.set("chat",e),u.fulfill()}),u},b.retrieveSession=function(t,n){I.spin(document.getElementById("brainstorm")),P.reset({}),P.sync(D,t).then(function(){var e=P.get("step"),t=1e4,r=M.getNbItems();n||(j=new g(document.body,null,null,"musession-confirm"),F=function(e){e?P.get("initiator").id===_.get("_id")?b.cancelSession():b.leaveSession():j.hide()},P.get("initiator").id===_.get("_id")?j.reset(x.get("leaderleave"),F):j.reset(x.get("participantleave"),F)),M.loop(function(r,i){i<t&&(S.getStack().get(r.name).reset(n),M.update(i,"status","done"),r.name===e&&(t=i,M.update(i,"currentStep",!0),r.name==="muwrapup"?M.update(i,"status","done"):M.update(i,"status","ongoing")))}),n?(I.stop(),S.getStack().show("muwrapup")):(I.stop(),S.getStack().show(e))})},b.reset=function(t,n){P.unsync(),H.reset(),document.querySelector(".confirm")&&document.body.removeChild(document.querySelector(".confirm")),M.reset([{name:"mustart",label:x.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:x.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:x.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:x.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:x.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:x.get("quickstepwrapup"),currentStep:!1,status:null}]),t&&b.retrieveSession(t,n)},b.prev=function(t){var n;M.loop(function(e,r){e.name===t&&(n=r)}),n>0?(M.update(n,"currentStep",!1),M.update(n-1,"currentStep",!0),S.getStack().show(M.get(n-1).name)):(alert("Exiting session"),y())},b.next=function(t){var n,r=S.getStack().get(t),i,s="",o=new p;return M.loop(function(e,r){e.name===t&&(n=r)}),n<M.getNbItems()&&(s=M.get(n+1).name,i=S.getStack().get(s),M.update(n,"currentStep",!1),M.update(n+1,"currentStep",!0),M.get(n).status!=="done"?(M.update(n,"status","done"),M.update(n+1,"status","ongoing"),M.get(n+1).name==="muwrapup"&&M.update(n+1,"status","done"),i.reset(),b.createChat(n+1).then(function(){return P.set("step",s),P.upload()}).then(function(){i.initTimer&&i.initTimer(),r.stopSpinner(),S.getStack().show(s),s==="muwrapup"?(_.unsync(),_.sync(h.get("db"),_.get("_id")).then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){o.fulfill()})):o.fulfill()})):(r.stopSpinner(),S.getStack().show(s),o.fulfill())),o},b.init=function(){N=new s(P,b.prev,b.next,b.toggleProgress),C=new o(P,H,b.prev,b.next,b.toggleProgress),k=new u(P,H,b.prev,b.next,b.toggleProgress),L=new a(P,H,b.prev,b.next,b.toggleProgress),A=new f(P,H,b.prev,b.next,b.toggleProgress),O=new l(P,H,b.prev,b.next,b.toggleProgress),P.setTransport(h.get("transport")),S.getStack().add("mustart",N),S.getStack().add("musetup",C),S.getStack().add("muscenario",k),S.getStack().add("mutech",L),S.getStack().add("muidea",A),S.getStack().add("muwrapup",O)},b.init(),P.watchValue("status",function(e){e==="deleted"&&P.get("initiator").id!==_.get("_id")&&(_.set("sessionInProgress",""),_.upload(),b.displayInfo(x.get("canceledbyleader"),2e3).then(function(){P.unsync(),y()}))}),P.watchValue("step",function(e){var t,n=P.get("step");P.get("initiator")&&P.get("initiator").id!==_.get("_id")&&(M.loop(function(e,r){e.name===n&&(t=r)}),M.update(t-1,"status","done"),M.update(t,"status","ongoing"),M.update(t-1,"currentStep",!1),M.update(t,"currentStep",!0),S.getStack().get(e).reset(),S.getStack().show(e)),step==="muwrapup"&&(_.unsync(),_.sync(h.get("db"),_.get("_id")).then(function(){return _.set("sessionInProgress",""),_.upload()}))}),P.watchValue("participants",function(e){e.length===0&&P.get("step")!=="muwrapup"&&b.displayInfo("participantsleft",1e4).then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){y(),document.body.removeChild(document.querySelector(".confirm"))})}),b}}),define("brainstorm/multi/mub",["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","CouchDBDocument","CouchDBView","service/config","Promise","Store","./mubinit","./mubwait","./session/mucontroller","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(r,s){var u=new e,a=new t,p=o.get("user"),d,v,m,g=(new h({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return u.plugins.add("mustack",a),u.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>',u.place(document.getElementById("ideafy-multi")),u.reset=function(t){t?t.mode==="join"?u.join(t.id):u.replayMUSession(t.id):(v.reset(),a.getStack().show("mubinit"))},u.replayMUSession=function(t){m.reset(t,!0),a.getStack().show("musession")},u.join=function(t){var n=new i;n.setTransport(o.get("transport")),n.sync(o.get("db"),t).then(function(){var e=n.get("participants"),r=!1;e.forEach(function(e){e.id===p.get("_id")&&(r=!0)}),r?n.get("step")==="mustart"?(d.reset(t),a.getStack().show("mubwait")):u.startSession(t):(e.push({id:p.get("_id"),username:p.get("username"),intro:p.get("intro")}),n.set("participants",e),e.length===3&&n.set("status","full"),n.upload().then(function(){d.reset(t),a.getStack().show("mubwait")},function(e){console.log(e),alert("failed to join session")}))},function(e){console.log(e),alert("failed to join session")})},u.startSession=function(t){a.getStack().show("musession"),m.reset(t)},v=new f(s),d=new l(s,u.startSession),m=new c(s),a.getStack().add("mubinit",v),a.getStack().add("mubwait",d),a.getStack().add("musession",m),r?r.mode==="join"?(console.log("joining session",r),u.join(r.id)):u.replayMUSession(r.id):a.getStack().show("mubinit"),o.get("observer").watch("start-mu_session",function(e){d.reset(e),a.getStack().show("mubwait")}),u}}),define("brainstorm/brainstorm",["OObject","service/map","service/submenu","Amy/Stack-plugin","Bind.plugin","service/config","Store","service/utils","./ideafy-menu","./quickb/quickb","./multi/mub"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var c=new e,h,p=new o,d=new r,v=s.get("user");return c.plugins.addAll({brainstormstack:d,header:new i(p,{setDate:function(e){e&&(this.innerHTML=e.toLocaleDateString())},setTime:function(e){var t=e.getHours(),n=e.getMinutes(),r=e.getSeconds();t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r}})}),c.template='<div id="brainstorm"><div id="brainstorm-menu"></div><div class="brainstorm-header header blue-light"><div class="date" data-header="bind: setDate, date"></div><span class="headerTitle" data-header="bind: innerHTML, headertitle"></span><div class="clock" data-header="bind: setTime, date">hh:mm</div></div><div class="stack" data-brainstormstack="destination"></div></div>',c.place(t.get("brainstorm")),c.showMenu=function(){h.toggleActive(!0)},c.hideMenu=function(){h.toggleActive(!1)},c.exitSession=function(){d.getStack().show("menu")},c.reset=function(){d.getStack().get("menu").reset(),d.getStack().show("menu")},c.selectScreen=function(t,n){t==="continue"&&(t=n.type);if(t!=="tutorial"&&d.getStack().get(t))d.getStack().get(t).reset(n),d.getStack().show(t);else{n?t=n.type:n=null;switch(t){case"quick":d.getStack().add("quick",new f(n,c.exitSession));break;case"musession":d.getStack().add("musession",new l(n,c.exitSession));break;case"tutorial":s.get("observer").notify("display-tutorials");break;default:t=""}t&&d.getStack().show(t)}},h=new n(c.dom.querySelector("#brainstorm-menu")),h.toggleActive(!1),p.set("headertitle",s.get("labels").get("brainstormheadertitle")),setInterval(function(){var e=new Date;p.set("date",e)},1e3),d.getStack().add("menu",new a(c.selectScreen)),d.getStack().show("menu"),s.get("observer").watch("replay-session",function(e,t){var n={};n.id=e,e.toLowerCase().search("quick")>-1&&(n.type="quick"),e.toLowerCase().search("s:mu")>-1&&(n.type="musession"),c.selectScreen(n.type,n)}),s.get("observer").watch("join-musession",function(e){var t={type:"musession",id:e,mode:"join"};c.selectScreen(t.type,t)}),c}}),define("connect/contacts/addcontact",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","Store","service/avatar","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f){return function(){var c=new e,h=new s,p=new o({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),d=new o([]),v={},m=t.get("user"),g=t.get("transport"),y=t.get("labels"),b=(new f({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:-20,top:-36})).spin(),w=function(e,t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;e==="email"?n.test(t.toLowerCase())?(p.set("result",""),E("userid",t.toLowerCase())):p.set("result",y.get("signupinvalidemail")):p.get("email")?p.set("result",y.get("clearemailfirst")):p.get("firstname")&&p.get("lastname")?(p.set("result",""),E("username",p.get("firstname").toLowerCase()+" "+p.get("lastname").toLowerCase())):p.set("result",y.get("needbothfnln"))},E=function(e,n){var r=new s;r.setTransport(g),e==="userid"?r.sync(t.get("db"),"users","_view/searchbyid",{key:'"'+n+'"',descending:!0}).then(function(){d.reset(JSON.parse(r.toJSON())),d.getNbItems()?p.set("display",!0):p.set("invite",!0),r.unsync()}):r.sync(t.get("db"),"users","_view/searchbyusername",{key:'"'+n+'"',descending:!0}).then(function(){d.reset(JSON.parse(r.toJSON())),d.getNbItems()?p.set("display",!0):p.set("result",y.get("noentryfound")),r.unsync()})},S=function(e){var t=!1,n=m.get("sentMessages")||[],r=m.get("connections"),i=!1,s=!1,o,u,a,f;if(e.userid===m.get("_id"))p.set("result",y.get("cannotaddself"));else{for(u=0,a=r.length;u<a;u++)if(r[u].userid===e.userid){s=!0;break}if(s)p.set("result",e.username+y.get("alreadyconnected"));else{for(o=0,f=n.length;o<f;o++)if(n[o].type==="CXR"&&n[o].toList.search(e.username)>-1){i=!0;break}i?p.set("result",y.get("alreadysentCXR")+e.username):t=!0}}return t},x=function(e){var t=new Date,n={};S(e)&&(n.dest=[e.userid],n.type="CXR",n.status="unread",n.date=[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],n.author=m.get("_id"),n.username=m.get("username"),n.firstname=m.get("firstname"),n.toList=e.username,n.ccList="",n.object=m.get("username")+y.get("CXRobject"),n.body=p.get("message"),n.signature=m.get("signature"),n.contactInfo={firstname:m.get("firstname"),lastname:m.get("lastname"),userid:m.get("_id"),username:m.get("username"),intro:m.get("intro"),type:"user"},g.request("Notify",n,function(e){var t=JSON.parse(e);t[0].res==="ok"?(p.set("result",y.get("CXRsent")),setTimeout(function(){c.reset()},2e3)):model.set("result","There was an error, please try again later")}))};return c.plugins.addAll({label:new n(y),count:new n(h),search:new n(p,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")}}),contacts:new n(d,{setAvatar:function(t){var n,r;_frag=document.createDocumentFragment(),_ui=new u([t]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),searchdbevent:new r(c),invitecontactevent:new r(c)}),c.template='<div id="addcontact"><div class="header blue-dark"><span class="newcontactlbl" data-label="bind:innerHTML, newcontactlbl"></span></div><div class = "detail-contents"><div class="doctor-deedee"></div><div class="addcontactform"><p class="half"><span data-label="bind:innerHTML, beforecount"></span><strong><span data-count="bind:innerHTML, 0.value"></span></strong><span data-label="bind:innerHTML, aftercount"></span></p><p class="half" data-label="bind: innerHTML, addcontactrightintro"></p><legend data-label="bind:innerHTML, addcontactnow"></legend><input class="search" type="text" name="email" data-label="bind:placeholder, searchcontactplaceholder" data-search="bind: value, email" data-searchdbevent="listen: keypress, searchDB"><legend data-label="bind:innerHTML, lookup"></legend><div class="searchcontact"><input type="text" class="search half" name="fn" data-label="bind:placeholder, firstnameplaceholder" data-search="bind: value, firstname" data-searchdbevent="listen: keypress, searchDB"><input class="search half right" type="text" name="ln" data-label="bind: placeholder, lastnameplaceholder" data-search="bind: value, lastname" data-searchdbevent="listen: keypress, searchDB"></div><p class="searchresult" data-search="bind: innerHTML, result; bind:setStyle, sentok"></p></div><div class="contactinvite" data-search="bind: setVisible, invite"><p>The person you are looking for was not found in Ideafy. Would you like to send him/her an invitation ? You will receive 200 Ideafy Points if the person joins the community</p><div><span class="sendmail" data-label="bind:innerHTML, sendlbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, sendInvite">Accept</span><span class="cancelmail" data-label="bind:innerHTML, cancellbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, cancelInvite">Cancel</span></div></div><div class = "contactlist invisible" data-search="bind: setVisible, display"><legend data-label="bind:innerHTML, selectcontact"></legend><ul data-contacts="foreach"><li class = "contact list-item"><div data-contacts="bind:setAvatar, value.userid"></div><p class="contact-name" data-contacts="bind:innerHTML, value.username"></p><p class="contact-intro" data-contacts="bind:innerHTML, value.intro"></p><div class="select-contact" data-searchdbevent="listen:mousedown, check"></div></li></ul><textarea class="input" data-label="bind:placeholder, addamessage" data-search="bind:value, message"></textarea><div class="addcontactbtns"><div class="addct" data-searchdbevent="listen:mousedown, push; listen:mouseup, add"></div><div class="cancelct" data-searchdbevent="listen:mousedown, push; listen:mouseup, cancel"></div></div></div></div></div>',c.init=function(){var n=new a;return h.setTransport(g),h.sync(t.get("db"),"users","_view/count").then(function(){n.fulfill()}),n},c.searchDB=function(e,t){var n;e.keyCode===13&&(e.target.blur(),n=t.getAttribute("name"),w(n,t.value))},c.check=function(e,t){var n=t.getAttribute("data-contacts_id");t.innerHTML?(t.innerHTML="",v[n]=!1):(t.innerHTML="&#10003;",v[n]=!0)},c.reset=function(){p.reset({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),d.reset([])},c.push=function(e,t){t.classList.add("pushed")},c.cancel=function(e,t){t.classList.remove("pushed"),c.reset()},c.press=function(e,t){t.classList.add("pressed")},c.cancelInvite=function(e,t){t.classList.remove("pressed"),c.reset()},c.sendInvite=function(e,t){var n={id:p.get("email").toLowerCase(),senderid:m.get("_id"),sendername:m.get("username"),subject:m.get("username")+y.get("invitesyou"),body:y.get("invitebody")};b.spin(t),g.request("Invite",n,function(e){e==="ok"&&alert(y.get("invitationsent")),e==="alreadyinvited"&&alert(y.get("alreadyinvited")),b.stop(),t.classList.remove("pressed"),c.reset()})},c.add=function(e,t){t.classList.remove("pushed");for(i in Object.keys(v))x(d.get(i).value)},ADDCTSPIN=b,c}}),define("connect/contacts/addgroup",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,n,r,s,o){return function(){var a=new e,f=new s({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),c=new s([{color:"#4D4D4D",icon:"graygroup.png",selected:!0},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}]),h=new s([]),p=new s([]),d=new s({error:""}),v={},m=t.get("user"),g=t.get("labels");return a.plugins.addAll({label:new n(g),error:new n(d),color:new n(c,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new n(f,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),contacts:new n(h,{setAvatar:function(t){var n,r;_frag=document.createDocumentFragment(),_ui=new o([t]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new n(p,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),addgrpevent:new r(a)}),a.template='<div id="addgroup"><div class="header blue-dark"><span class="newfolderlbl" data-label="bind:innerHTML, newfolderlbl"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-addgrpevent="listen: mousedown, selectColor"></li></ul></form><div class = "groupcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-contacts="foreach"><li class = "contact list-item" data-addgrpevent="listen:mousedown, discardContact"><div data-contacts="bind:setAvatar, userid"></div><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><div class="addgroupbtns"><span class="errormsg" data-error="bind:innerHTML, error"></span><div class="addct" data-addgrpevent="listen:mousedown, press; listen:mouseup, add"></div><div class="cancelct" data-addgrpevent="listen:mousedown, press; listen:mouseup, cancel"></div></div><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-addgrpevent="listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-addgrpevent="listen:mouseup, select"></li></ul></div></div></div></div>',a.init=function(){m.get("connections").forEach(function(e){e.type==="user"&&p.alter("push",{contact:e,selected:!1})})},a.selectColor=function(e,t){var n=t.getAttribute("data-color_id");c.loop(function(e,t){c.update(t,"selected",!1)}),c.update(n,"selected",!0),f.set("color",c.get(n).icon)},a.toggleHide=function(e,t){var n=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},a.select=function(e,t){var n=t.getAttribute("data-auto_id");p.get(n).selected?(a.removeContact(n),setTimeout(function(){p.update(n,"selected",!1)},200)):(a.addContact(n),setTimeout(function(){p.update(n,"selected",!0)},200))},a.addContact=function(t){var n=JSON.parse(h.toJSON()),r=p.get(t).contact,s=0;if(h.toJSON().search(r.userid)<0){for(i=0,l=n.length;i<l;i++)r.lastname>n[i].lastname?s++:r.lastname===n[i].lastname&&r.username>n[i].username&&s++;n.splice(s,0,r),h.reset(n),f.set("contacts",n)}},a.removeContact=function(t){var n=JSON.parse(h.toJSON());for(i=n.length-1;i>=0;i--)n[i].userid===p.get(t).contact.userid&&n.splice(i,1);h.reset(n)},a.updateAutoContact=function(e,t){var n=JSON.parse(p.toJSON()),r=m.get("connections"),s,o=t.value.toLowerCase();if(t.value===""){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1})}else if(e.keyCode===8||e.keyCode===46){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1});for(i=n.length-1;i>=0;i--)n[i].contact.username.toLowerCase().search(o)!==0&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)s=n[i].contact.username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);p.reset(n),p.loop(function(e,t){h.toJSON().search(e.contact.userid)>-1&&p.update(t,"selected",!0)})},a.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=h.get(n).userid;h.alter("splice",n,1),p.loop(function(e,t){e.contact.userid===r&&setTimeout(function(){p.update(t,"selected",!1)},200)})},a.reset=function(){f.reset({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),h.reset([]),p.reset([]),d.reset({error:""}),m.get("connections").forEach(function(e){e.type==="user"&&p.alter("push",{contact:e,selected:!1})})},a.press=function(e,t){t.classList.add("pushed")},a.cancel=function(e,t){t.classList.remove("pushed"),a.reset(),document.querySelector("#addgroup input.search").value=""},a.add=function(e,t){var n=m.get("connections"),r=0,s=JSON.parse(f.toJSON());t.classList.remove("pushed"),d.set("error","");if(s.username==="")d.set("error",g.get("nogrpname"));else if(s.intro==="")d.set("error",g.get("nogrpintro"));else if(!s.contacts.length)d.set("error",g.get("nocontactselected"));else{for(i=0,l=n.length;i<l;i++)n[i].type==="user"?s.username>n[i].lastname&&r++:(s.username===n[i].username&&d.set("error",g.get("grpnameexists")),s.username>n[i].username&&r++);d.get("error")||(n.splice(r,0,s),m.set("connections",n),m.upload().then(function(){a.reset()}))}},a}}),define("connect/contacts/contact-detail",["OObject","service/config","service/map","Store","Bind.plugin","Event.plugin","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(){var l=new e,c=new r,h=new r,p=new r([]),d=new r([]),v=t.get("labels"),m=t.get("user"),g=t.get("transport");return l.plugins.addAll({label:new s(v),basicinfo:new s(h,{setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),ctdetails:new s(c),grades:new s(p,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new s(d,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),ctdetailsevent:new o(l)}),l.template='<div id = "contactdetails"><div class="header blue-dark"><span class="subjectlbl" data-details="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class = "contactessentials"><div class="avatar" data-basicinfo="bind:setAvatar, userid"></div><div class="basicinfo"><h2 data-basicinfo="bind:innerHTML,username"></h2><p data-basicinfo="bind:innerHTML, intro"></p></div><div class="contactdashboard"><div class="contactstats"><legend data-label="bind:innerHTML, stats"></legend><div class="userscore"><span class="ip" data-ctdetails="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-ctdetails="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-ctdetails="bind: innerHTML, sessions"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-ctdetails="bind: innerHTML, contacts"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-ctdetails="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="contactbadges"><legend data-label="bind:innerHTML, achievements"></legend><p class="grade" data-stats="bind:innerHTML, title"></p><ul class="badges" data-grades="foreach"><li class="contactbadge"><div data-grades="bind:showBadge, badge"></div><label data-grades="bind:innerHTML, title"></label></li></ul><ul class="badges" data-achievements="foreach"><li class="contactbadge"><div data-achievements="bind:showBadge, badge"></div><label data-achievements="bind:innerHTML, label"></label></li></ul></div></div></div></div><div class = "contactnotes"><legend data-label="bind: innerHTML, mynotes"></legend><div id = "cancelnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push; listen:mouseup, cancelNotes"></div><div id = "uploadnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push;listen:mouseup, uploadNotes"></div><textarea id="ctnotes" class = "input" data-label="bind:placeholder,writesomething" data-basicinfo="bind: value, notes" data-ctdetailsevent="listen:input, displayNoteBtns"></textarea></div></div></div>',l.place(n.get("contactdetails")),l.updateContact=function(t){var n=m.get("connections"),r,i=n.length,s,o;for(r=0;r<i;r++){n[r].userid===t._id&&(n[r].username=t.username,n[r].firstname=t.firstname,n[r].lastname=t.lastname,n[r].intro=t.intro);if(n[r].type==="group"){s=n[r].contacts;for(o=0;o<s.length;o++)s[o].userid===t._id&&(s[o].username=t.username,s[o].firstname=t.firstname,s[o].lastname=t.lastname,s[o].intro=t.intro);n[r].contacts=s}}m.set("connections",n),m.upload()},l.getUserInfo=function(t){a.getUserDetails(t,function(e){(e.username!==h.get("username")||e.firstname!==h.get("firstname")||e.lastname!==h.get("lastname")||e.intro!==h.get("intro"))&&l.updateContact(e),c.reset(e),c.set("sessions",c.get("su_sessions_count")+c.get("mu_sessions_count")),a.getGrade(e.ip,function(e){p.alter("push",e.grade),e.distinction&&p.alter("push",e.distinction)}),d.reset(e.achievements)})},l.reset=function(t){h.reset(t),p.reset([]),d.reset([]),h.get("notes")||h.set("notes",""),l.getUserInfo(t.userid)},l.displayNoteBtns=function(e,t){document.getElementById("uploadnotes").classList.remove("invisible"),document.getElementById("cancelnotes").classList.remove("invisible")},l.hideNoteBtns=function(t,n){document.getElementById("uploadnotes").classList.add("invisible"),document.getElementById("cancelnotes").classList.add("invisible")},l.push=function(e,t){t.classList.add("pushed")},l.uploadNotes=function(e,t){var n=m.get("connections"),r,i=n.length,s,o,u=document.getElementById("uploadnotes"),a=document.getElementById("cancelnotes");for(r=0;r<i;r++){n[r].userid===h.get("userid")&&(n[r].notes=h.get("notes"));if(n[r].type==="group"){s=n[r].contacts;for(o=0;o<s.length;o++)s[o].userid===h.get("userid")&&(s[o].notes=h.get("notes"));n[r].contacts=s}}m.set("connections",n),m.upload().then(function(){t.classList.remove("pushed"),l.hideNoteBtns()})},l.cancelNotes=function(e,t){var n=m.get("connections"),r=n.length;i;for(i=0;i<r;i++)n[i].userid===h.get("userid")&&h.set("notes",n[i].notes);t.classList.add("pushed"),l.hideNoteBtns()},l}}),define("connect/contacts/group-detail",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,n,r,s,o){return function(){var a=new e,f=new s,c=new s([]),h,p=[{color:"#4D4D4D",icon:"graygroup.png",selected:!1},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}],d=new s(p),v=new s([]),m=new s({error:""}),g={},y=t.get("user"),b=t.get("labels");return a.template='<div id="groupdetails"><div class="header blue-dark"><span class="newfolderlbl" data-group="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-grpdetailsevent="listen: mousedown, selectColor"></li></ul></form><div class = "grpcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-grpcontacts="foreach"><li class = "contact list-item" data-grpdetailsevent="listen:mousedown, discardContact"><div data-grpcontacts="bind:setAvatar, userid"></div><p class="contact-name" data-grpcontacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-grpcontacts="bind:innerHTML, intro"></p></li></ul></div><p class="update"><label class="cancelmail" data-label="bind:innerHTML, cancellbl" data-grpdetailsevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-label="bind:innerHTML, updatelbl" data-grpdetailsevent="listen:mousedown, press; listen:mouseup, updateGroup"></label><label class="editerror" data-error="bind:innerHTML, error"></label><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-grpdetailsevent="listen:keyup, updateAutoContact" data-label="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-grpdetailsevent="listen:mouseup, select"></li></ul></div></div></div></div>',a.plugins.addAll({label:new n(b),error:new n(m),color:new n(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new n(f,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),grpcontacts:new n(c,{setAvatar:function(t){var n,r;t&&(_frag=document.createDocumentFragment(),_ui=new o([t]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag))},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new n(v,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),grpdetailsevent:new r(a)}),a.selectColor=function(e,t){var n=t.getAttribute("data-color_id");d.loop(function(e,t){d.update(t,"selected",!1)}),d.update(n,"selected",!0),f.set("color",d.get(n).icon)},a.toggleHide=function(e,t){var n=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},a.select=function(e,t){var n=t.getAttribute("data-auto_id");v.get(n).selected?(a.removeContact(n),setTimeout(function(){v.update(n,"selected",!1)},200)):(a.addContact(n),setTimeout(function(){v.update(n,"selected",!0)},200))},a.addContact=function(t){var n=JSON.parse(c.toJSON()),r=v.get(t).contact,s=0;if(c.toJSON().search(r.userid)<0){for(i=0,l=n.length;i<l;i++)r.lastname>n[i].lastname?s++:r.lastname===n[i].lastname&&r.username>n[i].username&&s++;n.splice(s,0,r),c.reset(n),f.set("contacts",n)}},a.removeContact=function(t){var n=JSON.parse(c.toJSON());for(i=n.length-1;i>=0;i--)n[i].userid===v.get(t).contact.userid&&n.splice(i,1);c.reset(n),f.set("contacts",n)},a.updateAutoContact=function(e,t){var n=JSON.parse(v.toJSON()),r=y.get("connections");if(t.value===""){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1})}else if(e.keyCode===8||e.keyCode===46){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1});for(i=n.length-1;i>=0;i--)n[i].contact.username.search(t.value)!==0&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)n[i].contact.username.search(t.value)!==0&&n.splice(i,1);v.reset(n),v.loop(function(e,t){c.toJSON().search(e.contact.userid)>-1&&v.update(t,"selected",!0)})},a.discardContact=function(e,t){var n=t.getAttribute("data-grpcontacts_id"),r=c.get(n).userid;c.alter("splice",n,1),v.loop(function(e,t){e.contact.userid===r&&setTimeout(function(){v.update(t,"selected",!1)},200)}),f.set("contacts",JSON.parse(c.toJSON()))},a.press=function(e,t){t.classList.add("pressed")},a.cancel=function(e,t){t.classList.remove("pressed"),a.reset(h),document.querySelector("#groupdetails input.search").value=""},a.updateGroup=function(e,t){var n=y.get("connections"),r,i=JSON.parse(f.toJSON());t.classList.remove("pressed"),m.set("error","");if(i.username==="")m.set("error",b.get("nogrpname"));else if(i.intro==="")m.set("error",b.get("nogrpintro"));else if(!i.contacts.length)m.set("error",b.get("nocontactselected"));else for(r=n.length-1;r>=0;r--)n[r].type==="group"&&n[r].username===h.username&&(m.get("error")||(n.splice(r,1,i),y.set("connections",n),y.upload().then(function(){a.reset(i),m.set("error",b.get("groupupdated"))})))},a.reset=function(t){d.reset(p),d.loop(function(e,n){e.icon===t.color?d.update(n,"selected",!0):d.update(n,"selected",!1)}),f.reset(t),h=t,c.reset(t.contacts),v.reset([]),m.reset({error:""}),y.get("connections").forEach(function(e){e.type==="user"&&v.alter("push",{contact:e,selected:!1})}),v.loop(function(e,t){c.toJSON().search(e.contact.userid)>-1&&v.update(t,"selected",!0)})},a.init=function(){y.get("connections").forEach(function(e){e.type==="user"&&v.alter("push",{contact:e,selected:!1})})},a}}),define("connect/contacts/contacts",["OObject","service/map","service/config","Amy/Stack-plugin","Bind.plugin","Event.plugin","Amy/Control-plugin","Store","service/avatar","service/actionbar","./addcontact","./addgroup","./contact-detail","./group-detail"],function(e,t,n,r,s,o,u,a,f,c,h,p,d,v){return function(){var g=new e,y=new r,b=new h,w=new p,E=new d,S=new v,x=new a([{name:"all",label:"allbtn",selected:!0},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),T=0,N=new a([]),C=null,k=n.get("user"),L=n.get("labels"),A=function(e){var t=x.get(e).name,n=k.get("connections"),r=n.length,s=[];switch(t){case"users":for(i=0;i<r;i++)n[i].type==="user"&&s.push(n[i]);break;case"groups":for(i=0;i<r;i++)n[i].type==="group"&&s.push(n[i]);break;default:s=n}return s},O=function(e){var t=[],n=[];t=k.get("connections").concat();if(e==="")n=t,x.update(0,"selected",!0),T=0;else for(i=0,l=t.length;i<l;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&n.push(t[i]);return n};return g.plugins.addAll({label:new s(L),sort:new s(x,{setLabel:function(e){this.innerHTML=L.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),contact:new s(N,{setAvatar:function(t){var n=this.getAttribute("data-contact_id"),r,i;t==="group"?(this.hasChildNodes()&&this.removeChild(this.firstChild),this.setAttribute("style","background: url('img/connect/"+N.get(n).color+"') no-repeat center center; background-size: contain;display:block; width:40px; height:40px;float:left;")):t==="user"&&(this.setAttribute("style","background:none;"),r=document.createDocumentFragment(),i=new f([N.get(n).userid]),i.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),contactdetailstack:y,contactlistcontrol:new u(g),contactlistevent:new o(g)}),g.template='<div id="connect-contacts"><div class="contacts"><div class="header blue-light"><span data-label="bind: innerHTML, contactlistheadertitle">My Contacts</span><div class="option right" data-contactlistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-contactlistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-contactlistevent="listen: keypress, search"><div class="contactlist overflow" data-contactlistcontrol="radio:li,selected,mousedown,selectContact"><ul data-contact="foreach"><li class="contact list-item" data-contactlistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-contact="bind:setAvatar, type"></div><p class="contact-name" data-contact="bind:innerHTML, username"></p><p class="contact-intro" data-contact="bind:setIntro, intro"></p><div class="select-contact"></div></li></ul></div></div><div id="toggleadd" class="group" data-contactlistevent="listen:mousedown, press; listen:mouseup, toggleAddUI"></div><div id="contact-detail" class="details" data-contactdetailstack="destination"></div></div>',g.place(t.get("connect-contacts")),g.plus=function(t,n){var r=document.getElementById("toggleadd");y.getStack().get("#addcontact").reset(),y.getStack().show("#addcontact"),r.classList.contains("user")&&r.classList.remove("user"),r.classList.add("group")},g.init=function(){N.reset(k.get("connections")),b.init().then(function(){y.getStack().show("#addcontact")}),w.init(),S.init()},g.reset=function(){N.reset(k.get("connections")),b.reset(),y.getStack().show("#addcontact")},g.getSelectedContact=function(){var e=document.querySelector(".contact.selected"),t=-1;return e&&(t=e.getAttribute("data-contact_id")),t},g.selectContact=function(e){var t=e.target.getAttribute("data-contact_id"),n=N.get(t);document.getElementById("toggleadd").classList.remove("group"),document.getElementById("toggleadd").classList.remove("user"),n.type==="user"?(E.reset(N.get(t)),y.getStack().getCurrentName()!=="#contactdetails"&&y.getStack().show("#contactdetails")):(S.reset(N.get(t)),y.getStack().getCurrentName()!=="#groupdetails"&&y.getStack().show("#groupdetails"))},g.displaySort=function(e,t){var n=t.getAttribute("data-sort_id");N.reset([]),T>-1&&x.update(T,"selected",!1),x.update(n,"selected",!0),T=n,N.reset(A(n))},g.search=function(e,t){e.keyCode===13&&(x.update(T,"selected",!1),T=-1,N.reset(O(t.value)))},g.setStart=function(e,t){C&&C.hide()},g.showActionBar=function(e,t){var n=t.getAttribute("data-contact_id"),r=!1,i;C&&C.getParent()===t&&(r=!0),r||(C=new c("contact",t,N.get(n)),i=document.createDocumentFragment(),C.place(i),t.appendChild(i),r=!0)},g.press=function(e,t){t.classList.add("pressed")},g.toggleAddUI=function(e,t){t.classList.remove("pressed"),t.classList.contains("group")?(t.classList.remove("group"),y.getStack().get("#addgroup").reset(),y.getStack().show("#addgroup"),t.classList.add("user")):(t.classList.remove("user"),y.getStack().get("#addcontact").reset(),y.getStack().show("#addcontact"),t.classList.add("group"))},y.getStack().add("#contactdetails",E),y.getStack().add("#groupdetails",S),y.getStack().add("#addcontact",b),y.getStack().add("#addgroup",w),w.init(),g.init(),k.watchValue("connections",function(){var e;T>-1&&N.reset(A(T)),y.getStack().getCurrentName()==="#contactdetails"&&(e=g.getSelectedContact(),e>-1?(contactDetail.reset(N.get(e)),y.getStack().show("#contactdetails")):(y.getStack().show("#addcontact"),document.getElementById("toggleadd").classList.add("group")))}),n.get("observer").watch("contact-deleted",function(){y.getStack().show("#addcontact")}),k.watchValue("lang",function(){var e;x.loop(function(t,n){t.selected&&(e=n)}),x.reset([{name:"all",label:"allbtn",selected:!1},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),x.update(e,"selected",!0)}),g}}),define("connect/messages/message-reply",["OObject","Store","Bind.plugin","Event.plugin","service/config","service/utils","Promise","service/autocontact"],function(e,t,n,r,s,o,u,a){return function(){var c=new e,h=new t,p,d={},v=new t({errormsg:""}),m=s.get("labels"),g=s.get("user"),y=s.get("transport"),b=!1,w=function(e){var t=/<(.|\n)*?>/g;return e.replace(t,"")},E=function(e){var t=h.get("toList").toLowerCase().split(/,|;/),n=h.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(g.get("connections")).toLowerCase(),s=[],o={},a=new u;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1||p.toList.search(t[i].trim())>-1||p.ccList.search(t[i].trim())>-1)){v.set("errormsg",m.get("tolbl")+" : "+t[i].trim()+m.get("notavalidcontact")),b=!1,a.reject();break}s.push(t[i].trim())}if(!v.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1||p.toList.search(n[i].trim())>-1||p.ccList.search(n[i].trim())>-1)){v.set("errormsg",m.get("tolbl")+" : "+n[i].trim()+m.get("notavalidcontact")),b=!1,a.reject();break}s.push(n[i].trim())}return v.get("errormsg")||(o.list=s,y.request("CheckRecipientList",o,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.fulfill()}else v.set("errormsg",t.error),a.reject()})),a};return c.plugins.addAll({labels:new n(m),errormsg:new n(v),reply:new n(h,{setAvatar:function(e){this.setAttribute("style","background: url('"+s.get("avatar")+"') no-repeat center center;background-size:cover;")},setCC:function(e){switch(e){case"replyall":break;case"forward":break;default:this.innerHTML=h.get("message").username}},setSubject:function(e){switch(e){case"replyall":break;case"forward":break;default:this.innerHTML="  Re : "+h.get("message").object}}}),replyevent:new r(c)}),c.template='<div><div class="avatar" data-reply="bind: setAvatar, message.author"></div><form class="form"><p><textarea name="toList" class="mail-header" data-labels="bind:placeholder, tocontactlbl" data-reply="bind: value, toList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea name="ccList" class="mail-header" data-labels="bind:placeholder, cclbl" data-reply="bind: value, ccList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><span class="subject" data-labels="bind:innerHTML, subjectlbl"></span><span data-reply="bind:innerHTML, object"></span></p><p><textarea class="input" data-reply="bind:value, body"></textarea></p><blockquote class="original" data-reply="bind:innerHTML, original"></blockquote><p><legend>Signature</legend><textarea class="signature" data-reply="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-replyevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-replyevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div>',c.reset=function(t,n){p=t,h.reset({signature:"",original:"",author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:"",ccList:"",object:"",body:""}),h.set("type",n),g.get("signature")?h.set("signature",g.get("signature")):h.set("signature",g.get("username")),h.set("original",m.get("on")+o.formatDate(t.date)+"</p><p>"+t.username+m.get("ideawrotelbl")+"</p><p>"+m.get("subjectlbl")+t.object+"</p><hr><p>"+t.body+"</p>");switch(n){case"replyall":t.ccList?h.set("toList",t.username.concat(", "+t.ccList)):h.set("toList",t.username),t.object.search("Re :")!==0?h.set("object","Re : "+t.object):h.set("object",t.object);break;case"forward":h.set("toList",""),t.object.search("Fwd :")!==0?h.set("object","Fwd : "+t.object):h.set("object",t.object);break;default:h.set("toList",t.username),t.object.search("Re :")!==0?h.set("object","Re : "+t.object):h.set("object",t.object)}h.set("message",t),c.place(document.getElementById("msgreply"))},c.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){h.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new a(r,t,s),d.name=i,r.classList.remove("invisible")},c.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?d.name.init():d.name.updateList()},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),b=!1,document.getElementById("msgreply").classList.add("invisible")},c.send=function(e,t){var n=new Date,r={};t.classList.remove("pressed"),b||(b=!0,v.set("errormsg",""),r=JSON.parse(h.toJSON()),r.type="MSG",r.body=r.body.concat("<br><br>"+r.original),r.dest=[],E(function(e){r.dest=e}).then(function(){v.get("errormsg")?(console.log(result),b=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],y.request("Notify",r,function(e){b=!1,v.set("errormsg",m.get("messagesentok")),setTimeout(function(){v.set("errormsg",""),b=!1,document.getElementById("msgreply").classList.add("invisible")},2e3)}))}))},c}}),define("connect/messages/message-detail",["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/avatar","service/utils","./message-reply"],function(e,t,n,r,s,o,u,a,f){return function(h){var p=new e,d=new f,v=new n,m=new n({response:""}),g=t.get("labels"),y=t.get("user"),b=t.get("observer"),w=t.get("transport");return p.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class="msgdetailarea"><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="more" class="more" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><p data-message="bind:setSignature, type"></p><p class="invisible" data-message="bind:setJoinMsg, sessionStatus"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:mousedown, press; listen:mouseup, showDoc"></div><div class="gotosession invisible" data-message="bind: showSessionBtn, sessionStatus" data-messageevent="listen:mousedown, press; listen:mouseup, gotoSession"></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: mousedown, press; listen: mouseup, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:mousedown, press; listen:mouseup, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:mousedown, press; listen:mouseup, rejectCXR"></div></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div></div>',p.plugins.addAll({label:new s(g),message:new s(v,{date:function E(E){var e=new Date,t=E[3],n=E[4],r=E[5];E&&E[0]===e.getFullYear()&&E[1]===e.getMonth()&&E[2]===e.getDate()?(t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r):this.innerHTML=a.formatDate(E)+"  "+t+":"+n},setObject:function(e){switch(e){case"CXR":this.innerHTML=v.get("username")+g.get("CXRobject");break;case"INV":this.innerHTML=v.get("username")+g.get("INVObject");break;case"CXRaccept":this.innerHTML=v.get("username")+g.get("acceptedCXR");break;case"CXRreject":this.innerHTML=v.get("username")+g.get("rejectedCXR");break;case"CXCancel":this.innerHTML=v.get("username")+g.get("canceledCX");break;case"DOC":this.innerHTML=v.get("username")+g.get("sentdocmsg");break;case"2Q+":this.innerHTML=v.get("username")+g.get("askednew");break;case"2C+":this.innerHTML=v.get("username")+g.get("senttc");break;case"REF":this.innerHTML=messages.get(id).username+g.get("joinedideafy");break;default:this.innerHTML=v.get("object")}},setBody:function(e){switch(e){case"CXRaccept":this.innerHTML=g.get("youlbl")+g.get("nowconnected")+v.get("username");break;case"DOC":this.innerHTML="<p>"+v.get("body")+"</p><p>"+v.get("username")+"</p><p>"+v.get("signature")+"</p><br><br><p>"+g.get("clicktoview")+" : <b>"+v.get("docTitle")+"</b></p>";break;case"INV":this.innerHTML=v.get("username")+g.get("INVObject")+" : <b>"+v.get("docTitle")+"</b>";break;case"REF":this.innerHTML=g.get("referral");break;default:this.innerHTML=v.get("body").replace(/\n/g,"<br>")}},setSignature:function(e){e==="MSG"?(this.classList.remove("invisible"),this.innerHTML=v.get("signature")):this.classList.add("invisible")},showOptions:function(e){e.search("CX")>-1||e==="2Q+"||e==="INV"?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(e){e?this.innerHTML=e:this.innerHTML=g.get("melbl")},showCcList:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(e){e==="CXR"?this.classList.remove("invisible"):this.classList.add("invisible")},showDocBtn:function(e){e==="DOC"?this.classList.remove("invisible"):this.classList.add("invisible")},showSessionBtn:function(e){console.log(e),e&&e==="waiting"&&!v.get("joined")?this.classList.remove("invisible"):this.classList.add("invisible")},setJoinMsg:function(e){e?(this.classList.remove("invisible"),e==="unavailable"?this.innerHTML=g.get("nolongerjoin"):e==="joined"?this.innerHTML=g.get("joinedsession"):e==="waiting"&&(this.innerHTML=g.get("clicktojoin"))):this.classList.add("invisible")},showTwoQ:function(e){e==="2Q+"||e==="2C+"?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u([t]);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)}}),cxr:new s(m,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(e){e==="YES"?this.innerHTML=g.get("CXRaccepted")+v.get("username")+g.get("isnowacontact"):this.innerHTML=g.get("CXRrejected")}}),messageevent:new o(p)}),p.showDoc=function(t,n){n.classList.remove("pushed"),v.get("type")==="DOC"&&b.notify("display-doc",v.get("docId"),v.get("docType"))},p.showTwoQ=function(t,n){n.classList.remove("pushed"),v.get("type")==="2Q+"&&b.notify("display-twoq",v.get("docId"),v.get("author")),v.get("type")==="2C+"&&b.notify("display-twoc")},p.press=function(e,t){t.classList.add("pushed")},p.action=function(e,t){var n=t.getAttribute("name"),r=document.getElementById("msgreply"),i=document.querySelector(".msgoptionlist");switch(n){case"more":i.classList.remove("invisible");break;case"reply":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"reply"),r.classList.remove("invisible");break;case"replyall":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"replyall"),r.classList.remove("invisible");break;case"forward":i.classList.add("invisible"),d.reset(JSON.parse(v.toJSON()),"forward"),r.classList.remove("invisible");break;case"deletemsg":i.classList.add("invisible"),p.deletemsg(v.toJSON()),h("#defaultPage");break;default:}t.classList.remove("pushed")},p.deletemsg=function(t){var n=y.get("notifications").concat(),r;for(i=0,l=n.length;i<l;i++)if(JSON.stringify(n[i])===t){r=i;break}n.splice(r,1),y.set("notifications",n),y.upload()},p.acceptCXR=function(e,t){var n=y.get("connections"),r=y.get("news")||[],s=0,o=new Date,u=[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];t.classList.remove("pushed");for(i=0,l=n.length;i<l;i++)n[i].type==="user"?(n[i].lastname<v.get("contactInfo").lastname&&s++,n[i].lastname===v.get("contactInfo").lastname&&n[i].firstname<v.get("contactInfo").firstname&&s++):n[i].username<v.get("contactInfo").lastname&&s++;n.splice(s,0,v.get("contactInfo")),y.set("connections",n),r.unshift({type:"CX+",date:u,content:{userid:v.get("author"),username:v.get("username")}}),y.set("news",r),y.upload().then(function(){var e={dest:[v.get("author")],date:u,original:"",type:"CXRaccept",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:v.get("username"),ccList:"",object:y.get("username")+g.get("acceptedCXR"),body:g.get("youlbl")+g.get("nowconnected")+y.get("username"),signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};m.set("response","YES"),w.request("Notify",e,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){p.deletemsg(v.toJSON()),h("#defaultPage")},1e3)})})},p.rejectCXR=function(e,t){var n,r=new Date;t.classList.remove("pushed"),m.set("response","NO"),n={dest:[v.get("author")],original:"",date:[r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds()],type:"CXRreject",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:v.get("username"),ccList:"",object:y.get("username")+g.get("rejectedCXR"),body:"",signature:""},w.request("Notify",n,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){p.deletemsg(v.toJSON()),h("#defaultPage")},1500)})},p.checkSessionStatus=function(n){var i=new r;i.setTransport(w),i.sync(t.get("db"),n).then(function(){console.log(i.get("status")),i.get("status")==="waiting"?v.set("sessionStatus","waiting"):v.set("sessionStatus","unavailable"),i.unsync()},function(e){alert(e)})},p.gotoSession=function(e,n){var r=y.get("notifications");n.classList.remove("pressed"),v.set("joined",!0),t.get("observer").notify("join-musession",v.get("docId"));for(i=0,l=r.length;i<l;i++)if(r[i].type==="INV"&&r[i].docId===v.get("docId")){r[i].joined=!0;break}y.set("notifications",r),y.upload()},p.reset=function(t){v.reset({}),m.reset({response:""}),v.reset(t),d.reset(t,"reply"),console.log(t),v.get("type")==="INV"&&(v.get("joined")?v.set("joined",!0):(v.set("sessionStatus",null),p.checkSessionStatus(v.get("docId"))))},p}}),define("connect/messages/newmessage",["OObject","Bind.plugin","Event.plugin","service/config","Store","Promise","service/autocontact","lib/spin.min"],function(e,t,n,r,s,o,u,a){return function(c){var h=new e,p=new s,d=new s({errormsg:""}),v=r.get("labels"),m=r.get("user"),g=r.get("transport"),y=!1,b=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),w={},E=function(e){var t=p.get("toList").toLowerCase().split(/,|;/),n=p.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(m.get("connections")).toLowerCase(),s=[],u={},a=new o;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+t[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(t[i].trim())}if(!d.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+n[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(n[i].trim())}return d.get("errormsg")||(u.list=s,g.request("CheckRecipientList",u,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.fulfill()}else d.set("errormsg",t.error),a.reject()})),a};return h.plugins.addAll({labels:new t(v),errormsg:new t(d),newmessage:new t(p,{setAvatar:function(e){this.setAttribute("style","background: url('"+r.get("avatar")+"') no-repeat center center;background-size:cover;")}}),newmessageevent:new n(h)}),h.template='<div id="newmsg"><div class="header blue-dark"><span data-labels="bind: innerHTML, newmsg">New message</span></div><div class="avatar" data-newmessage="bind: setAvatar, author"></div><form class="form"><p><textarea class="mail-header" name="toList" data-newmessage="bind: value, toList" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea class="mail-header" name="ccList" data-newmessage="bind: value, ccList" data-labels="bind:placeholder, cclbl" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><input type="text" class="input" data-newmessage="bind:value, object" data-labels="bind:placeholder, subjectlbl"></p><p><textarea class="input" data-newmessage="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-newmessage="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-newmessageevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-newmessageevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',h.reset=function(t){var n,r,i="";p.reset({author:m.get("_id"),username:m.get("username"),firstname:m.get("firstname"),type:"MSG",signature:m.get("username"),toList:"",ccList:"",object:"",body:"",date:null}),m.get("signature")?p.set("signature",m.get("signature")):p.set("signature",m.get("username")),d.reset({errormsg:""});if(t){console.log(t);if(t.type==="user")p.set("toList",t.username);else{for(n=0,r=t.contacts.length;n<r;n++)i?i=i+", "+t.contacts[n].username:i=t.contacts[n].username;p.set("toList",i)}}},h.press=function(e,t){t.classList.add("pressed")},h.cancel=function(e,t){t.classList.remove("pressed"),y=!1,h.reset(),c("#defaultPage")},h.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){p.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new u(r,t,s),w.name=i,r.classList.remove("invisible")},h.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?w.name.init():w.name.updateList()},h.send=function(e,t){var n=new Date,r={};t.classList.add("invisible"),t.classList.remove("pressed"),b.spin(t.parentNode),y||(y=!0,d.set("errormsg",""),r.author=p.get("author"),r.username=p.get("username"),r.firstname=p.get("firstname"),r.signature=p.get("signature"),r.toList=p.get("toList"),r.ccList=p.get("ccList"),r.object=p.get("object"),r.body=p.get("body"),r.type="MSG",p.get("object")||(d.set("errormsg",v.get("entersubjectlbl")),y=!1),r.dest=[],E(function(e){r.dest=e}).then(function(){d.get("errormsg")?(console.log(result),y=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],g.request("Notify",r,function(e){y=!1,b.stop(),t.classList.remove("invisible"),h.reset(),d.set("errormsg",v.get("messagesentok")),setTimeout(function(){d.set("errormsg",""),t.classList.remove("invisible"),c("#defaultPage")},2e3)}))}))},h}}),define("connect/messages/messages",["OObject","service/map","Bind.plugin","Event.plugin","Amy/Control-plugin","Amy/Stack-plugin","Store","service/config","service/avatar","service/utils","./message-detail","./newmessage","service/actionbar","Promise"],function(e,t,n,r,s,o,u,a,f,c,h,p,d,v){return function(){var g=new e,y=new s(g),b=new o,w=function(e){b.getStack().show(e)},E="#defaultPage",S=new e,x=new h(w),T=new p(w),N=new u([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),C=0,k=new u([]),L=a.get("labels"),A=null,O=a.get("user"),M=a.get("observer"),_=function(e){var t=N.get(e).name,n=O.get("notifications"),r,i=n.length,s=[];switch(t){case"messages":for(r=0;r<i;r++)n[r].type==="MSG"&&s.push(n[r]);break;case"notifications":for(r=0;r<i;r++)n[r].type!=="MSG"&&s.push(n[r]);break;case"unread":for(r=0;r<i;r++)n[r].status==="unread"&&s.push(n[r]);break;default:s=n}return s},D=function(e){var t=[],n=[];t=O.get("notifications").concat();if(e==="")n=t,N.update(0,"selected",!0),C=0;else for(i=0,l=t.length;i<l;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&n.push(t[i]);return n};return g.plugins.addAll({label:new n(L),sort:new n(N,{setLabel:function(e){this.innerHTML=L.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),msg:new n(k,{setObject:function(e){var t=this.getAttribute("data-msg_id");switch(e){case"INV":this.innerHTML=k.get(t).username+L.get("INVObject");break;case"CXR":this.innerHTML=k.get(t).username+L.get("CXRobject");break;case"CXRaccept":this.innerHTML=k.get(t).username+L.get("acceptedCXR");break;case"CXRreject":this.innerHTML=k.get(t).username+L.get("rejectedCXR");break;case"CXCancel":this.innerHTML=k.get(t).username+L.get("canceledCX");break;case"DOC":this.innerHTML=k.get(t).username+L.get("sentdocmsg");break;case"2Q+":this.innerHTML=k.get(t).username+L.get("askednew");break;case"2C+":this.innerHTML=k.get(t).username+L.get("senttc");break;case"REF":this.innerHTML=k.get(t).username+L.get("joinedideafy");break;default:this.innerHTML=k.get(t).object}},date:function P(P){var e=new Date;if(P&&P[0]===e.getFullYear()&&P[1]===e.getMonth()&&P[2]===e.getDate()){var t=P[3],n=P[4],r=P[5];t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r}else this.innerHTML=c.formatDate(P)},highlight:function(e){e&&e==="unread"?this.classList.add("unread"):this.classList.remove("unread")},setAvatar:function(t){var n,r;t&&(n=document.createDocumentFragment(),r=new f([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))}}),msglistevent:new r(g),msglistcontrol:y,msgdetailstack:b}),g.template='<div id="connect-messages"><div class="messages"><div class="header blue-light"><span data-label="bind: innerHTML, msglistheadertitle">My Messages</span><div class="option right" data-msglistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-msglistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-msglistevent="listen: keypress, search"><div class="msglist overflow" data-msglistcontrol="radio:li,selected,mouseup,selectMsg"><ul data-msg="foreach"><li class="msg list-item" data-msglistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-msg="bind:setAvatar, author"></div><p class="msg-author unread" data-msg="bind:highlight, status; bind:innerHTML, username">Author</p><div class="select-msg"></div><span class="date" data-msg="bind: date, date"></span><p class="msg-subject unread" data-msg="bind:highlight, status; bind:setObject, type">Subject</p></li></ul></div></div><div id="msg-detail" class="details" data-msgdetailstack="destination"></div></div>',g.place(t.get("connect-messages")),g.plus=function(t,n){b.getStack().get("#newmsg").reset(),b.getStack().show("#newmsg")},g.displaySort=function(e,t){var n=t.getAttribute("data-sort_id");k.reset([]),b.getStack().show("#defaultPage"),C>-1&&N.update(C,"selected",!1),N.update(n,"selected",!0),C=n,k.reset(_(n))},g.search=function(e,t){e.keyCode===13&&(N.update(C,"selected",!1),C=-1,k.reset(D(t.value)))},g.selectMsg=function(t,n){var r=t.target.getAttribute("data-msg_id"),s=O.get("notifications"),o;if(k.get(r).status==="unread"){for(i=0,l=s.length;i<l;i++)if(JSON.stringify(s[i])===JSON.stringify(k.get(r))){index=i;break}k.update(r,"status","read"),s[index]=k.get(r),O.set("notifications",s),O.upload()}b.getStack().show("#msgdetail"),x.reset(k.get(r)),E="#msgdetail"},g.init=function(){k.reset(O.get("notifications")),g.cleanOld()},g.reset=function(){N.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),g.init(),b.getStack().show("#defaultPage"),display=!1},g.getSelectedmsg=function(){var e=document.querySelector(".msg.selected"),t=-1;return e&&(t=e.getAttribute("data-msg_id")),t},g.cleanOld=function(){var e=new v,t=new Date,n,r,s=!1,o=O.get("notifications")||[],u=O.get("sentMessages")||[];for(i=o.length-1;i>=0;i--)n=new Date(o[i].date[0],o[i].date[1],o[i].date[2],o[i].date[3],o[i].date[4],o[i].date[5]),t.getTime()-n.getTime()>2592e6&&(o.pop(),s=!0);for(i=u.length-1;i>=0;i--)r=new Date(u[i].date[0],u[i].date[1],u[i].date[2],u[i].date[3],u[i].date[4],u[i].date[5]),t.getTime()-r.getTime()>2592e6&&(u.pop(),s=!0);return s?(O.set("notifications",o),O.set("sentMessages",u),O.upload().then(function(){e.fulfill()})):e.fulfill(),e},g.setStart=function(e,t){A&&A.hide()},g.showActionBar=function(e,t){var n=t.getAttribute("data-msg_id"),r,i=!1;A&&A.getParent()===t&&(i=!0),i||(A=new d("message",t,k.get(n)),r=document.createDocumentFragment(),A.place(r),t.appendChild(r),i=!0)},S.template='<div class="msgsplash"><div class="header blue-dark"><span>'+a.get("labels").get("messageview")+'</span></div><div class="innersplash" data-labels="bind: innerHTML, messagecenter"></div></div>',S.plugins.add("labels",new n(L)),g.init(),b.getStack().add("#defaultPage",S),b.getStack().add("#msgdetail",x),b.getStack().add("#newmsg",T),b.getStack().show("#defaultPage"),O.watchValue("notifications",function(){var e,t=[];k.reset([]),t=_(C),k.reset(t),b.getStack().getCurrentName()==="#msgdetail"&&(e=g.getSelectedmsg(),e>-1?x.reset(k.get(e)):b.getStack().show("#defaultPage"))}),M.watch("display-message",function(e){var t=O.get("notifications");N.update(C,"selected",!1),t[e].type==="MSG"?(N.update(1,"selected",!0),C=1):(N.update(2,"selected",!0),C=2),t[e].status="read",O.set("notifications",t),O.upload(),k.reset([t[e]]),document.querySelector('li[data-msg_id="0"]').classList.add("selected"),y.init(document.querySelector('li[data-msg_id="0"]')),b.getStack().show("#msgdetail"),x.reset(t[e]),E="#msgdetail"}),M.watch("message-contact",function(e){T.reset(e),b.getStack().show("#newmsg")}),O.watchValue("lang",function(){var e;N.loop(function(t,n){t.selected&&(e=n)}),N.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),N.update(e,"selected",!0)}),g}}),define("connect/twocents/mtc-details",["OObject","service/config","Store","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","service/avatar","service/utils","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f){return function(){var i=new e,s=t.get("labels"),u=t.get("user"),a=new o("connect");return i.plugins.addAll({labels:new r(s),place:new f({TwocentUI:a})}),i.template='<div class="twocent-detail"><div class="header blue-dark"><span data-labels="bind: innerHTML, mytwocentwall"></span></div><div class = "detail-contents"><div id="connect-twocents" class="twocents" data-place="place: TwocentUI"></div></div></div>',i.reset=function(){a.reset(u.get("_id"),"connect")},i}}),define("connect/twocents/mtq-details",["OObject","service/config","Store","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","service/avatar","service/utils","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f){return function(){var c=new e,h=t.get("labels"),p=t.get("user"),d=new n,v=new s("connect"),m=new o("connect"),g;return c.plugins.addAll({labels:new r(h),tqdetail:new r(d,{setHeader:function(e){e?e===p.get("_id")?this.innerHTML=h.get("mytqdetailheader"):this.innerHTML=h.get("tqheaderprefix")+d.get("username")+h.get("tqheadersuffix"):this.innerHTML=h.get("selecttq")},displayWriteTwocent:function(e){!e||e===p.get("_id")?this.classList.add("invisible"):this.classList.remove("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("connect-writetwocents").classList.add("invisible")},displayTwocentNB:function(e){var t=e.length||0;t?t===1?this.innerHTML=t+" "+h.get("showonetcreply"):this.innerHTML=t+"showtcrepliesafter":this.innerHTML=h.get("noreplyyet")},date:function y(y){y&&(this.innerHTML=a.formatDate(y))},setAuthor:function(e){e===p.get("username")&&d.get("author")===p.get("_id")?this.innerHTML=h.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e===p.get("_id")?this.innerHTML=h.get("youwrotelbl"):this.innerHTML=h.get("ideawrotelbl")},setAvatar:function(t){var n=document.createDocumentFragment(),r=new u([t]);r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n)}}),place:new f({TwoQTwocentList:m}),tqevent:new i(c)}),c.template='<div class="twocent-detail"><div class="header blue-dark"><span data-tqdetail="bind: setHeader, author"></span></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-tqdetail="bind:setAvatar, author"></div><span class="author" data-tqdetail="bind:setAuthor,username"></span><span class="commentlbl" data-tqdetail="bind: setWrotelbl, author"></span><p data-tqdetail="bind:innerHTML,question"></p><span class="date" data-tqdetail="bind:date, creation_date"></span></div><div class="detail-body"></div><div class="detail-footer"><div class="tcbutton" data-tqevent="listen:mousedown, press; listen: mouseup, write"></div><div class="tcreplies" data-tqdetail = "bind: displayTwocentNB, twocents"></div></div><div id="connect-writetwocents" class="invisible" data-tqdetail="bind: displayWriteTwocent, author"></div><div id="connect-twocents" class="twocents" data-tqdetail="bind: displayTwocentList, twocents" data-place="place:TwoQTwocentList"></div></div></div>',c.press=function(e,t){t.classList.add("pressed")},c.write=function(e,t){t.classList.remove("pressed"),document.getElementById("connect-writetwocents").classList.remove("invisible")},c.hide=function(){document.querySelector(".detail-contents").classList.add("invisible"),d.reset({})},c.reset=function(t){d.reset(t.value),v.reset(d.get("_id")),m.reset(d.get("_id")),g=c.dom.querySelector("#connect-writetwocents"),v.place(g)},c.place(document.createDocumentFragment()),c}}),define("connect/twocents/mtc-stack",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","./mtc-details","./mtq-details","service/config","Store"],function(e,t,n,r,i,s,o,u){return function(){var u=new e,a=new e,f=o.get("labels"),l=new n;return u.template='<div id = "mtcdetailstack" data-mtcdetailstack = "destination"></div>',u.plugins.addAll({mtcdetailstack:l}),u.setView=function(t){var n=l.getStack().getCurrentName();t==="2Q"&&n!=="twoqdetail"?l.getStack().show("twoqdetail"):t==="2C"&&n!=="twocdetail"?(l.getStack().get("twocdetail").reset(),l.getStack().show("twocdetail")):l.getStack().show("defaultPage")},u.reset=function(t,n){t==="2Q"&&n&&(l.getStack().get("twoqdetail").reset(n),l.getStack().show("twoqdetail")),(t==="default"||!n)&&l.getStack().show("defaultPage")},a.template='<div class="msgsplash"><div class="header blue-dark" data-labels="bind: innerHTML, twocentview"><span></span></div><div class="innersplash" data-labels="bind: innerHTML, twocentcenter"></div></div>',a.plugins.add("labels",new r(f)),u.init=function(t,n){var r=new s,o=new i;l.getStack().add("twoqdetail",r),l.getStack().add("twocdetail",o),l.getStack().add("defaultPage",a),t==="default"&&l.getStack().show("defaultPage"),t==="2Q"&&(l.getStack().show("twoqdetail"),twoQDetail.reset(n))},u}}),define("connect/twocents/twoqlist",["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,l,c,h,p){var d=new n([]),v=new t([]),m=!1,g="",y=null,b={db:l,view:h,design:c,query:{descending:!0}},w=r.get("labels"),E=this;d.setTransport(r.get("transport")),e==="contact"?g="contacttwoqlist":g="",this.template='<div><ul class="twoq-list '+g+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+g+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new i(d,{date:function S(S){S?this.innerHTML=o.formatDate(S):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=w.get("noreplyyet"):n===1?this.innerHTML=n+" "+w.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+w.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new i(v,{date:function x(x){x?this.innerHTML=o.formatDate(x):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=w.get("noreplyyet"):n===1?this.innerHTML=n+" "+w.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+w.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new s(this)}),this.getModel=function(){var e,t;return t=!E.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),t?e=v:e=d,e},this.resetQuery=function(e){var t=new f;return b.query=e,d.unsync(),d.reset([]),E.hideSearch(),d.sync(b.db,b.design,b.view,b.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){y&&y.hide()},this.showActionBar=function(e,t){var n=t.getAttribute("data-twoqlist_id"),r=!1,i,s=document.getElementById("mtc-list");y&&y.getParent()===t&&(r=!0),!s.classList.contains("mosaic")&&!r&&(y=new a("2Q",t,d.get(n).value),i=document.createDocumentFragment(),y.place(i),t.appendChild(i),r=!0)},this.showSearch=function(){var t=document.querySelector(".twoq-searchlist"),n=document.querySelector(".twoq-list");t&&t.classList.contains("invisible")&&(n.classList.add("invisible"),t.classList.remove("invisible"))},this.hideSearch=function(){var t=this.dom.querySelector(".twoq-searchlist"),n=this.dom.querySelector(".twoq-list");t&&!t.classList.contains("invisible")&&(n.classList.remove("invisible"),t.classList.add("invisible"))},this.search=function(t){v.reset([]),t.toLowerCase()?(this.showSearch(),d.loop(function(e,n){JSON.stringify(e).search(t)>-1&&v.alter("push",e)})):this.hideSearch()},p&&(b.query=p),this.init=function(){var t=new f;return d.sync(b.db,b.design,b.view,b.query).then(function(){t.fulfill()}),t}}return function(n,r,i,s,o){return l.prototype=new e,new l(n,r,i,s,o)}}),define("connect/twocents/mytwocents",["OObject","service/map","service/config","Bind.plugin","Place.plugin","Amy/Delegate-plugin","Amy/Stack-plugin","Amy/Control-plugin","./mtc-stack","./twoqlist","Store"],function(e,t,n,r,s,o,u,a,f,c,h){return function(){var d=new e,v=new u,m=new a(d),g=new f,y,b,w=[{name:"#mytwoq",active:!0},{name:"#contacttwoq",active:!1},{name:"#mytwoc",active:!1}],E=new h(w),S=new h({view:"#mytwoq"}),x=new h([]),T=n.get("user"),N=T.get("connections"),C=n.get("labels"),k=n.get("db");d.plugins.addAll({labels:new r(C),twoqbuttons:new r(E,{setBg:function(e){switch(e){case"#mytwoq":this.classList.add("mytwoq");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.classList.add("mytwoc");break;default:}},setActive:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),mtctools:new r(S,{setVisible:function(e){this.getAttribute("name")===e?this.classList.remove("invisible"):this.classList.add("invisible")},setLegend:function(e){switch(e){case"#mytwoq":this.innerHTML=C.get("mytwoquestions");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.innerHTML=C.get("mytwocents");break;default:}},updateLegend:function(e){e&&S.get("view")==="#contacttwoq"&&(this.innerHTML=C.get("twoqprefix")+e+C.get("twoqsuffix"))}}),auto:new r(x),mtcliststack:v,mtcdetails:new s({mtcDetails:g}),mtccontrol:m,mtcevent:new o(d)}),d.template='<div id="connect-tc"><div id="mtc-list"><div class="header blue-light"><span data-labels="bind: innerHTML, mtcheadertitle"></span><div class="option right" data-mtcevent="listen: mousedown, plus"></div></div><ul class="twoqbuttons" data-twoqbuttons="foreach"><li data-twoqbuttons="bind: setBg,name; bind:setActive, active" data-mtcevent="listen:mousedown, selectView; listen: mouseup, showView"></li></ul><div class="selectcontact" name = "#contacttwoq" data-mtctools="bind:setVisible, view"><legend>Select a contact</legend><input class="search" data-mtcevent="listen:mousedown, updateAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl" data-mtctools = "bind:value, contact"><div class="rightcaret" data-mtcevent="listen: mousedown, updateAutoContact"></div><div class = "autocontact invisible"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-mtcevent="listen:mousedown, highlightContact; listen:mouseup, selectContact"></li></ul></div></div><legend data-mtctools="bind:setLegend, view; bind: updateLegend, contact"></legend><input name="#mytwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: input, search"><input name="#contacttwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><input name="#mytwoc" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><div data-mtcliststack="destination" data-mtccontrol="radio:li,selected,mousedown,selectStart"></div></div><div id="mtc-detail" data-mtcdetails="place:mtcDetails" class="details"></div></div>',d.place(t.get("connect-twocents")),d.plus=function(){t.get("new2q-popup").classList.add("appear"),t.get("cache").classList.add("appear")},d.selectView=function(e,t){var n=t.getAttribute("data-twoqbuttons_id");E.loop(function(e,t){t===parseInt(n)?E.update(t,"active",!0):E.update(t,"active",!1)}),S.set("view",E.get(n).name)},d.showView=function(e,t){var n=t.getAttribute("data-twoqbuttons_id");switch(E.get(n).name){case"#mytwoq":v.getStack().show("#mytwoq"),g.setView("#defaultPage");break;case"#contacttwoq":v.getStack().show("#contacttwoq"),g.setView("#defaultPage");break;case"#mytwoc":v.getStack().show("#blank"),g.setView("2C")}},d.updateAutoContact=function(e,t){var n=JSON.parse(x.toJSON()),r,s,o=document.getElementById("mtc-list"),u=o.querySelector(".autocontact");u.classList.contains("invisible")&&u.classList.remove("invisible"),e.keyCode===8&&(t.value="");if(!t.value||t.value===""){n=[];for(i=0,l=N.length;i<l;i++)N[i].type==="user"&&n.push({contact:N[i]});x.reset(n)}else{s=t.value.toLowerCase();for(i=n.length-1;i>=0;i--)r=n[i].contact.username.toLowerCase(),r.search(s)!==0&&n.splice(i,1);x.reset(n)}e.keyCode===13&&(t.value===""?(v.getStack().show("#blank"),g.getStack().show("defaultPage")):x.getNbItems()?(S.set("contact",x.get(0).contact.username),b.resetQuery({key:'"'+x.get(0).contact.userid+'"',descending:!0}).then(function(){var e=b.getModel(),t;e.getNbItems()?(v.getStack().show("#contacttwoq"),g.reset("2Q",e.get(0)),t=b.dom.querySelector("li[data-twoqlist_id='0']"),m.init(t),t.classList.add("selected"),g.reset("2Q",e.get(0))):(v.getStack().show("#blank"),g.reset("default"))})):(v.getStack().show("#blank"),g.reset("default")))},d.highlightContact=function(e,t){t.classList.add("highlighted")},d.selectContact=function(e,t){var n=t.getAttribute("data-auto_id"),r=document.getElementById("mtc-list"),i=r.querySelector(".autocontact");t.classList.remove("highlighted"),S.set("contact",x.get(n).contact.username),i.classList.add("invisible"),b.resetQuery({key:'"'+x.get(n).contact.userid+'"',descending:!0}).then(function(){var e=b.getModel(),t;e.getNbItems()?(v.getStack().show("#contacttwoq"),g.reset("2Q",e.get(0)),t=b.dom.querySelector("li[data-twoqlist_id='0']"),m.init(t),t.classList.add("selected"),g.reset("2Q",e.get(0))):(v.getStack().show("#blank"),g.reset("default"))})},d.selectStart=function(e,t){var n=v.getStack().getCurrentScreen().getModel(),r;if(S.get("view")==="#mytwoq"||S.get("view")==="#contacttwoq")r=e.target.getAttribute("data-twoqlist_id")||e.target.getAttribute("data-twoqsearch_id"),g.reset("2Q",n.get(r))},d.search=function(e,t){v.getStack().getCurrentScreen().search(t.value)},d.reset=function(){var t;E.reset(w),S.set("view","#mytwoq"),x.reset([]),N=T.get("connections");for(t=0,l=N.length;t<l;t++)N[t].type==="user"&&x.alter("push",{contact:N[t],selected:!1});y.resetQuery({key:n.get("uid"),descending:!0}).then(function(){v.getStack().show("#mytwoq"),g.reset("default")})},n.get("observer").watch("display-twoq",function(e,t){b.resetQuery({key:'"'+t+'"',descending:!0}).then(function(){var t=b.getModel(),n,r;v.getStack().show("#contacttwoq"),S.set("view","#contacttwoq"),E.loop(function(e,t){e.name==="#contacttwoq"?E.update(t,"active",!0):E.update(t,"active",!1)}),t.loop(function(t,r){t.id===e&&(n=r,S.set("contact",t.value.username))}),r=b.dom.querySelector("li[data-twoqlist_id='"+n+"']"),m.init(r),r.classList.add("selected"),g.reset("2Q",t.get(n))})}),n.get("observer").watch("display-twoc",function(){v.getStack().show("#blank"),S.set("view","#mytwoc"),E.loop(function(e,t){e.name==="#mytwoc"?E.update(t,"active",!0):E.update(t,"active",!1)}),g.setView("2C")});for(i=0,l=N.length;i<l;i++)N[i].type==="user"&&x.alter("push",{contact:N[i],selected:!1});return y=new c("user",k,"questions","_view/questionsbyauthor",{key:n.get("uid"),descending:!0}),b=new c("contact",k,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:!0}),blank=new c("user",k,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:!0}),v.getStack().add("#mytwoq",y),v.getStack().add("#contacttwoq",b),v.getStack().add("#blank",blank),b.init(),blank.init(),y.init().then(function(){v.getStack().show("#mytwoq"),g.init("default")}),d}}),define("connect/connect",["OObject","service/map","Amy/Stack-plugin","service/submenu","./contacts/contacts","./messages/messages","./twocents/mytwocents","service/config"],function(e,t,n,r,i,s,o,u){return function(){var f=new e,l=new n,c=u.get("observer"),h=function(t){l.getStack().show(t)},p,d=new s,v=new i,m=new o;return f.plugins.add("connectstack",l),f.template='<div id="connect"><div id="connect-menu"></div><div class="stack" data-connectstack="destination"></div></div>',f.place(t.get("connect")),f.showMenu=function(){p.toggleActive(!0)},f.hideMenu=function(){p.toggleActive(!1)},f.reset=function(){p.reset(),v.reset(),d.reset(),m.reset(),l.getStack().show("#messages")},p=new r(f.dom.querySelector("#connect-menu"),h),p.toggleActive(!1),d.init(),v.init(),l.getStack().add("#messages",d),l.getStack().add("#contacts",v),l.getStack().add("#twocents",m),l.getStack().show("#messages"),c.watch("display-message",function(e){l.getStack().show("#messages")}),c.watch("display-twoq",function(){l.getStack().show("#twocents")}),c.watch("display-twoc",function(){l.getStack().show("#twocents")}),c.watch("message-contact",function(){l.getStack().show("#messages")}),f}}),define("dashboard/profile/leaderboard",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","service/utils","service/avatar"],function(e,t,n,r,i,s,o){return function(){var a=new e,f=new i([]);return a.template='<div><ul data-leaders="foreach"><li class="leader" data-leaders="bind:setSpotLight, value.userid"><div data-leaders="bind:setAvatar, value.userid"></div><div class="username" data-leaders="bind:innerHTML, value.username"></div><div class="distinction" data-leaders="bind:setDistinction, value.ip"></div><div class="grade" data-leaders="bind:setGrade, value.ip"></div><div class="score" data-leaders="bind: setScore, value.ip"></div></li></ul></div>',a.plugins.addAll({leaders:new n(f,{setSpotLight:function(e){e===t.get("user").get("_id")?(this.classList.add("userleader"),this.scrollIntoView(!1)):this.classList.remove("userleader")},setAvatar:function(e){var t,n;e&&(n=document.createDocumentFragment(),t=new o([e]),t.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setGrade:function(e){var t=this;s.getGrade(e,function(e){t.setAttribute("style","background: url('img/profile/"+e.grade.badge+"') no-repeat center center; background-size: 40px 40px;")})},setDistinction:function(e){var t=this;s.getGrade(e,function(e){e.distinction&&t.setAttribute("style","background: url('img/profile/"+e.distinction.badge+"') no-repeat center center; background-size: 40px 40px;")})},setScore:function(e){this.innerHTML=e+" ip"}}),leaderevent:new r(a)}),a.init=function(n){f.setTransport(t.get("transport")),f.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0}).then(function(){a.place(n)})},t.get("observer").watch("reconnect",function(){f.unsync(),f.reset([]),f.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0})}),a}}),define("dashboard/profile/editprofile",["OObject","service/config","Bind.plugin","Event.plugin","service/avatar","service/utils","Store","lib/spin.min","LocalStore"],function(e,t,n,r,i,s,o,u,a){return function(){var f=new e,l=t.get("user"),c=new o,h=[{name:"azur",file:"img/avatars/deedee0.png",selected:!1},{name:"blue",file:"img/avatars/deedee1.png",selected:!1},{name:"green",file:"img/avatars/deedee2.png",selected:!1},{name:"grey",file:"img/avatars/deedee3.png",selected:!1},{name:"orange",file:"img/avatars/deedee4.png",selected:!1},{name:"red",file:"img/avatars/deedee5.png",selected:!1},{name:"yellow",file:"img/avatars/deedee6.png",selected:!1}],p=new o(h),d={},v=new o({status:null}),m=t.get("labels"),g=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:360})).spin(),y=80,b=80,w=function(e){var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)},E=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=y/t,t=y):(t*=b/n,n=b),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},S=function(e){var t=new Image,n=document.createElement("canvas"),r=document.getElementById("avatarcanvas"),i=n.getContext("2d"),s=r.scrollWidth,o=r.scrollHeight,u,a;t.src=e,setTimeout(function(){n.width=s,n.height=o,u=Math.floor(Math.max(0,(t.width-s)/2)),a=Math.floor(Math.max(0,(t.height-o)/2)),i.drawImage(t,u,a,s,o,0,0,s,o),c.set("avatar",n.toDataURL("image/png"))},300)},x=function(e){var t="/upload",n=new FormData;n.append("type","avatar"),n.append("filename",d.picture_file),n.append("img",c.get("avatar")),s.uploadFile(t,n,v,function(e){e.response!=="ok"&&console.log(e)})};return f.plugins.addAll({label:new n(m),avatars:new n(p,{setPic:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setChecked:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),progress:new n(v,{showProgress:function(e){var t=0;e&&(t=Math.floor(e/100*80)),this.setAttribute("style","width:"+t+"px;"),e===100?this.innerHTML=m.get("uploadcomplete"):this.innerHTML=""}}),profile:new n(c,{setAvatar:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setDay:function(e){e[2]&&(this.value=e[2])},setMonth:function(e){var t=e[1]||0;this.value=this.options[t].innerHTML},setYear:function(e){e[0]&&(this.value=e[0])},setFamilyStatus:function(e){if(e||e===0)this.selectedIndex=e},setChildren:function(e){if(e||e===0)this.selectedIndex=e},setSituation:function(e){if(e||e===0)this.selectedIndex=e},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})}}),editprofileevent:new r(f)}),f.template='<div><div class = "setavatar"><canvas id ="avatarcanvas" class="currentavatar" data-profile="bind:setAvatar, avatar" data-editprofileevent="listen:mousedown, changeAvatar"></canvas><div id="rotate" class="invisible" data-editprofileevent="listen:mousedown, rotateAvatar"></div><div id="changeavatar" class="invisible"><div class="avatarcache"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editprofileevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editprofileevent="listen: mousedown, press; listen: mouseup, release"></div></span><p data-label="bind:innerHTML, selectavatar"></p><ul class="defaultlist" data-avatars="foreach"><li><div class="defaultAvatar" data-avatars="bind: setPic, file"></div><div class="checkbox" data-avatars="bind: setChecked, selected" data-editprofileevent="listen: mouseup, setDefaultAvatar"></div></li></ul></div></div><form class="profileinfo"><div class = "username"><div class = "firstname"><label data-label="bind:innerHTML, firstnameplaceholder"></label><input class="input" name="firstname" type="text" data-profile="bind: value, firstname" data-editprofileevent="listen: input, updateField"></div><div class = "lastname"><label data-label="bind:innerHTML, lastnameplaceholder"></label><input class="input" type="text" name="lastname" data-profile="bind: value, lastname" data-editprofileevent="listen: input, updateField"></div></div><label data-label="bind:innerHTML, profileintro"></label><input class="input" name="intro" type="text" data-profile="bind:value, intro" data-label="bind:placeholder, shortprofiledesc" data-editprofileevent="listen: input, updateField"><label data-label="bind:innerHTML, dob"></label><div class="dob"><input class="day" name="day" type="text" data-label="bind:placeholder, day" data-profile="bind: setDay, birthdate" data-editprofileevent="listen:input, updateDate"><select name="month" data-profile="bind: setMonth, birthdate" data-editprofileevent="listen:change, updateDate"><option data-label="bind:innerHTML, jan"></option><option data-label="bind:innerHTML, feb"></option><option data-label="bind:innerHTML, mar"></option><option data-label="bind:innerHTML, apr"></option><option data-label="bind:innerHTML, may"></option><option data-label="bind:innerHTML, jun"></option><option data-label="bind:innerHTML, jul"></option><option data-label="bind:innerHTML, aug"></option><option data-label="bind:innerHTML, sep"></option><option data-label="bind:innerHTML, oct"></option><option data-label="bind:innerHTML, nov"></option><option data-label="bind:innerHTML, dec"></option></select><input class="year" name="year" type="text" data-label="bind:placeholder,year" data-profile="bind: setYear, birthdate" data-editprofileevent="listen:input, updateDate"></div><div class="postal"><label class="streetaddress" data-label="bind:innerHTML, mailaddress"></label><input class="streetaddress input" name="street1" type="text" data-label="bind:placeholder, street" data-profile="bind:value, address.street1" data-editprofileevent="listen:input, updateAddress"><div class="city"><label data-label="bind:innerHTML, city"></label><input class="input city" name="city" type="text" data-profile="bind:value, address.city" data-editprofileevent="listen:input, updateAddress"></div><div class="zipstate"><div class="state"><label data-label="bind:innerHTML, state"></label><input class="input" name="state" placeholder="" type="text" data-profile="bind:value, address.state" data-editprofileevent="listen:input, updateAddress"></div><div class="zip"><label data-label="bind:innerHTML, zip"></label><input class="input" name="zip" placeholder="" type="text" data-profile="bind:value, address.zip" data-editprofileevent="listen:input, updateAddress"></div></div><label data-label="bind:innerHTML, country"></label><input class="input" name="country" type="text" data-profile="bind:value, address.country" data-editprofileevent="listen:input, updateAddress"></div><label data-label="bind:innerHTML, myfamily"></label><div class="family"><select class="status" name="couple" data-profile="bind: setFamilyStatus, family.couple" data-editprofileevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select><select class="children" name="children" data-profile="bind: setChildren, family.children" data-editprofileevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><label data-label="bind:innerHTML, children"></label></div><label data-label="bind:innerHTML, myoccupation"></label><div class="job"><select class="status" name="situation" data-profile="bind: setSituation, occupation.situation" data-editprofileevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select><div class="jobdesc"><label data-label="bind:innerHTML, jobtitle"></label><input class="input" type="text" name="job" data-profile="bind:value, occupation.job" data-label="bind:placeholder, jobtitle" data-editprofileevent="listen:input, updateJob"></div><div class="org"><label data-label="bind:innerHTML, organization"></label><input class="input" name="organization" type="text" data-profile="bind:value, occupation.organization" data-label="bind:placeholder,organization" data-editprofileevent="listen:input, updateJob"></div></div></form><form class="addtlinfo"><legend data-label="bind:innerHTML, socialnwlbl"></legend><ul class="socialnw"><li class="fb"><input class="input" type="text" name="facebook" data-profile="bind: value, facebook" data-editprofileevent="listen: input, updateField"></li><li class="gp"><input class="input" name="gplus" type="text" data-profile="bind: value, gplus" data-editprofileevent="listen: input, updateField"></li><li class="lin"><input class="input" name="linkedin" type="text" data-profile="bind: value, linkedin" data-editprofileevent="listen: input, updateField"></li><li class="tw"><input class="input" name="twitter" type="text" data-profile="bind: value, twitter" data-editprofileevent="listen: input, updateField"></li></ul><legend data-label="bind:innerHTML, hobbieslbl"></legend><label data-label="bind:innerHTML, name"></label><label class="description" data-label="bind:innerHTML, comment"></label><input name="leisure0" class="input" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input" type="text"  data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input class="input" name="leisure2" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><label data-label="bind:innerHTML, field"></label><label class="description" data-label="bind:innerHTML, comment"></label><input class="input" name="interest0" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest1" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest2" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"></form><div class="useascharacter"></div><p class="update"><label class="cancelprofile" data-label="bind:innerHTML, cancellbl" data-editprofileevent="listen: mousedown, press; listen:mouseup, cancel"></label><label class="updateprofile" data-label="bind:innerHTML, updatelbl" data-editprofileevent="listen:mousedown, press; listen:mouseup, update"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p><div class="uploadprogress" data-progress="bind:showProgress, status"></div></div>',f.init=function(t){f.reset(),f.place(t)},f.selectpress=function(e,t){t.value=""},f.press=function(e,t){t.classList.add("pressed")},f.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},f.uploadnDisplay=function(e,t){var n=new Image,r=new FileReader,i=new FileReader,s=document.getElementById("avatarcanvas");r.onload=function(e){n.src=e.target.result,setTimeout(function(){S(E(n)),d.picture_file=l.get("_id")+"_@v@t@r",document.getElementById("changeavatar").classList.add("invisible")},300)},r.readAsDataURL(t.files[0])},f.changeAvatar=function(e,t){document.getElementById("changeavatar").classList.remove("invisible"),v.set("status",0)},f.setDefaultAvatar=function(e,t){var n=t.getAttribute("data-avatars_id");p.loop(function(e,t){t===parseInt(n)?p.update(t,"selected",!0):p.update(t,"selected",!1)}),c.set("avatar",p.get(n).file),d.picture_file=p.get(n).file,document.getElementById("changeavatar").classList.add("invisible")},f.rotateAvatar=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d"),i=new Image;i.src=c.get("avatar"),setTimeout(function(){n.width=i.width,n.height=i.height,r.translate(n.width/2,n.height/2),r.rotate(Math.PI/2),r.translate(-n.height/2,-n.width/2),r.drawImage(i,0,0),c.set("avatar",n.toDataURL("image/png"))},300)},f.reset=function(){c.reset(JSON.parse(l.toJSON())),c.set("avatar",t.get("avatar")),p.reset(h),d={},c.get("picture_file").search("img/avatars/deedee")>-1&&p.loop(function(e,t){c.get("picture_file").search(e.file)>-1&&p.update(t,"selected",!0)})},f.updateField=function(e,t){var n=t.getAttribute("name");d[n]=t.value,c.set(n,t.value)},f.updateDate=function(e,t){var n=c.get("birthdate"),r=t.getAttribute("name"),i;switch(r){case"year":n[0]=t.value;break;case"month":n[1]=t.selectedIndex;break;case"day":n[2]=t.value}c.set("birthdate",n),d.birthdate=n},f.updateAddress=function(e,t){var n=c.get("address"),r=t.getAttribute("name");n[r]=t.value||"",c.set("address",n),d.address=n},f.updateFamily=function(e,t){var n=t.getAttribute("name"),r=c.get("family");r[n]=t.selectedIndex,c.set("family",r),d.family=r},f.updateJob=function(e,t){var n=c.get("occupation"),r=t.getAttribute("name"),i;switch(r){case"situation":n.situation=t.selectedIndex;break;case"job":n.job=t.value;break;case"organization":n.organization=t.value}d.occupation=n},f.updateLeisureName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=c.get("leisure_activities");i[r].name=t.value,c.set("leisure_activities",i),d.leisure_activities=i},f.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=c.get("leisure_activities");i[r].comment=t.value,c.set("leisure_activities",i),d.leisure_activities=i},f.updateInterestName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=c.get("interests");i[r].name=t.value,c.set("interests",i),d.interests=i},f.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=c.get("interests");i[r].comment=t.value,c.set("interests",i),d.interests=i},f.press=function(e,t){t.classList.add("pressed")},f.cancel=function(t,n){n.classList.remove("pressed"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible")},f.update=function(n,r){var i,s=0;r.classList.remove("pressed"),r.classList.add("invisible"),g.spin(r.parentNode);for(i in d)l.set(i,d[i]),s++;s?l.upload().then(function(){var e=new a;d.picture_file&&(t.set("avatar",c.get("avatar")),e.sync("ideafy-data"),e.set("userAvatar",t.get("avatar"))),d.picture_file&&d.picture_file.search("img/avatars/deedee")<0&&(x(),document.getElementById("rotate").classList.add("invisible")),g.stop(),r.classList.remove("invisible"),t.get("observer").notify("profile-updated"),document.querySelector(".edituserdetails").classList.add("invisible"),document.querySelector(".userdetails").classList.remove("invisible")}):(g.stop(),r.classList.remove("invisible"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible"))},f}}),define("dashboard/profile/profile",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","./leaderboard","./editprofile","Promise"],function(e,t,n,r,s,o,u,a,f,c){return function(){var p=new e,d=s.get("user"),v=d.get("ip"),m=s.get("labels"),g=new o({total:0,ideas:0,sessions:0,contacts:0,twoQ:0}),y=new o({status:""}),b=new o({view:"info",completion:0,socialnw:0}),w=new o(d.get("news")),E,S,x=new o([]),T=new o;return p.plugins.addAll({label:new n(m),stats:new n(b,{setViewLbl:function(e){this.innerHTML=m.get(e)},toggleInformation:function(e){e==="info"?this.classList.remove("invisible"):this.classList.add("invisible")},toggleLeaderboard:function(e){e==="leaderboard"?this.classList.remove("invisible"):this.classList.add("invisible")},setPercentage:function(e){this.innerHTML=m.get("completionprefix")+e+m.get("completionsuffix")},setProgress:function(e){e===100?this.setAttribute("style","width:100%;border-top-right-radius:5px;border-bottom-right-radius:5px;"):this.setAttribute("style","width:"+e+"%;")},showDetails:function(e){e===100?this.classList.add("invisible"):this.classList.remove("invisible")},showSocialNW:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),grades:new n(x,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new n(T,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),progressbar:new n(g,{setWidth:function(e){this.setAttribute("style","width:"+e+"%;")}}),progress:new n(y),config:new n(s,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),user:new n(d,{setLocation:function(e){e.country?this.innerHTML=e.country.toUpperCase():this.innerHTML=m.get("completeprofile"),e.city&&e.country&&(this.innerHTML=e.city+", "+e.country.toUpperCase()),e.city&&e.state&&e.country&&(this.innerHTML=e.city+", "+e.state.toUpperCase()+" "+e.country.toUpperCase())},setAge:function(e){var t=new Date,n,r;e&&e.length===3?(n=new Date(e[0],e[1],e[2]),r=t.getTime()-n.getTime(),this.innerHTML=Math.floor(r/1e3/3600/24/365)+" "+m.get("agelbl")):this.innerHTML=m.get("completeprofile")},setFamily:function(e){var t=e.couple,n=e.children,r,i;t===null?r=m.get("completeprofile"):t===0?r=m.get("singlelbl"):t===1?r=m.get("marriedlbl"):t===2?r=m.get("divorcedlbl"):t===3&&(r=m.get("widowlbl")),!n||n===0?i="":(d.get("age")<20?n===1?i=n+m.get("onesiblinglbl"):i=n+m.get("siblingslbl"):n===1?i=n+m.get("onechildlbl"):i=n+m.get("childrenlbl"),i=", "+i),this.innerHTML=r+i},setOccupation:function(e){e.situation===4?this.innerHTML=m.get("stayathome"):e.situation===3?this.innerHTML=m.get("unemployed"):e.situation===0?e.organization?this.innerHTML=m.get("student")+" @ "+e.organization:this.innerHTML=m.get("student"):e.situation===2?e.job?this.innerHTML=e.job+" ("+m.get("retired")+")":this.innerHTML=m.get("retired"):e.situation===1?!e.job&&!e.organization?this.innerHTML=m.get("active"):e.job&&!e.organization?this.innerHTML=e.job:!e.job&&e.organization?this.innerHTML=m.get("active")+" @ "+e.organization:this.innerHTML=e.job+" @ "+e.organization:this.innerHTML=m.get("completeprofile")},showLeisure:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setLeisure:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)e[i].comment?t+="<li>"+e[i].name+" ("+e[i].comment+")</li>":t+="<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showInterests:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setInterests:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)e[i].comment?t+="<li>"+e[i].name+" ("+e[i].comment+")</li>":t+="<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showSN:function(e){e?this.innerHTML=e:this.innerHTML=""},setSessionCount:function(e){var t=d.get("su_sessions_count")||0,n=d.get("mu_sessions_count")||0;this.innerHTML=t+n},setContactCount:function(e){var t=0;for(i=0,l=e.length;i<l;i++)e[i].type==="user"&&t++;this.innerHTML=t},setBarLength:function(e){e>=3e5?this.setAttribute("style","width: 100%"):e>=3e4?this.setAttribute("style","width: 75%"):e>=3e3?this.setAttribute("style","width: 50%"):this.setAttribute("style","width: 25%")}}),news:new n(w,{setType:function(e){e.search("CX")>-1?this.setAttribute("style","background: url('img/profileDisable.png') no-repeat center center; background-size: contain;"):e.search("RWD")>-1||e.search("RANK")>-1?this.setAttribute("style","background: url('img/brainstorm/yourScore40.png') no-repeat center center; background-size: 40px;"):e.search("ID")>-1?this.setAttribute("style","background: url('img/libraryIdeaDisabled40.png') no-repeat center center; background-size: 40px;"):e.search("2Q")>-1?this.setAttribute("style","background: url('img/2questionDisable50.png') no-repeat center center; background-size: 40px;"):e.search("2CTS")>-1&&this.setAttribute("style","background: url('img/2centDisable.png') no-repeat center center; background-size: 40px;")},setContent:function(e){var t=this.getAttribute("data-news_id");switch(w.get(t).type){case"CX+":this.innerHTML="<span class='newsinfo'>"+w.get(t).content.username+"</span>"+m.get("isnowacontact");break;case"CX-":this.innerHTML="<span class='newsinfo'>"+w.get(t).content.username+"</span>"+m.get("isnolongeracontact");break;case"IDEA+":this.innerHTML=m.get("enterednewidea")+"<span class='newsinfo'>"+w.get(t).content.title+"</span>";break;case"SHID":this.innerHTML=m.get("sharedanidea")+"("+"<span class='newsinfo'>"+w.get(t).content.title+"</span>)";break;case"RANK":this.innerHTML=m.get("reachedrank")+"<span class='newsinfo'>"+w.get(t).content.label+"</span>";break;case"RWD":this.innerHTML=m.get("gotaward")+"<span class='newsinfo'>"+w.get(t).content.label+"</span>";break;case"2Q+":this.innerHTML=m.get("posted2q")+"<span class='newsinfo'>"+w.get(t).content.question+"</span>";break;case"2CTS":this.innerHTML=m.get("commentedon")+"<span class='newsinfo'>"+w.get(t).content.title+"</span>"+m.get("by")+w.get("id").content.username}},formatDate:function(e){this.innerHTML=u.formatDate(e)}}),profileevent:new r(p)}),p.template='<div id="dashboard-profile"><div class="header blue-dark"><span data-label="bind:innerHTML, profilelbl"></span></div><input class="infoslider" type="range" min="0" max="1" value ="0" data-profileevent="listen:mouseup, switchLeaderboard"><span class="slidertext" data-stats="bind:setViewLbl, view"></span><div id="profile-content" data-stats="bind:toggleInformation, view"><div class="leftprofile"><div class="userdetails"><div class="editbtn" data-profileevent="listen:mousedown, edit"></div><div class="cd-picarea"><div class="cardpicture" data-config="bind:setAvatar, avatar"></div><div class="cardinfo"><h2 data-user="bind:innerHTML,username"></h2><blockquote data-user="bind:innerHTML, intro"></blockquote><p><span class="cd-agelbl"></span><span data-user="bind:setAge, birthdate"></span></p><p><span class="cd-locationlbl"></span><span class="cd-info" data-user="bind: setLocation, address"></span></p><p><span class="cd-joblbl"></span><span class="cd-info" data-user="bind: setOccupation, occupation"></span></p><p><span class="cd-familylbl"></span><span class="cd-info" data-user="bind: setFamily, family"></span></p></div></div><div class="cd-contentarea"><div data-user="bind:showLeisure, leisure_activities"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl"></span><p class = "userinfo" data-user="bind:setLeisure, leisure_activities"></p></div><div data-user="bind:showInterests, interests"><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "userinfo" data-user="bind: setInterests, interests"></p></div><div data-stats="bind:showSocialNW, socialnw"><span class="contentTitle" data-label="bind: innerHTML, socialnwlbl"></span><p class = "userinfo fb" data-user="bind:showSN, facebook"></p><p class = "userinfo gp" data-user="bind:showSN, gplus; bind:innerHTML"></p><p class = "userinfo tw" data-user="bind:showSN, twitter"></p><p class = "userinfo lin" data-user="bind:showSN, linkedin"></p></div></div><div><legend data-stats="bind: setPercentage, completion"></legend><div class="completionbar"><div class="innerbar" data-stats = "bind:setProgress, completion"></div></div></div></div><div class="edituserdetails invisible"></div><div class="mystats"><legend data-label="bind:innerHTML, mystatslbl"></legend><div class="completionbar"><ul data-user="bind: setBarLength, ip"><li class="innerbar myids" data-progressbar="bind: setWidth, ideas"></li><li class="innerbar myss" data-progressbar="bind:setWidth, sessions"></li><li class="innerbar myctcts" data-progressbar="bind: setWidth, contacts"></li><li class="innerbar my2q" data-progressbar="bind:setWidth, twoQ"></li></ul></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-user="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-user="bind: setSessionCount, ip"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-user="bind: setContactCount, connections"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-user="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="recentactivity"><legend data-label="bind:innerHTML, recentactivitylbl"></legend><ul data-news="foreach"><li><div class="newstype" data-news="bind:setType, type"></div><div class="newsdate" data-news="bind:formatDate, date"></div><p class="newstext" data-news="bind:setContent, content"></p></li></ul></div></div><div class = "rightprofile"><div class="userscore"><span class="ip" data-user="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><div class="userachievements"><h2 class="grade" data-stats="bind:innerHTML, title"></h2><ul class="badges" data-grades="foreach"><li class="badge"><div data-grades="bind:showBadge, badge"></div><legend data-grades="bind:innerHTML, title"></legend></li></ul><ul class="badges" data-achievements="foreach"><li class="badge"><div data-achievements="bind:showBadge, badge"></div><legend data-achievements="bind:innerHTML, label"></legend></li></ul></div></div></div><div id="leaderboard" data-stats="bind:toggleLeaderboard, view"></div></div>',p.place(t.get("dashboard-profile")),p.switchLeaderboard=function(e,t){var n=document.getElementById("leaderboard"),r=document.getElementById("profile-content");E||(E=new a,E.init(n)),t.value==1?(t.setAttribute("style","background: #5F8F28;"),b.set("view","leaderboard")):(t.setAttribute("style","background: #9AC9CD;"),b.set("view","info"))},p.edit=function(e,t){var n=document.querySelector(".edituserdetails");document.querySelector(".userdetails").classList.add("invisible"),S?S.reset():(S=new f,S.init(n)),n.classList.remove("invisible")},s.get("observer").watch("profile-updated",function(e){p.checkProfileCompletion().then(function(){p.updateGrade(),p.updateAchievements()})}),d.watchValue("ip",function(){p.updateGrade(),p.updateProgressBar()}),d.watchValue("tutorial_complete",function(){p.updateGrade(),p.updateAchievements()}),d.watchValue("settings",function(){p.updateGrade(),p.updateAchievements()}),d.watchValue("news",function(){w.reset(d.get("news"))}),d.watchValue("lang",function(){p.updateGrade().then(function(){p.updateAchievements()}),w.reset([]),w.reset(d.get("news"))}),p.checkProfileCompletion=function(){var e=u.checkProfileCompletion(),t=new c;return b.set("completion",e.percentage),b.set("missing",e.missing),e.missing.indexOf(m.get("entersocialnw"))<0&&b.set("socialnw",1),e.percentage===100&&d.get("profile_complete")!==!0?(d.set("profile_complete",!0),d.upload().then(function(){t.fulfill()})):e.percentage<100&&d.get("profile_complete")?(d.set("profile_complete",!1),d.upload().then(function(){t.fulfill()})):t.fulfill(),t},p.updateGrade=function(){var t=new c;return u.getGrade(d.get("ip"),function(e){var n;e.distinction?n=[e.grade,e.distinction]:n=[e.grade],x.reset(n),b.set("title",e.grade.label),t.fulfill()}),t},p.updateAchievements=function(){var t=new c;return u.getAchievements(d.get("_id"),function(e){e.length?T.reset(e):T.reset(d.get("achievements")),t.fulfill()}),t},p.updateProgressBar=function(){var t,n,r,i,s,o,u,a,f;n=d.get("ideas_count"),i=d.get("su_sessions_count")||0,s=d.get("mu_sessions_count")||0,r=i+s,u=d.get("twoquestions_count")||0,o=0;for(a=0,f=d.get("connections").length;a<f;a++)d.get("connections")[a].type==="user"&&o++;t=n+u+o+r,g.set("total",t),g.set("ideas",Math.floor(n/t*100)),g.set("contacts",Math.floor(o/t*100)),g.set("sessions",Math.floor(r/t*100)),g.set("twoQ",Math.floor(u/t*100))},p.cleanOldNews=function(){var t=new Date,n=d.get("news"),r,i,s=new c;if(n.length){for(r=n.length-1;r>=0;r--)i=new Date(n[r].date[0],n[r].date[1],n[r].date[2]),t.getTime()-i.getTime()>1296e6&&n.splice(r,1);d.set("news",n),d.upload().then(function(){s.fulfill()})}return s},p.init=function(){p.checkProfileCompletion().then(function(){return p.updateGrade()}).then(function(){return p.updateAchievements()}).then(function(){p.updateProgressBar(),p.cleanOldNews()})},p.reset=function(){w.reset([]),w.reset(d.get("news")),p.init()},p.init(),p}}),define("dashboard/settings/settings",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","CouchDBBulkDocuments"],function(e,t,n,r,i,s,o,u){return function(){var f=new e,l=i.get("labels"),c=[{name:l.get("public"),dest:"#public"},{name:l.get("library"),dest:"#library"},{name:l.get("brainstorm"),dest:"#brainstorm"},{name:l.get("connect"),dest:"#connect"},{name:l.get("dashboard"),dest:"#dashboard"}],h=[{name:l.get("everymin"),value:6e4},{name:l.get("everyfive"),value:3e5},{name:l.get("everyfifteen"),value:9e5},{name:l.get("never"),value:864e5}],p=new s({screens:c,timers:h,pwd:"",pwdbis:"",lang:[],pwdchange:""}),d=new s,v=i.get("transport"),m=i.get("user");return f.plugins.addAll({label:new n(l),options:new n(p,{setLang:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t]+"</option>";this.innerHTML=r,this.selectedIndex=e.indexOf(m.get("lang"))},setStartupScreen:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].name+"</option>",e[t].dest===m.get("settings").startupScreen&&(s=t);this.innerHTML=r,this.selectedIndex=s},setPollingInterval:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].name+"</option>",e[t].value===m.get("settings").polling_interval&&(s=t);this.innerHTML=r,this.selectedIndex=s},setDecks:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].title+"</option>",e[t].id===m.get("active_deck")&&(s=t);this.innerHTML=r,this.selectedIndex=s}}),settings:new n(d),settingsevent:new r(f)}),f.template='<div id="dashboard-settings"><div class="header blue-dark"><span data-label="bind:innerHTML, settingslbl"></span></div><div class="settingscontent"><div class="settingmodule"><legend data-label="bind:innerHTML, userpref"></legend><ul><li><span data-label="bind:innerHTML, setlang"></span><select data-options="bind:setLang, lang" data-settingsevent="listen: change, updateLang"></select></li><li class="startupscreen"><span data-label="bind: innerHTML, choosestartup"></span><select data-options="bind:setStartupScreen, screens" data-settingsevent="listen: change, updateStartup"></select></li><li class="startupscreen"><span data-label="bind: innerHTML, choosepolling"></span><select data-options="bind:setPollingInterval, timers" data-settingsevent="listen: change, updatePollingInterval"></select></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, showTips" data-settingsevent="listen: change, showTips"><label data-label="bind:innerHTML, showtips"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, notifyPopup" data-settingsevent="listen: change, showNotif"><label data-label="bind:innerHTML, shownotif"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, useascharacter" data-settingsevent="listen: change, useAsChar"><label data-label="bind:innerHTML, usechar"></label></li><li><span data-label="bind: innerHTML, changepwd"></span><input class="input" type="password" data-label="bind:placeholder, passwordplaceholder" data-options="bind: value, pwd" data-settingsevent="listen: input, clearOK"><input class="input" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-options="bind: value, pwdbis" data-settingsevent="listen: input, clearOK"><span class="changeok" data-options="bind: innerHTML, pwdchange"></span><div class="next-button" data-label="bind:innerHTML, changelbl" data-settingsevent="listen: mousedown, press; listen:mouseup, changePWD"></div></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, brainstormsettings"></legend><ul><li class="activedeck"><span data-label="bind:innerHTML, setdeck">Set brainstorming deck</span><select data-options="bind:setDecks, decks" data-settingsevent="listen: mousedown, getDecks;listen: change, updateDeck"></select></li></ul></div></div></div>',f.place(t.get("dashboard-settings")),f.updateLang=function(t,n){n.value!==m.get("lang")&&o.updateLabels(n.value).then(function(){m.set("lang",n.value),m.upload(),p.set("timers",[{name:l.get("everymin"),value:6e4},{name:l.get("everyfive"),value:3e5},{name:l.get("everyfifteen"),value:9e5},{name:l.get("never"),value:864e5}]),p.set("screens",[{name:l.get("public"),dest:"#public"},{name:l.get("library"),dest:"#library"},{name:l.get("brainstorm"),dest:"#brainstorm"},{name:l.get("connect"),dest:"#connect"},{name:l.get("dashboard"),dest:"#dahsboard"}])})},f.getDecks=function(){var t=new u,n=m.get("taiaut_decks").concat(m.get("custom_decks")),r=[];t.setTransport(i.get("transport")),t.sync(i.get("db"),{keys:n}).then(function(){p.set("decks",[]),t.loop(function(e,t){var n=e.doc.content;n.characters.length>=2&&n.contexts.length>=2&&n.problems.length>=2&&n.techno.length>=4&&r.push({id:e.doc._id,title:e.doc.title})}),t.unsync(),r.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),p.set("decks",r)})},f.updateDeck=function(t,n){var r=n.selectedIndex,i=p.get("decks")[r].id;m.set("active_deck",i),m.upload()},f.updateStartup=function(t,n){var r=n.selectedIndex,i=m.get("settings");i.startupScreen=c[r].dest,m.set("settings",i),m.upload()},f.updatePollingInterval=function(t,n){var r=n.selectedIndex,i=m.get("settings");i.polling_interval=h[r].value,m.set("settings",i),m.upload()},f.showTips=function(e,t){var n=m.get("settings");n.showTips=t.checked,m.set("settings",n),m.upload().then(function(){console.log("upload successful")})},f.showNotif=function(e,t){var n=m.get("settings");n.notifyPopup=t.checked,m.set("settings",n),m.upload()},f.useAsChar=function(e,t){var n=m.get("settings");n.useascharacter=t.checked,m.set("settings",n),m.upload()},f.press=function(e,t){t.classList.add("pressed")},f.clearOK=function(e,t){p.set("pwdchange","")},f.changePWD=function(e,t){t.classList.remove("pressed"),p.get("pwd")!==p.get("pwdbis")?p.set("pwdbis",""):v.request("ChangePWD",{userid:m.get("_id"),pwd:p.get("pwd")},function(e){e==="ok"&&p.set("pwdchange","&#10003;")})},f.reset=function(){d.reset(m.get("settings")),m.watchValue("settings",function(e){d.reset(m.get("settings"))}),f.getDecks(),v.request("GetLanguages",{},function(e){p.set("lang",e)}),p.set("timers",[{name:l.get("everymin"),value:6e4},{name:l.get("everyfive"),value:3e5},{name:l.get("everyfifteen"),value:9e5},{name:l.get("never"),value:864e5}]),p.set("screens",[{name:l.get("public"),dest:"#public"},{name:l.get("library"),dest:"#library"},{name:l.get("brainstorm"),dest:"#brainstorm"},{name:l.get("connect"),dest:"#connect"},{name:l.get("dashboard"),dest:"#dahsboard"}])},f.reset(),o.updateLabels(m.get("lang")),f}}),define("dashboard/about/aboutideafy",["OObject","service/config","Bind.plugin","Store"],function(e,t,n,r){return function(){var s=new e,o=t.get("labels"),u=new r([{name:o.get("solene"),contrib:o.get("contribsolene")},{name:o.get("oliviers"),contrib:o.get("contribscherrer")},{name:o.get("olivierw"),contrib:o.get("contribwietrich")},{name:o.get("vincent"),contrib:o.get("contribvincent")}]);return s.plugins.addAll({labels:new n(o),credits:new n(u)}),s.template='<div class="aboutcontent"><legend data-labels="bind:innerHTML, aboutlbl"></legend><p data-labels="bind:innerHTML, ideafydesc"></p><legend data-labels="bind:innerHTML, about-taiaut"></legend><p data-labels="bind:innerHTML, taiautdesc"></p><legend data-labels="bind: innerHTML, credits"></legend><p><ul data-credits="foreach"><li><span class="contributor" data-credits="bind:innerHTML, name"></span><span class="contribution" data-credits="bind:innerHTML, contrib"></span></li></ul></p></div>',s}}),define("dashboard/about/faq",["OObject","service/config","CouchDBView","Bind.plugin","Event.plugin","Store"],function(e,t,n,r,i,s){return function(){var u=new e,a=new n,f=t.get("user");return faqlist=new s([]),u.plugins.addAll({faq:new r(faqlist),faqevent:new i(u)}),u.template='<div class="aboutcontent"><ul data-faq="foreach"><li><legend data-faq="bind:innerHTML, question"></legend><p data-faq="bind: innerHTML, response"></p></li></ul></div>',a.setTransport(t.get("transport")),u.fetch=function(n){a.unsync(),a.reset([]),faqlist.reset([]),a.sync(t.get("db"),"about","_view/faq").then(function(){a.loop(function(e,t){e.value.default_lang===n||!e.value.translations[n]?faqlist.alter("push",e.value):faqlist.alter("push",e.value.translations[n])})})},u.fetch(f.get("lang")),f.watchValue("lang",function(){u.fetch(f.get("lang"))}),u}}),define("dashboard/about/userguide",["OObject","service/config","CouchDBView","Bind.plugin","Event.plugin","Store"],function(e,t,n,r,i,s){return function(){var u=new e,a=new n,f=t.get("user"),l=t.get("labels"),c=new s([]);return u.plugins.addAll({label:new r(l),howto:new r(c),howtoevent:new i(u)}),u.template='<div class="aboutcontent"><div id="userguidetoc"><legend data-label="bind:innerHTML, toc"></legend><ul data-howto="foreach"><li><span data-howto="bind: innerHTML, title" data-howtoevent="listen: mousedown, press; listen:touchend, goto"></span></li></ul></div><br/><ul data-howto="foreach"><li data-howto="bind:id, _id"><legend data-howto="bind:innerHTML, title"></legend><p data-howto="bind: innerHTML, body"></p><span class="backtotop" data-label="bind:innerHTML, backtotop" data-howtoevent="listen: mousedown, backToTop"></span></li></ul></div>',u.press=function(e,t){t.setAttribute("style","font-weight: bold;")},u.goto=function(e,t){var n=t.getAttribute("data-howto_id"),r=c.get(n)._id;t.setAttribute("style","font-weight: normal;"),document.getElementById(r).scrollIntoView()},u.backToTop=function(e,t){document.getElementById("userguidetoc").scrollIntoView()},a.setTransport(t.get("transport")),u.fetch=function(n){a.unsync(),a.reset([]),c.reset([]),a.sync(t.get("db"),"about","_view/howto").then(function(){a.loop(function(e,t){e.value.default_lang===n||!e.value.translations[n]?c.alter("push",e.value):c.alter("push",e.value.translations[n])})})},u.fetch(f.get("lang")),f.watchValue("lang",function(){u.fetch(f.get("lang"))}),u}}),define("dashboard/about/tutorials",["OObject","service/config","Bind.plugin","Store"],function(e,t,n,r){return function(){var s=new e,o=t.get("labels"),u=[{name:"brainstormtutorial",src:"http://37.153.96.26:1664/tuto04.m4v"}],a=new r(u);return s.plugins.addAll({labels:new n(o),tuto:new n(a,{setName:function(e){this.innerHTML=o.get(e)}})}),s.template='<div class="aboutcontent"><ul data-tuto="foreach"><li><legend data-tuto="bind: setName, name"></legend><div class="videocontent"><video width = "640" height="480" controls="controls"><source data-tuto="bind:src,src" type="video/mp4" /></video></div></li></ul></div>',s}}),define("dashboard/about/support",["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBDocument"],function(e,t,n,r,i,s){return function(){var u=new e,a=t.get("labels"),f=t.get("user"),l=new i({body:"",result:""}),c=new i({}),h=new i({}),p=new s,d=new s;return p.setTransport(t.get("transport")),d.setTransport(t.get("transport")),u.plugins.addAll({labels:new n(a),support:new n(l),news:new n(c,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),maintenance:new n(h,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){this.innerHTML=(new Date(e)).toString()}}),supportevent:new r(u)}),u.template='<div class="aboutcontent"><p class="supportmsg invisible" data-news="bind:setVisible, active; bind:innerHTML, content"></p><legend class="support" data-labels="bind:innerHTML, supportlegend"></legend><textarea class="input" data-labels="bind:placeholder, supportplaceholder" data-support="bind: value, body"></textarea><span data-support="bind:innerHTML, result"></span><div class="cancel" data-labels="bind: innerHTML, cancellbl" data-supportevent="listen: mousedown, press; listen: mouseup, cancel"></div><div class="send" data-labels="bind: innerHTML, sendlbl" data-supportevent="listen: mousedown, press; listen: mouseup, send"></div><div class="maintenancemsg invisible" data-maintenance="bind:setVisible,active"><legend data-labels="bind:innerHTML, schedmaintenance"></legend><p><span data-labels="bind: innerHTML, nextmaintenance"></span><span class="dateandtime" data-maintenance="bind:setDate, date">Sunday April 7th 6:00 EST</span><br/><span data-maintenance="bind:innerHTML, comment"></span></p></div><div class="supportus"><legend data-labels="bind: innerHTML, twoway"></legend><p data-labels="bind: innerHTML, supportusintro"><ul><li><h4 data-labels="bind: innerHTML, asanideafyer"></h4><p data-labels="bind: innerHTML, ideafyerhelp"></p></li><li><h4 data-labels="bind: innerHTML, asanexec"></h4><p data-labels="bind: innerHTML, exechelp"></p></li><li><h4 data-labels="bind: innerHTML, asadev"></h4><p data-labels="bind: innerHTML, devhelp"></p></li><li><h4 data-labels="bind: innerHTML, asaninvest"></h4><p data-labels="bind: innerHTML, investhelp"></p></li></ul></p></div></div>',u.send=function(e,t){t.classList.remove("pressed"),u.sendRequest(l.get("body"))},u.cancel=function(e,t){t.classList.remove("pressed"),l.set("body","")},u.press=function(e,t){t.classList.add("pressed")},u.sendRequest=function(n){var r={},i=new Date;r.request=n,r.date=i.getTime(),r.userid=t.get("user").get("_id"),t.get("transport").request("Support",r,function(e){e==="ok"?l.set("result",a.get("requestsent")):l.set("result",e),setTimeout(function(){l.set("result",""),l.set("body","")},3e3)})},u.setSupportMSG=function(t){p.get("lang")===t||!p.get("translations")[t]?c.reset(JSON.parse(p.toJSON())):c.reset(p.get("translations")[t])},u.setMaintenanceMSG=function(t){d.get("lang")===t||!d.get("translations")[t]?h.reset(JSON.parse(d.toJSON())):h.reset(d.get("translations")[t])},p.sync(t.get("db"),"SUPPORTMSG").then(function(){u.setSupportMSG(f.get("lang"))}),d.sync(t.get("db"),"MAINTENANCE").then(function(){u.setMaintenanceMSG(f.get("lang"))}),f.watchValue("lang",function(){u.setSupportMSG(f.get("lang"),"SUPPORTMSG"),u.setMaintenanceMSG(f.get("lang"),"MAINTENANCE")}),p.watchValue("active",function(){u.setSupportMSG(f.get("lang"))}),d.watchValue("active",function(){u.setMaintenanceMSG(f.get("lang"))}),u}}),define("dashboard/about/eula",["OObject","service/config","Bind.plugin","CouchDBDocument","Store"],function(e,t,n,r,i){return function(){var o=new e,u=t.get("user"),a=new i;return o.plugins.add("eula",new n(a)),o.template='<div class="aboutcontent"><h4 data-eula = "bind:innerHTML, title"></h4><div data-eula="bind:innerHTML, body"></div></div>',o.fetch=function(n){var i=new r;i.setTransport(t.get("transport")),i.sync(t.get("db"),"EULA").then(function(){i.get("default_lang")===n||!i.get("translations")[n]?(a.set("title",i.get("title")),a.set("body",i.get("body"))):(a.set("title",i.get("translations")[n].title),a.set("body",i.get("translations")[n].body))})},o.fetch(u.get("lang")),u.watchValue("lang",function(){o.fetch(u.get("lang"))}),o}}),define("dashboard/about/about",["OObject","service/map","Bind.plugin","Event.plugin","Amy/Stack-plugin","service/config","Store","./aboutideafy","./faq","./userguide","./tutorials","./support","./eula"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(){var d=new e,v=new i,m=s.get("labels"),g=[{name:"#about",label:m.get("aboutIdeafy"),currentUI:!1},{name:"#faq",label:m.get("faq"),currentUI:!1},{name:"#userguide",label:m.get("userguide"),currentUI:!1},{name:"#tutorials",label:m.get("tutorials"),currentUI:!1},{name:"#support",label:m.get("support"),currentUI:!1},{name:"#eula",label:m.get("eula"),currentUI:!1}],y=new o(g);return d.plugins.addAll({label:new n(m),aboutmenu:new n(y,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),aboutstack:v,aboutevent:new r(d)}),d.template='<div id="dashboard-about"><div class="header blue-dark"><span data-label="bind:innerHTML, aboutlbl"></span></div><div class = "progressbar"><ul id = "aboutmenu" class="steplist" data-aboutmenu="foreach"><li class="step" data-aboutmenu="bind: innerHTML, label; bind:setCurrent, currentUI" data-aboutevent="listen: mousedown, changeDisplay"></li></ul></div><div id="aboutstack" data-aboutstack="destination"></div></div>',d.place(t.get("dashboard-about")),d.changeDisplay=function(t,n){var r=n.getAttribute("data-aboutmenu_id");d.show(y.get(r).name)},d.show=function(t){var n;y.loop(function(e,r){y.update(r,"currentUI",!1),e.name===t&&(n=r)}),y.update(n,"currentUI",!0),v.getStack().show(y.get(n).name)},v.getStack().add("#about",new u),v.getStack().add("#faq",new a),v.getStack().add("#userguide",new f),v.getStack().add("#tutorials",new l),v.getStack().add("#support",new c),v.getStack().add("#eula",new h),v.getStack().show("#about"),y.update(0,"currentUI",!0),d}}),define("dashboard/dashboard",["OObject","service/map","service/submenu","Amy/Stack-plugin","./profile/profile","./settings/settings","./about/about","service/config"],function(e,t,n,r,i,s,o,u){return function(){var f=new e,l=new r,c,h,p,d=u.get("observer"),v=function(t){l.getStack().show(t)},m;return f.plugins.add("dashboardstack",l),f.template='<div id="dashboard"><div id="dashboard-menu"></div><div class="stack" data-dashboardstack="destination"></div></div>',f.place(t.get("dashboard")),f.showMenu=function(){m.toggleActive(!0)},f.hideMenu=function(){m.toggleActive(!1)},f.reset=function(){m.reset(),c.reset(),h.reset()},m=new n(f.dom.querySelector("#dashboard-menu"),v),m.toggleActive(!1),c=new i,h=new s,p=new o,l.getStack().add("#profile",c),l.getStack().add("#settings",h),l.getStack().add("#about",p),l.getStack().show("#profile"),u.get("observer").watch("display-tutorials",function(){m.setWidget("#about"),l.getStack().get("#about").show("#tutorials")}),u.get("observer").watch("show-about",function(){m.setWidget("#about"),l.getStack().get("#about").show("#userguide")}),f}}),define("notify",["OObject","service/config","service/map","Store","Bind.plugin","Place.plugin","Event.plugin","service/avatar"],function(e,t,n,r,s,o,u,a){return function(){var f=new e,c=new e,h=t.get("user"),p=t.get("observer"),d=t.get("labels"),v=0,m=0,g=!0,y=new r({unread:0,newmsg:!1}),b=new r([]);return f.plugins.addAll({notif:new s(y,{flashNew:function(e){var t,n=this;e&&(t=setInterval(function(){n.classList.contains("orange")?n.classList.remove("orange"):n.classList.add("orange")},600),setTimeout(function(){clearInterval(t),n.classList.remove("orange"),y.set("newmsg",!1)},3e3))}}),place:new o({notifyPopup:c}),notifevent:new u(f)}),f.template='<div><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: mousedown, push; listen:mouseup, showPopup"></div><div class = "signout-bubble" data-notifevent="listen:mousedown, signout"></div><div class = "info-bubble" data-notifevent="listen:mousedown, press; listen:mouseup, showAbout">i</div><div id="notify-popup" data-place="place:notifyPopup"></div></div>',f.getUnread=function(){var t=h.get("notifications"),n=0;for(i=0,l=t.length;i<l;i++)t[i].status==="unread"&&n++;return n},f.push=function(e,t){t.classList.add("orange"),e.stopPropagation()},f.press=function(e,t){t.classList.add("pressed")},f.showPopup=function(e,t){t.classList.remove("orange"),c.showPopup()},f.signout=function(n,r){document.getElementById("cache").classList.add("appear"),document.getElementById("dock").querySelector(".selected").classList.remove("selected"),document.querySelector('a[href="#public"]').classList.add("selected"),t.get("observer").notify("signout")},f.showAbout=function(e,n){n.classList.remove("pressed"),t.get("observer").notify("goto-screen","#dashboard"),t.get("observer").notify("show-about")},c.plugins.addAll({labels:new s(d),notify:new s(b,{setObject:function(e){var t=this.getAttribute("data-notify_id");if(e)switch(e){case"CXR":this.innerHTML=b.get(t).username+d.get("CXRobject");break;case"INV":this.innerHTML=b.get(t).username+d.get("INVObject");break;case"CXRaccept":this.innerHTML=b.get(t).username+d.get("acceptedCXR");break;case"CXRreject":this.innerHTML=b.get(t).username+d.get("rejectedCXR");break;case"CXCancel":this.innerHTML=b.get(t).username+d.get("canceledCX");break;case"DOC":this.innerHTML=b.get(t).username+d.get("sentdocmsg");break;case"2Q+":this.innerHTML=b.get(t).username+d.get("askednew");break;case"2C+":this.innerHTML=b.get(t).username+d.get("senttc");break;case"REF":this.innerHTML=b.get(t).username+d.get("joinedideafy");break;default:this.innerHTML=b.get(t).object}},setStyle:function(e){e==="unread"?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setAvatar:function(e){var t,n,r=this;e&&(t=document.createDocumentFragment(),n=new a([e]),n.place(t),r.firstChild?r.replaceChild(t,r.firstChild):r.appendChild(t))}}),notifyevent:new u(c)}),c.template='<div class="invisible"><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:mousedown, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:mousedown, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:innerHTML, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>',c.closePopup=function(t,n){c.dom.classList.add("invisible")},c.showPopup=function(t,n){c.dom.classList.remove("invisible")},c.displayComCenter=function(t,n){var r=n.getAttribute("data-notify_id");p.notify("display-message",r)},p.watch("display-message",function(){c.closePopup()}),f.init=function(){f.reset(),c.dom.classList.add("invisible")},f.reset=function(){m=f.getUnread(),y.set("unread",m),y.set("newmsg",!1),b.reset(h.get("notifications"))},h.watchValue("notifications",function(){var e=f.getUnread();b.reset([]),e>m?(y.set("newmsg",!0),y.set("unread",e),m=e,h.get("settings")&&h.get("settings").notifyPopup&&popup.classList.add("show-notify")):e<m&&(y.set("unread",e),m=e),b.reset(h.get("notifications"))}),f}}),define("service/newidea",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var a=new e,f=new s(i.get("ideaTemplate")),l=i.get("user"),c=i.get("labels"),h=new s({error:""}),p=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return f.setTransport(i.get("transport")),a.plugins.addAll({newidea:new n(f,{setVisibility:function(e){e==="public"?(this.innerHTML=c.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=c.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){e==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),labels:new n(c),errormsg:new n(h,{setError:function(e){switch(e){case"notitle":this.innerHTML=c.get("titlefield")+c.get("emptyfielderror");break;case"nodesc":this.innerHTML=c.get("descriptionfield")+c.get("emptyfielderror");break;case"nosol":this.innerHTML=c.get("solutionfield")+c.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new r(a)}),a.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',a.render(),a.place(t.get("newidea-popup")),a.toggleVisibility=function(e,t){t.value==="1"?f.set("visibility","private"):f.set("visibility","public")},a.press=function(e,t){t.classList.add("pressed"),a.dom.querySelector(".publicwarning").classList.add("invisible")},a.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.unsync(),f.reset(i.get("ideaTemplate")),h.reset({error:""}),a.dom.querySelector(".visibility-slider").value=1},a.resetError=function(e,t){var n;t.scrollTop=99999,h.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",h.get("error")===n&&t.value&&h.set("error",""))},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,t){var n=new Date,r="I:"+n.getTime(),s;t.classList.remove("pressed"),f.get("title")?f.get("description")?f.get("solution")||h.set("error","nosol"):h.set("error","nodesc"):h.set("error","notitle"),!h.get("error")&&!f.get("_id")&&(t.classList.add("invisible"),p.spin(t.parentNode),s=setInterval(function(){h.get("error")===c.get("uploadinprogress")?h.set("error",c.get("uploadinprogress")+"..."):h.set("error",c.get("uploadinprogress"))},100),f.set("authors",[l.get("_id")]),f.set("authornames",l.get("username")),f.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),f.set("lang",l.get("lang")),f.sync(i.get("db"),r).then(function(){return f.upload()}).then(function(){f.get("visibility")==="public"?i.get("transport").request("UpdateUIP",{userid:l.get("_id"),type:f.get("type"),docId:r,docTitle:f.get("title")},function(e){e!=="ok"&&console.log(e),p.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s)}):(p.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s))}))},a}}),define("service/new2q",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=new s(i.get("TQTemplate")),l=i.get("user"),c=i.get("labels"),h=140,p=new s({error:""}),d=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return f.setTransport(i.get("transport")),a.plugins.addAll({new2q:new n(f,{setLength:function(e){e===10&&this.setAttribute("maxlength",h)}}),labels:new n(c),errormsg:new n(p,{setError:function(e){switch(e){case"noquestion":this.innerHTML=c.get("noquestion");break;case"lengthexceeded":this.innerHTML=c.get("lengthexceeded")+" ("+h+c.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new r(a)}),a.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',a.render(),a.place(t.get("new2q-popup")),a.press=function(e,t){t.classList.add("pressed")},a.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.unsync(),f.reset(i.get("TQTemplate")),p.reset({error:""})},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,t){var n=new Date,r,s="Q:"+n.getTime();t.classList.remove("pressed"),f.get("question")||p.set("error","noquestion"),!p.get("error")&&!f.get("_id")&&(t.classList.add("invisible"),d.spin(t.parentNode),r=setInterval(function(){p.get("error")===c.get("uploadinprogress")?p.set("error",c.get("uploadinprogress")+"..."):p.set("error",c.get("uploadinprogress"))},150),f.set("author",l.get("_id")),f.set("username",l.get("username")),f.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),f.set("lang",l.get("lang")),f.sync(i.get("db"),s).then(function(){return f.upload()}).then(function(){i.get("transport").request("UpdateUIP",{userid:l.get("_id"),type:f.get("type"),docId:s,question:f.get("question")},function(e){var o,u=l.get("connections"),h=u.length,v=[],m={type:"2Q+",docId:s,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:l.get("_id"),username:l.get("username"),firstname:l.get("firstname"),toList:"",ccList:"",object:l.get("username")+c.get("askednew"),body:f.get("question"),signature:""};e!=="ok"&&console.log(e),clearInterval(r),r=setInterval(function(){p.get("error")===c.get("notifyingcontacts")?p.set("error",c.get("notifyingcontacts")+"..."):p.set("error",c.get("notifyingcontacts"))},150);for(o=0;o<h;o++)u[o].type==="user"&&v.push(u[o].userid);m.dest=v,i.get("transport").request("Notify",m,function(e){var e=JSON.parse(e);console.log(e)}),d.stop(),t.classList.remove("invisible"),a.closePopup()})}))},a.checkLength=function(e,t){t.value.length>=h?p.set("error","lengthexceeded"):p.set("error","")},a}}),define("service/tips",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBView"],function(e,t,n,r,i,s,o){return function(a){var f=new e,l=i.get("labels"),c=new o([]),h=i.get("user"),p=[],d=new s([]),v=new s({});return c.setTransport(i.get("transport")),f.plugins.addAll({labels:new n(l),tip:new n(v,{setTitle:function(e){e==="TIP:0"?this.innerHTML=l.get("signupwelcomeobject"):this.innerHTML=l.get("dyknow")}}),tipevent:new r(f)}),f.template='<div><div class="help-doctor"></div><div class="close-tip" data-tipevent="listen:mousedown, close"></div><div class="tip-screen"><legend data-tip="bind:setTitle, id"></legend><p data-tip = "bind: innerHTML, body"></p><div class="next-button" data-labels = "bind: innerHTML, nextbutton" data-tipevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="tip-footer"><input type="checkbox" data-tipevent="listen: change, doNotShow"><label data-labels="bind: innerHTML, notips"></label></div></div>',f.init=function(n){c.sync(i.get("db"),"about","_view/tip").then(function(){var e=h.get("lang");c.loop(function(t,n){var r=t.value;r.default_lang===e||!r.translations[e]?d.alter("push",{id:r._id,title:r.title,body:r.body}):d.alter("push",{id:r._id,title:r.translations[e].title,body:r.translations[e].body})}),n?v.reset(d.get(0)):(d.alter("splice",0,1),f.getRandomTip()),f.place(t.get("tip-popup")),document.getElementById("tip-popup").classList.add("visible"),document.getElementById("cache").classList.add("visible")})},f.getRandomTip=function(){var t=d.getNbItems(),n=Math.floor(Math.random()*t);t===0?f.close():(v.reset(d.get(n)),d.alter("splice",n,1))},f.press=function(e,t){t.classList.add("pressed")},f.next=function(e,t){t.classList.remove("pressed"),f.getRandomTip()},f.close=function(e,t){document.getElementById("tip-popup").classList.remove("visible"),document.getElementById("cache").classList.remove("visible")},f.doNotShow=function(e,t){var n;t.setAttribute("readonly","readonly"),t.checked===h.get("settings").showTips&&(n=h.get("settings"),n.showTips=!t.checked,h.set("settings",n),h.upload().then(function(){t.removeAttribute("readonly")}))},f}}),define("dock",["OObject","Place.plugin","Amy/Stack-plugin","Amy/Control-plugin","public/public","library/library","brainstorm/brainstorm","connect/connect","dashboard/dashboard","service/map","service/config","./notify","service/newidea","service/help","service/new2q","service/new2c","service/tips"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return function(){var v=new e,g,y,b,w=new c,E,S,x,T,N,C=new r(this),k=l.get("observer"),L=l.get("user"),A=new n;return v.plugins.addAll({dockstack:A,dockcontrol:C,place:new t({notify:w})}),v.template='<div id="wrapper"><nav id="dock" data-dockcontrol="radio:a,selected,mousedown,setCurrentWidget"><a class="dock-item selected" href="#public" data-dockcontrol="init"></a><a class="dock-item" href="#library"></a><a class="dock-item" href="#brainstorm"></a><a class="dock-item" href="#connect"></a><a class="dock-item" href="#dashboard"></a></nav><div class="stack" data-dockstack="destination"></div><div id="notify" data-place="place:notify"></div></div>',v.place(f.get("dock")),v.init=function(){E=new i,console.log("public ok"),S=new s,console.log("library ok"),x=new o,console.log("brainstorm ok"),T=new u,console.log("connect ok"),N=new a,console.log("dashboard ok"),A.getStack().add("#public",E),A.getStack().add("#library",S),A.getStack().add("#brainstorm",x),A.getStack().add("#connect",T),A.getStack().add("#dashboard",N),w.init(),g=new h,y=new d,b=new m},v.start=function(t){var n=v.dom.querySelector('a[href="#public"]'),r=v.dom.querySelector("a.selected"),i=v.dom.querySelector('a[href="'+L.get("settings").startupScreen+'"]');L.get("settings").startupScreen?(C.radioClass(i,r,"selected"),C.init(i),A.getStack().show(L.get("settings").startupScreen)):(r!==n&&(C.radioClass(n,r,"selected"),C.init(n)),A.getStack().show("#public")),(t||L.get("settings").showTips!==!1)&&b.init(t)},v.reset=function(){E.reset(),S.reset(),x.reset(),T.reset(),N.reset(),w.reset()},this.setCurrentWidget=function(e){var t=e.target.getAttribute("href"),n=3e3;e.preventDefault(),t!==A.getStack().getCurrentName()?(A.getStack().getCurrentScreen().hideMenu(),A.getStack().show(t),A.getStack().getCurrentScreen().showMenu(),setTimeout(function(){A.getStack().getCurrentScreen().hideMenu()},n)):A.getStack().getCurrentScreen().showMenu()},k.watch("replay-session",function(e,t){var n=document.querySelector(".dock-item.selected"),r=document.querySelector(".dock-item[href='#brainstorm']");A.getStack().show("#brainstorm"),C.radioClass(r,n,"selected"),C.init(r)}),k.watch("display-doc",function(){var e=document.querySelector(".dock-item.selected"),t=document.querySelector(".dock-item[href='#library']");A.getStack().show("#library"),C.radioClass(t,e,"selected"),C.init(t)}),k.watch("display-message",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#connect']");A.getStack().show("#connect"),C.radioClass(n,t,"selected"),C.init(n)}),k.watch("display-tutorials",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#dashboard']");A.getStack().show("#dashboard"),C.radioClass(n,t,"selected"),C.init(n)}),k.watch("join-musession",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#brainstorm']");A.getStack().getCurrentName()!=="#brainstorm"&&(A.getStack().show("#brainstorm"),C.radioClass(n,t,"selected"),C.init(n))}),k.watch("goto-screen",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='"+e+"']");A.getStack().getCurrentName()!==e&&(A.getStack().show(e),C.radioClass(n,t,"selected"),C.init(n))}),v}}),define("login",["OObject","Amy/Stack-plugin","service/map","Event.plugin","service/config","Bind.plugin","Store","lib/spin.min","Promise","CouchDBDocument"],function(e,t,n,r,i,s,o,u,a,f){return function(c,h,p){var d=new e,v=new e,m=new e,g=new e,y=new e,b=new e,w=new t,E=new o({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),S=i.get("labels"),x=i.get("transport"),T=i.get("db"),N,C=(new u({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270})).spin(),k=!1;return d.plugins.addAll({loginstack:w}),g.plugins.add("label",new s(S)),g.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>',g.place(document.getElementById("loading")),y.plugins.add("label",new s(S)),y.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p><div id="loadingspin"></div></div>',b.plugins.add("label",new s(S)),b.template='<div id="nointernt"><p data-label="bind: innerHTML, nointernet"></p><div id="loadingspin"></div></div>',m.plugins.addAll({label:new s(S),loginmodel:new s(E),signupevent:new r(m)}),m.template='<form id="signup-form"><p class="login-fields"><input data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:keypress, resetError; listen:keypress, entersignup"></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, signup"></label></p><p><label class="login-button pressed-btn" name="#login-screen" data-signupevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form>',m.press=function(e,t){t.classList.add("pressed")},m.release=function(e,t){t.classList.remove("pressed")},m.entersignup=function(e,t){e.keyCode===13&&(e.target.blur(),m.signup())},m.showLogin=function(e,t){w.getStack().show("#login-screen")},m.resetError=function(e,t){E.set("error","")},m.signup=function(t,n){var r=E.get("email"),s=E.get("password"),o=E.get("confirm-password"),u=E.get("firstname"),l=E.get("lastname"),d=new a,v=new f;if(r==="")E.set("error",S.get("signupmissingemail"));else if(s==="")E.set("error",S.get("signupmissingpwd"));else if(o==="")E.set("error",S.get("signupmissingpwdok"));else if(u==="")E.set("error",S.get("signupmissingfn"));else if(l==="")E.set("error",S.get("signupmissingln"));else{var g=r.toLowerCase(),y=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;y.test(g)?s!==o?E.set("error",S.get("signuppwdnomatch")):(C.spin(m.dom),x.request("Signup",{name:g,password:s,fn:u,ln:l,lang:i.get("lang")},function(e){if(e.signup==="ok"){v.reset(i.get("userTemplate")),v.set("firstname",u),v.set("lastname",l),v.set("username",u+" "+l),v.set("lang",i.get("lang"));var t=new Date;v.set("notifications",[{type:"MSG",toList:u+" "+l,date:[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],object:S.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:S.get("signupwelcomebody")}]),x.request("Welcome",{userid:g,language:v.get("lang")},function(e){console.log(e)}),e.db&&p.set("db",e.db),v.setTransport(x),v.sync(e.db,g).then(function(){return v.upload()}).then(function(){p.set("currentLogin",g),p.set("userAvatar",v.get("picture_file")),p.sync("ideafy-data"),i.set("uid",'"'+g+'"'),v.unsync(),k?h(!0):c(!0)})}else E.set("error","error : "+e.message),E.set("email",""),C.stop()},this)):E.set("error",S.get("signupinvalidemail"))}},v.plugins.addAll({label:new s(S),loginmodel:new s(E),loginevent:new r(v)}),v.template='<form id="login-form"><p class="login-fields"><input data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: keypress, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:mousedown, press; listen: mouseup, release; listen:mouseup, login"></label></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup-button" class="pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showSignup"></label></p></form>',v.press=function(e,t){t.classList.add("pressed")},v.release=function(e,t){t.classList.remove("pressed")},v.enterlogin=function(e,t){e.keyCode===13&&(e.target.blur(),v.login())},v.showSignup=function(e,t){w.getStack().show("#signup-screen")},v.resetError=function(e,t){E.set("error","")},v.login=function(t,n){var r=E.get("email").toLowerCase(),s=E.get("password");r&&s?(C.spin(v.dom),x.request("Login",{name:r,password:s},function(e){e.login==="ok"?(i.set("uid",'"'+r+'"'),e.db&&p.set("db",e.db),p.set("currentLogin",r),x.request("GetAvatar",{id:r},function(e){e.error||(p.set("userAvatar",e),p.sync("ideafy-data"),i.set("avatar",e)),k?h():c()})):(E.set("error",S.get("invalidlogin")),C.stop())})):E.set("error",S.get("invalidlogin"))},w.getStack().add("#login-screen",v),w.getStack().add("#signup-screen",m),w.getStack().add("#loading-screen",g),w.getStack().add("#maintenance-screen",y),w.getStack().add("#nointernet",b),d.alive(n.get("login")),d.init=function(){w.getStack().show("#loading-screen"),N=(new u({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin(document.getElementById("loadingspin"))},d.setScreen=function(t){w.getStack().show(t)},d.reset=function(t){E.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),t&&(k=!0)},d.stopSpinner=function(){C&&C.stop(),N&&N.stop()},d}}),require(["OObject","LocalStore","service/map","Amy/Stack-plugin","Bind.plugin","Amy/Delegate-plugin","./dock","./login","service/config","service/utils","Promise"],function(e,t,n,r,i,s,o,u,a,f,l){var c=new e,h=null,p=new r({"#login":h}),d=new o,v=new t,m=f.updateLabels,g=f.checkServerStatus,y=a.get("labels"),b=a.get("db"),w=a.get("transport"),E=a.get("user"),S;S="1.1.3",c.plugins.addAll({stack:p}),c.init=function(t){p.getStack().add("#dock",d),v.get("db")&&v.get("db")!==b&&(b=v.get("db")),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.init(),h.stopSpinner(),p.getStack().show("#dock"),d.start(t)})},c.reload=function(t){E.unsync(),E.reset(),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.reset(),h.stopSpinner(),p.getStack().show("#dock"),d.start(t)})},c.alive(n.get("body")),v.sync("ideafy-data"),h=new u(c.init,c.reload,v),document.querySelector(".spinner").classList.add("invisible"),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.init(),navigator.connection&&navigator.connection.type==="none"?(v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),a.set("lang",y.set("language")),h.setScreen("#nointernet")):g().then(function(){v.get("labels")?(y.reset(v.get("labels")),a.set("lang",y.get("language"))):m(navigator.language),w.request("CheckVersion",{version:S},function(e){var t=y.get("outdated")||"Please update your application";e==="outdated"&&alert(t)});var e=v.get("currentLogin")||"";e?w.request("CheckLogin",{id:e},function(e){e.authenticated?c.init():h.setScreen("#login-screen")}):h.setScreen("#signup-screen")},function(e){v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),h.setScreen("#maintenance-screen")}),a.get("observer").watch("signout",function(){v.set("currentLogin",""),v.set("userAvatar",""),v.sync("ideafy-data"),p.getStack().add("#login",h),h.reset(!0),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.setScreen("#login-screen"),document.getElementById("cache").classList.remove("appear")}),n.get("body").addEventListener("mousedown",f.checkSocketStatus),a.get("observer").watch("reconnect",function(){v.sync("ideafy-data"),g.then(function(){return E.unsync(),E.sync(b,v.get("currentLogin"))},function(){h.setScreen("#maintenance-screen")}).then(function(){console.log("user resynchronized")})})}),define("main",function(){});