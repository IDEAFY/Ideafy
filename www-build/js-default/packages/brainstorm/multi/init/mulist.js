/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h){var p=new e,d=i.get("labels"),v=i.get("user"),m=i.get("db"),g=i.get("transport"),y=new o([]),b=new o([]),w=new l,E=new o([]),S=new o({lang:[d.get("all")],modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"}),x="mulistall",T=u.getUserContactIds(),N=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200})).spin();return p.plugins.addAll({labels:new t(d),options:new t(S,{setLang:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t]+"</option>";this.innerHTML=r},setMode:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+d.get(e[t])+"</option>";this.innerHTML=r}}),muall:new t(y,{setParticipants:function(e){var t=e.length+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),musearch:new t(b,{setParticipants:function(e){var t=parseInt(e,10)+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),mupreview:new f({preview:w}),mulistevent:new n(p)}),p.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><select data-options="bind: setLang, lang" data-mulistevent="listen:change, filterLang"></select></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div id="noresult" class="invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',p.reset=function(){x="mulistall",N.spin(document.getElementById("mulistspinner")),S.set("selectedLang","all"),S.set("selectedMode","allmodes"),p.buildList(x).then(function(){N.stop()})},p.buildList=function(t,n){console.log("building list :",t,n);var r=[],i=new s;return t==="mulistall"&&(y.reset([]),p.addSessions(r,"roulette").then(function(){return console.log("roulette ok"),p.addSessions(r,"campfire")}).then(function(){return console.log("campfire ok"),p.addSessions(r,"boardroom")}).then(function(){console.log("after last query",r,p.dom.querySelector("#noresult")),r.length?p.dom.querySelector("#noresult").classList.add("invisible"):p.dom.querySelector("#noresult").classList.remove("invisible"),y.reset(r),i.fulfill()})),t==="musearch"&&(b.reset([]),p.syncSearch(r,n).then(function(){r.length?p.dom.querySelector("#noresult").classList.add("invisible"):p.dom.querySelector("#noresult").classList.remove("invisible"),b.reset(r),i.fulfill()})),i},p.syncSearch=function(t,n,i){var o=new s,u=new r;return u.setTransport(g),u.sync("_fti/local/"+m,"indexedsessions","waiting",{q:n,descending:!0}).then(function(){u.loop(function(e,n){var r=!1;e.fields.mode==="roulette"?r=!0:e.fields.mode==="campfire"&&T.indexOf(e.fields.initiator.id)>-1?r=!0:e.fields.mode==="boardroom"&&e.fields.invited.search(v.get("_id"))>-1&&(r=!0),r&&(i?e.fields.mode.search(i.mode)>-1&&e.fields.lang.search(i.lang)>-1&&t.push(e):t.push(e))}),o.fulfill()}),o},p.addSessions=function(t,n){var o=new s,u=new r,a="_view/"+n,f={};return u.setTransport(g),n==="roulette"?f={descending:!1,limit:50}:f={key:i.get("uid"),descending:!1},u.sync(m,"library",a,f).then(function(){console.log("query result for : ",n,u.toJSON()),u.loop(function(e,n){t.unshift(e)}),o.fulfill(),u.unsync()},function(e){console.log(e,n)}),o},p.search=function(e,t){e.keyCode===13&&(t.value===""?p.toggleList("mulistall"):p.toggleList("musearch"))},p.filterLang=function(e,t){var n=t.selectedIndex;n===0?S.set("selectedLang","all"):S.set("selectedLang",S.get("lang")[n]),N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.filterMode=function(e,t){var n=t.selectedIndex;S.set("selectedMode",S.get("modes")[n]);switch(n){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.filterList=function(){var t=[],n=document.getElementById("mulist-content").querySelector("input").value,r=new s,i="",o="";return S.get("selectedMode")!=="allmodes"&&(i=S.get("selectedMode")),S.get("selectedLang")!=="all"&&(o=S.get("selectedLang")),i===""&&o===""?p.buildList(x,n).then(function(){r.fulfill()}):x==="mulistall"?(y.reset([]),i?p.addSessions(t,i,{lang:o}).then(function(){y.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()}):p.addSessions(t,"roulette",{lang:o}).then(function(){return p.addSessions(t,"campfire",{lang:o})}).then(function(){return p.addSessions(t,"boardroom",{lang:o})}).then(function(){y.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()})):(b.reset([]),p.syncSearch(t,n,{mode:i,lang:o}).then(function(){b.reset(t),t.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),r.fulfill()})),r},p.zoom=function(e,t){var n;t.classList.add("pressed"),x==="mulistall"?(n=parseInt(t.getAttribute("data-muall_id"),10),w.reset(y.get(n).id)):x==="musearch"&&(n=t.getAttribute("data-musearch_id"),w.reset(b.get(n).id))},p.toggleList=function(t){t!==x&&(document.getElementById(x).classList.add("invisible"),document.getElementById(t).classList.remove("invisible"),x=t),N.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){N.stop()})},p.refreshList=function(){p.toggleList(x)},g.request("GetLanguages",{},function(e){S.set("lang",[d.get("all")].concat(e))}),w.init(p.refreshList),v.watchValue("lang",function(){var e;S.set("modes",["allmodes","roulette","campfire","boardroom"]),e=S.get("lang"),e.splice(0,1,d.get("all")),S.set("lang",e)}),MUALL=y,MUSEARCH=b,MUOPTIONS=S,p}});