/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=new s(i.get("TQTemplate")),l=new s(i.get("userLanguages")),c=i.get("user"),h=function(){f.set("lang",c.get("lang")),l.loop(function(e,t){e.name===c.get("lang").substring(0,2)?l.update(t,"selected",!0):l.update(t,"selected",!1)})},p=i.get("labels"),d=140,v=new s({error:""}),m=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return f.setTransport(i.get("transport")),h(),a.plugins.addAll({new2q:new n(f,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setLength:function(e){e===10&&this.setAttribute("maxlength",d)}}),select:new n(l,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new n(p),errormsg:new n(v,{setError:function(e){switch(e){case"noquestion":this.innerHTML=p.get("noquestion");break;case"lengthexceeded":this.innerHTML=p.get("lengthexceeded")+" ("+d+p.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new r(a)}),a.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:touchstart, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-new2q="bind: displayLang, lang" data-new2qevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-new2qevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',a.render(),a.place(t.get("new2q-popup")),a.showLang=function(e,t){a.dom.querySelector(".idealang ul").classList.remove("invisible")},a.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),l.loop(function(e,t){n===t?l.update(t,"selected",!0):l.update(t,"selected",!1)})},a.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),f.set("lang",l.get(n).name),a.dom.querySelector(".idealang ul").classList.add("invisible")},a.press=function(e,t){t.classList.add("pressed"),a.dom.querySelector(".description").blur()},a.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.unsync(),f.reset(i.get("TQTemplate")),h(),v.reset({error:""}),a.dom.querySelector(".idealang ul").classList.add("invisible")},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,t){var n=new Date,r,s="Q:"+n.getTime();t.classList.remove("pressed"),f.get("question")||v.set("error","noquestion"),!v.get("error")&&!f.get("_id")&&(t.classList.add("invisible"),m.spin(t.parentNode),r=setInterval(function(){v.get("error")===p.get("uploadinprogress")?v.set("error",p.get("uploadinprogress")+"..."):v.set("error",p.get("uploadinprogress"))},150),f.set("author",c.get("_id")),f.set("username",c.get("username")),f.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),f.set("lang",c.get("lang")),f.sync(i.get("db"),s).then(function(){return f.upload()}).then(function(){i.get("transport").request("UpdateUIP",{userid:c.get("_id"),type:f.get("type"),docId:s,question:f.get("question")},function(e){var o,u=c.get("connections"),l=u.length,h=[],d={type:"2Q+",docId:s,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:c.get("_id"),username:c.get("username"),firstname:c.get("firstname"),toList:"",ccList:"",object:c.get("username")+p.get("askednew"),body:f.get("question"),signature:""};e!=="ok"&&console.log(e),clearInterval(r),r=setInterval(function(){v.get("error")===p.get("notifyingcontacts")?v.set("error",p.get("notifyingcontacts")+"..."):v.set("error",p.get("notifyingcontacts"))},150);for(o=0;o<l;o++)u[o].type==="user"&&h.push(u[o].userid);d.dest=h,i.get("transport").request("Notify",d,function(e){console.log(e)}),m.stop(),t.classList.remove("invisible"),a.closePopup()})}))},a.checkLength=function(e,t){t.value.length>=d?v.set("error","lengthexceeded"):v.set("error","")},a}});