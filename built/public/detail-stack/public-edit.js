/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,i,n,s,a,r,o,c){return function(l){var d,u=new e,p=new n,g=new i(r.get("userLanguages")),h=r.get("labels"),v=new i({error:""});return p.setTransport(r.get("transport")),u.plugins.addAll({editlabel:new s(h),editidea:new s(p,{displayLang:function(e){var t;e&&(t=e.substring(0,2),this.setAttribute("style","background-image:url('img/flags/"+t+".png');"))},setVisibility:function(e){this.innerHTML="public"===e?h.get("publiclbl"):h.get("privatelbl")},hideVisibility:function(e){"public"===e?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){"public"===e?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 19px 16px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){e&&-1===e.search("deleted")?this.setAttribute("style","display:inline-block"):this.setAttribute("style","display:none")},setIdeafyStatus:function(e){this.innerHTML=e?h.get("enabledreplaylbl"):h.get("disabledreplaylbl")},setSessionReplay:function(e){this.innerHTML=e?h.get("disablereplaylbl"):h.get("enablereplaylbl")}}),select:new s(g,{setBg:function(e){e&&this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),editevent:new a(u),errormsg:new s(v,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;case"nosol":this.innerHTML=h.get("solutionfield")+h.get("emptyfielderror");break;default:this.innerHTML=""}}})}),u.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl">Modify your idea</span></div><form class="form"><div class="idealang"><div class="currentlang" data-editidea="bind: displayLang, lang" data-editevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:touchstart, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:touchstart, press; listen:touchend, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editevent="listen:touchstart, press;listen:touchend, upload">Publish</label><label class="cancel pressed-btn" data-editevent="listen:touchstart, press;listen:touchend, cancel">Cancel</label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',u.place(t.get("public-edit")),u.reset=function(e){p.unsync(),p.reset(),p.sync(r.get("db"),e),d=!1},u.showLang=function(){u.dom.querySelector(".idealang ul").classList.remove("invisible")},u.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),g.loop(function(e,t){i===t?g.update(t,"selected",!0):g.update(t,"selected",!1)})},u.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),p.set("lang",g.get(i).name),u.dom.querySelector(".idealang ul").classList.add("invisible")},u.editVisibility=function(e,t){var i=new o(t,h.get("setpublicquestion"),function(e){e?p.set("visibility","public"):p.set("visibility","private"),i.close()})},u.press=function(e,t){t.classList.add("pressed")},u.enableReplay=function(e,t){setTimeout(function(){p.get("sessionReplay")?p.set("sessionReplay",!1):p.set("sessionReplay",!0),d=!0,t.classList.remove("pressed")},300)},u.updateSessionReplay=function(e){var t=new c,i=new n;return i.setTransport(r.get("transport")),i.sync(r.get("db"),p.get("sessionId")).then(function(){var t,n=i.get("replayIdeas")||[];if(e)n.push(p.get("_id"));else for(t=n.length-1;t>=0;t--)n[t]===p.get("_id")&&n.splice(t,1);return i.set("replayIdeas",n),i.upload()}).then(function(){t.fulfill(),i.unsync()}),t},u.upload=function(e,t){var i=new Date,n=[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()];""===p.get("title")?v.set("error","notitle"):""===p.get("description")?v.set("error","nodesc"):""===p.get("solution")?v.set("error","nosol"):(p.set("modification_date",n),p.upload().then(function(){d&&u.updateSessionReplay(p.get("sessionReplay")).then(null,function(e){console.log(e)}),u.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")})),t.classList.remove("pressed")},u.cancel=function(e,t){t.classList.remove("pressed"),u.dom.querySelector(".idealang ul").classList.add("invisible"),l("close")},u}});