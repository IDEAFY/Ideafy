/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","service/map","Store","Bind.plugin","Place.plugin","Event.plugin","service/avatar"],function(e,t,n,s,a,r,o,c){return function(){var n=new e,d=new e,u=t.get("user"),p=t.get("observer"),g=t.get("labels"),h=0,v=new s({unread:0,newmsg:!1}),m=new s([]);return n.plugins.addAll({notif:new a(v,{flashNew:function(e){var t,i=this;e&&(t=setInterval(function(){i.classList.contains("orange")?i.classList.remove("orange"):i.classList.add("orange")},600),setTimeout(function(){clearInterval(t),i.classList.remove("orange"),v.set("newmsg",!1)},3e3))}}),place:new r({notifyPopup:d}),notifevent:new o(n)}),n.template='<div><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: touchstart, push; listen:touchend, showPopup"></div><div class = "signout-bubble" data-notifevent="listen:touchstart, signout"></div><div class = "info-bubble" data-notifevent="listen:touchstart, press; listen:touchend, showAbout">i</div><div id="notify-popup" data-place="place:notifyPopup"></div></div>',n.getUnread=function(){var e=u.get("notifications"),t=0;for(i=0,l=e.length;l>i;i++)"unread"===e[i].status&&t++;return t},n.push=function(e,t){t.classList.add("orange"),e.stopPropagation()},n.press=function(e,t){t.classList.add("pressed")},n.showPopup=function(e,t){t.classList.remove("orange"),d.showPopup()},n.signout=function(){document.getElementById("cache").classList.add("appear"),document.getElementById("dock").querySelector(".selected").classList.remove("selected"),document.querySelector('a[href="#public"]').classList.add("selected"),t.get("observer").notify("signout")},n.showAbout=function(e,i){i.classList.remove("pressed"),t.get("observer").notify("goto-screen","#dashboard"),t.get("observer").notify("show-about")},d.plugins.addAll({labels:new a(g),notify:new a(m,{setObject:function(e){var t=this.getAttribute("data-notify_id");if(e)switch(e){case"CXR":this.innerHTML=m.get(t).username+g.get("CXRobject");break;case"INV":this.innerHTML=m.get(t).username+g.get("INVObject");break;case"CXRaccept":this.innerHTML=m.get(t).username+g.get("acceptedCXR");break;case"CXRreject":this.innerHTML=m.get(t).username+g.get("rejectedCXR");break;case"CXCancel":this.innerHTML=m.get(t).username+g.get("canceledCX");break;case"DOC":this.innerHTML=m.get(t).username+g.get("sentdocmsg");break;case"2Q+":this.innerHTML=m.get(t).username+g.get("askednew");break;case"2C+":this.innerHTML=m.get(t).username+g.get("senttc");break;case"REF":this.innerHTML=m.get(t).username+g.get("joinedideafy");break;default:this.innerHTML=m.get(t).object}},setStyle:function(e){"unread"===e?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setAvatar:function(e){var t,i,n=this;e&&(t=document.createDocumentFragment(),i=new c([e]),i.place(t),n.firstChild?n.replaceChild(t,n.firstChild):n.appendChild(t))}}),notifyevent:new o(d)}),d.template='<div class="invisible"><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:touchstart, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:touchstart, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:innerHTML, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>',d.closePopup=function(){d.dom.classList.add("invisible")},d.showPopup=function(){d.dom.classList.remove("invisible")},d.displayComCenter=function(e,t){var i=t.getAttribute("data-notify_id");p.notify("display-message",i)},p.watch("display-message",function(){d.closePopup()}),n.init=function(){n.reset(),d.dom.classList.add("invisible")},n.reset=function(){h=n.getUnread(),v.set("unread",h),v.set("newmsg",!1),m.reset(u.get("notifications"))},u.watchValue("notifications",function(){var e=n.getUnread();m.reset([]),e>h?(v.set("newmsg",!0),v.set("unread",e),h=e,u.get("settings")&&u.get("settings").notifyPopup&&popup.classList.add("show-notify")):h>e&&(v.set("unread",e),h=e),m.reset(u.get("notifications"))}),n}});