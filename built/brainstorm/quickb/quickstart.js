/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","Promise","Store"],function(e,t,i,s,n,a,r,c,o){return function(d,l,u,p){var g=new e,m=n.get("user"),h=n.get("db"),v=new o(n.get("userLanguages")),b=function(){var e=m.get("lang").substring(0,2);d.set("lang",e),v.loop(function(t,i){t.name===e?v.update(i,"selected",!0):v.update(i,"selected",!1)})},f=n.get("labels"),w="step",y=new r({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545}).spin();return b(),g.plugins.addAll({labels:new i(f),select:new i(v,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),model:new i(d,{setTitle:function(e){new Date,e&&e.username&&this.setAttribute("placeholder",f.get("quickstarttitleplaceholderpre")+e.username+f.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),quickstartevent:new s(g)}),g.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:touchstart, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:touchstart, help"></div><form class="quickstart-form"><div class="idealang"><div class="currentlang" data-model="bind: displayLang, lang" data-quickstartevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-quickstartevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: touchstart, press; listen:touchend, next"></div></form><div>',g.place(t.get("quickstart")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){y.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===w?(w="screen",""===d.get("title")&&d.set("title",f.get("quickstarttitleplaceholderpre")+d.get("initiator").username+f.get("quickstarttitleplaceholderpost")),d.set("lang",m.get("lang")),d.set("_id","S:QUICK:"+d.get("startTime")),d.sync(h,d.get("_id")).then(function(){return m.set("sessionInProgress",{id:d.get("_id"),type:"quick"}),m.upload()}).then(function(){u("quickstart")})):u("quickstart")},g.stopSpinner=function(){y.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.prev=function(e,t){t.classList.remove("pressed"),l("quickstart")},g.toggleProgress=function(){p()},g.showLang=function(){g.dom.querySelector(".idealang ul").classList.remove("invisible")},g.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),v.loop(function(e,t){i===t?v.update(t,"selected",!0):v.update(t,"selected",!1)})},g.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),d.set("lang",v.get(i).name),g.dom.querySelector(".idealang ul").classList.add("invisible")},g.reset=function(e){var t=new Date,i=d.get("step");new c,e?(w="quickstart"===i?"step":"screen","quickwrapup"!==i&&d.set("resumeTime",t.getTime())):(d.set("startTime",t.getTime()),d.set("date",[t.getFullYear(),t.getMonth(),t.getDate()]),d.set("lang",m.get("lang")),w="step")},g.help=function(){a.setContent("quickstarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g}});