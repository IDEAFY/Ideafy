define("CouchDBSecurity",["CouchDBStore"],function CouchDBSecurity(c){function b(){var d="_security";this.setName=function g(h){if(h){d=h;return true}else{return false}};this.getName=function f(){return d};this.load=function e(h){return this.sync(h,d)}}return function a(){b.prototype=new c;return new b}});define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function CouchDBStore(e,a,b,d){function f(){var p="CouchDB",j=null,r={},w=new d,q={getView:function(){r.query=r.query||{};j.request(p,{method:"GET",path:"/"+r.database+"/_design/"+r.design+"/"+r.view,query:r.query},function(z){var y=JSON.parse(z);if(!y.rows){throw new Error("CouchDBStore ["+r.database+", "+r.design+", "+r.view+"].sync() failed: "+z)}else{this.reset(y.rows);if(typeof y.total_rows=="undefined"){this.setReducedViewInfo(true)}s.event("subscribeToViewChanges")}},this)},getDocument:function(){j.request(p,{method:"GET",path:"/"+r.database+"/"+r.document,query:r.query},function(z){var y=JSON.parse(z);if(y._id){this.reset(y);s.event("subscribeToDocumentChanges")}else{w.reject(z)}},this)},getBulkDocuments:function(){var y={path:"/"+r.database+"/_all_docs",query:r.query},z;if(r.keys instanceof Array){y.method="POST";y.data=JSON.stringify({keys:r.keys});y.headers={"Content-Type":"application/json"};z=y.data}else{y.method="GET";z=JSON.stringify(r.query)}r.query.include_docs=true;j.request(p,y,function(B){var A=JSON.parse(B);if(!A.rows){throw new Error('CouchDBStore.sync("'+r.database+'", '+z+") failed: "+B)}else{this.reset(A.rows);s.event("subscribeToBulkChanges")}},this)},createDocument:function(y){j.request(p,{method:"PUT",path:"/"+r.database+"/"+r.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(z){var A=JSON.parse(z);if(A.ok){s.event("subscribeToDocumentChanges")}else{y.reject(A)}})},subscribeToViewChanges:function(){b.mixin({feed:"continuous",heartbeat:10000,descending:true},r.query);this.stopListening=j.listen(p,{path:"/"+r.database+"/_changes",query:r.query},function(z){if(z=="\n"){return false}var y=JSON.parse(z),A;if(r.reducedView){A="updateReduced"}else{if(y.deleted){A="delete"}else{if(y.changes&&y.changes[0].rev.search("1-")==0){A="add"}else{A="change"}}}s.event(A,y.id)},this)},subscribeToDocumentChanges:function(){this.stopListening=j.listen(p,{path:"/"+r.database+"/_changes",query:{feed:"continuous",heartbeat:10000,descending:true}},function(z){var y;if(z=="\n"){return false}y=JSON.parse(z);if(y.id==r.document&&y.changes.pop().rev!=this.get("_rev")){if(y.deleted){s.event("deleteDoc")}else{s.event("updateDoc")}}},this)},subscribeToBulkChanges:function(){b.mixin({feed:"continuous",heartbeat:10000,descending:true,include_docs:true},r.query);this.stopListening=j.listen(p,{path:"/"+r.database+"/_changes",query:r.query},function(z){var y;if(z=="\n"){return false}var y=JSON.parse(z),A;if(y.changes[0].rev.search("1-")==0){A="bulkAdd"}else{if(y.deleted){A="delete"}else{A="bulkChange"}}s.event(A,y.id,y.doc)},this)},updateDocInStore:function(y){j.request(p,{method:"GET",path:"/"+r.database+"/_design/"+r.design+"/"+r.view,query:r.query},function(z){var A=JSON.parse(z);if(A.rows.length==this.getNbItems()){A.rows.some(function(C,B){if(C.id==y){this.set(B,C)}},this)}else{this.actions.evenDocsInStore.call(this,A.rows,y)}},this)},evenDocsInStore:function(y,A){var z=this.getNbItems();if(y.length<z){this.loop(function(C,B){if(C.id==A){this.del(B)}},this)}else{if(y.length>z){y.some(function(C,B){if(C.id==A){return this.alter("splice",B,0,C)}},this)}}},addBulkDocInStore:function(y){if(r.query.startkey||r.query.endkey){r.query.include_docs=true;r.query.update_seq=true;j.request(p,{method:"GET",path:"/"+r.database+"/_all_docs",query:r.query},function(A){var z=JSON.parse(A);z.rows.forEach(function(C,B){if(C.id==y){this.alter("splice",B,0,C.doc)}},this)},this)}else{return false}},updateBulkDocInStore:function(z,y){this.loop(function(B,A){if(B.id==z){this.set(A,y)}},this)},removeDocInStore:function(y){this.loop(function(A,z){if(A.id==y){this.del(z)}},this)},addDocInStore:function(y){j.request(p,{method:"GET",path:"/"+r.database+"/_design/"+r.design+"/"+r.view,query:r.query},function(z){var A=JSON.parse(z);A.rows.some(function(C,B){if(C.id==y){this.alter("splice",B,0,C)}},this)},this)},updateReduced:function(){j.request(p,{method:"GET",path:"/"+r.database+"/_design/"+r.design+"/"+r.view,query:r.query},function(y){var z=JSON.parse(y);this.set(0,z.rows[0])},this)},updateDoc:function(){j.request(p,{method:"GET",path:"/"+r.database+"/"+r.document},function(y){this.reset(JSON.parse(y))},this)},deleteDoc:function(){this.reset({})},updateDatabase:function(y){j.request(p,{method:"PUT",path:"/"+r.database+"/"+r.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(z){var A=JSON.parse(z);if(A.ok){this.set("_rev",A.rev);y.resolve(A)}else{console.log("DOCUMENT UPLOAD FAILED",this.toJSON());y.reject(A)}},this)},updateDatabaseWithBulkDoc:function(z){var y=[];this.loop(function(A){y.push(A.doc)});j.request(p,{method:"POST",path:"/"+r.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:y})},function(A){z.resolve(JSON.parse(A))})},removeFromDatabase:function(){j.request(p,{method:"DELETE",path:"/"+r.database+"/"+r.document,query:{rev:this.get("_rev")}})},unsync:function(){this.stopListening();delete this.stopListening}},s=new a("Unsynched",{Unsynched:[["getView",q.getView,this,"Synched"],["getDocument",q.getDocument,this,"Synched"],["getBulkDocuments",q.getBulkDocuments,this,"Synched"]],Synched:[["updateDatabase",q.createDocument,this],["subscribeToViewChanges",q.subscribeToViewChanges,this,"Listening"],["subscribeToDocumentChanges",q.subscribeToDocumentChanges,this,"Listening"],["subscribeToBulkChanges",q.subscribeToBulkChanges,this,"Listening"],["unsync",function i(){},"Unsynched"]],Listening:[["entry",function(){w.resolve(this)}],["change",q.updateDocInStore,this],["bulkAdd",q.addBulkDocInStore,this],["bulkChange",q.updateBulkDocInStore,this],["delete",q.removeDocInStore,this],["add",q.addDocInStore,this],["updateReduced",q.updateReduced,this],["updateDoc",q.updateDoc,this],["deleteDoc",q.deleteDoc,this],["updateDatabase",q.updateDatabase,this],["updateDatabaseWithBulkDoc",q.updateDatabaseWithBulkDoc,this],["removeFromDatabase",q.removeFromDatabase,this],["unsync",q.unsync,this,"Unsynched"]]});this.sync=function m(){w=new d;if(typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]=="string"){this.setSyncInfo(arguments[0],arguments[1],arguments[2],arguments[3]);s.event("getView");return w}else{if(typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]!="string"){this.setSyncInfo(arguments[0],arguments[1],arguments[2]);s.event("getDocument");return w}else{if(typeof arguments[0]=="string"&&arguments[1] instanceof Object){this.setSyncInfo(arguments[0],arguments[1]);s.event("getBulkDocuments");return w}}}return false};this.setSyncInfo=function o(){this.clearSyncInfo();if(typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]=="string"){r.database=arguments[0];r.design=arguments[1];r.view=arguments[2];r.query=arguments[3];return true}else{if(typeof arguments[0]=="string"&&typeof arguments[1]=="string"&&typeof arguments[2]!="string"){r.database=arguments[0];r.document=arguments[1];r.query=arguments[2];return true}else{if(typeof arguments[0]=="string"&&arguments[1] instanceof Object){r.database=arguments[0];r.query=arguments[1];if(r.query.keys instanceof Array){r.keys=r.query.keys;delete r.query.keys}return true}}}return false};this.clearSyncInfo=function l(){r={};return true};this.setReducedViewInfo=function n(y){if(typeof y=="boolean"){r.reducedView=y;return true}else{return false}};this.getSyncInfo=function k(){return r};this.unsync=function u(){return s.event("unsync")};this.upload=function v(){var y=new d;if(r.document){s.event("updateDatabase",y);return y}else{if(!r.view){s.event("updateDatabaseWithBulkDoc",y);return y}}return false};this.remove=function x(){if(r.document){return s.event("removeFromDatabase")}return false};this.setTransport=function t(y){if(y&&typeof y.listen=="function"&&typeof y.request=="function"){j=y;return true}else{return false}};this.getStateMachine=function h(){return s};this.getTransport=function g(){return j};this.actions=q}return function c(g){f.prototype=new e(g);return new f}});define("CouchDBUser",["CouchDBStore","Promise"],function CouchDBUser(d,a){function c(){var h="_users",e="org.couchdb.user:";this.getUserDB=function i(){return h};this.setUserDB=function m(p){if(p){h=p;return true}else{return false}};this.getIdPrefix=function l(){return e};this.setIdPrefix=function j(p){if(p){e=p;return true}else{return false}};this.setId=function f(p){if(p){this.set("_id",e+p);return true}else{return false}};this.getId=function g(){return this.get("_id")};this.load=function o(p){return this.sync(h,e+p)};this.login=function n(){var r=new a,q=this.get("name"),p=this.get("password");if(q&&typeof q=="string"&&typeof p=="string"){this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+q,auth:q+":"+p},r.resolve,r)}else{r.reject({error:"name & password must be strings"})}return r};this.create=function k(){var p=new a;if(!this.get("type")){this.set("type","user")}if(!this.get("roles")){this.set("roles",[])}this.load(this.get("name")).then(function(){p.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(q){p.resolve(q)},function(q){p.reject(q)})},this);return p}}return function b(){c.prototype=new d;return new c}});