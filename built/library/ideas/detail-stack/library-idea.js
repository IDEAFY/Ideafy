/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,i,s,a,r,o,c,l,d,u,p,g){return function(h){var v=new e,f=new l("library"),m=new c("library"),b=o.get("labels"),y=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),w=!1,k=o.get("user"),L=o.get("transport"),S=new p,T=new t([]),M=s.get("ideas-detail"),x=s.get("library-writetwocents");return new d,S.setTransport(L),v.plugins.addAll({label:new n(b),ideadetail:new n(S,{toggleFavEdit:function(e){var t=this;e.indexOf(k.get("_id"))>-1?t.setAttribute("href","#library-edit"):(t.setAttribute("href","#library-favorites"),k.get("library-favorites")&&k.get("library-favorites").indexOf(S.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav"),k.watchValue("library-favorites",function(e){e.indexOf(S.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav")}))},toggleTwocentShare:function(e){e.indexOf(k.get("_id"))>-1?this.setAttribute("href","#library-share"):this.setAttribute("href","#library-2cents")},displayWriteTwocent:function(e){e.indexOf(k.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("library-writetwocents").classList.add("invisible")},date:function C(C){C&&(this.innerHTML=a.formatDate(C))},setAuthor:function(e){this.innerHTML=e===k.get("username")&&S.get("authors").indexOf(k.get("_id"))>-1?b.get("youlbl"):e},setWrotelbl:function(e){this.innerHTML=1===e.length&&e[0]===k.get("_id")?b.get("youwrotelbl"):e.length>1?b.get("theywrotelbl"):b.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new r(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},hideRating:function(e){e.search("I:WELCOME")>-1?this.classList.add("invisible"):this.classList.remove("invisible")},setRating:function(e){this.innerHTML=0===e.length?"":Math.round(100*(e.reduce(function(e,t){return e+t})/e.length))/100},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setSolution:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=S.get("_id"),n=S.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),k.get("rated_ideas").indexOf(t)<0&&n.indexOf(k.get("_id"))<0&&!w?(this.setAttribute("name","vote"),this.innerHTML=b.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(w=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),this.innerHTML=0===e.length?"("+b.get("novotesyet")+")":1===e.length?"("+b.get("onevote")+")":"("+e.length+" "+b.get("votes")+")",this.classList.add("votes"))},setSharedWith:function(e){S.get("_id").search("I:WELCOME")<0&&e&&e.length?(this.classList.remove("invisible"),this.innerHTML=1===e.length?b.get("sharedwith")+"<b><u>"+1+b.get("ideafyer")+"</u></b>":b.get("sharedwith")+"<b><u>"+e.length+b.get("ideafyer")+"</u></b>"):this.classList.add("invisible")}}),share:new n(T),vote:new n(y,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new g({LibraryTwocentUI:f}),ideadetailevent:new i(v)}),v.template='<div class="library-idea"><div class="header blue-dark"><a href="#library-2cents" data-ideadetail="bind: toggleTwocentShare, authors" data-ideadetailevent="listen: touchstart, action" class="option left"></a><span data-label="bind: innerHTML, ideadetailsheadertitle"></span><a href="#library-favorites" data-ideadetail="bind: toggleFavEdit, authors" data-ideadetailevent="listen: touchstart, action" class="option right"></a></div><div id="idea-cache" class="invisible"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-ideadetail="bind:setAvatar, authors"></div><h2 data-ideadetail="bind:innerHTML,title"></h2><span class="date" data-ideadetail="bind:date, creation_date"></span><br><span class="author" data-ideadetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-ideadetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><legend class="idealegend" data-label="bind:innerHTML, principle"></legend><p class="ideap" data-ideadetail="bind:setDescription,description"></p><legend class="idealegend" data-label="bind:innerHTML, solution"></legend><p class="ideap" data-ideadetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class="sharedwith invisible" data-ideadetail="bind: setSharedWith, sharedwith" data-ideadetailevent="listen:touchstart, displayList"></div><div id="sharelist" class="autocontact invisible"><div class="autoclose" data-ideadetailevent="listen:touchstart,close"></div><ul data-share="foreach"><li data-share="bind:innerHTML, value.username"></li></ul></div><div class ="rateIdea" data-ideadetail="bind:hideRating, id"><a class="item-acorn"></a><div class="rating" data-ideadetail="bind:setRating,votes"></div><div class="publicButton" data-ideadetail="bind: toggleVoteButton, votes" name="vote" data-ideadetailevent="listen: touchstart, press; listen: touchend, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-ideadetailevent="listen: touchstart, previewVote; listen: touchend, castVote"></li></ul></div></div></div></div><div id="library-writetwocents" class="invisible" data-ideadetail="bind: displayWriteTwocent, authors"></div><div id="library-twocents" class="twocents" data-ideadetail="bind: displayTwocentList, twocents" data-place="place: LibraryTwocentUI"></div></div>',v.showCache=function(){v.dom.querySelector("#idea-cache").classList.remove("invisible")},v.hideCache=function(){v.dom.querySelector("#idea-cache").classList.add("invisible")},v.reset=function(e,t){var n=e.get(t).id,i=new u;return y.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),v.getIdea(n).then(function(){w=!1,m.reset(S.get("_id")),f.reset(S.get("_id")),x=document.getElementById("library-writetwocents"),m.place(x),i.fulfill()}),i},v.getIdea=function(e){return S.unsync(),S.reset(),S.sync(o.get("db"),e)},v.action=function(e,t){var n,i,s=t.getAttribute("href"),a=S.get("_id");switch(s){case"#library-2cents":m.reset(a),x.classList.remove("invisible");break;case"#library-favorites":n=k.get("library-favorites")?k.get("library-favorites").concat():[],i=n.indexOf(a),i>-1?n.splice(n.indexOf(a),1):n.push(a),n.length<100?(k.set("library-favorites",n),k.upload().then(function(){i>-1?alert(b.get("removedfav")):alert(b.get("addedfav")),t.classList.toggle("unfav")})):alert(b.get("maxfavsize"));break;default:h(s)}},v.edit=function(){_stack.getStack().show("#public-edit")},v.press=function(e,t){t.classList.add("pressed")},v.vote=function(e,t){w||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},v.previewVote=function(e,t){var n=t.getAttribute("data-vote_id");y.loop(function(e,t){n>=t?y.update(t,"active",!0):y.update(t,"active",!1)})},v.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,i=S.get("_id"),s={id:i,vote:n,voter:k.get("_id")};w||(w=!0,L.request("Vote",s,function(e){var t=k.get("rated_ideas")||[];"ok"!==e?(console.log(e,"something went wrong, please try again later"),w=!1):(t.unshift(i),k.set("rated_ideas",t),alert(o.get("labels").get("thankyou")),document.getElementById("ratingPopup").classList.remove("appear"),y.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},v.close=function(e,t){t.parentNode.classList.add("invisible")},v.displayList=function(){L.request("GetUserNames",{list:S.get("sharedwith")},function(e){T.reset(e),document.getElementById("sharelist").classList.remove("invisible")})},v.place(M),v}});