/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min","service/confirm"],function(e,t,n,r,i,s,o,u,a,f,c){function h(e,h,p){var d=new i([]),v=h.offsetHeight,m=new i({height:v}),g=10,y=r.get("user"),b=r.get("labels"),w=r.get("observer"),E=r.get("transport"),S=r.get("db"),x,T=this,N=(new f({color:"#9AC9CD",lines:10,length:10,width:8,radius:10})).spin(),C=(new f({color:"#a0a0a0",lines:10,length:6,width:4,radius:6})).spin();this.plugins.addAll({buttons:new t(d,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(m,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-g)+"px;")},setButtons:function(e){var t=Math.floor((e-g-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new n(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:touchend, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:touchstart, press; listen:touchend, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(){var e=T.dom.parentElement;e&&e.removeChild(e.lastChild)},this.getParent=function(){return h},this.press=function(e,t){e.stopPropagation(),t.classList.add("pressed"),N.el=document.getElementById("abspinner")},this.action=function(e,t){var n=t.getAttribute("data-buttons_id"),i=d.get(n).name;e.stopPropagation(),t.classList.remove("pressed");switch(i){case"delete":this.deleteItem().then(function(){T.hide()});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":r.get("observer").notify("replay-session",p.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();break;case"unfav":C.spin(t),document.getElementById("public")?this.removeFav("public-favorites"):this.removeFav("library-favorites");break;case"addfav":C.spin(t),document.getElementById("public")?this.addFav("public-favorites"):this.addFav("library-favorites");break;default:}},x=function(e,t){var n;switch(e){case"idea":n=new s,n.setTransport(E),n.sync(S,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){var e=y.get("public-favorites")||[],i=y.get("library-favorites")||[];t=n.get(0).doc,p=n.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&d.alter("push",{name:"edit",icon:"img/wall/35modify.png"});if(t.sessionId&&t.sessionId!==""&&t.sessionId.search("deleted")===-1)if(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1){var o=new s;o.setTransport(r.get("transport")),o.sync(r.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){o.get(0)&&d.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}document.getElementById("public")?e.indexOf(t._id)>-1?d.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):d.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"}):document.getElementById("library")&&(i.indexOf(t._id)>-1?d.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):d.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"})),d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),t.authors.length===1&&t.authors[0]===y.get("_id")&&!t.twocents.length&&!t.sharedwith.length&&t.visibility!=="public"&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),t.authors.indexOf(y.get("_id"))===-1&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"deck":var i=new o;i.setTransport(E),i.sync(S,p).then(function(){i.get("created_by")===y.get("_id")&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),y.get("taiaut_decks").length+y.get("custom_decks").length>1&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.type==="user"&&d.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:}},this.deleteItem=function(){var n=new u,i=new o,s=this;i.setTransport(E);switch(e){case"idea":p.authors.length===1&&p.authors[0]===y.get("_id")?i.sync(r.get("db"),p._id).then(function(){return i.remove()}).then(function(){n.fulfill()}):E.request("RemoveFromLibrary",{id:p._id,userid:y.get("_id")},function(e){n.fulfill()});break;case"deck":y.get("active_deck")===p?(alert(b.get("cannotdelactivedeck")),s.hide()):(document.getElementById("cache").classList.add("appear"),confirmUI=new c(document.body,b.get("deldeckwarning"),function(e){var t=(new f({lines:10,length:20,width:8,radius:10})).spin();if(!e)s.hide();else{t.spin(document.getElementById("deckview")),document.getElementById("cache").classList.add("appear");if(y.get("taiaut_decks").indexOf(p)>-1){var r=y.get("taiaut_decks");r.splice(r.indexOf(p),1),y.set("taiaut_decks",r),y.upload().then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})}else i.sync(S,p).then(function(){var e=i.get("sharedwith")||[],r=y.get("custom_decks").concat();e.length&&e.indexOf(y.get("_id"))>-1?(e.splice(e.indexOf(y.get("_id")),1),i.set("sharedwith",e),i.upload.then(function(){return r.splice(r.indexOf(p),1),y.set("custom_decks",r),y.upload()}).then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})):i.get("created_by")===y.get("_id")&&E.request("DeleteDeck",{id:p,userid:y.get("_id")},function(e){e==="ok"?(r.splice(r.indexOf(p),1),y.set("custom_decks",r),y.upload().then(function(){t.stop(),document.getElementById("cache").classList.remove("appear"),n.fulfill()})):console.log(e)})})}document.body.removeChild(document.querySelector(".confirm"))},"importcard-confirm"));break;case"message":var a=y.get("notifications"),h,d;for(h=0,l=a.length;h<l;h++)if(JSON.stringify(a[h])===JSON.stringify(p)){d=h;break}a.splice(d,1),y.set("notifications",a),y.upload();break;case"contact":var a=y.get("connections"),v=new Date,m=[v.getFullYear(),v.getMonth(),v.getDate(),v.getHours(),v.getMinutes(),v.getSeconds()];if(p.type==="user"){for(h=a.length-1;h>=0;h--)if(a[h].type==="user"&&a[h].userid===p.userid)a.splice(h,1);else if(a[h].type==="group"){var g=a[h].contacts;for(j=g.length-1;j>=0;j--)g[j].userid===p.userid&&g.splice(j,1)}}else for(h=a.length-1;h>=0;h--)a[h].username===p.username&&a.splice(h,1);y.set("connections",a),p.type==="user"&&y.get("news").unshift({type:"CX-",date:m,content:{userid:p.userid,username:p.username}}),y.upload().then(function(){if(p.type==="user"){var e=new Date,t={dest:[p.userid],date:m,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:p.username,ccList:"",object:y.get("username")+b.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};E.request("Notify",t,function(e){console.log(e)})}w.notify("contact-deleted")});break;default:}return n},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-edit",p._id):w.notify("library-edit",p._id);break;default:}N.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-sendmail",p):w.notify("library-sendmail",p);break;case"message":break;case"contact":w.notify("message-contact",p);break;default:}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-share",p):w.notify("library-share",p);break;case"deck":w.notify("deck-share",p);break;case"message":break;case"contact":break;default:}},this.sendTwocent=function(){a.reset(p)},this.addFav=function(e){var t,n;y.get(e)?t=y.get(e).concat():t=[],t.length<100?(t.push(p._id),y.set(e,t),y.upload().then(function(){C.stop(),alert(b.get("addedfav")),T.hide()})):(C.stop(),alert(b.get("maxfavsize")),T.hide())},this.removeFav=function(e){var t;y.get(e)?t=y.get(e).concat():t=[],t.splice(t.indexOf(p._id),1),y.set(e,t),y.upload().then(function(){C.stop(),alert(b.get("removedfav")),T.hide()})},x(e,p)}return function(n,r,i){return h.prototype=new e,new h(n,r,i)}});