/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["service/config","Observable","Promise","LocalStore"],function(e,t,i,n){return{formatDate:function(e){var t=e[1]+1;return 10>t&&(t="0"+t),e[2]+"/"+t+"/"+e[0]},formatDuration:function(e){var t,i,n,s,a,r;return e?(t=Math.round(e/1e3),i=Math.floor(t/86400),n=Math.floor(t%86400/3600),s=Math.floor(t%86400%3600/60),a=Math.floor(t%86400%3600%60),r=i>0?i+"d ":"",r+=n>0?n+":":"",r+=s>0?(n>0&&10>s?"0":"")+s+":":"0:",r+=10>a?"0"+a:a):r="",r},formatTime:function(e){var t=new Date(e),i=t.getHours(),n=t.getMinutes(),s=t.getSeconds(),a="";return a+=i+":",a+=n>0?(i>0&&10>n?"0":"")+n+":":"00:",a+=10>s?"0"+s:s},displayFirstSentence:function(e,t){var i=[];return i=t.split("."[0],1),i[0].length>140&&(e.innerHTML=i[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")),e.innerHTML},truncate:function(e,t){for(e.innerHTML=t;e.scrollHeight>e.offsetHeight;){var i=e.innerHTML;e.innerHTML=i.replace(/\W*\s(\S)*$/,"...")}return e.innerHTML},setRating:function(e,t){var i,n="<img src = 'img/wall/disableIdeaVote.png'>",s="<img src = 'img/wall/semi-activeIdeaVote.png'>",a="<img src = 'img/wall/activeIdeaVote.png'>",r="";if(t){for(i=0;i<Math.floor(t);)r+=a,i++;for(5>i&&(r+=Math.round(t-Math.floor(t))?s:n,i++);5>i;)r+=n,i++}else for(i=0;5>i;i++)r+=n;e.innerHTML=r},searchArray:function(e,t){var i,n,s,a,r=t.toLowerCase().split(" "),o=[];for(i=0,l=e.length;l>i;i++){for(s=JSON.stringify(e[i]).toLowerCase(),a=0,n=0;n<r.length&&s.search(r[n])>-1;n++)a++;a===r.length&&o.push(e[i])}return o},sortByProperty:function s(e,t,i){switch(t){case"idea":e.sort(function(e,n){var a,r,o=e[t],c=n[t];return i?(o&&o instanceof Array&&o.length?(s(o,"title",!0),a=o[0].title):a="",c&&c instanceof Array&&c.length?(s(c,"title",!0),r=c[0].title):r="",r>a?1:a>r?-1:0):(o&&o instanceof Array&&o.length?(s(o,"title",!1),a=o[0].title):a="",c&&c instanceof Array&&c.length?(s(c,"title",!1),r=c[0].title):r="",r>a?-1:a>r?1:0)});break;case"date":e.sort(function(e,n){var s=e[t],a=n[t],r=new Date(s[0],s[1],s[2]),o=new Date(a[0],a[1],a[2]);return i?o>r?1:r>o?-1:0:o>r?-1:r>o?1:0});break;default:e.sort(function(e,n){var s=e[t],a=n[t];return"string"==typeof s||"string"==typeof a?(s&&s.toLowerCase&&(s=s.toLowerCase()),a&&a.toLowerCase&&(a=a.toLowerCase()),i?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0):i?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0})}},uploadFile:function(t,i,n,s){var a=new XMLHttpRequest;a.open("POST",e.get("location")+t),a.onreadystatechange=function(){4===a.readyState&&s&&s(a)},a.upload.onprogress=function(e){e.lengthComputable&&n&&n.set("status",Math.round(100*(e.loaded/e.total)))},a.send(i)},checkServerStatus:function(){var t=new i,n=new XMLHttpRequest;return n.open("GET",e.get("location")),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?t.fulfill():t.reject())},n.send(),t},checkSocketStatus:function(){var t=e.get("socket"),i=e.get("observer"),n=e.get("user");t.socket.connected?n.get("online")||i.notify("reconnect","user"):(t.socket.reconnect(),i.notify("reconnect","all"))},disconnectSocket:function(){e.get("socket").socket.disconnect(),e.get("observer").notify("disconnect")},updateLabels:function(t){var s={lang:t},a=new n,r=e.get("labels"),o=new i;return a.sync("ideafy-data"),e.get("transport").request("Lang",s,function(t){"nok"===t?(a.set("labels",e.get("defaultLabels")),e.set("lang","en-us")):(a.set("labels",t),e.set("lang",t.language)),a.sync("ideafy-data"),r.reset(a.get("labels")),o.fulfill()}),o},getAvatarById:function(t){var s=new i,a=(new n,e.get("avatars"));if(a.get(t)&&"in progress"!==a.get(t))s.fulfill(a.get(t));else{if("in progress"!==a.get(t))return a.set(t,"in progress"),e.get("transport").request("GetAvatar",{id:t},function(e){if(e.error)s.reject();else{if(a.getNbItems()<100)a.set(t,e);else{var i=a.toJSON(),n=i.keys();a.del(n[0]),a.set(t,e)}s.fulfill(e)}}),s;a.watchValue(t,function(e){e&&"in progress"!==e&&(a.unwatch(t),s.fulfill(e))})}},getAvatarByFileName:function(t,i){e.get("transport").request("GetAvatar",{file:t},function(e){i(e)})},getGrade:function(t,i){var n=e.get("transport"),s=e.get("user");n.request("GetGrade",{ip:t,lang:s.get("lang")},function(e){i(e)})},getAchievements:function(t,i){var n=e.get("transport"),s=e.get("user");n.request("GetAchievements",{userid:t,lang:s.get("lang")},function(e){i(e)})},getUserDetails:function(t,i){var n=e.get("transport");n.request("GetUserDetails",{userid:t},function(e){i(e)})},getUserContactIds:function(){var t=[],i=e.get("user").get("connections");return i.forEach(function(e){"user"===e.type&&t.push(e.userid)}),t},checkProfileCompletion:function(){var t=e.get("user"),i=e.get("labels"),n={percentage:0,missing:[]};return t.get("firstname")&&t.get("lastname")&&(n.percentage+=10),3===t.get("birthdate").length?n.percentage+=10:n.missing.push(i.get("enterbirthdate")),null!==t.get("family").couple&&null!==t.get("family").children?n.percentage+=10:n.missing.push(i.get("enterfamily")),t.get("address").city&&t.get("address").country?n.percentage+=10:n.missing.push(i.get("enteraddress")),t.get("intro")&&"Ideafyer"!==t.get("intro")?n.percentage+=10:n.missing.push(i.get("enterintro")),t.get("occupation").situation>=0&&t.get("occupation").job&&t.get("occupation").organization?n.percentage+=10:n.missing.push(i.get("enteroccupation")),t.get("leisure_activities")[0].name&&t.get("leisure_activities")[1].name?n.percentage+=10:n.missing.push(i.get("enterleisure")),t.get("interests")[0].name&&t.get("interests")[1].name?n.percentage+=10:n.missing.push(i.get("enterinterest")),t.get("twitter")||t.get("facebook")||t.get("gplus")||t.get("linkedin")?n.percentage+=10:n.missing.push(i.get("entersocialnw")),t.get("picture_file").search("img/avatars/deedee")<0?n.percentage+=10:n.missing.push(i.get("enterownpic")),n},stringToBytes:function(e){var t,i,n,s,a=[],r=0;for(n=0;n<e.length;n++)if(t=e.charCodeAt(n),127>t)a[r++]=255&t;else{i=[];do i.unshift(255&t),t>>=8;while(t);for(s=0;s<i.length;s++)a[r++]=i[s]}return a},changeStyle:function(e){var t=document.querySelector(".currentStyle"),i=t.getAttribute("href");i!=="css/"+e&&t.setAttribute("href","css/"+e)},exitListener:function(e,t){var i=function(i){var n;for(n=i.target;n;n=n.parentNode)if(n.id===e)return;i.target.classList.contains("deedee")||i.target.classList.contains("notify-header")||"dock"===i.target.id||i.target.classList.contains("close-help")||(i.stopPropagation(),t(i.target))};return document.addEventListener("touchstart",i,!0),i}}});