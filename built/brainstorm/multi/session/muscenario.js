/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../../whiteboard/whiteboard","Promise","service/utils","lib/spin.min","./mubchat"],function(e,t,i,s,n,a,r,o,l,d,c,u,g,p){return function(m,v,h,b,f){var w,y,S,L,k=new e,T=new p,I=a.get("labels"),M=a.get("user"),A=a.get("db"),x=new r,q=new r,C=new r,H=new r({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),_={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},N=new r(_),P=new r({timer:null,display:!1}),O=new r({title:"",story:"",solution:""}),D=new r([]),B=new d("scenario",D,N,"mu"),E=0,J="step",V=a.get("transport"),j=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();return k.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===M.get("_id")},k.plugins.addAll({labels:new i(I,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new i(H,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(N,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){k.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showStory:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),muscenariotimer:new i(P,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new i(O),wbstack:B,place:new n({chat:T}),muscenarioevent:new s(k)}),k.template='<div id = "muscenario"><div class="previousbutton" data-muscenarioevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muscenario" data-muscenarioevent="listen:touchstart, toggleProgress"></div><div class="timer" data-muscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-muscenarioevent="listen:touchstart,toggleTimer"></div><div id="muscenario-left"><div class="scenario-cards leftarea folded" data-muscenarioevent="listen:touchstart, fold"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-muscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-muscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-muscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div><div class="caret"></div></div><div id="muscenario-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muscenarioevent="listen: touchstart, push; listen:touchend, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muscenarioevent="listen: touchstart, push; listen:touchend, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muscenarioevent="listen: touchstart, push; listen:touchend, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muscenarioevent="listen: touchstart, press; listen:touchend, finish"></div></div></div><div id="muscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard" data-muscenarioevent = "listen:touchstart, toggleView"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muscenarioevent="listen:touchstart, toggleCaret"></div></div><div id = "muscenario-writeup" class="writeup invisible" data-wbtools="bind: showStory,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muscenarioevent="listen: touchstart, press; listen:touchend, next"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',k.place(t.get("muscenario")),k.press=function(e,t){t.classList.add("pressed")},k.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===M.get("_id")},k.next=function(e,t){j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===J?(J="screen",N.set("readonly",!0),clearInterval(S),P.set("display",!0),clearInterval(L),v.set("scenario",JSON.parse(O.toJSON())),m.unsync(),m.sync(A,m.get("_id")).then(function(){var e;return T.conclude("next"),e=m.get("elapsedTimers"),e.muscenario=P.get("timer"),m.set("elapsedTimers",e),m.set("scenario",[v.get("scenario")]),m.upload()}).then(function(){return k.updateSessionScore(P.get("timer"))}).then(function(){b("muscenario")})):b("muscenario")},k.stopSpinner=function(){j.stop()},k.prev=function(e,t){t.classList.remove("pressed"),h("muscenario")},k.toggleProgress=function(){f()},k.toggleTimer=function(){k.isLeader()&&P.set("display",!P.get("display"))},k.push=function(e,t){var i=t.getAttribute("name");N.set(i,"active")},k.zoom=function(e,t){e.stopPropagation();var i=t.getAttribute("name");k.setPopup(i)},k.fold=function(e,t){m.get("scReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),y&&w.close())},k.setPopup=function(e){var t,i={x:147,y:130},s="left",n=H.get(e),a=N.get("cardpopup"),r="";y&&(a[y]=!1),a[e]=!0,N.set("cardpopup",a),y=e,"char"===e&&(i.y=120,n.id===x.get("_id")&&(r=x.toJSON())),"context"===e&&(i.y=290,n.id===q.get("_id")&&(r=q.toJSON())),"problem"===e&&(i.y=350,n.id===C.get("_id")&&(r=C.toJSON())),r?w.reset(r,i,s,document.getElementById("muscenario-popup")):(t=new o,t.setTransport(V),t.sync(A,n.id).then(function(){r=t.toJSON(),w.reset(r,i,s,document.getElementById("muscenario-popup")),"char"===e&&x.reset(JSON.parse(t.toJSON())),"context"===e&&q.reset(JSON.parse(t.toJSON())),"problem"===e&&C.reset(JSON.parse(t.toJSON()))}))},k.closePopup=function(){var e=N.get("cardpopup");e[y]=!1,N.set("cardpopup",e),y=""},w=new l(k.closePopup),k.getChatUI=function(){return T},k.post=function(){B.selectScreen("postit"),N.set("import","inactive"),N.set("drawing","inactive")},k.importpic=function(){B.selectScreen("import"),N.set("postit","inactive"),N.set("drawing","inactive")},k.draw=function(){B.selectScreen("drawing"),N.set("import","inactive"),N.set("postit","inactive")},k.exitTool=function(e){N.set(e,"inactive")},k.finish=function(e,t){var i=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();i.spin(t.parentNode),t.classList.add("invisible"),m.unsync(),m.sync(A,m.get("_id")).then(function(){return m.set("scReady",!0),m.upload()}).then(function(){i.stop(),t.classList.remove("pressed"),N.set("ready",!1),k.displayStory(),k.updateScenario()})},k.updateField=function(e,t){t.classList.contains("enterTitle")&&O.set("title",t.value),t.classList.contains("enterDesc")&&O.set("story",t.value),t.classList.contains("enterSol")&&O.set("solution",t.value)},k.displayStory=function(){B.setReadonly(!0),N.set("showstory",!0),k.dom.querySelector(".scenario-cards").classList.remove("folded"),k.dom.querySelector(".scenario-cards .caret").classList.add("invisible"),k.dom.querySelector(".writeup").scrollIntoView(),k.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},k.hideStory=function(){k.dom.querySelector(".scenario-cards").classList.add("folded"),k.dom.querySelector(".scenario-cards .caret").classList.remove("invisible"),k.dom.querySelector(".whiteboard .caret").classList.add("invisible")},k.toggleCaret=function(e,t){e.stopPropagation();var i=k.dom.querySelector(".writeup"),s=k.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?i.scrollIntoView():s.scrollIntoView()},k.toggleView=function(e,t){var i=t.querySelector(".caret"),s=k.dom.querySelector(".writeup"),n=k.dom.querySelector(".whiteboard");i.classList.contains("descending")?(i.classList.remove("descending"),n.scrollIntoView()):e.pageY-t.scrollHeight>0&&(i.classList.add("descending"),s.scrollIntoView())},k.updateScenario=function(){L=setInterval(function(){var e=m.get("scenario")[0]||{title:"",story:"",solution:""},t=e.title,i=e.story,s=e.solution,n={};(O.get("title")!==t||O.get("story")!==i||O.get("solution")!==s)&&(n.title=O.get("title"),n.story=O.get("story"),n.solution=O.get("solution"),m.set("scenario",[n]),m.upload().then(function(){return!0},function(e){console.log("failed to update scenario",e)}))},8e3)},k.updateSessionScore=function(e){var t=new c,i={sid:m.get("_id"),step:"muscenario",time:e,wbcontent:D.toJSON(),scenario:O.toJSON()};return V.request("UpdateSessionScore",i,function(e){"ok"===e.res?(m.unsync(),m.sync(A,m.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},k.reset=function(e){T.clear(),m.get("chat")[2]&&T.reset(m.get("chat")[2]),N.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),B.setSessionId(m.get("_id")),D.reset(m.get("scenarioWB")),D.getNbItems()?B.selectScreen("main"):B.selectScreen("default"),e||m.get("scenario").length?(J="screen",T.dom.querySelector(".chatread").classList.add("extended"),N.set("ready",!1),k.displayStory(),N.set("readonly",!0),N.set("shownext",!1),O.reset(m.get("scenario")[0]),v.set("scenario",m.get("scenario")[0])):(O.reset({title:"",story:"",solution:""}),D.getNbItems()?N.set("ready",!0):N.set("ready",!1),B.setReadonly(!1),k.hideStory(),J="step"),m.get("elapsedTimers").muscenario&&(E=m.get("elapsedTimers").muscenario,P.set("timer",E),"screen"===J?P.set("display",!0):k.isLeader()&&k.initTimer(E))},k.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;P.set("display",!1),P.set("timer",s),"muscenario"===m.get("step")&&(clearInterval(S),S=setInterval(function(){var e=new Date;P.set("timer",s+e.getTime()-i)},1e3))},v.watchValue("characters",function(e){H.set("char",e)}),v.watchValue("contexts",function(e){H.set("context",e)}),v.watchValue("problems",function(e){H.set("problem",e)}),m.watchValue("_id",function(e){B.setSessionId(e)}),m.watchValue("chat",function(e){3===e.length&&T.getModel().get("_id")!==e[2]&&T.reset(e[2])}),["added","deleted","updated"].forEach(function(e){D.watch(e,function(){N.get("showstory")||((m.get("scenarioWB").length!==D.getNbItems()||JSON.stringify(m.get("scenarioWB"))!==D.toJSON())&&(m.set("scenarioWB",JSON.parse(D.toJSON())),m.upload().then(function(){return"success"},function(e){console.log("failure : ",e)})),D.getNbItems()&&"step"===J?N.set("ready",!0):N.set("ready",!1))})}),m.watchValue("scenarioWB",function(e){"muscenario"!==m.get("step")||N.get("showstory")||(e.length&&"default"===B.getStack().getCurrentName()&&B.selectScreen("main"),e.length||B.selectScreen("default"),(e.length!==D.getNbItems()||JSON.stringify(e)!==D.toJSON())&&D.reset(e))}),m.watchValue("scReady",function(e){"muscenario"===m.get("step")&&e&&!k.isLeader()&&(N.set("readonly",!0),k.displayStory())}),m.watchValue("scenario",function(e){k.isLeader()||(O.reset(e[0]),v.set("scenario",JSON.parse(O.toJSON())))}),O.watch("updated",function(){k.isLeader()&&O.get("title")&&O.get("story")&&O.get("solution")?N.set("shownext",!0):N.set("shownext",!1)}),k}});