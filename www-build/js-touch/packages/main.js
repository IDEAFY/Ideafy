/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

require(["OObject","LocalStore","service/map","Amy/Stack-plugin","Bind.plugin","Amy/Delegate-plugin","./dock","./login","service/config","service/utils","Promise"],function(e,t,n,r,i,s,o,u,a,f,l){var c=new e,h=null,p=new r({"#login":h}),d=new o,v=new t,m=f.updateLabels,g=f.checkServerStatus,y=a.get("labels"),b=a.get("db"),w=a.get("transport"),E=a.get("user"),S;S=a.get("version"),c.plugins.addAll({stack:p}),c.init=function(t){p.getStack().add("#dock",d),v.get("db")&&v.get("db")!==b&&(b=v.get("db")),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.init(),h.stopSpinner(),p.getStack().show("#dock"),d.start(t)})},c.reload=function(t){E.unsync(),E.reset(),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.reset(),h.stopSpinner(),p.getStack().show("#dock"),d.start(t)})},c.alive(n.get("body")),v.sync("ideafy-data"),h=new u(c.init,c.reload,v),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.init(),navigator.connection&&navigator.connection.type==="none"?(v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),a.set("lang",y.set("language")),h.setScreen("#nointernet")):g().then(function(){v.get("labels")?(y.reset(v.get("labels")),a.set("lang",y.get("language"))):m(navigator.language),w.request("CheckVersion",{version:S},function(e){var t=y.get("outdated")||"Please update your application";e==="outdated"&&alert(t)});var e=v.get("currentLogin")||"";e?w.request("CheckLogin",{id:e,sock:a.get("socket").socket.sessionid},function(e){e.authenticated?c.init():h.setScreen("#login-screen")}):h.setScreen("#signup-screen")},function(e){v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),h.setScreen("#maintenance-screen")}),a.get("observer").watch("signout",function(){E.set("online",!1),E.set("sock",""),E.upload(),v.set("currentLogin",""),v.set("userAvatar",""),v.sync("ideafy-data"),p.getStack().add("#login",h),h.reset(!0),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.setScreen("#login-screen"),document.getElementById("cache").classList.remove("appear")}),document.addEventListener("pause",f.disconnectSocket,!1),document.addEventListener("resume",f.checkSocketStatus,!1),n.get("body").addEventListener("touchstart",f.checkSocketStatus,!1),a.get("observer").watch("reconnect",function(e){v.sync("ideafy-data");if(navigator.connection&&navigator.connection.type==="none")h.setScreen("#nointernet");else{if(e!=="all")return E.set("online",!0),E.set("sock",a.get("socket").socket.sessionid),E.upload();g().then(function(){return E.unsync(),E.sync(b,v.get("currentLogin"))},function(){h.setScreen("#maintenance-screen")}).then(function(){return E.set("online",!0),E.set("sock",a.get("socket").socket.sessionid),E.upload()})}})});