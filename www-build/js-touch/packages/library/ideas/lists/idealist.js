/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h,p,d=null,v={db:e,view:f,design:o,query:{descending:!0}},m=n.get("user"),g=this;c.setTransport(n.get("transport")),l&&(v.query=l),g.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:touchstart, setStart; listen:touchmove, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,value.doc.authors"></div><h2 data-listideas="bind:innerHTML,value.doc.authornames"></h2><span class="date" data-listideas="bind:date, value.doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,value.doc.title"></h3><p data-listideas="bind:innerHTML, value.doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, value.doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul></div>',v.query.q&&(g.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:touchstart, setStart; listen:touchmove, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames"></h2><span class="date" data-listideas="bind:date, doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:setDesc, doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, rating"></span></div></li></ul></div>'),g.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function y(y){y?this.innerHTML=s.formatDate(y):this.innerHTML=""},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=c.get(n).doc.votes||[];r.length===0?this.innerHTML="0":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=Math.round(t*100)/100},setAvatar:function(t){var n,r},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),listevent:new i(this)}),g.getModel=function(){return c},g.resetQuery=function(e){var t=new a,r=g.dom.querySelector(".noresult"),i=n.get("user").get("library-favorites")||[],s={idList:i};return v.query=e,c.unsync(),c.reset([]),l==="fav"?n.get("transport").request("GetFavList",s,function(n){var i=JSON.parse(n),s,o,u;if(!e||e==="*")c.reset(i);else for(s=0,o=i.length;s<o;s++)u=i[s].value.doc.lang.substring(0,2),e===u&&c.alter("push",i[s]);c.getNbItems()?r.classList.add("invisible"):r.classList.remove("invisible"),t.fulfill()}):c.sync(v.db,v.design,v.view,v.query).then(function(){d&&d.hide(),c.getNbItems()?r.classList.add("invisible"):r.classList.remove("invisible"),t.fulfill()}),t},g.setStart=function(e,t){h=[e.pageX,e.pageY],d&&(d.hide(),d=null)},g.setLang=function(e){var t;if(l==="fav")t=e;else switch(f){case"_view/ideas":e==="*"?t={key:'"'+m.get("_id")+'"',descending:!0}:t={key:'[0,"'+m.get("_id")+'","'+e+'"]',descending:!0};break;case"_view/privatebyvotes":e==="*"?t={endkey:'[0,"'+m.get("_id")+'"]',startkey:'[0,"'+m.get("_id")+'",{},{}]',descending:!0}:t={endkey:'[1,"'+m.get("_id")+'"]',startkey:'[1,"'+m.get("_id")+'","'+e+'",{},{}]',descending:!0};break;default:}return g.resetQuery(t)},g.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("ideas"),i,s=!1;p=[e.pageX,e.pageY],d&&d.getParent()===t&&(s=!0),!s&&h[0]-p[0]>40&&p[1]-h[1]<20&&p[1]-h[1]>-20&&(d=new u("idea",t,c.get(n).id),i=document.createDocumentFragment(),d.place(i),t.appendChild(i))},g.init=function(){var t=new a,r=m.get("library-favorites")||[],i={idList:r},s=g.dom.querySelector(".noresult");return l==="fav"?r.length?n.get("transport").request("GetFavList",i,function(e){c.reset(JSON.parse(e)),s.classList.add("invisible"),t.fulfill()}):(c.reset([]),s.classList.remove("invisible"),t.fulfill()):c.sync(v.db,v.design,v.view,v.query).then(function(){c.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),t.fulfill()}),t}}return function(n,r,i,s){return f.prototype=new e,new f(n,r,i,s)}});