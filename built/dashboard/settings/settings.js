/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","CouchDBBulkDocuments"],function(e,t,s,i,n,a,r,c){return function(){var l=new e,o=n.get("labels"),d=n.get("user"),u=n.get("transport"),p=[{name:o.get("public"),dest:"#public"},{name:o.get("library"),dest:"#library"},{name:o.get("brainstorm"),dest:"#brainstorm"},{name:o.get("connect"),dest:"#connect"},{name:o.get("dashboard"),dest:"#dashboard"}],g=[{name:o.get("everymin"),value:6e4},{name:o.get("everyfive"),value:3e5},{name:o.get("everyfifteen"),value:9e5},{name:o.get("never"),value:864e5}],v=new a({screens:p,timers:g,pwd:"",pwdbis:"",lang:[],pwdchange:"",contentLang:d.get("lang").substring(0,2)}),b=new a([{name:"*"}]),h=n.get("userLanguages"),m=new a;return h.forEach(function(e){b.alter("push",e)}),l.plugins.addAll({label:new s(o),options:new s(v,{setLang:function(e){var t,s,i="";for(t=0,s=e.length;s>t;t++)i+="<option>"+e[t]+"</option>";this.innerHTML=i,this.selectedIndex=e.indexOf(d.get("lang"))},setStartupScreen:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].name+"</option>",e[t].dest===d.get("settings").startupScreen&&(i=t);this.innerHTML=n,this.selectedIndex=i},setPollingInterval:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].name+"</option>",e[t].value===d.get("settings").polling_interval&&(i=t);this.innerHTML=n,this.selectedIndex=i},setDecks:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].title+"</option>",e[t].id===d.get("active_deck")&&(i=t);this.innerHTML=n,this.selectedIndex=i},setBg:function(e){"all"===e?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),select:new s(b,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),settings:new s(m),settingsevent:new i(l)}),l.template='<div id="dashboard-settings"><div class="header blue-dark"><span data-label="bind:innerHTML, settingslbl"></span></div><div class="settingscontent"><div class="settingmodule"><legend data-label="bind:innerHTML, publicwallsettings"></legend><ul><li class="startupscreen"><span data-label="bind: innerHTML, choosepolling"></span><select data-options="bind:setPollingInterval, timers" data-settingsevent="listen: change, updatePollingInterval"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, brainstormsettings"></legend><ul><li class="activedeck"><span data-label="bind:innerHTML, setdeck">Set brainstorming deck</span><select data-options="bind:setDecks, decks" data-settingsevent="listen: touchstart, getDecks; listen: change, updateDeck"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, userpref"></legend><ul><li><span data-label="bind:innerHTML, setlang"></span><select data-options="bind:setLang, lang" data-settingsevent="listen: change, updateLang"></select></li><li class="activelang"><span data-label="bind:innerHTML, defaultlangfilter"></span><div class="selectlang"><div data-options="bind:setBg, contentLang"></div><button data-settingsevent = "listen:touchstart, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-settingsevent="listen: touchend, setContentLang"></li></ul></li><li class="startupscreen"><span data-label="bind: innerHTML, choosestartup"></span><select data-options="bind:setStartupScreen, screens" data-settingsevent="listen: change, updateStartup"></select></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, showTips" data-settingsevent="listen: change, showTips"><label data-label="bind:innerHTML, showtips"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, notifyPopup" data-settingsevent="listen: change, showNotif"><label data-label="bind:innerHTML, shownotif"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, useascharacter" data-settingsevent="listen: change, useAsChar"><label data-label="bind:innerHTML, usechar"></label></li><li><span data-label="bind: innerHTML, changepwd"></span><input class="input" type="password" data-label="bind:placeholder, passwordplaceholder" data-options="bind: value, pwd" data-settingsevent="listen: input, clearOK"><input class="input" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-options="bind: value, pwdbis" data-settingsevent="listen: input, clearOK"><span class="changeok" data-options="bind: innerHTML, pwdchange"></span><div class="next-button" data-label="bind:innerHTML, changelbl" data-settingsevent="listen: touchstart, press; listen:touchend, changePWD"></div></li></ul></div></div></div>',l.place(t.get("dashboard-settings")),l.updateLang=function(e,t){t.value!==d.get("lang")&&r.updateLabels(t.value).then(function(){d.set("lang",t.value),d.upload(),v.set("timers",[{name:o.get("everymin"),value:6e4},{name:o.get("everyfive"),value:3e5},{name:o.get("everyfifteen"),value:9e5},{name:o.get("never"),value:864e5}]),v.set("screens",[{name:o.get("public"),dest:"#public"},{name:o.get("library"),dest:"#library"},{name:o.get("brainstorm"),dest:"#brainstorm"},{name:o.get("connect"),dest:"#connect"},{name:o.get("dashboard"),dest:"#dahsboard"}]),m.get("contentLang")?v.set("contentLang",m.get("contentLang")):v.set("contentLang",d.get("lang").substring(0,2))})},l.displayLang=function(){l.dom.querySelector(".langlist").classList.remove("invisible")},l.setContentLang=function(e,t){var s=parseInt(t.getAttribute("data-select_id"),10),i=d.get("settings");l.dom.querySelector(".langlist").classList.add("invisible"),0===s?(i.contentLang="all",v.set("contentLang","all")):(i.contentLang=b.get(s).name,v.set("contentLang",i.contentLang)),d.set("settings",i),d.upload()},l.getDecks=function(){var e=new c,t=d.get("taiaut_decks").concat(d.get("custom_decks")),s=[];e.setTransport(n.get("transport")),e.sync(n.get("db"),{keys:t}).then(function(){v.set("decks",[]),e.loop(function(e){var t=e.doc.content;t.characters.length>=2&&t.contexts.length>=2&&t.problems.length>=2&&t.techno.length>=4&&s.push({id:e.doc._id,title:e.doc.title})}),e.unsync(),s.sort(function(e,t){var s=e.title,i=t.title;return i>s?-1:s>i?1:s===i?0:void 0}),v.set("decks",s)})},l.updateDeck=function(e,t){var s=t.selectedIndex,i=v.get("decks")[s].id;d.set("active_deck",i),d.upload()},l.updateStartup=function(e,t){var s=t.selectedIndex,i=d.get("settings");i.startupScreen=p[s].dest,d.set("settings",i),d.upload()},l.updatePollingInterval=function(e,t){var s=t.selectedIndex,i=d.get("settings");i.polling_interval=g[s].value,d.set("settings",i),d.upload()},l.showTips=function(e,t){var s=d.get("settings");s.showTips=t.checked,d.set("settings",s),d.upload().then(function(){console.log("upload successful")})},l.showNotif=function(e,t){var s=d.get("settings");s.notifyPopup=t.checked,d.set("settings",s),d.upload()},l.useAsChar=function(e,t){var s=d.get("settings");s.useascharacter=t.checked,d.set("settings",s),d.upload()},l.press=function(e,t){t.classList.add("pressed")},l.clearOK=function(){v.set("pwdchange","")},l.changePWD=function(e,t){t.classList.remove("pressed"),v.get("pwd")!==v.get("pwdbis")?v.set("pwdbis",""):u.request("ChangePWD",{userid:d.get("_id"),pwd:v.get("pwd")},function(e){"ok"===e&&v.set("pwdchange","&#10003;")})},l.reset=function(){m.reset(d.get("settings")),d.watchValue("settings",function(){m.reset(d.get("settings"))}),l.getDecks(),u.request("GetLanguages",{},function(e){v.set("lang",e)}),m.get("contentLang")?v.set("contentLang",m.get("contentLang")):v.set("contentLang",d.get("lang").substring(0,2)),v.set("timers",[{name:o.get("everymin"),value:6e4},{name:o.get("everyfive"),value:3e5},{name:o.get("everyfifteen"),value:9e5},{name:o.get("never"),value:864e5}]),v.set("screens",[{name:o.get("public"),dest:"#public"},{name:o.get("library"),dest:"#library"},{name:o.get("brainstorm"),dest:"#brainstorm"},{name:o.get("connect"),dest:"#connect"},{name:o.get("dashboard"),dest:"#dahsboard"}])},l.reset(),r.updateLabels(d.get("lang")),l}});