(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";function compareNumbers(number1,number2){if(number1>number2){return 1}else if(number1<number2){return-1}else{return 0}}module.exports={asc:compareNumbers,desc:function desc(number1,number2){return compareNumbers(number2,number1)}}},{}],2:[function(require,module,exports){"use strict";var assert=require("assert");function _getClosest(item,array,getDiff){var closest,diff;assert(Array.isArray(array),"Get closest expects an array as second argument");array.forEach(function(comparedItem,comparedItemIndex){var thisDiff=getDiff(comparedItem,item);if(thisDiff>=0&&(typeof diff=="undefined"||thisDiff<diff)){diff=thisDiff;closest=comparedItemIndex}});return closest}module.exports={number:function closestNumber(item,array){return _getClosest(item,array,function(comparedItem,item){return Math.abs(comparedItem-item)})},greaterNumber:function closestGreaterNumber(item,array){return _getClosest(item,array,function(comparedItem,item){return comparedItem-item})},lowerNumber:function closestLowerNumber(item,array){return _getClosest(item,array,function(comparedItem,item){return item-comparedItem})},custom:function closestCustom(item,array,comparator){return _getClosest(item,array,comparator)}}},{assert:257}],3:[function(require,module,exports){"use strict";module.exports=function getGlobal(){return Function("return this")()}},{}],4:[function(require,module,exports){"use strict";var Observable=require("watch-notify"),toArray=require("to-array");module.exports=function RouterConstructor(){var _routes=new Observable,_events=new Observable,_history=[],_currentPos=-1,_maxHistory=10;this.getRoutesObservable=function getRoutesObservable(){return _routes};this.getEventsObservable=function getEventsObservable(){return _events};this.setMaxHistory=function setMaxHistory(maxHistory){if(maxHistory>=0){_maxHistory=maxHistory;return true}else{return false}};this.getMaxHistory=function getMaxHistory(){return _maxHistory};this.set=function set(){return _routes.watch.apply(_routes,arguments)};this.unset=function unset(handle){return _routes.unwatch(handle)};this.navigate=function get(route){if(this.load.apply(this,arguments)){_history.splice(_currentPos+1,_history.length);_history.push(toArray(arguments));this.ensureMaxHistory(_history);_currentPos=_history.length-1;return true}else{return false}};this.ensureMaxHistory=function ensureMaxHistory(history){var count=history.length,max=this.getMaxHistory(),excess=count-max;if(excess>0){history.splice(0,excess)}};this.load=function load(){var copy=toArray(arguments);if(_routes.notify.apply(_routes,copy)){copy.unshift("route");_events.notify.apply(_events,copy);return true}else{return false}};this.watch=function watch(func,scope){return _events.watch("route",func,scope)};this.unwatch=function unwatch(handle){return _events.unwatch(handle)};this.getHistoryStore=function getHistoryStore(){return _history};this.getHistoryCount=function getHistoryCount(){return _history.length};this.clearHistory=function clearHistory(){_history.length=0};this.go=function go(nb){var history=_history[_currentPos+nb];if(history){_currentPos+=nb;this.load.apply(this,history);return true}else{return false}};this.back=function back(){return this.go(-1)};this.forward=function forward(){return this.go(1)}}},{"to-array":18,"watch-notify":20}],5:[function(require,module,exports){"use strict";var assert=require("assert");module.exports={set:setNestedProperty,get:getNestedProperty};function getNestedProperty(object,property){if(object&&typeof object=="object"){if(typeof property=="string"&&property!==""){var split=property.split(".");return split.reduce(function(obj,prop){return obj&&obj[prop]},object)}else if(typeof property=="number"){return object[property]}else{return object}}else{return object}}function setNestedProperty(object,property,value){if(object&&typeof object=="object"){if(typeof property=="string"&&property!==""){var split=property.split(".");return split.reduce(function(obj,prop,idx){obj[prop]=obj[prop]||{};if(split.length==idx+1){obj[prop]=value}return obj[prop]},object)}else if(typeof property=="number"){object[property]=value;return object[property]}else{return object}}else{return object}}},{assert:257}],6:[function(require,module,exports){"use strict";var assert=require("assert");module.exports=function count(object){assert(typeof object=="object","object must be an array or an object");if(Array.isArray(object)){return object.length}else{return count(Object.keys(object))}}},{assert:257}],7:[function(require,module,exports){"use strict";var Observable=require("watch-notify"),diff=require("shallow-diff"),clone=require("shallow-copy"),compareNumbers=require("compare-numbers"),count=require("object-count"),nestedProperty=require("nested-property"),simpleLoop=require("simple-loop");module.exports=function StoreConstructor($data){var _data=clone($data)||{},_storeObservable=new Observable,_valueObservable=new Observable,_computed=[],_notifyDiffs=function _notifyDiffs(previousData){var diffs=diff(previousData,_data);["updated","deleted","added"].forEach(function(value){diffs[value].forEach(function(dataIndex){_storeObservable.notify(value,dataIndex,_data[dataIndex]);_valueObservable.notify(dataIndex,_data[dataIndex],value)})})};this.count=function(){return count(_data)};this.get=function get(name){return _data[name]};this.has=function has(name){return _data.hasOwnProperty(name)};this.set=function set(name,value){var hasPrevious,previousValue,action;if(typeof name!="undefined"){hasPrevious=this.has(name);previousValue=this.get(name);_data[name]=value;action=hasPrevious?"updated":"added";_storeObservable.notify(action,name,_data[name],previousValue);_valueObservable.notify(name,_data[name],action,previousValue);return true}else{return false}};this.update=function update(name,property,value){var item;if(this.has(name)){item=this.get(name);nestedProperty.set(item,property,value);_storeObservable.notify("updated",property,value);_valueObservable.notify(name,item,"updated");return true}else{return false}};this.del=function del(name){var previous;if(this.has(name)){if(!this.alter("splice",name,1)){previous=_data[name];delete _data[name];_storeObservable.notify("deleted",name,undefined,previous);_valueObservable.notify(name,_data[name],"deleted",previous)}return true}else{return false}};this.delAll=function delAll(indexes){if(Array.isArray(indexes)){indexes.sort(compareNumbers.desc).forEach(this.del,this);return true}else{return false}};this.alter=function alter(func){var apply,previousData;if(_data[func]){previousData=clone(_data);apply=this.proxy.apply(this,arguments);_notifyDiffs(previousData);_storeObservable.notify("altered",_data,previousData);return apply}else{return false}};this.proxy=function proxy(func){if(_data[func]){return _data[func].apply(_data,Array.prototype.slice.call(arguments,1))}else{return false}};this.watch=function watch(name,func,scope){return _storeObservable.watch(name,func,scope)};this.unwatch=function unwatch(handle){return _storeObservable.unwatch(handle)};this.getStoreObservable=function getStoreObservable(){return _storeObservable};this.watchValue=function watchValue(name,func,scope){return _valueObservable.watch(name,func,scope)};this.unwatchValue=function unwatchValue(handler){return _valueObservable.unwatch(handler)};this.getValueObservable=function getValueObservable(){return _valueObservable};this.loop=function loop(func,scope){simpleLoop(_data,func,scope)};this.reset=function reset(data){if(typeof data=="object"){var previousData=clone(_data);_data=clone(data)||{};_notifyDiffs(previousData);_storeObservable.notify("resetted",_data,previousData);return true}else{return false}};this.compute=function compute(name,computeFrom,callback,scope){var args=[];if(typeof name=="string"&&typeof computeFrom=="object"&&typeof callback=="function"&&!this.isCompute(name)){_computed[name]=[];simpleLoop(computeFrom,function(property){_computed[name].push(this.watchValue(property,function(){this.set(name,callback.call(scope))},this))},this);this.set(name,callback.call(scope));return true}else{return false}};this.removeCompute=function removeCompute(name){if(this.isCompute(name)){simpleLoop(_computed[name],function(handle){this.unwatchValue(handle)},this);this.del(name);delete _computed[name];return true}else{return false}};this.isCompute=function isCompute(name){return!!_computed[name]};this.toJSON=function toJSON(){return JSON.stringify(_data)};this.dump=function dump(){return _data}}},{"compare-numbers":1,"nested-property":8,"object-count":6,"shallow-copy":10,"shallow-diff":11,"simple-loop":9,"watch-notify":20}],8:[function(require,module,exports){"use strict";var assert=require("assert");module.exports={set:setNestedProperty,get:getNestedProperty};function getNestedProperty(object,property){if(object&&object instanceof Object){if(typeof property=="string"&&property!==""){var split=property.split(".");return split.reduce(function(obj,prop){return obj&&obj[prop]},object)}else if(typeof property=="number"){return object[property]}else{return object}}else{return object}}function setNestedProperty(object,property,value){if(object&&object instanceof Object){if(typeof property=="string"&&property!==""){var split=property.split(".");return split.reduce(function(obj,prop,idx){obj[prop]=obj[prop]||{};if(split.length==idx+1){obj[prop]=value}return obj[prop]},object)}else if(typeof property=="number"){object[property]=value;return object[property]}else{return object}}else{return object}}},{assert:257}],9:[function(require,module,exports){"use strict";var assert=require("assert");module.exports=function loop(iterated,callback,scope){assert(typeof iterated=="object","simple-loop: iterated must be an array/object");assert(typeof callback=="function","simple-loop: callback must be a function");if(Array.isArray(iterated)){iterated.forEach(callback,scope)}else{for(var i in iterated){if(iterated.hasOwnProperty(i)){callback.call(scope,iterated[i],i,iterated)}}}}},{assert:257}],10:[function(require,module,exports){module.exports=function(obj){if(!obj||typeof obj!=="object")return obj;var copy;if(isArray(obj)){var len=obj.length;copy=Array(len);for(var i=0;i<len;i++){copy[i]=obj[i]}}else{var keys=objectKeys(obj);copy={};for(var i=0,l=keys.length;i<l;i++){var key=keys[i];copy[key]=obj[key]}}return copy};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if({}.hasOwnProperty.call(obj,key))keys.push(key)}return keys};var isArray=Array.isArray||function(xs){return{}.toString.call(xs)==="[object Array]"}},{}],11:[function(require,module,exports){"use strict";var assert=require("assert"),loop=require("simple-loop");module.exports=function shallowDiff(base,compared){assert(typeof base=="object","the first object to compare with shallowDiff needs to be an object");assert(typeof compared=="object","the second object to compare with shallowDiff needs to be an object");var unchanged=[],updated=[],deleted=[],added=[];loop(compared,function(value,idx){if(typeof base[idx]=="undefined"){added.push(idx)}else if(value!==base[idx]){updated.push(idx)}else if(value===base[idx]){unchanged.push(idx)}});loop(base,function(value,idx){if(typeof compared[idx]=="undefined"){deleted.push(idx)}});return{updated:updated,unchanged:unchanged,added:added,deleted:deleted}}},{assert:257,"simple-loop":12}],12:[function(require,module,exports){module.exports=require(9)},{assert:257}],13:[function(require,module,exports){"use strict";var assert=require("assert");module.exports=function loop(iterated,callback,scope){assert(typeof iterated=="object","simple-loop: iterated must be an array/object");assert(typeof callback=="function","simple-loop: callback must be a function");if(Array.isArray(iterated)){for(var i=0;i<iterated.length;i++){callback.call(scope,iterated[i],i,iterated)}}else{for(var i in iterated){if(iterated.hasOwnProperty(i)){callback.call(scope,iterated[i],i,iterated)}}}}},{assert:257}],14:[function(require,module,exports){"use strict";var loop=require("simple-loop");module.exports=function mixin(source,destination,dontOverride){loop(source,function(value,idx){if(!destination[idx]||!dontOverride){destination[idx]=source[idx]}});return destination}},{"simple-loop":15}],15:[function(require,module,exports){module.exports=require(9)},{assert:257}],16:[function(require,module,exports){"use strict";var toArray=require("to-array"),simpleLoop=require("simple-loop");module.exports=function StateMachineConstructor($initState,$diagram){var _states={},_currentState="";this.init=function init(name){if(_states[name]){_currentState=name;return true}else{return false}};this.add=function add(name){if(!_states[name]){var transition=_states[name]=new Transition;return transition}else{return _states[name]}};this.get=function get(name){return _states[name]};this.getCurrent=function getCurrent(){return _currentState};this.has=function has(state){return _states.hasOwnProperty(state)};this.advance=function advance(state){if(this.has(state)){_currentState=state;return true}else{return false}};this.event=function event(name){var nextState;nextState=_states[_currentState].event.apply(_states[_currentState].event,toArray(arguments));if(nextState===false){return false}else{if(nextState){_states[_currentState].event("exit");_currentState=nextState;_states[_currentState].event("entry")}return true}};if($diagram){simpleLoop($diagram,function(transition,state){var myState=this.add(state);transition.forEach(function(params){myState.add.apply(null,params)})},this)}this.init($initState)};function Transition(){var _transitions={};this.add=function add(event,action,scope,next){var arr=[];if(_transitions[event]){return false}if(typeof event=="string"&&typeof action=="function"){arr[0]=action;if(typeof scope=="object"){arr[1]=scope}if(typeof scope=="string"){arr[2]=scope}if(typeof next=="string"){arr[2]=next}_transitions[event]=arr;return true}return false};this.has=function has(event){return!!_transitions[event]};this.get=function get(event){return _transitions[event]||false};this.event=function event(newEvent){var _transition=_transitions[newEvent];if(_transition){_transition[0].apply(_transition[1],toArray(arguments).slice(1));return _transition[2]}else{return false}}}},{"simple-loop":17,"to-array":18}],17:[function(require,module,exports){module.exports=require(9)},{assert:257}],18:[function(require,module,exports){module.exports=toArray;function toArray(list,index){var array=[];index=index||0;for(var i=index||0;i<list.length;i++){array[i-index]=list[i]}return array}},{}],19:[function(require,module,exports){"use strict";module.exports=function TransportConstructor($reqHandlers){var _reqHandlers=null;this.setReqHandlers=function setReqHandlers(reqHandlers){if(typeof reqHandlers=="object"){_reqHandlers=reqHandlers;return true}else{return false}};this.getReqHandlers=function getReqHandlers(){return _reqHandlers};this.request=function request(reqHandler,data,callback,scope){if(_reqHandlers.has(reqHandler)&&typeof data!="undefined"){_reqHandlers.get(reqHandler)(data,function(){if(callback){callback.apply(scope,arguments)}});return true}else{return false}};this.listen=function listen(reqHandler,data,callback,scope){var func,abort;if(_reqHandlers.has(reqHandler)&&typeof data!="undefined"&&typeof callback=="function"){func=callback.bind(scope);abort=_reqHandlers.get(reqHandler)(data,func,func);return function(){if(typeof abort=="function"){abort()}else if(typeof abort=="object"&&typeof abort.func=="function"){abort.func.call(abort.scope)}}}else{return false}};this.setReqHandlers($reqHandlers)}},{}],20:[function(require,module,exports){"use strict";var assert=require("assert");var loop=require("simple-loop"),toArray=require("to-array");module.exports=function WatchNotifyConstructor(){var _topics={};this.watch=function watch(topic,callback,scope){if(typeof callback=="function"){var observers=_topics[topic]=_topics[topic]||[],observer=[callback,scope];observers.push(observer);return[topic,observers.indexOf(observer)]}else{return false}};this.once=function once(topic,callback,scope){var handle=this.watch(topic,function(){callback.apply(scope,arguments);this.unwatch(handle)},this);return handle};this.unwatch=function unwatch(handle){var topic=handle[0],idx=handle[1];if(_topics[topic]&&_topics[topic][idx]){delete _topics[topic][idx];if(!_topics[topic].some(function(value){return!!value})){delete _topics[topic]}return true}else{return false}};this.notify=function notify(topic){var observers=_topics[topic],args=toArray(arguments).slice(1);if(observers){loop(observers,function(value){try{if(value){value[0].apply(value[1]||null,args)}}catch(err){}});return true}else{return false}};this.hasObserver=function hasObserver(handle){return!!(handle&&_topics[handle[0]]&&_topics[handle[0]][handle[1]])};this.hasTopic=function hasTopic(topic){return!!_topics[topic]};this.unwatchAll=function unwatchAll(topic){if(_topics[topic]){delete _topics[topic]}else{_topics={}}return true}}},{assert:257,"simple-loop":21,"to-array":18}],21:[function(require,module,exports){module.exports=require(9)},{assert:257}],22:[function(require,module,exports){var compareNumbers=require("compare-numbers"),nestedProperty=require("nested-property"),getClosest=require("get-closest");module.exports={Observable:require("watch-notify"),Promise:require("./Promise"),Router:require("highway"),StateMachine:require("synchronous-fsm"),Store:require("observable-store"),Tools:{getGlobal:require("get-global"),mixin:require("simple-object-mixin"),count:require("object-count"),compareNumbers:compareNumbers.asc,toArray:require("to-array"),loop:require("simple-loop"),objectsDiffs:require("shallow-diff"),clone:require("shallow-copy"),getNestedProperty:nestedProperty.get,setNestedProperty:nestedProperty.set,closest:getClosest.number,closestGreater:getClosest.greaterNumber,closestLower:getClosest.lowerNumber},Transport:require("transport")}},{"./Promise":23,"compare-numbers":1,"get-closest":2,"get-global":3,highway:4,"nested-property":5,"object-count":6,"observable-store":7,"shallow-copy":10,"shallow-diff":11,"simple-loop":13,"simple-object-mixin":14,"synchronous-fsm":16,"to-array":18,transport:19,"watch-notify":20}],23:[function(require,module,exports){"use strict";var Observable=require("watch-notify"),StateMachine=require("synchronous-fsm");module.exports=function PromiseConstructor(){var _value=null,_reason=null,_observable=new Observable,_stateMachine=new StateMachine("Pending",{Pending:[["fulfill",function onFulfill(value){_value=value;_observable.notify("fulfill",value)},"Fulfilled"],["reject",function onReject(reason){_reason=reason;_observable.notify("reject",reason)},"Rejected"],["toFulfill",function toFulfill(resolver){_observable.watch("fulfill",resolver)}],["toReject",function toReject(resolver){_observable.watch("reject",resolver)}]],Fulfilled:[["toFulfill",function toFulfill(resolver){resolver(_value)}]],Rejected:[["toReject",function toReject(resolver){resolver(_reason)}]]});this.fulfill=function fulfill(value){setTimeout(function(){_stateMachine.event("fulfill",value)},0);return this};this.reject=function reject(reason){setTimeout(function(){_stateMachine.event("reject",reason)},0);return this};this.then=function then(){var promise=new PromiseConstructor;if(arguments[0]instanceof Function){if(arguments[1]instanceof Function){_stateMachine.event("toFulfill",this.makeResolver(promise,arguments[0]))}else{_stateMachine.event("toFulfill",this.makeResolver(promise,arguments[0],arguments[1]))}}else{_stateMachine.event("toFulfill",this.makeResolver(promise,function(){promise.fulfill(_value)}))}if(arguments[1]instanceof Function){_stateMachine.event("toReject",this.makeResolver(promise,arguments[1],arguments[2]))}if(arguments[2]instanceof Function){_stateMachine.event("toReject",this.makeResolver(promise,arguments[2],arguments[3]))}if(!(arguments[1]instanceof Function)&&!(arguments[2]instanceof Function)){_stateMachine.event("toReject",this.makeResolver(promise,function(){promise.reject(_reason)}))}return promise};this.cast=function cast(thenable){if(thenable instanceof PromiseConstructor||typeof thenable=="object"||typeof thenable=="function"){thenable.then(this.fulfill.bind(this),this.reject.bind(this));return true}else{return false}};this.makeResolver=function makeResolver(promise,func,scope){return function resolver(value){var returnedPromise;try{returnedPromise=func.call(scope,value);if(returnedPromise===promise){throw new TypeError("Promise A+ 2.3.1: If `promise` and `x` refer to the same object, reject `promise` with a `TypeError' as the reason.")}if(!promise.cast(returnedPromise)){promise.fulfill(returnedPromise)}}catch(err){promise.reject(err)}}};this.getReason=function getReason(){return _reason};this.getValue=function getValue(){return _value};this.getObservable=function getObservable(){return _observable};this.getStateMachine=function getStateMachine(){return _stateMachine};this.getStates=function getStates(){return _states}}},{"synchronous-fsm":16,"watch-notify":20}],24:[function(require,module,exports){"use strict";var Observable=require("watch-notify"),compareNumbers=require("compare-numbers"),simpleLoop=require("simple-loop"),toArray=require("to-array"),getClosest=require("get-closest"),nestedProperty=require("nested-property"),getNodes=require("get-nodes"),getDataset=require("get-dataset");function setAttribute(node,property,value){if("ownerSVGElement"in node){node.setAttribute(property,value);return true}else if("ownerDocument"in node){node[property]=value;return true}else{throw new Error("invalid element type")}}module.exports=function BindPluginConstructor($model,$bindings){var _model=null,_bindings={},_itemRenderers={},_observers={};this.observers=_observers;function _removeObserversForId(id){if(_observers[id]){_observers[id].forEach(function(handler){_model.unwatchValue(handler)});delete _observers[id]}}this.setModel=function setModel(model){_model=model};this.getModel=function getModel(){return _model};this.ItemRenderer=function ItemRenderer($plugins,$rootNode){var _node=null,_plugins=null,_rootNode=null,_start=null,_nb=null;this.setRenderer=function setRenderer(node){_node=node;return true};this.getRenderer=function getRenderer(){return _node};this.setRootNode=function setRootNode(rootNode){var renderer;_rootNode=rootNode;renderer=_rootNode.querySelector("*");this.setRenderer(renderer);if(renderer){_rootNode.removeChild(renderer)}};this.getRootNode=function getRootNode(){return _rootNode};this.setPlugins=function setPlugins(plugins){_plugins=plugins;return true};this.getPlugins=function getPlugins(){return _plugins};this.items={};this.setStart=function setStart(start){_start=parseInt(start,10);return _start};this.getStart=function getStart(){return _start};this.setNb=function setNb(nb){_nb=nb=="*"?nb:parseInt(nb,10);return _nb};this.getNb=function getNb(){return _nb};this.addItem=function addItem(id){var node,next;if(typeof id=="number"&&!this.items[id]){next=this.getNextItem(id);node=this.create(id);if(node){if(next){_rootNode.insertBefore(node,next)}else{_rootNode.appendChild(node)}return true}else{return false}}else{return false}};this.getNextItem=function getNextItem(id){var keys=Object.keys(this.items).map(function(string){return Number(string)}),closest=getClosest.greaterNumber(id,keys),closestId=keys[closest];if(closestId!=id){return this.items[closestId]}else{return}};this.removeItem=function removeItem(id){var item=this.items[id];if(item){_rootNode.removeChild(item);delete this.items[id];_removeObserversForId(id);return true}else{return false}};this.create=function create(id){if(_model.has(id)){var newNode=_node.cloneNode(true),nodes=getNodes(newNode);toArray(nodes).forEach(function(child){child.setAttribute("data-"+_plugins.name+"_id",id)});this.items[id]=newNode;_plugins.apply(newNode);return newNode}};this.render=function render(){var _tmpNb=_nb=="*"?_model.count():_nb;var marked=[];if(_nb!==null&&_start!==null){simpleLoop(this.items,function(value,idx){idx=Number(idx);if(idx<_start||idx>=_start+_tmpNb||!_model.has(idx)){marked.push(idx)}},this);marked.sort(compareNumbers.desc).forEach(this.removeItem,this);for(var i=_start,l=_tmpNb+_start;i<l;i++){this.addItem(i)}return true}else{return false}};if($plugins){this.setPlugins($plugins)}if($rootNode){this.setRootNode($rootNode)}};this.setItemRenderer=function setItemRenderer(id,itemRenderer){id=id||"default";_itemRenderers[id]=itemRenderer};this.getItemRenderer=function getItemRenderer(id){return _itemRenderers[id]};this.foreach=function foreach(node,idItemRenderer,start,nb){var itemRenderer=new this.ItemRenderer(this.plugins,node);itemRenderer.setStart(start||0);itemRenderer.setNb(nb||"*");itemRenderer.render();_model.watch("added",itemRenderer.render,itemRenderer);_model.watch("deleted",function(idx){itemRenderer.render();_removeObserversForId(idx)},this);this.setItemRenderer(idItemRenderer,itemRenderer)};this.updateStart=function updateStart(id,start){var itemRenderer=this.getItemRenderer(id);if(itemRenderer){itemRenderer.setStart(start);return true}else{return false}};this.updateNb=function updateNb(id,nb){var itemRenderer=this.getItemRenderer(id);if(itemRenderer){itemRenderer.setNb(nb);return true}else{return false}};this.refresh=function refresh(id){var itemRenderer=this.getItemRenderer(id);if(itemRenderer){itemRenderer.render();return true}else{return false}};this.bind=function bind(node,property,name){name=name||"";var id=node.getAttribute("data-"+this.plugins.name+"_id"),split=name.split("."),modelIdx=id||split.shift(),prop=id?name:split.join("."),get=nestedProperty.get(_model.get(modelIdx),prop),extraParam=toArray(arguments).slice(3);if(get||get===0||get===false){if(!this.execBinding.apply(this,[node,property,get].concat(extraParam))){setAttribute(node,property,get)}}if(!this.hasBinding(property)){node.addEventListener("change",function(event){if(_model.has(modelIdx)){if(prop){_model.update(modelIdx,name,node[property])}else{_model.set(modelIdx,node[property])}}},true)}this.observers[modelIdx]=this.observers[modelIdx]||[];this.observers[modelIdx].push(_model.watchValue(modelIdx,function(value){if(!this.execBinding.apply(this,[node,property,nestedProperty.get(value,prop)].concat(extraParam))){setAttribute(node,property,nestedProperty.get(value,prop))}},this))};this.set=function set(node){if(node.name){_model.set(node.name,node.value);return true}else{return false}};this.getItemIndex=function getElementId(dom){var dataset=getDataset(dom);if(dataset&&typeof dataset[this.plugins.name+"_id"]!="undefined"){return+dataset[this.plugins.name+"_id"]}else{return false}};this.form=function form(DOMform){if(DOMform&&DOMform.nodeName=="FORM"){var that=this;DOMform.addEventListener("submit",function(event){toArray(DOMform.querySelectorAll("[name]")).forEach(that.set,that);event.preventDefault()},true);return true}else{return false}};this.addBinding=function addBinding(name,binding){if(name&&typeof name=="string"&&typeof binding=="function"){_bindings[name]=binding;return true}else{return false}};this.execBinding=function execBinding(node,name){if(this.hasBinding(name)){_bindings[name].apply(node,Array.prototype.slice.call(arguments,2));return true}else{return false}};this.hasBinding=function hasBinding(name){return _bindings.hasOwnProperty(name)};this.getBinding=function getBinding(name){return _bindings[name]};this.addBindings=function addBindings(list){return simpleLoop(list,function(binding,name){this.addBinding(name,binding)},this)};this.setModel($model);if($bindings){this.addBindings($bindings)}}},{"compare-numbers":25,"get-closest":26,"get-dataset":27,"get-nodes":28,"nested-property":29,"simple-loop":30,"to-array":31,"watch-notify":32}],25:[function(require,module,exports){module.exports=require(1)},{}],26:[function(require,module,exports){module.exports=require(2)},{assert:257}],27:[function(require,module,exports){"use strict";module.exports=function getDataset(dom){var dataset={},i,l,split,join;if("dataset"in dom){return dom.dataset}else{for(i=0,l=dom.attributes.length;i<l;i++){split=dom.attributes[i].name.split("-");if(split.shift()=="data"){dataset[join=split.join("-")]=dom.getAttribute("data-"+join)}}return dataset}}},{}],28:[function(require,module,exports){"use strict";var toArray=require("to-array");module.exports=function getNodes(dom){var domElements=dom.querySelectorAll("*"),arrayDomElements=toArray(domElements);arrayDomElements.unshift(dom);return arrayDomElements}},{"to-array":31}],29:[function(require,module,exports){module.exports=require(5)},{assert:257}],30:[function(require,module,exports){module.exports=require(9)},{assert:257}],31:[function(require,module,exports){module.exports=require(18)},{}],32:[function(require,module,exports){module.exports=require(20)},{assert:257,"simple-loop":30,"to-array":31}],33:[function(require,module,exports){"use strict";var toArray=require("to-array");module.exports=function StackConstructor($parent){var _parent=document.createDocumentFragment(),_hidePlace=document.createElement("div"),_childNodes=[],_lastTransit=null;this.add=function add(dom){if(!this.has(dom)){_parent.appendChild(dom);_childNodes.push(dom);return dom}else{return false}};this.remove=function remove(dom){var index;if(this.has(dom)){index=_childNodes.indexOf(dom);_parent.removeChild(dom);_childNodes.splice(index,1);return dom}else{return false}};this.place=function place(newParentDom){[].slice.call(_parent.childNodes).forEach(function(childDom){if(this.has(childDom)){newParentDom.appendChild(childDom)}},this);return this._setParent(newParentDom)};this.up=function up(dom){if(this.has(dom)){var domPosition=this.getPosition(dom);this.move(dom,domPosition+1);return dom}else{return false}};this.down=function down(dom){if(this.has(dom)){var domPosition=this.getPosition(dom);this.move(dom,domPosition-1);return dom}else{return false}};this.move=function move(dom,position){if(this.has(dom)){var domIndex=_childNodes.indexOf(dom);_childNodes.splice(domIndex,1);var nextElement=getNextElementInDom(position);if(nextElement){_parent.insertBefore(dom,nextElement)}else{_parent.appendChild(dom)}_childNodes.splice(position,0,dom);return dom}else{return false}};function getNextElementInDom(position){if(position>=_childNodes.length){return}var nextElement=_childNodes[position];if(toArray(_parent.childNodes).indexOf(nextElement)==-1){return getNextElementInDom(position+1)}else{return nextElement}}this.insert=function insert(dom,position){if(!this.has(dom)){_childNodes.splice(position,0,dom);_parent.insertBefore(dom,_parent.childNodes[position]);return dom}else{return false}};this.getPosition=function getPosition(dom){return _childNodes.indexOf(dom)};this.count=function count(){return _parent.childNodes.length};this.has=function has(childDom){return this.getPosition(childDom)>=0};this.hide=function hide(dom){if(this.has(dom)){_hidePlace.appendChild(dom);return true}else{return false}};this.show=function show(dom){if(this.has(dom)&&dom.parentNode===_hidePlace){this.move(dom,_childNodes.indexOf(dom));return true}else{return false}};this.hideAll=function hideAll(){_childNodes.forEach(this.hide,this)};this.showAll=function showAll(){_childNodes.forEach(this.show,this)};this.getParent=function getParent(){return _parent};this._setParent=function _setParent(parent){_parent=parent;return _parent};this.getHidePlace=function getHidePlace(){return _hidePlace};this.setHidePlace=function setHidePlace(hidePlace){_hidePlace=hidePlace};this.getLastTransit=function getLastTransit(){return _lastTransit};this.transit=function transit(dom){if(_lastTransit){this.hide(_lastTransit)
}if(this.show(dom)){_lastTransit=dom;return true}else{return false}};if($parent){this._setParent($parent)}}},{"to-array":34}],34:[function(require,module,exports){module.exports=require(18)},{}],35:[function(require,module,exports){"use strict";module.exports=function EventPluginConstructor($parent,$isMobile){var _parent=null,matchesSelector=require("matches-selector"),_map={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},_isMobile=!!$isMobile;this.addEventListener=function addEventListener(node,event,callback,useCapture){node.addEventListener(this.map(event),callback,!!useCapture)};this.listen=function listen(node,name,listener,useCapture){this.addEventListener(node,name,function(e){_parent[listener].call(_parent,e,node)},!!useCapture)};this.delegate=function delegate(node,selector,name,listener,useCapture){this.addEventListener(node,name,function(event){if(matchesSelector(event.target,selector)){_parent[listener].call(_parent,event,node)}},!!useCapture)};this.getParent=function getParent(){return _parent};this.setParent=function setParent(parent){if(parent instanceof Object){_parent=parent;return true}return false};this.map=function map(name){return _isMobile?_map[name]||name:name};this.setMap=function setMap(name,value){if(typeof name=="string"&&typeof value=="string"){_map[name]=value;return true}return false};this.setParent($parent)}},{"matches-selector":36}],36:[function(require,module,exports){"use strict";var proto=Element.prototype;var vendor=proto.matches||proto.matchesSelector||proto.webkitMatchesSelector||proto.mozMatchesSelector||proto.msMatchesSelector||proto.oMatchesSelector;module.exports=match;function match(el,selector){if(vendor)return vendor.call(el,selector);var nodes=el.parentNode.querySelectorAll(selector);for(var i=0;i<nodes.length;i++){if(nodes[i]==el)return true}return false}},{}],37:[function(require,module,exports){"use strict";var Store=require("observable-store"),loop=require("simple-loop");function LocalStoreConstructor(){var _name=null,_localStorage=localStorage;function persistLocalStorage(){_localStorage.setItem(_name,this.toJSON())}this.setLocalStorage=function setLocalStorage(local$torage){if(local$torage&&typeof local$torage.setItem=="function"){_localStorage=local$torage;return true}else{return false}};this.getLocalStorage=function getLocalStorage(){return _localStorage};this.sync=function sync(name){var json;if(typeof name=="string"){_name=name;json=JSON.parse(_localStorage.getItem(name));loop(json,function(value,idx){if(!this.has(idx)){this.set(idx,value)}},this);persistLocalStorage.call(this);this.watch("added",persistLocalStorage,this);this.watch("updated",persistLocalStorage,this);this.watch("deleted",persistLocalStorage,this);return true}else{return false}}}module.exports=function LocalStoreFactory(init){LocalStoreConstructor.prototype=new Store(init);return new LocalStoreConstructor}},{"observable-store":38,"simple-loop":46}],38:[function(require,module,exports){arguments[4][7][0].apply(exports,arguments)},{"compare-numbers":39,"nested-property":40,"object-count":41,"shallow-copy":42,"shallow-diff":43,"simple-loop":46,"watch-notify":44}],39:[function(require,module,exports){module.exports=require(1)},{}],40:[function(require,module,exports){module.exports=require(8)},{assert:257}],41:[function(require,module,exports){module.exports=require(6)},{assert:257}],42:[function(require,module,exports){module.exports=require(10)},{}],43:[function(require,module,exports){arguments[4][11][0].apply(exports,arguments)},{assert:257,"simple-loop":46}],44:[function(require,module,exports){arguments[4][20][0].apply(exports,arguments)},{assert:257,"simple-loop":46,"to-array":45}],45:[function(require,module,exports){module.exports=require(18)},{}],46:[function(require,module,exports){module.exports=require(9)},{assert:257}],47:[function(require,module,exports){"use strict";var simpleLoop=require("simple-loop");function isSeamView(ui){return typeof ui=="object"&&typeof ui.place=="function"}module.exports=function PlacePluginConstructor($uis){var _uis={};this.place=function place(node,name){if(_uis[name]){_uis[name].place(node)}else{throw new Error(name+" is not a SeamView UI in place: "+name)}};this.set=function set(name,ui){if(typeof name=="string"&&isSeamView(ui)){_uis[name]=ui;return true}else{return false}};this.setAll=function setAll(uis){simpleLoop(uis,function(ui,name){this.set(name,ui)},this)};this.get=function get(name){return _uis[name]};if($uis){this.setAll($uis)}}},{"simple-loop":48}],48:[function(require,module,exports){module.exports=require(9)},{assert:257}],49:[function(require,module,exports){"use strict";var StateMachine=require("synchronous-fsm"),Seam=require("seam"),toArray=require("to-array");function isAcceptedType(dom){return dom.nodeType>=1}module.exports=function SeamViewConstructor(){function render(UI){var baseNode=_currentPlace||document.createElement("div");if(UI.template){if(typeof UI.template=="string"){baseNode.innerHTML=UI.template.trim()}else if(isAcceptedType(UI.template)){baseNode.appendChild(UI.template)}if(baseNode.childNodes.length>1){throw new Error("UI.template should have only one parent node")}else{UI.dom=baseNode.childNodes[0]}UI.seam.apply(UI.dom)}else{throw new Error("UI.template must be set prior to render")}}function place(UI,DOMplace,beforeNode){if(DOMplace){if(beforeNode){DOMplace.insertBefore(UI.dom,beforeNode)}else{DOMplace.appendChild(UI.dom)}_currentPlace=DOMplace}}function renderNPlace(UI,dom){render(UI);place.apply(null,toArray(arguments))}var _currentPlace=null,_stateMachine=new StateMachine("Init",{Init:[["render",render,this,"Rendered"],["place",renderNPlace,this,"Rendered"]],Rendered:[["place",place,this],["render",render,this]]});this.seam=new Seam;this.template=null;this.dom=null;this.place=function place(node,beforeNode){_stateMachine.event("place",this,node,beforeNode)};this.render=function render(){_stateMachine.event("render",this)};this.setTemplateFromDom=function setTemplateFromDom(dom){if(isAcceptedType(dom)){this.template=dom;return true}else{return false}};this.alive=function alive(dom){if(isAcceptedType(dom)){this.setTemplateFromDom(dom);this.place(dom.parentNode,dom.nextElementSibling);return true}else{return false}};this.getCurrentPlace=function(){return _currentPlace}}},{seam:53,"synchronous-fsm":50,"to-array":52}],50:[function(require,module,exports){arguments[4][16][0].apply(exports,arguments)},{"simple-loop":51,"to-array":52}],51:[function(require,module,exports){module.exports=require(9)},{assert:257}],52:[function(require,module,exports){module.exports=require(18)},{}],53:[function(require,module,exports){"use strict";var toArray=require("to-array"),simpleLoop=require("simple-loop"),getNodes=require("get-nodes"),getDataset=require("get-dataset");module.exports=function Seam($plugins){var _plugins={},trim=function trim(string){return string.trim()},applyPlugin=function applyPlugin(node,phrase,plugin){phrase.split(";").forEach(function(couple){var split=couple.split(":"),method=split[0].trim(),params=split[1]?split[1].split(",").map(trim):[];params.unshift(node);if(_plugins[plugin]&&_plugins[plugin][method]){_plugins[plugin][method].apply(_plugins[plugin],params)}})};this.add=function add(name,plugin){var propertyName="plugins";if(typeof name=="string"&&typeof plugin=="object"&&plugin){_plugins[name]=plugin;plugin[propertyName]={name:name,apply:function apply(){return this.apply.apply(this,arguments)}.bind(this)};return true}else{return false}};this.addAll=function addAll(list){return simpleLoop(list,function(plugin,name){this.add(name,plugin)},this)};this.get=function get(name){return _plugins[name]};this.del=function del(name){return delete _plugins[name]};this.apply=function apply(dom){var nodes=getNodes(dom);simpleLoop(toArray(nodes),function(node){simpleLoop(getDataset(node),function(phrase,plugin){applyPlugin(node,phrase,plugin)})});return dom};if($plugins){this.addAll($plugins)}}},{"get-dataset":54,"get-nodes":55,"simple-loop":56,"to-array":57}],54:[function(require,module,exports){module.exports=require(27)},{}],55:[function(require,module,exports){arguments[4][28][0].apply(exports,arguments)},{"to-array":57}],56:[function(require,module,exports){module.exports=require(9)},{assert:257}],57:[function(require,module,exports){module.exports=require(18)},{}],58:[function(require,module,exports){"use strict";var Highway=require("highway"),toArray=require("to-array");function UrlHighway(){var _watchHandle,_defaultRoute="",_lastRoute=window.location.hash;function doNavigate(){if(!hashIsEmpty()){var parsedHash=this.parse(window.location.hash);this.navigate.apply(this,parsedHash)}else{this.navigate(_defaultRoute)}}function hashIsEmpty(){return!window.location.hash||window.location.hash=="#"}this.setDefaultRoute=function setDefaultRoute(defaultRoute){if(defaultRoute&&typeof defaultRoute=="string"){_defaultRoute=defaultRoute;return true}else{return false}};this.getDefaultRoute=function getDefaultRoute(){return _defaultRoute};this.parse=function parse(hash){return hash.split("#").pop().split("/")};this.toUrl=function toUrl(args){return args.join("/")};this.start=function start(defaultRoute){this.setDefaultRoute(defaultRoute);doNavigate.call(this);this.bindOnHashChange();this.bindOnRouteChange()};this.destroy=function destroy(){this.unwatch(_watchHandle);window.removeEventListener("hashchange",this.boundOnHashChange,true)};this.onHashChange=function onHashChange(){if(window.location.hash!=_lastRoute){doNavigate.call(this)}};this.boundOnHashChange=this.onHashChange.bind(this);this.bindOnHashChange=function bindOnHashChange(){window.addEventListener("hashchange",this.boundOnHashChange,true)};this.bindOnRouteChange=function bindOnRouteChange(){_watchHandle=this.watch(this.onRouteChange,this)};this.onRouteChange=function onRouteChange(){window.location.hash=this.toUrl(toArray(arguments));_lastRoute=window.location.hash};this.getLastRoute=function getLastRoute(){return _lastRoute}}module.exports=function UrlHighwayFactory(){UrlHighway.prototype=new Highway;UrlHighway.constructor=Highway;return new UrlHighway}},{highway:59,"to-array":62}],59:[function(require,module,exports){arguments[4][4][0].apply(exports,arguments)},{"to-array":62,"watch-notify":60}],60:[function(require,module,exports){arguments[4][20][0].apply(exports,arguments)},{assert:257,"simple-loop":61,"to-array":62}],61:[function(require,module,exports){module.exports=require(9)},{assert:257}],62:[function(require,module,exports){module.exports=require(18)},{}],63:[function(require,module,exports){"use strict";module.exports={"Bind.plugin":require("data-binding-plugin"),LocalStore:require("local-observable-store"),LocationRouter:require("url-highway"),OObject:require("seam-view"),"Event.plugin":require("event-plugin"),"Place.plugin":require("place-plugin"),Plugins:require("seam"),SocketIOTransport:require("socketio-transport"),Stack:require("dom-stack")}},{"data-binding-plugin":24,"dom-stack":33,"event-plugin":35,"local-observable-store":37,"place-plugin":47,seam:53,"seam-view":49,"socketio-transport":65,"url-highway":58}],64:[function(require,module,exports){"use strict";module.exports=function SocketIOTransportConstructor($socket){var _socket=null;this.setSocket=function setSocket(socket){if(socket&&typeof socket.emit=="function"){_socket=socket;return true}else{return false}};this.getSocket=function getSocket(){return _socket};this.on=function on(event,func){return _socket.on(event,func)};this.once=function once(event,func){return _socket.once(event,func)};this.emit=function emit(event,data,callback){return _socket.emit(event,data,callback)};this.removeListener=function removeListener(event,data,callback){return _socket.removeListener(event,data,callback)};this.request=function request(channel,data,func,scope){if(typeof channel=="string"&&typeof data!="undefined"){var reqData={eventId:Date.now()+Math.floor(Math.random()*1e6),data:data},boundCallback=function(){if(func){func.apply(scope||null,arguments)}};this.once(reqData.eventId,boundCallback);this.emit(channel,reqData);return true}else{return false}};this.listen=function listen(channel,data,func,scope){if(typeof channel=="string"&&typeof data!="undefined"&&typeof func=="function"){var reqData={eventId:Date.now()+Math.floor(Math.random()*1e6),data:data,keepAlive:true},boundCallback=function(){if(func){func.apply(scope||null,arguments)}},that=this;this.on(reqData.eventId,boundCallback);this.emit(channel,reqData);return function stop(){that.emit("disconnect-"+reqData.eventId);that.removeListener(reqData.eventId,boundCallback)}}else{return false}};this.setSocket($socket)}},{}],65:[function(require,module,exports){"use strict";module.exports={Client:require("./client/index"),Server:require("./server/index")}},{"./client/index":64,"./server/index":66}],66:[function(require,module,exports){var isConnected=false;module.exports=function registerSocketIO(io,handlers){if(isConnected){return false}else{io.sockets.on("connection",function(socket){var connectHandler=function(func,handler){socket.on(handler,function(reqData){reqData.data.handshake=socket.handshake;var stop=func(reqData.data,function onEnd(body){socket.emit(reqData.eventId,body)},function onData(chunk){reqData.keepAlive&&socket.emit(reqData.eventId,""+chunk)});if(typeof stop=="function"){socket.on("disconnect-"+reqData.eventId,stop)}})};handlers.loop(connectHandler);handlers.watch("added",connectHandler)});isConnected=true}}},{}],67:[function(require,module,exports){"use strict";var Store=require("emily").Store,Promise=require("emily").Promise;function _isStateMachine(stateMachine){if(typeof stateMachine=="object"&&typeof stateMachine.event=="function"){return true}else{return false}}function _isTransport(transport){if(typeof transport=="object"&&typeof transport.request=="function"&&typeof transport.listen=="function"){return true}else{return false}}function _isPromise(promise){if(typeof promise=="object"&&typeof promise.fulfill=="function"&&typeof promise.reject=="function"&&typeof promise.then=="function"){return true}else{return false}}function CouchDBBaseConstructor(){var _stateMachine=null,_handlerName="CouchDB",_transport=null,_syncInfo,_promise=new Promise;this.setPromise=function setPromise(promise){if(_isPromise(promise)){_promise=promise;return true}else{return false}};this.getPromise=function getPromise(){return _promise};this.getStateMachine=function getStateMachine(){return _stateMachine};this.setStateMachine=function setStateMachine(stateMachine){if(_isStateMachine(stateMachine)){_stateMachine=stateMachine;return true}else{return false}};this.getTransport=function getTransport(){return _transport};this.setTransport=function setTransport(transport){if(_isTransport(transport)){_transport=transport;return true}else{return false}};this.getHandlerName=function getHandlerName(){return _handlerName};this.setHandlerName=function setHandlerName(handlerName){if(typeof handlerName=="string"){_handlerName=handlerName;return true}else{return false}};this.sync=function sync(){_promise=new Promise;_syncInfo=this.setSyncInfo.apply(this,arguments);if(_syncInfo){_stateMachine.event("sync");return _promise}else{return false}};this.unsync=function unsync(){return _stateMachine.event("unsync")};this.getSyncInfo=function getSyncInfo(){return _syncInfo};this.onSync=function onSync(){};this.onListen=function onListen(){};this.onUnsync=function onUnsync(){if(this.stopListening){this.stopListening();delete this.stopListening}};this.unsync=function unsync(){_stateMachine.event("unsync")};this.onChange=function onChange(){};this.onAdd=function onAdd(){};this.onRemove=function onRemove(){};this.setSyncInfo=function setSyncInfo(syncInfo){_syncInfo=syncInfo;return _syncInfo}}module.exports=function CouchDBBaseFactory(data){CouchDBBaseConstructor.prototype=new Store(data);return new CouchDBBaseConstructor}},{emily:22}],68:[function(require,module,exports){"use strict";var CouchDBBase=require("./CouchDBBase");var Tools=require("emily").Tools,Promise=require("emily").Promise,StateMachine=require("emily").StateMachine,CouchDBChanges=require("./CouchDBChanges");function CouchDBBulkDocumentsConstructor(){this.setSyncInfo=function setSyncInfo(database,query){if(typeof database=="string"&&typeof query=="object"){var _syncInfo={database:database,query:query||{}};if(Array.isArray(_syncInfo.query.keys)){_syncInfo.keys=_syncInfo.query.keys;delete _syncInfo.query.keys}return _syncInfo}else{return false}};this.onSync=function onSync(){var _syncInfo=this.getSyncInfo(),reqData={path:"/"+_syncInfo.database+"/_all_docs",query:_syncInfo.query},errorString;if(Array.isArray(_syncInfo.keys)){reqData.method="POST";reqData.data=JSON.stringify({keys:_syncInfo.keys});reqData.headers={"Content-Type":"application/json"};errorString=reqData.data}else{reqData.method="GET";errorString=JSON.stringify(_syncInfo.query)}_syncInfo.query.include_docs=true;this.getTransport().request(this.getHandlerName(),reqData,function(results){var json=JSON.parse(results);if(!json.rows){throw new Error('CouchDBBulkDocuments.sync("'+_syncInfo.database+'", '+errorString+") failed: "+results)}else{this.reset(json.rows);this.getStateMachine().event("listen");this.getPromise().fulfill(this)}},this)};this.onListen=function onListen(){var _syncInfo=this.getSyncInfo(),handle;handle=CouchDBChanges.getObserver().watch("changes",function(changes){var action;if(changes.changes[0].rev.search("1-")===0){action="add"}else if(changes.deleted){action="remove"}else{action="change"}this.getStateMachine().event(action,changes.id,changes.doc)},this);this.stopListening=function(){CouchDBChanges.getObserver().unwatch(handle)}};this.onAdd=function onAdd(id){var _syncInfo=this.getSyncInfo();if(_syncInfo.query.startkey||_syncInfo.query.endkey){_syncInfo.query.include_docs=true;_syncInfo.query.update_seq=true;this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/_all_docs",query:_syncInfo.query},function(results){var json=JSON.parse(results);json.rows.forEach(function(value,idx){if(value.id==id){this.alter("splice",idx,0,value.doc)}},this)},this)}else{return false}};this.onChange=function onChange(id,doc){this.loop(function(value,idx){if(value.id==id){this.set(idx,doc)}},this)};this.onRemove=function onRemove(id){this.loop(function(value,idx){if(value.id==id){this.del(idx)}},this)};this.databaseUpdate=function databaseUpdate(promise){var docs=[],_syncInfo=this.getSyncInfo();this.loop(function(value){docs.push(value.doc)});this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+_syncInfo.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:docs})},function(response){var updates=JSON.parse(response);this.loop(function(doc,idx){if(updates[idx].ok){doc.doc._rev=updates[idx].rev}});promise.fulfill(updates)},this)};this.upload=function upload(){var promise=new Promise;this.getStateMachine().event("upload",promise);return promise};this.setStateMachine(new StateMachine("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function NOOP(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}module.exports=function CouchDBBulkDocumentsFactory(data){CouchDBBulkDocumentsConstructor.prototype=new CouchDBBase(data);return new CouchDBBulkDocumentsConstructor}},{"./CouchDBBase":67,"./CouchDBChanges":69,emily:22}],69:[function(require,module,exports){"use strict";var Store=require("emily").Store,Promise=require("emily").Promise,Observable=require("emily").Observable;function _isTransport(transport){if(typeof transport=="object"&&typeof transport.request=="function"&&typeof transport.listen=="function"){return true}else{return false}}var _changeObserver=new Observable;function CouchDBChangesConstructor(){var _observer=_changeObserver,_changeHandlerName="CouchDBChange",_transport=null;this.getTransport=function getTransport(){return _transport};this.setTransport=function setTransport(transport){if(_isTransport(transport)){_transport=transport;return true}else{return false}};this.getChangeHandlerName=function getChangeHandlerName(){return _changeHandlerName};this.getObserver=function getObserver(){return _observer};this.watch=function watch(callback){_observer.watch("changes",function(data){callback(data)})};this.initStream=function initStream(db){this.getStream=this.getTransport().listen(this.getChangeHandlerName(),{path:"/"+db,query:{feed:"continuous",heartbeat:2e4,since:"now"}},function(changes){var json;if(changes=="\n"){return false}json=JSON.parse(changes);_observer.notify("changes",json)},this)};this.endStream=function(){if(this.getStream)this.getStream();delete this.getStream}}module.exports=new CouchDBChangesConstructor},{emily:22}],70:[function(require,module,exports){"use strict";var CouchDBBase=require("./CouchDBBase");var Promise=require("emily").Promise,StateMachine=require("emily").StateMachine,CouchDBChanges=require("./CouchDBChanges");function CouchDBDocumentConstructor(){this.setSyncInfo=function setSyncInfo(database,doc,query){if(typeof database=="string"&&typeof doc=="string"){if(!query||typeof query=="object"){return{database:database,document:doc,query:query||{}}}else{return false}}else{return false}};this.onSync=function onSync(){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/"+_syncInfo.document,query:_syncInfo.query},function(results){var json=JSON.parse(results);if(json._id){this.reset(json);this.getStateMachine().event("listen")}this.getPromise().fulfill(json)},this)};this.onListen=function onListen(){var _syncInfo=this.getSyncInfo(),handle;handle=CouchDBChanges.getObserver().watch("changes",function(changes){if(changes.id==_syncInfo.document&&changes.changes.pop().rev!=this.get("_rev")){if(changes.deleted){this.getStateMachine().event("remove")}else{this.getStateMachine().event("change")}}},this);this.stopListening=function(){CouchDBChanges.getObserver().unwatch(handle)}};this.onChange=function onChange(){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/"+_syncInfo.document},function(doc){this.reset(JSON.parse(doc))},this)};this.onRemove=function onRemove(){this.reset({})};this.upload=function upload(){var promise=new Promise,_syncInfo=this.getSyncInfo();if(_syncInfo.document){this.getStateMachine().event("upload",promise);return promise}return false};this.remove=function remove(){var promise=new Promise;this.getStateMachine().event("removeFromDatabase",promise);return promise};this.databaseCreate=function databaseCreate(promise){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+_syncInfo.database+"/"+_syncInfo.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(result){var json=JSON.parse(result);if(json.ok){this.set("_rev",json.rev);this.set("_id",json.id);this.getStateMachine().event("listen");promise.fulfill(json)}else{promise.reject(json)}},this)};this.databaseUpdate=function databaseUpdate(promise){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+_syncInfo.database+"/"+_syncInfo.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(response){var json=JSON.parse(response);if(json.ok){this.set("_rev",json.rev);promise.fulfill(json)}else{promise.reject(json)}},this)};this.databaseRemove=function databaseRemove(promise){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+_syncInfo.database+"/"+_syncInfo.document,query:{rev:this.get("_rev")}},function(response){var json=JSON.parse(response);if(json.ok){promise.fulfill(json)}else{promise.reject(json)}})};this.setStateMachine(new StateMachine("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function NOOP(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}module.exports=function CouchDBDocumentFactory(data){CouchDBDocumentConstructor.prototype=new CouchDBBase(data);return new CouchDBDocumentConstructor}},{"./CouchDBBase":67,"./CouchDBChanges":69,emily:22}],71:[function(require,module,exports){"use strict";var CouchDBDocument=require("./CouchDBDocument");function CouchDBSecurityConstructor(){var _name="_security";this.setName=function setName(name){if(name){_name=name;return true}else{return false}};this.getName=function getName(){return _name};this.load=function load(db){return this.sync(db,_name)}}module.exports=function CouchDBSecurityFactory(){CouchDBSecurityConstructor.prototype=new CouchDBDocument;return new CouchDBSecurityConstructor}},{"./CouchDBDocument":70}],72:[function(require,module,exports){"use strict";module.exports={CouchDBBulkDocuments:require("./CouchDBBulkDocuments"),CouchDBDocument:require("./CouchDBDocument"),CouchDBView:require("./CouchDBView"),CouchDBSecurity:require("./CouchDBSecurity"),CouchDBUser:require("./CouchDBUser"),CouchDBChanges:require("./CouchDBChanges")}},{"./CouchDBBulkDocuments":68,"./CouchDBChanges":69,"./CouchDBDocument":70,"./CouchDBSecurity":71,"./CouchDBUser":73,"./CouchDBView":74}],73:[function(require,module,exports){"use strict";var CouchDBDocument=require("./CouchDBDocument");var Promise=require("emily").Promise;function CouchDBUserConstructor(){var _userDB="_users",_idPrefix="org.couchdb.user:";this.getUserDB=function getUserDB(){return _userDB};this.setUserDB=function setUserDB(name){if(name){_userDB=name;return true}else{return false}};this.getIdPrefix=function getIdPrefix(){return _idPrefix};this.setIdPrefix=function setIdPrefix(name){if(name){_idPrefix=name;return true}else{return false}};this.setId=function setId(id){if(id){this.set("_id",_idPrefix+id);return true}else{return false}};this.getId=function getId(){return this.get("_id")};this.load=function load(id){return this.sync(_userDB,_idPrefix+id)};this.login=function login(){var promise=new Promise,name=this.get("name"),password=this.get("password");if(name&&typeof name=="string"&&typeof password=="string"){this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+name,auth:name+":"+password},promise.fulfill,promise)}else{promise.reject({error:"name & password must be strings"})}return promise};this.create=function create(){var promise=new Promise;if(!this.get("type")){this.set("type","user")}if(!this.get("roles")){this.set("roles",[])}this.load(this.get("name")).then(function(){promise.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(success){promise.fulfill(success)},function(error){promise.reject(error)})},this);return promise}}module.exports=function CouchDBUserFactory(){CouchDBUserConstructor.prototype=new CouchDBDocument;return new CouchDBUserConstructor}},{"./CouchDBDocument":70,emily:22}],74:[function(require,module,exports){"use strict";var CouchDBBase=require("./CouchDBBase");var Tools=require("emily").Tools,StateMachine=require("emily").StateMachine,CouchDBChanges=require("./CouchDBChanges");function CouchDBViewConstructor(){this.setSyncInfo=function setSyncInfo(database,designDocument,view,query){if(typeof database=="string"&&typeof designDocument=="string"&&typeof view=="string"){if(!query||typeof query=="object"){return{database:database,design:designDocument,view:view,query:query||{}}}else{return false}}else{return false}};this.onSync=function onSync(){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/_design/"+_syncInfo.design+"/"+_syncInfo.view,query:_syncInfo.query},function(results){var json=JSON.parse(results);if(!json.rows){throw new Error("CouchDBStore ["+_syncInfo.database+", "+_syncInfo.design+", "+_syncInfo.view+"].sync() failed: "+results)}else{this.reset(json.rows);if(typeof json.total_rows=="undefined"){_syncInfo.reducedView=true}this.getStateMachine().event("listen");this.getPromise().fulfill(json)}},this)};this.onListen=function onListen(){var _syncInfo=this.getSyncInfo(),handle;handle=CouchDBChanges.getObserver().watch("changes",function(changes){var action;if(_syncInfo.reducedView){action="updateReduced"}else{if(changes.deleted){action="remove"}else if(changes.changes&&changes.changes[0].rev.search("1-")===0){action="add"}else{action="change"}}this.getStateMachine().event(action,changes.id)},this);this.stopListening=function(){CouchDBChanges.getObserver().unwatch(handle)}};this.onChange=function onChange(id){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/_design/"+_syncInfo.design+"/"+_syncInfo.view,query:_syncInfo.query},function(view){var json=JSON.parse(view);if(json.rows.length==this.count()){json.rows.some(function(value,idx){if(value.id==id){this.set(idx,value)}},this)}else{this.evenDocsInStore.call(this,json.rows,id)}},this)};this.evenDocsInStore=function evenDocsInStore(view,id){var nbItems=this.count();if(view.length<nbItems){this.loop(function(value,idx){if(value.id==id){this.del(idx)}},this)}else if(view.length>nbItems){view.some(function(value,idx){if(value.id==id){return this.alter("splice",idx,0,value)}},this)}};this.onAdd=function onAdd(id){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/_design/"+_syncInfo.design+"/"+_syncInfo.view,query:_syncInfo.query},function(view){var json=JSON.parse(view);json.rows.some(function(value,idx){if(value.id==id){this.alter("splice",idx,0,value)}},this)},this)};this.onRemove=function onRemove(id){this.loop(function(value,idx){if(value.id==id){this.del(idx)}},this)};this.updateReduced=function updateReduced(){var _syncInfo=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+_syncInfo.database+"/_design/"+_syncInfo.design+"/"+_syncInfo.view,query:_syncInfo.query},function(view){var json=JSON.parse(view);this.set(0,json.rows[0])},this)};this.setStateMachine(new StateMachine("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function NOOP(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}module.exports=function CouchDBViewFactory(data){CouchDBViewConstructor.prototype=new CouchDBBase(data);return new CouchDBViewConstructor}},{"./CouchDBBase":67,"./CouchDBChanges":69,emily:22}],75:[function(require,module,exports){var olives=require("./olives"),emily=require("./emily"),Tools=emily.Tools,Store=emily.Store,Observer=emily.Observable,OObject=olives.OObject,Amy={};var hasQuerySelector=function(parent,node,selector){var getNodes=function(parent,selector){if(parent instanceof HTMLElement||parent instanceof SVGElement){if(!parent.parentNode){document.createDocumentFragment().appendChild(parent)}return parent.parentNode.querySelectorAll(selector||"*")}else{return false}};return Tools.toArray(getNodes(parent,selector)).indexOf(node)>-1};Amy.TestUtils=function(){var _isString=function(string){return typeof string=="string"},_throw=function(error,message){throw new Error(_isString(message)?message:error)};return{assertIsObject:function(object,message){if(!(object instanceof Object)){_throw("Is not Object",message)}return true},assertIsObservable:function(observable,message){if(!(observable&&typeof observable["watch"]=="function"&&typeof observable["notify"]=="function")){_throw("Is not Observable",message)
}return true},assertIsString:function(string,message){if(!_isString(string)){_throw("Is not String",message)}return true}}};Amy.StackPlugin=function StackPluginConstructor($uis,$destination){var _stack=new Amy.Stack($uis,$destination);this.getStack=function(){return _stack};this.destination=function(node){_stack.setDestination(node)};this.hide=function(){_stack.hide()};this.show=function(node,eventType,attribute,useCapture){node.addEventListener(eventType,function(event){_stack.show(event.target.getAttribute(attribute))},useCapture=="true")}};Amy.EventController=function EventControllerConstructor($scope,$touch){var Utils=Amy.TestUtils,_scope=$scope instanceof Object?$scope:null,_isBoolean=function(bool){return typeof bool=="boolean"?bool:false},_isString=function(){var bool=true,l;for(l=arguments.length;l>=0;l--){bool=bool&&typeof arguments[l]=="string"}return bool},_touch=_isBoolean($touch),_map={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"};this.addListener=function(node,event,callback,useCapture){node.addEventListener(this.map(event),callback,useCapture)};this.call=function(method){_scope[method].apply(_scope,Tools.toArray(arguments).slice(1))};this.isTouch=function(){return _touch};this.setTouch=function(touch){if(_isBoolean(touch)){_touch=touch;return true}return false};this.setMap=function(key,value){if(_isString(key,value)){_map[key]=value;return true}return false};this.map=function(key){var value=_map[key];return value&&_touch?value:key};this.setScope=function(scope){_scope=scope;return true};this.scope=function(){return _scope}};var DelegatePluginConstructor=function(){this.listen=function(node,type,listener,useCapture){var that=this;this.addListener(node,type,function(event){that.call(listener,event,node)},useCapture=="true")};this.selector=function(node,selector,type,listener,useCapture){var that=this;this.addListener(node,type,function(event){if(hasQuerySelector(node,event.target,selector))that.call(listener,event,node)},useCapture=="true")}};Amy.DelegatePlugin=function DelegatePluginFactory($scope,$touch){DelegatePluginConstructor.prototype=new Amy.EventController($scope,$touch);return new DelegatePluginConstructor};var ControlPluginConstructor=function(){var _current=null;this.init=function(node){_current=node};this.radio=function(node,query,className,type,callback,useCapture){var that=this;this.addListener(node,type,function(event){var target=event.target;if(hasQuerySelector(node,target,query)){that.radioClass(target,_current,className);_current=target;that.call(callback,event)}},useCapture=="true")};this.radioClass=function(node,previous,className){node.classList.add(className);if(previous&&previous!=node){previous.classList.remove(className)}};this.toggleClass=function(node,className){return node.classList.toggle(className)};this.toggle=function(node,query,className,type,callback,useCapture){var that=this;this.addListener(node,type,function(event){var target=event.target;if(hasQuerySelector(node,target,query)){that.toggleClass(target,className);that.call(callback,event)}},useCapture=="true")}};Amy.ControlPlugin=function ControlPluginFactory($scope,$touch){ControlPluginConstructor.prototype=new Amy.EventController($scope,$touch);return new ControlPluginConstructor};Amy.Stack=function ScreensConstructor($uis,$default){var _store=new Store($uis),_observer=new Observer,_destination=$default,_currentName="",_currentScreen=null;this.setDestination=function setDestination(destination){if(destination instanceof HTMLElement||destination instanceof SVGElement){_destination=destination;return true}else{return false}};this.getDestination=function getDestination(){return _destination};this.setCurrentScreen=function setCurrentScreen(ui){_currentScreen=ui;_observer.notify("StackChange",ui)};this.getCurrentScreen=function getCurrentScreen(){return _currentScreen};this.add=function add(name,ui){if(typeof name=="string"&&ui instanceof OObject){_store.set(name,ui);this.hide(ui);return true}else{return false}};this.get=function get(name){return _store.get(name)};this.del=function del(name){return _store.del(name)};this.reset=function reset(uis){return _store.reset(uis)};this.getCurrentName=function getCurrentName(){return _currentName};this.show=function show(name){var ui=this.get(name);if(ui&&name!==_currentName){ui.place(_destination);_currentScreen&&this.hide(_currentScreen);this.setCurrentScreen(ui);_currentName=name;return true}else{return false}};this.hide=function hide(ui){ui.place(document.createDocumentFragment())};this.getObserver=function getObserver(){return _observer}};module.exports=Amy},{"./emily":97,"./olives":141}],76:[function(require,module,exports){module.exports=require(1)},{}],77:[function(require,module,exports){module.exports=require(2)},{assert:257}],78:[function(require,module,exports){module.exports=require(3)},{}],79:[function(require,module,exports){arguments[4][4][0].apply(exports,arguments)},{"to-array":93,"watch-notify":95}],80:[function(require,module,exports){module.exports=require(5)},{assert:257}],81:[function(require,module,exports){module.exports=require(6)},{assert:257}],82:[function(require,module,exports){arguments[4][7][0].apply(exports,arguments)},{"compare-numbers":76,"nested-property":83,"object-count":81,"shallow-copy":85,"shallow-diff":86,"simple-loop":84,"watch-notify":95}],83:[function(require,module,exports){module.exports=require(8)},{assert:257}],84:[function(require,module,exports){module.exports=require(9)},{assert:257}],85:[function(require,module,exports){module.exports=require(10)},{}],86:[function(require,module,exports){arguments[4][11][0].apply(exports,arguments)},{assert:257,"simple-loop":87}],87:[function(require,module,exports){module.exports=require(9)},{assert:257}],88:[function(require,module,exports){module.exports=require(13)},{assert:257}],89:[function(require,module,exports){arguments[4][14][0].apply(exports,arguments)},{"simple-loop":90}],90:[function(require,module,exports){module.exports=require(9)},{assert:257}],91:[function(require,module,exports){arguments[4][16][0].apply(exports,arguments)},{"simple-loop":92,"to-array":93}],92:[function(require,module,exports){module.exports=require(9)},{assert:257}],93:[function(require,module,exports){module.exports=require(18)},{}],94:[function(require,module,exports){module.exports=require(19)},{}],95:[function(require,module,exports){arguments[4][20][0].apply(exports,arguments)},{assert:257,"simple-loop":96,"to-array":93}],96:[function(require,module,exports){module.exports=require(9)},{assert:257}],97:[function(require,module,exports){arguments[4][22][0].apply(exports,arguments)},{"./Promise":98,"compare-numbers":76,"get-closest":77,"get-global":78,highway:79,"nested-property":80,"object-count":81,"observable-store":82,"shallow-copy":85,"shallow-diff":86,"simple-loop":88,"simple-object-mixin":89,"synchronous-fsm":91,"to-array":93,transport:94,"watch-notify":95}],98:[function(require,module,exports){module.exports=require(23)},{"synchronous-fsm":91,"watch-notify":95}],99:[function(require,module,exports){arguments[4][24][0].apply(exports,arguments)},{"compare-numbers":100,"get-closest":101,"get-dataset":102,"get-nodes":103,"nested-property":104,"simple-loop":105,"to-array":106,"watch-notify":107}],100:[function(require,module,exports){module.exports=require(1)},{}],101:[function(require,module,exports){module.exports=require(2)},{assert:257}],102:[function(require,module,exports){module.exports=require(27)},{}],103:[function(require,module,exports){arguments[4][28][0].apply(exports,arguments)},{"to-array":106}],104:[function(require,module,exports){module.exports=require(5)},{assert:257}],105:[function(require,module,exports){module.exports=require(9)},{assert:257}],106:[function(require,module,exports){module.exports=require(18)},{}],107:[function(require,module,exports){module.exports=require(20)},{assert:257,"simple-loop":105,"to-array":106}],108:[function(require,module,exports){arguments[4][33][0].apply(exports,arguments)},{"to-array":109}],109:[function(require,module,exports){module.exports=require(18)},{}],110:[function(require,module,exports){arguments[4][35][0].apply(exports,arguments)},{"matches-selector":111}],111:[function(require,module,exports){module.exports=require(36)},{}],112:[function(require,module,exports){arguments[4][37][0].apply(exports,arguments)},{"observable-store":113,"simple-loop":121}],113:[function(require,module,exports){arguments[4][7][0].apply(exports,arguments)},{"compare-numbers":114,"nested-property":115,"object-count":116,"shallow-copy":117,"shallow-diff":118,"simple-loop":121,"watch-notify":119}],114:[function(require,module,exports){module.exports=require(1)},{}],115:[function(require,module,exports){module.exports=require(8)},{assert:257}],116:[function(require,module,exports){module.exports=require(6)},{assert:257}],117:[function(require,module,exports){module.exports=require(10)},{}],118:[function(require,module,exports){arguments[4][11][0].apply(exports,arguments)},{assert:257,"simple-loop":121}],119:[function(require,module,exports){arguments[4][20][0].apply(exports,arguments)},{assert:257,"simple-loop":121,"to-array":120}],120:[function(require,module,exports){module.exports=require(18)},{}],121:[function(require,module,exports){module.exports=require(9)},{assert:257}],122:[function(require,module,exports){arguments[4][47][0].apply(exports,arguments)},{"simple-loop":123}],123:[function(require,module,exports){module.exports=require(9)},{assert:257}],124:[function(require,module,exports){arguments[4][49][0].apply(exports,arguments)},{seam:128,"synchronous-fsm":125,"to-array":127}],125:[function(require,module,exports){arguments[4][16][0].apply(exports,arguments)},{"simple-loop":126,"to-array":127}],126:[function(require,module,exports){module.exports=require(9)},{assert:257}],127:[function(require,module,exports){module.exports=require(18)},{}],128:[function(require,module,exports){arguments[4][53][0].apply(exports,arguments)},{"get-dataset":129,"get-nodes":130,"simple-loop":131,"to-array":132}],129:[function(require,module,exports){module.exports=require(27)},{}],130:[function(require,module,exports){arguments[4][28][0].apply(exports,arguments)},{"to-array":132}],131:[function(require,module,exports){module.exports=require(9)},{assert:257}],132:[function(require,module,exports){module.exports=require(18)},{}],133:[function(require,module,exports){module.exports=require(64)},{}],134:[function(require,module,exports){arguments[4][65][0].apply(exports,arguments)},{"./client/index":133,"./server/index":135}],135:[function(require,module,exports){module.exports=require(66)},{}],136:[function(require,module,exports){arguments[4][58][0].apply(exports,arguments)},{highway:137,"to-array":140}],137:[function(require,module,exports){arguments[4][4][0].apply(exports,arguments)},{"to-array":140,"watch-notify":138}],138:[function(require,module,exports){arguments[4][20][0].apply(exports,arguments)},{assert:257,"simple-loop":139,"to-array":140}],139:[function(require,module,exports){module.exports=require(9)},{assert:257}],140:[function(require,module,exports){module.exports=require(18)},{}],141:[function(require,module,exports){module.exports=require(63)},{"data-binding-plugin":99,"dom-stack":108,"event-plugin":110,"local-observable-store":112,"place-plugin":122,seam:128,"seam-view":124,"socketio-transport":134,"url-highway":136}],142:[function(require,module,exports){var io="undefined"==typeof module?{}:module.exports;(function(){(function(a,b){var c=a;c.version="0.9.16",c.protocol=1,c.transports=[],c.j=[],c.sockets={},c.connect=function(a,d){var e=c.util.parseUri(a),f,g;b&&b.location&&(e.protocol=e.protocol||b.location.protocol.slice(0,-1),e.host=e.host||(b.document?b.document.domain:b.location.hostname),e.port=e.port||b.location.port),f=c.util.uniqueUri(e);var h={host:e.host,secure:"https"==e.protocol,port:e.port||("https"==e.protocol?443:80),query:e.query||""};c.util.merge(h,d);if(h["force new connection"]||!c.sockets[f])g=new c.Socket(h);return!h["force new connection"]&&g&&(c.sockets[f]=g),g=g||c.sockets[f],g.of(e.path.length>1?e.path:"")}})("object"==typeof module?module.exports:this.io={},this),function(a,b){var c=a.util={},d=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,e=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];c.parseUri=function(a){var b=d.exec(a||""),c={},f=14;while(f--)c[e[f]]=b[f]||"";return c},c.uniqueUri=function(a){var c=a.protocol,d=a.host,e=a.port;return"document"in b?(d=d||document.domain,e=e||(c=="https"&&document.location.protocol!=="https:"?443:document.location.port)):(d=d||"localhost",!e&&c=="https"&&(e=443)),(c||"http")+"://"+d+":"+(e||80)},c.query=function(a,b){var d=c.chunkQuery(a||""),e=[];c.merge(d,c.chunkQuery(b||""));for(var f in d)d.hasOwnProperty(f)&&e.push(f+"="+d[f]);return e.length?"?"+e.join("&"):""},c.chunkQuery=function(a){var b={},c=a.split("&"),d=0,e=c.length,f;for(;d<e;++d)f=c[d].split("="),f[0]&&(b[f[0]]=f[1]);return b};var f=!1;c.load=function(a){if("document"in b&&document.readyState==="complete"||f)return a();c.on(b,"load",a,!1)},c.on=function(a,b,c,d){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener&&a.addEventListener(b,c,d)},c.request=function(a){if(a&&"undefined"!=typeof XDomainRequest&&!c.ua.hasCORS)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!a||c.ua.hasCORS))return new XMLHttpRequest;if(!a)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(b){}return null},"undefined"!=typeof window&&c.load(function(){f=!0}),c.defer=function(a){if(!c.ua.webkit||"undefined"!=typeof importScripts)return a();c.load(function(){setTimeout(a,100)})},c.merge=function(b,d,e,f){var g=f||[],h=typeof e=="undefined"?2:e,i;for(i in d)d.hasOwnProperty(i)&&c.indexOf(g,i)<0&&(typeof b[i]!="object"||!h?(b[i]=d[i],g.push(d[i])):c.merge(b[i],d[i],h-1,g));return b},c.mixin=function(a,b){c.merge(a.prototype,b.prototype)},c.inherit=function(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c},c.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},c.intersect=function(a,b){var d=[],e=a.length>b.length?a:b,f=a.length>b.length?b:a;for(var g=0,h=f.length;g<h;g++)~c.indexOf(e,f[g])&&d.push(f[g]);return d},c.indexOf=function(a,b,c){for(var d=a.length,c=c<0?c+d<0?0:c+d:c||0;c<d&&a[c]!==b;c++);return d<=c?-1:c},c.toArray=function(a){var b=[];for(var c=0,d=a.length;c<d;c++)b.push(a[c]);return b},c.ua={},c.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(b){return!1}return a.withCredentials!=undefined}(),c.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),c.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(a,b){function c(){}a.EventEmitter=c,c.prototype.on=function(a,c){return this.$events||(this.$events={}),this.$events[a]?b.util.isArray(this.$events[a])?this.$events[a].push(c):this.$events[a]=[this.$events[a],c]:this.$events[a]=c,this},c.prototype.addListener=c.prototype.on,c.prototype.once=function(a,b){function d(){c.removeListener(a,d),b.apply(this,arguments)}var c=this;return d.listener=b,this.on(a,d),this},c.prototype.removeListener=function(a,c){if(this.$events&&this.$events[a]){var d=this.$events[a];if(b.util.isArray(d)){var e=-1;for(var f=0,g=d.length;f<g;f++)if(d[f]===c||d[f].listener&&d[f].listener===c){e=f;break}if(e<0)return this;d.splice(e,1),d.length||delete this.$events[a]}else(d===c||d.listener&&d.listener===c)&&delete this.$events[a]}return this},c.prototype.removeAllListeners=function(a){return a===undefined?(this.$events={},this):(this.$events&&this.$events[a]&&(this.$events[a]=null),this)},c.prototype.listeners=function(a){return this.$events||(this.$events={}),this.$events[a]||(this.$events[a]=[]),b.util.isArray(this.$events[a])||(this.$events[a]=[this.$events[a]]),this.$events[a]},c.prototype.emit=function(a){if(!this.$events)return!1;var c=this.$events[a];if(!c)return!1;var d=Array.prototype.slice.call(arguments,1);if("function"==typeof c)c.apply(this,d);else{if(!b.util.isArray(c))return!1;var e=c.slice();for(var f=0,g=e.length;f<g;f++)e[f].apply(this,d)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){function f(a){return a<10?"0"+a:a}function date(a,b){return isFinite(a.valueOf())?a.getUTCFullYear()+"-"+f(a.getUTCMonth()+1)+"-"+f(a.getUTCDate())+"T"+f(a.getUTCHours())+":"+f(a.getUTCMinutes())+":"+f(a.getUTCSeconds())+"Z":null}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i instanceof Date&&(i=date(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";return e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g,e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)typeof rep[c]=="string"&&(d=rep[c],e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));return e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g,e}}"use strict";if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return str("",{"":a});throw new Error("JSON.stringify")},JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,typeof JSON!="undefined"?JSON:undefined),function(a,b){var c=a.parser={},d=c.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],e=c.reasons=["transport not supported","client not handshaken","unauthorized"],f=c.advice=["reconnect"],g=b.JSON,h=b.util.indexOf;c.encodePacket=function(a){var b=h(d,a.type),c=a.id||"",i=a.endpoint||"",j=a.ack,k=null;switch(a.type){case"error":var l=a.reason?h(e,a.reason):"",m=a.advice?h(f,a.advice):"";if(l!==""||m!=="")k=l+(m!==""?"+"+m:"");break;case"message":a.data!==""&&(k=a.data);break;case"event":var n={name:a.name};a.args&&a.args.length&&(n.args=a.args),k=g.stringify(n);break;case"json":k=g.stringify(a.data);break;case"connect":a.qs&&(k=a.qs);break;case"ack":k=a.ackId+(a.args&&a.args.length?"+"+g.stringify(a.args):"")}var o=[b,c+(j=="data"?"+":""),i];return k!==null&&k!==undefined&&o.push(k),o.join(":")},c.encodePayload=function(a){var b="";if(a.length==1)return a[0];for(var c=0,d=a.length;c<d;c++){var e=a[c];b+="�"+e.length+"�"+a[c]}return b};var i=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;c.decodePacket=function(a){var b=a.match(i);if(!b)return{};var c=b[2]||"",a=b[5]||"",h={type:d[b[1]],endpoint:b[4]||""};c&&(h.id=c,b[3]?h.ack="data":h.ack=!0);switch(h.type){case"error":var b=a.split("+");h.reason=e[b[0]]||"",h.advice=f[b[1]]||"";break;case"message":h.data=a||"";break;case"event":try{var j=g.parse(a);h.name=j.name,h.args=j.args}catch(k){}h.args=h.args||[];break;case"json":try{h.data=g.parse(a)}catch(k){}break;case"connect":h.qs=a||"";break;case"ack":var b=a.match(/^([0-9]+)(\+)?(.*)/);if(b){h.ackId=b[1],h.args=[];if(b[3])try{h.args=b[3]?g.parse(b[3]):[]}catch(k){}}break;case"disconnect":case"heartbeat":}return h},c.decodePayload=function(a){if(a.charAt(0)=="�"){var b=[];for(var d=1,e="";d<a.length;d++)a.charAt(d)=="�"?(b.push(c.decodePacket(a.substr(d+1).substr(0,e))),d+=Number(e)+1,e=""):e+=a.charAt(d);return b}return[c.decodePacket(a)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b){function c(a,b){this.socket=a,this.sessid=b}a.Transport=c,b.util.mixin(c,b.EventEmitter),c.prototype.heartbeats=function(){return!0},c.prototype.onData=function(a){this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout();if(a!==""){var c=b.parser.decodePayload(a);if(c&&c.length)for(var d=0,e=c.length;d<e;d++)this.onPacket(c[d])}return this},c.prototype.onPacket=function(a){return this.socket.setHeartbeatTimeout(),a.type=="heartbeat"?this.onHeartbeat():(a.type=="connect"&&a.endpoint==""&&this.onConnect(),a.type=="error"&&a.advice=="reconnect"&&(this.isOpen=!1),this.socket.onPacket(a),this)},c.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var a=this;this.closeTimeout=setTimeout(function(){a.onDisconnect()},this.socket.closeTimeout)}},c.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},c.prototype.onConnect=function(){return this.socket.onConnect(),this},c.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},c.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},c.prototype.packet=function(a){this.send(b.parser.encodePacket(a))},c.prototype.onHeartbeat=function(a){this.packet({type:"heartbeat"})},c.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},c.prototype.onClose=function(){var a=this;this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},c.prototype.prepareUrl=function(){var a=this.socket.options;return this.scheme()+"://"+a.host+":"+a.port+"/"+a.resource+"/"+b.protocol+"/"+this.name+"/"+this.sessid},c.prototype.ready=function(a,b){b.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(a){this.options={port:80,secure:!1,document:"document"in c?document:!1,resource:"socket.io",transports:b.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},b.util.merge(this.options,a),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||b.util.ua.hasCORS)){var d=this;b.util.on(c,"beforeunload",function(){d.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function e(){}a.Socket=d,b.util.mixin(d,b.EventEmitter),d.prototype.of=function(a){return this.namespaces[a]||(this.namespaces[a]=new b.SocketNamespace(this,a),a!==""&&this.namespaces[a].packet({type:"connect"})),this.namespaces[a]},d.prototype.publish=function(){this.emit.apply(this,arguments);var a;for(var b in this.namespaces)this.namespaces.hasOwnProperty(b)&&(a=this.of(b),a.$emit.apply(a,arguments))},d.prototype.handshake=function(a){function f(b){b instanceof Error?(c.connecting=!1,c.onError(b.message)):a.apply(null,b.split(":"))}var c=this,d=this.options,g=["http"+(d.secure?"s":"")+":/",d.host+":"+d.port,d.resource,b.protocol,b.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!b.util.ua.hasCORS){var h=document.getElementsByTagName("script")[0],i=document.createElement("script");i.src=g+"&jsonp="+b.j.length,h.parentNode.insertBefore(i,h),b.j.push(function(a){f(a),i.parentNode.removeChild(i)})}else{var j=b.util.request();j.open("GET",g,!0),this.isXDomain()&&(j.withCredentials=!0),j.onreadystatechange=function(){j.readyState==4&&(j.onreadystatechange=e,j.status==200?f(j.responseText):j.status==403?c.onError(j.responseText):(c.connecting=!1,!c.reconnecting&&c.onError(j.responseText)))},j.send(null)}},d.prototype.getTransport=function(a){var c=a||this.transports,d;for(var e=0,f;f=c[e];e++)if(b.Transport[f]&&b.Transport[f].check(this)&&(!this.isXDomain()||b.Transport[f].xdomainCheck(this)))return new b.Transport[f](this,this.sessionid);return null},d.prototype.connect=function(a){if(this.connecting)return this;var c=this;return c.connecting=!0,this.handshake(function(d,e,f,g){function h(a){c.transport&&c.transport.clearTimeouts(),c.transport=c.getTransport(a);if(!c.transport)return c.publish("connect_failed");c.transport.ready(c,function(){c.connecting=!0,c.publish("connecting",c.transport.name),c.transport.open(),c.options["connect timeout"]&&(c.connectTimeoutTimer=setTimeout(function(){if(!c.connected){c.connecting=!1;if(c.options["try multiple transports"]){var a=c.transports;while(a.length>0&&a.splice(0,1)[0]!=c.transport.name);a.length?h(a):c.publish("connect_failed")}}},c.options["connect timeout"]))})}c.sessionid=d,c.closeTimeout=f*1e3,c.heartbeatTimeout=e*1e3,c.transports||(c.transports=c.origTransports=g?b.util.intersect(g.split(","),c.options.transports):c.options.transports),c.setHeartbeatTimeout(),h(c.transports),c.once("connect",function(){clearTimeout(c.connectTimeoutTimer),a&&typeof a=="function"&&a()})}),this},d.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);if(this.transport&&!this.transport.heartbeats())return;var a=this;this.heartbeatTimeoutTimer=setTimeout(function(){a.transport.onClose()},this.heartbeatTimeout)},d.prototype.packet=function(a){return this.connected&&!this.doBuffer?this.transport.packet(a):this.buffer.push(a),this},d.prototype.setBuffer=function(a){this.doBuffer=a,!a&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},d.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},d.prototype.disconnect=function(){if(this.connected||this.connecting)this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted");return this},d.prototype.disconnectSync=function(){var a=b.util.request(),c=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,b.protocol,"",this.sessionid].join("/")+"/?disconnect=1";a.open("GET",c,!1),a.send(null),this.onDisconnect("booted")},d.prototype.isXDomain=function(){var a=c.location.port||("https:"==c.location.protocol?443:80);return this.options.host!==c.location.hostname||this.options.port!=a},d.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},d.prototype.onOpen=function(){this.open=!0},d.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},d.prototype.onPacket=function(a){this.of(a.endpoint).onPacket(a)},d.prototype.onError=function(a){a&&a.advice&&a.advice==="reconnect"&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",a&&a.reason?a.reason:a)},d.prototype.onDisconnect=function(a){var b=this.connected,c=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1;if(b||c)this.transport.close(),this.transport.clearTimeouts(),b&&(this.publish("disconnect",a),"booted"!=a&&this.options.reconnect&&!this.reconnecting&&this.reconnect())},d.prototype.reconnect=function(){function e(){if(a.connected){for(var b in a.namespaces)a.namespaces.hasOwnProperty(b)&&""!==b&&a.namespaces[b].packet({type:"connect"});a.publish("reconnect",a.transport.name,a.reconnectionAttempts)}clearTimeout(a.reconnectionTimer),a.removeListener("connect_failed",f),a.removeListener("connect",f),a.reconnecting=!1,delete a.reconnectionAttempts,delete a.reconnectionDelay,delete a.reconnectionTimer,delete a.redoTransports,a.options["try multiple transports"]=c}function f(){if(!a.reconnecting)return;if(a.connected)return e();if(a.connecting&&a.reconnecting)return a.reconnectionTimer=setTimeout(f,1e3);a.reconnectionAttempts++>=b?a.redoTransports?(a.publish("reconnect_failed"),e()):(a.on("connect_failed",f),a.options["try multiple transports"]=!0,a.transports=a.origTransports,a.transport=a.getTransport(),a.redoTransports=!0,a.connect()):(a.reconnectionDelay<d&&(a.reconnectionDelay*=2),a.connect(),a.publish("reconnecting",a.reconnectionDelay,a.reconnectionAttempts),a.reconnectionTimer=setTimeout(f,a.reconnectionDelay))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var a=this,b=this.options["max reconnection attempts"],c=this.options["try multiple transports"],d=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(f,this.reconnectionDelay),this.on("connect",f)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b){function c(a,b){this.socket=a,this.name=b||"",this.flags={},this.json=new d(this,"json"),this.ackPackets=0,this.acks={}}function d(a,b){this.namespace=a,this.name=b}a.SocketNamespace=c,b.util.mixin(c,b.EventEmitter),c.prototype.$emit=b.EventEmitter.prototype.emit,c.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},c.prototype.packet=function(a){return a.endpoint=this.name,this.socket.packet(a),this.flags={},this},c.prototype.send=function(a,b){var c={type:this.flags.json?"json":"message",data:a};return"function"==typeof b&&(c.id=++this.ackPackets,c.ack=!0,this.acks[c.id]=b),this.packet(c)},c.prototype.emit=function(a){var b=Array.prototype.slice.call(arguments,1),c=b[b.length-1],d={type:"event",name:a};return"function"==typeof c&&(d.id=++this.ackPackets,d.ack="data",this.acks[d.id]=c,b=b.slice(0,b.length-1)),d.args=b,this.packet(d)},c.prototype.disconnect=function(){return this.name===""?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},c.prototype.onPacket=function(a){function d(){c.packet({type:"ack",args:b.util.toArray(arguments),ackId:a.id})}var c=this;switch(a.type){case"connect":this.$emit("connect");break;case"disconnect":this.name===""?this.socket.onDisconnect(a.reason||"booted"):this.$emit("disconnect",a.reason);break;case"message":case"json":var e=["message",a.data];a.ack=="data"?e.push(d):a.ack&&this.packet({type:"ack",ackId:a.id}),this.$emit.apply(this,e);break;case"event":var e=[a.name].concat(a.args);a.ack=="data"&&e.push(d),this.$emit.apply(this,e);break;case"ack":this.acks[a.ackId]&&(this.acks[a.ackId].apply(this,a.args),delete this.acks[a.ackId]);break;case"error":a.advice?this.socket.onError(a):a.reason=="unauthorized"?this.$emit("connect_failed",a.reason):this.$emit("error",a.reason)}},d.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)
},d.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(a){b.Transport.apply(this,arguments)}a.websocket=d,b.util.inherit(d,b.Transport),d.prototype.name="websocket",d.prototype.open=function(){var a=b.util.query(this.socket.options.query),d=this,e;return e||(e=c.MozWebSocket||c.WebSocket),this.websocket=new e(this.prepareUrl()+a),this.websocket.onopen=function(){d.onOpen(),d.socket.setBuffer(!1)},this.websocket.onmessage=function(a){d.onData(a.data)},this.websocket.onclose=function(){d.onClose(),d.socket.setBuffer(!0)},this.websocket.onerror=function(a){d.onError(a)},this},b.util.ua.iDevice?d.prototype.send=function(a){var b=this;return setTimeout(function(){b.websocket.send(a)},0),this}:d.prototype.send=function(a){return this.websocket.send(a),this},d.prototype.payload=function(a){for(var b=0,c=a.length;b<c;b++)this.packet(a[b]);return this},d.prototype.close=function(){return this.websocket.close(),this},d.prototype.onError=function(a){this.socket.onError(a)},d.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},d.check=function(){return"WebSocket"in c&&!("__addTask"in WebSocket)||"MozWebSocket"in c},d.xdomainCheck=function(){return!0},b.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b){function c(){b.Transport.websocket.apply(this,arguments)}a.flashsocket=c,b.util.inherit(c,b.Transport.websocket),c.prototype.name="flashsocket",c.prototype.open=function(){var a=this,c=arguments;return WebSocket.__addTask(function(){b.Transport.websocket.prototype.open.apply(a,c)}),this},c.prototype.send=function(){var a=this,c=arguments;return WebSocket.__addTask(function(){b.Transport.websocket.prototype.send.apply(a,c)}),this},c.prototype.close=function(){return WebSocket.__tasks.length=0,b.Transport.websocket.prototype.close.call(this),this},c.prototype.ready=function(a,d){function e(){var b=a.options,e=b["flash policy port"],g=["http"+(b.secure?"s":"")+":/",b.host+":"+b.port,b.resource,"static/flashsocket","WebSocketMain"+(a.isXDomain()?"Insecure":"")+".swf"];c.loaded||(typeof WEB_SOCKET_SWF_LOCATION=="undefined"&&(WEB_SOCKET_SWF_LOCATION=g.join("/")),e!==843&&WebSocket.loadFlashPolicyFile("xmlsocket://"+b.host+":"+e),WebSocket.__initialize(),c.loaded=!0),d.call(f)}var f=this;if(document.body)return e();b.util.load(e)},c.check=function(){return typeof WebSocket!="undefined"&&"__initialize"in WebSocket&&!!swfobject?swfobject.getFlashPlayerVersion().major>=10:!1},c.xdomainCheck=function(){return!0},typeof window!="undefined"&&(WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0),b.transports.push("flashsocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window)var swfobject=function(){function A(){if(t)return;try{var a=i.getElementsByTagName("body")[0].appendChild(Q("span"));a.parentNode.removeChild(a)}catch(b){return}t=!0;var c=l.length;for(var d=0;d<c;d++)l[d]()}function B(a){t?a():l[l.length]=a}function C(b){if(typeof h.addEventListener!=a)h.addEventListener("load",b,!1);else if(typeof i.addEventListener!=a)i.addEventListener("load",b,!1);else if(typeof h.attachEvent!=a)R(h,"onload",b);else if(typeof h.onload=="function"){var c=h.onload;h.onload=function(){c(),b()}}else h.onload=b}function D(){k?E():F()}function E(){var c=i.getElementsByTagName("body")[0],d=Q(b);d.setAttribute("type",e);var f=c.appendChild(d);if(f){var g=0;(function(){if(typeof f.GetVariable!=a){var b=f.GetVariable("$version");b&&(b=b.split(" ")[1].split(","),y.pv=[parseInt(b[0],10),parseInt(b[1],10),parseInt(b[2],10)])}else if(g<10){g++,setTimeout(arguments.callee,10);return}c.removeChild(d),f=null,F()})()}else F()}function F(){var b=m.length;if(b>0)for(var c=0;c<b;c++){var d=m[c].id,e=m[c].callbackFn,f={success:!1,id:d};if(y.pv[0]>0){var g=P(d);if(g)if(S(m[c].swfVersion)&&!(y.wk&&y.wk<312))U(d,!0),e&&(f.success=!0,f.ref=G(d),e(f));else if(m[c].expressInstall&&H()){var h={};h.data=m[c].expressInstall,h.width=g.getAttribute("width")||"0",h.height=g.getAttribute("height")||"0",g.getAttribute("class")&&(h.styleclass=g.getAttribute("class")),g.getAttribute("align")&&(h.align=g.getAttribute("align"));var i={},j=g.getElementsByTagName("param"),k=j.length;for(var l=0;l<k;l++)j[l].getAttribute("name").toLowerCase()!="movie"&&(i[j[l].getAttribute("name")]=j[l].getAttribute("value"));I(h,i,d,e)}else J(g),e&&e(f)}else{U(d,!0);if(e){var n=G(d);n&&typeof n.SetVariable!=a&&(f.success=!0,f.ref=n),e(f)}}}}function G(c){var d=null,e=P(c);if(e&&e.nodeName=="OBJECT")if(typeof e.SetVariable!=a)d=e;else{var f=e.getElementsByTagName(b)[0];f&&(d=f)}return d}function H(){return!u&&S("6.0.65")&&(y.win||y.mac)&&!(y.wk&&y.wk<312)}function I(b,c,d,e){u=!0,r=e||null,s={success:!1,id:d};var g=P(d);if(g){g.nodeName=="OBJECT"?(p=K(g),q=null):(p=g,q=d),b.id=f;if(typeof b.width==a||!/%$/.test(b.width)&&parseInt(b.width,10)<310)b.width="310";if(typeof b.height==a||!/%$/.test(b.height)&&parseInt(b.height,10)<137)b.height="137";i.title=i.title.slice(0,47)+" - Flash Player Installation";var j=y.ie&&y.win?["Active"].concat("").join("X"):"PlugIn",k="MMredirectURL="+h.location.toString().replace(/&/g,"%26")+"&MMplayerType="+j+"&MMdoctitle="+i.title;typeof c.flashvars!=a?c.flashvars+="&"+k:c.flashvars=k;if(y.ie&&y.win&&g.readyState!=4){var l=Q("div");d+="SWFObjectNew",l.setAttribute("id",d),g.parentNode.insertBefore(l,g),g.style.display="none",function(){g.readyState==4?g.parentNode.removeChild(g):setTimeout(arguments.callee,10)}()}L(b,c,d)}}function J(a){if(y.ie&&y.win&&a.readyState!=4){var b=Q("div");a.parentNode.insertBefore(b,a),b.parentNode.replaceChild(K(a),b),a.style.display="none",function(){a.readyState==4?a.parentNode.removeChild(a):setTimeout(arguments.callee,10)}()}else a.parentNode.replaceChild(K(a),a)}function K(a){var c=Q("div");if(y.win&&y.ie)c.innerHTML=a.innerHTML;else{var d=a.getElementsByTagName(b)[0];if(d){var e=d.childNodes;if(e){var f=e.length;for(var g=0;g<f;g++)(e[g].nodeType!=1||e[g].nodeName!="PARAM")&&e[g].nodeType!=8&&c.appendChild(e[g].cloneNode(!0))}}}return c}function L(c,d,f){var g,h=P(f);if(y.wk&&y.wk<312)return g;if(h){typeof c.id==a&&(c.id=f);if(y.ie&&y.win){var i="";for(var j in c)c[j]!=Object.prototype[j]&&(j.toLowerCase()=="data"?d.movie=c[j]:j.toLowerCase()=="styleclass"?i+=' class="'+c[j]+'"':j.toLowerCase()!="classid"&&(i+=" "+j+'="'+c[j]+'"'));var k="";for(var l in d)d[l]!=Object.prototype[l]&&(k+='<param name="'+l+'" value="'+d[l]+'" />');h.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+i+">"+k+"</object>",n[n.length]=c.id,g=P(c.id)}else{var m=Q(b);m.setAttribute("type",e);for(var o in c)c[o]!=Object.prototype[o]&&(o.toLowerCase()=="styleclass"?m.setAttribute("class",c[o]):o.toLowerCase()!="classid"&&m.setAttribute(o,c[o]));for(var p in d)d[p]!=Object.prototype[p]&&p.toLowerCase()!="movie"&&M(m,p,d[p]);h.parentNode.replaceChild(m,h),g=m}}return g}function M(a,b,c){var d=Q("param");d.setAttribute("name",b),d.setAttribute("value",c),a.appendChild(d)}function N(a){var b=P(a);b&&b.nodeName=="OBJECT"&&(y.ie&&y.win?(b.style.display="none",function(){b.readyState==4?O(a):setTimeout(arguments.callee,10)}()):b.parentNode.removeChild(b))}function O(a){var b=P(a);if(b){for(var c in b)typeof b[c]=="function"&&(b[c]=null);b.parentNode.removeChild(b)}}function P(a){var b=null;try{b=i.getElementById(a)}catch(c){}return b}function Q(a){return i.createElement(a)}function R(a,b,c){a.attachEvent(b,c),o[o.length]=[a,b,c]}function S(a){var b=y.pv,c=a.split(".");return c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10)||0,c[2]=parseInt(c[2],10)||0,b[0]>c[0]||b[0]==c[0]&&b[1]>c[1]||b[0]==c[0]&&b[1]==c[1]&&b[2]>=c[2]?!0:!1}function T(c,d,e,f){if(y.ie&&y.mac)return;var g=i.getElementsByTagName("head")[0];if(!g)return;var h=e&&typeof e=="string"?e:"screen";f&&(v=null,w=null);if(!v||w!=h){var j=Q("style");j.setAttribute("type","text/css"),j.setAttribute("media",h),v=g.appendChild(j),y.ie&&y.win&&typeof i.styleSheets!=a&&i.styleSheets.length>0&&(v=i.styleSheets[i.styleSheets.length-1]),w=h}y.ie&&y.win?v&&typeof v.addRule==b&&v.addRule(c,d):v&&typeof i.createTextNode!=a&&v.appendChild(i.createTextNode(c+" {"+d+"}"))}function U(a,b){if(!x)return;var c=b?"visible":"hidden";t&&P(a)?P(a).style.visibility=c:T("#"+a,"visibility:"+c)}function V(b){var c=/[\\\"<>\.;]/,d=c.exec(b)!=null;return d&&typeof encodeURIComponent!=a?encodeURIComponent(b):b}var a="undefined",b="object",c="Shockwave Flash",d="ShockwaveFlash.ShockwaveFlash",e="application/x-shockwave-flash",f="SWFObjectExprInst",g="onreadystatechange",h=window,i=document,j=navigator,k=!1,l=[D],m=[],n=[],o=[],p,q,r,s,t=!1,u=!1,v,w,x=!0,y=function(){var f=typeof i.getElementById!=a&&typeof i.getElementsByTagName!=a&&typeof i.createElement!=a,g=j.userAgent.toLowerCase(),l=j.platform.toLowerCase(),m=l?/win/.test(l):/win/.test(g),n=l?/mac/.test(l):/mac/.test(g),o=/webkit/.test(g)?parseFloat(g.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,p=!1,q=[0,0,0],r=null;if(typeof j.plugins!=a&&typeof j.plugins[c]==b)r=j.plugins[c].description,r&&(typeof j.mimeTypes==a||!j.mimeTypes[e]||!!j.mimeTypes[e].enabledPlugin)&&(k=!0,p=!1,r=r.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),q[0]=parseInt(r.replace(/^(.*)\..*$/,"$1"),10),q[1]=parseInt(r.replace(/^.*\.(.*)\s.*$/,"$1"),10),q[2]=/[a-zA-Z]/.test(r)?parseInt(r.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof h[["Active"].concat("Object").join("X")]!=a)try{var s=new(window[["Active"].concat("Object").join("X")])(d);s&&(r=s.GetVariable("$version"),r&&(p=!0,r=r.split(" ")[1].split(","),q=[parseInt(r[0],10),parseInt(r[1],10),parseInt(r[2],10)]))}catch(t){}return{w3:f,pv:q,wk:o,ie:p,win:m,mac:n}}(),z=function(){if(!y.w3)return;(typeof i.readyState!=a&&i.readyState=="complete"||typeof i.readyState==a&&(i.getElementsByTagName("body")[0]||i.body))&&A(),t||(typeof i.addEventListener!=a&&i.addEventListener("DOMContentLoaded",A,!1),y.ie&&y.win&&(i.attachEvent(g,function(){i.readyState=="complete"&&(i.detachEvent(g,arguments.callee),A())}),h==top&&function(){if(t)return;try{i.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}A()}()),y.wk&&function(){if(t)return;if(!/loaded|complete/.test(i.readyState)){setTimeout(arguments.callee,0);return}A()}(),C(A))}(),W=function(){y.ie&&y.win&&window.attachEvent("onunload",function(){var a=o.length;for(var b=0;b<a;b++)o[b][0].detachEvent(o[b][1],o[b][2]);var c=n.length;for(var d=0;d<c;d++)N(n[d]);for(var e in y)y[e]=null;y=null;for(var f in swfobject)swfobject[f]=null;swfobject=null})}();return{registerObject:function(a,b,c,d){if(y.w3&&a&&b){var e={};e.id=a,e.swfVersion=b,e.expressInstall=c,e.callbackFn=d,m[m.length]=e,U(a,!1)}else d&&d({success:!1,id:a})},getObjectById:function(a){if(y.w3)return G(a)},embedSWF:function(c,d,e,f,g,h,i,j,k,l){var m={success:!1,id:d};y.w3&&!(y.wk&&y.wk<312)&&c&&d&&e&&f&&g?(U(d,!1),B(function(){e+="",f+="";var n={};if(k&&typeof k===b)for(var o in k)n[o]=k[o];n.data=c,n.width=e,n.height=f;var p={};if(j&&typeof j===b)for(var q in j)p[q]=j[q];if(i&&typeof i===b)for(var r in i)typeof p.flashvars!=a?p.flashvars+="&"+r+"="+i[r]:p.flashvars=r+"="+i[r];if(S(g)){var s=L(n,p,d);n.id==d&&U(d,!0),m.success=!0,m.ref=s}else{if(h&&H()){n.data=h,I(n,p,d,l);return}U(d,!0)}l&&l(m)})):l&&l(m)},switchOffAutoHideShow:function(){x=!1},ua:y,getFlashPlayerVersion:function(){return{major:y.pv[0],minor:y.pv[1],release:y.pv[2]}},hasFlashPlayerVersion:S,createSWF:function(a,b,c){return y.w3?L(a,b,c):undefined},showExpressInstall:function(a,b,c,d){y.w3&&H()&&I(a,b,c,d)},removeSWF:function(a){y.w3&&N(a)},createCSS:function(a,b,c,d){y.w3&&T(a,b,c,d)},addDomLoadEvent:B,addLoadEvent:C,getQueryParamValue:function(a){var b=i.location.search||i.location.hash;if(b){/\?/.test(b)&&(b=b.split("?")[1]);if(a==null)return V(b);var c=b.split("&");for(var d=0;d<c.length;d++)if(c[d].substring(0,c[d].indexOf("="))==a)return V(c[d].substring(c[d].indexOf("=")+1))}return""},expressInstallCallback:function(){if(u){var a=P(f);a&&p&&(a.parentNode.replaceChild(p,a),q&&(U(q,!0),y.ie&&y.win&&(p.style.display="block")),r&&r(s)),u=!1}}}}();(function(){if("undefined"==typeof window||window.WebSocket)return;var a=window.console;if(!a||!a.log||!a.error)a={log:function(){},error:function(){}};if(!swfobject.hasFlashPlayerVersion("10.0.0")){a.error("Flash Player >= 10.0.0 is required.");return}location.protocol=="file:"&&a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(a,b,c,d,e){var f=this;f.__id=WebSocket.__nextId++,WebSocket.__instances[f.__id]=f,f.readyState=WebSocket.CONNECTING,f.bufferedAmount=0,f.__events={},b?typeof b=="string"&&(b=[b]):b=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(f.__id,a,b,c||null,d||0,e||null)})},0)},WebSocket.prototype.send=function(a){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var b=WebSocket.__flash.send(this.__id,encodeURIComponent(a));return b<0?!0:(this.bufferedAmount+=b,!1)},WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING)return;this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id)},WebSocket.prototype.addEventListener=function(a,b,c){a in this.__events||(this.__events[a]=[]),this.__events[a].push(b)},WebSocket.prototype.removeEventListener=function(a,b,c){if(!(a in this.__events))return;var d=this.__events[a];for(var e=d.length-1;e>=0;--e)if(d[e]===b){d.splice(e,1);break}},WebSocket.prototype.dispatchEvent=function(a){var b=this.__events[a.type]||[];for(var c=0;c<b.length;++c)b[c](a);var d=this["on"+a.type];d&&d(a)},WebSocket.prototype.__handleEvent=function(a){"readyState"in a&&(this.readyState=a.readyState),"protocol"in a&&(this.protocol=a.protocol);var b;if(a.type=="open"||a.type=="error")b=this.__createSimpleEvent(a.type);else if(a.type=="close")b=this.__createSimpleEvent("close");else{if(a.type!="message")throw"unknown event type: "+a.type;var c=decodeURIComponent(a.message);b=this.__createMessageEvent("message",c)}this.dispatchEvent(b)},WebSocket.prototype.__createSimpleEvent=function(a){if(document.createEvent&&window.Event){var b=document.createEvent("Event");return b.initEvent(a,!1,!1),b}return{type:a,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(a,b){if(document.createEvent&&window.MessageEvent&&!window.opera){var c=document.createEvent("MessageEvent");return c.initMessageEvent("message",!1,!1,b,null,null,window,null),c}return{type:a,data:b,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(a){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(a)})},WebSocket.__initialize=function(){if(WebSocket.__flash)return;WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation);if(!window.WEB_SOCKET_SWF_LOCATION){a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var b=document.createElement("div");b.id="webSocketContainer",b.style.position="absolute",WebSocket.__isFlashLite()?(b.style.left="0px",b.style.top="0px"):(b.style.left="-100px",b.style.top="-100px");var c=document.createElement("div");c.id="webSocketFlash",b.appendChild(c),document.body.appendChild(b),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(b){b.success||a.error("[WebSocket] swfobject.embedSWF failed")})},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var a=0;a<WebSocket.__tasks.length;++a)WebSocket.__tasks[a]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{var b=WebSocket.__flash.receiveEvents();for(var c=0;c<b.length;++c)WebSocket.__instances[b[c].webSocketId].__handleEvent(b[c])}catch(d){a.error(d)}},0),!0},WebSocket.__log=function(b){a.log(decodeURIComponent(b))},WebSocket.__error=function(b){a.error(decodeURIComponent(b))},WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];return!a||!a.enabledPlugin||!a.enabledPlugin.filename?!1:a.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))})(),function(a,b,c){function d(a){if(!a)return;b.Transport.apply(this,arguments),this.sendBuffer=[]}function e(){}a.XHR=d,b.util.inherit(d,b.Transport),d.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},d.prototype.payload=function(a){var c=[];for(var d=0,e=a.length;d<e;d++)c.push(b.parser.encodePacket(a[d]));this.send(b.parser.encodePayload(c))},d.prototype.send=function(a){return this.post(a),this},d.prototype.post=function(a){function d(){this.readyState==4&&(this.onreadystatechange=e,b.posting=!1,this.status==200?b.socket.setBuffer(!1):b.onClose())}function f(){this.onload=e,b.socket.setBuffer(!1)}var b=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),c.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=f:this.sendXHR.onreadystatechange=d,this.sendXHR.send(a)},d.prototype.close=function(){return this.onClose(),this},d.prototype.request=function(a){var c=b.util.request(this.socket.isXDomain()),d=b.util.query(this.socket.options.query,"t="+ +new Date);c.open(a||"GET",this.prepareUrl()+d,!0);if(a=="POST")try{c.setRequestHeader?c.setRequestHeader("Content-type","text/plain;charset=UTF-8"):c.contentType="text/plain"}catch(e){}return c},d.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},d.check=function(a,d){try{var e=b.util.request(d),f=c.XDomainRequest&&e instanceof XDomainRequest,g=a&&a.options&&a.options.secure?"https:":"http:",h=c.location&&g!=c.location.protocol;if(e&&(!f||!h))return!0}catch(i){}return!1},d.xdomainCheck=function(a){return d.check(a,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b){function c(a){b.Transport.XHR.apply(this,arguments)}a.htmlfile=c,b.util.inherit(c,b.Transport.XHR),c.prototype.name="htmlfile",c.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var a=this.doc.createElement("div");a.className="socketio",this.doc.body.appendChild(a),this.iframe=this.doc.createElement("iframe"),a.appendChild(this.iframe);var c=this,d=b.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+d,b.util.on(window,"unload",function(){c.destroy()})},c.prototype._=function(a,b){a=a.replace(/\\\//g,"/"),this.onData(a);try{var c=b.getElementsByTagName("script")[0];c.parentNode.removeChild(c)}catch(d){}},c.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(a){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},c.prototype.close=function(){return this.destroy(),b.Transport.XHR.prototype.close.call(this)},c.check=function(a){if(typeof window!="undefined"&&["Active"].concat("Object").join("X")in window)try{var c=new(window[["Active"].concat("Object").join("X")])("htmlfile");return c&&b.Transport.XHR.check(a)}catch(d){}return!1},c.xdomainCheck=function(){return!1},b.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(a,b,c){function d(){b.Transport.XHR.apply(this,arguments)}function e(){}a["xhr-polling"]=d,b.util.inherit(d,b.Transport.XHR),b.util.merge(d,b.Transport.XHR),d.prototype.name="xhr-polling",d.prototype.heartbeats=function(){return!1},d.prototype.open=function(){var a=this;return b.Transport.XHR.prototype.open.call(a),!1},d.prototype.get=function(){function b(){this.readyState==4&&(this.onreadystatechange=e,this.status==200?(a.onData(this.responseText),a.get()):a.onClose())}function d(){this.onload=e,this.onerror=e,a.retryCounter=1,a.onData(this.responseText),a.get()}function f(){a.retryCounter++,!a.retryCounter||a.retryCounter>3?a.onClose():a.get()}if(!this.isOpen)return;var a=this;this.xhr=this.request(),c.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=d,this.xhr.onerror=f):this.xhr.onreadystatechange=b,this.xhr.send(null)},d.prototype.onClose=function(){b.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=e;try{this.xhr.abort()}catch(a){}this.xhr=null}},d.prototype.ready=function(a,c){var d=this;b.util.defer(function(){c.call(d)})},b.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(a,b,c){function e(a){b.Transport["xhr-polling"].apply(this,arguments),this.index=b.j.length;var c=this;b.j.push(function(a){c._(a)})}var d=c.document&&"MozAppearance"in c.document.documentElement.style;a["jsonp-polling"]=e,b.util.inherit(e,b.Transport["xhr-polling"]),e.prototype.name="jsonp-polling",e.prototype.post=function(a){function i(){j(),c.socket.setBuffer(!1)}function j(){c.iframe&&c.form.removeChild(c.iframe);try{h=document.createElement('<iframe name="'+c.iframeId+'">')}catch(a){h=document.createElement("iframe"),h.name=c.iframeId}h.id=c.iframeId,c.form.appendChild(h),c.iframe=h}var c=this,d=b.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var e=document.createElement("form"),f=document.createElement("textarea"),g=this.iframeId="socketio_iframe_"+this.index,h;e.className="socketio",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.display="none",e.target=g,e.method="POST",e.setAttribute("accept-charset","utf-8"),f.name="d",e.appendChild(f),document.body.appendChild(e),this.form=e,this.area=f}this.form.action=this.prepareUrl()+d,j(),this.area.value=b.JSON.stringify(a);try{this.form.submit()}catch(k){}this.iframe.attachEvent?h.onreadystatechange=function(){c.iframe.readyState=="complete"&&i()}:this.iframe.onload=i,this.socket.setBuffer(!0)},e.prototype.get=function(){var a=this,c=document.createElement("script"),e=b.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),c.async=!0,c.src=this.prepareUrl()+e,c.onerror=function(){a.onClose()};var f=document.getElementsByTagName("script")[0];f.parentNode.insertBefore(c,f),this.script=c,d&&setTimeout(function(){var a=document.createElement("iframe");document.body.appendChild(a),document.body.removeChild(a)},100)},e.prototype._=function(a){return this.onData(a),this.isOpen&&this.get(),this},e.prototype.ready=function(a,c){var e=this;if(!d)return c.call(this);b.util.load(function(){c.call(e)})},e.check=function(){return"document"in c},e.xdomainCheck=function(){return!0},b.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),typeof define=="function"&&define.amd&&define([],function(){return io})})()},{}],143:[function(require,module,exports){(function(t,e){if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define(e);else t.Spinner=e()})(this,function(){"use strict";var t=["webkit","Moz","ms","O"],e={},i;function o(t,e){var i=document.createElement(t||"div"),o;for(o in e)i[o]=e[o];return i}function n(t){for(var e=1,i=arguments.length;e<i;e++)t.appendChild(arguments[e]);return t}var r=function(){var t=o("style",{type:"text/css"});n(document.getElementsByTagName("head")[0],t);return t.sheet||t.styleSheet}();function s(t,o,n,s){var a=["opacity",o,~~(t*100),n,s].join("-"),f=.01+n/s*100,l=Math.max(1-(1-t)/o*(100-f),t),d=i.substring(0,i.indexOf("Animation")).toLowerCase(),u=d&&"-"+d+"-"||"";if(!e[a]){r.insertRule("@"+u+"keyframes "+a+"{"+"0%{opacity:"+l+"}"+f+"%{opacity:"+t+"}"+(f+.01)+"%{opacity:1}"+(f+o)%100+"%{opacity:"+t+"}"+"100%{opacity:"+l+"}"+"}",r.cssRules.length);e[a]=1}return a}function a(e,i){var o=e.style,n,r;if(o[i]!==undefined)return i;i=i.charAt(0).toUpperCase()+i.slice(1);for(r=0;r<t.length;r++){n=t[r]+i;if(o[n]!==undefined)return n}}function f(t,e){for(var i in e)t.style[a(t,i)||i]=e[i];return t}function l(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)if(t[o]===undefined)t[o]=i[o]}return t}function d(t){var e={x:t.offsetLeft,y:t.offsetTop};while(t=t.offsetParent)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e}var u={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};function p(t){if(typeof this=="undefined")return new p(t);this.opts=l(t||{},p.defaults,u)}p.defaults={};l(p.prototype,{spin:function(t){this.stop();var e=this,n=e.opts,r=e.el=f(o(0,{className:n.className}),{position:n.position,width:0,zIndex:n.zIndex}),s=n.radius+n.length+n.width,a,l;if(t){t.insertBefore(r,t.firstChild||null);l=d(t);a=d(r);f(r,{left:(n.left=="auto"?l.x-a.x+(t.offsetWidth>>1):parseInt(n.left,10)+s)+"px",top:(n.top=="auto"?l.y-a.y+(t.offsetHeight>>1):parseInt(n.top,10)+s)+"px"})}r.setAttribute("role","progressbar");e.lines(r,e.opts);if(!i){var u=0,p=(n.lines-1)*(1-n.direction)/2,c,h=n.fps,m=h/n.speed,y=(1-n.opacity)/(m*n.trail/100),g=m/n.lines;(function v(){u++;for(var t=0;t<n.lines;t++){c=Math.max(1-(u+(n.lines-t)*g)%m*y,n.opacity);e.opacity(r,t*n.direction+p,c,n)}e.timeout=e.el&&setTimeout(v,~~(1e3/h))})()}return e},stop:function(){var t=this.el;if(t){clearTimeout(this.timeout);if(t.parentNode)t.parentNode.removeChild(t);this.el=undefined}return this},lines:function(t,e){var r=0,a=(e.lines-1)*(1-e.direction)/2,l;function d(t,i){return f(o(),{position:"absolute",width:e.length+e.width+"px",height:e.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/e.lines*r+e.rotate)+"deg) translate("+e.radius+"px"+",0)",borderRadius:(e.corners*e.width>>1)+"px"})}for(;r<e.lines;r++){l=f(o(),{position:"absolute",top:1+~(e.width/2)+"px",transform:e.hwaccel?"translate3d(0,0,0)":"",opacity:e.opacity,animation:i&&s(e.opacity,e.trail,a+r*e.direction,e.lines)+" "+1/e.speed+"s linear infinite"});if(e.shadow)n(l,f(d("#000","0 0 4px "+"#000"),{top:2+"px"}));n(t,n(l,d(e.color,"0 0 1px rgba(0,0,0,.1)")))}return t},opacity:function(t,e,i){if(e<t.childNodes.length)t.childNodes[e].style.opacity=i}});function c(){function t(t,e){return o("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',e)}r.addRule(".spin-vml","behavior:url(#default#VML)");p.prototype.lines=function(e,i){var o=i.length+i.width,r=2*o;function s(){return f(t("group",{coordsize:r+" "+r,coordorigin:-o+" "+-o}),{width:r,height:r})}var a=-(i.width+i.length)*2+"px",l=f(s(),{position:"absolute",top:a,left:a}),d;function u(e,r,a){n(l,n(f(s(),{rotation:360/i.lines*e+"deg",left:~~r}),n(f(t("roundrect",{arcsize:i.corners}),{width:o,height:i.width,left:i.radius,top:-i.width>>1,filter:a}),t("fill",{color:i.color,opacity:i.opacity}),t("stroke",{opacity:0}))))}if(i.shadow)for(d=1;d<=i.lines;d++)u(d,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(d=1;d<=i.lines;d++)u(d);return n(e,l)};p.prototype.opacity=function(t,e,i,o){var n=t.firstChild;o=o.shadow&&o.lines||0;if(n&&e+o<n.childNodes.length){n=n.childNodes[e+o];n=n&&n.firstChild;n=n&&n.firstChild;if(n)n.opacity=i}}}var h=f(o("group"),{behavior:"url(#default#VML)"});if(!a(h,"transform")&&h.adj)c();else i=a(h,"animation");return p})},{}],144:[function(require,module,exports){var olives=require("./libs/olives"),emily=require("./libs/emily"),amy=require("./libs/amy2"),Widget=olives.OObject,LocalStore=olives.LocalStore,Promise=emily.Promise;Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Place=olives["Place.plugin"],Event=amy.DelegatePlugin,Dock=require("./packages/dock"),Login=require("./packages/login"),Config=require("./services/config"),Map=require("./services/map"),Utils=require("./services/utils"),Confirm=require("./services/confirm"),CouchDBChanges=require("./libs/CouchDBTools").CouchDBChanges;var _body=new Widget,_stack=new Stack({}),_dock=new Dock,_login,_local=new LocalStore,updateLabels=Utils.updateLabels,checkServerStatus=Utils.checkServerStatus,_labels=Config.get("labels"),_db=Config.get("db"),_transport=Config.get("transport"),_user=Config.get("user"),_currentVersion=Config.get("version");_body.startDock=function startDock(firstStart){document.getElementById("main").classList.add("main");_stack.getStack().show("#dock");_dock.start(firstStart)};_body.init=function init(firstStart){_stack.getStack().add("#dock",_dock);if(_local.get("db")&&_local.get("db")!==_db){_db=_local.get("db")}CouchDBChanges.setTransport(_transport);CouchDBChanges.initStream(_db);_user.sync(_db,_local.get("currentLogin")).then(function(){var lblUpdate=new Promise;Config.set("uid",'"'+_user.get("_id")+'"');if(_user.get("lang")!==Config.get("lang")){updateLabels(_user.get("lang")).then(function(){lblUpdate.fulfill()})}else{lblUpdate.fulfill()}return lblUpdate}).then(function(){var loadAvatar=new Promise;if(_user.get("picture_file").search("img/avatars/deedee")>-1){Config.set("avatar",_user.get("picture_file"));loadAvatar.fulfill()}else if(_local.get("userAvatar")){Config.set("avatar",_local.get("userAvatar"));loadAvatar.fulfill()}else{_transport.request("GetFile",{dir:"avatars",filename:_user.get("_id")+"_@v@t@r"},function(result){if(!result.error){Config.set("avatar",result)}else{console.log(result.error);Config.set("avatar","img/avatars/deedee1.png")}loadAvatar.fulfill()})}return loadAvatar}).then(function(){_dock.init();_login.stopSpinner();_body.startDock(firstStart)})};_body.reload=function reload(firstStart){_user.unsync();_user.reset();CouchDBChanges.setTransport(_transport);CouchDBChanges.initStream(_db);_user.sync(_db,_local.get("currentLogin")).then(function(){var lblUpdate=new Promise;Config.set("uid",'"'+_user.get("_id")+'"');if(_user.get("lang")!==Config.get("lang")){updateLabels(_user.get("lang")).then(function(){lblUpdate.fulfill()})}else lblUpdate.fulfill();return lblUpdate}).then(function(){var loadAvatar=new Promise;if(_user.get("picture_file").search("img/avatars/deedee")>-1){Config.set("avatar",_user.get("picture_file"));loadAvatar.fulfill()}else if(_local.get("userAvatar")){Config.set("avatar",_local.get("userAvatar"));loadAvatar.fulfill()}else{_transport.request("GetFile",{dir:"avatars",filename:_user.get("_id")+"_@v@t@r"},function(result){if(!result.error){Config.set("avatar",result)}else{console.log(result.error);Config.set("avatar","img/avatars/deedee1.png")}loadAvatar.fulfill()})}return loadAvatar}).then(function(){_dock.reset();_login.stopSpinner();_body.startDock(firstStart)})};_dock=new Dock;_login=new Login(_body.init,_body.reload,_local);_stack.getStack().add("#login",_login);_body.seam.addAll({stack:_stack,place:new Place({confirm:Confirm})});_body.template='<div id="main"><div data-stack="destination"></div><div data-place="place:confirm"></div></div>';_body.place(document.body);
_local.sync("ideafy-data");document.getElementById("apploading").classList.add("invisible");_stack.getStack().show("#login");_stack.getStack().setCurrentScreen(_login);_login.init();if(navigator.connection&&navigator.connection.type==="none"){_local.get("labels")?_labels.reset(_local.get("labels")):_labels.reset(Config.get("defaultLabels"));Config.set("lang",_labels.set("language"));_login.setScreen("#nointernet")}else{checkServerStatus().then(function(){if(_local.get("labels")){_labels.reset(_local.get("labels"));Config.set("lang",_labels.get("language"))}else{updateLabels(navigator.language)}_transport.request("CheckVersion",{version:_currentVersion},function(result){console.log(result);var msg=_labels.get("outdated")||"Please update your application";if(result==="outdated"){alert(msg)}});var current=_local.get("currentLogin")||"";if(!current){_login.setScreen("#signup-screen")}else{_transport.request("CheckLogin",{id:current,sock:Config.get("socket").socket.sessionid},function(result){console.log(result);if(result.authenticated)_body.init();else{_login.setScreen("#login-screen")}})}},function(error){_local.get("labels")?_labels.reset(_local.get("labels")):_labels.reset(Config.get("defaultLabels"));_login.setScreen("#maintenance-screen")})}Config.get("observer").watch("signout",function(){Config.get("socket").disconnect();_local.set("currentLogin","");_local.set("userAvatar","");_local.sync("ideafy-data");_stack.getStack().add("#login",_login);_login.reset(true);_body.dom.classList.remove("main");document.getElementById("cache").classList.remove("appear");_stack.getStack().show("#login");_stack.getStack().setCurrentScreen(_login);_login.setScreen("#login-screen")});Map.get("body").addEventListener("mousedown",Utils.checkSocketStatus,false);Config.get("observer").watch("reconnect",function(option){_local.sync("ideafy-data");if(option==="all"){checkServerStatus().then(function(){_user.unsync();CouchDBChanges.initStream(_db);return _user.sync(_db,_local.get("currentLogin"))},function(){_login.setScreen("#maintenance-screen")}).then(function(){_user.set("online",true);_user.set("sock",Config.get("socket").socket.sessionid);return _user.upload()})}else{_user.set("online",true);_user.set("sock",Config.get("socket").socket.sessionid);return _user.upload()}})},{"./libs/CouchDBTools":72,"./libs/amy2":75,"./libs/emily":97,"./libs/olives":141,"./packages/dock":205,"./packages/login":226,"./services/config":245,"./services/confirm":246,"./services/map":249,"./services/utils":256}],145:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),CouchDBTools=require("../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../services/config"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../services/utils"),Promise=emily.Promise,Spinner=require("../../libs/spin.min");function AddAttachmentConstructor(){var ui=this,transport=Config.get("transport"),user=Config.get("user"),cats=Config.get("cat"),_labels=Config.get("labels"),cdb=new CouchDBDocument({custom:false,category:"",name:"",description:"",type:"",fileName:"",authors:[user.get("_id")],authornames:user.get("username"),docId:"",rating:null,votes:[],twocents:[],uploaded:false}),_progress=new Store({status:null}),uploadReq,parentDoc,parentType,aList,aspinner=new Spinner({color:"#657b99",lines:8,length:6,width:3,radius:6,top:-2,left:-2}).spin();cdb.setTransport(transport);ui.seam.addAll({labels:new Model(_labels),attach:new Model(cdb,{show:function(bool){bool?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},setContent:function(type){var node=this;switch(type){case"file":node.innerHTML=cdb.get("fileName");break;default:node.innerHTML=cdb.get("name");break}},setName:function(name){this.value=name},resetCat:function(cat){var node=this;if(cat===""){node.selectedIndex=0;[1,2,3,4,5,6].forEach(function(val){node.classList.remove("acolor"+val);node.classList.add("acolor")})}},setAttachmentCat:function(uploaded){if(!uploaded){var custom=[],arr,i,l,key,res="<option selected disabled style='display:none;'>"+_labels.get("choosecat")+"</option>",node=this;for(i=0,l=cats.length;i<l;i++){key=cats[i];res+="<option>"+_labels.get(key)+"</option>"}node.innerHTML=res;user.watchValue("categories",function(){res="<option selected disabled style='display:none;'>"+_labels.get("choosecat")+"</option>";if(user.get("categories"))custom=user.get("categories");for(i=0,l=cats.length;i<l;i++){key=cats[i];res+="<option>"+_labels.get(key)+"</option>"}if(custom.length){for(i=0,l=custom.length;i<l;i++){res+="<option>"+custom[i]+"</option>"}}res+="<option>"+_labels.get("other")+"</option>";node.innerHTML=res})}}}),progress:new Model(_progress,{showStatus:function(status){status?this.setAttribute("value",status):this.setAttribute("value",0)},showVal:function(status){status?this.innerHTML=status+"%":this.innerHTML=""}}),addevent:new Event(ui)});ui.template='<div class="add-attachments"><select class="acolor" data-attach="bind:setAttachmentCat, uploaded; bind:resetCat, category" data-addevent="listen: change, selectCat"></select><input maxlength=18 type="text" placeholder="Enter category" class="input custom-cat" data-attach="bind:show, custom" data-addevent="listen:input, setCat"><input maxlength=36 type="text" placeholder="Enter name" class="input a-name" data-attach="bind:setName, name" data-addevent="listen: input, setName"><ul class="a-tools" data-attach="bind:show, category"><li class="toolbox-button"><div class="upload-button" name="upload" data-addevent="listen:mousedown, press; listen:mouseup, release"><input type="file" class="a-input" data-addevent="listen:change, uploadFile"></div><legend data-labels="bind:innerHTML, filelbl"></legend></li><li class="toolbox-button" style="display:none"><div class="importpic-button" name="import" data-addevent="listen:mousedown, press"></div><legend data-labels="bind:innerHTML, imagelbl"></legend></li><li class="toolbox-button" style="display:none"><div class="drawingtool-button" name="drawing" data-addevent="listen:mousedown, press"></div><legend data-labels="bind:innerHTML, drawinglbl">Drawing</legend></li></ul><div class="a-preview invisible"><div class="a-content" data-attach="bind:setContent, type"></div><progress class="uploadbar" data-progress="bind:showStatus, status" max=100></progress><div class="uploadval" data-progress="bind:showVal, status"></div></div><div class="a-button a-confirm" data-attach="bind:show, uploaded" data-addevent="listen:mousedown, press; listen: mousedown, aconfirm; listen:mouseup, release">&#10003</div><div class="a-button a-cancel" data-attach="bind:show, uploaded" data-addevent="listen:mousedown, press; listen:mousedown, acancel">&#10007</div><textarea class="a-desc input" data-labels="bind:placeholder, attachdescplaceholder" data-attach="bind: value, description" data-attachevent="listen: input, updateDesc"></textarea></div>';ui.reset=function reset($parentDoc,$parentType,$aList){parentDoc=$parentDoc;parentType=$parentType;aList=$aList;cdb.unsync();cdb.reset({custom:false,category:"",name:"",description:"",type:"",fileName:"",authors:[user.get("_id")],authornames:[user.get("username")],docId:parentDoc,rating:null,votes:[],twocents:[],uploaded:false});ui.dom.querySelector(".a-confirm").classList.remove("pressed");ui.dom.querySelector(".a-cancel").classList.remove("pressed");ui.dom.querySelector(".a-preview").classList.add("invisible")};ui.show=function(){ui.dom.classList.remove("invisible")};ui.hide=function(){ui.dom.classList.add("invisible")};ui.press=function(event,node){node.classList.add("pressed")};ui.release=function(event,node){node.classList.remove("pressed")};ui.selectCat=function(event,node){if(node.selectedIndex>cats.length){if(node.value===node.lastChild.innerHTML){cdb.set("custom",true)}else{cdb.set("custom",false);for(i=1,l=cats.length;i<=l;i++){node.classList.remove("acolor"+i)}cdb.set("category",node.value)}node.classList.add("acolor")}else{node.classList.remove("acolor");cdb.set("custom",false);cdb.set("category",cats[node.selectedIndex-1]);for(i=1,l=cats.length;i<=l;i++){node.selectedIndex===i?node.classList.add("acolor"+i):node.classList.remove("acolor"+i)}}};ui.setCat=function(event,node){cdb.set("category",node.value)};ui.setName=function(event,node){cdb.set("name",node.value)};ui.updateDesc=function(event,node){cdb.set("description",node.value)};ui.check=function(event,node){node.parentNode.classList.remove("pressed")};ui.uploadFile=function(event,node){var _reader=new FileReader,_fd=new FormData,_now=new Date,_id=parentDoc,_url="/upload",_type="afile",_dir,fileName="";switch(parentType){case"idea":if(_id==="new")_id="I:"+_now.getTime();_dir="ideas/"+_id;parentDoc=_id;break;default:if(_id==="new")_id="I:"+_now.getTime();_dir="ideas/"+_id;parentDoc=_id;break}if(node.files&&node.files.length){fileName=node.files[0].name;ui.dom.querySelector(".a-preview").classList.remove("invisible");cdb.set("fileName",fileName);cdb.set("docId",_id);if(!cdb.get("name"))cdb.set("name",fileName);cdb.set("type","file");_reader.onloadend=function(e){_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("userfile",node.files[0]);_fd.append("filename",fileName);_uploadReq=Utils.uploadFile(_url,_fd,_progress,function(result){cdb.set("uploaded",true)})};_reader.readAsArrayBuffer(node.files[0])}};ui.deleteAttachmentFile=function(fileName){return Utils.deleteAttachmentFile(parentDoc,fileName)};ui.deleteAttachmentDoc=function(docId){return Utils.deleteAttachmentDoc(docId)};ui.aconfirm=function(event,node){var now=new Date,id="A:"+now.getTime();if(cdb.get("name")&&cdb.get("category")){aspinner.spin(node);cdb.sync(Config.get("db"),id).then(function(err){if(err)console.log(err);return cdb.upload()}).then(function(){var custom=[];user.get("categories")&&(custom=user.get("categories").concat());aList.alter("unshift",{docId:id,type:cdb.get("type"),category:cdb.get("category"),name:cdb.get("name"),fileName:cdb.get("fileName"),authornames:cdb.get("authornames")});if(cdb.get("custom")){if(custom.indexOf(cdb.get("category"))===-1){custom.push(cdb.get("category"));user.set("categories",custom);user.upload()}}aspinner.stop();ui.reset(parentDoc,parentType,aList)})}else if(!cdb.get("name")){}else{}};ui.acancel=function(event,node){var file=cdb.get("fileName");ui.abortReq();ui.deleteAttachmentFile(file);ui.reset(parentDoc,parentType,aList)};ui.getDocId=function(){if(parentDoc==="new")return false;else return parentDoc};ui.getFileName=function(){return cdb.get("fileName")};ui.getReq=function(){return uploadReq};ui.abortReq=function(){if(uploadReq&&uploadReq.readyState!==4){uploadReq.abort();_progress.reset({status:""})}}}module.exports=function AddAttachmentFactory(){AddAttachmentConstructor.prototype=new Widget;return new AddAttachmentConstructor}},{"../../libs/CouchDBTools":72,"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/utils":256}],146:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),CouchDBTools=require("../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../services/config"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],WriteTwocent=require("../twocents/writetwocent"),TwocentList=require("../twocents/twocentlist"),Place=olives["Place.plugin"],Utils=require("../../services/utils"),Confirm=require("../../services/confirm"),Promise=emily.Promise,Spinner=require("../../libs/spin.min");module.exports=new function AttachmentConstructor($type){var ui=new Widget,_attachmentTwocentListUI=new TwocentList("attach"),_twocentWriteUI=new WriteTwocent("attach"),cdb=new CouchDBDocument,cdbEdit=new Store,_progress=new Store({status:null}),_uploadReq,labels=Config.get("labels"),transport=Config.get("transport"),user=Config.get("user"),_cat=Config.get("cat"),vote=new Store([{active:false},{active:false},{active:false},{active:false},{active:false}]),_voted=false;cdb.setTransport(transport);ui.seam.addAll({labels:new Model(labels),attach:new Model(cdb,{setCat:function(cat){var colors=Config.get("catColors"),idx=_cat.indexOf(cat);if(idx>-1){this.innerHTML=labels.get(cat);this.setAttribute("style","color:"+colors[idx])}else{this.innerHTML=cat;this.setAttribute("sytle","color: #404040")}},setDescription:function(desc){if(desc&&desc!=="\n"){this.classList.remove("invisible");this.innerHTML=desc.replace(/\n/g,"<br>")}else this.classList.add("invisible")},displayTwocentList:function(twocents){twocents&&twocents.length?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(id){var stamp=parseInt(id.replace("A:",""),10);this.innerHTML=Utils.formatDateStamp(stamp)},setAuthors:function(names){var res="";if(names&&names instanceof Array&&names.length){for(i=0,l=names.length;i<l;i++){if(i===l-1){res+=names[i]}else res+=names[i]+", "}this.innerHTML=res}else this.innerHTML=names},showVoting:function(id){var arr=user.get("rated_a")||[],authors=cdb.get("authors");if(authors.indexOf(user.get("_id"))>-1){this.classList.add("invisible")}else{arr.indexOf(id)>-1?this.classList.add("invisible"):this.classList.remove("invisible")}},showRating:function(votes){var votingEl=ui.dom.querySelector(".a-vote");this.classList.add("invisible");if(votes&&votes.length&&votingEl.classList.contains("invisible")){this.classList.remove("invisible")}},displayRating:function(votes){if(votes&&votes.length){this.innerHTML=Math.round(votes.reduce(function(x,y){return x+y})/votes.length*100)/100}},displayNbVotes:function(votes){if(!votes)this.innerHTML="";else if(votes.length===0){this.innerHTML="("+labels.get("novotesyet")+")"}else if(votes.length===1){this.innerHTML="("+labels.get("onevote")+")"}else{this.innerHTML="("+votes.length+" "+labels.get("votes")+")"}},setRef:function(name){var url=Config.get("location")+"/downloads",type;if(cdb.get("docId").search("I:")>-1)type="idea";if(name){url+="?atype="+type+"&docid="+cdb.get("docId")+"&file="+name;this.setAttribute("href",url);this.addEventListener("touchstart",Utils.showLinkInBrowser)}},showWriteTwocent:function(twocents){(twocents&&twocents,length)?this.classList.add("invisible"):this.classList.remove("invisible")},displayEdit:function(arr){arr.indexOf(user.get("_id"))>-1?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},displayDelete:function(twocents){if(twocents&&twocents.length){this.setAttribute("style","display:none;")}else if(cdb.get("authors").indexOf(user.get("_id"))<0){this.setAttribute("style","display:none;")}else{this.setAttribute("style","display:inline-block;")}}}),edit:new Model(cdbEdit,{show:function(bool){bool&&ui.dom.classList.contains("edit-a")?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},setSelectCat:function(cat){var custom=user.get("categories")||[],arr,i,l,key,idx=null,node=this,res="<option selected disabled style='display:none;'>"+labels.get("choosecat")+"</option>";[1,2,3,4,5,6].forEach(function(val){node.classList.remove("acolor"+val);node.classList.add("acolor")});for(i=0,l=_cat.length;i<l;i++){key=_cat[i];res+="<option>"+labels.get(key)+"</option>";if(cat===key){idx=i+1;node.classList.add("acolor"+idx)}}if(custom.length){for(i=0,l=custom.length;i<l;i++){res+="<option>"+custom[i]+"</option>";if(cat===custom[i])idx=_cat.length+i+1}}res+="<option>"+labels.get("other")+"</option>";this.innerHTML=res;this.selectedIndex=idx||0}}),progress:new Model(_progress,{showStatus:function(status){status?this.setAttribute("value",status):this.setAttribute("value",0)},showVal:function(status){status?this.innerHTML=status+"%":this.innerHTML=""}}),vote:new Model(vote,{setIcon:function(active){var styleActive="background-image: url('img/public/activeIdeaVote.png');",styleInactive="background-image: url('img/public/rateForList.png');";active?this.setAttribute("style",styleActive):this.setAttribute("style",styleInactive)}}),place:new Place({LibraryTwocentUI:_attachmentTwocentListUI}),attachevent:new Event(ui)});ui.template='<div id = "attachment-popup"><div class="close-popup" data-attachevent = "listen:mousedown, close"></div><div class="attach-header" data-attach="bind:innerHTML, name"></div><div class="attach-details"><div class="attach-body"><div class="a-type" data-attach="bind:setType, type"></div><div class="a-type-edit" data-attachevent="listen:mousedown, press"><input type="file" class="a-input" data-attachevent="listen:mousedown, check;listen:change, uploadFile"></div><div class="a-left"><div class="a-name" data-attach="bind:innerHTML, name" data-edit="bind:innerHTML, name" data-attachevent="listen:input, updateName"></div><div class="a-contrib"><span class="a-span" data-labels="bind: innerHTML, contrib"></span><span class="a-author" data-attach="bind: setAuthors, authornames"></span></div><div class="a-date" data-attach="bind:setDate, _id"></div></div><div class="a-cat"><span data-attach="bind:setCat, category"></span><select class="acolor invisible" data-edit="bind:setSelectCat, category" data-attachevent="listen: change, selectCat"></select><input maxlength=18 type="text" placeholder="Enter category" class="input custom-cat invisible" data-edit="bind:show, custom" data-attachevent="listen:input, setCat"></div><div class="a-rating invisible" data-attach="bind:showRating, votes"><a class="item-acorn"></a><span data-attach="bind:displayRating, votes"></span><span class="votes" data-attach="bind:displayNbVotes, votes"></span></div><div class="a-preview invisible"><div class="a-content" data-edit="bind:innerHTML, fileName"></div><progress class="uploadbar" data-progress="bind:showStatus, status" max=100></progress><div class="uploadval" data-progress="bind:showVal, status"></div></div><div class="a-vote" data-attach="bind:showVoting, _id"><legend data-labels="bind:innerHTML, rateit"></legend><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-attachevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div><ul class="actionbtn"><li><a class="attach-download" data-attach="bind: setRef, fileName" data-attachevent="listen:mousedown, press; listen:mouseup, download"></a></li><li><div class="a-2cent" data-attachevent="listen:mousedown, press; listen:mouseup, displayWriteTwocent"></div></li><li data-attach="bind:displayEdit, authors"><div class="a-edit" data-attachevent="listen:mousedown, press; listen:mouseup, edit"></div></li><li data-attach="bind:displayDelete, twocents"><div class="a-delete" data-attachevent="listen:mousedown, press; listen:mouseup, confirmDelete"></div></li><li class="a-publish invisible"><div class="sendmail" data-labels="bind: innerHTML, publishlbl" data-attachevent="listen:mousedown, press; listen: mouseup, update"></div></li><li class="a-cancel invisible"><div class="cancelmail" data-labels="bind: innerHTML, cancellbl" data-attachevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div></li></ul><p class="a-desc invisible" data-attach="bind: setDescription, description" data-attachevent="listen:input, updateDesc"></p><div class="attach-preview invisible"></div><div id="attach-writetwocents" data-attach="bind:showWriteTwocent, twocents"></div><div id="attach-twocents" class="twocents" data-attach="bind:displayTwocentList, twocents" data-place="place:LibraryTwocentUI"></div></div></div>';ui.reset=function reset(id,type){var _domWrite=ui.dom.querySelector("#attach-writetwocents");document.getElementById("cache").classList.add("appear");_twocentWriteUI.reset(id);_attachmentTwocentListUI.reset(id);_voted=false;_twocentWriteUI.place(_domWrite);cdb.unsync();cdb.reset({});cdb.sync(Config.get("db"),id).then(function(){ui.dom.classList.add("appear");if(cdb.get("authors").indexOf(user.get("_id"))>-1){ui.resetEdit()}},function(err){console.log(err)})};ui.resetEdit=function(){cdbEdit.reset({});cdbEdit.set("type",cdb.get("type"));cdbEdit.set("name",cdb.get("name"));cdbEdit.set("authors",cdb.get("authors").concat());cdbEdit.set("authornames",cdb.get("authornames"));cdbEdit.set("fileName",cdb.get("fileName"));cdbEdit.set("category",cdb.get("category"));cdbEdit.set("custom",cdb.get("custom"));cdbEdit.set("description",cdb.get("description")||labels.get("attachdescplaceholder"))};ui.close=function(event,node){if(ui.dom.classList.contains("edit-a"))ui.dom.classList.remove("edit-a");ui.dom.classList.remove("appear");document.getElementById("cache").classList.remove("appear");cdb.unsync();cdb.reset({});cdbEdit.reset({})};ui.previewVote=function(event,node){var i=0,idx=node.getAttribute("data-vote_id");vote.loop(function(v,i){i<=idx?vote.update(i,"active",true):vote.update(i,"active",false)})};ui.castVote=function(event,node){var grade=parseInt(node.getAttribute("data-vote_id"))+1,id=cdb.get("_id"),json={id:id,vote:grade,voter:user.get("_id")};if(!_voted){_voted=true;transport.request("Vote",json,function(result){var ra=user.get("rated_a")||[];if(result!=="ok"){console.log(result,"something went wrong, please try again later");_voted=false}else{ra.unshift(id);user.set("rated_a",ra);alert(Config.get("labels").get("thankyou"));ui.dom.querySelector(".a-vote").classList.add("invisible");ui.dom.querySelector(".a-rating").classList.remove("invisible");vote.reset([{active:false},{active:false},{active:false},{active:false},{active:false}])}})}};ui.press=function(event,node){event.preventDefault();if(node.classList.contains("a-type")){if(ui.dom.classList.contains("edit-a"))node.classList.add("a-pressed")}else node.classList.add("a-pressed")};ui.download=function(event,node){node.classList.remove("a-pressed")};ui.displayWriteTwocent=function(event,node){ui.dom.querySelector("#attach-writetwocents").classList.remove("invisible");node.classList.remove("a-pressed")};ui.edit=function(event,node){var nameEl=ui.dom.querySelector(".a-name"),descEl=ui.dom.querySelector(".a-desc");node.classList.remove("a-pressed");ui.dom.classList.add("edit-a");nameEl.setAttribute("contentEditable",true);descEl.setAttribute("contentEditable",true);if(!cdb.get("description")){descEl.classList.remove("invisible");descEl.innerHTML=cdbEdit.get("description")}};ui.updateName=function(event,node){cdbEdit.set("name",node.innerHTML)};ui.updateDesc=function(event,node){cdbEdit.set("description",node.innerText)};ui.selectCat=function(event,node){if(node.value===node.lastChild.innerHTML){cdbEdit.set("custom",true);for(i=1,l=_cat.length;i<=l;i++){node.classList.remove("acolor"+i)}node.classList.add("acolor")}else{node.classList.remove("acolor");cdbEdit.set("custom",false);cdbEdit.set("category",_cat[node.selectedIndex-1]);for(i=1,l=_cat.length;i<=l;i++){node.selectedIndex===i?node.classList.add("acolor"+i):node.classList.remove("acolor"+i)}}};ui.setCat=function(event,node){cdbEdit.set("category",node.value)};ui.check=function(event,node){node.classList.remove("a-pressed")};ui.uploadFile=function(event,node){var _reader=new FileReader,_fd=new FormData,_id=cdb.get("docId"),_url="/upload",_type="afile",_dir,fileName="";if(_id.search("I:")>-1)_dir="ideas/"+_id;if(node.files&&node.files.length){fileName=node.files[0].name;ui.dom.querySelector(".a-preview").classList.remove("invisible");cdbEdit.set("fileName",fileName);if(!cdbEdit.get("name"))cdbEdit.set("name",fileName);_reader.onloadend=function(e){_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("userfile",node.files[0]);_fd.append("filename",fileName);_uploadReq=Utils.uploadFile(_url,_fd,_progress,function(result){return result})};_reader.readAsArrayBuffer(node.files[0])}};ui.checkUpdate=function(){var update=false;if(cdbEdit.get("name")!==cdb.get("name")||cdbEdit.get("description")!==cdb.get("description")||cdbEdit.get("fileName")!==cdb.get("fileName")||cdbEdit.get("category")!==cdb.get("category")||cdbEdit.get("authors").join()!==cdb.get("authors").join()){update=true}return update};ui.update=function(event,node){node.classList.remove("a-pressed");if(ui.checkUpdate()){if(cdb.get("fileName")!==cdbEdit.get("fileName")){ui.deleteAttachmentFile(cdb.get("fileName"))}cdb.set("name",cdbEdit.get("name"));cdb.set("description",cdbEdit.get("description"));cdb.set("fileName",cdbEdit.get("fileName"));cdb.set("category",cdbEdit.get("category"));cdb.set("custom",cdbEdit.get("custom"));cdb.set("authors",cdbEdit.get("authors"));cdb.set("authornames",cdbEdit.get("authornames"));ui.dom.classList.remove("edit-a");ui.dom.querySelector(".a-name").setAttribute("contentEditable",false);ui.dom.querySelector(".a-desc").setAttribute("contentEditable",false);ui.dom.querySelector(".a-preview").classList.add("invisible");ui.resetEdit();cdb.upload().then(function(){return ui.updateParentDoc(cdb.get("docId"))})}else{ui.cancel()}};ui.cancel=function(event,node){node&&node.classList.remove("a-pressed");if(_uploadReq&&_uploadReq.readyState!==4){_uploadReq.abort();_progress.reset({status:""})}if(cdbEdit.get("fileName")!==cdb.get("fileName"))ui.deleteAttachmentFile(cdbEdit.get("fileName"));ui.dom.querySelector(".a-name").setAttribute("contentEditable",false);ui.dom.querySelector(".a-desc").setAttribute("contentEditable",false);ui.dom.querySelector(".a-preview").classList.add("invisible");ui.dom.classList.remove("edit-a");ui.resetEdit()};ui.confirmDelete=function(event,node){node.classList.remove("a-pressed");Confirm.reset(labels.get("deleteattachment"),ui.deleteAttachment,"a-delconfirm");Confirm.show()};ui.deleteAttachmentFile=function(fileName){return Utils.deleteAttachmentFile(cdb.get("docId"),fileName)};ui.deleteAttachment=function(choice){var doc=cdb.get("docId"),a_id=cdb.get("_id"),fileName=cdb.get("fileName"),parentCDB=new CouchDBDocument;if(choice){parentCDB.setTransport(transport);parentCDB.sync(Config.get("db"),doc).then(function(){var a_array=parentCDB.get("attachments").concat()||[],l=a_array.length,i,idx=null,promise=new Promise;for(i=0;i<l;i++){if(a_array[i].docId===a_id){idx=i;break}}if(idx===null){promise.reject("error: attachment not found")}else{a_array.splice(idx,1);parentCDB.set("attachments",a_array);parentCDB.upload().then(function(){promise.fulfill()})}return promise}).then(function(){console.log("before calling remove");return cdb.remove()}).then(function(){ui.close();return Utils.deleteAttachmentFile(doc,fileName)})}else{Confirm.hide()}};ui.updateParentDoc=function(id){var promise=new Promise,doc=new CouchDBDocument;doc.setTransport(transport);doc.sync(Config.get("db"),id).then(function(){var att=doc.get("attachments").concat(),idx,i,l=att.length;for(i=0;i<l;i++){if(att[i].docId===cdb.get("_id")){idx=i;break}}att.splice(idx,1,{docId:cdb.get("_id"),type:cdb.get("type"),category:cdb.get("category"),name:cdb.get("name"),fileName:cdb.get("fileName"),authornames:cdb.get("authornames")});doc.set("attachments",att);return doc.upload()}).then(function(){promise.fulfill()});return promise};return ui}},{"../../libs/CouchDBTools":72,"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/confirm":246,"../../services/utils":256,"../twocents/twocentlist":236,"../twocents/writetwocent":238}],147:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),amy=require("../../libs/amy2"),Widget=olives.OObject,Map=require("../../services/map"),Menu=require("../../services/submenu"),Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Config=require("../../services/config"),Store=emily.Store,Utils=require("../../services/utils"),IdeafyMenu=require("./ideafy-menu"),QuickB=require("./quickb/quickb"),MultiB=require("./multi/mub");module.exports=function BrainstormConstructor(){var _widget=new Widget,_submenu,_store=new Store,_stack=new Stack,_user=Config.get("user");_widget.seam.addAll({brainstormstack:_stack,header:new Model(_store,{setDate:function(date){if(date){this.innerHTML=date.toLocaleDateString()}},setTime:function(date){var hrs=date.getHours(),min=date.getMinutes(),sec=date.getSeconds();if(hrs<10)hrs="0"+hrs;if(min<10)min="0"+min;if(sec<10)sec="0"+sec;this.innerHTML=hrs+":"+min+":"+sec}})});_widget.template='<div id="brainstorm"><div id="brainstorm-menu"></div><div class="brainstorm-header header blue-dark"><div class="date" data-header="bind: setDate, date"></div><span class="headerTitle" data-header="bind: innerHTML, headertitle"></span><div class="clock" data-header="bind: setTime, date">hh:mm</div></div><div class="stack" data-brainstormstack="destination"></div></div>';_widget.place(Map.get("brainstorm"));_widget.showMenu=function showMenu(){_submenu.toggleActive(true)};_widget.hideMenu=function hideMenu(){_submenu.toggleActive(false)};_widget.exitSession=function exitSession(){_stack.getStack().show("menu");Config.get("observer").notify("session-exited")};_widget.reset=function reset(){_stack.getStack().get("menu").reset();_stack.getStack().show("menu")};_widget.selectScreen=function selectScreen(name,sip){if(name==="continue"){name=sip.type}if(name!=="tutorial"&&_stack.getStack().get(name)){_stack.getStack().get(name).reset(sip);_stack.getStack().show(name)}else{sip?name=sip.type:sip=null;switch(name){case"quick":_stack.getStack().add("quick",new QuickB(sip,_widget.exitSession));break;case"musession":_stack.getStack().add("musession",new MultiB(sip,_widget.exitSession));break;case"tutorial":Config.get("observer").notify("display-tutorials");break;default:name="";break}if(name){_stack.getStack().show(name)}}};_submenu=new Menu(_widget.dom.querySelector("#brainstorm-menu"));_submenu.toggleActive(false);_store.set("headertitle",Config.get("labels").get("brainstormheadertitle"));setInterval(function(){var now=new Date;_store.set("date",now)},1e3);_stack.getStack().add("menu",new IdeafyMenu(_widget.selectScreen));_stack.getStack().show("menu");Config.get("observer").watch("replay-session",function(sid,mode){var _sip={};_sip.id=sid;if(sid.toLowerCase().search("quick")>-1){_sip.type="quick"}if(sid.toLowerCase().search("s:mu")>-1){_sip.type="musession"}_widget.selectScreen(_sip.type,_sip)});Config.get("observer").watch("join-musession",function(sid){var sip={type:"musession",id:sid,mode:"join"};_widget.selectScreen(sip.type,sip)});Config.get("observer").watch("show-mupreview",function(sid){var sip={type:"musession",id:sid,mode:"preview"};_widget.selectScreen(sip.type,sip)});return _widget}},{"../../libs/amy2":75,"../../libs/emily":97,"../../libs/olives":141,"../../services/config":245,"../../services/map":249,"../../services/submenu":253,"../../services/utils":256,"./ideafy-menu":148,"./multi/mub":152,"./quickb/quickb":164}],148:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),Widget=olives.OObject,Map=require("../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../services/config"),Store=emily.Store;module.exports=function IdeafyMenuConstructor($selectScreen){var _widget=new Widget,_user=Config.get("user"),_labels=Config.get("labels"),_menu=new Store,_last={name:"continue",active:true,selected:false,label:_labels.get("continuesession"),bg:"continuesession.png",bgselected:"continueactive.png"},_sip="";_widget.seam.addAll({ideafymenu:new Model(_menu,{setActive:function(active){active?this.classList.remove("inactive"):this.classList.add("inactive")},setBg:function(selected){var id=this.getAttribute("data-ideafymenu_id");if(selected){this.setAttribute("style","background-image:url('img/brainstorm/"+_menu.get(id).bgselected+"');color:white;")}else{this.setAttribute("style","background-image:url('img/brainstorm/"+_menu.get(id).bg+"');color:#4D4D4D;")}}}),labels:new Model(_labels),ideafyevent:new Event(this)});_widget.template='<div id="ideafy-menu"><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, brainstormchoosemode"></div><ul class="menu" data-ideafymenu = "foreach"><li data-ideafymenu="bind:innerHTML, label; bind: setActive, active; bind:setBg, selected" data-ideafyevent="listen:mousedown, press; listen: mouseup, start"></li></ul></div>';
_widget.place(Map.get("ideafy-menu"));this.press=function(event,node){var _id=node.getAttribute("data-ideafymenu_id");_menu.update(_id,"selected",true);node.classList.add("pressed")};this.start=function(event,node){var id=node.getAttribute("data-ideafymenu_id");_menu.get(id).name==="continue"?$selectScreen("continue",_sip):$selectScreen(_menu.get(id).name);node.classList.remove("pressed");_menu.update(id,"selected",false)};_widget.addContinue=function addContinue(sip){var arr=JSON.parse(_menu.toJSON());if(_menu.get(0).name!=="continue"){arr.unshift(_last);_menu.reset(arr)}_sip=sip};_widget.removeContinue=function removeContinue(){var arr=JSON.parse(_menu.toJSON());if(arr[0].name==="continue")arr.splice(0,1);_menu.reset(arr);_sip=""};_widget.reset=function reset(){_menu.reset([{name:"quick",active:true,selected:false,label:_labels.get("quickbmode"),bg:"quick.png",bgselected:"quickactive.png"},{name:"musession",active:true,selected:false,label:_labels.get("musession"),bg:"multiuser.png",bgselected:"multiuseractive.png"},{name:"customb",active:false,selected:false,label:_labels.get("customsession"),bg:"customb.png",bgselected:"custombactive.png"},{name:"tutorial",active:true,selected:false,label:_labels.get("ideafytutorial"),bg:"tutorial.png",bgselected:"tutorialactive.png"}]);if(_user.get("sessionInProgress")&&_user.get("sessionInProgress").id){_widget.addContinue(_user.get("sessionInProgress"))}};_widget.reset();_user.watchValue("sessionInProgress",function(sip){sip.id&&sip.type?_widget.addContinue(sip):_widget.removeContinue()});_user.watchValue("lang",function(){var lbl=Config.get("labels");_menu.loop(function(v,i){switch(v.name){case"continue":_menu.update(i,"label",lbl.get("continuesession"));break;case"quick":_menu.update(i,"label",lbl.get("quickbmode"));break;case"musession":_menu.update(i,"label",lbl.get("musession"));break;case"customb":_menu.update(i,"label",lbl.get("customsession"));break;case"tutorial":_menu.update(i,"label",lbl.get("ideafytutorial"));break}})});return _widget}},{"../../libs/emily":97,"../../libs/olives":141,"../../services/config":245,"../../services/map":249}],149:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),UIPlugin=olives["Place.plugin"],MUPreview=require("./mupreview");module.exports=function MuListConstructor($exit){var widget=new Widget,labels=Config.get("labels"),user=Config.get("user"),db=Config.get("db"),transport=Config.get("transport"),muListAll=new Store([]),muSearch=new Store([]),muPreviewUI=new MUPreview,musessions=new Store([]),muListOptions=new Store({modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"}),_languages=new Store([{name:"*"}]),_usrLg=Config.get("userLanguages"),currentList="mulistall",contacts,spinner=new Spinner({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200}).spin();_usrLg.forEach(function(val){_languages.alter("push",val)});widget.seam.addAll({labels:new Model(labels),options:new Model(muListOptions,{setBg:function(lang){if(lang==="all"){this.setAttribute("style","background-image: none;");this.innerHTML="*"}else{this.innerHTML=" ";this.setAttribute("style","background-image:url('img/flags/"+lang+".png');")}},setMode:function(modes){var i,l,res="";for(i=0,l=modes.length;i<l;i++){res+="<option>"+labels.get(modes[i])+"</option>"}this.innerHTML=res}}),select:new Model(_languages,{setBg:function(name){if(name==="*"){this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;");this.innerHTML="*"}else{this.innerHTML=" ";this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}}}),muall:new Model(muListAll,{setParticipants:function(array){var length=array.length+1,i,res="<ul>";for(i=0;i<length;i++){res+="<li></li>"}res+="</ul>";this.innerHTML=res},setMode:function(mode){switch(mode){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break}},setDate:function(scheduled){var now,sched;if(scheduled){now=new Date;sched=new Date(scheduled);if(now.toDateString()===sched.toDateString()){if(sched.getTime()-now.getTime()<=3e5)this.innerHTML=labels.get("now");else this.innerHTML=sched.toLocaleTimeString()}else{this.innerHTML=Utils.formatDate([sched.getFullYear(),sched.getMonth(),sched.getDate()])}}else this.innerHTML=labels.get("now")},setLang:function(lang){this.setAttribute("style","background-image: url('img/flags/"+lang.substring(0,2)+".png');");this.innerHTML=" "}}),musearch:new Model(muSearch,{setParticipants:function(nb){var length=parseInt(nb,10)+1,i,res="<ul>";for(i=0;i<length;i++){res+="<li></li>"}res+="</ul>";this.innerHTML=res},setMode:function(mode){switch(mode){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break}},setDate:function(scheduled){scheduled=parseInt(scheduled,10);var now,sched;if(scheduled){now=new Date;sched=new Date(scheduled);if(now.toDateString()===sched.toDateString()){if(sched.getTime()-now.getTime()<=3e5)this.innerHTML=labels.get("now");else this.innerHTML=sched.toLocaleTimeString()}else{this.innerHTML=Utils.formatDate([sched.getFullYear(),sched.getMonth(),sched.getDate()])}}else this.innerHTML=labels.get("now")},setLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');");this.innerHTML=" "}}),mupreview:new UIPlugin({preview:muPreviewUI}),mulistevent:new Event(widget)});widget.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><div class="selectlang"><div data-options="bind:setBg, selectedLang"></div><button data-mulistevent = "listen:mouseup, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-mulistevent="listen: mouseup, filterLang"></li></ul></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class=mudate data-labels="bind:innerHTML, sbydate"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div class="noresult invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mudate" data-muall="bind:setDate, value.scheduled"></div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mudate" data-musearch="bind:setDate, fields.scheduled"></div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>';widget.reset=function reset(){currentList="mulistall";spinner.spin(widget.dom.querySelector("#mulistspinner"));muListOptions.set("selectedLang","all");muListOptions.set("selectedMode","allmodes");widget.buildList(currentList).then(function(){spinner.stop()})};widget.buildList=function buildList(listId,query){var arr=[],promise=new Promise;if(listId==="mulistall"){muListAll.reset([]);widget.addSessions(arr,"roulette").then(function(){return widget.addSessions(arr,"campfire")}).then(function(){return widget.addSessions(arr,"boardroom")}).then(function(){if(arr.length){widget.dom.querySelector(".noresult").classList.add("invisible")}else{widget.dom.querySelector(".noresult").classList.remove("invisible")}muListAll.reset(arr);promise.fulfill()})}if(listId==="musearch"){muSearch.reset([]);widget.syncSearch(arr,query).then(function(){if(arr.length){widget.dom.querySelector(".noresult").classList.add("invisible")}else{widget.dom.querySelector(".noresult").classList.remove("invisible")}muSearch.reset(arr);promise.fulfill()})}return promise};widget.syncSearch=function syncSearch(arr,query,filter){var promise=new Promise,cdb=new CouchDBView;cdb.setTransport(transport);cdb.sync("_fti/local/"+db,"indexedsessions","waiting",{q:query,descending:true}).then(function(){contacts=Utils.getContactUsernames().join();cdb.loop(function(v,i){var add=false;if(v.fields.mode==="roulette"&&v.score>.66){add=true}else if(v.fields.mode==="campfire"&&v.score>.66&&(v.fields.initiator===user.get("username")||contacts.search(v.fields.initiator)>-1)){add=true}else if(v.fields.mode==="boardroom"&&v.score>.66&&(v.fields.initiator===user.get("username")||v.fields.invited.search(user.get("_id"))>-1)){add=true}if(add){if(!filter){arr.push(v)}else{if(v.fields.mode.search(filter.mode)>-1&&v.fields.lang.search(filter.lang)>-1){arr.push(v)}}}});promise.fulfill()},function(err){alert(err)});return promise};widget.addSessions=function addSessions(arr,mode,lang){var promise=new Promise,cdb=new CouchDBView,view="_view/"+mode,query={};cdb.setTransport(transport);if(mode==="roulette"){lang?query={key:'"'+lang+'"',descending:false,limit:50}:query={descending:false,limit:50}}else{lang?query={key:'["'+user.get("_id")+'","'+lang+'"]',descending:false}:query={startkey:'["'+user.get("_id")+'",{}]',endkey:'["'+user.get("_id")+'"]',descending:true}}cdb.sync(db,"library",view,query).then(function(){cdb.loop(function(v,i){var now=new Date;if(!v.value.scheduled||now.getTime()-v.value.scheduled<=9e5)arr.unshift(v)});promise.fulfill();cdb.unsync()},function(err){console.log(err,mode)});return promise};widget.search=function(event,node){if(event.keyCode===13){if(node.value===""){widget.toggleList("mulistall")}else{widget.toggleList("musearch")}}};widget.displayLang=function(event,node){widget.dom.querySelector(".langlist").classList.remove("invisible")};widget.filterLang=function(event,node){var i=parseInt(node.getAttribute("data-select_id"),10);widget.dom.querySelector(".langlist").classList.add("invisible");if(i===0){muListOptions.set("selectedLang","all")}else{muListOptions.set("selectedLang",_languages.get(i).name)}spinner.spin(document.getElementById("mulistspinner"));widget.filterList().then(function(){spinner.stop()})};widget.filterMode=function(event,node){var i=node.selectedIndex;muListOptions.set("selectedMode",muListOptions.get("modes")[i]);switch(i){case 1:node.setAttribute("style","color: #5F8F28;");break;case 2:node.setAttribute("style","color: #F27B3D");break;case 3:node.setAttribute("style","color: #4D4D4D;");break;default:node.setAttribute("style","color: black;");break}spinner.spin(document.getElementById("mulistspinner"));widget.filterList().then(function(){spinner.stop()})};widget.filterList=function filterList($query){var arr=[],query=$query||widget.dom.querySelector("#mulist-content input").value,promise=new Promise,mode="",lang="";query=query.replace(/:/g,"\\:");if(muListOptions.get("selectedMode")!=="allmodes"){mode=muListOptions.get("selectedMode")}if(muListOptions.get("selectedLang")!=="all"){lang=muListOptions.get("selectedLang")}if(mode===""&&lang===""){widget.buildList(currentList,query).then(function(){promise.fulfill()})}else{if(currentList==="mulistall"){muListAll.reset([]);if(mode){widget.addSessions(arr,mode,lang).then(function(){muListAll.reset(arr);if(arr.length){widget.dom.querySelector(".noresult").classList.add("invisible")}else{widget.dom.querySelector(".noresult").classList.remove("invisible")}promise.fulfill()})}else{widget.addSessions(arr,"roulette",lang).then(function(){return widget.addSessions(arr,"campfire",lang)}).then(function(){return widget.addSessions(arr,"boardroom",lang)}).then(function(){muListAll.reset(arr);if(arr.length){widget.dom.querySelector(".noresult").classList.add("invisible")}else{widget.dom.querySelector(".noresult").classList.remove("invisible")}promise.fulfill()})}}else{muSearch.reset([]);widget.syncSearch(arr,query,{mode:mode,lang:lang}).then(function(){muSearch.reset(arr);if(arr.length){widget.dom.querySelector(".noresult").classList.add("invisible")}else{widget.dom.querySelector(".noresult").classList.remove("invisible")}promise.fulfill()})}}return promise};widget.zoom=function(event,node){var id;node.classList.add("pressed");if(currentList==="mulistall"){id=parseInt(node.getAttribute("data-muall_id"),10);muPreviewUI.reset(muListAll.get(id).id)}else if(currentList==="musearch"){id=node.getAttribute("data-musearch_id");muPreviewUI.reset(muSearch.get(id).id)}};widget.toggleList=function toggleList(list){if(list!==currentList){widget.dom.querySelector("#"+currentList).classList.add("invisible");widget.dom.querySelector("#"+list).classList.remove("invisible");currentList=list}spinner.spin(widget.dom.querySelector("#mulistspinner"));widget.filterList().then(function(){spinner.stop()})};widget.refreshList=function refreshList(){if(!widget.dom.querySelector("#mulist-content input").value)currentList="mulistall";widget.toggleList(currentList)};widget.showPreview=function showPreview(id){if(currentList!=="musearch"){widget.dom.querySelector("#mulistall").classList.add("invisible");widget.dom.querySelector("#musearch").classList.remove("invisible");currentList="musearch"}spinner.spin(widget.dom.querySelector("#mulistspinner"));widget.filterList(id).then(function(){widget.dom.querySelector("#mulist-content input").value=muSearch.get(0).fields.title;spinner.stop()});muPreviewUI.reset(id)};muPreviewUI.init(widget.refreshList);user.watchValue("lang",function(){var arr;muListOptions.set("modes",["allmodes","roulette","campfire","boardroom"]);arr=muListOptions.get("lang");arr.splice(0,1,labels.get("all"));muListOptions.set("lang",arr)});Config.get("observer").watch("show-session",function(session){widget.dom.querySelector("#mulist-content input").value=session.get("title");widget.toggleList("musearch")});Config.get("observer").watch("session-exited",function(){widget.refreshList()});return widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/config":245,"../../../../services/utils":256,"./mupreview":150}],150:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Confirm=require("../../../../services/confirm"),Avatar=require("../../../../services/avatar");module.exports=function MUPreviewConstructor(){var muPreviewUI=new Widget,labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),muCDB=new CouchDBDocument,info=new Store({msg:""}),participants=new Store([]),spinner=new Spinner({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin(),refreshList;muCDB.setTransport(transport);muPreviewUI.seam.addAll({labels:new Model(labels),model:new Model(muCDB,{setTitle:function(title){this.innerHTML=title;if(user.get("_id")===session.get("initiator").id){this.setAttribute("contenteditable",true)}else{this.setAttribute("contenteditable",false)}},setDescription:function(desc){this.innerHTML=desc.replace(/\n/g,"<br>");if(user.get("_id")===session.get("initiator").id){this.setAttribute("contenteditable",true)}else{this.setAttribute("contenteditable",false)}},showDate:function(scheduled){scheduled?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(scheduled){var date,now;if(scheduled){this.setAttribute("style","display:inline-block");date=new Date(scheduled);now=new Date;if(date.toDateString()===now.toDateString())this.innerHTML=labels.get("today");else this.innerHTML=date.toLocaleDateString()}else{this.setAttribute("style","display:none")}},setTime:function(scheduled){var time,now;if(scheduled){this.setAttribute("style","display:inline-block");time=new Date(scheduled);now=new Date;if(time.getTime()-now.getTime()<=3e5)this.innerHTML=labels.get("now");else this.innerHTML=time.toLocaleTimeString().replace(/:\d\d /," ")}else{this.setAttribute("style","display:none")}},setAvatar:function setAvatar(id){var frag,ui;if(id){this.setAttribute("style","background:none;");frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setUsername:function(username){if(username)this.innerHTML=username},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "},showJoinButton:function(status){muPreviewUI.displayJoinButton(this,status,muCDB.get("participants"))},updateJoinButton:function(parts){var node=this;participants.reset(parts);muPreviewUI.displayJoinButton(node,muCDB.get("status"),parts)},displayCancel:function(leader){leader.id===user.get("_id")?this.innerHTML="&#10007":this.innerHTML=""}}),participant:new Model(participants,{setAvatar:function setAvatar(id){var frag,ui;this.setAttribute("style","background:none;");if(id){frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "},showCancel:function(id){id===user.get("_id")?this.classList.remove("invisible"):this.classList.add("invisible")}}),info:new Model(info,{showMsg:function(msg){if(msg){this.innerHTML=msg;this.classList.remove("invisible")}else{this.classList.add("invisible");this.innerHTML=""}}}),previewevent:new Event(muPreviewUI)});muPreviewUI.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:mousedown, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="datetime invisible" data-model="bind:showDate, scheduled"><div class="date" data-model="bind: setDate, scheduled"></div><div class="time" data-model="bind:setTime, scheduled"></div><div class="cancelsession" data-model = "bind: displayCancel, initiator" data-previewevent="listen: mousedown, cancelSession">&#10007</div></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:setUsername, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p><div class="cancelsession cancelpart invisible" data-participant="bind:showCancel, id" data-previewevent="listen: mousedown, cancelPart">&#10007</div></li></ul></div><div class="start-button invisible" data-model="bind:showJoinButton, status; bind: updateJoinButton, participants" data-previewevent="listen: mousedown, press; listen:mouseup, action"></div><div class="infopreview invisible" data-info="bind:showMsg, msg"></div></div></div>';muPreviewUI.reset=function reset(sid){muPreviewUI.dom.classList.remove("invisible");muCDB.sync(Config.get("db"),sid).then(function(){muCDB.watchValue("participants",function(){participants.reset(muCDB.get("participants").concat())})})};muPreviewUI.closePreview=function closePreview(event,node){muPreviewUI.dom.classList.add("invisible");muCDB.unsync();muCDB.reset({});refreshList&&refreshList()};muPreviewUI.press=function press(event,node){node.classList.add("pressed")};muPreviewUI.notify=function notify(type){var json={},now=new Date,date,dest,leader=muCDB.get("initiator").id,parts=muCDB.get("participants")||[],partIds=[];date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];json={status:"unread",date:date,author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:muCDB.get("_id"),docTitle:muCDB.get("title"),scheduled:muCDB.get("scheduled")};for(i=0;i<parts.length;i++){partIds.push(parts[i].id)}switch(type){case"newpart":json.type="MUP+";json.dest=[leader].concat(partIds);break;case"partleave":json.type="MUP-";json.dest=[leader].concat(partIds);break;case"cancel":json.type="SCANCEL";json.dest=partIds;break;case"start":json.type="SSTART";json.dest=partIds;break;default:break}transport.request("Notify",json,function(result){return result})};muPreviewUI.action=function action(event,node){var action=node.getAttribute("name"),parts=muCDB.get("participants").concat()||[];node.classList.add("invisible");node.classList.remove("pressed");spinner.spin(node.parentNode);switch(action){case"open":if(muCDB.get("initiator").id===user.get("_id")){muCDB.set("status","waiting");muCDB.upload().then(function(){if(muCDB.get("scheduled"))muPreviewUI.notify("start");muPreviewUI.enter()})}else{console.log("Error : operation not permitted for ",user.get("_id"))}break;case"enter":if(parts.indexOf(user.get("_id"))>-1){muPreviewUI.enter()}else{console.log("Error: operation not permitted for ",user.get("_id"))}break;case"join":if(parts.indexOf(user.get("_id"))>-1||parts.length>=3){console.log("Error session already full and/or user already a participant")}else{parts.push({id:user.get("_id"),intro:user.get("intro"),username:user.get("username")});muCDB.set("participants",parts);muCDB.upload().then(function(){participants.reset(muCDB.get("participants"));if(muCDB.get("scheduled"))muPreviewUI.notify("newpart");if(muCDB.get("status")==="waiting")muPreviewUI.enter();else spinner.stop()})}break;default:break}};muPreviewUI.enter=function enter(){Config.get("observer").notify("join-musession",muCDB.get("_id"));setTimeout(function(){spinner.stop();muPreviewUI.dom.classList.add("invisible");muCDB.unsync();muCDB.reset()},3e3)};muPreviewUI.init=function init(callback){refreshList=callback};muPreviewUI.displayJoinButton=function(node,status,parts){var usr=user.get("_id"),leader=muCDB.get("initiator").id,sched=muCDB.get("scheduled")||0;now=(new Date).getTime();if(sched)sched=new Date(sched).getTime();if(node.hasAttribute("name"))node.removeAttribute("name");if(status==="in progress")info.set("msg",labels.get("sessionstarted"));else if(status==="deleted"){info.set("msg",labels.get("sessiondeleted"))}else{if(leader===usr){if(status!=="waiting"&&status!=="scheduled")node.classList.add("invisible");else{if(sched-now<9e5){node.innerHTML=labels.get("openbutton");node.setAttribute("name","open");node.classList.remove("invisible");info.set("msg",labels.get("opennow"))}else{node.classList.add("invisible");info.set("msg",labels.get("openfifteen"))}}}else if(JSON.stringify(parts).search(usr)>-1){if(status==="waiting"){node.innerHTML=labels.get("enterbutton");node.setAttribute("name","enter");node.classList.remove("invisible");info.set("msg",labels.get("enternow"))}else{node.classList.add("invisible");info.set("msg",labels.get("enterfifteen"))}}else{if(parts.length<3&&(status==="scheduled"||status==="waiting")){node.innerHTML=labels.get("joinbutton");node.setAttribute("name","join");node.classList.remove("invisible");info.set("msg",labels.get("joinnow"))}else{node.classList.add("invisible");info.set("msg",labels.get("sessionfull"))}}}};muPreviewUI.cancelSession=function(event,node){var confirmCallback=function(decision){console.log(decision);if(decision){muCDB.set("status","deleted");console.log("before muCDB upload");muCDB.upload().then(function(){console.log("upload successful",muCDB.toJSON());if(muCDB.get("participants").length)muPreviewUI.notify("cancel");return muCDB.remove()}).then(function(){console.log("remove successful");muPreviewUI.closePreview()})}Confirm.hide()};Confirm.reset(labels.get("delsession"),confirmCallback,"musession-confirm");Confirm.show()};muPreviewUI.cancelPart=function(event,node){var idx=node.getAttribute("data-participant_id"),parts=muCDB.get("participants").concat();var confirmCallback=function(decision){if(decision){participants.alter("splice",idx,1);parts.splice(idx,1);muCDB.set("participants",parts);muCDB.upload().then(function(){muPreviewUI.notify("partleave")})}Confirm.hide()};Confirm.reset(labels.get("partcancel"),confirmCallback,"musession-confirm");Confirm.show()};return muPreviewUI}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/confirm":246,"../../../../services/utils":256}],151:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Place=olives["Place.plugin"],DateWidget=require("../../../../services/date"),TimeWidget=require("../../../../services/time"),Calendar=require("../../../dashboard/profile/calendar");module.exports=function NewMUBConstructor($exit){var widget=new Widget,session=new Store({}),contactList=new Store([]),invited=new Store([]),error=new Store({errormsg:""}),labels=Config.get("labels"),user=Config.get("user"),_languages=new Store(Config.get("userLanguages")),_resetLang=function(){var l=user.get("lang").substring(0,2);session.set("lang",l);_languages.loop(function(v,i){v.name===l?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},sessionTemplate={title:"",description:"",initiator:{id:user.get("_id"),username:user.get("username"),intro:user.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:user.get("active_deck"),status:"waiting",step:"mustart",lang:user.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null},dateUI=new DateWidget,timeUI=new TimeWidget,spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:680}).spin();_resetLang();widget.seam.addAll({labels:new Model(labels),newmub:new Model(session,{initSessionMode:function(mode){switch(mode){case"campfire":this.selectedIndex=1;this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2;this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0;this.setAttribute("style","color: #5F8F28;");break}},setSessionInfo:function(mode){switch(mode){case"campfire":this.innerHTML=labels.get("campfireinfo");break;case"boardroom":this.innerHTML=labels.get("boardroominfo");break;default:this.innerHTML=labels.get("rouletteinfo");break}},displayInvitations:function(mode){if(mode==="boardroom"){this.classList.remove("invisible")}else{this.classList.add("invisible")}},setTitle:function(initiator){var _now=new Date;if(initiator&&initiator.username){this.setAttribute("placeholder",labels.get("quickstarttitleplaceholderpre")+initiator.username+labels.get("quickstarttitleplaceholderpost"))}},displayLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}}),select:new Model(_languages,{setBg:function(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),place:new Place({dateUI:dateUI,timeUI:timeUI}),invited:new Model(invited,{setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),errormsg:new Model(error),newmubevent:new Event(widget)});widget.template='<div id="newmub"><div id="newmub-content"><form><div class="idealang"><div class="currentlang" data-newmub="bind: displayLang, lang" data-newmubevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newmubevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="schedule-session"><label data-labels="bind:innerHTML, schedulesession"></label><hr/><input type="radio" name="schedule" checked=true data-newmubevent="listen:click, hideDTUI"><span data-labels="bind:innerHTML, now"></span><input type="radio" name="schedule" data-newmubevent="listen: click, showDTUI"><span data-labels="bind:innerHTML, schedule"></span><br/><div class="dateandtime invisible"><div data-place="place: dateUI"></div><div data-place="place:timeUI"></div></div></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label>Invitez les participants</label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-newmubevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:mouseup, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:mousedown, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=40 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: mousedown, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: mousedown, press; listen:mouseup, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:mousedown, press; listen:mouseup, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>';
widget.place(document.getElementById("newmub"));widget.reset=function reset(){var sessionTemplate={title:"",description:"",initiator:{id:user.get("_id"),username:user.get("username"),intro:user.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:user.get("active_deck"),status:"waiting",step:"",lang:user.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null};session.reset(sessionTemplate);session.set("lang",user.get("lang"));session.set("deck",user.get("active_deck"));session.set("initiator",{id:user.get("_id"),username:user.get("username"),intro:user.get("intro")});widget.hideDTUI();widget.dom.querySelector("input[name='schedule']").checked=true;invited.reset([]);error.set("errormsg","");contactList.reset(user.get("connections").concat())};widget.showLang=function(event,node){widget.dom.querySelector(".idealang ul").classList.remove("invisible")};widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");session.set("lang",_languages.get(id).name);widget.dom.querySelector(".idealang ul").classList.add("invisible")};widget.changeSessionMode=function(event,node){var id=node.selectedIndex,opt=node.childNodes[id],name=opt.getAttribute("name");contactList.reset(user.get("connections").concat());invited.reset([]);session.set("mode",name)};widget.showDTUI=function(event,node){widget.dom.querySelector(".dateandtime").setAttribute("style","display: inline-block;")};widget.hideDTUI=function(event,node){widget.dom.querySelector(".dateandtime").setAttribute("style","display: none;");dateUI.reset();timeUI.reset()};widget.displayAutoContact=function(event,node){document.getElementById("invitelistauto").classList.remove("invisible");contactList.reset(user.get("connections").concat())};widget.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=user.get("connections").concat(),clc,vlc=node.value.toLowerCase();if(node.value===""){contactList.reset(connections)}else{for(i=arr.length-1;i>=0;i--){clc=arr[i].username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}contactList.reset(arr)}contactList.loop(function(v,i){if(invited.toJSON().search(v.contact.userid)>-1)contactList.update(i,"selected",true)})};widget.close=function close(event,node){node.parentNode.classList.add("invisible")};widget.discardContact=function(event,node){var id=node.getAttribute("data-invited_id"),userid=invited.get(id).userid;invited.alter("splice",id,1);contactList.loop(function(v,i){if(v.userid===userid)setTimeout(function(){contactList.update(i,"selected",false)},200)});widget.unselectGroup(userid)};widget.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){widget.removeContact(contactList.get(id));setTimeout(function(){contactList.update(id,"selected",false);document.getElementById("invitelistauto").classList.add("invisible")},200)}else{widget.addContact(contactList.get(id));widget.selectGroup();setTimeout(function(){contactList.update(id,"selected",true);document.getElementById("invitelistauto").classList.add("invisible")},200)}};widget.selectAll=function(event,node){node.classList.remove("pressed");invited.reset([]);contactList.reset(user.get("connections").concat());contactList.loop(function(v,i){contactList.update(i,"selected",true);if(v.type==="user"){invited.alter("push",v)}})};widget.removeContact=function(contact){if(contact.type==="group"){for(j=contact.contacts.length-1;j>=0;j--){widget.removeContact(contact.contacts[j])}}else{invited.loop(function(v,i){if(v.userid===contact.userid)invited.alter("splice",i,1)});widget.unselectGroup(contact.userid);contactList.loop(function(val,idx){if(val.userid===contact.userid)contactList.update(idx,"selected",false)})}};widget.selectGroup=function(){var cts,add=false;contactList.loop(function(v,i){if(v.type==="group"&&!v.selected){cts=v.contacts;add=true;for(j=cts.length-1;j>=0;j--){if(invited.toJSON().search(cts[j].userid)<0){add=false;break}}if(add)contactList.update(i,"selected",true)}})};widget.unselectGroup=function(userid){contactList.loop(function(v,i){if(v.type==="group"&&v.selected){if(JSON.stringify(v.contacts).search(userid)>0)contactList.update(i,"selected",false)}})};widget.addContact=function(contact){var i,l,add=true;if(contact.type==="user")invited.alter("push",contact);else{for(i=0,l=contact.contacts.length;i<l;i++){invited.loop(function(val,idx){if(val.userid===contact.contacts[i].userid)add=false});if(add){invited.alter("push",contact.contacts[i]);contactList.loop(function(val,idx){if(val.userid===contact.contacts[i].userid)contactList.update(idx,"selected",true)})}}}};widget.removeReadonly=function(event,node){node.removeAttribute("readonly")};widget.press=function(event,node){node.classList.add("pressed")};widget.clear=function(event,node){node.classList.remove("pressed");widget.reset()};widget.create=function(event,node){node.classList.remove("pressed");error.set("errormsg","");if(session.get("title").length<3||session.get("description").length<3){error.set("errormsg",labels.get("providesessioninfo"))}else if(session.get("mode")!=="roulette"&&user.get("connections").length<1){error.set("errormsg",labels.get("nofriendtoinvite"))}else if(session.get("mode")==="boardroom"&&!invited.count()){error.set("errormsg",labels.get("inviteatleastone"))}else{node.classList.add("invisible");spinner.spin(node.parentNode);widget.uploadSession().then(function(){spinner.stop();node.classList.remove("invisible");widget.reset()})}};widget.createChat=function createChat(id){var cdb=new CouchDBDocument,now=(new Date).getTime(),promise=new Promise;cdb.setTransport(Config.get("transport"));cdb.set("users",[{username:user.get("username"),userid:user.get("_id")}]);cdb.set("msg",[{user:"SYS",type:0,arg:0,time:now}]);cdb.set("sid",session.get("_id"));cdb.set("lang",session.get("lang"));cdb.set("readonly",false);cdb.set("step",0);cdb.set("type",17);cdb.sync(Config.get("db"),id).then(function(){return cdb.upload()}).then(function(){promise.fulfill();cdb.unsync()});return promise};widget.uploadSession=function uploadSession(){var cdb=new CouchDBDocument,now=new Date,scheduled,chatId,chat=session.get("chat")||[],promise=new Promise;session.set("_id","S:MU:"+now.getTime());scheduled=dateUI.getDatestamp()+timeUI.getTimestamp();if(scheduled-now.getTime()>6e5){session.set("status","scheduled");session.set("scheduled",scheduled)}session.set("date",dateUI.getDate());if(session.get("mode")==="boardroom"){invited.loop(function(v,i){session.get("invited").push(v.userid)})}if(session.get("mode")==="campfire"){session.set("invited",Utils.getUserContactIds())}chatId=session.get("_id")+"_0";chat.push(chatId);session.set("chat",chat);cdb.reset(JSON.parse(session.toJSON()));cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),cdb.get("_id")).then(function(){return widget.createChat(chatId)}).then(function(){return cdb.upload()}).then(function(){if(session.get("scheduled")){return Calendar.add({date:cdb.get("scheduled"),type:"MU",docId:cdb.get("_id"),info:"scheduled"})}else{return Calendar.add({date:now.getTime(),type:"MU",docId:cdb.get("_id"),info:"started"})}}).then(function(){var obs=Config.get("observer");if(cdb.get("mode")==="boardroom"){error.set("errormsg",labels.get("sendinginvites"));widget.sendInvites(cdb.get("invited"),cdb.get("_id"),cdb.get("title"),cdb.get("scheduled")).then(function(){cdb.get("scheduled")?obs.notify("show-session",session):obs.notify("start-mu_session",cdb.get("_id"));promise.fulfill();cdb.unsync()})}else{cdb.get("status")==="scheduled"?obs.notify("show-session",session):obs.notify("start-mu_session",cdb.get("_id"));promise.fulfill();cdb.unsync()}});return promise};widget.sendInvites=function sendInvites(idlist,sid,stitle,ssched){var promise=new Promise,now=new Date,json={type:"INV",status:"unread",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getMinutes()],author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:sid,docTitle:stitle,scheduled:ssched,dest:idlist};Config.get("transport").request("Notify",json,function(result){error.set("errormsg",labels.get("invitesent"));promise.fulfill()});return promise};widget.reset();user.watchValue("lang",function(){var tempSession=JSON.parse(session.toJSON()),tempError=JSON.parse(error.toJSON());session.reset({});session.reset(tempSession);error.reset({});error.reset(tempError)});return widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/config":245,"../../../../services/date":247,"../../../../services/time":254,"../../../../services/utils":256,"../../../dashboard/profile/calendar":200}],152:[function(require,module,exports){var olives=require("../../../libs/olives"),amy=require("../../../libs/amy2"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../services/config"),Promise=emily.Promise,Store=emily.Store,MUInit=require("./mubinit"),MUWait=require("./mubwait"),MUController=require("./session/mucontroller"),Spinner=require("../../../libs/spin.min");module.exports=function MultiBConstructor($sip,$exit){var widget=new Widget,stack=new Stack,user=Config.get("user"),muWait,muInit,muController,spinner=new Spinner({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328}).spin();widget.seam.add("mustack",stack);widget.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>';widget.place(document.getElementById("ideafy-multi"));widget.reset=function reset(sip){if(!sip){muInit.reset();stack.getStack().show("mubinit")}else if(sip.mode==="join"){widget.join(sip.id)}else if(sip.mode==="preview"){widget.showPreview(sip.id)}else{widget.replayMUSession(sip.id)}};widget.replayMUSession=function replayMUSession(id){muController.reset(id,true);stack.getStack().show("musession")};widget.showPreview=function showPreview(id){muInit.showPreview(id);stack.getStack().show("mubinit")};widget.join=function join(sid){var cdb=new CouchDBDocument;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),sid).then(function(){var p=cdb.get("participants").concat(),join=false;if(cdb.get("initiator").id===user.get("_id"))join=true;else p.forEach(function(part){if(part.id===user.get("_id")){join=true;part.present=true;cdb.set("participants",p);cdb.upload()}});if(!join){p.push({id:user.get("_id"),username:user.get("username"),intro:user.get("intro"),present:true});cdb.set("participants",p);if(p.length===3){cdb.set("status","full")}cdb.upload().then(function(){muWait.reset(sid);stack.getStack().show("mubwait")},function(error){console.log(error);alert("failed to join session")})}else{if(!cdb.get("step")||cdb.get("step")==="mustart"){muWait.reset(sid);stack.getStack().show("mubwait")}else{widget.startSession(sid)}}},function(error){console.log(error);alert("failed to join session")})};widget.startSession=function startSession(sid){stack.getStack().show("musession");muController.reset(sid)};muInit=new MUInit($exit);muWait=new MUWait($exit,widget.startSession);muController=new MUController($exit);stack.getStack().add("mubinit",muInit);stack.getStack().add("mubwait",muWait);stack.getStack().add("musession",muController);if(!$sip){stack.getStack().show("mubinit")}else{if($sip.mode==="join"){widget.join($sip.id)}else if($sip.mode==="preview"){widget.showPreview($sip.id)}else{widget.replayMUSession($sip.id)}}Config.get("observer").watch("start-mu_session",function(sid){muWait.reset(sid);stack.getStack().show("mubwait")});return widget}},{"../../../libs/CouchDBTools":72,"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"./mubinit":153,"./mubwait":154,"./session/mucontroller":156}],153:[function(require,module,exports){var olives=require("../../../libs/olives"),amy=require("../../../libs/amy2"),emily=require("../../../libs/emily"),Widget=olives.OObject,Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../services/config"),Promise=emily.Promise,Store=emily.Store,NewMUB=require("./init/newmub"),MUList=require("./init/mulist");module.exports=function MultiBInitConstructor($exit){var widget=new Widget,newMub=new NewMUB($exit),muList=new MUList($exit),stack=new Stack,labels=Config.get("labels");widget.seam.addAll({labels:new Model(labels),muinitstack:stack,muinitevent:new Event(widget)});widget.template='<div id="mub-init"><div id="muinitsliderlbl"><label data-labels="bind:innerHTML, startnewmub"></label><label data-labels="bind:innerHTML, joinmub"></label></div><input id="muinitslider" type="range" min="0" max="1" value ="1" data-muinitevent="listen: mouseup, toggleMode"><div class="exit-brainstorm" data-muinitevent="listen: mousedown, press; listen: mouseup, exit"></div><div class="stack" data-muinitstack="destination"></div></div>';widget.place(document.getElementById("mub-init"));widget.toggleMode=function(event,node){var ui;if(node.value==="1"){ui="new"}else{ui="list"}stack.getStack().show(ui);stack.getStack().get(ui).reset()};widget.press=function(event,node){node.classList.add("pressed")};widget.exit=function(event,node){node.classList.remove("pressed");$exit()};widget.reset=function reset(){newMub.reset();muList.reset()};widget.showPreview=function showPreview(id){muList.showPreview(id);stack.getStack().show("list");widget.dom.querySelector("#muinitslider").value=0};stack.getStack().add("new",newMub);stack.getStack().add("list",muList);stack.getStack().show("new");Config.get("observer").watch("show-session",function(session){stack.getStack().show("list");widget.dom.querySelector("#muinitslider").value=0});return widget}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"./init/mulist":149,"./init/newmub":151}],154:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../services/config"),Map=require("../../../services/map"),Help=require("../../../services/help"),Utils=require("../../../services/utils"),Confirm=require("../../../services/confirm"),Avatar=require("../../../services/avatar"),Chat=require("./session/mubchat"),Promise=emily.Promise,Store=emily.Store,Spinner=require("../../../libs/spin.min");module.exports=function MultiBWaitConstructor($exit,$start){var widget=new Widget,session=new CouchDBDocument,participants=new Store,info=new Store({msg:""}),user=Config.get("user"),labels=Config.get("labels"),chatUI=new Chat,confirmCallBack,exitListener={listener:null},exitDest,spinner=new Spinner({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();session.setTransport(Config.get("transport"));widget.seam.addAll({labels:new Model(labels),model:new Model(session,{setTitle:function(title){if(title)this.innerHTML=title;if(user.get("_id")===session.get("initiator").id){this.setAttribute("contenteditable",true)}else{this.setAttribute("contenteditable",false)}},setDescription:function(desc){if(desc)this.innerHTML=desc.replace(/\n/g,"<br>");if(user.get("_id")===session.get("initiator").id){this.setAttribute("contenteditable",true)}else{this.setAttribute("contenteditable",false)}},setAvatar:function setAvatar(id){var frag,ui;if(id){this.setAttribute("style","background:none;");frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "},showStartButton:function(participants){if(participants&&participants.length&&user.get("_id")===session.get("initiator").id){this.classList.remove("invisible")}else{this.classList.add("invisible")}}}),participant:new Model(participants,{setAvatar:function setAvatar(id){var frag,ui;if(id){this.setAttribute("style","background:none;");frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "},setPresent:function(present){var idx=this.getAttribute("data-participant_id")||0;present||user.get("_id")===participants.get(idx).id?this.setAttribute("style","opacity: 1;"):this.setAttribute("style","opacity: 0.4;")}}),info:new Model(info),place:new Place({chat:chatUI}),mubwaitevent:new Event(widget)});widget.template='<div id="mubwait"><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact" data-participant="bind:setPresent, present"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="exit-brainstorm" data-mubwaitevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessionmsg invisible"><span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>';widget.place(document.getElementById("mubwait"));widget.help=function(event,node){Help.setContent("mustarthelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};widget.reset=function reset(sid){chatUI.clear();session.unsync();session.reset({});participants.reset([]);session.sync(Config.get("db"),sid).then(function(){exitListener.listener=Utils.exitListener("mubwait",widget.leave);participants.reset(session.get("participants"));chatUI.reset(session.get("chat")[0]);user.set("sessionInProgress",{id:sid,type:"musession",mode:"join"});user.upload()})};widget.press=function(event,node){node.classList.add("press")};widget.exit=function(event,node){var now=(new Date).getTime(),sched=session.get("scheduled")||null;node.classList.remove("pressed");if(sched&&sched-now>3e5)$exit();else{if(session.get("initiator").id===user.get("_id")){Confirm.reset(labels.get("leaderleave"),confirmCallBack,"musession-confirm")}else{Confirm.reset(labels.get("participantleave"),confirmCallBack,"musession-confirm")}Confirm.show("musession-confirm")}};widget.leave=function leave(target){var now=(new Date).getTime();exitDest=target.getAttribute("href")||target;if(session.get("initiator").id===user.get("_id")){Confirm.reset(labels.get("leaderleave"),confirmCallBack,"musession-confirm")}else{Confirm.reset(labels.get("participantleave"),confirmCallBack,"musession-confirm")}if(!session.get("scheduled")||session.get("scheduled")-now<3e5)Confirm.show("musession-confirm")};confirmCallBack=function confirmCallback(decision){if(!decision){Confirm.hide()}else{user.set("sessionInProgress","");user.upload();if(session.get("initiator").id===user.get("_id")){widget.cancelSession()}else{widget.leaveSession()}}};widget.leaveSession=function leaveSession(){var p=session.get("participants"),i;for(i=p.length-1;i>=0;i--){if(p[i].id===user.get("_id")){p.splice(i,1);break}}session.set("participants",p);session.set("status","waiting");session.upload().then(function(){return chatUI.leave()}).then(function(){widget.goToScreen();session.unsync();session.reset({})});$exit();Confirm.hide()};widget.cancelSession=function cancelSession(){var countdown=5e3;if(!session.get("participants").length){widget.goToScreen();Confirm.hide();chatUI.cancel();session.remove().then(function(res){console.log("session remove result : ",res)},function(err){console.log("session removal error: ",err)})}else widget.displayInfo("deleting",countdown).then(function(){session.remove();Confirm.hide();widget.goToScreen()})};widget.displayInfo=function displayInfo(message,timeout){var timer,infoUI=document.querySelector(".sessionmsg"),promise=new Promise,clearInfo=function(){infoUI.classList.add("invisible");clearInterval(timer);info.set("msg","");promise.fulfill()};Confirm.hide();infoUI.classList.remove("invisible");timer=setInterval(function(){if(message!=="deleting")info.set("msg",message);else info.set("msg",labels.get("deletingsession")+timeout/1e3+"s");if(timeout<=0)clearInfo();timeout-=1e3},1e3);if(message==="deleting"){session.set("status","deleted");session.upload().then(function(){chatUI.cancel()})}return promise};widget.goToScreen=function goToScreen(){var id;$exit();document.removeEventListener("mousedown",exitListener.listener,true);if(exitDest&&exitDest.getAttribute&&exitDest.getAttribute("data-notify_id")){Config.get("observer").notify("goto-screen","#connect");id=exitDest.getAttribute("data-notify_id");observer.notify("display-message",parseInt(id,10))}else{["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(name){if(exitDest===name){Config.get("observer").notify("goto-screen",name)}})}};widget.checkUpdate=function(event,node){var field=node.getAttribute("name");if(event.keyCode===13){widget.updateSession(field,node.innerHTML);node.blur()}};widget.updateField=function(event,node){var field=node.getAttribute("name");widget.updateSession(field,node.innerHTML)};widget.updateSession=function updateSession(field,value){if(session.get(field)!==value){session.set(field,value);session.upload()}};widget.start=function(event,node){var now=new Date,chat=session.get("chat"),p=session.get("participants").concat();if(session.get("initiator").id===user.get("_id")){chatUI.conclude("start");node.classList.add("invisible");node.classList.remove("pressed");spinner.spin(node.parentNode);session.set("status","in progress");session.set("step","musetup");session.set("startTime",now.getTime());session.set("date",[now.getFullYear(),now.getMonth(),now.getDate()]);chat.push(session.get("_id")+"_1");session.set("chat",chat);for(i=p.length-1;i>=0;i--){if(!p[i].present)p.splice(i,1)}session.set("participants",p);widget.createChat(session.get("chat")[1]).then(function(){return session.upload()}).then(function(){session.unsync();spinner.stop();node.classList.remove("invisible");document.removeEventListener("mousedown",exitListener.listener,true);$start(session.get("_id"))})}};widget.createChat=function createChat(id){var cdb=new CouchDBDocument,now=(new Date).getTime(),promise=new Promise;cdb.setTransport(Config.get("transport"));cdb.set("users",chatUI.getModel().get("users"));cdb.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:now}]);cdb.set("sid",session.get("_id"));cdb.set("lang",session.get("lang"));cdb.set("readonly",false);cdb.set("step",1);cdb.set("type",17);cdb.sync(Config.get("db"),id).then(function(){return cdb.upload()}).then(function(){promise.fulfill();cdb.unsync()});return promise};session.watchValue("status",function(value){if(value==="deleted"&&session.get("initiator").id!==user.get("_id")){session.unsync();widget.displayInfo(labels.get("canceledbyleader"),2e3).then(function(){document.removeEventListener("mousedown",exitListener.listener,true);$exit()})}if(value==="in progress"&&session.get("initiator").id!==user.get("_id")){session.unsync();document.removeEventListener("mousedown",exitListener.listener,true);$start(session.get("_id"));session.reset({});participants.reset([])}});session.watchValue("participants",function(array){participants.reset(array)});return widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245,"../../../services/confirm":246,"../../../services/help":248,"../../../services/map":249,"../../../services/utils":256,"./session/mubchat":155}],155:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Avatar=require("../../../../services/avatar");function MUBChatConstructor(){var mubChat=this,chat=new Store([]),chatCDB=new CouchDBDocument,labels=Config.get("labels"),user=Config.get("user"),position="null",spinner=new Spinner({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:20}).spin();chatCDB.setTransport(Config.get("transport"));mubChat.seam.addAll({labels:new Model(labels),model:new Model(chatCDB,{setReadonly:function(readonly){if(readonly){this.setAttribute("contenteditable",false);this.setAttribute("style","display:none;")}else{this.setAttribute("style","display:table-cell;");this.setAttribute("contenteditable",true)}},setHeight:function(readonly){readonly?this.classList.add("extended"):this.classList.remove("extended")}}),chat:new Model(chat,{setLiStyle:function(usr){if(usr===position){this.setAttribute("style","text-align: right;")}else{this.setAttribute("style","text-align: left;")}},setInnerMsgStyle:function(usr){if(usr==="SYS"){this.setAttribute("style","background: none; border: none")}else if(usr===position){this.setAttribute("style","background: #9AC9CD; border: 1px solid #808080; border-radius: 5px;")}else{this.setAttribute("style","background: #E6E6E6; border: 1px solid #808080; border-radius: 5px;float: left;max-width: 556px;")}},setTime:function(time){if(time){this.innerHTML=Utils.formatTime(time)}},setAvatar:function(usr){var frag,ui,uid;if(usr==="SYS"){this.classList.remove("invisible");this.classList.add("doctor-deedee")}else if(usr===position){this.classList.add("invisible")}else if(typeof usr==="number"){this.classList.remove("invisible");frag=document.createDocumentFragment();uid=chatCDB.get("users")[usr].userid;ui=new Avatar([uid]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setUserName:function(usr){if(typeof usr==="number"&&usr!==position){this.innerHTML=" "+chatCDB.get("users")[usr].username+labels.get("said")}},setMsg:function(msg){var id,type;if(msg){this.innerHTML=msg;this.setAttribute("style","color: #292929; font-size: 14px;")}else{this.setAttribute("style","color: #CCCCCC; font-size: 12px;");id=this.getAttribute("data-chat_id");type=chat.get(id).type;if(type<=3){this.innerHTML=chatCDB.get("users")[chat.get(id).arg].username+labels.get("chatmsg"+type)}else if(type===5){this.innerHTML=labels.get("chatmsg"+type)+labels.get(chat.get(id).arg)}else{this.innerHTML=labels.get("chatmsg"+type)}}}}),chatevent:new Event(mubChat)});mubChat.template='<div class="mubchat"><div id="chatspinner"></div><div class="chatread" data-model="bind:setHeight, readonly"><ul class="chatmessages" data-chat="foreach"><li data-chat="bind:setLiStyle, user"><div class="container" data-chat="bind:setAvatar, user"></div><div class="innerchatmsg" data-chat="bind:setInnerMsgStyle, user"><span class="time" data-chat="bind: setTime, time"></span><span class="username" data-chat="bind:setUserName, user"></span><br/><span class="chatmsg" data-chat="bind: setMsg, msg"></span></div></li></ul></div><div class="chatwrite placeholder" data-model="bind:setReadonly, readonly" data-labels="bind:innerHTML, typemsg" data-chatevent = "listen:mousedown, removePlaceholder; listen: keypress, post"></div></div>';mubChat.removePlaceholder=function(event,node){if(node.innerHTML===labels.get("typemsg")){node.innerHTML="";node.classList.remove("placeholder")}};mubChat.post=function(event,node){var now,msg,id;if(event.keyCode===13&&node.innerHTML!==""){now=(new Date).getTime();msg=chatCDB.get("msg");chat.alter("push",{user:position,time:now,msg:node.innerHTML});id=chat.count()-1;mubChat.dom.querySelector("li[data-chat_id='"+id+"']").scrollIntoView();msg.push({user:position,time:now,msg:node.innerHTML});chatCDB.set("msg",msg);node.innerHTML=labels.get("typemsg");node.classList.add("placeholder");node.blur();chatCDB.upload()}};mubChat.setReadonly=function setReadonly(){chatCDB.set("readonly",true)};mubChat.conclude=function conclude(reason){mubChat.setReadonly();mubChat.setMessage(reason)};mubChat.setMessage=function setMessage(message,arg){var now=(new Date).getTime(),msg=chatCDB.get("msg"),id,newMsg,promise=new Promise;switch(message){case"start":newMsg={user:"SYS",time:now,type:4};break;case"end":chat.alter("push",{user:"SYS",type:2,time:now,arg:position});msg.push({user:"SYS",type:2,time:now,arg:position});now=(new Date).getTime();newMsg={user:"SYS",time:now,type:7};mubChat.setReadonly();break;case"leave":newMsg={user:"SYS",type:2,time:now,arg:position};break;case"next":newMsg={user:"SYS",type:6,time:now};break;case"initStep":newMsg={user:"SYS",type:5,time:now,arg:arg};break;default:break}chat.alter("push",newMsg);id=chat.count()-1;mubChat.dom.querySelector("li[data-chat_id='"+id+"']").scrollIntoView();msg.push(newMsg);chatCDB.set("msg",msg);chatCDB.upload().then(function(){promise.fulfill()});return promise};mubChat.clear=function clear(){chat.reset([])};mubChat.reset=function reset(chatId){var promise=new Promise;position="null";mubChat.dom.querySelector(".chatwrite").classList.add("placeholder");mubChat.dom.querySelector(".chatwrite").innerHTML=labels.get("typemsg");chatCDB.unsync();chatCDB.reset({});chat.reset([]);spinner.spin(mubChat.dom.querySelector("#chatspinner"));chatCDB.sync(Config.get("db"),chatId).then(function(){var i,arr=chatCDB.get("users");for(i=0;i<arr.length;i++){if(arr[i].userid===user.get("_id")){position=i;break}}if(isNaN(position)&&!chatCDB.get("readonly")){mubChat.joinChat().then(function(){spinner.stop();promise.fulfill()})}else{chat.reset(chatCDB.get("msg"));spinner.stop();promise.fulfill()}});return promise};mubChat.joinChat=function joinChat(){var promise=new Promise,arr=chatCDB.get("users"),pos=arr.length,now=(new Date).getTime(),msg=chatCDB.get("msg");arr.push({username:user.get("username"),userid:user.get("_id")});chatCDB.set("users",arr);if(chatCDB.get("_id").search("_0")>-1){msg.push({user:"SYS",time:now,type:1,arg:pos});chatCDB.set("msg",msg);chat.reset(msg)}chatCDB.upload().then(function(){position=pos;
promise.fulfill()});return promise};mubChat.leave=function leave(){var promise=new Promise,idx=null,i,users=chatCDB.get("users");mubChat.setMessage("leave").then(function(){return chatCDB.upload()}).then(function(){promise.fulfill();chatCDB.unsync();chatCDB.reset();chat.reset([])});return promise};mubChat.cancel=function cancel(){chatCDB.remove();chatCDB.unsync();chatCDB.reset({});chat.reset([])};mubChat.getModel=function getModel(){return chatCDB};chatCDB.watchValue("msg",function(arrCDB){var l=arrCDB.length-1;chat.reset(arrCDB);mubChat.dom.querySelector("li[data-chat_id='"+l+"']").scrollIntoView()})}module.exports=function MUBChatFactory(){MUBChatConstructor.prototype=new Widget;return new MUBChatConstructor}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/utils":256}],156:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),amy=require("../../../../libs/amy2"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],MUStart=require("./mustart"),MUSetup=require("./musetup"),MUScenario=require("./muscenario"),MUTech=require("./mutech"),MUIdea=require("./muidea"),MUWrapup=require("./muwrapup"),CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Place=olives["Place.plugin"],Confirm=require("../../../../services/confirm");module.exports=function MUControllerConstructor($exit){var _widget=new Widget,_progress=new Widget,_frag=document.createDocumentFragment(),_stack=new Stack,_labels=Config.get("labels"),steps=[{name:"mustart",label:_labels.get("quickstepstart"),currentStep:false,status:"done"},{name:"musetup",label:_labels.get("quickstepsetup"),currentStep:false,status:null},{name:"muscenario",label:_labels.get("quickstepscenario"),currentStep:false,status:null},{name:"mutech",label:_labels.get("quicksteptech"),currentStep:false,status:null},{name:"muidea",label:_labels.get("quickstepidea"),currentStep:false,status:null},{name:"muwrapup",label:_labels.get("quickstepwrapup"),currentStep:false,status:null}],muStart,muSetup,muScenario,muTech,muIdea,muWrapup,_steps=new Store(steps),_user=Config.get("user"),_db=Config.get("db"),_session=new CouchDBDocument,_sessionData=new Store,info=new Store({msg:""}),exitListener={listener:null},confirmCallBack,spinner=new Spinner({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin();_progress.seam.addAll({labels:new Model(_labels),step:new Model(_steps,{setCurrent:function(currentStep){currentStep?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(status){status?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new Event(_progress)});_progress.template='<div class = "progressbar invisible"><ul id = "musteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>';_progress.changeStep=function(event,node){var _id=node.getAttribute("data-step_id");if(_steps.get(_id).status){_steps.loop(function(v,i){_id==i?_steps.update(i,"currentStep",true):_steps.update(i,"currentStep",false)});_stack.getStack().show(_steps.get(_id).name)}else{event.stopImmediatePropagation()}};_progress.press=function(event,node){node.classList.add("pressed")};_progress.exit=function(event,node){node.classList.remove("pressed");if(_user.get("sessionInProgress").id!==_session.get("_id")){$exit()}else{if(_session.get("step")==="muwrapup"){if(_session.get("initiator").id===_user.get("_id")){muWrapup.getChatUI().setMessage("end").then(function(){_user.set("sessionInProgress","");return _user.upload()}).then(function(){$exit();document.removeEventListener("mousedown",exitListener.listener,true)})}else{muWrapup.getChatUI().leave();_user.set("sessionInProgress","");_user.upload().then(function(){$exit();document.removeEventListener("mousedown",exitListener.listener,true)})}}else{_widget.leave()}}};_widget.template='<div id="musession"><div data-place="place:progress"></div><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></div><div class="stack" data-musessionstack="destination"></div></div>';_widget.seam.addAll({musessionstack:_stack,place:new Place({progress:_progress}),info:new Model(info)});_widget.toggleProgress=function toggleProgress(end){end?_progress.exit():_progress.dom.classList.toggle("invisible")};confirmCallBack=function confirmCallback(decision){if(!decision){Confirm.hide()}else{if(_session.get("step")!=="muwrapup"){_user.set("sessionInProgress","");_user.upload();if(_session.get("initiator").id===user.get("_id")){_widget.cancelSession()}else{_widget.leaveSession()}}else{Confirm.hide();_widget.exitSession()}}};_widget.exitSession=function exitSession(){if(_session.get("initiator").id===_user.get("_id")){muWrapup.getChatUI().setMessage("end").then(function(){_user.set("sessionInProgress","");return _user.upload()}).then(function(){_widget.goToScreen()})}else{muWrapup.getChatUI().leave();_user.set("sessionInProgress","");_user.upload().then(function(){_widget.goToScreen()})}};_widget.goToScreen=function goToScreen(){var id;$exit();document.removeEventListener("mousedown",exitListener.listener,true);if(exitDest.getAttribute&&exitDest.getAttribute("data-notify_id")){Config.get("observer").notify("goto-screen","#connect");id=exitDest.getAttribute("data-notify_id");observer.notify("display-message",parseInt(id,10))}else{["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(name){if(exitDest===name){Config.get("observer").notify("goto-screen",name)}})}};_widget.leaveSession=function leaveSession(){var p=_session.get("participants"),i,currentUI=_stack.getStack().get(_session.get("step"));for(i=p.length-1;i>=0;i--){if(p[i].id===_user.get("_id")){p.splice(i,1);break}}_session.set("participants",p);_session.upload().then(function(){currentUI.getChatUI().leave();_session.unsync();Confirm.hide()});_user.set("sessionInProgress","");_user.upload().then(function(){$exit();document.removeEventListener("mousedown",exitListener.listener,true)})};_widget.cancelSession=function cancelSession(){var countdown=5e3;_widget.displayInfo("deleting",countdown).then(function(){$exit();document.removeEventListener("mousedown",exitListener.listener,true)})};_widget.displayInfo=function displayInfo(message,timeout){var timer,infoUI=document.querySelector(".sessionmsg"),promise=new Promise,clearInfo=function(){infoUI.classList.add("invisible");clearInterval(timer);info.set("msg","");promise.fulfill()};Confirm.hide();infoUI.classList.remove("invisible");timer=setInterval(function(){switch(message){case"deleting":info.set("msg",_labels.get("deletingsession")+timeout/1e3+"s");break;case"participantsleft":info.set("msg",_labels.get("participantsleft")+" "+timeout/1e3+"s");break;default:if(message!==info.get("msg")){info.set("msg",message)}break}if(timeout<=0){clearInfo()}timeout-=1e3},1e3);if(message==="deleting"||message==="participantsleft"){_session.set("status","deleted");_session.upload().then(function(){_user.set("sessionInProgress","");return _user.upload()}).then(function(){var chat=_session.get("chat"),nb=chat.length,p=new Promise;if(nb){chat.forEach(function(id){var cdb=new CouchDBDocument;cdb.setTransport(Config.get("transport"));cdb.sync(_db,id).then(function(){return cdb.remove()}).then(function(){nb--;if(nb<=0){p.fulfill}})})}else{p.fulfill()}return p}).then(function(){_session.remove()})}return promise};_widget.createChat=function createChat(step){var cdb=new CouchDBDocument,now=(new Date).getTime(),usr=[],arg,id,promise=new Promise;usr.push({username:_session.get("initiator").username,userid:_session.get("initiator").id});_session.get("participants").forEach(function(part){usr.push({username:part.username,userid:part.id})});cdb.set("users",usr);switch(step){case 1:arg="quicksetup";break;case 2:arg="quickscenario";break;case 3:arg="quicktech";break;case 4:arg="quickidea";break;case 5:arg="quickwrapup";break;default:arg="quickstart";break}cdb.set("msg",[{user:"SYS",type:5,arg:arg,time:now}]);cdb.set("sid",_session.get("_id"));cdb.set("lang",_session.get("lang"));cdb.set("readonly",false);cdb.set("step",step);cdb.set("type",17);id=cdb.get("sid")+"_"+step;cdb.setTransport(Config.get("transport"));cdb.sync(_db,id).then(function(){return cdb.upload()}).then(function(){var chat=_session.get("chat").concat();cdb.unsync();chat.push(id);_session.set("chat",chat);promise.fulfill()});return promise};_widget.retrieveSession=function retrieveSession(sid,replay){var promise=new Promise;spinner.spin(document.getElementById("brainstorm"));_session.reset({});_session.sync(_db,sid).then(function(){var step=_session.get("step"),current=1e4,length=_steps.count();_steps.loop(function(v,i){if(i<current){_stack.getStack().get(v.name).reset(replay);_steps.update(i,"status","done");if(v.name===step){current=i;_steps.update(i,"currentStep",true);v.name==="muwrapup"?_steps.update(i,"status","done"):_steps.update(i,"status","ongoing")}}});if(replay){spinner.stop();promise.fulfill();_stack.getStack().show("muwrapup")}else{if(_session.get("initiator").id===_user.get("_id")){Confirm.reset(_labels.get("leaderleave"),confirmCallBack)}else{Confirm.reset(_labels.get("participantleave"),confirmCallBack)}spinner.stop();promise.fulfill();_stack.getStack().show(step)}});return promise};_widget.leave=function leave(){var lbl="";if(_session.get("initiator").id===_user.get("_id")){_session.get("step")==="muwrapup"?lbl=labels.get("leaderexit"):lbl=labels.get("leaderleave")}else{_session.get("step")==="muwrapup"?lbl=labels.get("participantexit"):lbl=labels.get("participantleave")}Confirm.reset(lbl,confirmCallBack,"musession-confirm");Confirm.show()};_widget.reset=function reset(sid,replay){_session.unsync();_sessionData.reset();_steps.reset([{name:"mustart",label:_labels.get("quickstepstart"),currentStep:false,status:"done"},{name:"musetup",label:_labels.get("quickstepsetup"),currentStep:false,status:null},{name:"muscenario",label:_labels.get("quickstepscenario"),currentStep:false,status:null},{name:"mutech",label:_labels.get("quicksteptech"),currentStep:false,status:null},{name:"muidea",label:_labels.get("quickstepidea"),currentStep:false,status:null},{name:"muwrapup",label:_labels.get("quickstepwrapup"),currentStep:false,status:null}]);if(sid){_widget.retrieveSession(sid,replay).then(function(){if(!replay)exitListener.listener=Utils.exitListener("musession",_widget.leave)})}};_widget.prev=function prev(currentName){var _id;_steps.loop(function(value,idx){if(value.name===currentName){_id=idx}});if(_id>0){_steps.update(_id,"currentStep",false);_steps.update(_id-1,"currentStep",true);_stack.getStack().show(_steps.get(_id-1).name)}else{alert("Exiting session");$exit()}};_widget.next=function next(currentName){var _id,_currentui=_stack.getStack().get(currentName),_nextui,_newStep="",promise=new Promise;_steps.loop(function(value,idx){if(value.name===currentName){_id=idx}});if(_id<_steps.count()){_newStep=_steps.get(_id+1).name;_nextui=_stack.getStack().get(_newStep);_steps.update(_id,"currentStep",false);_steps.update(_id+1,"currentStep",true);if(_steps.get(_id).status!=="done"){_steps.update(_id,"status","done");_steps.update(_id+1,"status","ongoing");if(_steps.get(_id+1).name==="muwrapup"){_steps.update(_id+1,"status","done")}_nextui.reset();_widget.createChat(_id+1).then(function(){_session.set("step",_newStep);return _session.upload()}).then(function(){if(_nextui.initTimer){_nextui.initTimer()}_currentui.stopSpinner();_stack.getStack().show(_newStep);if(_newStep==="muwrapup"){_user.unsync();_user.sync(Config.get("db"),_user.get("_id")).then(function(){_user.set("sessionInProgress","");return _user.upload()}).then(function(){promise.fulfill()})}else{promise.fulfill()}})}else{_currentui.stopSpinner();_stack.getStack().show(_newStep);promise.fulfill()}}return promise};_widget.init=function init(){muStart=new MUStart(_session,_widget.prev,_widget.next,_widget.toggleProgress);muSetup=new MUSetup(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress);muScenario=new MUScenario(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress);muTech=new MUTech(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress);muIdea=new MUIdea(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress);muWrapup=new MUWrapup(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress);_session.setTransport(Config.get("transport"));_stack.getStack().add("mustart",muStart);_stack.getStack().add("musetup",muSetup);_stack.getStack().add("muscenario",muScenario);_stack.getStack().add("mutech",muTech);_stack.getStack().add("muidea",muIdea);_stack.getStack().add("muwrapup",muWrapup)};_widget.init();_session.watchValue("status",function(value){if(value==="deleted"&&_session.get("initiator").id!==_user.get("_id")){_user.set("sessionInProgress","");_user.upload();_widget.displayInfo(_labels.get("canceledbyleader"),2e3).then(function(){_session.unsync();$exit();document.removeEventListener("mousedown",exitListener.listener,true)})}});_session.watchValue("step",function(value){var idx,newStep=_session.get("step");if(_session.get("initiator")&&_session.get("initiator").id!==_user.get("_id")){_steps.loop(function(v,i){if(v.name===newStep){idx=i}});_steps.update(idx-1,"status","done");_steps.update(idx,"status","ongoing");_steps.update(idx-1,"currentStep",false);_steps.update(idx,"currentStep",true);_stack.getStack().get(value).reset();_stack.getStack().show(value)}if(step==="muwrapup"){_user.unsync();_user.sync(Config.get("db"),_user.get("_id")).then(function(){_user.set("sessionInProgress","");return _user.upload()})}});_session.watchValue("participants",function(part){if(part.length===0&&_session.get("step")!=="muwrapup"){_widget.displayInfo("participantsleft",1e4).then(function(){_user.set("sessionInProgress","");return _user.upload()}).then(function(){$exit();document.removeEventListener("mousedown",exitListener.listener,true)})}});return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/amy2":75,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/config":245,"../../../../services/confirm":246,"../../../../services/map":249,"../../../../services/utils":256,"./muidea":157,"./muscenario":158,"./musetup":159,"./mustart":160,"./mutech":161,"./muwrapup":163}],157:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Place=olives["Place.plugin"],CardPopup=require("../../../../services/cardpopup"),Chat=require("./mubchat"),Vote=require("./muvote"),Whiteboard=require("../../whiteboard/whiteboard");module.exports=function MUIdeaConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,_currentPopup,chatUI=new Chat,voteUI=new Vote,_next="step",_start,_elapsed=0,_miTimer,_miInterval,_timer=new Store({timer:null,display:false}),_idea=new Store({title:"",description:"",solution:"",visibility:"private"}),_scenario=new Store,_techs=new Store([]),_techDetails=[],_initTools={cardpopup:{scenario:false,techs:[false,false,false]},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showidea:false,shownext:false,readonly:false},_tools=new Store(_initTools),_wbContent=new Store([]),_wb=new Whiteboard("idea",_wbContent,_tools,"mu"),_transport=Config.get("transport"),_user=Config.get("user"),_db=Config.get("db"),_labels=Config.get("labels"),_voted=false,spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();_widget.isLeader=function isLeader(){return $session.get("initiator")&&$session.get("initiator").id===_user.get("_id")};_widget.seam.addAll({labels:new Model(_labels,{setPlaceholder:function(value){this.setAttribute("placeholder",value)}}),scenario:new Model(_scenario),techs:new Model(_techs,{setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),wbtools:new Model(_tools,{setActive:function(status){status==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(ready){if(_widget.isLeader()){ready?this.classList.remove("invisible"):this.classList.add("invisible")}else{this.classList.add("invisible")}},showIdea:function(showidea){showidea?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(showstory){showstory?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(readonly){readonly?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(pop){var idx;if(this.getAttribute("name")==="scenario"){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}else{idx=this.getAttribute("data-techs_id");pop[idx]?this.classList.add("highlighted"):this.classList.remove("highlighted")}}}),muideatimer:new Model(_timer,{setTime:function(timer){this.innerHTML=Utils.formatDuration(timer)},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new Model(_idea),wbstack:_wb,place:new Place({chat:chatUI,vote:voteUI}),muideaevent:new Event(_widget)});_widget.template='<div id = "muidea"><div class="previousbutton" data-muideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, muidea" data-muideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muideatimer="bind:setTime, timer; bind: displayTimer, display" data-muideaevent="listen:mousedown,toggleTimer"></div><div id="muidea-left"><div class="idea-cards leftarea folded" data-muideaevent="listen:mousedown, fold"><div class="card defaultscenario" name="scenario" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul><div class="caret"></div></div><div id="muidea-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muideaevent="listen:mousedown, toggleCaret"></div></div><div id = "muidea-writeup" class="writeup invisible" data-wbtools="bind: showIdea,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionvote" data-place="place:vote"></div><div class="sessionchat" data-place="place:chat"></div></div>';_widget.place(Map.get("muidea"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){var now=new Date,id,_timers,duration,visibility,replay,promise=new Promise;node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";_tools.set("readonly",true);clearInterval(_miTimer);_timer.set("display",true);clearInterval(_miInterval);duration=_widget.getSessionDuration();voteUI.reset($session,function(result){_voted=true;visibility=result.visibility;replay=result.replay;_idea.set("visibility",visibility);_idea.set("sessionReplay",replay);promise.fulfill();voteUI.close()});promise.then(function(){spinner.spin(node.parentNode);$data.set("idea",JSON.parse(_idea.toJSON()));id="I:"+now.getTime();return _widget.createIdeaDoc(id)}).then(function(){$session.unsync();return $session.sync(_db,$session.get("_id"))}).then(function(){var timers=$session.get("elapsedTimers");chatUI.conclude("next");timers.muidea=_timer.get("timer");$session.set("idea",[JSON.parse(_idea.toJSON())]);if(replay)$session.set("replayIdeas",[id]);$session.set("elapsedTimers",timers);$session.set("duration",duration);$session.set("status","completed");$session.set("idea",[$data.get("idea")]);return $session.upload()}).then(function(){return _widget.updateSessionScore(_timer.get("timer"))}).then(function(){$next("muidea")})}else $next("muidea")};_widget.stopSpinner=function stopSpinner(){spinner.stop()};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("muidea")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){if(_widget.isLeader()){_timer.set("display",!_timer.get("display"))}};_widget.toggleVisibility=function(event,node){if(_next==="step"&&_widget.isLeader()){_idea.get("visibility")==="public"?_idea.set("visibility","private"):_idea.set("visibility","public")}};_widget.push=function(event,node){var name=node.getAttribute("name");_tools.set(name,"active")};_widget.zoom=function(event,node){event.stopPropagation();var type,id;if(node.getAttribute("name")==="scenario")type="scenario";else{type="techno";id=node.getAttribute("data-techs_id")}_widget.setPopup(type,id)};_widget.fold=function(event,node){if(!$session.get("ideaReady")){node.classList.toggle("folded");node.querySelector(".caret").classList.toggle("folding");if(_currentPopup){_popupUI.close()}}};_widget.setPopup=function setPopup(type,id){var pos={x:147,y:30},caret="left",popup=_tools.get("cardpopup"),story=new Store,details="",temp,cdb;if(_currentPopup){_currentPopup.type==="scenario"?popup.scenario=false:popup.techs[_currentPopup.id]=false;_tools.set("cardpopup",popup)}type==="scenario"?popup.scenario=true:popup.techs[id]=true;_tools.set("cardpopup",popup);_currentPopup={type:type,id:id};if(type==="scenario"){pos.y=55;story.reset($data.get("scenario"));story.set("type",5);details=story.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("muidea-popup"))}else{if(id==0)pos.y=200;if(id==1)pos.y=260;if(id==2)pos.y=350;if(_techDetails[id]){details=_techDetails[id];_popupUI.reset(details,pos,caret,document.getElementById("muidea-popup"))}else{cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),$data.get("techno").get(id).id).then(function(){details=cdb.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("muidea-popup"));_techDetails[id]=details})}}};_widget.closePopup=function closePopup(){_tools.set("cardpopup",{scenario:false,techs:[false,false,false]});_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.getChatUI=function getChatUI(){return chatUI};_widget.post=function(event,node){_wb.selectScreen("postit");_tools.set("import","inactive");_tools.set("drawing","inactive")};_widget.importpic=function(event,node){_wb.selectScreen("import");_tools.set("postit","inactive");_tools.set("drawing","inactive")};_widget.draw=function(event,node){_wb.selectScreen("drawing");_tools.set("import","inactive");_tools.set("postit","inactive")};_widget.exitTool=function exitTool(name){_tools.set(name,"inactive")};_widget.finish=function(event,node){var finishSpinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();finishSpinner.spin(node.parentNode);node.classList.add("invisible");$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){$session.set("ideaReady",true);return $session.upload()}).then(function(){finishSpinner.stop();node.classList.remove("pressed");_tools.set("ready",false);_widget.displayIdea();_widget.updateIdea()})};_widget.updateField=function updateField(event,node){if(node.classList.contains("enterTitle")){_idea.set("title",node.value)}if(node.classList.contains("enterDesc")){_idea.set("description",node.value)}if(node.classList.contains("enterSol")){_idea.set("solution",node.value)}};_widget.displayIdea=function displayIdea(){_wb.setReadonly(true);_tools.set("showidea",true);_widget.dom.querySelector(".idea-cards").classList.remove("folded");_widget.dom.querySelector(".idea-cards .caret").classList.add("invisible");_widget.dom.querySelector(".writeup").scrollIntoView();_widget.dom.querySelector(".whiteboard .caret").classList.remove("invisible")};_widget.hideIdea=function hideIdea(){_widget.dom.querySelector(".idea-cards").classList.add("folded");_widget.dom.querySelector(".idea-cards .caret").classList.remove("invisible");_widget.dom.querySelector(".whiteboard .caret").classList.add("invisible")};_widget.toggleCaret=function(event,node){event.stopPropagation();var _writeup=_widget.dom.querySelector(".writeup"),_whiteboard=_widget.dom.querySelector(".whiteboard");node.classList.toggle("descending");node.classList.contains("descending")?_writeup.scrollIntoView():_whiteboard.scrollIntoView()};_widget.toggleView=function(event,node){var caret=node.querySelector(".caret"),_writeup=_widget.dom.querySelector(".writeup"),_whiteboard=_widget.dom.querySelector(".whiteboard");if(caret.classList.contains("descending")){caret.classList.remove("descending");_whiteboard.scrollIntoView()}else{if(event.pageY-node.scrollHeight>0){caret.classList.add("descending");_writeup.scrollIntoView()}}};_widget.updateIdea=function updateIdea(event,node){_miInterval=setInterval(function(){var _sIdea=$session.get("idea")[0]||{title:"",description:"",solution:""},_title=_sIdea.title,_description=_sIdea.description,_solution=_sIdea.solution,cdbId={};if(_idea.get("title")!==_title||_idea.get("description")!==_description||_idea.get("solution")!==_solution){cdbId.title=_idea.get("title");cdbId.description=_idea.get("description");cdbId.solution=_idea.get("solution");$session.set("idea",[cdbId]);$session.upload().then(function(success){return true},function(err){console.log("failed to update idea",err)})}},8e3)};_widget.updateSessionScore=function(timer){var promise=new Promise,json={sid:$session.get("_id"),step:"muidea",time:timer,wbcontent:_wbContent.toJSON(),idea:_idea.toJSON()};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){promise.fulfill()})}else{promise.reject()}});return promise};_widget.getSessionDuration=function getSessionDuration(){var elapsed=$session.get("elapsedTime"),start=$session.get("resumeTime")||$session.get("startTime");now=new Date;return now.getTime()-start+elapsed};_widget.createIdeaDoc=function createIdeaDoc(_id){var cdb=new CouchDBDocument(Config.get("ideaTemplate")),now=new Date(parseInt(_id.slice(2,_id))),names=[],promise=new Promise;auth.push($session.get("initiator").id);names.push($session.get("initiator").username);$session.get("participants").forEach(function(part){if(part.present){auth.push(part.id);names.push(part.username)}});cdb.setTransport(_transport);cdb.set("title",_idea.get("title"));cdb.set("sessionId",$session.get("_id"));cdb.set("authors",auth);cdb.set("description",_idea.get("description"));cdb.set("solution",_idea.get("solution"));cdb.set("creation_date",[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()]);cdb.set("character",$session.get("characters")[0]);cdb.set("problem",$session.get("problems")[0]);cdb.set("context",$session.get("contexts")[0]);cdb.set("techno",$session.get("techno")[0]);cdb.set("visibility",_idea.get("visibility"));cdb.set("sessionReplay",_idea.get("sessionReplay"));cdb.set("authornames",names.join(", "));cdb.set("lang",$session.get("lang").substring(0,2));cdb.set("_id",_id);cdb.sync(Config.get("db"),_id).then(function(){return cdb.upload()}).then(function(){if(cdb.get("visibility")==="public"){_transport.request("UpdateUIP",{userid:_user.get("_id"),type:cdb.get("type"),docId:cdb.get("_id"),docTitle:cdb.get("title")},function(result){if(result!=="ok"){console.log(result)}});$session.get("participants").forEach(function(part){_transport.request("UpdateUIP",{userid:part.id,type:cdb.get("type"),docId:cdb.get("_id"),docTitle:cdb.get("title")},function(result){if(result!=="ok"){console.log(part.id," "+result)}})})}promise.fulfill();cdb.unsync()});return promise};_widget.reset=function reset(replay){chatUI.clear();if($session.get("chat")[4]){chatUI.reset($session.get("chat")[4])}_tools.reset({cardpopup:{scenario:false,techs:[false,false,false]},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showidea:false,shownext:false,readonly:false});_techs.reset();_wb.setSessionId($session.get("_id"));_wbContent.reset($session.get("ideaWB"));_wb.init();_wbContent.count()?_wb.selectScreen("main"):_wb.selectScreen("default");clearInterval(_miTimer);if(replay||$session.get("idea").length){_next="screen";chatUI.dom.querySelector(".chatread").classList.add("extended");_tools.set("ready",false);_widget.displayIdea();_idea.reset($session.get("idea")[0]);$data.set("idea",$session.get("idea")[0]);_tools.set("readonly",true);_tools.set("shownext",false)}else{_idea.reset({title:"",description:"",solution:"",visibility:"private"});
_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false);_wb.setReadonly(false);_next="step";_voted=false}if($session.get("elapsedTimers").muidea){_elapsed=$session.get("elapsedTimers").muidea;_timer.set("timer",_elapsed);if(_next==="screen"){_timer.set("display",true)}else if(_widget.isLeader()){_widget.initTimer(_elapsed)}}};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="muidea"){_miTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};$session.watchValue("_id",function(sid){_wb.setSessionId(sid)});$session.watchValue("chat",function(arr){if(arr.length===5&&chatUI.getModel().get("_id")!==arr[4]){chatUI.reset(arr[4])}});$data.watchValue("scenario",function(store){_scenario.reset($data.get("scenario"))});$data.watchValue("techno",function(store){_techs.reset(JSON.parse($data.get("techno").toJSON()))});["added","deleted","updated"].forEach(function(change){_wbContent.watch(change,function(val){if(!_tools.get("showidea")){if($session.get("ideaWB").length!==_wbContent.count()||JSON.stringify($session.get("ideaWB"))!==_wbContent.toJSON()){$session.set("ideaWB",JSON.parse(_wbContent.toJSON()));$session.upload().then(function(response){console.log("success : ",response)},function(response){console.log("failure : ",response)})}_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false)}})});$session.watchValue("ideaWB",function(content){if($session.get("step")==="muidea"&&!_tools.get("showidea")){if(content.length&&_wb.getStack().getCurrentName()==="default"){_wb.selectScreen("main")}if(!content.length){_wb.selectScreen("default")}if(content.length!==_wbContent.count()||JSON.stringify(content)!==_wbContent.toJSON()){_wbContent.reset(content)}}});$session.watchValue("ideaReady",function(ready){if($session.get("step")==="muidea"&&ready&&!_widget.isLeader()){_tools.set("readonly",true);_widget.displayIdea()}});$session.watchValue("idea",function(arr){if(!_widget.isLeader()){_idea.reset(arr[0]);$data.set("idea",JSON.parse(_idea.toJSON()))}});_idea.watch("updated",function(){_widget.isLeader()&&_idea.get("title")&&_idea.get("description")&&_idea.get("solution")?_tools.set("shownext",true):_tools.set("shownext",false)});$session.watchValue("vote",function(vote){if(vote&&!_voted&&!_widget.isLeader()&&!voteUI.isActive()){voteUI.reset($session,function(result){if(result)voteUI.close()});_voted=true}});return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/cardpopup":244,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256,"../../whiteboard/whiteboard":176,"./mubchat":155,"./muvote":162}],158:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Place=olives["Place.plugin"],CardPopup=require("../../../../services/cardpopup"),Chat=require("./mubchat"),Whiteboard=require("../../whiteboard/whiteboard");module.exports=function MUScenarioConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,_currentPopup,chatUI=new Chat,_labels=Config.get("labels"),_user=Config.get("user"),_db=Config.get("db"),_char=new Store,_context=new Store,_problem=new Store,_cards=new Store({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),_initTools={cardpopup:{"char":false,context:false,problem:false},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showstory:false,shownext:false,readonly:false},_tools=new Store(_initTools),_timer=new Store({timer:null,display:false}),_mscTimer,_mscInterval,_scenario=new Store({title:"",story:"",solution:""}),_wbContent=new Store([]),_wb=new Whiteboard("scenario",_wbContent,_tools,"mu"),_start,_elapsed=0,_next="step",_transport=Config.get("transport"),spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();_widget.isLeader=function isLeader(){return $session.get("initiator")&&$session.get("initiator").id===_user.get("_id")};_widget.seam.addAll({labels:new Model(_labels,{setPlaceholder:function(value){this.setAttribute("placeholder",value)}}),cards:new Model(_cards,{formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),wbtools:new Model(_tools,{setActive:function(status){status==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(ready){if(_widget.isLeader()){ready?this.classList.remove("invisible"):this.classList.add("invisible")}else{this.classList.add("invisible")}},showStory:function(showstory){showstory?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(showstory){showstory?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(readonly){readonly?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),muscenariotimer:new Model(_timer,{setTime:function(timer){this.innerHTML=Utils.formatDuration(timer)},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new Model(_scenario),wbstack:_wb,place:new Place({chat:chatUI}),muscenarioevent:new Event(_widget)});_widget.template='<div id = "muscenario"><div class="previousbutton" data-muscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, muscenario" data-muscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-muscenarioevent="listen:mousedown,toggleTimer"></div><div id="muscenario-left"><div class="scenario-cards leftarea folded" data-muscenarioevent="listen:mousedown, fold"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div><div class="caret"></div></div><div id="muscenario-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard" data-muscenarioevent = "listen:mousedown, toggleView"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muscenarioevent="listen:mousedown, toggleCaret"></div></div><div id = "muscenario-writeup" class="writeup invisible" data-wbtools="bind: showStory,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionchat" data-place="place:chat"></div></div>';_widget.place(Map.get("muscenario"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.isLeader=function isLeader(){return $session.get("initiator")&&$session.get("initiator").id===_user.get("_id")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";_tools.set("readonly",true);clearInterval(_mscTimer);_timer.set("display",true);clearInterval(_mscInterval);$data.set("scenario",JSON.parse(_scenario.toJSON()));$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){var timers;chatUI.conclude("next");timers=$session.get("elapsedTimers");timers.muscenario=_timer.get("timer");$session.set("elapsedTimers",timers);$session.set("scenario",[$data.get("scenario")]);return $session.upload()}).then(function(){return _widget.updateSessionScore(_timer.get("timer"))}).then(function(){$next("muscenario")})}else{$next("muscenario")}};_widget.stopSpinner=function stopSpinner(){spinner.stop()};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("muscenario")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){if(_widget.isLeader()){_timer.set("display",!_timer.get("display"))}};_widget.push=function(event,node){var name=node.getAttribute("name");_tools.set(name,"active")};_widget.zoom=function(event,node){event.stopPropagation();var type=node.getAttribute("name");_widget.setPopup(type)};_widget.fold=function(event,node){if(!$session.get("scReady")){node.classList.toggle("folded");node.querySelector(".caret").classList.toggle("folding");if(_currentPopup){_popupUI.close()}}};_widget.setPopup=function setPopup(type){var pos={x:147,y:130},caret="left",card=_cards.get(type),popup=_tools.get("cardpopup"),details="",cdb;if(_currentPopup)popup[_currentPopup]=false;popup[type]=true;_tools.set("cardpopup",popup);_currentPopup=type;if(type==="char"){pos.y=120;if(card.id===_char.get("_id"))details=_char.toJSON()}if(type==="context"){pos.y=290;if(card.id===_context.get("_id"))details=_context.toJSON()}if(type==="problem"){pos.y=350;if(card.id===_problem.get("_id"))details=_problem.toJSON()}if(details){_popupUI.reset(details,pos,caret,document.getElementById("muscenario-popup"))}else{cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(_db,card.id).then(function(){details=cdb.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("muscenario-popup"));if(type==="char"){_char.reset(JSON.parse(cdb.toJSON()))}if(type==="context"){_context.reset(JSON.parse(cdb.toJSON()))}if(type==="problem"){_problem.reset(JSON.parse(cdb.toJSON()))}})}};_widget.closePopup=function closePopup(){var cardPopup=_tools.get("cardpopup");cardPopup[_currentPopup]=false;_tools.set("cardpopup",cardPopup);_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.getChatUI=function getChatUI(){return chatUI};_widget.post=function(event,node){_wb.selectScreen("postit");_tools.set("import","inactive");_tools.set("drawing","inactive")};_widget.importpic=function(event,node){_wb.selectScreen("import");_tools.set("postit","inactive");_tools.set("drawing","inactive")};_widget.draw=function(event,node){_wb.selectScreen("drawing");_tools.set("import","inactive");_tools.set("postit","inactive")};_widget.exitTool=function exitTool(name){_tools.set(name,"inactive")};_widget.finish=function(event,node){var finishSpinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();finishSpinner.spin(node.parentNode);node.classList.add("invisible");$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){$session.set("scReady",true);return $session.upload()}).then(function(){finishSpinner.stop();node.classList.remove("pressed");_tools.set("ready",false);_widget.displayStory();_widget.updateScenario()})};_widget.updateField=function updateField(event,node){if(node.classList.contains("enterTitle")){_scenario.set("title",node.value)}if(node.classList.contains("enterDesc")){_scenario.set("story",node.value)}if(node.classList.contains("enterSol")){_scenario.set("solution",node.value)}};_widget.displayStory=function displayStory(){_wb.setReadonly(true);_tools.set("showstory",true);_widget.dom.querySelector(".scenario-cards").classList.remove("folded");_widget.dom.querySelector(".scenario-cards .caret").classList.add("invisible");_widget.dom.querySelector(".writeup").scrollIntoView();_widget.dom.querySelector(".whiteboard .caret").classList.remove("invisible")};_widget.hideStory=function hideStory(){_widget.dom.querySelector(".scenario-cards").classList.add("folded");_widget.dom.querySelector(".scenario-cards .caret").classList.remove("invisible");_widget.dom.querySelector(".whiteboard .caret").classList.add("invisible")};_widget.toggleCaret=function(event,node){event.stopPropagation();var _writeup=_widget.dom.querySelector(".writeup"),_whiteboard=_widget.dom.querySelector(".whiteboard");node.classList.toggle("descending");node.classList.contains("descending")?_writeup.scrollIntoView():_whiteboard.scrollIntoView()};_widget.toggleView=function(event,node){var caret=node.querySelector(".caret"),_writeup=_widget.dom.querySelector(".writeup"),_whiteboard=_widget.dom.querySelector(".whiteboard");if(caret.classList.contains("descending")){caret.classList.remove("descending");_whiteboard.scrollIntoView()}else{if(event.pageY-node.scrollHeight>0){caret.classList.add("descending");_writeup.scrollIntoView()}}};_widget.updateScenario=function updateScenario(){_mscInterval=setInterval(function(){var _sSC=$session.get("scenario")[0]||{title:"",story:"",solution:""},_title=_sSC.title,_story=_sSC.story,_solution=_sSC.solution,cdbScen={};if(_scenario.get("title")!==_title||_scenario.get("story")!==_story||_scenario.get("solution")!==_solution){cdbScen.title=_scenario.get("title");cdbScen.story=_scenario.get("story");cdbScen.solution=_scenario.get("solution");$session.set("scenario",[cdbScen]);$session.upload().then(function(success){return true},function(err){console.log("failed to update scenario",err)})}},8e3)};_widget.updateSessionScore=function(timer){var promise=new Promise,json={sid:$session.get("_id"),step:"muscenario",time:timer,wbcontent:_wbContent.toJSON(),scenario:_scenario.toJSON()};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){promise.fulfill()})}else{promise.reject()}});return promise};_widget.reset=function reset(replay){chatUI.clear();if($session.get("chat")[2]){chatUI.reset($session.get("chat")[2])}_tools.reset({cardpopup:{"char":false,context:false,problem:false},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showstory:false,shownext:false,readonly:false});_wb.setSessionId($session.get("_id"));_wbContent.reset($session.get("scenarioWB"));_wb.init();_wbContent.count()?_wb.selectScreen("main"):_wb.selectScreen("default");if(replay||$session.get("scenario").length){_next="screen";chatUI.dom.querySelector(".chatread").classList.add("extended");_tools.set("ready",false);_widget.displayStory();_tools.set("readonly",true);_tools.set("shownext",false);_scenario.reset($session.get("scenario")[0]);$data.set("scenario",$session.get("scenario")[0])}else{_scenario.reset({title:"",story:"",solution:""});_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false);_wb.setReadonly(false);_widget.hideStory();_next="step"}if($session.get("elapsedTimers").muscenario){_elapsed=$session.get("elapsedTimers").muscenario;_timer.set("timer",_elapsed);if(_next==="screen"){_timer.set("display",true)}else if(_widget.isLeader()){_widget.initTimer(_elapsed)}}};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="muscenario"){clearInterval(_mscTimer);_mscTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};$data.watchValue("characters",function(value){_cards.set("char",value)});$data.watchValue("contexts",function(value){_cards.set("context",value)});$data.watchValue("problems",function(value){_cards.set("problem",value)});$session.watchValue("_id",function(sid){_wb.setSessionId(sid)});$session.watchValue("chat",function(arr){if(arr.length===3&&chatUI.getModel().get("_id")!==arr[2]){chatUI.reset(arr[2])}});["added","deleted","updated"].forEach(function(change){_wbContent.watch(change,function(val){if(!_tools.get("showstory")){if($session.get("scenarioWB").length!==_wbContent.count()||JSON.stringify($session.get("scenarioWB"))!==_wbContent.toJSON()){$session.set("scenarioWB",JSON.parse(_wbContent.toJSON()));$session.upload().then(function(response){return true},function(response){console.log("failure : ",response)})}_wbContent.count()&&_next==="step"?_tools.set("ready",true):_tools.set("ready",false)}})});$session.watchValue("scenarioWB",function(content){if($session.get("step")==="muscenario"&&!_tools.get("showstory")){if(content.length&&_wb.getStack().getCurrentName()==="default"){_wb.selectScreen("main")}if(!content.length){_wb.selectScreen("default")}if(content.length!==_wbContent.count()||JSON.stringify(content)!==_wbContent.toJSON()){_wbContent.reset(content)}}});$session.watchValue("scReady",function(ready){if($session.get("step")==="muscenario"&&ready&&!_widget.isLeader()){_tools.set("readonly",true);_widget.displayStory()}});$session.watchValue("scenario",function(arr){if(!_widget.isLeader()){_scenario.reset(arr[0]);$data.set("scenario",JSON.parse(_scenario.toJSON()))}});_scenario.watch("updated",function(){_widget.isLeader()&&_scenario.get("title")&&_scenario.get("story")&&_scenario.get("solution")?_tools.set("shownext",true):_tools.set("shownext",false)});return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/cardpopup":244,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256,"../../whiteboard/whiteboard":176,"./mubchat":155}],159:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../../services/config"),Promise=emily.Promise,Store=emily.Store,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Place=olives["Place.plugin"],CardPopup=require("../../../../services/cardpopup"),Chat=require("./mubchat"),Help=require("../../../../services/help");module.exports=function MUSetupConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,chatUI=new Chat,_labels=Config.get("labels"),_transport=Config.get("transport"),_db=Config.get("db"),_user=Config.get("user"),_deckStack={},_timer=new Store({timer:null,display:false}),_msTimer,_selection=new Store({"char":{selected:false,left:null,popup:false},context:{selected:false,left:null,popup:false},problem:{selected:false,left:null,popup:false}}),_cards=new Store({"char":{id:"",title:_labels.get("char"),pic:""},context:{id:"",title:_labels.get("context"),pic:""},problem:{id:"",title:_labels.get("problem"),pic:""}}),_drawnCards={"char":0,context:0,problem:0},_ready=true,_currentCards={"char":new Store,context:new Store,problem:new Store},_currentPopup="",_start=null,_elapsed=0,_next="step",spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:337,left:490}).spin(),spinnerOk={};_widget.seam.addAll({labels:new Model(_labels),musetup:new Model(_selection,{setReload:function(left){left===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(selected){_next==="step"&&_selection.get("char").selected&&_selection.get("context").selected&&_selection.get("problem").selected&&_user.get("_id")===$session.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(selected){selected?this.classList.add("pushed"):this.classList.remove("pushed")}}),musetuptimer:new Model(_timer,{setTime:function(timer){if(timer){this.innerHTML=Utils.formatDuration(timer)}},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),musetupcards:new Model(_cards,{removeDefault:function(pic){pic?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else this.innerHTML=title},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),place:new Place({chat:chatUI}),musetupevent:new Event(_widget)});_widget.template='<div id = "musetup"><div class="previousbutton" data-musetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="musetup-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, musetup" data-musetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-musetuptimer="bind:setTime, timer; bind: displayTimer, display" data-musetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-musetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, char.pic" data-musetup="bind: popup, char.popup"><div class="cardpicture" data-musetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, context.pic" data-musetup="bind: popup, context.popup"><div class="cardpicture" data-musetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, problem.pic" data-musetup="bind: popup, problem.popup"><div class="cardpicture" data-musetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-musetup="bind:setSelected, char.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="context" data-musetup="bind:setSelected, context.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="problem" data-musetup="bind:setSelected, problem.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-musetupevent="listen: mousedown, press; listen:mouseup, next" data-musetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>';_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";$data.set("characters",_cards.get("char"));$data.set("contexts",_cards.get("context"));$data.set("problems",_cards.get("problem"));clearInterval(_msTimer);_timer.set("display",true);_widget.updateSessionScore(_timer.get("timer")).then(function(){$session.unsync();return $session.sync(Config.get("db"),$session.get("_id"))}).then(function(){chatUI.conclude("next");$session.set("elapsedTimers",{musetup:_timer.get("timer")});$session.set("characters",[_cards.get("char").id]);$session.set("contexts",[_cards.get("context").id]);$session.set("problems",[_cards.get("problem").id]);$next("musetup")})}else{$next("musetup")}};_widget.stopSpinner=function stopSpinner(){spinner.stop()};_widget.help=function(event,node){Help.setContent("musetuphelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("musetup")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){if($session.get("initiator").id===_user.get("_id")){_timer.set("display",!_timer.get("display"))}};_widget.push=function(event,node){if(_next!=="screen"&&_user.get("_id")===$session.get("initiator").id)node.classList.add("pushed")};_widget.draw=function(event,node){var _type=node.getAttribute("name"),_sel=_selection.get(_type);_now=new Date;if(_user.get("_id")===$session.get("initiator").id&&_next==="step"&&_ready){_ready=false;if(_sel.left===0){_deckStack[_type]=$data.get("deck")[_type].concat();_sel.left=_deckStack[_type].length;_selection.set(_type,_sel)}if(_sel.selected){_ready=true;alert("please unlock selected card first")}else{if(_sel.selected===false){_widget.drawCard(_type).then(function(){var _popup=false;node.classList.remove("pushed");_ready=true;_selection.loop(function(v,i){if(v.popup===true){_popup=true}});if(_popup){_widget.setPopup(_type)}})}else{node.classList.remove("pushed");_ready=true}}}};_widget.pushOk=function(event,node){var spok=spinnerOk[node.getAttribute("name")]||null;if(_user.get("_id")===$session.get("initiator").id&&_next==="step"){if(!spok){spinnerOk[node.getAttribute("name")]=(new Spinner).spin(node)}else{spinnerOk[node.getAttribute("name")].spin(node)}}};_widget.accept=function(event,node){var _type=node.getAttribute("name"),_sel=_selection.get(_type);if(_next==="step"&&$session.get("initiator").id===_user.get("_id")){if(_cards.get(_type).id){_sel.selected=!_sel.selected}else{_sel.selected=false}$session.unsync();$session.sync(Config.get("db"),$session.get("_id")).then(function(){$session.set("selected_"+_type,_sel.selected);return $session.upload()}).then(function(){spinnerOk[node.getAttribute("name")].stop();selection.set(_type,_sel)})}};_widget.zoom=function(event,node){var type=node.getAttribute("name");_widget.setPopup(type)};_widget.setPopup=function setPopup(type){var pos={x:0,y:257},caret="left",old=_selection.get(_currentPopup)||"",sel=_selection.get(type);if(old){old.popup=false;_selection.set(_currentPopup,old)}sel.popup=true;_selection.set(type,sel);_currentPopup=type;if(type==="char")pos.x=382;if(type==="context"){pos.x=102;caret="right"}if(type==="problem"){pos.x=249;caret="right"}if(_currentCards[type].count()){_popupUI.reset(_currentCards[type].toJSON(),pos,caret,document.getElementById("musetup-popup"))}};_widget.closePopup=function closePopup(){var sel=_selection.get(_currentPopup);sel.popup=false;_selection.set(_currentPopup,sel);_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.getChatUI=function getChatUI(){return chatUI};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("timer",elapsed);if($session.get("step")==="musetup"){clearInterval(_msTimer);_msTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};_widget.reset=function reset(replay){chatUI.clear();if($session.get("chat")[1]){chatUI.reset($session.get("chat")[1])}if(replay){_next="screen";chatUI.dom.querySelector(".chatread").classList.add("extended");_elapsed=$session.get("elapsedTimers").musetup||0;_selection.reset({"char":{selected:true,left:1,popup:false},context:{selected:true,left:1,popup:false},problem:{selected:true,left:1,popup:false}});_currentPopup="";_timer.set("timer",_elapsed);_timer.set("display",true);if($session.get("characters").length){_widget.getDeck($session.get("deck")).then(function(){return _widget.getCard($session.get("characters")[0],_currentCards.char)}).then(function(){var c=_currentCards.char;_cards.set("char",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("characters",_cards.get("char"));return _widget.getCard($session.get("contexts")[0],_currentCards.context)}).then(function(){var c=_currentCards.context;_cards.set("context",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("contexts",_cards.get("context"));return _widget.getCard($session.get("problems")[0],_currentCards.problem)
}).then(function(){var c=_currentCards.problem;_cards.set("problem",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("problems",_cards.get("problem"))})}}else{_widget.init()}};_widget.getDeck=function getDeck(deckId){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(_db,deckId).then(function(){var result,deck={},lang=Config.get("user").get("lang");if(!cdb.get("default_lang")||cdb.get("default_lang")===lang){result=JSON.parse(cdb.toJSON())}else{cdb.get("translations")&&cdb.get("translations")[lang]?result=cdb.get("translations")[lang]:result=JSON.parse(cdb.toJSON())}deck.char=result.content.characters;deck.context=result.content.contexts;deck.problem=result.content.problems;deck.techno=result.content.techno;["char","context","problem","techno"].forEach(function(type){if(deck[type][0]==="newcard")deck[type].shift()});$data.set("deck",deck);promise.fulfill();cdb.unsync()});return promise};_widget.getCard=function getCard(id,store){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(_db,id).then(function(){store.reset(JSON.parse(cdb.toJSON()));promise.fulfill();cdb.unsync()});return promise};_widget.drawCard=function drawCard(type){var promise=new Promise,idx=Math.floor(Math.random()*_deckStack[type].length),id=_deckStack[type][idx];$session.set("drawn_"+type,id);$session.upload().then(function(){_drawnCards[type]++;_deckStack[type].splice(idx,1);promise.fulfill()});return promise};_widget.updateDrawnCard=function updateDrawnCard(type,id){var sel,card,promise=new Promise;if(type&&id){sel=_selection.get(type);card=_cards.get(type);_widget.getCard(id,_currentCards[type]).then(function(){var store=_currentCards[type];card.id=id;card.title=store.get("title");card.pic=store.get("picture_file");_cards.set(type,card);sel.left=_deckStack[type].length;_selection.set(type,sel);promise.fulfill()})}return promise};_widget.updateSessionScore=function updateSessionScore(time){var promise=new Promise,json={sid:$session.get("_id"),step:"musetup",time:time,cards:_drawnCards.char+_drawnCards.context+_drawnCards.problem};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.init=function init(){_cards.reset({"char":{id:"",title:_labels.get("char"),pic:""},context:{id:"",title:_labels.get("context"),pic:""},problem:{id:"",title:_labels.get("problem"),pic:""}});_selection.reset({"char":{selected:false,left:null,popup:false},context:{selected:false,left:null,popup:false},problem:{selected:false,left:null,popup:false}});_drawnCards.char=0;_drawnCards.context=0;_drawnCards.problem=0;_currentCards={"char":new Store,context:new Store,problem:new Store};_currentPopup="";if(_user.get("_id")===$session.get("initiator").id){_widget.getDeck($session.get("deck")).then(function(){var _deck=$data.get("deck");_deckStack.char=_deck.char.concat();_deckStack.context=_deck.context.concat();_deckStack.problem=_deck.problem.concat();_ready=true;_widget.initTimer()})}else{_timer.set("display",false)}_next="step"};$session.watchValue("drawn_char",function(val){val&&_widget.updateDrawnCard("char",val)});$session.watchValue("drawn_context",function(val){val&&_widget.updateDrawnCard("context",val)});$session.watchValue("drawn_problem",function(val){val&&_widget.updateDrawnCard("problem",val)});$session.watchValue("selected_char",function(val){var selChar;selChar=_selection.get("char");selChar.selected=val;_selection.set("char",selChar);if(val){$data.set("characters",_cards.get("char"))}});$session.watchValue("selected_context",function(val){var selCtx;selCtx=_selection.get("context");selCtx.selected=val;_selection.set("context",selCtx);if(val){$data.set("contexts",_cards.get("context"))}});$session.watchValue("selected_problem",function(val){var selPb;selPb=_selection.get("problem");selPb.selected=val;_selection.set("problem",selPb);if(val){$data.set("problems",_cards.get("problem"))}});$session.watchValue("elapsedTimers",function(value){if(value.musetup){_timer.set("timer",value.musetup);_timer.set("display",true)}});return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/cardpopup":244,"../../../../services/config":245,"../../../../services/help":248,"../../../../services/map":249,"../../../../services/utils":256,"./mubchat":155}],160:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),Widget=olives.OObject,Map=require("../../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Config=require("../../../../services/config"),Store=emily.Store,Spinner=require("../../../../libs/spin.min"),Avatar=require("../../../../services/avatar"),Chat=require("./mubchat"),Help=require("../../../../services/help");module.exports=function MUStartConstructor($session,$prev,$next,$progress){var _widget=new Widget,_user=Config.get("user"),_db=Config.get("db"),_labels=Config.get("labels"),_next="step",participants=new Store([]),chatUI=new Chat,spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545}).spin();_widget.seam.addAll({labels:new Model(_labels),model:new Model($session,{setAvatar:function setAvatar(id){var frag,ui;if(id){this.setAttribute("style","background:none;");frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "},setDescription:function(desc){this.innerHTML=desc.replace(/\n/g,"<br>")}}),participant:new Model(participants,{setAvatar:function setAvatar(id){var frag,ui;if(id){this.setAttribute("style","background:none;");frag=document.createDocumentFragment();ui=new Avatar([id]);ui.place(frag);!this.hasChildNodes()?this.appendChild(frag):this.replaceChild(frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "}}),place:new Place({chat:chatUI}),mustartevent:new Event(_widget)});_widget.template='<div id = "mustart"><div class="previousbutton" data-mustartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quickstart" data-mustartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-mustartevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:innerHTML, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants"></label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div></form><div class="sessionchat" data-place="place:chat"></div><div>';_widget.place(Map.get("mustart"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");$next("mustart")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quickstart")};_widget.toggleProgress=function(event,node){$progress()};_widget.reset=function reset(replay){_next="step";participants.reset($session.get("participants"));chatUI.reset($session.get("chat")[0]).then(function(){chatUI.setReadonly();if(replay){chatUI.dom.querySelector(".chatread").classList.add("extended")}})};_widget.help=function(event,node){Help.setContent("mustarthelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};$session.watchValue("participants",function(parts){participants.reset(parts)});return _widget}},{"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/help":248,"../../../../services/map":249,"./mubchat":155}],161:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Place=olives["Place.plugin"],Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Help=require("../../../../services/help"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,CardPopup=require("../../../../services/cardpopup"),Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min"),Chat=require("./mubchat");module.exports=function MUTechConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_start=null,_elapsed=null,_mtTimer,_timer=new Store({timer:null,display:false}),_transport=Config.get("transport"),_user=Config.get("user"),_db=Config.get("db"),_labels=Config.get("labels"),_popupUI,_currentPopup,chatUI=new Chat,_techDisplay=new Store({left:"",scenario:{popup:false},tech1:{popup:false,selected:false},tech2:{popup:false,selected:false},tech3:{popup:false,selected:false}}),_techs=[],_ready=true,_tech1=new Store,_tech2=new Store,_tech3=new Store,_draw={tech1:_tech1,tech2:_tech2,tech3:_tech3},_drawnCards=0,_techCards=new Store([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),_next="step",spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:336,left:481}).spin(),spinnerOk={};_widget.isLeader=function isLeader(){return $session.get("initiator")&&$session.get("initiator").id===_user.get("_id")};_widget.seam.addAll({labels:new Model(_labels),display:new Model(_techDisplay,{setReload:function(left){!left&&_drawnCards>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(selected){_widget.isLeader()&&_techDisplay.get("tech1").selected&&_techDisplay.get("tech2").selected&&_techDisplay.get("tech3").selected&&_next==="step"?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(selected){selected?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new Model(_techCards,{removeDefault:function(pic){pic?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(title){if(title){this.innerHTML=title.toUpperCase()}else this.innerHTML=_labels.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),mutechtimer:new Model(_timer,{setTime:function(timer){this.innerHTML=Utils.formatDuration(timer)},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),place:new Place({chat:chatUI}),mutechevent:new Event(_widget)});_widget.template='<div id = "mutech"><div class="previousbutton" data-mutechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="mutech-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, mutech" data-mutechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-mutechtimer="bind:setTime, timer; bind: displayTimer, display" data-mutechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-mutechevent="listen:mousedown, help"></div><div id="mutech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-mutechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-mutechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-mutechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>';_widget.place(Map.get("mutech"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){var _now=new Date,_elapsedTime=_now.getTime()-_start;spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";$data.set("techno",_techCards);clearInterval(_mtTimer);_timer.set("display",true);_widget.updateSessionScore(_timer.get("timer")).then(function(){$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){var timers=$session.get("elapsedTimers");chatUI.conclude("next");timers.mutech=_timer.get("timer");$session.set("elapsedTimers",timers);$session.set("techno",[[_techCards.get(0).id,_techCards.get(1).id,_techCards.get(2).id]]);$next("mutech")})})}else{$next("mutech")}};_widget.stopSpinner=function stopSpinner(){spinner.stop()};_widget.help=function(event,node){Help.setContent("mutechhelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("mutech")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){if(_widget.isLeader()){_timer.set("display",!_timer.get("display"))}};_widget.select=function(event,node){var name=node.getAttribute("name");if(name.search("tech")<0||_drawnCards>0||_next==="screen"){node.classList.add("highlighted")}};_widget.zoom=function(event,node){var type=node.getAttribute("name");if(type.search("tech")<0||_drawnCards>0||_next==="screen"){_widget.setPopup(type)}};_widget.setPopup=function setPopup(type){var pos={x:0,y:257},caret="left",old=_techDisplay.get(_currentPopup)||"",story=new Store,details,sel=_techDisplay.get(type);if(old){old.popup=false;_techDisplay.set(_currentPopup,old)}sel.popup=true;_techDisplay.set(type,sel);_currentPopup=type;if(type==="scenario"){pos.x=147;pos.y=275;story.reset($session.get("scenario")[0]);story.set("type",5);details=story.toJSON()}else{if(type==="tech1"){pos.x=467}if(type==="tech2"){pos.x=186;caret="right"}if(type==="tech3"){pos.x=333;caret="right"}if(_draw[type].get("_id"))details=_draw[type].toJSON()}if(details){_popupUI.reset(details,pos,caret,document.getElementById("mutech-popup"))}};_widget.closePopup=function closePopup(){var sel=_techDisplay.get(_currentPopup);sel.popup=false;_techDisplay.set(_currentPopup,sel);_currentPopup=""};_widget.push=function(event,node){var name=node.getAttribute("name");if(node.classList.contains("drawok")){if(_draw[name].get("_id")&&_next==="step"&&_widget.isLeader()){node.classList.add("pushed")}}else node.classList.add("pushed")};_widget.draw=function(event,node){var toDraw=[];if(_widget.isLeader()&&_next==="step"&&_ready){_ready=false;["tech1","tech2","tech3"].forEach(function(tech){if(!_techDisplay.get(tech).selected){toDraw.push(tech)}});_widget.drawTech(toDraw).then(function(){node.classList.remove("pushed");_ready=true})}else{node.classList.remove("pushed")}};_widget.drawTech=function drawTech(arr){var idx,accepted=[],promise=new Promise,drawStatus=new Store({count:arr.length});if(arr.length){arr.forEach(function(name){if(_techs.length<=0){_techs=$data.get("deck").techno.concat();["tech1","tech2","tech3"].forEach(function(tech,idx){if(_techDisplay.get(tech).selected){accepted.push(_techCards.get(idx).id)}});_techs.filter(function(value){return!(accepted.indexOf(value)>-1)})}idx=Math.floor(Math.random()*_techs.length);_widget.getCardDetails(_techs[idx],name).then(function(){var newCount=drawStatus.get("count");newCount--;drawStatus.set("count",newCount)});_drawnCards++;_techs.splice(idx,1);_techDisplay.set("left",_techs.length)});drawStatus.watchValue("count",function(val){if(!val){$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){["tech1","tech2","tech3"].forEach(function(v,i){$session.set("drawn"+v,_techCards.get(i).id)});return $session.upload()}).then(function(){promise.fulfill()})}})}else{promise.fulfill()}return promise};_widget.getCardDetails=function getCardDetails(id,name){var cdb=new CouchDBDocument,arr=["tech1","tech2","tech3"],idx=arr.indexOf(name),promise=new Promise;cdb.setTransport(_transport);cdb.sync(_db,id).then(function(){_draw[name].reset(JSON.parse(cdb.toJSON()));_techCards.update(idx,"id",id);_techCards.update(idx,"title",cdb.get("title"));_techCards.update(idx,"pic",cdb.get("picture_file"));promise.fulfill();cdb.unsync()});return promise};_widget.pushOk=function(event,node){var spok=spinnerOk[node.getAttribute("name")]||null;if(_widget.isLeader()&&_next==="step"){if(spok){spinnerOk[node.getAttribute("name")].spin(node)}else{spinnerOk[node.getAttribute("name")]=(new Spinner).spin(node)}}};_widget.accept=function(event,node){var name=node.getAttribute("name"),arr=["tech1","tech2","tech3"],idx=arr.indexOf(name),display=_techDisplay.get(name);if(_next==="step"&&_widget.isLeader()){if(_techCards.get(idx)&&_techCards.get(idx).id){display.selected=!display.selected}else{display.selected=false}$session.unsync();$session.sync(_db,$session.get("_id")).then(function(){$session.set("selected_"+name,display.selected);return $session.upload()}).then(function(){spinnerOk[node.getAttribute("name")].stop();_techDisplay.set(name,display)})}};_widget.reset=function reset(replay){var sessionTech=$session.get("techno")[0];chatUI.clear();if($session.get("chat")[3]){chatUI.reset($session.get("chat")[3])}_techDisplay.reset({left:"",scenario:{popup:false},tech1:{popup:false,selected:false},tech2:{popup:false,selected:false},tech3:{popup:false,selected:false}});if(replay||sessionTech.length){_next="screen";chatUI.dom.querySelector(".chatread").classList.add("extended");_widget.getCardDetails(sessionTech[0],"tech1").then(function(){return _widget.getCardDetails(sessionTech[1],"tech2")}).then(function(){return _widget.getCardDetails(sessionTech[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(value){_techDisplay.set(value,{popup:false,selected:true})});$data.set("techno",_techCards)})}else{_techs=[];_drawnCards=0;_next="step";_tech1.reset();_tech2.reset();_tech3.reset();_techCards.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])}if($session.get("elapsedTimers").mutech){_elapsed=$session.get("elapsedTimers").mutech;_timer.set("timer",_elapsed);if(_next==="screen"){_timer.set("display",true)}else if(_widget.isLeader()){_widget.initTimer(_elapsed)}}};_widget.updateSessionScore=function updateSessionScore(time){var promise=new Promise,json={sid:$session.get("_id"),step:"mutech",time:time,cards:_drawnCards};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="mutech"){clearInterval(_mtTimer);_mtTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};_popupUI=new CardPopup(_widget.closePopup);_widget.getChatUI=function getChatUI(){return chatUI};$session.watchValue("chat",function(arr){if(arr.length===4&&chatUI.getModel().get("_id")!==arr[3]){chatUI.reset(arr[3])}});$data.watchValue("deck",function(value){_techs=value.techno.concat();_techDisplay.set("left",_techs.length)});["tech1","tech2","tech3"].forEach(function(name){$session.watchValue("drawn"+name,function(techId){if(!_widget.isLeader()){_widget.getCardDetails(techId,name)}});$session.watchValue("selected_"+name,function(val){var sel;if(!_widget.isLeader()){sel=_techDisplay.get(name);sel.selected=val;_techDisplay.set(name,sel);if(val){$data.set("techno",_techCards)}}})});return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/cardpopup":244,"../../../../services/config":245,"../../../../services/help":248,"../../../../services/map":249,"../../../../services/utils":256,"./mubchat":155}],162:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),Widget=olives.OObject,Map=require("../../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Store=emily.Store,Spinner=require("../../../../libs/spin.min");module.exports=function MuVoteConstructor(){var _widget=new Widget,_labels=Config.get("labels"),_vote=new Store,_user=Config.get("user"),_session=null,_uploadInProgress=false,_onEnd;_widget.seam.addAll({label:new Model(_labels),model:new Model(_vote,{setVisible:function(bool){bool?this.classList.remove("invisible"):this.classList.add("invisible")},setButton:function(bool){bool?this.setAttribute("style","display: inline-block;"):this.setAttribute("style","display:none;")},displayVote:function(vote){var type=this.getAttribute("name"),votes=_vote.get(type+"Votes"),yes=this.querySelector(".yesvote"),no=this.querySelector(".novote");if(vote){votes.indexOf(_user.get("_id"))>-1?no.classList.add("invisible"):yes.classList.add("invisible")}else{yes.classList.remove("invisible");no.classList.remove("invisible")}},setResult:function(result){if(result){this.innerHTML=_labels.get(result)}else{this.innerHTML=""}}}),event:new Event(_widget)});_widget.template='<div class = "confirm invisible"><legend><span data-label="bind:innerHTML, decidemsg"></span><span class="unanimity" data-label="bind: innerHTML, unanimity"></span></legend><div class="votingitem invisible" name="public" data-model="bind:setVisible,public; bind: displayVote, publicVote"><div class="sessionquestion" data-label="bind:innerHTML,setpublic"></div><div class = "votingbuttons" name="public"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, publicResult"></div></div><div class="votingitem invisible" name = "replay" data-model="bind:setVisible,replay; bind: displayVote, replayVote"><div class="sessionquestion" data-label="bind:innerHTML,enablereplay"></div><div class = "votingbuttons" name="replay"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, replayResult"></div></div><div id="muvotespinner"></div><div class="option left votebutton" data-event="listen:mousedown, press; listen:mouseup, submit" data-model="bind:setButton, submit" data-label="bind: innerHTML, submitlbl">Submit</div><div class="option right votebutton" data-event="listen:mousedown, press; listen:mouseup, skip" data-model="bind:setButton, skip" data-label="bind:innerHTML, skiplbl">Skip</div></div>';_widget.press=function(event,node){event.stopPropagation();node.classList.add("pressed")};_widget.push=function(event,node){var p=node.parentNode,type=p.getAttribute("name");if(!_vote.get(type+"Vote")&&!_vote.get(type+"Result")){node.setAttribute("style","-webkit-box-shadow: 0px 0px 2px #657B99;")}};_widget.vote=function vote(event,node){var p=node.parentNode,type=p.getAttribute("name");node.setAttribute("style","-webkit-box-shadow: none;");if(_vote.get("leader")){node.classList.toggle("voted");if(node.classList.contains("yesvote")){if(node.classList.contains("voted")){_vote.set(type+"Votes",[_user.get("_id")]);p.querySelector(".novote").classList.remove("voted")}else{_vote.set(type+"Votes",[])}}else{p.querySelector(".yesvote").classList.remove("voted");_vote.set(type+"Votes",[])}if(!_vote.get("publicVotes").length&&!_vote.get("replayVotes").length){_vote.set("submit",false)}else{_vote.set("submit",true)}}else if(!_vote.get(type+"Vote")){var votes=_vote.get(type+"Votes");if(node.classList.contains("novote")){if(type==="public")_vote.set("publicResult","rejected");if(type==="replay")_vote.set("replayResult","rejected")}else{votes.push(_user.get("_id"));_vote.set(type+"Votes",votes);if(votes.length===_session.get("participants").length+1){if(type==="public")_vote.set("publicResult","accepted");if(type==="replay")_vote.set("replayResult","accepted")}}node.classList.add("voted");_vote.set(type+"Vote",true);if(!_uploadInProgress){_widget.uploadVote()}else{setTimeout(_widget.uploadVote,3e3)}}};_widget.uploadVote=function uploadVote(){var vote;if(!_vote.get("leader")){vote=_session.get("vote");_uploadInProgress=true;if(vote.public){vote.publicVotes=_vote.get("publicVotes");vote.publicResult=_vote.get("publicResult")}if(vote.replay){vote.replayVotes=_vote.get("replayVotes");vote.replayResult=_vote.get("replayResult")}_session.set("vote",vote);_session.upload().then(function(){_uploadInProgress=false},function(conflict){console.log(conflict)})}};_widget.submit=function(event,node){var vote={};node.classList.remove("pressed");_vote.set("skip",false);_vote.set("submit",false);["public","replay"].forEach(function(type){if(_vote.get(type+"Votes").length){vote[type]=true;vote[type+"Votes"]=[_user.get("_id")]}else{if(!_vote.get(type+"Vote")){_vote.set(type,false)}else{_vote.set(type+"Result","rejected")}}_vote.set(type+"Vote",true)});_session.set("vote",vote);_session.upload().then(function(){console.log("VOTE : leader upload successful")},function(err){console.log(err)})};_widget.skip=function(event,node){node&&node.classList.remove("pressed");_widget.close();_onEnd({visibility:"private",replay:false})};_widget.close=function hide(){document.getElementById("cache").classList.remove("votingcache");_widget.dom.classList.add("invisible");_session=null};_widget.isActive=function isActive(){return!(_session===null)};_widget.show=function show(){document.getElementById("cache").classList.add("votingcache");_widget.dom.classList.remove("invisible")};_widget.reset=function reset(session,callback){var _watcher;_session=session;_onEnd=callback;_vote.reset({});if(_session.get("vote")){_vote.reset(_session.get("vote"))}if(_session.get("initiator").id===_user.get("_id")){_vote.set("leader",true);_vote.set("submit",false);_vote.set("skip",true);["public","replay"].forEach(function(type){_vote.set(type,true);_vote.set(type+"Vote",false);_vote.set(type+"Votes",[]);_vote.set(type+"Result","")})}else{_vote.set("leader",false);_vote.set("submit",false);_vote.set("skip",false)}_vote.set("publicVote",false);_vote.set("replayVote",false);_widget.show();_watcher=_session.watchValue("vote",function(vote){var result={},spinner=new Spinner({lines:10,length:8,width:4,radius:8,top:10});exitVote=function(){_session.unwatch(_watcher);spinner.spin(_widget.dom.querySelector("#muvotespinner"));setTimeout(function(){spinner.stop();Map.get("cache").classList.remove("votingcache");_onEnd&&_onEnd(result)},2e3)};if(vote&&vote.public&&vote.replay){_vote.set("publicResult",vote.publicResult);_vote.set("replayResult",vote.replayResult);if(vote.publicResult&&vote.replayResult){vote.publicResult==="accepted"?result.visibility="public":result.visibility="private";vote.replayResult==="accepted"?result.replay=true:result.replay=false;exitVote()}}else if(vote&&vote.public){_vote.set("publicResult",vote.publicResult);result.replay=false;if(vote.publicResult){vote.publicResult==="accepted"?result.visibility="public":result.visibility="private";result.replay=false;exitVote()}}else if(vote&&vote.replay){_vote.set("replayResult",vote.replayResult);result.visibility="private";if(vote.replayResult){vote.replayResult==="accepted"?result.replay=true:result.replay=false;exitVote()}}})};return _widget}},{"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/config":245,"../../../../services/map":249}],163:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),Widget=olives.OObject,Map=require("../../../../services/map"),Place=olives["Place.plugin"],Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Store=emily.Store,Utils=require("../../../../services/utils"),Chat=require("./mubchat");module.exports=function MUWrapupConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_wrapup=new Store,_cards=new Store([]),_labels=Config.get("labels"),chatUI=new Chat,_flash;_widget.seam.addAll({labels:new Model(_labels),wrapup:new Model(_wrapup,{formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}},setScore:function(score){if(score)this.innerHTML=score+" ip"},setTime:function(duration){if(duration)this.innerHTML=Utils.formatDuration(duration)},alertMsg:function(newmsg){var node=this;if(newmsg&&_widget.dom.querySelector(".sessionchat").classList.contains("folded")){_flash=setInterval(function(){node.classList.toggle("flashing")
},300)}else{_flash&&clearInterval(_flash)}},setVisibility:function(visibility){visibility&&visibility==="public"?this.classList.add("publicwrapup"):this.classList.remove("publicwrapup")},setReplay:function(replay){replay?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new Model(_cards,{formatTitle:function(title){var id=this.getAttribute("data-cards_id");if(title){if(id<3){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else{this.innerHTML=title.toUpperCase();this.setAttribute("style","font-family:Helvetica;")}}},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),place:new Place({chat:chatUI}),muwrapupevent:new Event(_widget)});_widget.template='<div id = "muwrapup"><div class="previousbutton" data-muwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, muwrapup" data-muwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div><div class="wrapupvisibility" data-wrapup="bind:setVisibility, idea.visibility"></div><div class="wrapupreplay invisible" data-wrapup="bind:setReplay, idea.sessionReplay"></div></div><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessioncards" data-muwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div><div class="togglechat" data-wrapup="bind:alertMsg, newmsg" data-muwrapupevent="listen: mousedown, toggleChat"></div><div class="sessionchat folded" data-place="place:chat"></div></div>';_widget.place(Map.get("muwrapup"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){node.classList.remove("pressed");$next("muwrapup")};_widget.exit=function exit(){$progress(true)};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("muwrapup")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleCards=function(event,node){node.classList.contains("expanded")?node.classList.remove("expanded"):node.classList.add("expanded")};_widget.toggleChat=function toggleChat(event,node){_wrapup.set("newmsg",false);_widget.dom.querySelector(".sessionchat").classList.toggle("folded")};_widget.getChatUI=function getChatUI(){return chatUI};_widget.reset=function reset(replay){_cards.reset([]);_wrapup.reset();chatUI.clear();if($session.get("chat")[5]){chatUI.reset($session.get("chat")[5]).then(function(){if(replay){chatUI.dom.querySelector(".chatread").classList.add("replayed");_wrapup.set("newmsg",false);_flash&&clearInterval(_flash)}else{chatUI.getModel().watchValue("msg",function(arr){if(arr.length>1){_wrapup.set("newmsg",true);setTimeout(function(){clearInterval(_flash)},2500)}})}})}_wrapup.set("scenario",$data.get("scenario"));_wrapup.set("idea",$data.get("idea"));_wrapup.set("score",$session.get("score"));_wrapup.set("duration",$session.get("duration"));_cards.reset([]);if(!replay){_cards.reset([$data.get("characters"),$data.get("contexts"),$data.get("problems"),$data.get("techno").get(0),$data.get("techno").get(1),$data.get("techno").get(2)])}else{["characters","contexts","problems","techno"].forEach(function(topic){$data.watchValue(topic,function(value){switch(topic){case"characters":_cards.set(0,value);break;case"contexts":_cards.set(1,value);break;case"problems":_cards.set(2,value);break;case"techno":value.loop(function(v,i){_cards.set(i+3,v)});break}})})}};$data.watchValue("scenario",function(value){_wrapup.set("scenario",value)});$data.watchValue("idea",function(value){_wrapup.set("idea",value)});$session.watchValue("score",function(score){_wrapup.set("score",score)});$session.watchValue("duration",function(val){_wrapup.set("duration",val)});$session.watchValue("chat",function(arr){if(arr.length===6&&chatUI.getModel().get("_id")!==arr[5]){chatUI.reset(arr[5]);if(!chatUI.getModel().get("readonly")){chatUI.getModel().watchValue("msg",function(arr){if(arr.length>1){_wrapup.set("newmsg",true)}})}}});return _widget}},{"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256,"./mubchat":155}],164:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Stack=amy.StackPlugin,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Promise=emily.Promise,Spinner=require("../../../libs/spin.min"),CouchDBDocument=CouchDBTools.CouchDBDocument,CouchDBView=CouchDBTools.CouchDBView,QuickStart=require("./quickstart"),QuickSetup=require("./quicksetup"),QuickScenario=require("./quickscenario"),QuickTech=require("./quicktech"),QuickIdea=require("./quickidea"),QuickWrapup=require("./quickwrapup");module.exports=function QuickBConstructor($sip,$exit){var _widget=new Widget,_progress=new Widget,_frag=document.createDocumentFragment(),_stack=new Stack,_labels=Config.get("labels"),_steps=new Store([{name:"quickstart",label:_labels.get("quickstepstart"),currentStep:true,status:"ongoing"},{name:"quicksetup",label:_labels.get("quickstepsetup"),currentStep:false,status:null},{name:"quickscenario",label:_labels.get("quickstepscenario"),currentStep:false,status:null},{name:"quicktech",label:_labels.get("quicksteptech"),currentStep:false,status:null},{name:"quickidea",label:_labels.get("quickstepidea"),currentStep:false,status:null},{name:"quickwrapup",label:_labels.get("quickstepwrapup"),currentStep:false,status:null}]),_user=Config.get("user"),_session=new CouchDBDocument,_sessionData=new Store,spinner=new Spinner({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin();_widget.seam.add("quickstack",_stack);_widget.template='<div id="ideafy-quick"><div class="stack" data-quickstack="destination"></div></div>';_widget.place(Map.get("ideafy-quick"));_progress.seam.addAll({labels:new Model(_labels),step:new Model(_steps,{setCurrent:function(currentStep){currentStep?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(status){status?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new Event(_progress)});_progress.template='<div class = "progressbar invisible"><ul id = "quicksteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, highlightStep; listen:mouseup, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>';_progress.place(_widget.dom);_progress.highlightStep=function(event,node){node.classList.toggle("inactive")};_progress.changeStep=function(event,node){var _id=node.getAttribute("data-step_id");if(_steps.get(_id).status){_steps.loop(function(v,i){_id==i?_steps.update(i,"currentStep",true):_steps.update(i,"currentStep",false)});_stack.getStack().show(_steps.get(_id).name)}else{event.stopImmediatePropagation()}_progress.dom.classList.add("invisible")};_progress.press=function(event,node){node.classList.add("pressed")};_progress.exit=function(event,node){node.classList.remove("pressed");_progress.dom.classList.add("invisible");$exit()};_widget.retrieveSession=function retrieveSession(sip){spinner.spin(document.getElementById("brainstorm"));_sessionData.reset();_session.unsync();_session.reset();_widget.sessionExists(sip.id).then(function(){return _session.sync(Config.get("db"),sip.id)}).then(function(){var step=_session.get("step"),current=1e4,length=_steps.count();_stack.getStack().get("quickstart").reset(sip);_stack.getStack().get("quicksetup").reset(sip);_stack.getStack().get("quickscenario").reset(sip);_stack.getStack().get("quicktech").reset(sip);_stack.getStack().get("quickidea").reset(sip);_stack.getStack().get("quickwrapup").reset(sip);_steps.loop(function(v,i){if(i<current){if(v.name===step){current=i;_steps.update(i,"currentStep",true);v.name==="quickwrapup"?_steps.update(i,"status","done"):_steps.update(i,"status","ongoing")}else _steps.update(i,"status","done")}});if(step==="quickwrapup"){spinner.stop();_stack.getStack().show("quickwrapup");_steps.update(0,"currentStep",false)}else{_steps.update(0,"currentStep",true);_steps.update(current,"currentStep",false);spinner.stop();_stack.getStack().show("quickstart");if(_session.get("status")!=="completed"){_user.set("sessionInProgress",sip);_user.upload()}}},function(err){spinner.stop();alert("session could not be retrieved")})};_widget.startNewSession=function startNewSession(){_session.unsync();_session.reset(Config.get("sessionTemplate"));_sessionData.reset({});_session.set("initiator",{id:_user.get("_id"),username:_user.get("username"),picture_file:_user.get("picture_file")});_session.set("mode","quick");_session.set("step","quickstart");_session.set("deck",_user.get("active_deck"));_session.set("lang",_user.get("lang"));_stack.getStack().get("quickstart").reset();_stack.getStack().get("quicksetup").reset();_stack.getStack().get("quickscenario").reset();_stack.getStack().get("quicktech").reset();_stack.getStack().get("quickidea").reset();_stack.getStack().get("quickwrapup").reset();_stack.getStack().show("quickstart")};_widget.sessionExists=function sessionExists(sid){var promise=new Promise,cdb=new CouchDBView;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),"library","_view/sessioncount",{key:'"'+sid+'"'}).then(function(){if(cdb.count()){promise.fulfill()}else{promise.reject("not found")}});return promise};_widget.reset=function reset(sip){_steps.reset([{name:"quickstart",label:_labels.get("quickstepstart"),currentStep:true,status:"ongoing"},{name:"quicksetup",label:_labels.get("quickstepsetup"),currentStep:false,status:null},{name:"quickscenario",label:_labels.get("quickstepscenario"),currentStep:false,status:null},{name:"quicktech",label:_labels.get("quicksteptech"),currentStep:false,status:null},{name:"quickidea",label:_labels.get("quickstepidea"),currentStep:false,status:null},{name:"quickwrapup",label:_labels.get("quickstepwrapup"),currentStep:false,status:null}]);sip?_widget.retrieveSession(sip):_widget.startNewSession()};_widget.prev=function prev(currentName){var _id;_steps.loop(function(value,idx){if(value.name===currentName){_id=idx}});if(_id>0){_steps.update(_id,"currentStep",false);_steps.update(_id-1,"currentStep",true);_stack.getStack().show(_steps.get(_id-1).name)}else{alert("Exiting session");$exit()}};_widget.next=function next(currentName){var _id,_nextui,_currentui=_stack.getStack().get(currentName),promise=new Promise;_steps.loop(function(value,idx){if(value.name===currentName){_id=idx}});if(_id<_steps.count()-1){_steps.update(_id,"currentStep",false);_steps.update(_id+1,"currentStep",true);if(_steps.get(_id).status!=="done"){_steps.update(_id,"status","done");_steps.update(_id+1,"status","ongoing");_session.set("step",_steps.get(_id+1).name);_session.upload().then(function(){_nextui=_stack.getStack().get(_steps.get(_id+1).name);if(_nextui.initTimer){_nextui.initTimer()}_currentui.stopSpinner();_stack.getStack().show(_steps.get(_id+1).name);promise.fulfill()})}else{_currentui.stopSpinner();_stack.getStack().show(_steps.get(_id+1).name);promise.fulfill()}}return promise};_widget.toggleProgress=function toggleProgress(){_progress.dom.classList.toggle("invisible")};_widget.init=function init(sip){_session.setTransport(Config.get("transport"));_stack.getStack().add("quickstart",new QuickStart(_session,_widget.prev,_widget.next,_widget.toggleProgress));_stack.getStack().add("quicksetup",new QuickSetup(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress));_stack.getStack().add("quickscenario",new QuickScenario(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress));_stack.getStack().add("quicktech",new QuickTech(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress));_stack.getStack().add("quickidea",new QuickIdea(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress));_stack.getStack().add("quickwrapup",new QuickWrapup(_session,_sessionData,_widget.prev,_widget.next,_widget.toggleProgress));_widget.reset(sip)};_widget.init($sip);Config.get("observer").watch("reconnect",function(){if(_session.get("_id")){_session.unsync();_session.sync(Config.get("db"),_session.get("_id"))}});return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/map":249,"./quickidea":165,"./quickscenario":166,"./quicksetup":167,"./quickstart":168,"./quicktech":169,"./quickwrapup":170}],165:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CardPopup=require("../../../services/cardpopup"),Whiteboard=require("../whiteboard/whiteboard"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,Utils=require("../../../services/utils"),Spinner=require("../../../libs/spin.min");module.exports=function QuickIdeaConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,_currentPopup,_next="step",_start,_elapsed=0,_qiTimer,_timer=new Store({timer:null,display:false}),_idea=new Store({title:"",description:"",solution:"",visibility:"private"}),_scenario=new Store,_techs=new Store([]),_techDetails=[],_initTools={cardpopup:{scenario:false,techs:[false,false,false]},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showidea:false,shownext:false,readonly:false},_tools=new Store(_initTools),_wbContent=new Store([]),_wb=new Whiteboard("idea",_wbContent,_tools),_transport=Config.get("transport"),_labels=Config.get("labels"),_user=Config.get("user"),spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690}).spin();_widget.seam.addAll({labels:new Model(_labels,{setPlaceholder:function(value){this.setAttribute("placeholder",value)}}),scenario:new Model(_scenario),techs:new Model(_techs,{setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),wbtools:new Model(_tools,{setActive:function(status){status==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(ready){ready?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(showstory){showstory?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(readonly){readonly?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(pop){var idx;if(this.getAttribute("name")==="scenario"){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}else{idx=this.getAttribute("data-techs_id");pop[idx]?this.classList.add("highlighted"):this.classList.remove("highlighted")}}}),quickideatimer:new Model(_timer,{setTime:function(timer){if(timer){this.innerHTML=Utils.formatDuration(timer)}},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new Model(_idea,{setVisibility:function(visibility){if(visibility==="public"){this.value=0;this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")}else{this.value=1;this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;")}}}),wbstack:_wb,quickideaevent:new Event(_widget)});_widget.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:mousedown,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:mouseup, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>';_widget.place(Map.get("quickidea"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){var now=new Date,_timers,duration;spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";clearInterval(_qiTimer);_timer.set("display",true);duration=_widget.getSessionDuration();$data.set("idea",JSON.parse(_idea.toJSON()));_widget.createIdeaDoc().then(function(){return _widget.updateSessionScore(_timer.get("timer"))}).then(function(){$session.unsync();return $session.sync(Config.get("db"),$session.get("_id"))}).then(function(){var timers=$session.get("elapsedTimers");timers.quickidea=_timer.get("timer");$session.set("idea",[JSON.parse(_idea.toJSON())]);$session.set("elapsedTimers",timers);$session.set("duration",duration);$session.set("status","completed");_tools.set("readonly",true);return $next("quickidea")}).then(function(){_user.set("sessionInProgress",{});user.upload()})}else{$next("quickidea")}};_widget.stopSpinner=function stopSpinner(){spinner.stop();_widget.dom.querySelector(".next-button").classList.remove("invisible")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quickidea")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){_timer.set("display",!_timer.get("display"))};_widget.toggleVisibility=function(event,node){if(_next==="step"){_idea.get("visibility")==="public"?_idea.set("visibility","private"):_idea.set("visibility","public")}};_widget.push=function(event,node){var name=node.getAttribute("name");_tools.set(name,"active")};_widget.select=function(event,node){node.classList.add("higlighted")};_widget.zoom=function(event,node){var type,id;if(node.getAttribute("name")==="scenario")type="scenario";else{type="techno";id=node.getAttribute("data-techs_id")}_widget.setPopup(type,id)};_widget.setPopup=function setPopup(type,id){var pos={x:147,y:30},caret="left",popup=_tools.get("cardpopup"),story=new Store,details="",temp,cdb;if(_currentPopup){_currentPopup.type==="scenario"?popup.scenario=false:popup.techs[_currentPopup.id]=false;_tools.set("cardpopup",popup)}type==="scenario"?popup.scenario=true:popup.techs[id]=true;_tools.set("cardpopup",popup);_currentPopup={type:type,id:id};if(type==="scenario"){pos.y=55;story.reset($data.get("scenario"));story.set("type",5);details=story.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("quickidea-popup"))}else{if(id==0)pos.y=200;if(id==1)pos.y=260;if(id==2)pos.y=350;if(_techDetails[id]){details=_techDetails[id];_popupUI.reset(details,pos,caret,document.getElementById("quickidea-popup"))}else{cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),$data.get("techno").get(id).id).then(function(){details=cdb.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("quickidea-popup"));_techDetails[id]=details})}}};_widget.closePopup=function closePopup(){var cardPopup=_tools.get("cardpopup");cardPopup[_currentPopup]=false;_tools.set("cardpopup",cardPopup);_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.post=function(event,node){_wb.selectScreen("postit");_tools.set("import","inactive");_tools.set("drawing","inactive")};_widget.importpic=function(event,node){_wb.selectScreen("import");_tools.set("postit","inactive");_tools.set("drawing","inactive")};_widget.draw=function(event,node){_wb.selectScreen("drawing");_tools.set("import","inactive");_tools.set("postit","inactive")};_widget.exitTool=function exitTool(name){_tools.set(name,"inactive")};_widget.finish=function(event,node){_wb.setReadonly(true);_tools.set("ready",false);_tools.set("showidea",true);node.classList.remove("pressed")};_widget.updateSessionScore=function(timer){var promise=new Promise,json={sid:$session.get("_id"),step:"quickidea",time:timer,wbcontent:_wbContent.toJSON(),idea:_idea.toJSON()};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.getSessionDuration=function getSessionDuration(){var elapsed=$session.get("elapsedTime"),start=$session.get("resumeTime")||$session.get("startTime");now=new Date;return now.getTime()-start+elapsed};_widget.createIdeaDoc=function createIdeaDoc(){var cdb=new CouchDBDocument(Config.get("ideaTemplate")),now=new Date,_id="I:"+now.getTime(),promise=new Promise;cdb.setTransport(_transport);cdb.set("title",_idea.get("title"));cdb.set("sessionId",$session.get("_id"));cdb.set("authors",[$session.get("initiator").id]);cdb.set("description",_idea.get("description"));cdb.set("solution",_idea.get("solution"));cdb.set("creation_date",[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()]);cdb.set("character",$session.get("characters")[0]);cdb.set("problem",$session.get("problems")[0]);cdb.set("context",$session.get("contexts")[0]);cdb.set("techno",$session.get("techno")[0]);cdb.set("visibility",_idea.get("visibility"));cdb.set("authornames",$session.get("initiator").username);cdb.set("lang",$session.get("lang").substring(0,2));cdb.set("_id",_id);cdb.sync(Config.get("db"),_id).then(function(){return cdb.upload()}).then(function(){if(cdb.get("visibility")==="public"){_transport.request("UpdateUIP",{userid:_user.get("_id"),type:cdb.get("type"),docId:cdb.get("_id"),docTitle:cdb.get("title")},function(result){if(result!=="ok"){console.log(result)}})}promise.fulfill();cdb.unsync()});return promise};_widget.reset=function reset(sip){_tools.reset({cardpopup:{scenario:false,techs:[false,false,false]},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showidea:false,shownext:false,readonly:false});_techs.reset();_wb.setSessionId($session.get("_id"));_wbContent.reset($session.get("ideaWB"));_wb.init();_wbContent.count()?_wb.selectScreen("main"):_wb.selectScreen("default");clearInterval(_qiTimer);if($session.get("idea").length){_wb.setReadonly(true);_tools.set("ready",false);_tools.set("showidea",true);_idea.reset($session.get("idea")[0]);$data.set("idea",$session.get("idea")[0]);_tools.set("readonly",true);_tools.set("shownext",true);_next="screen"}else{_idea.reset({title:"",description:"",solution:"",visibility:"private"});_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false);_wb.setReadonly(false);_next="step"}if($session.get("elapsedTimers").quickidea){_elapsed=$session.get("elapsedTimers").quickidea;_timer.set("timer",_elapsed)}_next==="screen"?_timer.set("display",true):_widget.initTimer(_elapsed)};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="quickidea"){clearInterval(_qiTimer);_qiTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};$session.watchValue("_id",function(sid){_wb.setSessionId(sid)});$data.watchValue("scenario",function(store){_scenario.reset($data.get("scenario"))});$data.watchValue("techno",function(store){_techs.reset(JSON.parse($data.get("techno").toJSON()))});["added","deleted","updated"].forEach(function(change){_wbContent.watch(change,function(){if(JSON.stringify($session.get("ideaWB"))!==_wbContent.toJSON()){$session.set("ideaWB",JSON.parse(_wbContent.toJSON()));$session.upload()}_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false)})});_idea.watch("updated",function(){_idea.get("title")&&_idea.get("description")&&_idea.get("solution")?_tools.set("shownext",true):_tools.set("shownext",false)});return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/cardpopup":244,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256,"../whiteboard/whiteboard":176}],166:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CardPopup=require("../../../services/cardpopup"),Whiteboard=require("../whiteboard/whiteboard"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,Utils=require("../../../services/utils"),Spinner=require("../../../libs/spin.min");module.exports=function QuickScenarioConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,_currentPopup,_labels=Config.get("labels"),_char=new Store,_context=new Store,_problem=new Store,_cards=new Store({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),_initTools={cardpopup:{"char":false,context:false,problem:false},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showstory:false,shownext:false,readonly:false},_tools=new Store(_initTools),_timer=new Store({timer:null,display:false}),_qsTimer,_scenario=new Store({title:"",story:"",solution:""}),_wbContent=new Store([]),_wb=new Whiteboard("scenario",_wbContent,_tools),_start,_elapsed=0,_next="step",_transport=Config.get("transport"),spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690}).spin();_widget.seam.addAll({labels:new Model(_labels,{setPlaceholder:function(value){this.setAttribute("placeholder",value)}}),cards:new Model(_cards,{formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")
})}}else{this.setAttribute("style","background-image: none;")}}}),wbtools:new Model(_tools,{setActive:function(status){status==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(ready){ready?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(showstory){showstory?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(readonly){readonly?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new Model(_timer,{setTime:function(timer){if(timer){this.innerHTML=Utils.formatDuration(timer)}},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new Model(_scenario),wbstack:_wb,quickscenarioevent:new Event(_widget)});_widget.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:mousedown,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>';_widget.place(Map.get("quickscenario"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";clearInterval(_qsTimer);_timer.set("display",true);$data.set("scenario",JSON.parse(_scenario.toJSON()));_widget.updateSessionScore(_timer.get("timer")).then(function(){$session.unsync();return $session.sync(Config.get("db"),$session.get("_id"))}).then(function(){var timers=$session.get("elapsedTimers");timers.quickscenario=_timer.get("timer");$session.set("scenario",[JSON.parse(_scenario.toJSON())]);$session.set("elapsedTimers",timers);_tools.set("readonly",true);$next("quickscenario")})}else $next("quickscenario")};_widget.stopSpinner=function stopSpinner(){spinner.stop();_widget.dom.querySelector(".next-button").classList.remove("invisible")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quickscenario")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){_timer.set("display",!_timer.get("display"))};_widget.push=function(event,node){var name=node.getAttribute("name");_tools.set(name,"active")};_widget.zoom=function(event,node){var type=node.getAttribute("name");_widget.setPopup(type)};_widget.setPopup=function setPopup(type){var pos={x:147,y:130},caret="left",card=_cards.get(type),popup=_tools.get("cardpopup"),details="",cdb;if(_currentPopup)popup[_currentPopup]=false;popup[type]=true;_tools.set("cardpopup",popup);_currentPopup=type;if(type==="char"){pos.y=120;if(card.id===_char.get("_id"))details=_char.toJSON()}if(type==="context"){pos.y=290;if(card.id===_context.get("_id"))details=_context.toJSON()}if(type==="problem"){pos.y=350;if(card.id===_problem.get("_id"))details=_problem.toJSON()}if(details){_popupUI.reset(details,pos,caret,document.getElementById("quickscenario-popup"))}else{cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),card.id).then(function(){details=cdb.toJSON();_popupUI.reset(details,pos,caret,document.getElementById("quickscenario-popup"));if(type==="char"){_char.reset(JSON.parse(cdb.toJSON()))}if(type==="context"){_context.reset(JSON.parse(cdb.toJSON()))}if(type==="problem"){_problem.reset(JSON.parse(cdb.toJSON()))}})}};_widget.closePopup=function closePopup(){var cardPopup=_tools.get("cardpopup");cardPopup[_currentPopup]=false;_tools.set("cardpopup",cardPopup);_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.post=function(event,node){_wb.selectScreen("postit");_tools.set("import","inactive");_tools.set("drawing","inactive")};_widget.importpic=function(event,node){_wb.selectScreen("import");_tools.set("postit","inactive");_tools.set("drawing","inactive")};_widget.draw=function(event,node){_wb.selectScreen("drawing");_tools.set("import","inactive");_tools.set("postit","inactive")};_widget.exitTool=function exitTool(name){_tools.set(name,"inactive")};_widget.finish=function(event,node){_wb.setReadonly(true);_tools.set("ready",false);_tools.set("showstory",true);node.classList.remove("pressed")};_widget.updateSessionScore=function(timer){var promise=new Promise,json={sid:$session.get("_id"),step:"quickscenario",time:timer,wbcontent:_wbContent.toJSON(),scenario:_scenario.toJSON()};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.reset=function reset(sip){_tools.reset({cardpopup:{"char":false,context:false,problem:false},postit:"inactive","import":"inactive",drawing:"inactive",ready:false,showstory:false,shownext:false,readonly:false});_wb.setSessionId($session.get("_id"));_wbContent.reset($session.get("scenarioWB"));_wb.init();_wbContent.count()?_wb.selectScreen("main"):_wb.selectScreen("default");if($session.get("scenario").length){_next="screen";_tools.set("ready",false);_tools.set("showstory",true);_wb.setReadonly(true);_scenario.reset($session.get("scenario")[0]);$data.set("scenario",$session.get("scenario")[0]);_tools.set("readonly",true);_tools.set("shownext",true)}else{_scenario.reset({title:"",story:"",solution:""});_wbContent.count()?_tools.set("ready",true):_tools.set("ready",false);_wb.setReadonly(false);_next="step"}if($session.get("elapsedTimers").quickscenario){_elapsed=$session.get("elapsedTimers").quickscenario;_timer.set("timer",_elapsed)}_next==="screen"?_timer.set("display",true):_widget.initTimer(_elapsed)};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="quickscenario"){clearInterval(_qsTimer);_qsTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};$data.watchValue("characters",function(value){_cards.set("char",value)});$data.watchValue("contexts",function(value){_cards.set("context",value)});$data.watchValue("problems",function(value){_cards.set("problem",value)});$session.watchValue("_id",function(sid){_wb.setSessionId(sid)});["added","deleted","updated"].forEach(function(change){_wbContent.watch(change,function(){if(JSON.stringify($session.get("scenarioWB"))!==_wbContent.toJSON()){$session.set("scenarioWB",JSON.parse(_wbContent.toJSON()));$session.upload()}_wbContent.count()&&_next==="step"?_tools.set("ready",true):_tools.set("ready",false)})});_scenario.watch("updated",function(){_scenario.get("title")&&_scenario.get("story")&&_scenario.get("solution")?_tools.set("shownext",true):_tools.set("shownext",false)});return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/cardpopup":244,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256,"../whiteboard/whiteboard":176}],167:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CardPopup=require("../../../services/cardpopup"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,Utils=require("../../../services/utils"),Help=require("../../../services/help"),Spinner=require("../../../libs/spin.min");module.exports=function QuickSetupConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_popupUI,_dom=Map.get("quicksetup"),_labels=Config.get("labels"),_transport=Config.get("transport"),_db=Config.get("db"),_user=Config.get("user"),_deckStack={},_timer=new Store({timer:null,display:false}),_qsTimer,_selection=new Store({"char":{selected:false,left:null,popup:false},context:{selected:false,left:null,popup:false},problem:{selected:false,left:null,popup:false}}),_cards=new Store({"char":{id:"",title:_labels.get("char"),pic:""},context:{id:"",title:_labels.get("context"),pic:""},problem:{id:"",title:_labels.get("problem"),pic:""}}),_drawnCards={"char":0,context:0,problem:0},_ready=true,_currentCards={"char":new Store,context:new Store,problem:new Store},_currentPopup="",_start=null,_elapsed=0,_next="step",spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373}).spin();_widget.seam.addAll({labels:new Model(_labels),quicksetup:new Model(_selection,{setReload:function(left){left===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(selected){_selection.get("char").selected&&_selection.get("context").selected&&_selection.get("problem").selected?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(selected){selected?this.classList.add("pushed"):this.classList.remove("pushed")}}),quicksetuptimer:new Model(_timer,{setTime:function(timer){this.innerHTML=Utils.formatDuration(timer)},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicksetupcards:new Model(_cards,{removeDefault:function(pic){pic?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else this.innerHTML=title},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),quicksetupevent:new Event(_widget)});_widget.template='<div id = "quicksetup"><div class="previousbutton" data-quicksetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicksetup-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quicksetup" data-quicksetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicksetuptimer="bind:setTime, timer; bind: displayTimer, display" data-quicksetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicksetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, char.pic" data-quicksetup="bind: popup, char.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, context.pic" data-quicksetup="bind: popup, context.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, problem.pic" data-quicksetup="bind: popup, problem.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-quicksetup="bind:setSelected, char.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="context" data-quicksetup="bind:setSelected, context.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="problem" data-quicksetup="bind:setSelected, problem.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-quicksetupevent="listen: mousedown, press; listen:mouseup, next" data-quicksetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div></div>';_widget.place(_dom);_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";$data.set("characters",_cards.get("char"));$data.set("contexts",_cards.get("context"));$data.set("problems",_cards.get("problem"));clearInterval(_qsTimer);_timer.set("display",true);_widget.updateSessionScore(_timer.get("timer")).then(function(){$session.unsync();return $session.sync(Config.get("db"),$session.get("_id"))}).then(function(){$session.set("elapsedTimers",{quicksetup:_timer.get("timer")});$session.set("characters",[_cards.get("char").id]);$session.set("contexts",[_cards.get("context").id]);$session.set("problems",[_cards.get("problem").id]);$next("quicksetup")})}else{$next("quicksetup")}};_widget.stopSpinner=function stopSpinner(){spinner.stop();_widget.dom.querySelector(".next-button").classList.remove("invisible")};_widget.help=function(event,node){Help.setContent("quicksetuphelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quicksetup")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){_timer.set("display",!_timer.get("display"))};_widget.push=function(event,node){if(_next!=="screen")node.classList.add("pushed")};_widget.draw=function(event,node){var _type=node.getAttribute("name"),_sel=_selection.get(_type);_now=new Date;if(_next==="step"&&_ready){if(_sel.left===0){_deckStack[_type]=$data.get("deck")[_type].concat();_sel.left=_deckStack[_type].length;_selection.set(_type,_sel)}if(_sel.selected){alert("please unlock selected card first")}if(_ready&&!_sel.selected){_ready=false;if(_sel.selected===false){_widget.drawCard(_type).then(function(){var _popup=false;node.classList.remove("pushed");_ready=true;_selection.loop(function(v,i){if(v.popup===true){_popup=true}});if(_popup){_widget.setPopup(_type)}})}else{node.classList.remove("pushed");_ready=true}}}};_widget.accept=function(event,node){var _type=node.getAttribute("name"),_sel=_selection.get(_type);if(_next==="step"){if(_cards.get(_type).id){if(_sel.selected){_sel.selected=false;_selection.set(_type,_sel)}else{_sel.selected=true;_selection.set(_type,_sel)}}else{_sel.selected=false;_selection.set(_type,_sel)}}};_widget.zoom=function(event,node){var type=node.getAttribute("name");_widget.setPopup(type)};_widget.setPopup=function setPopup(type){var pos={x:0,y:337},caret="left",old=_selection.get(_currentPopup)||"",sel=_selection.get(type);if(old){old.popup=false;_selection.set(_currentPopup,old)}sel.popup=true;_selection.set(type,sel);_currentPopup=type;if(type==="char")pos.x=382;if(type==="context"){pos.x=102;caret="right"}if(type==="problem"){pos.x=249;caret="right"}if(_currentCards[type].count()){_popupUI.reset(_currentCards[type].toJSON(),pos,caret,document.getElementById("quicksetup-popup"))}};_widget.closePopup=function closePopup(){var sel=_selection.get(_currentPopup);sel.popup=false;_selection.set(_currentPopup,sel);_currentPopup=""};_popupUI=new CardPopup(_widget.closePopup);_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="quicksetup"){_qsTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};_widget.reset=function reset(sip){_next="step";if(sip){_elapsed=$session.get("elapsedTimers").quicksetup||0;if($session.get("characters").length){_next="screen";_selection.reset({"char":{selected:true,left:1,popup:false},context:{selected:true,left:1,popup:false},problem:{selected:true,left:1,popup:false}});_currentPopup="";_timer.set("timer",_elapsed);_timer.set("display",true);_widget.getDeck($session.get("deck")).then(function(){return _widget.getCard($session.get("characters")[0],_currentCards.char)}).then(function(){var c=_currentCards.char;_cards.set("char",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("characters",_cards.get("char"));return _widget.getCard($session.get("contexts")[0],_currentCards.context)}).then(function(){var c=_currentCards.context;_cards.set("context",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("contexts",_cards.get("context"));return _widget.getCard($session.get("problems")[0],_currentCards.problem)}).then(function(){var c=_currentCards.problem;_cards.set("problem",{id:c.get("_id"),title:c.get("title"),pic:c.get("picture_file")});$data.set("problems",_cards.get("problem"))})}else{_widget.init();_widget.initTimer(_elapsed)}}else{_widget.init()}};_widget.getDeck=function getDeck($deck){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(_db,$deck).then(function(){var result,deck={},lang=Config.get("user").get("lang");if(!cdb.get("default_lang")||cdb.get("default_lang")===lang){result=JSON.parse(cdb.toJSON())}else{cdb.get("translations")&&cdb.get("translations")[lang]?result=cdb.get("translations")[lang]:result=JSON.parse(cdb.toJSON())}deck.char=result.content.characters;deck.context=result.content.contexts;deck.problem=result.content.problems;deck.techno=result.content.techno;["char","context","problem","techno"].forEach(function(type){if(deck[type][0]==="newcard")deck[type].shift()});$data.set("deck",deck);promise.fulfill();setTimeout(function(){cdb.unsync()},2e3)});return promise};_widget.getCard=function getCard(id,store){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(_db,id).then(function(){store.reset(JSON.parse(cdb.toJSON()));promise.fulfill();cdb.unsync()});return promise};_widget.drawCard=function drawCard(type){var promise=new Promise,sel=_selection.get(type),card=_cards.get(type),idx=Math.floor(Math.random()*_deckStack[type].length),id=_deckStack[type][idx];_widget.getCard(id,_currentCards[type]).then(function(){var store=_currentCards[type];_drawnCards[type]++;_deckStack[type].splice(idx,1);card.id=id;card.title=store.get("title");card.pic=store.get("picture_file");_cards.set(type,card);sel.left=_deckStack[type].length;_selection.set(type,sel);promise.fulfill()});return promise};_widget.updateSessionScore=function updateSessionScore(time){var promise=new Promise,json={sid:$session.get("_id"),step:"quicksetup",time:time,cards:_drawnCards.char+_drawnCards.context+_drawnCards.problem};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.init=function init(){_widget.getDeck(Config.get("user").get("active_deck")).then(function(){var _deck=$data.get("deck");_deckStack.char=_deck.char.concat();_deckStack.context=_deck.context.concat();_deckStack.problem=_deck.problem.concat();_drawnCards.char=0;_drawnCards.context=0;_drawnCards.problem=0;_currentCards={"char":new Store,context:new Store,problem:new Store};_currentPopup="";_ready=true;_start=null;_cards.reset({"char":{id:"",title:_labels.get("char"),pic:""},context:{id:"",title:_labels.get("context"),pic:""},problem:{id:"",title:_labels.get("problem"),pic:""}});_selection.reset({"char":{selected:false,left:null,popup:false},context:{selected:false,left:null,popup:false},problem:{selected:false,left:null,popup:false}})})};return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/cardpopup":244,"../../../services/config":245,"../../../services/help":248,"../../../services/map":249,"../../../services/utils":256}],168:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Help=require("../../../services/help"),Store=emily.Store,Promise=emily.Promise,Spinner=require("../../../libs/spin.min");module.exports=function QuickStartConstructor($session,$prev,$next,$progress){var _widget=new Widget,_user=Config.get("user"),_db=Config.get("db"),_languages=new Store(Config.get("userLanguages")),_resetLang=function(){var l=_user.get("lang").substring(0,2);$session.set("lang",l);_languages.loop(function(v,i){v.name===l?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_labels=Config.get("labels"),_next="step",spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545}).spin();_resetLang();_widget.seam.addAll({labels:new Model(_labels),select:new Model(_languages,{setBg:function(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),model:new Model($session,{setTitle:function(initiator){var _now=new Date;if(initiator&&initiator.username)this.setAttribute("placeholder",_labels.get("quickstarttitleplaceholderpre")+initiator.username+_labels.get("quickstarttitleplaceholderpost"))},displayLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}}),quickstartevent:new Event(_widget)});_widget.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:mousedown, help"></div><form class="quickstart-form"><div class="idealang"><div class="currentlang" data-model="bind: displayLang, lang" data-quickstartevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-quickstartevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: mousedown, press; listen:mouseup, next"></div></form><div>';_widget.place(Map.get("quickstart"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";if($session.get("title")===""){$session.set("title",_labels.get("quickstarttitleplaceholderpre")+$session.get("initiator").username+_labels.get("quickstarttitleplaceholderpost"))}$session.set("lang",_user.get("lang"));$session.set("_id","S:QUICK:"+$session.get("startTime"));$session.sync(_db,$session.get("_id")).then(function(){_user.set("sessionInProgress",{id:$session.get("_id"),type:"quick"});return _user.upload()}).then(function(){$next("quickstart")})}else{$next("quickstart")}};_widget.stopSpinner=function stopSpinner(){spinner.stop();_widget.dom.querySelector(".next-button").classList.remove("invisible")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quickstart")};_widget.toggleProgress=function(event,node){$progress()};_widget.showLang=function(event,node){_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");$session.set("lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.reset=function reset(sip){var now=new Date,step=$session.get("step"),promise=new Promise;if(sip){step==="quickstart"?_next="step":_next="screen";if(step!=="quickwrapup")$session.set("resumeTime",now.getTime())}else{$session.set("startTime",now.getTime());$session.set("date",[now.getFullYear(),now.getMonth(),now.getDate()]);$session.set("lang",_user.get("lang"));_next="step"}};_widget.help=function(event,node){Help.setContent("quickstarthelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/help":248,"../../../services/map":249}],169:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CardPopup=require("../../../services/cardpopup"),Help=require("../../../services/help"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,Utils=require("../../../services/utils"),Spinner=require("../../../libs/spin.min");module.exports=function QuickTechConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_start=null,_elapsed=null,_qtTimer,_timer=new Store({timer:null,display:false}),_transport=Config.get("transport"),_user=Config.get("user"),_labels=Config.get("labels"),_popupUI,_currentPopup,_displayInit={left:"",scenario:{popup:false},tech1:{popup:false,selected:false},tech2:{popup:false,selected:false},tech3:{popup:false,selected:false}},_techDisplay=new Store(_displayInit),_techs=[],_ready=true,_tech1=new Store,_tech2=new Store,_tech3=new Store,_draw={tech1:_tech1,tech2:_tech2,tech3:_tech3},_drawnCards=0,_techCards=new Store([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),_next="step",spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373}).spin();_widget.seam.addAll({labels:new Model(_labels),display:new Model(_techDisplay,{setReload:function(left){!left&&_drawnCards>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(selected){_techDisplay.get("tech1").selected&&_techDisplay.get("tech2").selected&&_techDisplay.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(selected){selected?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(pop){pop?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new Model(_techCards,{removeDefault:function(pic){pic?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(title){if(title){this.innerHTML=title.toUpperCase()}else this.innerHTML=_labels.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")
}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),quicktechtimer:new Model(_timer,{setTime:function(timer){this.innerHTML=Utils.formatDuration(timer)},displayTimer:function(display){display?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new Event(_widget)});_widget.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:mousedown, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-quicktechevent="listen: mousedown,  accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-quicktechevent="listen: mousedown, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-quicktechevent="listen: mousedown, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>';_widget.place(Map.get("quicktech"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){var _now=new Date,_elapsedTime=_now.getTime()-_start;spinner.spin(node.parentNode);node.classList.add("invisible");node.classList.remove("pressed");if(_next==="step"){_next="screen";$data.set("techno",_techCards);clearInterval(_qtTimer);_timer.set("display",true);_widget.updateSessionScore(_timer.get("timer")).then(function(){$session.unsync();return $session.sync(Config.get("db"),$session.get("_id"))}).then(function(){var timers=$session.get("elapsedTimers");timers.quicktech=_timer.get("timer");$session.set("elapsedTimers",timers);$session.set("techno",[[_techCards.get(0).id,_techCards.get(1).id,_techCards.get(2).id]]);$next("quicktech")})}else{$next("quicktech")}};_widget.stopSpinner=function stopSpinner(){spinner.stop();_widget.dom.querySelector(".next-button").classList.remove("invisible")};_widget.help=function(event,node){Help.setContent("quicktechhelp");document.getElementById("cache").classList.add("appear");document.getElementById("help-popup").classList.add("appear")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quicktech")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleTimer=function(event,node){_timer.set("display",!_timer.get("display"))};_widget.select=function(event,node){var name=node.getAttribute("name");if(name.search("tech")<0||_drawnCards>0||_next==="screen"){node.classList.add("highlighted")}};_widget.zoom=function(event,node){var type=node.getAttribute("name");if(type.search("tech")<0||_drawnCards>0||_next==="screen"){_widget.setPopup(type)}};_widget.setPopup=function setPopup(type){var pos={x:0,y:337},caret="left",old=_techDisplay.get(_currentPopup)||"",story=new Store,details,sel=_techDisplay.get(type);if(old){old.popup=false;_techDisplay.set(_currentPopup,old)}sel.popup=true;_techDisplay.set(type,sel);_currentPopup=type;if(type==="scenario"){pos.x=147;pos.y=275;story.reset($session.get("scenario")[0]);story.set("type",5);details=story.toJSON()}else{if(type==="tech1"){pos.x=467}if(type==="tech2"){pos.x=186;caret="right"}if(type==="tech3"){pos.x=333;caret="right"}if(_draw[type].get("_id"))details=_draw[type].toJSON()}if(details){_popupUI.reset(details,pos,caret,document.getElementById("quicktech-popup"))}};_widget.closePopup=function closePopup(){var sel=_techDisplay.get(_currentPopup);sel.popup=false;_techDisplay.set(_currentPopup,sel);_currentPopup=""};_widget.push=function(event,node){var name=node.getAttribute("name");if(node.classList.contains("drawok")){if(_draw[name].get("_id")&&_next==="step")node.classList.add("pushed")}else node.classList.add("pushed")};_widget.draw=function(event,node){var toDraw=[];if(_next==="step"&&_ready){_ready=false;["tech1","tech2","tech3"].forEach(function(tech){if(!_techDisplay.get(tech).selected){toDraw.push(tech)}});_widget.drawTech(toDraw).then(function(){node.classList.remove("pushed");_ready=true})}};_widget.drawTech=function drawTech(arr){var idx,accepted=[],promise=new Promise;arr.forEach(function(name){if(_techs.length<=0){_techs=$data.get("deck").techno.concat();["tech1","tech2","tech3"].forEach(function(tech,idx){if(_techDisplay.get(tech).selected){accepted.push(_techCards.get(idx).id)}});_techs.filter(function(value){return!(accepted.indexOf(value)>-1)})}idx=Math.floor(Math.random()*_techs.length);_widget.getCardDetails(_techs[idx],name);_techDisplay.set("left",_techs.length);_drawnCards++;_techs.splice(idx,1)});promise.fulfill();return promise};_widget.getCardDetails=function getCardDetails(id,name){var cdb=new CouchDBDocument,idx=["tech1","tech2","tech3"].indexOf(name),promise=new Promise;cdb.setTransport(_transport);cdb.sync(Config.get("db"),id).then(function(){_draw[name].reset(JSON.parse(cdb.toJSON()));_techCards.update(idx,"id",id);_techCards.update(idx,"title",cdb.get("title"));_techCards.update(idx,"pic",cdb.get("picture_file"));promise.fulfill();cdb.unsync()});return promise};_widget.accept=function(event,node){var name=node.getAttribute("name"),idx=["tech1","tech2","tech3"].indexOf(name),display=_techDisplay.get(name);if(_next==="step"){if(_techCards.get(idx).id){display.selected=!display.selected;_techDisplay.set(name,display)}else{alert("please draw a card first")}}};_widget.reset=function(sip){var sessionTech=$session.get("techno")[0];_techDisplay.reset({left:"",scenario:{popup:false},tech1:{popup:false,selected:false},tech2:{popup:false,selected:false},tech3:{popup:false,selected:false}});_techCards.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]);_next="step";if(sip&&sessionTech&&sessionTech.length){_next="screen";_widget.getCardDetails(sessionTech[0],"tech1").then(function(){return _widget.getCardDetails(sessionTech[1],"tech2")}).then(function(){return _widget.getCardDetails(sessionTech[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(value){_techDisplay.set(value,{popup:false,selected:true})});$data.set("techno",_techCards)})}else{_techs=[];_drawnCards=0;_tech1.reset();_tech2.reset();_tech3.reset();_techCards.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])}$session.get("elapsedTimers").quicktech?_elapsed=$session.get("elapsedTimers").quicktech:_elapsed=0;_timer.set("timer",_elapsed);_next==="screen"?_timer.set("display",true):_widget.initTimer(_elapsed)};_widget.updateSessionScore=function updateSessionScore(time){var promise=new Promise,json={sid:$session.get("_id"),step:"quicktech",time:time,cards:_drawnCards};_transport.request("UpdateSessionScore",json,function(result){if(result.res==="ok"){promise.fulfill()}else{promise.reject()}});return promise};_widget.initTimer=function(init){var now=new Date,_start=now.getTime(),elapsed=init||0;_timer.set("display",false);_timer.set("timer",elapsed);if($session.get("step")==="quicktech"){_qtTimer=setInterval(function(){var now=new Date;_timer.set("timer",elapsed+now.getTime()-_start)},1e3)}};_popupUI=new CardPopup(_widget.closePopup);$data.watchValue("deck",function(value){_techs=value.techno.concat();_techDisplay.set("left",_techs.length)});return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/cardpopup":244,"../../../services/config":245,"../../../services/help":248,"../../../services/map":249,"../../../services/utils":256}],170:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Utils=require("../../../services/utils");module.exports=function QuickWrapupConstructor($session,$data,$prev,$next,$progress){var _widget=new Widget,_wrapup=new Store,_cards=new Store([]),_labels=Config.get("labels");_widget.seam.addAll({labels:new Model(_labels),wrapup:new Model(_wrapup,{formatTitle:function(title){if(title){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}},setScore:function(score){if(score)this.innerHTML=score+" ip"},setTime:function(duration){if(duration)this.innerHTML=Utils.formatDuration(duration)}}),cards:new Model(_cards,{formatTitle:function(title){var id=this.getAttribute("data-cards_id");if(title){if(id<3){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else{this.innerHTML=title.toUpperCase();this.setAttribute("style","font-family:Helvetica;")}}},setPic:function(pic){var node=this;if(pic){if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}}else{this.setAttribute("style","background-image: none;")}}}),quickwrapupevent:new Event(_widget)});_widget.template='<div id = "quickwrapup"><div class="previousbutton" data-quickwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quickwrapup" data-quickwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div></div><div class="sessioncards" data-quickwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div></div>';_widget.place(Map.get("quickwrapup"));_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){node.classList.remove("pressed");$next("quickwrapup")};_widget.prev=function(event,node){node.classList.remove("pressed");$prev("quickwrapup")};_widget.toggleProgress=function(event,node){$progress()};_widget.toggleCards=function(event,node){node.classList.contains("expanded")?node.classList.remove("expanded"):node.classList.add("expanded")};_widget.reset=function reset(sip){_cards.reset([]);_wrapup.reset()};$data.watchValue("scenario",function(value){_wrapup.set("scenario",value)});$data.watchValue("idea",function(value){_wrapup.set("idea",value)});["characters","contexts","problems","techno"].forEach(function(topic){$data.watchValue(topic,function(value){switch(topic){case"characters":_cards.set(0,value);break;case"contexts":_cards.set(1,value);break;case"problems":_cards.set(2,value);break;case"techno":value.loop(function(v,i){_cards.set(i+3,v)});break}})});$session.watchValue("score",function(score){_wrapup.set("score",score)});$session.watchValue("duration",function(duration){_wrapup.set("duration",duration)});return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],171:[function(require,module,exports){var olives=require("../../../libs/olives"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"];module.exports=function WBDefaultConstructor($type,$mode){var _widget=new Widget,_helplbl="",_labels=Config.get("labels"),_sessionType="quick";_widget.seam.add("labels",new Model(_labels));$mode?_sessionType=$mode:_sessionType="quick";$type==="scenario"?_helplbl=_sessionType+"scenariohelp":_helplbl=_sessionType+"ideahelp";_widget.template='<div id="whiteboard-default" class="defaultcontent"><div class="doctor-deedee"></div><div class="help" data-labels="bind:innerHTML,'+_helplbl+'"></div></div>';return _widget}},{"../../../libs/olives":141,"../../../services/config":245}],172:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Promise=emily.Promise,Utils=require("../../../services/utils");module.exports=function DrawingConstructor($store,$exit){var _widget=new Widget,_pos=null,_line={},_pencil=new Store({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),_colors=new Store([{color:"#4D4D4D",active:true},{color:"#657B99",active:false},{color:"#9AC9CD",active:false},{color:"#F2E520",active:false},{color:"#F27B3D",active:false},{color:"#BD262C",active:false},{color:"#5F8F28",active:false},{color:"white",active:false}]),_bgcolors=new Store([{color:"white",active:true},{color:"#657B99",active:false},{color:"#9AC9CD",active:false},{color:"#F2E520",active:false},{color:"#F27B3D",active:false},{color:"#BD262C",active:false},{color:"#5F8F28",active:false},{color:"#4D4D4D",active:false}]),_labels=Config.get("labels"),_progress=new Store({status:null}),_postit=new Store({type:"drawing",content:"",background:"",author:Config.get("user").get("_id")}),_uploadCanvas=function(filename){var _promise=new Promise,_url="/upload",_fd=new FormData,_type="postit",_dir="sessions/"+_sid,_canvas=_widget.dom.querySelector(".drawingcanvas"),_dataURL=_canvas.toDataURL("image/png"),_now=new Date,_filename=filename||Config.get("user").get("_id")+"_"+_now.getTime();_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("filename",_filename);_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,_progress,function(result){_postit.set("content",_filename);_postit.set("background",_pencil.get("bg"));_promise.fulfill()});return _promise},_sid,_capture=false,deltaX,deltaY,_LEFT=93;_widget.seam.addAll({labels:new Model(_labels),color:new Model(_colors,{setColor:function(color){this.setAttribute("style","background:"+color+";")},setActive:function(active){active?this.innerHTML="&#10003;":this.innerHTML=""}}),pencil:new Model(_pencil,{setSize:function(d){this.setAttribute("r",Math.round(d/2))},setColor:function(color){this.setAttribute("style","background:"+color+";")},togglebgfill:function(color){this.setAttribute("fill",color)},togglemode:function(mode){mode==="pencil"?this.setAttribute("fill",_pencil.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(color){_pencil.get("mode")==="pencil"?this.setAttribute("fill",color):this.setAttribute("fill",_pencil.get("bg"))},toggleselected:function(mode){this.classList.contains(mode)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new Model(_bgcolors,{setColor:function(color){this.setAttribute("style","background:"+color+";")},setActive:function(active){active?this.innerHTML="&#10003;":this.innerHTML=""}}),uploadprogress:new Model(_progress,{showProgress:function(status){status?this.innerHTML=status+"%":this.innerHTML=""}}),drawing:new Model(_postit,{draw:function(content){var _transport=Config.get("transport"),node=this,json;if(content){json={dir:_sid,filename:content};_transport.request("GetFile",json,function(data){var _img=new Image,_ctx=node.getContext("2d");_img.src=data;_ctx.drawImage(_img,0,0)})}}}),drawingevent:new Event(_widget)});_widget.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>';_widget.setSessionId=function(sid){_sid=sid};_widget.clear=function(event,node){var _canvas=_widget.dom.querySelector(".drawingcanvas"),_ctx=_canvas.getContext("2d");_ctx.clearRect(0,0,_canvas.width,_canvas.height);node.classList.remove("selected")};_widget.resetColors=function(){_pencil.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"});_colors.reset([{color:"#4D4D4D",active:true},{color:"#657B99",active:false},{color:"#9AC9CD",active:false},{color:"#F2E520",active:false},{color:"#F27B3D",active:false},{color:"#BD262C",active:false},{color:"#5F8F28",active:false},{color:"white",active:false}]);_bgcolors.reset([{color:"white",active:true},{color:"#657B99",active:false},{color:"#9AC9CD",active:false},{color:"#F2E520",active:false},{color:"#F27B3D",active:false},{color:"#BD262C",active:false},{color:"#5F8F28",active:false},{color:"#4D4D4D",active:false}])};_widget.erase=function(event,node){_pencil.set("mode","erase");_pencil.set("color",_pencil.get("bg"))};_widget.drawactive=function(event,node){_pencil.set("mode","pencil");_colors.loop(function(v,i){if(v.active)_pencil.set("color",v.color)})};_widget.expand=function(event,node){var name=node.getAttribute("name"),_ui=document.getElementById(name);_ui.classList.contains("invisible")?_ui.classList.remove("invisible"):_ui.classList.add("invisible")};_widget.stop=function(event,node){event.stopPropagation()};_widget.hide=function(event,node){event.stopPropagation();node.classList.add("invisible")};_widget.select=function(event,node){node.classList.add("selected")};_widget.getColor=function(event,node){var id=node.getAttribute("data-color_id");event.stopPropagation();_colors.loop(function(v,i){i===parseInt(id)?_colors.update(i,"active",true):_colors.update(i,"active",false)});_pencil.set("color",_colors.get(id).color);_pencil.set("mode","pencil");node.parentNode.classList.add("invisible")};_widget.getBgColor=function(event,node){var id=node.getAttribute("data-bgcolor_id");event.stopPropagation();_bgcolors.loop(function(v,i){i===parseInt(id)?_bgcolors.update(i,"active",true):_bgcolors.update(i,"active",false)});_pencil.set("bg",_bgcolors.get(id).color);node.parentNode.classList.add("invisible")};_widget.cancel=function(event,node){_widget.clear(event,node);_widget.resetColors();_postit.reset({type:"drawing",content:"",background:""});node.classList.remove("selected");$exit("drawing")};_widget.deletedrawing=function(event,node){if(_pos||_pos===0)$store.del(_pos);_widget.cancel(event,node)};_widget.post=function(event,node){node.classList.add("selected");_uploadCanvas(_postit.get("content")).then(function(){if(!_pos&&_pos!==0){$store.alter("push",JSON.parse(_postit.toJSON()))}else{$store.alter("splice",_pos,1,JSON.parse(_postit.toJSON()))}node.classList.remove("selected");_widget.cancel(event,node);_progress.reset({status:""})})};_widget.reset=function reset($pos){var cv=_widget.dom.querySelector(".drawingcanvas");_pos=$pos;_widget.resetColors();_lines=[];if(document.getElementById("muscenario")||document.getElementById("muidea")){cv.setAttribute("height",380)}if(!_pos&&_pos!==0){_postit.reset({type:"drawing",content:"",background:"",author:Config.get("user").get("_id")})}else{_postit.reset($store.get($pos));_pencil.set("bg",_postit.get("background"));_bgcolors.loop(function(v,i){v.color===_postit.get("background")?_bgcolors.update(i,"active",true):_bgcolors.update(i,"active",false)})}};_widget.start=function(event,node){var offsetLeft=node.offsetLeft+_LEFT;deltaX=(document.body.clientWidth-1024)/2;deltaY=(document.body.clientHeight-748)/2,_line={x:event.pageX-offsetLeft-deltaX,y:event.pageY-node.offsetTop-deltaY};_capture=true;event.preventDefault()};_widget.end=function(event,node){_capture=false};_widget.move=function(event,node){var moveX,moveY,ret,offsetLeft=node.offsetLeft+_LEFT;if(_capture){moveX=event.pageX-offsetLeft-deltaX-_line.x;moveY=event.pageY-node.offsetTop-deltaY-_line.y;ret=_widget.draw(node,moveX,moveY);_line={x:ret.x,y:ret.y}}event.preventDefault()};_widget.draw=function(canvas,changeX,changeY){var _ctx=canvas.getContext("2d");_ctx.lineWidth=_pencil.get("size");_ctx.strokeStyle=_pencil.get("color");_ctx.lineCap=_pencil.get("cap");_ctx.beginPath();_ctx.moveTo(_line.x,_line.y);_ctx.lineTo(_line.x+changeX,_line.y+changeY);_ctx.stroke();_ctx.closePath();return{x:_line.x+changeX,y:_line.y+changeY}};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],173:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Promise=emily.Promise,Utils=require("../../../services/utils"),Spinner=require("../../../libs/spin.min");module.exports=function ImportConstructor($store,$exit){var _widget=new Widget,_labels=Config.get("labels"),_reader=new FileReader,_progress=new Store({status:null}),_pos=null,_postit=new Store({type:"import",content:"",author:Config.get("user").get("_id")}),_sid,MAX_WIDTH=400,MAX_HEIGHT=300,_drawImage=function(img){var _width,_height,_canvas=document.getElementById("preview"),_ctx=_canvas.getContext("2d");_width=img.width;_height=img.height;if(_width>_height){if(_width>MAX_WIDTH){_height*=MAX_WIDTH/_width;_width=MAX_WIDTH}}else{if(_height>MAX_HEIGHT){_width*=MAX_HEIGHT/_height;_height=MAX_HEIGHT}}_canvas.width=_width;_canvas.height=_height;_ctx.drawImage(img,0,0,_width,_height)},_uploadCanvas=function(filename){var _promise=new Promise,_url="/upload",_fd=new FormData,_type="postit",_dir="sessions/"+_sid,_canvas=document.getElementById("preview"),_dataURL=_canvas.toDataURL("image/png"),_now=new Date,_filename=filename||Config.get("user").get("_id")+"_"+_now.getTime();_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("filename",_filename);_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,_progress,function(result){_postit.set("content",_filename);_promise.fulfill()});return _promise},_clearCanvas=function(){var _canvas=document.getElementById("preview"),_ctx=_canvas.getContext("2d");_ctx.clearRect(0,0,_canvas.width,_canvas.height)};_widget.template='<div class="import"><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/*" data-importevent="listen: mousedown, selectpress; listen:mouseup, check; listen: change, preview"><div data-labels="bind:innerHTML, importlbl" data-importevent="listen: mousedown, press; listen: mouseup, release"></div></span><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:mousedown,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-importevent="listen:mousedown, press;listen:mouseup, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>';_widget.seam.addAll({labels:new Model(_labels),importmodel:new Model(_postit,{setVisibility:function(content){content?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(content){var json,node=this,_transport=Config.get("transport"),spinner;if(!content)this.innerHTML="";else{spinner=(new Spinner).spin(node);json={dir:"sessions/"+_sid,filename:content};_transport.request("GetFile",json,function(data){var _img=new Image,_ctx=node.getContext("2d");_img.src=data;node.width=_img.width;node.height=_img.height;_ctx.drawImage(_img,0,0);spinner.stop();_widget.dom.querySelector("#postpic").scrollIntoView(false)})}}}),importprogress:new Model(_progress,{showProgress:function(status){status?this.innerHTML=status+"%":this.innerHTML=""}}),importevent:new Event(_widget)});_widget.cancel=function(event,node){node.parentNode.classList.add("invisible");$exit("import")};_widget.check=function(event,node){node.classList.remove("pressed");if(node.files.length)_widget.preview("change",node)};_widget.preview=function(event,node){var _img=new Image,_reader=new FileReader;_reader.onloadend=function(e){_img.src=e.target.result;setTimeout(function(){_drawImage(_img);document.getElementById("postpic").classList.remove("invisible")},300)};_reader.readAsDataURL(node.files[0])};_widget.selectpress=function(event,node){node.value=""};_widget.press=function(event,node){node.classList.add("pressed")};_widget.release=function(event,node){setTimeout(function(){node.classList.remove("pressed")},300)};_widget.post=function(event,node){_uploadCanvas(_postit.get("content")).then(function(){if(!_pos&&_pos!==0){$store.alter("push",JSON.parse(_postit.toJSON()))}else{$store.alter("splice",_pos,1,JSON.parse(_postit.toJSON()))}node.classList.remove("pressed");_widget.reset();_progress.reset({status:""});_clearCanvas();_widget.dom.querySelector(".importbutton").classList.remove("invisible");$exit("import")})};_widget.reset=function reset($pos){_pos=$pos;_postit.reset({type:"import",content:"",author:Config.get("user").get("_id")});if(_pos||_pos===0){_postit.reset($store.get($pos));_widget.dom.querySelector("#postpic").scrollIntoView()}};_widget.setSessionId=function(sid){_sid=sid};_widget.del=function(event,node){if(_pos||_pos===0){$store.del(_pos)}node.classList.remove("pressed");node.parentNode.classList.add("invisible");_widget.reset();_clearCanvas();_widget.dom.querySelector(".importbuttons").classList.remove("invisible");$exit("import")};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],174:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Spinner=require("../../../libs/spin.min");
module.exports=function WBMainConstructor($store,$tools,$select){var _widget=new Widget,_sid,_edit=true,_readonly=false,_transport=Config.get("transport"),_page=new Store([]),_pageSize=8,_pagination=new Store({currentPage:1,nbPages:1});_widget.seam.addAll({pagination:new Model(_pagination,{setPage:function(currentPage){var nb=currentPage;if(_pagination.get("nbPages")>1){this.innerHTML=labels.get("page")+nb+" / "+_pagination.get("nbPages")}else this.innerHTML=""},setNbPages:function(nbPages){var nb=_pagination.get("currentPage");if(nbPages>1){this.innerHTML=labels.get("page")+nb+" / "+_pagination.get("nbPages")}else this.innerHTML=""},setLeft:function(currentPage){currentPage>1?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(currentPage){currentPage<_pagination.get("nbPages")?this.classList.remove("invisible"):this.classList.add("invisible")}}),wbmain:new Model(_page,{displayPost:function(type){var node=this,id=node.getAttribute("data-wbmain_id"),content=_page.get(id).content,style=_page.get(id).style,bg=_page.get(id).background,dir,spinner,json;switch(type){case"postit":node.classList.remove("photo");node.classList.remove("drawing");node.innerHTML='<div class="inner-postit">'+content.replace(/\n/g,"<br>")+"</div>";node.setAttribute("style","background:url('img/brainstorm/"+style.img+"') no-repeat center center; background-size: contain; color:"+style.marker+";");break;case"import":node.classList.add("photo");node.classList.remove("drawing");this.innerHTML="";spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,left:50,top:50}).spin(node);dir="sessions/"+_sid;json={dir:dir,filename:content};_transport.request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;");spinner.stop()});break;case"drawing":node.classList.remove("photo");node.classList.add("drawing");this.innerHTML="";spinner=new Spinner({color:"#657B99",lines:10,length:8,width:4,radius:8,left:50,top:30}).spin(node);dir="sessions/"+_sid;json={dir:dir,filename:content};_transport.request("GetFile",json,function(data){node.setAttribute("style","background:"+bg+"; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;");spinner.stop()});break;default:break}}}),wbevent:new Event(_widget)});_widget.template='<div class="wbmain"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-wbevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage; bind:setNbPages, nbPages"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-wbevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul class="wblist" data-wbmain="foreach"><li class="wb-item postit" data-wbmain="bind: displayPost, type" data-wbevent="listen: mouseup, edit; listen:dblclick, cancelEdit"></li><ul><div>';_widget.push=function(event,node){node.classList.add("invisible");event.stopPropagation()};_widget.previousPage=function(event,node){_widget.displayPage("previous")};_widget.nextPage=function(event,node){_widget.displayPage("next")};_widget.edit=function(event,node){var id=node.getAttribute("data-wbmain_id"),type=$store.get(id).type;if(_edit){if(!_readonly){$tools.set(type,"active");$select(type,id)}else{if($store.get(id).type!=="postit"){node.classList.contains("enlarge")?node.classList.remove("enlarge"):node.classList.add("enlarge")}}}else _edit=true};_widget.cancelEdit=function(event,node){event.stopPropagation();_edit=false};_widget.setSessionId=function(sid){_sid=sid};_widget.setReadonly=function(bool){_readonly=bool};_widget.displayPage=function(target){var currentPage=_pagination.get("currentPage"),cp,i,j;switch(target){case"next":cp=currentPage;_pagination.set("currentPage",cp+1);break;case"previous":cp=currentPage-2;_pagination.set("currentPage",cp+1);break;default:cp=currentPage-1;break}_page.reset([]);for(i=0;i<_pageSize;i++){j=cp*_pageSize+i;if($store.get(j)){_page.alter("push",$store.get(j))}else{break}}};_widget.getNbPages=function(){var total=$store.count(),div=total/_pageSize,r=total%_pageSize;if(r>0)return parseInt(div)+1;if(div===0)return 1;else return div};_widget.init=function(type){_pagination.set("nbPages",_widget.getNbPages());_widget.displayPage("current");if(_pagination.get("nbPages")>1)_widget.dom.querySelector(".rightcaret").classList.remove("invisible");$store.watch("added",function(idx){var nb=_widget.getNbPages();_pagination.set("nbPages",nb);if(_page.count()===_pageSize&&$store.get(idx).author===Config.get("user").get("_id")){_widget.displayPage("next")}else{_widget.displayPage("current")}});$store.watch("deleted",function(item){_pagination.set("nbPages",_widget.getNbPages());if(_page.count()===1&&_pagination.get("currentPage")===_pagination.get("nbPages")){_widget.displayPage("previous")}else{_widget.displayPage("current")}});$store.watch("updated",function(){_widget.displayPage("current")})};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245}],175:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store;module.exports=function PostitConstructor($store,$exit){var _widget=new Widget,_labels=Config.get("labels"),_marker="#4D4D4D",_initColors=[{name:"blue",color:"#657B99",img:"postItBlue.png",selected:false},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:false},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:true},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:false}],_colors=new Store(_initColors),_pos=null,_postit=new Store({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"},author:Config.get("user").get("_id")});_widget.seam.addAll({labels:new Model(_labels),postit:new Model(_postit,{setStyle:function(style){var color=style.marker,img=style.img;this.setAttribute("style","background-image:url('img/brainstorm/"+img+"'); color:"+color+";")}}),colors:new Model(_colors,{setBg:function(color){this.setAttribute("style","background:"+color+";")},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),postitevent:new Event(_widget)});_widget.template='<div class="wbpostit"><div class="postit-cancel postit-close" data-postitevent="listen:mousedown,cancel"></div><div class="postit" data-postit="bind:setStyle, style"><textarea data-postit="bind: value, content"></textarea></div><span class="choosecolorlbl" data-labels="bind:innerHTML, choosecolorlbl"></span><ul class="postitcolors" data-colors="foreach"><li class="postitcolor" data-postitevent="listen:mousedown,choose" data-colors="bind:setBg, color;bind:setSelected, selected"></li></ul><div name="post" class = "postpostit" data-postitevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-postitevent="listen:mousedown, press;listen:mouseup, del"></div></div>';_widget.cancel=function(event,node){$exit("postit")};_widget.choose=function(event,node){var id=node.getAttribute("data-colors_id");_colors.loop(function(v,i){i===parseInt(id,10)?_colors.update(i,"selected",true):_colors.update(i,"selected",false)});_postit.set("style",{postit:_colors.get(id).name,marker:_marker,img:_colors.get(id).img})};_widget.press=function(event,node){_widget.dom.querySelector("textarea").blur();node.classList.add("pressed")};_widget.post=function(event,node){if(!_pos&&_pos!==0){$store.alter("push",JSON.parse(_postit.toJSON()))}else{$store.alter("splice",_pos,1,JSON.parse(_postit.toJSON()))}node.classList.remove("pressed");$exit("postit");_widget.reset()};_widget.reset=function reset($pos){_pos=$pos;if(!_pos&&_pos!==0){_postit.reset({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"},author:Config.get("user").get("_id")});_colors.reset([{name:"blue",color:"#657B99",img:"postItBlue.png",selected:false},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:false},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:true},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:false}])}else{_postit.reset($store.get(_pos))}};_widget.del=function(event,node){if(_pos){$store.del(_pos)}node.classList.remove("pressed");_widget.reset();$exit("postit")};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],176:[function(require,module,exports){var amy=require("../../../libs/amy2"),emily=require("../../../libs/emily"),Stack=amy.StackPlugin,Default=require("./wbdefault"),Main=require("./wbmain"),Postit=require("./wbpostit"),Import=require("./wbimport"),Drawing=require("./wbdrawing"),Store=emily.Store;function WhiteboardConstructor($type,$store,$tools,$mode){var _wbContent=new Store([]),_stack=this;this.selectScreen=function selectScreen(name,param){var ui=_stack.getStack().get(name);ui.reset&&ui.reset(param);_stack.getStack().show(name)};this.exitScreen=function exitScreen(name){$store.count()?_stack.getStack().show("main"):_stack.getStack().show("default");$tools.set(name,"inactive")};this.getContent=function getContent(){return _wbContent};this.setSessionId=function(sid){_stack.getStack().get("main").setSessionId(sid);_stack.getStack().get("import").setSessionId(sid);_stack.getStack().get("drawing").setSessionId(sid)};this.setReadonly=function(bool){_stack.getStack().get("main").setReadonly(bool)};this.getStack().add("default",new Default($type,$mode));this.getStack().add("main",new Main($store,$tools,this.selectScreen));this.getStack().add("postit",new Postit($store,this.exitScreen));this.getStack().add("import",new Import($store,this.exitScreen));this.getStack().add("drawing",new Drawing($store,this.exitScreen));this.init=function(){_stack.getStack().get("main").init($type)}}module.exports=function WhiteboardFactory($type,$store,$tools,$mode){WhiteboardConstructor.prototype=new Stack;return new WhiteboardConstructor($type,$store,$tools,$mode)}},{"../../../libs/amy2":75,"../../../libs/emily":97,"./wbdefault":171,"./wbdrawing":172,"./wbimport":173,"./wbmain":174,"./wbpostit":175}],177:[function(require,module,exports){var olives=require("../../libs/olives"),amy=require("../../libs/amy2"),Widget=olives.OObject,Map=require("../../services/map"),Stack=amy.StackPlugin,Menu=require("../../services/submenu"),Contacts=require("./contacts/contacts"),Messages=require("./messages/messages"),MyTwocents=require("./twocents/mytwocents"),Config=require("../../services/config");module.exports=function ConnectConstructor(){var _widget=new Widget,_stack=new Stack,_observer=Config.get("observer"),setView=function setView(name){_stack.getStack().show(name)},_menu,msgUI=new Messages,contactsUI=new Contacts,twocentsUI=new MyTwocents;_widget.seam.add("connectstack",_stack);_widget.template='<div id="connect"><div id="connect-menu"></div><div class="stack" data-connectstack="destination"></div></div>';_widget.place(Map.get("connect"));_widget.showMenu=function showMenu(){_menu.toggleActive(true)};_widget.hideMenu=function hideMenu(){_menu.toggleActive(false)};_widget.reset=function reset(){_menu.reset();contactsUI.reset();msgUI.reset();twocentsUI.reset();_stack.getStack().show("#messages")};_menu=new Menu(_widget.dom.querySelector("#connect-menu"),setView);_menu.toggleActive(false);msgUI.init();contactsUI.init();_stack.getStack().add("#messages",msgUI);_stack.getStack().add("#contacts",contactsUI);_stack.getStack().add("#twocents",twocentsUI);_stack.getStack().show("#messages");_observer.watch("display-message",function(id){_menu.setWidget("#messages")});_observer.watch("display-twoq",function(){_menu.setWidget("#twocents")});_observer.watch("display-twoc",function(){_menu.setWidget("#twocents")});_observer.watch("message-contact",function(){_menu.setWidget("#messages")});return _widget}},{"../../libs/amy2":75,"../../libs/olives":141,"../../services/config":245,"../../services/map":249,"../../services/submenu":253,"./contacts/contacts":181,"./messages/messages":185,"./twocents/mytwocents":190}],178:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBView=CouchDBTools.CouchDBView,Store=emily.Store,Avatar=require("../../../services/avatar"),Promise=emily.Promise,Spinner=require("../../../libs/spin.min");module.exports=function AddContactConstructor(){var addContactUI=new Widget,count=new CouchDBView,search=new Store({email:"",firstname:"",lastname:"",result:"",display:false,sentok:false,message:"",invite:false}),displayContacts=new Store([]),selected={},user=Config.get("user"),transport=Config.get("transport"),labels=Config.get("labels"),spinner=new Spinner({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:26,top:-7}).spin(),validateSearch=function(name,value){var emailPattern=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;if(name==="email"){if(emailPattern.test(value.toLowerCase())){search.set("result","");searchContact("userid",value.toLowerCase())}else{search.set("result",labels.get("signupinvalidemail"))}}else{if(search.get("email")){search.set("result",labels.get("clearemailfirst"))}else{if(search.get("firstname")&&search.get("lastname")){search.set("result","");searchContact("username",search.get("firstname").toLowerCase()+" "+search.get("lastname").toLowerCase())}else{search.set("result",labels.get("needbothfnln"))}}}},searchContact=function(type,value){var cdb=new CouchDBView;cdb.setTransport(transport);if(type==="userid"){cdb.sync(Config.get("db"),"users","_view/searchbyid",{key:'"'+value+'"',descending:true}).then(function(){displayContacts.reset(JSON.parse(cdb.toJSON()));displayContacts.count()?search.set("display",true):search.set("invite",true);cdb.unsync()})}else{cdb.sync(Config.get("db"),"users","_view/searchbyusername",{key:'"'+value+'"',descending:true}).then(function(){displayContacts.reset(JSON.parse(cdb.toJSON()));displayContacts.count()?search.set("display",true):search.set("result",labels.get("noentryfound"));cdb.unsync()})}},validateContactRequest=function(contact){var res=false,sent=user.get("sentMessages")||[],cx=user.get("connections"),sentCXR=false,existing=false,i,j,k,l;if(contact.userid===user.get("_id")){search.set("result",labels.get("cannotaddself"))}else{for(j=0,k=cx.length;j<k;j++){if(cx[j].userid===contact.userid){existing=true;break}}if(existing){search.set("result",contact.username+labels.get("alreadyconnected"))}else{for(i=0,l=sent.length;i<l;i++){if(sent[i].type==="CXR"&&sent[i].toList.search(contact.username)>-1){sentCXR=true;break}}sentCXR?search.set("result",labels.get("alreadysentCXR")+contact.username):res=true}}return res},addContact=function(contact){var now=new Date,json={};if(validateContactRequest(contact)){json.dest=[contact.userid];json.type="CXR";json.status="unread";json.date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];json.author=user.get("_id");json.username=user.get("username");json.firstname=user.get("firstname");json.toList=contact.username;json.ccList="";json.object=user.get("username")+labels.get("CXRobject");json.body=search.get("message");json.signature=user.get("signature");json.contactInfo={firstname:user.get("firstname"),lastname:user.get("lastname"),userid:user.get("_id"),username:user.get("username"),intro:user.get("intro"),type:"user"};transport.request("Notify",json,function(result){var res=JSON.parse(result);if(res[0].res==="ok"){search.set("result",labels.get("CXRsent"));setTimeout(function(){addContactUI.reset()},2e3)}else{model.set("result","There was an error, please try again later")}})}};addContactUI.seam.addAll({label:new Model(labels),count:new Model(count),search:new Model(search,{setVisible:function(value){value?this.classList.remove("invisible"):this.classList.add("invisible")},setStyle:function(sentok){sentok?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")}}),contacts:new Model(displayContacts,{setAvatar:function setAvatar(id){var frag,ui;_frag=document.createDocumentFragment();_ui=new Avatar([id]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),searchdbevent:new Event(addContactUI),invitecontactevent:new Event(addContactUI)});addContactUI.template='<div id="addcontact"><div class="header blue-dark"><span class="newcontactlbl" data-label="bind:innerHTML, newcontactlbl"></span></div><div class = "detail-contents"><div class="doctor-deedee"></div><div class="addcontactform"><p class="half"><span data-label="bind:innerHTML, beforecount"></span><strong><span data-count="bind:innerHTML, 0.value"></span></strong><span data-label="bind:innerHTML, aftercount"></span></p><p class="half" data-label="bind: innerHTML, addcontactrightintro"></p><legend data-label="bind:innerHTML, addcontactnow"></legend><input class="search" type="text" name="email" data-label="bind:placeholder, searchcontactplaceholder" data-search="bind: value, email" data-searchdbevent="listen: keypress, searchDB"><legend data-label="bind:innerHTML, lookup"></legend><div class="searchcontact"><input type="text" class="search half" name="fn" data-label="bind:placeholder, firstnameplaceholder" data-search="bind: value, firstname" data-searchdbevent="listen: keypress, searchDB"><input class="search half right" type="text" name="ln" data-label="bind: placeholder, lastnameplaceholder" data-search="bind: value, lastname" data-searchdbevent="listen: keypress, searchDB"></div><p class="searchresult" data-search="bind: innerHTML, result; bind:setStyle, sentok"></p></div><div class="contactinvite" data-search="bind: setVisible, invite"><p>The person you are looking for was not found in Ideafy. Would you like to send him/her an invitation ? You will receive 200 Ideafy Points if the person joins the community</p><div class="invitebuttons"><span class="sendmail" data-label="bind:innerHTML, sendlbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, sendInvite">Accept</span><span class="cancelmail" data-label="bind:innerHTML, cancellbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, cancelInvite">Cancel</span></div></div><div class = "contactlist invisible" data-search="bind: setVisible, display"><legend data-label="bind:innerHTML, selectcontact"></legend><ul data-contacts="foreach"><li class = "contact list-item"><div data-contacts="bind:setAvatar, value.userid"></div><p class="contact-name" data-contacts="bind:innerHTML, value.username"></p><p class="contact-intro" data-contacts="bind:innerHTML, value.intro"></p><div class="select-contact" data-searchdbevent="listen:mousedown, check"></div></li></ul><textarea class="input" data-label="bind:placeholder, addamessage" data-search="bind:value, message"></textarea><div class="addcontactbtns"><div class="addct" data-searchdbevent="listen:mousedown, push; listen:mouseup, add"></div><div class="cancelct" data-searchdbevent="listen:mousedown, push; listen:mouseup, cancel"></div></div></div></div></div>';addContactUI.init=function init(){var promise=new Promise;count.setTransport(transport);count.sync(Config.get("db"),"users","_view/count").then(function(){promise.fulfill()});return promise};addContactUI.searchDB=function(event,node){var field;if(event.keyCode===13){event.target.blur();field=node.getAttribute("name");validateSearch(field,node.value)}};addContactUI.check=function(event,node){var id=node.getAttribute("data-contacts_id");if(node.innerHTML){node.innerHTML="";selected[id]=false}else{node.innerHTML="&#10003;";selected[id]=true}};addContactUI.reset=function reset(){search.reset({email:"",firstname:"",lastname:"",result:"",display:false,sentok:false,message:"",invite:false});displayContacts.reset([])};addContactUI.push=function(event,node){node.classList.add("pushed")};addContactUI.cancel=function(event,node){node.classList.remove("pushed");addContactUI.reset()};addContactUI.press=function(event,node){node.classList.add("pressed")};addContactUI.cancelInvite=function(event,node){node.classList.remove("pressed");addContactUI.reset()};addContactUI.sendInvite=function(event,node){var json={id:search.get("email").toLowerCase(),senderid:user.get("_id"),sendername:user.get("username"),subject:user.get("username")+labels.get("invitesyou"),body:labels.get("invitebody")};spinner.spin(node);transport.request("Invite",json,function(result){if(result==="ok"){alert(labels.get("invitationsent"))}if(result==="alreadyinvited"){alert(labels.get("alreadyinvited"))}spinner.stop();node.classList.remove("pressed");addContactUI.reset()})};addContactUI.add=function(event,node){node.classList.remove("pushed");for(i in Object.keys(selected)){addContact(displayContacts.get(i).value)}};return addContactUI}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245}],179:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Avatar=require("../../../services/avatar");module.exports=function AddGroupConstructor(){var addGroupUI=new Widget,group=new Store({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),colors=new Store([{color:"#4D4D4D",icon:"graygroup.png",selected:true},{color:"#657B99",icon:"bluegroup.png",selected:false},{color:"#9AC9CD",icon:"azurgroup.png",selected:false},{color:"#5F8F28",icon:"greengroup.png",selected:false},{color:"#F2E520",icon:"yellowgroup.png",selected:false},{color:"#F27B3D",icon:"orangegroup.png",selected:false},{color:"#BD262C",icon:"redgroup.png",selected:false}]),displayContacts=new Store([]),contactList=new Store([]),error=new Store({error:""}),selected={},user=Config.get("user"),labels=Config.get("labels");addGroupUI.seam.addAll({label:new Model(labels),error:new Model(error),color:new Model(colors,{setColor:function(color){this.setAttribute("style","background:"+color+";")},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new Model(group,{setColor:function(value){this.setAttribute("style","background: url('img/connect/"+value+"') no-repeat top left; background-size: contain;")},setStyle:function(sentok){sentok?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(contacts){contacts.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),contacts:new Model(displayContacts,{setAvatar:function setAvatar(id){var frag,ui;_frag=document.createDocumentFragment();_ui=new Avatar([id]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),addgrpevent:new Event(addGroupUI)});addGroupUI.template='<div id="addgroup"><div class="header blue-dark"><span class="newfolderlbl" data-label="bind:innerHTML, newfolderlbl"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-addgrpevent="listen: mousedown, selectColor"></li></ul></form><div class = "groupcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-contacts="foreach"><li class = "contact list-item" data-addgrpevent="listen:mousedown, discardContact"><div data-contacts="bind:setAvatar, userid"></div><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><div class="addgroupbtns"><span class="errormsg" data-error="bind:innerHTML, error"></span><div class="addct" data-addgrpevent="listen:mousedown, press; listen:mouseup, add"></div><div class="cancelct" data-addgrpevent="listen:mousedown, press; listen:mouseup, cancel"></div></div><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-addgrpevent="listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-addgrpevent="listen:mouseup, select"></li></ul></div></div></div></div>';addGroupUI.init=function init(){user.get("connections").forEach(function(item){if(item.type==="user")contactList.alter("push",{contact:item,selected:false})})};addGroupUI.selectColor=function(event,node){var id=node.getAttribute("data-color_id");colors.loop(function(v,i){colors.update(i,"selected",false)});colors.update(id,"selected",true);group.set("color",colors.get(id).icon)};addGroupUI.toggleHide=function(event,node){var name=node.getAttribute("name");if(node.classList.contains("hide")){node.classList.remove("hide");name==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")}else{node.classList.add("hide");name==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible")}};addGroupUI.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){addGroupUI.removeContact(id);setTimeout(function(){contactList.update(id,"selected",false)},200)}else{addGroupUI.addContact(id);setTimeout(function(){contactList.update(id,"selected",true)},200)}};addGroupUI.addContact=function addContact(id){var current=JSON.parse(displayContacts.toJSON()),contact=contactList.get(id).contact,index=0;if(displayContacts.toJSON().search(contact.userid)<0){for(i=0,l=current.length;i<l;i++){if(contact.lastname>current[i].lastname)index++;else if(contact.lastname===current[i].lastname&&contact.username>current[i].username)index++}current.splice(index,0,contact);displayContacts.reset(current);group.set("contacts",current)}};addGroupUI.removeContact=function removeContact(id){var contacts=JSON.parse(displayContacts.toJSON());for(i=contacts.length-1;i>=0;i--){if(contacts[i].userid===contactList.get(id).contact.userid)contacts.splice(i,1)}displayContacts.reset(contacts)};addGroupUI.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=user.get("connections"),clc,vlc=node.value.toLowerCase();if(node.value===""){arr=[];for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){arr.push({contact:connections[i],selected:false})}}}else if(event.keyCode===8||event.keyCode===46){arr=[];for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){arr.push({contact:connections[i],selected:false})}}for(i=arr.length-1;i>=0;i--){if(arr[i].contact.username.toLowerCase().search(vlc)!==0){arr.splice(i,1)}}}else{for(i=arr.length-1;i>=0;i--){clc=arr[i].contact.username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}}contactList.reset(arr);contactList.loop(function(v,i){if(displayContacts.toJSON().search(v.contact.userid)>-1)contactList.update(i,"selected",true)})};addGroupUI.discardContact=function(event,node){var id=node.getAttribute("data-contacts_id"),userid=displayContacts.get(id).userid;displayContacts.alter("splice",id,1);contactList.loop(function(v,i){if(v.contact.userid===userid)setTimeout(function(){contactList.update(i,"selected",false)},200)})};addGroupUI.reset=function reset(){group.reset({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]});displayContacts.reset([]);contactList.reset([]);error.reset({error:""});user.get("connections").forEach(function(item){if(item.type==="user")contactList.alter("push",{contact:item,selected:false})})};addGroupUI.press=function(event,node){node.classList.add("pushed")};addGroupUI.cancel=function(event,node){node.classList.remove("pushed");addGroupUI.reset();document.querySelector("#addgroup input.search").value=""};addGroupUI.add=function(event,node){var connections=user.get("connections"),index=0,grp=JSON.parse(group.toJSON());node.classList.remove("pushed");error.set("error","");if(grp.username===""){error.set("error",labels.get("nogrpname"))}else if(grp.intro===""){error.set("error",labels.get("nogrpintro"))}else if(!grp.contacts.length){error.set("error",labels.get("nocontactselected"))}else{for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){if(grp.username>connections[i].lastname)index++}else{if(grp.username===connections[i].username){error.set("error",labels.get("grpnameexists"))}if(grp.username>connections[i].username)index++}}if(!error.get("error")){connections.splice(index,0,grp);user.set("connections",connections);user.upload().then(function(){addGroupUI.reset()})}}};return addGroupUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245}],180:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils");module.exports=function ContactDetailsConstructor(){var contactDetails=new Widget,details=new Store,contact=new Store,grades=new Store([]),achievements=new Store([]),labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport");contactDetails.seam.addAll({label:new Model(labels),basicinfo:new Model(contact,{setAvatar:function(userid){var _frag=document.createDocumentFragment(),_ui=new Avatar([userid]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}),ctdetails:new Model(details),grades:new Model(grades,{showBadge:function(badge){this.setAttribute("style","background: url('img/profile/"+badge+"') no-repeat center center; background-size: cover;")}}),achievements:new Model(achievements,{showBadge:function(badge){this.setAttribute("style","background: url('img/profile/"+badge+"') no-repeat center center; background-size: cover;")}}),ctdetailsevent:new Event(contactDetails)});contactDetails.template='<div id = "contactdetails"><div class="header blue-dark"><span class="subjectlbl" data-details="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class = "contactessentials"><div class="avatar" data-basicinfo="bind:setAvatar, userid"></div><div class="basicinfo"><h2 data-basicinfo="bind:innerHTML,username"></h2><p data-basicinfo="bind:innerHTML, intro"></p></div><div class="contactdashboard"><div class="contactstats"><legend data-label="bind:innerHTML, stats"></legend><div class="userscore"><span class="ip" data-ctdetails="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-ctdetails="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-ctdetails="bind: innerHTML, sessions"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-ctdetails="bind: innerHTML, contacts"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-ctdetails="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="contactbadges"><legend data-label="bind:innerHTML, achievements"></legend><p class="grade" data-stats="bind:innerHTML, title"></p><ul class="badges" data-grades="foreach"><li class="contactbadge"><div data-grades="bind:showBadge, badge"></div><label data-grades="bind:innerHTML, title"></label></li></ul><ul class="badges" data-achievements="foreach"><li class="contactbadge"><div data-achievements="bind:showBadge, badge"></div><label data-achievements="bind:innerHTML, label"></label></li></ul></div></div></div></div><div class = "contactnotes"><legend data-label="bind: innerHTML, mynotes"></legend><div id = "cancelnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push; listen:mouseup, cancelNotes"></div><div id = "uploadnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push;listen:mouseup, uploadNotes"></div><textarea id="ctnotes" class = "input" data-label="bind:placeholder,writesomething" data-basicinfo="bind: value, notes" data-ctdetailsevent="listen:input, displayNoteBtns"></textarea></div></div></div>';
contactDetails.place(Map.get("contactdetails"));contactDetails.updateContact=function updateContact(contact){var contacts=user.get("connections"),i,l=contacts.length,g,j;for(i=0;i<l;i++){if(contacts[i].userid===contact._id){contacts[i].username=contact.username;contacts[i].firstname=contact.firstname;contacts[i].lastname=contact.lastname;contacts[i].intro=contact.intro}if(contacts[i].type==="group"){g=contacts[i].contacts;for(j=0;j<g.length;j++){if(g[j].userid===contact._id){g[j].username=contact.username;g[j].firstname=contact.firstname;g[j].lastname=contact.lastname;g[j].intro=contact.intro}}contacts[i].contacts=g}}user.set("connections",contacts);user.upload()};contactDetails.getUserInfo=function getUserInfo(id){Utils.getUserDetails(id,function(result){if(result.username!==contact.get("username")||result.firstname!==contact.get("firstname")||result.lastname!==contact.get("lastname")||result.intro!==contact.get("intro")){contactDetails.updateContact(result)}details.reset(result);details.set("sessions",details.get("su_sessions_count")+details.get("mu_sessions_count"));Utils.getGrade(result.ip,function(res){grades.alter("push",res.grade);if(res.distinction)grades.alter("push",res.distinction)});achievements.reset(result.achievements)})};contactDetails.reset=function reset(contactinfo){contact.reset(contactinfo);grades.reset([]);achievements.reset([]);if(!contact.get("notes"))contact.set("notes","");contactDetails.getUserInfo(contactinfo.userid)};contactDetails.displayNoteBtns=function(event,node){document.getElementById("uploadnotes").classList.remove("invisible");document.getElementById("cancelnotes").classList.remove("invisible")};contactDetails.hideNoteBtns=function hideNoteBtns(event,node){document.getElementById("uploadnotes").classList.add("invisible");document.getElementById("cancelnotes").classList.add("invisible")};contactDetails.push=function(event,node){node.classList.add("pushed")};contactDetails.uploadNotes=function(event,node){var contacts=user.get("connections"),i,l=contacts.length,g,j,upload=document.getElementById("uploadnotes"),cancel=document.getElementById("cancelnotes");for(i=0;i<l;i++){if(contacts[i].userid===contact.get("userid")){contacts[i].notes=contact.get("notes")}if(contacts[i].type==="group"){g=contacts[i].contacts;for(j=0;j<g.length;j++){if(g[j].userid===contact.get("userid")){g[j].notes=contact.get("notes")}}contacts[i].contacts=g}}user.set("connections",contacts);user.upload().then(function(){node.classList.remove("pushed");contactDetails.hideNoteBtns()})};contactDetails.cancelNotes=function(event,node){var contacts=user.get("connections"),l=contacts.length;i;for(i=0;i<l;i++){if(contacts[i].userid===contact.get("userid"))contact.set("notes",contacts[i].notes)}node.classList.add("pushed");contactDetails.hideNoteBtns()};return contactDetails}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],181:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Stack=amy.StackPlugin,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Control=amy.ControlPlugin,Store=emily.Store,Avatar=require("../../../services/avatar"),ActionBar=require("../../../services/actionbar"),AddContact=require("./addcontact"),AddGroup=require("./addgroup"),ContactDetails=require("./contact-detail"),GroupDetails=require("./group-detail");module.exports=function ContactsConstructor(){var contactsUI=new Widget,detailStack=new Stack,addContact=new AddContact,addGroup=new AddGroup,contactDetails=new ContactDetails,groupDetails=new GroupDetails,sortButtons=new Store([{name:"all",label:"allbtn",selected:true},{name:"users",label:"usrbtn",selected:false},{name:"groups",label:"grpbtn",selected:false}]),currentSort=0,contactList=new Store([]),currentBar=null,user=Config.get("user"),labels=Config.get("labels"),sortContacts=function(id){var type=sortButtons.get(id).name,contacts=user.get("connections"),l=contacts.length,result=[];switch(type){case"users":for(i=0;i<l;i++){if(contacts[i].type==="user")result.push(contacts[i])}break;case"groups":for(i=0;i<l;i++){if(contacts[i].type==="group")result.push(contacts[i])}break;default:result=contacts}return result},searchContacts=function(text){var contacts=[],result=[];contacts=user.get("connections").concat();if(text===""){result=contacts;sortButtons.update(0,"selected",true);currentSort=0}else{for(i=0,l=contacts.length;i<l;i++){if(JSON.stringify(contacts[i]).toLowerCase().search(text.toLowerCase())>-1)result.push(contacts[i])}}return result};contactsUI.seam.addAll({label:new Model(labels),sort:new Model(sortButtons,{setLabel:function(name){this.innerHTML=labels.get(name)},setSelected:function(selected){selected?this.classList.add("pressed"):this.classList.remove("pressed")}}),contact:new Model(contactList,{setAvatar:function setAvatar(type){var id=this.getAttribute("data-contact_id"),_frag,_ui;if(type==="group"){if(this.hasChildNodes())this.removeChild(this.firstChild);this.setAttribute("style","background: url('img/connect/"+contactList.get(id).color+"') no-repeat center center; background-size: contain;display:block; width:40px; height:40px;float:left;")}else if(type==="user"){this.setAttribute("style","background:none;");_frag=document.createDocumentFragment();_ui=new Avatar([contactList.get(id).userid]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setIntro:function(intro){intro?this.innerHTML=intro:this.innerHTML=" "}}),contactdetailstack:detailStack,contactlistcontrol:new Control(contactsUI),contactlistevent:new Event(contactsUI)});contactsUI.template='<div id="connect-contacts"><div class="contacts"><div class="header blue-light"><span data-label="bind: innerHTML, contactlistheadertitle">My Contacts</span><div class="option right" data-contactlistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-contactlistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-contactlistevent="listen: keypress, search"><div class="contactlist overflow" data-contactlistcontrol="radio:li,selected,mousedown,selectContact"><ul data-contact="foreach"><li class="contact list-item" data-contactlistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-contact="bind:setAvatar, type"></div><p class="contact-name" data-contact="bind:innerHTML, username"></p><p class="contact-intro" data-contact="bind:setIntro, intro"></p><div class="select-contact"></div></li></ul></div></div><div id="toggleadd" class="group" data-contactlistevent="listen:mousedown, press; listen:mouseup, toggleAddUI"></div><div id="contact-detail" class="details" data-contactdetailstack="destination"></div></div>';contactsUI.place(Map.get("connect-contacts"));contactsUI.plus=function plus(event,node){var toggle=document.getElementById("toggleadd");detailStack.getStack().get("#addcontact").reset();detailStack.getStack().show("#addcontact");if(toggle.classList.contains("user")){toggle.classList.remove("user")}toggle.classList.add("group")};contactsUI.init=function init(){contactList.reset(user.get("connections"));addContact.init().then(function(){detailStack.getStack().show("#addcontact")});addGroup.init();groupDetails.init()};contactsUI.reset=function reset(){contactList.reset(user.get("connections"));addContact.reset();detailStack.getStack().show("#addcontact")};contactsUI.getSelectedContact=function(){var node=document.querySelector(".contact.selected"),id=-1;if(node)id=node.getAttribute("data-contact_id");return id};contactsUI.selectContact=function(event){var id=event.target.getAttribute("data-contact_id"),contact=contactList.get(id);document.getElementById("toggleadd").classList.remove("group");document.getElementById("toggleadd").classList.remove("user");if(contact.type==="user"){contactDetails.reset(contactList.get(id));if(detailStack.getStack().getCurrentName()!=="#contactdetails")detailStack.getStack().show("#contactdetails")}else{groupDetails.reset(contactList.get(id));if(detailStack.getStack().getCurrentName()!=="#groupdetails")detailStack.getStack().show("#groupdetails")}};contactsUI.displaySort=function(event,node){var id=node.getAttribute("data-sort_id");contactList.reset([]);if(currentSort>-1)sortButtons.update(currentSort,"selected",false);sortButtons.update(id,"selected",true);currentSort=id;contactList.reset(sortContacts(id))};contactsUI.search=function(event,node){if(event.keyCode===13){sortButtons.update(currentSort,"selected",false);currentSort=-1;contactList.reset(searchContacts(node.value))}};contactsUI.setStart=function(event,node){currentBar&&currentBar.hide()};contactsUI.showActionBar=function(event,node){var id=node.getAttribute("data-contact_id"),display=false,frag;if(currentBar&&currentBar.getParent()===node){display=true}if(!display){currentBar=new ActionBar("contact",node,contactList.get(id));frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};contactsUI.press=function(event,node){node.classList.add("pressed")};contactsUI.toggleAddUI=function(event,node){node.classList.remove("pressed");if(node.classList.contains("group")){node.classList.remove("group");detailStack.getStack().get("#addgroup").reset();detailStack.getStack().show("#addgroup");node.classList.add("user")}else{node.classList.remove("user");detailStack.getStack().get("#addcontact").reset();detailStack.getStack().show("#addcontact");node.classList.add("group")}};detailStack.getStack().add("#contactdetails",contactDetails);detailStack.getStack().add("#groupdetails",groupDetails);detailStack.getStack().add("#addcontact",addContact);detailStack.getStack().add("#addgroup",addGroup);user.watchValue("connections",function(){var id;if(currentSort>-1){contactList.reset(sortContacts(currentSort))}if(detailStack.getStack().getCurrentName()==="#contactdetails"){id=contactsUI.getSelectedContact();if(id>-1){contactDetail.reset(contactList.get(id));detailStack.getStack().show("#contactdetails")}else{detailStack.getStack().show("#addcontact");document.getElementById("toggleadd").classList.add("group")}}});Config.get("observer").watch("contact-deleted",function(){detailStack.getStack().show("#addcontact")});user.watchValue("lang",function(){var current;sortButtons.loop(function(v,i){if(v.selected)current=i});sortButtons.reset([{name:"all",label:"allbtn",selected:false},{name:"users",label:"usrbtn",selected:false},{name:"groups",label:"grpbtn",selected:false}]);sortButtons.update(current,"selected",true)});return contactsUI}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/actionbar":240,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"./addcontact":178,"./addgroup":179,"./contact-detail":180,"./group-detail":182}],182:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Avatar=require("../../../services/avatar");module.exports=function GroupDetailsConstructor(){var groupDetails=new Widget,group=new Store,grpcontacts=new Store([]),currentGroupInfo,colorList=[{color:"#4D4D4D",icon:"graygroup.png",selected:false},{color:"#657B99",icon:"bluegroup.png",selected:false},{color:"#9AC9CD",icon:"azurgroup.png",selected:false},{color:"#5F8F28",icon:"greengroup.png",selected:false},{color:"#F2E520",icon:"yellowgroup.png",selected:false},{color:"#F27B3D",icon:"orangegroup.png",selected:false},{color:"#BD262C",icon:"redgroup.png",selected:false}],colors=new Store(colorList),contactList=new Store([]),error=new Store({error:""}),selected={},user=Config.get("user"),labels=Config.get("labels");groupDetails.template='<div id="groupdetails"><div class="header blue-dark"><span class="newfolderlbl" data-group="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-grpdetailsevent="listen: mousedown, selectColor"></li></ul></form><div class = "grpcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-grpcontacts="foreach"><li class = "contact list-item" data-grpdetailsevent="listen:mousedown, discardContact"><div data-grpcontacts="bind:setAvatar, userid"></div><p class="contact-name" data-grpcontacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-grpcontacts="bind:innerHTML, intro"></p></li></ul></div><p class="update"><label class="cancelmail" data-label="bind:innerHTML, cancellbl" data-grpdetailsevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-label="bind:innerHTML, updatelbl" data-grpdetailsevent="listen:mousedown, press; listen:mouseup, updateGroup"></label><label class="editerror" data-error="bind:innerHTML, error"></label><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-grpdetailsevent="listen:keyup, updateAutoContact" data-label="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-grpdetailsevent="listen:mouseup, select"></li></ul></div></div></div></div>';groupDetails.seam.addAll({label:new Model(labels),error:new Model(error),color:new Model(colors,{setColor:function(color){this.setAttribute("style","background:"+color+";")},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new Model(group,{setColor:function(value){this.setAttribute("style","background: url('img/connect/"+value+"') no-repeat top left; background-size: contain;")},setStyle:function(sentok){sentok?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(contacts){contacts.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),grpcontacts:new Model(grpcontacts,{setAvatar:function setAvatar(id){var frag,ui;if(id){_frag=document.createDocumentFragment();_ui=new Avatar([id]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),grpdetailsevent:new Event(groupDetails)});groupDetails.selectColor=function(event,node){var id=node.getAttribute("data-color_id");colors.loop(function(v,i){colors.update(i,"selected",false)});colors.update(id,"selected",true);group.set("color",colors.get(id).icon)};groupDetails.toggleHide=function(event,node){var name=node.getAttribute("name");if(node.classList.contains("hide")){node.classList.remove("hide");name==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")}else{node.classList.add("hide");name==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible")}};groupDetails.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){groupDetails.removeContact(id);setTimeout(function(){contactList.update(id,"selected",false)},200)}else{groupDetails.addContact(id);setTimeout(function(){contactList.update(id,"selected",true)},200)}};groupDetails.addContact=function addContact(id){var current=JSON.parse(grpcontacts.toJSON()),contact=contactList.get(id).contact,index=0;if(grpcontacts.toJSON().search(contact.userid)<0){for(i=0,l=current.length;i<l;i++){if(contact.lastname>current[i].lastname)index++;else if(contact.lastname===current[i].lastname&&contact.username>current[i].username)index++}current.splice(index,0,contact);grpcontacts.reset(current);group.set("contacts",current)}};groupDetails.removeContact=function removeContact(id){var contacts=JSON.parse(grpcontacts.toJSON());for(i=contacts.length-1;i>=0;i--){if(contacts[i].userid===contactList.get(id).contact.userid)contacts.splice(i,1)}grpcontacts.reset(contacts);group.set("contacts",contacts)};groupDetails.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=user.get("connections");if(node.value===""){arr=[];for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){arr.push({contact:connections[i],selected:false})}}}else if(event.keyCode===8||event.keyCode===46){arr=[];for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){arr.push({contact:connections[i],selected:false})}}for(i=arr.length-1;i>=0;i--){if(arr[i].contact.username.search(node.value)!==0){arr.splice(i,1)}}}else{for(i=arr.length-1;i>=0;i--){if(arr[i].contact.username.search(node.value)!==0)arr.splice(i,1)}}contactList.reset(arr);contactList.loop(function(v,i){if(grpcontacts.toJSON().search(v.contact.userid)>-1)contactList.update(i,"selected",true)})};groupDetails.discardContact=function(event,node){var id=node.getAttribute("data-grpcontacts_id"),userid=grpcontacts.get(id).userid;grpcontacts.alter("splice",id,1);contactList.loop(function(v,i){if(v.contact.userid===userid)setTimeout(function(){contactList.update(i,"selected",false)},200)});group.set("contacts",JSON.parse(grpcontacts.toJSON()))};groupDetails.press=function(event,node){node.classList.add("pressed")};groupDetails.cancel=function(event,node){node.classList.remove("pressed");groupDetails.reset(currentGroupInfo);document.querySelector("#groupdetails input.search").value=""};groupDetails.updateGroup=function(event,node){var connections=user.get("connections"),i,grp=JSON.parse(group.toJSON());node.classList.remove("pressed");error.set("error","");if(grp.username===""){error.set("error",labels.get("nogrpname"))}else if(grp.intro===""){error.set("error",labels.get("nogrpintro"))}else if(!grp.contacts.length){error.set("error",labels.get("nocontactselected"))}else{for(i=connections.length-1;i>=0;i--){if(connections[i].type==="group"&&connections[i].username===currentGroupInfo.username){if(!error.get("error")){connections.splice(i,1,grp);user.set("connections",connections);user.upload().then(function(){groupDetails.reset(grp);error.set("error",labels.get("groupupdated"))})}}}}};groupDetails.reset=function reset(contactinfo){colors.reset(colorList);colors.loop(function(v,i){if(v.icon===contactinfo.color){colors.update(i,"selected",true)}else{colors.update(i,"selected",false)}});group.reset(contactinfo);currentGroupInfo=contactinfo;grpcontacts.reset(contactinfo.contacts);contactList.reset([]);error.reset({error:""});user.get("connections").forEach(function(item){if(item.type==="user")contactList.alter("push",{contact:item,selected:false})});contactList.loop(function(v,i){if(grpcontacts.toJSON().search(v.contact.userid)>-1)contactList.update(i,"selected",true)})};groupDetails.init=function init(){user.get("connections").forEach(function(item){if(item.type==="user")contactList.alter("push",{contact:item,selected:false})})};return groupDetails}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245}],183:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("../../../services/config"),Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils"),Reply=require("./message-reply"),Spinner=require("../../../libs/spin.min");module.exports=function MessageDetailConstructor($close){var msgDetailUI=new Widget,msgReplyUI=new Reply,message=new Store,cxrConfirm=new Store({response:""}),cxrSpinner=new Spinner({color:"#cccccc",lines:10,length:8,width:4,radius:8,top:-2,left:-10}).spin(),labels=Config.get("labels"),user=Config.get("user"),observer=Config.get("observer"),transport=Config.get("transport");msgDetailUI.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class="msgdetailarea"><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="more" class="more" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><p data-message="bind:setSignature, type"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:mousedown, press; listen:mouseup, showDoc"></div><div class="gotosession invisible" data-message="bind: showSessionBtn, sessionStatus" data-messageevent="listen:mousedown, press; listen:mouseup, gotoSession"></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: mousedown, press; listen: mouseup, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:mousedown, press; listen:mouseup, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:mousedown, press; listen:mouseup, rejectCXR"></div></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div></div>';msgDetailUI.seam.addAll({label:new Model(labels),message:new Model(message,{date:function date(date){var now=new Date,hrs=date[3],min=date[4],sec=date[5];if(date&&date[0]===now.getFullYear()&&date[1]===now.getMonth()&&date[2]===now.getDate()){if(hrs<10){hrs="0"+hrs}if(min<10){min="0"+min}if(sec<10){sec="0"+sec}this.innerHTML=hrs+":"+min+":"+sec}else{this.innerHTML=Utils.formatDate(date)+"  "+hrs+":"+min}},setObject:function(type){switch(type){case"CXR":this.innerHTML=message.get("username")+labels.get("CXRobject");break;case"INV":this.innerHTML=message.get("username")+labels.get("INVObject");break;case"CXRaccept":this.innerHTML=message.get("username")+labels.get("acceptedCXR");break;case"CXRreject":this.innerHTML=message.get("username")+labels.get("rejectedCXR");break;case"CXCancel":this.innerHTML=message.get("username")+labels.get("canceledCX");break;case"DOC":this.innerHTML=message.get("username")+labels.get("sentdocmsg");break;case"2Q+":this.innerHTML=message.get("username")+labels.get("askednew");break;case"2C+":this.innerHTML=message.get("username")+labels.get("senttc");break;case"REF":this.innerHTML=message.get("username")+labels.get("joinedideafy");break;case"MUD-":this.innerHTML=labels.get("muinaday");break;case"MUQ-":this.innerHTML=labels.get("mufifteen");break;case"MUP+":this.innerHTML=labels.get("newpart");break;case"MUP-":this.innerHTML=labels.get("partleft");break;case"SCANCEL":this.innerHTML=labels.get("scancel");break;case"SSTART":this.innerHTML=labels.get("sstart");break;default:this.innerHTML=message.get("object")}},setBody:function(type){switch(type){case"CXRaccept":this.innerHTML=labels.get("youlbl")+labels.get("nowconnected")+message.get("username");break;case"DOC":this.innerHTML="<p>"+message.get("body")+"</p><p>"+message.get("username")+"</p><p>"+message.get("signature")+"</p><br><br><p>"+labels.get("clicktoview")+" : <b>"+message.get("docTitle")+"</b></p>";break;case"INV":this.innerHTML=message.get("username")+labels.get("INVObject")+" : <b>"+message.get("docTitle")+"</b>";break;case"REF":this.innerHTML=labels.get("referral");break;case"MUD-":this.innerHTML=labels.get("snamed")+'<b> "'+message.get("docTitle")+'"</b> '+labels.get("stomorrow")+new Date(message.get("scheduled")).toLocaleTimeString()+".<br/><br/>";break;case"MUQ-":this.innerHTML=labels.get("snamed")+'<b> "'+message.get("docTitle")+'"</b> '+labels.get("sfifteen")+".<br/><br/>";break;case"MUP+":this.innerHTML=message.get("username")+labels.get("justreg")+labels.get("snamed").toLowercase()+' <b> "'+message.get("docTitle")+'"</b>.';break;case"MUP-":this.innerHTML=message.get("username")+labels.get("unreg")+labels.get("snamed").toLowercase()+' <b> "'+message.get("docTitle")+'"</b>.';break;case"SCANCEL":this.innerHTML=labels.get("snamed").toLowerCase()+'<b> "'+message.get("docTitle")+'"</b> '+labels.get("cclbyorg")+".";break;case"SSTART":this.innerHTML=labels.get("snamed").toLowerCase()+'<b> "'+message.get("docTitle")+'"</b> '+labels.get("nowopen")+".";break;default:this.innerHTML=message.get("body").replace(/\n/g,"<br>");break}},setSignature:function(type){if(type==="MSG"){this.classList.remove("invisible");this.innerHTML=message.get("signature")}else{this.classList.add("invisible")}},showOptions:function(type){type.search("CX")>-1||type==="2Q+"||type==="INV"||type==="REF"||type.search("MU")>-1?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(toList){toList?this.innerHTML=toList:this.innerHTML=labels.get("melbl")},showCcList:function(ccList){ccList?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(type){var cx,userid;this.classList.add("invisible");if(type==="CXR"){cx=user.get("connections");userid=message.get("author");for(i=0;i<cx.length;i++){if(cx[i].userid&&cx[i].userid===userid){break}}this.classList.remove("invisible")}},showDocBtn:function(type){type==="DOC"?this.classList.remove("invisible"):this.classList.add("invisible")},showSessionBtn:function(sessionStatus){sessionStatus&&(sessionStatus==="waiting"||sessionStatus==="scheduled")?this.classList.remove("invisible"):this.classList.add("invisible")},showTwoQ:function(type){type==="2Q+"||type==="2C+"?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function setAvatar(author){var _frag=document.createDocumentFragment(),_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}),cxr:new Model(cxrConfirm,{setVisibility:function(resp){resp?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(resp){resp==="YES"?this.innerHTML=labels.get("CXRaccepted")+message.get("username")+labels.get("isnowacontact"):this.innerHTML=labels.get("CXRrejected")}}),messageevent:new Event(msgDetailUI)});msgDetailUI.showDoc=function showDoc(event,node){node.classList.remove("pushed");if(message.get("type")==="DOC")observer.notify("display-doc",message.get("docId"),message.get("docType"))};msgDetailUI.showTwoQ=function showTwoQ(event,node){node.classList.remove("pushed");if(message.get("type")==="2Q+"){observer.notify("display-twoq",message.get("docId"),message.get("author"))}if(message.get("type")==="2C+"){observer.notify("display-twoc")}};msgDetailUI.press=function(event,node){node.classList.add("pushed")};msgDetailUI.action=function(event,node){var name=node.getAttribute("name"),replyNode=document.getElementById("msgreply"),options=document.querySelector(".msgoptionlist");switch(name){case"more":options.classList.remove("invisible");break;case"reply":options.classList.add("invisible");msgReplyUI.reset(JSON.parse(message.toJSON()),"reply");replyNode.classList.remove("invisible");replyNode.scrollIntoView();break;case"replyall":options.classList.add("invisible");msgReplyUI.reset(JSON.parse(message.toJSON()),"replyall");replyNode.classList.remove("invisible");replyNode.scrollIntoView();break;case"forward":options.classList.add("invisible");msgReplyUI.reset(JSON.parse(message.toJSON()),"forward");replyNode.classList.remove("invisible");replyNode.scrollIntoView();break;case"deletemsg":options.classList.add("invisible");msgDetailUI.deletemsg(message);$close("#defaultPage");break;default:break}node.classList.remove("pushed")};msgDetailUI.deletemsg=function deletemsg(msg){var arr=user.get("notifications").concat(),userid=msg.get("author"),index;for(i=0,l=arr.length;i<l;i++){if(arr[i].userid&&arr[i].userid===userid){index=i;break}}arr.splice(index,1);user.set("notifications",arr);user.upload()};msgDetailUI.acceptCXR=function(event,node){var contacts=user.get("connections").concat(),news=user.get("news").concat()||[],pos=0,now=new Date,date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];node.classList.remove("pushed");node.nextSibling.classList.add("invisible");cxrSpinner.spin(node);for(i=0,l=contacts.length;i<l;i++){if(contacts[i].type==="user"){if(contacts[i].lastname<message.get("contactInfo").lastname)pos++;if(contacts[i].lastname===message.get("contactInfo").lastname){if(contacts[i].firstname<message.get("contactInfo").firstname)pos++}}else if(contacts[i].username<message.get("contactInfo").lastname)pos++}contacts.splice(pos,0,message.get("contactInfo"));user.set("connections",contacts);news.unshift({type:"CX+",date:date,content:{userid:message.get("author"),username:message.get("username")}});user.set("news",news);user.upload().then(function(){var json={dest:[message.get("author")],date:date,original:"",type:"CXRaccept",author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:message.get("username"),ccList:"",object:user.get("username")+labels.get("acceptedCXR"),body:labels.get("youlbl")+labels.get("nowconnected")+user.get("username"),signature:"",contactInfo:{firstname:user.get("firstname"),lastname:user.get("lastname"),userid:user.get("_id"),username:user.get("username"),intro:user.get("intro"),type:"user"}};
cxrConfirm.set("response","YES");transport.request("Notify",json,function(result){cxrSpinner.stop();if(JSON.parse(result)[0].res==="ok"){setTimeout(function(){msgDetailUI.deletemsg(message);$close("#defaultPage")},1e3)}})})};msgDetailUI.rejectCXR=function(event,node){var json,now=new Date;node.classList.remove("pushed");node.parentNode.classList.add("invisible");cxrConfirm.set("response","NO");json={dest:[message.get("author")],original:"",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()],type:"CXRreject",author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:message.get("username"),ccList:"",object:user.get("username")+labels.get("rejectedCXR"),body:"",signature:""};transport.request("Notify",json,function(result){if(JSON.parse(result)[0].res==="ok"){setTimeout(function(){msgDetailUI.deletemsg(message);$close("#defaultPage")},1500)}})};msgDetailUI.checkSessionStatus=function checkSessionStatus(sid){var cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(Config.get("db"),sid).then(function(){if(cdb.get("status")){message.set("sessionStatus",cdb.get("status"))}else{message.set("sessionStatus","unavailable")}cdb.unsync()},function(error){alert(error)})};msgDetailUI.gotoSession=function(event,node){node.classList.remove("pushed");Config.get("observer").notify("show-mupreview",message.get("docId"))};msgDetailUI.reset=function reset(msg){message.reset({});cxrConfirm.reset({response:""});message.reset(msg);msgReplyUI.reset(msg,"reply");if(message.get("type")==="INV"||message.get("type").search("MU")>-1){message.set("sessionStatus",null);msgDetailUI.checkSessionStatus(message.get("docId"))}};return msgDetailUI}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256,"./message-reply":184}],184:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Promise=emily.Promise,Config=require("../../../services/config"),AutoContact=require("../../../services/autocontact"),Utils=require("../../../services/utils");module.exports=function MessageReplyConstructor(){var messageReplyUI=new Widget,msgReply=new Store,originalMsg,autoCompleteUIs={},error=new Store({errormsg:""}),labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),sendInProgress=false,cleanBody=function(body){var pattern=/<(.|\n)*?>/g;return body.replace(pattern,"")},validateRecipients=function(onEnd){var to=msgReply.get("toList").toLowerCase().split(/,|;/),cc=msgReply.get("ccList").toLowerCase().split(/,|;/),contacts=JSON.stringify(user.get("connections")).toLowerCase(),dest=[],json={},promise=new Promise;arr=[];for(i=0,l=to.length;i<l;i++){if(contacts.search(to[i].trim())>-1||originalMsg.toList.search(to[i].trim())>-1||originalMsg.ccList.search(to[i].trim())>-1){dest.push(to[i].trim())}else{error.set("errormsg",labels.get("tolbl")+" : "+to[i].trim()+labels.get("notavalidcontact"));sendInProgress=false;promise.reject();break}}if(!error.get("errormsg")&&cc[0]!==""){for(i=0,l=cc.length;i<l;i++){if(contacts.search(cc[i].trim())>-1||originalMsg.toList.search(cc[i].trim())>-1||originalMsg.ccList.search(cc[i].trim())>-1){dest.push(cc[i].trim())}else{error.set("errormsg",labels.get("tolbl")+" : "+cc[i].trim()+labels.get("notavalidcontact"));sendInProgress=false;promise.reject();break}}}if(!error.get("errormsg")){json.list=dest;transport.request("CheckRecipientList",json,function(result){var arr=[];if(!result.error){for(i=0,l=result.length;i<l;i++){arr.push(result[i].value)}onEnd(arr);promise.fulfill()}else{error.set("errormsg",result.error);promise.reject()}})}return promise};messageReplyUI.seam.addAll({labels:new Model(labels),errormsg:new Model(error),reply:new Model(msgReply,{setAvatar:function(author){this.setAttribute("style","background: url('"+Config.get("avatar")+"') no-repeat center center;background-size:cover;")},setCC:function(type){switch(type){case"replyall":break;case"forward":break;default:this.innerHTML=msgReply.get("message").username;break}},setSubject:function(type){switch(type){case"replyall":break;case"forward":break;default:this.innerHTML="  Re : "+msgReply.get("message").object;break}}}),replyevent:new Event(messageReplyUI)});messageReplyUI.template='<div><div class="avatar" data-reply="bind: setAvatar, message.author"></div><form class="form"><p><textarea name="toList" class="mail-header" data-labels="bind:placeholder, tocontactlbl" data-reply="bind: value, toList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea name="ccList" class="mail-header" data-labels="bind:placeholder, cclbl" data-reply="bind: value, ccList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><span class="subject" data-labels="bind:innerHTML, subjectlbl"></span><span data-reply="bind:innerHTML, object"></span></p><p><textarea class="input" data-reply="bind:value, body"></textarea></p><blockquote class="original" data-reply="bind:innerHTML, original"></blockquote><p><legend>Signature</legend><textarea class="signature" data-reply="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-replyevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-replyevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div>';messageReplyUI.reset=function reset(msg,type){originalMsg=msg;msgReply.reset({signature:"",original:"",author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:"",ccList:"",object:"",body:""});msgReply.set("type",type);user.get("signature")?msgReply.set("signature",user.get("signature")):msgReply.set("signature",user.get("username"));msgReply.set("original",labels.get("on")+Utils.formatDate(msg.date)+"</p><p>"+msg.username+labels.get("ideawrotelbl")+"</p><p>"+labels.get("subjectlbl")+msg.object+"</p><hr><p>"+msg.body+"</p>");switch(type){case"replyall":msg.ccList?msgReply.set("toList",msg.username.concat(", "+msg.ccList)):msgReply.set("toList",msg.username);msg.object&&msg.object.search("Re :")!==0?msgReply.set("object","Re : "+msg.object):msgReply.set("object",msg.object);break;case"forward":msgReply.set("toList","");msg.object&&msg.object.search("Fwd :")!==0?msgReply.set("object","Fwd : "+msg.object):msgReply.set("object",msg.object);break;default:msgReply.set("toList",msg.username);msg.object&&msg.object.search("Re :")!==0?msgReply.set("object","Re : "+msg.object):msgReply.set("object",msg.object);break}msgReply.set("message",msg);messageReplyUI.place(document.getElementById("msgreply"))};messageReplyUI.displayAutoContact=function(event,node){var name=node.getAttribute("name"),dom,ui,updateField=function(value){msgReply.set(name,value)};name==="toList"?dom=document.getElementById("tolistauto"):dom=document.getElementById("cclistauto");ui=new AutoContact(dom,node,updateField);autoCompleteUIs.name=ui;dom.classList.remove("invisible")};messageReplyUI.updateAutoContact=function(event,node){var name=node.getAttribute("name");if(event.keyCode===13){node.removeChild(node.firstChild)}else if(event.keyCode===186||event.keyCode===188){autoCompleteUIs.name.init()}else{autoCompleteUIs.name.updateList()}};messageReplyUI.press=function(event,node){node.classList.add("pressed")};messageReplyUI.cancel=function(event,node){node.classList.remove("pressed");sendInProgress=false;document.getElementById("msgreply").classList.add("invisible")};messageReplyUI.send=function(event,node){var now=new Date,json={};node.classList.remove("pressed");if(!sendInProgress){sendInProgress=true;error.set("errormsg","");json=JSON.parse(msgReply.toJSON());json.type="MSG";json.body=json.body.concat("<br><br>"+json.original);json.dest=[];validateRecipients(function(result){json.dest=result}).then(function(){if(!error.get("errormsg")){json.date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];transport.request("Notify",json,function(result){sendInProgress=false;error.set("errormsg",labels.get("messagesentok"));setTimeout(function(){error.set("errormsg","");sendInProgress=false;document.getElementById("msgreply").classList.add("invisible")},2e3)})}else{console.log(result);sendInProgress=false}})}};return messageReplyUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/autocontact":241,"../../../services/config":245,"../../../services/utils":256}],185:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Control=amy.ControlPlugin,Stack=amy.StackPlugin,Store=emily.Store,Config=require("../../../services/config"),Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils"),MessageDetail=require("./message-detail"),NewMessage=require("./newmessage"),ActionBar=require("../../../services/actionbar"),Promise=emily.Promise;module.exports=function MessagesConstructor(){var messageUI=new Widget,msgControl=new Control(messageUI),detailStack=new Stack,close=function(screen){detailStack.getStack().show(screen)},previousScreen="#defaultPage",defaultPage=new Widget,messageDetail=new MessageDetail(close),newMessage=new NewMessage(close),sortButtons=new Store([{name:"all",label:"allbtn",selected:true},{name:"messages",label:"msgbtn",selected:false},{name:"notifications",label:"notifbtn",selected:false},{name:"unread",label:"unreadbtn",selected:false}]),currentSort=0,msgList=new Store([]),labels=Config.get("labels"),currentBar=null,user=Config.get("user"),observer=Config.get("observer"),sortMessages=function(id){var type=sortButtons.get(id).name,msgs=user.get("notifications"),i,l=msgs.length,result=[];switch(type){case"messages":for(i=0;i<l;i++){if(msgs[i].type==="MSG")result.push(msgs[i])}break;case"notifications":for(i=0;i<l;i++){if(msgs[i].type!=="MSG")result.push(msgs[i])}break;case"unread":for(i=0;i<l;i++){if(msgs[i].status==="unread")result.push(msgs[i])}break;default:result=msgs}return result},searchMessages=function(text){var msgs=[],result=[];msgs=user.get("notifications").concat();if(text===""){result=msgs;sortButtons.update(0,"selected",true);currentSort=0}else{for(i=0,l=msgs.length;i<l;i++){if(JSON.stringify(msgs[i]).toLowerCase().search(text.toLowerCase())>-1)result.push(msgs[i])}}return result};messageUI.seam.addAll({label:new Model(labels),sort:new Model(sortButtons,{setLabel:function(name){this.innerHTML=labels.get(name)},setSelected:function(selected){selected?this.classList.add("pressed"):this.classList.remove("pressed")}}),msg:new Model(msgList,{setObject:function(type){var id=this.getAttribute("data-msg_id");switch(type){case"INV":this.innerHTML=msgList.get(id).username+labels.get("INVObject");break;case"CXR":this.innerHTML=msgList.get(id).username+labels.get("CXRobject");break;case"CXRaccept":this.innerHTML=msgList.get(id).username+labels.get("acceptedCXR");break;case"CXRreject":this.innerHTML=msgList.get(id).username+labels.get("rejectedCXR");break;case"CXCancel":this.innerHTML=msgList.get(id).username+labels.get("canceledCX");break;case"DOC":this.innerHTML=msgList.get(id).username+labels.get("sentdocmsg");break;case"2Q+":this.innerHTML=msgList.get(id).username+labels.get("askednew");break;case"2C+":this.innerHTML=msgList.get(id).username+labels.get("senttc");break;case"REF":this.innerHTML=msgList.get(id).username+labels.get("joinedideafy");break;case"MUD-":this.innerHTML=labels.get("muinaday");break;case"MUQ-":this.innerHTML=labels.get("mufifteen");break;case"MUP+":this.innerHTML=labels.get("newpart");break;case"MUP-":this.innerHTML=labels.get("partleft");break;case"SCANCEL":this.innerHTML=labels.get("scancel");break;case"SSTART":this.innerHTML=labels.get("sstart");break;default:this.innerHTML=msgList.get(id).object}},date:function date(date){var now=new Date;if(date&&date[0]===now.getFullYear()&&date[1]===now.getMonth()&&date[2]===now.getDate()){var hrs=date[3],min=date[4],sec=date[5];if(hrs<10){hrs="0"+hrs}if(min<10){min="0"+min}if(sec<10){sec="0"+sec}this.innerHTML=hrs+":"+min+":"+sec}else{this.innerHTML=Utils.formatDate(date)}},highlight:function(status){status&&status==="unread"?this.classList.add("unread"):this.classList.remove("unread")},setAvatar:function setAvatar(author){var _frag,_ui;if(author){_frag=document.createDocumentFragment();_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}}),msglistevent:new Event(messageUI),msglistcontrol:msgControl,msgdetailstack:detailStack});messageUI.template='<div id="connect-messages"><div class="messages"><div class="header blue-light"><span data-label="bind: innerHTML, msglistheadertitle">My Messages</span><div class="option right" data-msglistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-msglistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-msglistevent="listen: keypress, search"><div class="msglist overflow" data-msglistcontrol="radio:li,selected,mouseup,selectMsg"><ul data-msg="foreach"><li class="msg list-item" data-msglistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-msg="bind:setAvatar, author"></div><p class="msg-author unread" data-msg="bind:highlight, status; bind:innerHTML, username">Author</p><div class="select-msg"></div><span class="date" data-msg="bind: date, date"></span><p class="msg-subject unread" data-msg="bind:highlight, status; bind:setObject, type">Subject</p></li></ul></div></div><div id="msg-detail" class="details" data-msgdetailstack="destination"></div></div>';messageUI.place(Map.get("connect-messages"));messageUI.plus=function plus(event,node){detailStack.getStack().get("#newmsg").reset();detailStack.getStack().show("#newmsg")};messageUI.displaySort=function(event,node){var id=node.getAttribute("data-sort_id");msgList.reset([]);detailStack.getStack().show("#defaultPage");if(currentSort>-1)sortButtons.update(currentSort,"selected",false);sortButtons.update(id,"selected",true);currentSort=id;msgList.reset(sortMessages(id))};messageUI.search=function(event,node){if(event.keyCode===13){sortButtons.update(currentSort,"selected",false);currentSort=-1;msgList.reset(searchMessages(node.value))}};messageUI.selectMsg=function selectMsg(event,node){var id=event.target.getAttribute("data-msg_id"),arr=user.get("notifications"),idx;if(msgList.get(id).status==="unread"){for(i=0,l=arr.length;i<l;i++){if(JSON.stringify(arr[i])===JSON.stringify(msgList.get(id))){index=i;break}}msgList.update(id,"status","read");arr[index]=msgList.get(id);user.set("notifications",arr);user.upload()}detailStack.getStack().show("#msgdetail");messageDetail.reset(msgList.get(id));previousScreen="#msgdetail"};messageUI.init=function init(){msgList.reset(user.get("notifications"));messageUI.cleanOld()};messageUI.reset=function reset(){sortButtons.reset([{name:"all",label:"allbtn",selected:true},{name:"messages",label:"msgbtn",selected:false},{name:"notifications",label:"notifbtn",selected:false},{name:"unread",label:"unreadbtn",selected:false}]);messageUI.init();detailStack.getStack().show("#defaultPage");display=false};messageUI.getSelectedmsg=function(){var node=document.querySelector(".msg.selected"),id=-1;if(node)id=node.getAttribute("data-msg_id");return id};messageUI.cleanOld=function(){var promise=new Promise,now=new Date,msgdate,sentdate,update=false,n=user.get("notifications")||[],s=user.get("sentMessages")||[];for(i=n.length-1;i>=0;i--){msgdate=new Date(n[i].date[0],n[i].date[1],n[i].date[2],n[i].date[3],n[i].date[4],n[i].date[5]);if(now.getTime()-msgdate.getTime()>2592e6){n.pop();update=true}}for(i=s.length-1;i>=0;i--){sentdate=new Date(s[i].date[0],s[i].date[1],s[i].date[2],s[i].date[3],s[i].date[4],s[i].date[5]);if(now.getTime()-sentdate.getTime()>2592e6){s.pop();update=true}}if(update){user.set("notifications",n);user.set("sentMessages",s);user.upload().then(function(){promise.fulfill()})}else promise.fulfill();return promise};messageUI.setStart=function(event,node){currentBar&&currentBar.hide()};messageUI.showActionBar=function(event,node){var id=node.getAttribute("data-msg_id"),frag,display=false;if(currentBar&&currentBar.getParent()===node){display=true}if(!display){currentBar=new ActionBar("message",node,msgList.get(id));frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};defaultPage.template='<div class="msgsplash"><div class="header blue-dark"><span>'+Config.get("labels").get("messageview")+'</span></div><div class="innersplash" data-labels="bind: innerHTML, messagecenter"></div></div>';defaultPage.seam.add("labels",new Model(labels));messageUI.init();detailStack.getStack().add("#defaultPage",defaultPage);detailStack.getStack().add("#msgdetail",messageDetail);detailStack.getStack().add("#newmsg",newMessage);detailStack.getStack().show("#defaultPage");user.watchValue("notifications",function(){var id,newList=[];msgList.reset([]);newList=sortMessages(currentSort);msgList.reset(newList);if(detailStack.getStack().getCurrentName()==="#msgdetail"){id=messageUI.getSelectedmsg();id>-1?messageDetail.reset(msgList.get(id)):detailStack.getStack().show("#defaultPage")}});observer.watch("display-message",function(id){var arr=user.get("notifications");sortButtons.update(currentSort,"selected",false);if(arr[id].type==="MSG"){sortButtons.update(1,"selected",true);currentSort=1}else{sortButtons.update(2,"selected",true);currentSort=2}arr[id].status="read";user.set("notifications",arr);user.upload();msgList.reset([arr[id]]);document.querySelector('li[data-msg_id="0"]').classList.add("selected");msgControl.init(document.querySelector('li[data-msg_id="0"]'));detailStack.getStack().show("#msgdetail");messageDetail.reset(arr[id]);previousScreen="#msgdetail"});observer.watch("message-contact",function(data){newMessage.reset(data);detailStack.getStack().show("#newmsg")});user.watchValue("lang",function(){var current;sortButtons.loop(function(v,i){if(v.selected)current=i});sortButtons.reset([{name:"all",label:"allbtn",selected:true},{name:"messages",label:"msgbtn",selected:false},{name:"notifications",label:"notifbtn",selected:false},{name:"unread",label:"unreadbtn",selected:false}]);sortButtons.update(current,"selected",true)});return messageUI}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/actionbar":240,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256,"./message-detail":183,"./newmessage":186}],186:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Spinner=require("../../../libs/spin.min"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("../../../services/config"),AutoContact=require("../../../services/autocontact"),Promise=emily.Promise;module.exports=function NewMessageConstructor($close){var newMessageUI=new Widget,message=new Store,error=new Store({errormsg:""}),labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),sendInProgress=false,spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin(),autoCompleteUIs={},validateRecipients=function(onEnd){var to=message.get("toList").toLowerCase().split(/,|;/),cc=message.get("ccList").toLowerCase().split(/,|;/),contacts=JSON.stringify(user.get("connections")).toLowerCase(),dest=[],json={},promise=new Promise;arr=[];for(i=0,l=to.length;i<l;i++){if(contacts.search(to[i].trim())>-1){dest.push(to[i].trim())}else{error.set("errormsg",labels.get("tolbl")+" : "+to[i].trim()+labels.get("notavalidcontact"));sendInProgress=false;promise.reject();break}}if(!error.get("errormsg")&&cc[0]!==""){for(i=0,l=cc.length;i<l;i++){if(contacts.search(cc[i].trim())>-1){dest.push(cc[i].trim())}else{error.set("errormsg",labels.get("tolbl")+" : "+cc[i].trim()+labels.get("notavalidcontact"));sendInProgress=false;promise.reject();break}}}if(!error.get("errormsg")){json.list=dest;transport.request("CheckRecipientList",json,function(result){var arr=[];if(!result.error){for(i=0,l=result.length;i<l;i++){arr.push(result[i].value)}onEnd(arr);promise.fulfill()}else{error.set("errormsg",result.error);promise.reject()}})}return promise};newMessageUI.seam.addAll({labels:new Model(labels),errormsg:new Model(error),newmessage:new Model(message,{setAvatar:function(author){this.setAttribute("style","background: url('"+Config.get("avatar")+"') no-repeat center center;background-size:cover;")}}),newmessageevent:new Event(newMessageUI)});newMessageUI.template='<div id="newmsg"><div class="header blue-dark"><span data-labels="bind: innerHTML, newmsg">New message</span></div><div class="avatar" data-newmessage="bind: setAvatar, author"></div><form class="form"><p><textarea class="mail-header" name="toList" data-newmessage="bind: value, toList" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea class="mail-header" name="ccList" data-newmessage="bind: value, ccList" data-labels="bind:placeholder, cclbl" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><input type="text" class="input" data-newmessage="bind:value, object" data-labels="bind:placeholder, subjectlbl"></p><p><textarea class="input" data-newmessage="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-newmessage="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-newmessageevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-newmessageevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';newMessageUI.reset=function reset(data){var i,l,list="";message.reset({author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),type:"MSG",signature:user.get("username"),toList:"",ccList:"",object:"",body:"",date:null});user.get("signature")?message.set("signature",user.get("signature")):message.set("signature",user.get("username"));error.reset({errormsg:""});if(data){if(data.type==="user")message.set("toList",data.username);else{for(i=0,l=data.contacts.length;i<l;i++){list?list=list+", "+data.contacts[i].username:list=data.contacts[i].username}message.set("toList",list)}}};newMessageUI.press=function(event,node){node.classList.add("pressed")};newMessageUI.cancel=function(event,node){node.classList.remove("pressed");sendInProgress=false;newMessageUI.reset();$close("#defaultPage")};newMessageUI.displayAutoContact=function(event,node){var name=node.getAttribute("name"),dom,ui,updateField=function(value){message.set(name,value)};name==="toList"?dom=document.getElementById("tolistauto"):dom=document.getElementById("cclistauto");ui=new AutoContact(dom,node,updateField);autoCompleteUIs.name=ui;dom.classList.remove("invisible")};newMessageUI.updateAutoContact=function(event,node){var name=node.getAttribute("name");if(event.keyCode===13){node.removeChild(node.firstChild)}else if(event.keyCode===186||event.keyCode===188){autoCompleteUIs.name.init()}else{autoCompleteUIs.name.updateList()}};newMessageUI.send=function(event,node){var now=new Date,json={};node.classList.add("invisible");node.classList.remove("pressed");spinner.spin(node.parentNode);if(!sendInProgress){sendInProgress=true;error.set("errormsg","");json.author=message.get("author");json.username=message.get("username");json.firstname=message.get("firstname");json.signature=message.get("signature");json.toList=message.get("toList");json.ccList=message.get("ccList");json.object=message.get("object");json.body=message.get("body");json.type="MSG";if(!message.get("object")){error.set("errormsg",labels.get("entersubjectlbl"));sendInProgress=false;spinner.stop();node.classList.remove("invisible")}json.dest=[];validateRecipients(function(result){json.dest=result}).then(function(){if(!error.get("errormsg")){json.date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];transport.request("Notify",json,function(result){sendInProgress=false;spinner.stop();node.classList.remove("invisible");newMessageUI.reset();error.set("errormsg",labels.get("messagesentok"));setTimeout(function(){error.set("errormsg","");node.classList.remove("invisible");$close("#defaultPage")},2e3)})}else{sendInProgress=false;spinner.stop();node.classList.remove("invisible")}})}};return newMessageUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/autocontact":241,"../../../services/config":245}],187:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],WriteTwocent=require("../../twocents/writetwocent"),TwocentList=require("../../twocents/twocentlist"),Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils"),Place=olives["Place.plugin"];module.exports=function MTCDetailsConstructor(){var mtcDetailUI=new Widget,labels=Config.get("labels"),user=Config.get("user"),twocentList=new TwocentList("connect");mtcDetailUI.seam.addAll({labels:new Model(labels),place:new Place({TwocentUI:twocentList})});mtcDetailUI.template='<div class="twocent-detail"><div class="header blue-dark"><span data-labels="bind: innerHTML, mytwocentwall"></span></div><div class = "detail-contents"><div id="connect-twocents" class="twocents" data-place="place: TwocentUI"></div></div></div>';mtcDetailUI.reset=function reset(){twocentList.reset(user.get("_id"),"connect")};return mtcDetailUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256,"../../twocents/twocentlist":236,"../../twocents/writetwocent":238}],188:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Config=require("../../../services/config"),Store=emily.Store,Model=olives["Bind.plugin"],Map=require("../../../services/map"),Stack=amy.StackPlugin,MTCDetail=require("./mtc-details"),MTQDetail=require("./mtq-details");module.exports=function MTCDetailStackConstructor(){var widget=new Widget,defaultPage=new Widget,labels=Config.get("labels"),mtcDetailStack=new Stack;widget.template='<div id = "mtcdetailstack" data-mtcdetailstack = "destination"></div>';widget.seam.addAll({mtcdetailstack:mtcDetailStack});widget.setView=function setView(view){var current=mtcDetailStack.getStack().getCurrentName();if(view==="2Q"&&current!=="twoqdetail")mtcDetailStack.getStack().show("twoqdetail");else if(view==="2C"&&current!=="twocdetail"){mtcDetailStack.getStack().get("twocdetail").reset();mtcDetailStack.getStack().show("twocdetail")}else mtcDetailStack.getStack().show("defaultPage")};widget.reset=function reset(type,data){if(type==="2Q"&&data){mtcDetailStack.getStack().get("twoqdetail").reset(data);mtcDetailStack.getStack().show("twoqdetail")}if(type==="default"||!data){mtcDetailStack.getStack().show("defaultPage")}};defaultPage.template='<div class="msgsplash"><div class="header blue-dark" data-labels="bind: innerHTML, twocentview"><span></span></div><div class="innersplash" data-labels="bind: innerHTML, twocentcenter"></div></div>';defaultPage.seam.add("labels",new Model(labels));widget.init=function init(type,value){var twoqDetail=new MTQDetail,twocDetail=new MTCDetail;mtcDetailStack.getStack().add("twoqdetail",twoqDetail);mtcDetailStack.getStack().add("twocdetail",twocDetail);mtcDetailStack.getStack().add("defaultPage",defaultPage);if(type==="default"){mtcDetailStack.getStack().show("defaultPage")}if(type==="2Q"){mtcDetailStack.getStack().show("twoqdetail");twoQDetail.reset(value)}};return widget}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"./mtc-details":187,"./mtq-details":189}],189:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],WriteTwocent=require("../../twocents/writetwocent"),TwocentList=require("../../twocents/twocentlist"),Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils"),Place=olives["Place.plugin"];module.exports=function MTQDetailsConstructor(){var mtqDetailUI=new Widget,labels=Config.get("labels"),user=Config.get("user"),model=new Store,twocentWriteUI=new WriteTwocent("connect"),twoqTwocentList=new TwocentList("connect"),domWrite;mtqDetailUI.seam.addAll({labels:new Model(labels),tqdetail:new Model(model,{setHeader:function(author){if(!author)this.innerHTML=labels.get("selecttq");else if(author===user.get("_id"))this.innerHTML=labels.get("mytqdetailheader");else this.innerHTML=labels.get("tqheaderprefix")+model.get("username")+labels.get("tqheadersuffix")},displayWriteTwocent:function(author){!author||author===user.get("_id")?this.classList.add("invisible"):this.classList.remove("invisible")},displayTwocentList:function(twocents){if(twocents&&twocents.length){document.getElementById("connect-writetwocents").classList.add("invisible")}},displayTwocentNB:function(twocents){var nb=twocents.length||0;if(!nb)this.innerHTML=labels.get("noreplyyet");else if(nb===1)this.innerHTML=nb+" "+labels.get("showonetcreply");else this.innerHTML=nb+labels.get("showtcrepliesafter")},date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setAuthor:function(username){if(username===user.get("username")&&model.get("author")===user.get("_id")){this.innerHTML=labels.get("youlbl")}else{this.innerHTML=username}},setWrotelbl:function(author){if(author===user.get("_id")){this.innerHTML=labels.get("youwrotelbl")}else{this.innerHTML=labels.get("ideawrotelbl")}},setAvatar:function setAvatar(author){var _frag=document.createDocumentFragment(),_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}),place:new Place({TwoQTwocentList:twoqTwocentList}),tqevent:new Event(mtqDetailUI)});mtqDetailUI.template='<div class="twocent-detail"><div class="header blue-dark"><span data-tqdetail="bind: setHeader, author"></span></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-tqdetail="bind:setAvatar, author"></div><span class="author" data-tqdetail="bind:setAuthor,username"></span><span class="commentlbl" data-tqdetail="bind: setWrotelbl, author"></span><p data-tqdetail="bind:innerHTML,question"></p><span class="date" data-tqdetail="bind:date, creation_date"></span></div><div class="detail-body"></div><div class="detail-footer"><div class="tcbutton" data-tqevent="listen:mousedown, press; listen: mouseup, write"></div><div class="tcreplies" data-tqdetail = "bind: displayTwocentNB, twocents"></div></div><div id="connect-writetwocents" class="invisible" data-tqdetail="bind: displayWriteTwocent, author"></div><div id="connect-twocents" class="twocents" data-tqdetail="bind: displayTwocentList, twocents" data-place="place:TwoQTwocentList"></div></div></div>';
mtqDetailUI.press=function(event,node){node.classList.add("pressed")};mtqDetailUI.write=function(event,node){node.classList.remove("pressed");document.getElementById("connect-writetwocents").classList.remove("invisible")};mtqDetailUI.hide=function hide(){document.querySelector(".detail-contents").classList.add("invisible");model.reset({})};mtqDetailUI.reset=function reset(content){model.reset(content.value);twocentWriteUI.reset(model.get("_id"));twoqTwocentList.reset(model.get("_id"));domWrite=mtqDetailUI.dom.querySelector("#connect-writetwocents");twocentWriteUI.place(domWrite)};mtqDetailUI.place(document.createDocumentFragment());return mtqDetailUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256,"../../twocents/twocentlist":236,"../../twocents/writetwocent":238}],190:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../services/map"),Config=require("../../../services/config"),Store=emily.Store,Model=olives["Bind.plugin"],UIPlugin=olives["Place.plugin"],Delegate=amy.DelegatePlugin,Stack=amy.StackPlugin,Control=amy.ControlPlugin,MTCDetailStack=require("./mtc-stack"),TwoQList=require("./twoqlist"),New2Q=require("../../../services/new2q");module.exports=function MyTwocentsConstructor(){var myTwocentUI=new Widget,mtcStack=new Stack,mtcControl=new Control(myTwocentUI),mtcDetails=new MTCDetailStack,mytwoq,contacttwoq,btns=[{name:"#mytwoq",active:true},{name:"#contacttwoq",active:false},{name:"#mytwoc",active:false}],twoQButtons=new Store(btns),mtcTools=new Store({view:"#mytwoq"}),contactList=new Store([]),user=Config.get("user"),connections=user.get("connections"),labels=Config.get("labels"),db=Config.get("db");myTwocentUI.seam.addAll({labels:new Model(labels),twoqbuttons:new Model(twoQButtons,{setBg:function(name){switch(name){case"#mytwoq":this.classList.add("mytwoq");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.classList.add("mytwoc");break;default:break}},setActive:function(active){active?this.classList.add("pushed"):this.classList.remove("pushed")}}),mtctools:new Model(mtcTools,{setVisible:function(view){this.getAttribute("name")===view?this.classList.remove("invisible"):this.classList.add("invisible")},setLegend:function(view){switch(view){case"#mytwoq":this.innerHTML=labels.get("mytwoquestions");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.innerHTML=labels.get("mytwocents");break;default:break}},updateLegend:function(contact){if(contact&&mtcTools.get("view")==="#contacttwoq"){this.innerHTML=labels.get("twoqprefix")+contact+labels.get("twoqsuffix")}}}),auto:new Model(contactList),mtcliststack:mtcStack,mtcdetails:new UIPlugin({mtcDetails:mtcDetails}),mtccontrol:mtcControl,mtcevent:new Delegate(myTwocentUI)});myTwocentUI.template='<div id="connect-tc"><div id="mtc-list"><div class="header blue-light"><span data-labels="bind: innerHTML, mtcheadertitle"></span><div class="option right" data-mtcevent="listen: mousedown, plus"></div></div><ul class="twoqbuttons" data-twoqbuttons="foreach"><li data-twoqbuttons="bind: setBg,name; bind:setActive, active" data-mtcevent="listen:mousedown, selectView; listen: mouseup, showView"></li></ul><div class="selectcontact" name = "#contacttwoq" data-mtctools="bind:setVisible, view"><legend>Select a contact</legend><input class="search" data-mtcevent="listen:mousedown, updateAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl" data-mtctools = "bind:value, contact"><div class="rightcaret" data-mtcevent="listen: mousedown, updateAutoContact"></div><div class = "autocontact invisible"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-mtcevent="listen:mousedown, highlightContact; listen:mouseup, selectContact"></li></ul></div></div><legend data-mtctools="bind:setLegend, view; bind: updateLegend, contact"></legend><input name="#mytwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: input, search"><input name="#contacttwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><input name="#mytwoc" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><div data-mtcliststack="destination" data-mtccontrol="radio:li,selected,mousedown,selectStart"></div></div><div id="mtc-detail" data-mtcdetails="place:mtcDetails" class="details"></div></div>';myTwocentUI.place(Map.get("connect-twocents"));myTwocentUI.plus=function(){New2Q.reset()};myTwocentUI.selectView=function(event,node){var id=node.getAttribute("data-twoqbuttons_id");twoQButtons.loop(function(v,i){i===parseInt(id)?twoQButtons.update(i,"active",true):twoQButtons.update(i,"active",false)});mtcTools.set("view",twoQButtons.get(id).name)};myTwocentUI.showView=function(event,node){var id=node.getAttribute("data-twoqbuttons_id");switch(twoQButtons.get(id).name){case"#mytwoq":mtcStack.getStack().show("#mytwoq");mtcDetails.setView("#defaultPage");break;case"#contacttwoq":mtcStack.getStack().show("#contacttwoq");mtcDetails.setView("#defaultPage");break;case"#mytwoc":mtcStack.getStack().show("#blank");mtcDetails.setView("2C");break}};myTwocentUI.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),clc,vlc,dom=document.getElementById("mtc-list"),auto=dom.querySelector(".autocontact");if(auto.classList.contains("invisible"))auto.classList.remove("invisible");if(event.keyCode===8){node.value=""}if(!node.value||node.value===""){arr=[];for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){arr.push({contact:connections[i]})}}contactList.reset(arr)}else{vlc=node.value.toLowerCase();for(i=arr.length-1;i>=0;i--){clc=arr[i].contact.username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}contactList.reset(arr)}if(event.keyCode===13){if(node.value===""){mtcStack.getStack().show("#blank");mtcDetails.getStack().show("defaultPage")}else{if(contactList.count()){mtcTools.set("contact",contactList.get(0).contact.username);contacttwoq.resetQuery({key:'"'+contactList.get(0).contact.userid+'"',descending:true}).then(function(){var store=contacttwoq.getModel(),node;if(store.count()){mtcStack.getStack().show("#contacttwoq");mtcDetails.reset("2Q",store.get(0));node=contacttwoq.dom.querySelector("li[data-twoqlist_id='0']");mtcControl.init(node);node.classList.add("selected");mtcDetails.reset("2Q",store.get(0))}else{mtcStack.getStack().show("#blank");mtcDetails.reset("default")}})}else{mtcStack.getStack().show("#blank");mtcDetails.reset("default")}}}};myTwocentUI.highlightContact=function(event,node){node.classList.add("highlighted")};myTwocentUI.selectContact=function(event,node){var idx=node.getAttribute("data-auto_id"),dom=document.getElementById("mtc-list"),auto=dom.querySelector(".autocontact");node.classList.remove("highlighted");mtcTools.set("contact",contactList.get(idx).contact.username);auto.classList.add("invisible");contacttwoq.resetQuery({key:'"'+contactList.get(idx).contact.userid+'"',descending:true}).then(function(){var store=contacttwoq.getModel(),node;if(store.count()){mtcStack.getStack().show("#contacttwoq");mtcDetails.reset("2Q",store.get(0));node=contacttwoq.dom.querySelector("li[data-twoqlist_id='0']");mtcControl.init(node);node.classList.add("selected");mtcDetails.reset("2Q",store.get(0))}else{mtcStack.getStack().show("#blank");mtcDetails.reset("default")}})};myTwocentUI.selectStart=function(event,node){var store=mtcStack.getStack().getCurrentScreen().getModel(),id;if(mtcTools.get("view")==="#mytwoq"||mtcTools.get("view")==="#contacttwoq"){id=event.target.getAttribute("data-twoqlist_id")||event.target.getAttribute("data-twoqsearch_id");mtcDetails.reset("2Q",store.get(id))}};myTwocentUI.search=function(event,node){mtcStack.getStack().getCurrentScreen().search(node.value)};myTwocentUI.reset=function reset(){var i;twoQButtons.reset(btns);mtcTools.set("view","#mytwoq");contactList.reset([]);connections=user.get("connections");for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user"){contactList.alter("push",{contact:connections[i],selected:false})}}mytwoq.resetQuery({key:'"'+user.get("_id")+'"',descending:true}).then(function(){mtcStack.getStack().show("#mytwoq");mtcDetails.reset("default")})};Config.get("observer").watch("display-twoq",function(id,userid){contacttwoq.resetQuery({key:'"'+userid+'"',descending:true}).then(function(){var store=contacttwoq.getModel(),index,node;mtcStack.getStack().show("#contacttwoq");mtcTools.set("view","#contacttwoq");twoQButtons.loop(function(v,i){v.name==="#contacttwoq"?twoQButtons.update(i,"active",true):twoQButtons.update(i,"active",false)});store.loop(function(v,i){if(v.id===id){index=i;mtcTools.set("contact",v.value.username)}});node=contacttwoq.dom.querySelector("li[data-twoqlist_id='"+index+"']");mtcControl.init(node);node.classList.add("selected");mtcDetails.reset("2Q",store.get(index))})});Config.get("observer").watch("display-twoc",function(){mtcStack.getStack().show("#blank");mtcTools.set("view","#mytwoc");twoQButtons.loop(function(v,i){v.name==="#mytwoc"?twoQButtons.update(i,"active",true):twoQButtons.update(i,"active",false)});mtcDetails.setView("2C")});for(i=0,l=connections.length;i<l;i++){if(connections[i].type==="user")contactList.alter("push",{contact:connections[i],selected:false})}mytwoq=new TwoQList("user",db,"questions","_view/questionsbyauthor",{key:'"'+user.get("_id")+'"',descending:true});contacttwoq=new TwoQList("contact",db,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:true});blank=new TwoQList("user",db,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:true});mtcStack.getStack().add("#mytwoq",mytwoq);mtcStack.getStack().add("#contacttwoq",contacttwoq);mtcStack.getStack().add("#blank",blank);contacttwoq.init();blank.init();mytwoq.init().then(function(){mtcStack.getStack().show("#mytwoq");mtcDetails.init("default")});return myTwocentUI}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"../../../services/new2q":251,"./mtc-stack":188,"./twoqlist":191}],191:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),ActionBar=require("../../../services/actionbar"),Promise=emily.Promise;function TwoQListConstructor($type,$db,$design,$view,$query){var _store=new CouchDBView([]),_searchList=new Store([]),display=false,className="",currentBar=null,_options={db:$db,view:$view,design:$design,query:{descending:true}},labels=Config.get("labels"),widget=this;_store.setTransport(Config.get("transport"));$type==="contact"?className="contacttwoqlist":className="";this.template='<div><ul class="twoq-list '+className+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+className+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>';this.seam.addAll({twoqlist:new Model(_store,{date:function date(date){date?this.innerHTML=Utils.formatDate(date):this.innerHTML=""},showReplies:function showReplies(twocents){var nb;if(twocents){nb=twocents.length}if(nb===0){this.innerHTML=labels.get("noreplyyet")}else if(nb===1){this.innerHTML=nb+" "+labels.get("showonetcreply")}else if(nb>1){this.innerHTML=nb+" "+labels.get("showtcrepliesafter")}},setAvatar:function setAvatar(author){var _ui,_frag;if(author){_frag=document.createDocumentFragment();_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setVisibility:function(visibility){visibility&&visibility==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new Model(_searchList,{date:function date(date){date?this.innerHTML=Utils.formatDate(date):this.innerHTML=""},showReplies:function showReplies(twocents){var nb;if(twocents){nb=twocents.length}if(nb===0){this.innerHTML=labels.get("noreplyyet")}else if(nb===1){this.innerHTML=nb+" "+labels.get("showonetcreply")}else if(nb>1){this.innerHTML=nb+" "+labels.get("showtcrepliesafter")}},setAvatar:function setAvatar(author){var _ui,_frag;if(author){_frag=document.createDocumentFragment();_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setVisibility:function(visibility){visibility&&visibility==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new Event(this)});this.getModel=function(){var ret,search;search=!widget.dom.querySelector(".twoq-searchlist").classList.contains("invisible");search?ret=_searchList:ret=_store;return ret};this.resetQuery=function(query){var promise=new Promise;_options.query=query;_store.unsync();_store.reset([]);widget.hideSearch();_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){promise.fulfill()});return promise};this.setStart=function(event,node){currentBar&&currentBar.hide()};this.showActionBar=function(event,node){var id=node.getAttribute("data-twoqlist_id"),display=false,frag,dom=document.getElementById("mtc-list");if(currentBar&&currentBar.getParent()===node){display=true}if(!dom.classList.contains("mosaic")&&!display){currentBar=new ActionBar("2Q",node,_store.get(id).value);frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};this.showSearch=function showSearch(){var search=document.querySelector(".twoq-searchlist"),list=document.querySelector(".twoq-list");if(search&&search.classList.contains("invisible")){list.classList.add("invisible");search.classList.remove("invisible")}};this.hideSearch=function hideSearch(){var search=this.dom.querySelector(".twoq-searchlist"),list=this.dom.querySelector(".twoq-list");if(search&&!search.classList.contains("invisible")){list.classList.remove("invisible");search.classList.add("invisible")}};this.search=function search(text){_searchList.reset([]);if(text.toLowerCase()){this.showSearch();_store.loop(function(v,i){if(JSON.stringify(v).search(text)>-1){_searchList.alter("push",v)}})}else{this.hideSearch()}};if($query){_options.query=$query}this.init=function init(){var promise=new Promise;_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){promise.fulfill()});return promise}}module.exports=function TwoQListFactory($type,$db,$design,$view,$query){TwoQListConstructor.prototype=new Widget;return new TwoQListConstructor($type,$db,$design,$view,$query)}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/actionbar":240,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256}],192:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Stack=amy.StackPlugin,Config=require("../../../services/config"),Store=emily.Store,AboutIdeafy=require("./aboutideafy"),FAQ=require("./faq"),UserGuide=require("./userguide"),Tutorials=require("./tutorials"),Support=require("./support"),EULA=require("./eula");module.exports=function AboutConstructor(){var aboutUI=new Widget,aboutStack=new Stack,labels=Config.get("labels"),menu=[{name:"#about",label:labels.get("aboutIdeafy"),currentUI:false},{name:"#faq",label:labels.get("faq"),currentUI:false},{name:"#userguide",label:labels.get("userguide"),currentUI:false},{name:"#tutorials",label:labels.get("tutorials"),currentUI:false},{name:"#support",label:labels.get("support"),currentUI:false},{name:"#eula",label:labels.get("eula"),currentUI:false}],aboutMenu=new Store(menu);aboutUI.seam.addAll({label:new Model(labels),aboutmenu:new Model(aboutMenu,{setCurrent:function(currentStep){currentStep?this.classList.add("pressed"):this.classList.remove("pressed")}}),aboutstack:aboutStack,aboutevent:new Event(aboutUI)});aboutUI.template='<div id="dashboard-about"><div class="header blue-dark"><span data-label="bind:innerHTML, aboutlbl"></span></div><div class = "progressbar"><ul id = "aboutmenu" class="steplist" data-aboutmenu="foreach"><li class="step" data-aboutmenu="bind: innerHTML, label; bind:setCurrent, currentUI" data-aboutevent="listen: mousedown, changeDisplay"></li></ul></div><div id="aboutstack" data-aboutstack="destination"></div></div>';aboutUI.place(Map.get("dashboard-about"));aboutUI.changeDisplay=function changeDisplay(event,node){var id=node.getAttribute("data-aboutmenu_id");aboutUI.show(aboutMenu.get(id).name,id)};aboutUI.show=function show(name,id){aboutMenu.loop(function(v,i){aboutMenu.update(i,"currentUI",false)});aboutMenu.update(id,"currentUI",true);if(name==="#support")aboutStack.getStack().get(name).refresh();aboutStack.getStack().show(aboutMenu.get(id).name)};aboutStack.getStack().add("#about",new AboutIdeafy);aboutStack.getStack().add("#faq",new FAQ);aboutStack.getStack().add("#userguide",new UserGuide);aboutStack.getStack().add("#tutorials",new Tutorials);aboutStack.getStack().add("#support",new Support);aboutStack.getStack().add("#eula",new EULA);aboutStack.getStack().show("#about");aboutMenu.update(0,"currentUI",true);return aboutUI}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"./aboutideafy":193,"./eula":194,"./faq":195,"./support":196,"./tutorials":197,"./userguide":198}],193:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Store=emily.Store;module.exports=function AboutIdeafyConstructor(){var aboutIdeafy=new Widget,labels=Config.get("labels"),credits=new Store([{name:labels.get("solene"),contrib:labels.get("contribsolene")},{name:labels.get("oliviers"),contrib:labels.get("contribscherrer")},{name:labels.get("vincent"),contrib:labels.get("contribvincent")}]);aboutIdeafy.seam.addAll({labels:new Model(labels),credits:new Model(credits)});aboutIdeafy.template='<div class="aboutcontent"><legend data-labels="bind:innerHTML, aboutlbl"></legend><p data-labels="bind:innerHTML, ideafydesc"></p><legend data-labels="bind:innerHTML, about-taiaut"></legend><p data-labels="bind:innerHTML, taiautdesc"></p><legend data-labels="bind: innerHTML, credits"></legend><p><ul data-credits="foreach"><li><span class="contributor" data-credits="bind:innerHTML, name"></span><span class="contribution" data-credits="bind:innerHTML, contrib"></span></li></ul></p></div>';return aboutIdeafy}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],194:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],CouchDBDocument=CouchDBTools.CouchDBDocument,Store=emily.Store;module.exports=function EULAConstructor(){var eula=new Widget,user=Config.get("user"),model=new Store;eula.seam.add("eula",new Model(model));eula.template='<div class="aboutcontent"><h4 data-eula = "bind:innerHTML, title"></h4><div data-eula="bind:innerHTML, body"></div></div>';eula.fetch=function fetch(lang){var cdb=new CouchDBDocument;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),"EULA-PC").then(function(){if(cdb.get("default_lang")===lang||!cdb.get("translations")[lang]){model.set("title",cdb.get("title"));model.set("body",cdb.get("body"))}else{model.set("title",cdb.get("translations")[lang].title);model.set("body",cdb.get("translations")[lang].body)}cdb.unsync()})};eula.fetch(user.get("lang"));user.watchValue("lang",function(){eula.fetch(user.get("lang"))});return eula}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],195:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),CouchDBView=CouchDBTools.CouchDBView,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store;module.exports=function FAQConstructor(){var FAQ=new Widget,cdb=new CouchDBView,user=Config.get("user");faqlist=new Store([]);FAQ.seam.addAll({faq:new Model(faqlist),faqevent:new Event(FAQ)});FAQ.template='<div class="aboutcontent"><ul data-faq="foreach"><li><legend data-faq="bind:innerHTML, question"></legend><p data-faq="bind: innerHTML, response"></p></li></ul></div>';cdb.setTransport(Config.get("transport"));FAQ.fetch=function fetch(lang){cdb.unsync();cdb.reset([]);faqlist.reset([]);cdb.sync(Config.get("db"),"about","_view/faq").then(function(){cdb.loop(function(v,i){if(v.value.default_lang===lang||!v.value.translations[lang]){faqlist.alter("push",v.value)}else{faqlist.alter("push",v.value.translations[lang])}});cdb.unsync()})};FAQ.fetch(user.get("lang"));user.watchValue("lang",function(){FAQ.fetch(user.get("lang"))});return FAQ}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],196:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument;module.exports=function SupportConstructor(){var support=new Widget,labels=Config.get("labels"),user=Config.get("user"),model=new Store({body:"",result:""}),supportMSG=new Store({}),maintenanceMSG=new Store({}),supportCDB=new CouchDBDocument,maintenanceCDB=new CouchDBDocument;supportCDB.setTransport(Config.get("transport"));maintenanceCDB.setTransport(Config.get("transport"));support.seam.addAll({labels:new Model(labels),support:new Model(model),news:new Model(supportMSG,{setVisible:function(active){active?this.classList.remove("invisible"):this.classList.add("invisible")}}),maintenance:new Model(maintenanceMSG,{setVisible:function(active){active?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(date){this.innerHTML=new Date(date).toString()}}),supportevent:new Event(support)});support.template='<div class="aboutcontent"><p class="supportmsg invisible" data-news="bind:setVisible, active; bind:innerHTML, content"></p><legend class="support" data-labels="bind:innerHTML, supportlegend"></legend><textarea class="input" data-labels="bind:placeholder, supportplaceholder" data-support="bind: value, body"></textarea><span data-support="bind:innerHTML, result"></span><div class="cancel" data-labels="bind: innerHTML, cancellbl" data-supportevent="listen: mousedown, press; listen: mouseup, cancel"></div><div class="send" data-labels="bind: innerHTML, sendlbl" data-supportevent="listen: mousedown, press; listen: mouseup, send"></div><div class="maintenancemsg invisible" data-maintenance="bind:setVisible,active"><legend data-labels="bind:innerHTML, schedmaintenance"></legend><p><span data-labels="bind: innerHTML, nextmaintenance"></span><span class="dateandtime" data-maintenance="bind:setDate, date">Sunday April 7th 6:00 EST</span><br/><span data-maintenance="bind:innerHTML, comment"></span></p></div><div class="supportus"><legend data-labels="bind: innerHTML, twoway"></legend><p data-labels="bind: innerHTML, supportusintro"><ul><li><h4 data-labels="bind: innerHTML, asanideafyer"></h4><p data-labels="bind: innerHTML, ideafyerhelp"></p></li><li><h4 data-labels="bind: innerHTML, asanexec"></h4><p data-labels="bind: innerHTML, exechelp"></p></li><li><h4 data-labels="bind: innerHTML, asadev"></h4><p data-labels="bind: innerHTML, devhelp"></p></li><li><h4 data-labels="bind: innerHTML, asaninvest"></h4><p data-labels="bind: innerHTML, investhelp"></p></li></ul></p></div></div>';support.send=function(event,node){node.classList.remove("pressed");support.sendRequest(model.get("body"))};support.cancel=function(event,node){node.classList.remove("pressed");model.set("body","")};support.press=function(event,node){node.classList.add("pressed")};support.sendRequest=function sendRequest(request){var json={},now=new Date;json.request=request;json.date=now.getTime();json.userid=Config.get("user").get("_id");Config.get("transport").request("Support",json,function(result){result==="ok"?model.set("result",labels.get("requestsent")):model.set("result",result);setTimeout(function(){model.set("result","");model.set("body","")},3e3)})};support.setSupportMSG=function setSupportMSG(lang){supportCDB.sync(Config.get("db"),"SUPPORTMSG").then(function(){if(supportCDB.get("lang")===lang||!supportCDB.get("translations")[lang]){supportMSG.reset(JSON.parse(supportCDB.toJSON()))}else{supportMSG.reset(supportCDB.get("translations")[lang])}supportCDB.unsync()})};support.setMaintenanceMSG=function setMaintenanceMSG(lang){maintenanceCDB.sync(Config.get("db"),"MAINTENANCE").then(function(){if(maintenanceCDB.get("lang")===lang||!maintenanceCDB.get("translations")[lang]){maintenanceMSG.reset(JSON.parse(maintenanceCDB.toJSON()))}else{maintenanceMSG.reset(maintenanceCDB.get("translations")[lang])}maintenanceCDB.unsync()})};support.setSupportMSG(user.get("lang"));support.setMaintenanceMSG(user.get("lang"));support.refresh=function refresh(){support.setSupportMSG(user.get("lang"));support.setMaintenanceMSG(user.get("lang"))};user.watchValue("lang",function(){support.setSupportMSG(user.get("lang"),"SUPPORTMSG");support.setMaintenanceMSG(user.get("lang"),"MAINTENANCE")});supportCDB.watchValue("active",function(){support.setSupportMSG(user.get("lang"))});maintenanceCDB.watchValue("active",function(){support.setMaintenanceMSG(user.get("lang"))});return support}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],197:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Store=emily.Store;module.exports=function TutorialsConstructor(){var tutorials=new Widget,labels=Config.get("labels"),tuto=[{name:"brainstormtutorial",src:Config.get("location")+"/tuto04.m4v"}],store=new Store(tuto);tutorials.seam.addAll({labels:new Model(labels),tuto:new Model(store,{setName:function(name){this.innerHTML=labels.get(name)}})});tutorials.template='<div class="aboutcontent"><ul data-tuto="foreach"><li><legend data-tuto="bind: setName, name"></legend><div class="videocontent"><video width = "640" height="480" controls="controls"><source data-tuto="bind:src,src" type="video/mp4" /></video></div></li></ul></div>';return tutorials}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],198:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),CouchDBView=CouchDBTools.CouchDBView,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store;module.exports=function UserGuideConstructor(){var userGuide=new Widget,cdb=new CouchDBView,user=Config.get("user"),labels=Config.get("labels"),howTolist=new Store([]);userGuide.seam.addAll({label:new Model(labels),howto:new Model(howTolist),howtoevent:new Event(userGuide)});userGuide.template='<div class="aboutcontent"><div id="userguidetoc"><legend data-label="bind:innerHTML, toc"></legend><ul data-howto="foreach"><li><span data-howto="bind: innerHTML, title" data-howtoevent="listen: mousedown, press; listen:mouseup, goto"></span></li></ul></div><br/><ul data-howto="foreach"><li data-howto="bind:id, _id"><legend data-howto="bind:innerHTML, title"></legend><p data-howto="bind: innerHTML, body"></p><span class="backtotop" data-label="bind:innerHTML, backtotop" data-howtoevent="listen: mousedown, backToTop"></span></li></ul></div>';userGuide.press=function(event,node){node.setAttribute("style","font-weight: bold;")};userGuide.goto=function(event,node){var idx=node.getAttribute("data-howto_id"),id=howTolist.get(idx)._id;node.setAttribute("style","font-weight: normal;");document.getElementById(id).scrollIntoView()};userGuide.backToTop=function(event,node){document.getElementById("userguidetoc").scrollIntoView()};cdb.setTransport(Config.get("transport"));userGuide.fetch=function fetch(lang){cdb.reset([]);howTolist.reset([]);cdb.sync(Config.get("db"),"about","_view/howto").then(function(){cdb.loop(function(v,i){if(v.value.default_lang===lang||!v.value.translations[lang]){howTolist.alter("push",v.value)}else{howTolist.alter("push",v.value.translations[lang])}});cdb.unsync()})};userGuide.fetch(user.get("lang"));user.watchValue("lang",function(){userGuide.fetch(user.get("lang"))});return userGuide}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245}],199:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),amy=require("../../libs/amy2"),Widget=olives.OObject,Stack=amy.StackPlugin,Map=require("../../services/map"),Menu=require("../../services/submenu"),Profile=require("./profile/profile"),Settings=require("./settings/settings"),About=require("./about/about"),Config=require("../../services/config");module.exports=function DashboardConstructor(){var _widget=new Widget,_stack=new Stack,_profile,_settings,_about,_user=Config.get("user"),_observer=Config.get("observer"),setView=function setView(name){_stack.getStack().show(name)},_menu;_widget.seam.add("dashboardstack",_stack);_widget.template='<div id="dashboard"><div id="dashboard-menu"></div><div class="stack" data-dashboardstack="destination"></div></div>';_widget.place(Map.get("dashboard"));_widget.showMenu=function showMenu(){_menu.toggleActive(true)};_widget.hideMenu=function hideMenu(){_menu.toggleActive(false)};_widget.reset=function reset(){_menu.reset();_profile.reset();_settings.reset()};_menu=new Menu(_widget.dom.querySelector("#dashboard-menu"),setView);_menu.toggleActive(false);_profile=new Profile;_settings=new Settings;_about=new About;_stack.getStack().add("#profile",_profile);_stack.getStack().add("#settings",_settings);
_stack.getStack().add("#about",_about);if(_user.get("resetPWD")){_stack.getStack().show("#settings")}else{_stack.getStack().show("#profile")}Config.get("observer").watch("display-tutorials",function(){_menu.setWidget("#about");_stack.getStack().get("#about").show("#tutorials")});Config.get("observer").watch("show-about",function(){_menu.setWidget("#about");_stack.getStack().get("#about").show("#userguide")});return _widget}},{"../../libs/amy2":75,"../../libs/emily":97,"../../libs/olives":141,"../../services/config":245,"../../services/map":249,"../../services/submenu":253,"./about/about":192,"./profile/profile":203,"./settings/settings":204}],200:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Store=emily.Store,Promise=emily.Promise,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils");var calendar=new Widget,cal=new Store([]),labels=Config.get("labels"),user=Config.get("user");calendar.template='<div class="calendar"></div>';calendar.seam.addAll({labels:new Model(labels),model:new Model(cal),calevent:new Event(calendar)});calendar.add=function add(entry){var i,l,_cal;if(!entry.date||!entry.docId||!entry.type)console.log("error : wrong calendar entry format");user.get("cal")&&user.get("cal").length?_cal=user.get("cal").concat():_cal=[];if(_cal.length===0)_cal.push(entry);else{for(i=0,l=_cal.length;i<l;i++){if(_cal[i].date<=entry.date)break}_cal.splice(i,1,entry)}user.set("cal",_cal);return user.upload()};calendar.init=function(){CAL=this};user.watchValue("cal",function(){cal.reset(user.get("cal"))});module.exports=calendar},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/utils":256}],201:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Avatar=require("../../../services/avatar"),Utils=require("../../../services/utils"),Store=emily.Store,Spinner=require("../../../libs/spin.min"),LocalStore=olives.LocalStore;module.exports=function EditProfileConstructor(){var editProfile=new Widget,user=Config.get("user"),profile=new Store,avatarList=[{name:"azur",file:"img/avatars/deedee0.png",selected:false},{name:"blue",file:"img/avatars/deedee1.png",selected:false},{name:"green",file:"img/avatars/deedee2.png",selected:false},{name:"grey",file:"img/avatars/deedee3.png",selected:false},{name:"orange",file:"img/avatars/deedee4.png",selected:false},{name:"red",file:"img/avatars/deedee5.png",selected:false},{name:"yellow",file:"img/avatars/deedee6.png",selected:false}],defaultAvatars=new Store(avatarList),updates={},progress=new Store({status:null}),labels=Config.get("labels"),spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:360}).spin(),MIN_WIDTH=80,MIN_HEIGHT=80,clearCanvas=function(canvas){var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height)},resizeImage=function(img){var _width,_height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");_width=img.width;_height=img.height;if(_width<_height){_height*=MIN_WIDTH/_width;_width=MIN_WIDTH}else{_width*=MIN_HEIGHT/_height;_height=MIN_HEIGHT}canvas.width=_width;canvas.height=_height;ctx.drawImage(img,0,0,_width,_height);return canvas.toDataURL("image/png")},cropImage=function(dataURL){var image=new Image,canvas=document.createElement("canvas"),dest=document.getElementById("avatarcanvas"),ctx=canvas.getContext("2d"),dw=dest.scrollWidth,dh=dest.scrollHeight,sx,sy;image.src=dataURL;setTimeout(function(){canvas.width=dw;canvas.height=dh;sx=Math.floor(Math.max(0,(image.width-dw)/2));sy=Math.floor(Math.max(0,(image.height-dh)/2));ctx.drawImage(image,sx,sy,dw,dh,0,0,dw,dh);profile.set("avatar",canvas.toDataURL("image/png"))},300)},uploadAvatar=function(canvas){var url="/upload",fd=new FormData;fd.append("type","avatar");fd.append("filename",updates.picture_file);fd.append("img",profile.get("avatar"));Utils.uploadFile(url,fd,progress,function(result){if(result.response!=="ok"){console.log(result)}})};editProfile.seam.addAll({label:new Model(labels),avatars:new Model(defaultAvatars,{setPic:function(file){this.setAttribute("style","background-image: url('"+file+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setChecked:function(checked){checked?this.innerHTML="&#10003;":this.innerHTML=""}}),progress:new Model(progress,{showProgress:function(status){var width=0;if(status){width=Math.floor(status/100*80)}this.setAttribute("style","width:"+width+"px;");if(status===100){this.innerHTML=labels.get("uploadcomplete")}else this.innerHTML=""}}),profile:new Model(profile,{setAvatar:function(avatar){this.setAttribute("style","background-image: url('"+avatar+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setDay:function(birthdate){if(birthdate[2])this.value=birthdate[2]},setMonth:function(birthdate){var month=birthdate[1]||0;this.value=this.options[month].innerHTML},setYear:function(birthdate){if(birthdate[0])this.value=birthdate[0]},setFamilyStatus:function(couple){if(couple||couple===0){this.selectedIndex=couple}},setChildren:function(children){if(children||children===0){this.selectedIndex=children}},setSituation:function(situation){if(situation||situation===0){this.selectedIndex=situation}},setLeisureName:function(leisure){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(leisure[i]&&name.search(i)>0)node.value=leisure[i].name})},setLeisureDesc:function(leisure){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(leisure[i]&&name.search(i)>0)node.value=leisure[i].comment})},setInterestName:function(interests){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(interests[i]&&name.search(i)>0)node.value=interests[i].name})},setInterestDesc:function(interests){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(interests[i]&&name.search(i)>0)node.value=interests[i].comment})}}),editprofileevent:new Event(editProfile)});editProfile.template='<div><div class = "setavatar"><canvas id ="avatarcanvas" class="currentavatar" data-profile="bind:setAvatar, avatar" data-editprofileevent="listen:mousedown, changeAvatar"></canvas><div id="rotate" class="invisible" data-editprofileevent="listen:mousedown, rotateAvatar"></div><div id="changeavatar" class="invisible"><div class="avatarcache"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editprofileevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editprofileevent="listen: mousedown, press; listen: mouseup, release"></div></span><p data-label="bind:innerHTML, selectavatar"></p><ul class="defaultlist" data-avatars="foreach"><li><div class="defaultAvatar" data-avatars="bind: setPic, file"></div><div class="checkbox" data-avatars="bind: setChecked, selected" data-editprofileevent="listen: mouseup, setDefaultAvatar"></div></li></ul></div></div><form class="profileinfo"><div class = "username"><div class = "firstname"><label data-label="bind:innerHTML, firstnameplaceholder"></label><input class="input" name="firstname" type="text" data-profile="bind: value, firstname" data-editprofileevent="listen: input, updateField"></div><div class = "lastname"><label data-label="bind:innerHTML, lastnameplaceholder"></label><input class="input" type="text" name="lastname" data-profile="bind: value, lastname" data-editprofileevent="listen: input, updateField"></div></div><label data-label="bind:innerHTML, profileintro"></label><input class="input" name="intro" type="text" data-profile="bind:value, intro" data-label="bind:placeholder, shortprofiledesc" data-editprofileevent="listen: input, updateField"><label data-label="bind:innerHTML, dob"></label><div class="dob"><input class="day" name="day" type="text" data-label="bind:placeholder, day" data-profile="bind: setDay, birthdate" data-editprofileevent="listen:input, updateDate"><select name="month" data-profile="bind: setMonth, birthdate" data-editprofileevent="listen:change, updateDate"><option data-label="bind:innerHTML, jan"></option><option data-label="bind:innerHTML, feb"></option><option data-label="bind:innerHTML, mar"></option><option data-label="bind:innerHTML, apr"></option><option data-label="bind:innerHTML, may"></option><option data-label="bind:innerHTML, jun"></option><option data-label="bind:innerHTML, jul"></option><option data-label="bind:innerHTML, aug"></option><option data-label="bind:innerHTML, sep"></option><option data-label="bind:innerHTML, oct"></option><option data-label="bind:innerHTML, nov"></option><option data-label="bind:innerHTML, dec"></option></select><input class="year" name="year" type="text" data-label="bind:placeholder,year" data-profile="bind: setYear, birthdate" data-editprofileevent="listen:input, updateDate"></div><div class="postal"><label class="streetaddress" data-label="bind:innerHTML, mailaddress"></label><input class="streetaddress input" name="street1" type="text" data-label="bind:placeholder, street" data-profile="bind:value, address.street1" data-editprofileevent="listen:input, updateAddress"><div class="city"><label data-label="bind:innerHTML, city"></label><input class="input city" name="city" type="text" data-profile="bind:value, address.city" data-editprofileevent="listen:input, updateAddress"></div><div class="zipstate"><div class="state"><label data-label="bind:innerHTML, state"></label><input class="input" name="state" placeholder="" type="text" data-profile="bind:value, address.state" data-editprofileevent="listen:input, updateAddress"></div><div class="zip"><label data-label="bind:innerHTML, zip"></label><input class="input" name="zip" placeholder="" type="text" data-profile="bind:value, address.zip" data-editprofileevent="listen:input, updateAddress"></div></div><label data-label="bind:innerHTML, country"></label><input class="input" name="country" type="text" data-profile="bind:value, address.country" data-editprofileevent="listen:input, updateAddress"></div><label data-label="bind:innerHTML, myfamily"></label><div class="family"><select class="status" name="couple" data-profile="bind: setFamilyStatus, family.couple" data-editprofileevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select><select class="children" name="children" data-profile="bind: setChildren, family.children" data-editprofileevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><label data-label="bind:innerHTML, children"></label></div><label data-label="bind:innerHTML, myoccupation"></label><div class="job"><select class="status" name="situation" data-profile="bind: setSituation, occupation.situation" data-editprofileevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select><div class="jobdesc"><label data-label="bind:innerHTML, jobtitle"></label><input class="input" type="text" name="job" data-profile="bind:value, occupation.job" data-label="bind:placeholder, jobtitle" data-editprofileevent="listen:input, updateJob"></div><div class="org"><label data-label="bind:innerHTML, organization"></label><input class="input" name="organization" type="text" data-profile="bind:value, occupation.organization" data-label="bind:placeholder,organization" data-editprofileevent="listen:input, updateJob"></div></div></form><form class="addtlinfo"><legend data-label="bind:innerHTML, socialnwlbl"></legend><ul class="socialnw"><li class="fb"><input class="input" type="text" name="facebook" data-profile="bind: value, facebook" data-editprofileevent="listen: input, updateField"></li><li class="gp"><input class="input" name="gplus" type="text" data-profile="bind: value, gplus" data-editprofileevent="listen: input, updateField"></li><li class="lin"><input class="input" name="linkedin" type="text" data-profile="bind: value, linkedin" data-editprofileevent="listen: input, updateField"></li><li class="tw"><input class="input" name="twitter" type="text" data-profile="bind: value, twitter" data-editprofileevent="listen: input, updateField"></li></ul><legend data-label="bind:innerHTML, hobbieslbl"></legend><label data-label="bind:innerHTML, name"></label><label class="description" data-label="bind:innerHTML, comment"></label><input name="leisure0" class="input" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input" type="text"  data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input class="input" name="leisure2" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><label data-label="bind:innerHTML, field"></label><label class="description" data-label="bind:innerHTML, comment"></label><input class="input" name="interest0" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest1" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest2" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"></form><div class="useascharacter"></div><p class="update"><label class="cancelprofile" data-label="bind:innerHTML, cancellbl" data-editprofileevent="listen: mousedown, press; listen:mouseup, cancel"></label><label class="updateprofile" data-label="bind:innerHTML, updatelbl" data-editprofileevent="listen:mousedown, press; listen:mouseup, update"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p><div class="uploadprogress" data-progress="bind:showProgress, status"></div></div>';editProfile.init=function init($dom){editProfile.reset();editProfile.place($dom)};editProfile.selectpress=function(event,node){node.value=""};editProfile.press=function(event,node){node.classList.add("pressed")};editProfile.release=function(event,node){setTimeout(function(){node.classList.remove("pressed")},300)};editProfile.uploadnDisplay=function(event,node){var _img=new Image,_reader=new FileReader,_binaryReader=new FileReader,canvas=document.getElementById("avatarcanvas");_reader.onload=function(e){_img.src=e.target.result;setTimeout(function(){cropImage(resizeImage(_img));updates.picture_file=user.get("_id")+"_@v@t@r";document.getElementById("changeavatar").classList.add("invisible")},300)};_reader.readAsDataURL(node.files[0])};editProfile.changeAvatar=function(event,node){document.getElementById("changeavatar").classList.remove("invisible");progress.set("status",0)};editProfile.setDefaultAvatar=function(event,node){var idx=node.getAttribute("data-avatars_id");defaultAvatars.loop(function(v,i){i===parseInt(idx)?defaultAvatars.update(i,"selected",true):defaultAvatars.update(i,"selected",false)});profile.set("avatar",defaultAvatars.get(idx).file);updates.picture_file=defaultAvatars.get(idx).file;document.getElementById("changeavatar").classList.add("invisible")};editProfile.rotateAvatar=function(event,node){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image;img.src=profile.get("avatar");setTimeout(function(){canvas.width=img.width;canvas.height=img.height;ctx.translate(canvas.width/2,canvas.height/2);ctx.rotate(Math.PI/2);ctx.translate(-canvas.height/2,-canvas.width/2);ctx.drawImage(img,0,0);profile.set("avatar",canvas.toDataURL("image/png"))},300)};editProfile.reset=function reset(){profile.reset(JSON.parse(user.toJSON()));profile.set("avatar",Config.get("avatar"));defaultAvatars.reset(avatarList);updates={};if(profile.get("picture_file").search("img/avatars/deedee")>-1){defaultAvatars.loop(function(v,i){if(profile.get("picture_file").search(v.file)>-1)defaultAvatars.update(i,"selected",true)})}};editProfile.updateField=function(event,node){var prop=node.getAttribute("name");updates[prop]=node.value;profile.set(prop,node.value)};editProfile.updateDate=function(event,node){var date=profile.get("birthdate"),name=node.getAttribute("name"),value;switch(name){case"year":date[0]=node.value;break;case"month":date[1]=node.selectedIndex;break;case"day":date[2]=node.value;break}profile.set("birthdate",date);updates.birthdate=date};editProfile.updateAddress=function(event,node){var address=profile.get("address"),name=node.getAttribute("name");address[name]=node.value||"";profile.set("address",address);updates.address=address};editProfile.updateFamily=function(event,node){var name=node.getAttribute("name"),family=profile.get("family");family[name]=node.selectedIndex;profile.set("family",family);updates.family=family};editProfile.updateJob=function(event,node){var occupation=profile.get("occupation"),name=node.getAttribute("name"),value;switch(name){case"situation":occupation.situation=node.selectedIndex;break;case"job":occupation.job=node.value;break;case"organization":occupation.organization=node.value;break}updates.occupation=occupation};editProfile.updateLeisureName=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),leisure=profile.get("leisure_activities");leisure[idx].name=node.value;profile.set("leisure_activities",leisure);updates.leisure_activities=leisure};editProfile.updateLeisureDesc=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),leisure=profile.get("leisure_activities");leisure[idx].comment=node.value;profile.set("leisure_activities",leisure);updates.leisure_activities=leisure};editProfile.updateInterestName=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),interests=profile.get("interests");interests[idx].name=node.value;profile.set("interests",interests);updates.interests=interests};editProfile.updateInterestDesc=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),interests=profile.get("interests");interests[idx].comment=node.value;profile.set("interests",interests);updates.interests=interests};editProfile.press=function(event,node){node.classList.add("pressed")};editProfile.cancel=function cancel(event,node){node.classList.remove("pressed");document.querySelector(".userdetails").classList.remove("invisible");document.querySelector(".edituserdetails").classList.add("invisible")};editProfile.update=function update(event,node){var prop,changes=0;node.classList.remove("pressed");node.classList.add("invisible");spinner.spin(node.parentNode);for(prop in updates){user.set(prop,updates[prop]);changes++}if(changes){user.upload().then(function(){var local=new LocalStore;if(updates.picture_file){Config.set("avatar",profile.get("avatar"));local.sync("ideafy-data");local.set("userAvatar",Config.get("avatar"))}if(updates.picture_file&&updates.picture_file.search("img/avatars/deedee")<0){uploadAvatar();document.getElementById("rotate").classList.add("invisible")}spinner.stop();node.classList.remove("invisible");Config.get("observer").notify("profile-updated");document.querySelector(".edituserdetails").classList.add("invisible");document.querySelector(".userdetails").classList.remove("invisible")})}else{spinner.stop();node.classList.remove("invisible");document.querySelector(".userdetails").classList.remove("invisible");document.querySelector(".edituserdetails").classList.add("invisible")}};return editProfile}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256}],202:[function(require,module,exports){var olives=require("../../../libs/olives"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],CouchDBView=CouchDBTools.CouchDBView,Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),Spinner=require("../../../libs/spin.min");module.exports=function LeaderboardConstructor(){var leaderboard=new Widget,leaders=new CouchDBView([]),spinner=new Spinner({color:"#9ac9cd",lines:10,length:12,width:6,radius:10,top:328}).spin();leaderboard.template='<div><ul data-leaders="foreach"><li class="leader" data-leaders="bind:setSpotLight, value.userid"><div data-leaders="bind:setAvatar, value.userid"></div><div class="username" data-leaders="bind:innerHTML, value.username"></div><div class="distinction" data-leaders="bind:setDistinction, value.ip"></div><div class="grade" data-leaders="bind:setGrade, value.ip"></div><div class="score" data-leaders="bind: setScore, value.ip"></div></li></ul></div>';leaderboard.seam.addAll({leaders:new Model(leaders,{setSpotLight:function(userid){if(userid===Config.get("user").get("_id")){this.classList.add("userleader");this.scrollIntoView(false)}else{this.classList.remove("userleader")}},setAvatar:function(userid){var _ui,_frag;if(userid){_frag=document.createDocumentFragment();_ui=new Avatar([userid]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setGrade:function(ip){var node=this;Utils.getGrade(ip,function(result){node.setAttribute("style","background: url('img/profile/"+result.grade.badge+"') no-repeat center center; background-size: 40px 40px;")})},setDistinction:function(ip){var node=this;Utils.getGrade(ip,function(result){if(result.distinction)node.setAttribute("style","background: url('img/profile/"+result.distinction.badge+"') no-repeat center center; background-size: 40px 40px;")})},setScore:function(ip){this.innerHTML=ip+" ip"}}),leaderevent:new Event(leaderboard)});leaderboard.init=function init($dom){spinner.spin($dom);leaders.setTransport(Config.get("transport"));leaders.sync(Config.get("db"),"users","_view/leaderboard",{limit:100,descending:true}).then(function(){leaderboard.place($dom);spinner.stop();leaders.unsync()})};leaderboard.refresh=function(){leaders.reset([]);spinner.spin(leaderboard.dom);leaders.sync(Config.get("db"),"users","_view/leaderboard",{limit:100,descending:true}).then(function(){spinner.stop();leaders.unsync()})};Config.get("observer").watch("reconnect",function(){leaderboard.refresh()});return leaderboard}},{"../../../libs/CouchDBTools":72,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256}],203:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../services/config"),Store=emily.Store,Utils=require("../../../services/utils"),Leaderboard=require("./leaderboard"),EditProfile=require("./editprofile"),Calendar=require("./calendar"),Promise=emily.Promise;module.exports=function ProfileConstructor(){var profileUI=new Widget,user=Config.get("user"),currentIP=user.get("ip"),labels=Config.get("labels"),progressBar=new Store({total:0,ideas:0,sessions:0,contacts:0,twoQ:0}),progress=new Store({status:""}),stats=new Store({view:"info",completion:0,socialnw:0}),news=new Store(user.get("news")),LB,EP,grades=new Store([]),achievements=new Store;profileUI.seam.addAll({label:new Model(labels),stats:new Model(stats,{setViewLbl:function(view){this.innerHTML=labels.get(view);view==="info"?this.setAttribute("style","background: #9ac9cd;"):this.setAttribute("style","background: #5F8F28;")},toggleInformation:function(view){view==="info"?this.classList.remove("invisible"):this.classList.add("invisible")},toggleLeaderboard:function(view){view==="leaderboard"?this.classList.remove("invisible"):this.classList.add("invisible")},setPercentage:function(completion){this.innerHTML=labels.get("completionprefix")+completion+labels.get("completionsuffix")},setProgress:function(completion){completion===100?this.setAttribute("style","width:100%;border-top-right-radius:5px;border-bottom-right-radius:5px;"):this.setAttribute("style","width:"+completion+"%;")},showDetails:function(percentage){percentage===100?this.classList.add("invisible"):this.classList.remove("invisible")},showSocialNW:function(socialnw){socialnw?this.classList.remove("invisible"):this.classList.add("invisible")}}),grades:new Model(grades,{showBadge:function(badge){this.setAttribute("style","background: url('img/profile/"+badge+"') no-repeat center center; background-size: cover;")}}),achievements:new Model(achievements,{showBadge:function(badge){this.setAttribute("style","background: url('img/profile/"+badge+"') no-repeat center center; background-size: cover;")}}),progressbar:new Model(progressBar,{setWidth:function(width){this.setAttribute("style","width:"+width+"%;")}}),progress:new Model(progress),config:new Model(Config,{setAvatar:function(avatar){this.setAttribute("style","background: url('"+avatar+"') no-repeat center center;background-size:cover;")}}),user:new Model(user,{setLocation:function(address){if(address.country){this.innerHTML=address.country.toUpperCase()}else{this.innerHTML=labels.get("completeprofile")}if(address.city&&address.country){this.innerHTML=address.city+", "+address.country.toUpperCase()}if(address.city&&address.state&&address.country){this.innerHTML=address.city+", "+address.state.toUpperCase()+" "+address.country.toUpperCase()}},setAge:function(dob){var now=new Date,then,age;if(dob&&dob.length===3){then=new Date(dob[0],dob[1],dob[2]);age=now.getTime()-then.getTime();this.innerHTML=Math.floor(age/1e3/3600/24/365)+" "+labels.get("agelbl")}else this.innerHTML=labels.get("completeprofile")},setFamily:function(family){var couple=family.couple,children=family.children,res1,res2;if(couple===null)res1=labels.get("completeprofile");else if(couple===0)res1=labels.get("singlelbl");else if(couple===1)res1=labels.get("marriedlbl");else if(couple===2)res1=labels.get("divorcedlbl");else if(couple===3)res1=labels.get("widowlbl");if(!children||children===0){res2=""}else{if(user.get("age")<20){children===1?res2=children+labels.get("onesiblinglbl"):res2=children+labels.get("siblingslbl")}else{children===1?res2=children+labels.get("onechildlbl"):res2=children+labels.get("childrenlbl")}res2=", "+res2}this.innerHTML=res1+res2},setOccupation:function(occupation){if(occupation.situation===4)this.innerHTML=labels.get("stayathome");else if(occupation.situation===3)this.innerHTML=labels.get("unemployed");else if(occupation.situation===0){occupation.organization?this.innerHTML=labels.get("student")+" @ "+occupation.organization:this.innerHTML=labels.get("student")}else if(occupation.situation===2){occupation.job?this.innerHTML=occupation.job+" ("+labels.get("retired")+")":this.innerHTML=labels.get("retired")}else if(occupation.situation===1){if(!occupation.job&&!occupation.organization)this.innerHTML=labels.get("active");else if(occupation.job&&!occupation.organization)this.innerHTML=occupation.job;else if(!occupation.job&&occupation.organization)this.innerHTML=labels.get("active")+" @ "+occupation.organization;else this.innerHTML=occupation.job+" @ "+occupation.organization}else this.innerHTML=labels.get("completeprofile")},showLeisure:function(hobbies){hobbies[0].name||hobbies[1].name||hobbies[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setLeisure:function(hobbies){var res="<ul>";if(hobbies&&hobbies.length){for(i=0;i<hobbies.length;i++){if(hobbies[i].comment){res+="<li>"+hobbies[i].name+" ("+hobbies[i].comment+")</li>"}else res+="<li>"+hobbies[i].name+"</li>"}this.innerHTML=res+"</ul>"}else{this.innerHTML=""}},showInterests:function(interests){interests[0].name||interests[1].name||interests[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setInterests:function(interests){var res="<ul>";if(interests&&interests.length){for(i=0;i<interests.length;i++){if(interests[i].comment){res+="<li>"+interests[i].name+" ("+interests[i].comment+")</li>"}else{res+="<li>"+interests[i].name+"</li>"}}this.innerHTML=res+"</ul>"}else{this.innerHTML=""}},showSN:function(sn){sn?this.innerHTML=sn:this.innerHTML=""},setSessionCount:function(ip){var su=user.get("su_sessions_count")||0,mu=user.get("mu_sessions_count")||0;this.innerHTML=su+mu},setContactCount:function(contacts){var count=0;for(i=0,l=contacts.length;i<l;i++){if(contacts[i].type==="user")count++}this.innerHTML=count},setBarLength:function(ip){if(ip>=3e5)this.setAttribute("style","width: 100%");else if(ip>=3e4)this.setAttribute("style","width: 75%");else if(ip>=3e3)this.setAttribute("style","width: 50%");else this.setAttribute("style","width: 25%")}}),news:new Model(news,{setType:function(type){if(type.search("CX")>-1)this.setAttribute("style","background: url('img/profileDisable.png') no-repeat center center; background-size: contain;");else if(type.search("RWD")>-1||type.search("RANK")>-1)this.setAttribute("style","background: url('img/brainstorm/yourScore40.png') no-repeat center center; background-size: 40px;");else if(type.search("ID")>-1)this.setAttribute("style","background: url('img/libraryIdeaDisabled40.png') no-repeat center center; background-size: 40px;");else if(type.search("2Q")>-1)this.setAttribute("style","background: url('img/2questionDisable50.png') no-repeat center center; background-size: 40px;");else if(type.search("2CTS")>-1)this.setAttribute("style","background: url('img/2centDisable.png') no-repeat center center; background-size: 40px;")},setContent:function(content){var id=this.getAttribute("data-news_id");switch(news.get(id).type){case"CX+":this.innerHTML="<span class='newsinfo'>"+news.get(id).content.username+"</span>"+labels.get("isnowacontact");break;case"CX-":this.innerHTML="<span class='newsinfo'>"+news.get(id).content.username+"</span>"+labels.get("isnolongeracontact");break;case"IDEA+":this.innerHTML=labels.get("enterednewidea")+"<span class='newsinfo'>"+news.get(id).content.title+"</span>";
break;case"SHID":this.innerHTML=labels.get("sharedanidea")+"("+"<span class='newsinfo'>"+news.get(id).content.title+"</span>)";break;case"RANK":this.innerHTML=labels.get("reachedrank")+"<span class='newsinfo'>"+news.get(id).content.label+"</span>";break;case"RWD":this.innerHTML=labels.get("gotaward")+"<span class='newsinfo'>"+news.get(id).content.label+"</span>";break;case"2Q+":this.innerHTML=labels.get("posted2q")+"<span class='newsinfo'>"+news.get(id).content.question+"</span>";break;case"2CTS":this.innerHTML=labels.get("commentedon")+"<span class='newsinfo'>"+news.get(id).content.title+"</span>"+labels.get("by")+news.get("id").content.username;break}},formatDate:function(date){this.innerHTML=Utils.formatDate(date)}}),profileevent:new Event(profileUI)});profileUI.template='<div id="dashboard-profile"><div class="header blue-dark"><span data-label="bind:innerHTML, profilelbl"></span></div><input class="infoslider" type="range" min="0" max="1" value ="0" data-profileevent="listen:mouseup, switchLeaderboard"><span class="slidertext" data-stats="bind:setViewLbl, view"></span><div id="profile-content" data-stats="bind:toggleInformation, view"><div class="leftprofile"><div class="userdetails"><div class="editbtn" data-profileevent="listen:mousedown, edit"></div><div class="cd-picarea"><div class="cardpicture" data-config="bind:setAvatar, avatar"></div><div class="cardinfo"><h2 data-user="bind:innerHTML,username"></h2><blockquote data-user="bind:innerHTML, intro"></blockquote><p><span class="cd-agelbl"></span><span data-user="bind:setAge, birthdate"></span></p><p><span class="cd-locationlbl"></span><span class="cd-info" data-user="bind: setLocation, address"></span></p><p><span class="cd-joblbl"></span><span class="cd-info" data-user="bind: setOccupation, occupation"></span></p><p><span class="cd-familylbl"></span><span class="cd-info" data-user="bind: setFamily, family"></span></p></div></div><div class="cd-contentarea"><div data-user="bind:showLeisure, leisure_activities"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl"></span><p class = "userinfo" data-user="bind:setLeisure, leisure_activities"></p></div><div data-user="bind:showInterests, interests"><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "userinfo" data-user="bind: setInterests, interests"></p></div><div data-stats="bind:showSocialNW, socialnw"><span class="contentTitle" data-label="bind: innerHTML, socialnwlbl"></span><p class = "userinfo fb" data-user="bind:showSN, facebook"></p><p class = "userinfo gp" data-user="bind:showSN, gplus; bind:innerHTML"></p><p class = "userinfo tw" data-user="bind:showSN, twitter"></p><p class = "userinfo lin" data-user="bind:showSN, linkedin"></p></div></div><div><legend data-stats="bind: setPercentage, completion"></legend><div class="completionbar"><div class="innerbar" data-stats = "bind:setProgress, completion"></div></div></div></div><div class="edituserdetails invisible"></div><div class="mystats"><legend data-label="bind:innerHTML, mystatslbl"></legend><div class="completionbar"><ul data-user="bind: setBarLength, ip"><li class="innerbar myids" data-progressbar="bind: setWidth, ideas"></li><li class="innerbar myss" data-progressbar="bind:setWidth, sessions"></li><li class="innerbar myctcts" data-progressbar="bind: setWidth, contacts"></li><li class="innerbar my2q" data-progressbar="bind:setWidth, twoQ"></li></ul></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-user="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-user="bind: setSessionCount, ip"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-user="bind: setContactCount, connections"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-user="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="recentactivity"><legend data-label="bind:innerHTML, recentactivitylbl"></legend><ul data-news="foreach"><li><div class="newstype" data-news="bind:setType, type"></div><div class="newsdate" data-news="bind:formatDate, date"></div><p class="newstext" data-news="bind:setContent, content"></p></li></ul></div></div><div class = "rightprofile"><div class="userscore"><span class="ip" data-user="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><div class="userachievements"><h2 class="grade" data-stats="bind:innerHTML, title"></h2><ul class="badges" data-grades="foreach"><li class="badge"><div data-grades="bind:showBadge, badge"></div><legend data-grades="bind:innerHTML, title"></legend></li></ul><ul class="badges" data-achievements="foreach"><li class="badge"><div data-achievements="bind:showBadge, badge"></div><legend data-achievements="bind:innerHTML, label"></legend></li></ul></div></div></div><div id="leaderboard" data-stats="bind:toggleLeaderboard, view"></div></div>';profileUI.place(Map.get("dashboard-profile"));profileUI.switchLeaderboard=function(event,node){var lb=document.getElementById("leaderboard"),pc=document.getElementById("profile-content");if(node.value==1){stats.set("view","leaderboard");if(LB)LB.refresh();else{LB=new Leaderboard;LB.init(lb)}}else stats.set("view","info")};profileUI.edit=function(event,node){var editDOM=document.querySelector(".edituserdetails");document.querySelector(".userdetails").classList.add("invisible");if(!EP){EP=new EditProfile;EP.init(editDOM)}else{EP.reset()}editDOM.classList.remove("invisible")};Config.get("observer").watch("profile-updated",function(change){profileUI.checkProfileCompletion().then(function(){profileUI.updateGrade();profileUI.updateAchievements()})});user.watchValue("ip",function(){profileUI.updateGrade();profileUI.updateProgressBar()});user.watchValue("tutorial_complete",function(){profileUI.updateGrade();profileUI.updateAchievements()});user.watchValue("settings",function(){profileUI.updateGrade();profileUI.updateAchievements()});user.watchValue("news",function(){news.reset(user.get("news"))});user.watchValue("lang",function(){profileUI.updateGrade().then(function(){profileUI.updateAchievements()});news.reset([]);news.reset(user.get("news"))});profileUI.checkProfileCompletion=function(){var result=Utils.checkProfileCompletion(),promise=new Promise;stats.set("completion",result.percentage);stats.set("missing",result.missing);if(result.missing.indexOf(labels.get("entersocialnw"))<0){stats.set("socialnw",1)}if(result.percentage===100&&user.get("profile_complete")!==true){user.set("profile_complete",true);user.upload().then(function(){promise.fulfill()})}else{if(result.percentage<100&&user.get("profile_complete")){user.set("profile_complete",false);user.upload().then(function(){promise.fulfill()})}else{promise.fulfill()}}return promise};profileUI.updateGrade=function updateGrade(){var promise=new Promise;Utils.getGrade(user.get("ip"),function(result){var array;result.distinction?array=[result.grade,result.distinction]:array=[result.grade];grades.reset(array);stats.set("title",result.grade.label);promise.fulfill()});return promise};profileUI.updateAchievements=function updateAchievements(){var promise=new Promise;Utils.getAchievements(user.get("_id"),function(result){if(result.length){achievements.reset(result)}else{achievements.reset(user.get("achievements"))}promise.fulfill()});return promise};profileUI.updateProgressBar=function updateProgressBar(){var total,ideas,sessions,su,mu,contacts,twoq,i,l;ideas=user.get("ideas_count");su=user.get("su_sessions_count")||0;mu=user.get("mu_sessions_count")||0;sessions=su+mu;twoq=user.get("twoquestions_count")||0;contacts=0;for(i=0,l=user.get("connections").length;i<l;i++){if(user.get("connections")[i].type==="user")contacts++}total=ideas+twoq+contacts+sessions;progressBar.set("total",total);progressBar.set("ideas",Math.floor(ideas/total*100));progressBar.set("contacts",Math.floor(contacts/total*100));progressBar.set("sessions",Math.floor(sessions/total*100));progressBar.set("twoQ",Math.floor(twoq/total*100))};profileUI.cleanOldNews=function cleanOldNew(){var now=new Date,n=user.get("news").concat(),l=n.length,i,s,then,promise=new Promise;if(l){for(i=l-1;i>=0;i--){s=n[i].date[0]+"/"+(n[i].date[1]+1)+"/"+n[i].date[2];then=new Date(s);if(now.getTime()-then.getTime()>1296e6){n.splice(i,1)}}if(n.length!==l){user.set("news",n);user.upload().then(function(){promise.fulfill()})}else promise.fulfill()}return promise};profileUI.init=function init(){profileUI.checkProfileCompletion().then(function(){return profileUI.updateGrade()}).then(function(){return profileUI.updateAchievements()}).then(function(){profileUI.updateProgressBar();profileUI.cleanOldNews()})};profileUI.reset=function reset(){news.reset([]);news.reset(user.get("news"));profileUI.init()};profileUI.init();Calendar.init();return profileUI}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256,"./calendar":200,"./editprofile":201,"./leaderboard":202}],204:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../services/config"),Store=emily.Store,Utils=require("../../../services/utils"),CouchDBBulkDocuments=CouchDBTools.CouchDBBulkDocuments;module.exports=function SettingsConstructor(){var settingsUI=new Widget,labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),screens=[{name:labels.get("public"),dest:"#public"},{name:labels.get("library"),dest:"#library"},{name:labels.get("brainstorm"),dest:"#brainstorm"},{name:labels.get("connect"),dest:"#connect"},{name:labels.get("dashboard"),dest:"#dashboard"}],timers=[{name:labels.get("everymin"),value:6e4},{name:labels.get("everyfive"),value:3e5},{name:labels.get("everyfifteen"),value:9e5},{name:labels.get("never"),value:864e5}],options=new Store({screens:screens,timers:timers,pwd:"",pwdbis:"",lang:[],pwdchange:"",contentLang:user.get("lang").substring(0,2)}),_languages=new Store([{name:"*"}]),_usrLg=Config.get("userLanguages"),settings=new Store;_usrLg.forEach(function(val){_languages.alter("push",val)});settingsUI.seam.addAll({label:new Model(labels),options:new Model(options,{setLang:function(lang){var i,l,res="";for(i=0,l=lang.length;i<l;i++){res+="<option>"+lang[i]+"</option>"}this.innerHTML=res;this.selectedIndex=lang.indexOf(user.get("lang"))},setStartupScreen:function(screens){var i,l,res="",selected,idx;for(i=0,l=screens.length;i<l;i++){res+="<option>"+screens[i].name+"</option>";if(screens[i].dest===user.get("settings").startupScreen)idx=i}this.innerHTML=res;this.selectedIndex=idx},setPollingInterval:function(timers){var i,l,res="",selected,idx;for(i=0,l=timers.length;i<l;i++){res+="<option>"+timers[i].name+"</option>";if(timers[i].value===user.get("settings").polling_interval)idx=i}this.innerHTML=res;this.selectedIndex=idx},setDecks:function(decks){var i,l,res="",selected,idx;for(i=0,l=decks.length;i<l;i++){res+="<option>"+decks[i].title+"</option>";if(decks[i].id===user.get("active_deck"))idx=i}this.innerHTML=res;this.selectedIndex=idx},setBg:function(l){if(l==="all"){this.setAttribute("style","background-image: none;");this.innerHTML="*"}else{this.innerHTML=" ";this.setAttribute("style","background-image:url('img/flags/"+l+".png');background-size: contain;")}}}),select:new Model(_languages,{setBg:function(name){if(name==="*"){this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;");this.innerHTML="*"}else{this.innerHTML=" ";this.setAttribute("style","background-image:url('img/flags/"+name+".png'); background-size: contain;")}}}),settings:new Model(settings),settingsevent:new Event(settingsUI)});settingsUI.template='<div id="dashboard-settings"><div class="header blue-dark"><span data-label="bind:innerHTML, settingslbl"></span></div><div class="settingscontent"><div class="settingmodule"><legend data-label="bind:innerHTML, publicwallsettings"></legend><ul><li class="startupscreen"><span data-label="bind: innerHTML, choosepolling"></span><select data-options="bind:setPollingInterval, timers" data-settingsevent="listen: change, updatePollingInterval"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, brainstormsettings"></legend><ul><li class="activedeck"><span data-label="bind:innerHTML, setdeck">Set brainstorming deck</span><select data-options="bind:setDecks, decks" data-settingsevent="listen: mousedown, getDecks; listen: change, updateDeck"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, userpref"></legend><ul><li><span data-label="bind:innerHTML, setlang"></span><select data-options="bind:setLang, lang" data-settingsevent="listen: change, updateLang"></select></li><li class="activelang"><span data-label="bind:innerHTML, defaultlangfilter"></span><div class="selectlang"><div data-options="bind:setBg, contentLang"></div><button data-settingsevent = "listen:mouseup, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-settingsevent="listen: mouseup, setContentLang"></li></ul></li><li class="startupscreen"><span data-label="bind: innerHTML, choosestartup"></span><select data-options="bind:setStartupScreen, screens" data-settingsevent="listen: change, updateStartup"></select></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, showTips" data-settingsevent="listen: change, showTips"><label data-label="bind:innerHTML, showtips"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, notifyPopup" data-settingsevent="listen: change, showNotif"><label data-label="bind:innerHTML, shownotif"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, useascharacter" data-settingsevent="listen: change, useAsChar"><label data-label="bind:innerHTML, usechar"></label></li><li><span data-label="bind: innerHTML, changepwd"></span><input class="input" type="password" data-label="bind:placeholder, passwordplaceholder" data-options="bind: value, pwd" data-settingsevent="listen:input, updatepwd; listen: input, clearOK"><input class="input" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-options="bind: value, pwdbis" data-settingsevent="listen:input, updatepwdbis; listen: input, clearOK"><span class="changeok" data-options="bind: innerHTML, pwdchange"></span><div class="next-button" data-label="bind:innerHTML, changelbl" data-settingsevent="listen: mousedown, press; listen:mouseup, changePWD"></div></li></ul></div></div></div>';settingsUI.place(Map.get("dashboard-settings"));settingsUI.updateLang=function updateLang(event,node){if(node.value!==user.get("lang")){Utils.updateLabels(node.value).then(function(){user.set("lang",node.value);user.upload();options.set("timers",[{name:labels.get("everymin"),value:6e4},{name:labels.get("everyfive"),value:3e5},{name:labels.get("everyfifteen"),value:9e5},{name:labels.get("never"),value:864e5}]);options.set("screens",[{name:labels.get("public"),dest:"#public"},{name:labels.get("library"),dest:"#library"},{name:labels.get("brainstorm"),dest:"#brainstorm"},{name:labels.get("connect"),dest:"#connect"},{name:labels.get("dashboard"),dest:"#dahsboard"}]);settings.get("contentLang")?options.set("contentLang",settings.get("contentLang")):options.set("contentLang",user.get("lang").substring(0,2))})}};settingsUI.displayLang=function(event,node){settingsUI.dom.querySelector(".langlist").classList.remove("invisible")};settingsUI.setContentLang=function(event,node){var i=parseInt(node.getAttribute("data-select_id"),10),s=user.get("settings");settingsUI.dom.querySelector(".langlist").classList.add("invisible");if(i===0){s.contentLang="all";options.set("contentLang","all")}else{s.contentLang=_languages.get(i).name;options.set("contentLang",s.contentLang)}user.set("settings",s);user.upload()};settingsUI.getDecks=function getDecks(){var cdb=new CouchDBBulkDocuments,idList=user.get("taiaut_decks").concat(user.get("custom_decks")),decks=[];cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),{keys:idList}).then(function(){options.set("decks",[]);cdb.loop(function(v,i){var c=v.doc.content;if(c.characters.length>=2&&c.contexts.length>=2&&c.problems.length>=2&&c.techno.length>=4){decks.push({id:v.doc._id,title:v.doc.title})}});cdb.unsync();decks.sort(function(x,y){var a=x.title,b=y.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});options.set("decks",decks)})};settingsUI.updateDeck=function updateDeck(event,node){var id=node.selectedIndex,deck=options.get("decks")[id].id;user.set("active_deck",deck);user.upload()};settingsUI.updateStartup=function updateStartup(event,node){var id=node.selectedIndex,s=user.get("settings");s.startupScreen=screens[id].dest;user.set("settings",s);user.upload()};settingsUI.updatePollingInterval=function updatePollingInterval(event,node){var id=node.selectedIndex,s=user.get("settings");s.polling_interval=timers[id].value;user.set("settings",s);user.upload()};settingsUI.showTips=function(event,node){var s=user.get("settings");s.showTips=node.checked;user.set("settings",s);user.upload().then(function(){console.log("upload successful")})};settingsUI.showNotif=function(event,node){var s=user.get("settings");s.notifyPopup=node.checked;user.set("settings",s);user.upload()};settingsUI.useAsChar=function(event,node){var s=user.get("settings");s.useascharacter=node.checked;user.set("settings",s);user.upload()};settingsUI.press=function(event,node){node.classList.add("pressed")};settingsUI.clearOK=function(event,node){options.set("pwdchange","")};settingsUI.updatepwd=function(event,node){options.set("pwd",node.value)};settingsUI.updatepwdbis=function(event,node){options.set("pwdbis",node.value)};settingsUI.changePWD=function(event,node){node.classList.remove("pressed");if(options.get("pwd")!==options.get("pwdbis")){options.set("pwdbis","");options.set("pwdchange","&#10007;")}else{transport.request("ChangePWD",{userid:user.get("_id"),pwd:options.get("pwd")},function(result){var json={},notif={},now,n=user.get("notifications").concat()||[];if(result==="ok"){options.set("pwdchange","&#10003;");json.type="pwd";json.to=user.get("_id");json.subject=labels.get("pwdchange");json.html=labels.get("pwdchangebody")+options.get("pwd");transport.request("SendMail",json,function(result){if(result.sendmail!=="ok")console.log(result)});user.set("resetPWD",false);now=new Date;notif.type="pwd";notif.status="unread";notif.date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];notif.author="IDEAFY";notif.username="Ideafy";notif.firstname="DeeDee";notif.object=labels.get("pwdupdate");notif.body=labels.get("pwdchangebody")+options.get("pwd");n.unshift(notif);user.set("notifications",n);user.upload().then(function(result){if(!result.ok)console.log(result)})}})}};settingsUI.reset=function reset(){settings.reset(user.get("settings"));user.watchValue("settings",function(change){settings.reset(user.get("settings"))});settingsUI.getDecks();transport.request("GetLanguages",{},function(result){options.set("lang",result)});settings.get("contentLang")?options.set("contentLang",settings.get("contentLang")):options.set("contentLang",user.get("lang").substring(0,2));options.set("timers",[{name:labels.get("everymin"),value:6e4},{name:labels.get("everyfive"),value:3e5},{name:labels.get("everyfifteen"),value:9e5},{name:labels.get("never"),value:864e5}]);options.set("screens",[{name:labels.get("public"),dest:"#public"},{name:labels.get("library"),dest:"#library"},{name:labels.get("brainstorm"),dest:"#brainstorm"},{name:labels.get("connect"),dest:"#connect"},{name:labels.get("dashboard"),dest:"#dahsboard"}]);options.set("pwd","");options.set("pwdbis","");options.set("pwdchange","")};settingsUI.reset();Utils.updateLabels(user.get("lang"));return settingsUI}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],205:[function(require,module,exports){var olives=require("../libs/olives"),amy=require("../libs/amy2"),Widget=olives.OObject,Place=olives["Place.plugin"],Stack=amy.StackPlugin,Control=amy.ControlPlugin,Public=require("./public/public"),Library=require("./library/library"),Brainstorm=require("./brainstorm/brainstorm"),Connect=require("./connect/connect"),Dashboard=require("./dashboard/dashboard"),Map=require("../services/map"),Config=require("../services/config"),Notify=require("./notify"),NewIdea=require("../services/newidea"),Help=require("../services/help"),New2Q=require("../services/new2q"),New2C=require("../services/new2c"),Tips=require("../services/tips"),Attachment=require("./attach/attachment");module.exports=function DockConstructor(){var _widget=new Widget,_notify=new Notify,_public,_library,_brainstorm,_connect,_dashboard,_control=new Control(_widget),_observer=Config.get("observer"),_user=Config.get("user"),_stack=new Stack;_widget.seam.addAll({dockstack:_stack,dockcontrol:_control,place:new Place({notify:_notify,newidea:NewIdea,new2q:New2Q,new2c:New2C,help:Help,tips:Tips,attach:Attachment})});_widget.template='<div id="wrapper"><nav id="dock" data-dockcontrol="radio:a,selected,mousedown,setCurrentWidget"><a class="dock-item selected" href="#public" data-dockcontrol="init"></a><a class="dock-item" href="#library"></a><a class="dock-item" href="#brainstorm"></a><a class="dock-item" href="#connect"></a><a class="dock-item" href="#dashboard"></a></nav><div class="stack" data-dockstack="destination"></div><div data-place="place:notify"></div><div data-place="place:newidea"></div><div data-place="place:new2q"></div><div data-place="place:new2c"></div><div data-place="place:help"></div><div data-place="place:tips"></div><div data-place="place:attach"></div><div id="cache"></div></div>';_widget.setDisplay=function(){var W=window.innerWidth,H=window.innerHeight,w=_widget.dom.clientWidth||1024,h=_widget.dom.clientHeight||748,style="";if(W>w)style+="left:50%; margin-left:-"+w/2+"px;";if(H>h)style+="top:50%; margin-top:-"+h/2+"px;";_widget.dom.setAttribute("style",style)};_widget.init=function init(){_widget.setDisplay();_public=new Public;console.log("public ok");_library=new Library;console.log("library ok");_brainstorm=new Brainstorm;console.log("brainstorm ok");_connect=new Connect;console.log("connect ok");_dashboard=new Dashboard;console.log("dashboard ok");_stack.getStack().add("#public",_public);_stack.getStack().add("#library",_library);_stack.getStack().add("#brainstorm",_brainstorm);_stack.getStack().add("#connect",_connect);_stack.getStack().add("#dashboard",_dashboard);_notify.init()};_widget.start=function start(firstStart){var pub=_widget.dom.querySelector('a[href="#public"]'),dash=_widget.dom.querySelector('a[href="#dashboard"]'),current=_widget.dom.querySelector("a.selected"),startScreen=_widget.dom.querySelector('a[href="'+_user.get("settings").startupScreen+'"]');if(!_user.get("settings").startupScreen&&!_user.get("resetPWD")){if(current!==pub){_control.radioClass(pub,current,"selected");_control.init(pub)}_stack.getStack().show("#public")}else if(_user.get("resetPWD")){_control.radioClass(dash,current,"selected");_control.init(dash);_stack.getStack().show("#dashboard")}else{_control.radioClass(startScreen,current,"selected");_control.init(startScreen);_stack.getStack().show(_user.get("settings").startupScreen)}if(firstStart||_user.get("settings").showTips!==false){Tips.init(firstStart)}};_widget.reset=function reset(){_public.reset();_library.reset();_brainstorm.reset();_connect.reset();_dashboard.reset();_notify.reset()};_widget.setCurrentWidget=function(event){var href=event.target.getAttribute("href"),timeout=1500;event.preventDefault();if(href!==_stack.getStack().getCurrentName()){_stack.getStack().getCurrentScreen().hideMenu();_stack.getStack().show(href);_stack.getStack().getCurrentScreen().showMenu();setTimeout(function(){_stack.getStack().getCurrentScreen().hideMenu()},timeout)}else{_stack.getStack().getCurrentScreen().showMenu()}};_observer.watch("replay-session",function(sid,mode){var prev=document.querySelector(".dock-item.selected"),bs=document.querySelector(".dock-item[href='#brainstorm']");_stack.getStack().show("#brainstorm");_control.radioClass(bs,prev,"selected");_control.init(bs)});_observer.watch("display-doc",function(){var prev=document.querySelector(".dock-item.selected"),lib=document.querySelector(".dock-item[href='#library']");_stack.getStack().show("#library");_control.radioClass(lib,prev,"selected");_control.init(lib)});_observer.watch("display-message",function(id){var prev=document.querySelector(".dock-item.selected"),con=document.querySelector(".dock-item[href='#connect']");_stack.getStack().show("#connect");_control.radioClass(con,prev,"selected");_control.init(con)});_observer.watch("display-tutorials",function(id){var prev=document.querySelector(".dock-item.selected"),dash=document.querySelector(".dock-item[href='#dashboard']");_stack.getStack().show("#dashboard");_control.radioClass(dash,prev,"selected");_control.init(dash)});_observer.watch("join-musession",function(sid){var prev=document.querySelector(".dock-item.selected"),bs=document.querySelector(".dock-item[href='#brainstorm']");if(_stack.getStack().getCurrentName()!=="#brainstorm"){_stack.getStack().show("#brainstorm");_control.radioClass(bs,prev,"selected");_control.init(bs)}});_observer.watch("show-mupreview",function(sid){var prev=document.querySelector(".dock-item.selected"),bs=document.querySelector(".dock-item[href='#brainstorm']");if(_stack.getStack().getCurrentName()!=="#brainstorm"){_stack.getStack().show("#brainstorm");_control.radioClass(bs,prev,"selected");_control.init(bs)}});_observer.watch("goto-screen",function(name){var prev=document.querySelector(".dock-item.selected"),dest=document.querySelector(".dock-item[href='"+name+"']");if(_stack.getStack().getCurrentName()!==name){_stack.getStack().show(name);_control.radioClass(dest,prev,"selected");_control.init(dest)}});return _widget}},{"../libs/amy2":75,"../libs/olives":141,"../services/config":245,"../services/help":248,"../services/map":249,"../services/new2c":250,"../services/new2q":251,"../services/newidea":252,"../services/tips":255,"./attach/attachment":146,"./brainstorm/brainstorm":147,"./connect/connect":177,"./dashboard/dashboard":199,"./library/library":224,"./notify":227,"./public/public":235}],206:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBBulkDocuments=CouchDBTools.CouchDBBulkDocuments,Promise=emily.Promise,Utils=require("../../../../services/utils"),ActionBar=require("../../../../services/actionbar");module.exports=function DeckListConstructor($type){var deckList=new Widget,labels=Config.get("labels"),user=Config.get("user"),decks=new Store([]),currentBar=null;deckList.seam.addAll({labels:new Model(labels),active:new Model(user,{}),decks:new Model(decks,{setVersion:function(version){version?this.innerHTML=labels.get("version")+version:this.innerHTML=""},setAuthor:function(author){if(author==="Taiaut"){this.innerHTML="";this.setAttribute("style","background-image:url('img/logo.png');")}else{this.innerHTML=author}},date:function(date){date?this.innerHTML=Utils.formatDate(date):this.innerHTML=""}}),decklistevent:new Event(deckList)});deckList.template='<ul id="deck-list" data-decks="foreach"><li class="list-item" data-decklistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>';deckList.setStart=function(event,node){currentBar&&currentBar.hide()};deckList.showActionBar=function(event,node){var id=node.getAttribute("data-decks_id"),display=false,frag;if(currentBar&&currentBar.getParent()===node){display=true}if(!display){currentBar=new ActionBar("deck",node,decks.get(id)._id);frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};deckList.reset=function reset(onEnd){var callback=onEnd||null;decks.reset([]);deckList.getDecks($type,callback);display=false};deckList.getModel=function getModel(){return decks};deckList.getDecks=function getDecks(type,onEnd){var cdb=new CouchDBBulkDocuments,keys=[];switch(type){default:keys=user.get("taiaut_decks").concat(user.get("custom_decks"));break}cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),{keys:keys}).then(function(){var lang=user.get("lang"),arr=[];cdb.loop(function(v,i){if(!v.doc.default_lang||v.doc.default_lang===lang){arr.push(v.doc)}else{v.doc.translations&&v.doc.translations[lang]?arr.push(v.doc.translations[lang]):arr.push(v.doc)}});arr.sort(function(x,y){var a=x.title,b=y.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});decks.reset(arr);onEnd&&onEnd("ok");cdb.unsync()})};deckList.initSelected=function initSelected(init,id){var dom=deckList.dom,node=dom.querySelector(".list-item[data-decks_id='"+id+"']");init(node);node.classList.add("selected")};deckList.highlightDeck=function highlightDeck(init,deckId){var dom=deckList.dom,node,position;if(deckId===0){node=dom.querySelector(".list-item[data-decks_id='0']");position=0}else{decks.loop(function(v,i){if(v._id===deckId){position=i}});node=dom.querySelector(".list-item[data-decks_id='"+position+"']")}init(node);node.classList.add("selected");node.scrollIntoView();return position};deckList.init=function init(onEnd){deckList.reset(onEnd)};user.watchValue("lang",function(){deckList.getDecks($type)});return deckList}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/actionbar":240,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256}],207:[function(require,module,exports){var olives=require("../../../libs/olives"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Model=olives["Bind.plugin"],Stack=amy.StackPlugin,Control=amy.ControlPlugin,Event=olives["Event.plugin"],Place=olives["Place.plugin"],Config=require("../../../services/config"),Map=require("../../../services/map"),List=require("./decklist/decklist"),DeckView=require("./deckview/deckview"),NewDeck=require("./newdeck");module.exports=function MyDecksContructor(){var widget=new Widget,deckControl=new Control(widget),user=Config.get("user"),currentSelected,stack=new Stack,ideafyDecks,customDecks,taiautDecks,displayDeck=function(deckId){var listUI=stack.getStack().getCurrentScreen(),list=listUI.getModel();currentSelected=listUI.highlightDeck(deckControl.init,deckId);deckView.reset(list.get(currentSelected))},newdeck=false,currentId,deckUpdate=function(update,deckId,cardType){var listUI;currentId=deckId;if(update==="new"){newdeck=true;currentId=deckId}if(update==="updated"){listUI=stack.getStack().getCurrentScreen();listUI.reset(function(sync){if(sync){listUI.highlightDeck(deckControl.init,deckId);deckView.reset(listUI.getModel().get(currentSelected),cardType)}})}},deckView=new DeckView(deckUpdate),newDeck=new NewDeck(deckUpdate);
widget.seam.addAll({label:new Model(Config.get("labels")),deckliststack:stack,decksevent:new Event(widget),deckplace:new Place({deckView:deckView,newDeck:newDeck}),deckscontrol:deckControl});widget.template='<div id="decks"><div id="decklist" class="list"><div class="header blue-light"><div class="option left" data-deckscontrol=""></div><span data-label="bind: innerHTML, decklistheadertitle"></span><div class="option right" data-decksevent="listen: mousedown, plus"></div></div><div class="overflow" data-deckliststack="destination" data-deckscontrol="radio:li,selected,mousedown,selectStart"></div></div><div data-deckplace="place:deckView"></div><div data-deckplace="place:newDeck"></div></div>';widget.reset=function reset(){ideafyDecks.reset(function(sync){if(sync){stack.getStack().show("ideafy");ideafyDecks.highlightDeck(deckControl.init,0);deckView.reset(ideafyDecks.getModel().get(0));currentSelected=0}})};widget.displayDeck=displayDeck;widget.init=function init(){ideafyDecks=new List("all_decks");stack.getStack().add("ideafy",ideafyDecks);ideafyDecks.init(function(sync){if(sync){stack.getStack().show("ideafy");deckView.init();ideafyDecks.highlightDeck(deckControl.init,0);deckView.reset(ideafyDecks.getModel().get(0),"details");currentSelected=0}})};widget.selectStart=function(event){var list=stack.getStack().getCurrentScreen().getModel(),id=event.target.getAttribute("data-decks_id");deckView.reset(list.get(id));currentSelected=id};widget.plus=function(event,node){newDeck.show()};widget.init();user.watchValue("lang",function(){var name=stack.getStack().getCurrentName(),currentDeckList,deckListUI=stack.getStack().getCurrentScreen();switch(name){case"taiaut":currentDeckList="taiaut_decks";case"custom":currentDeckList="custom_decks";break;default:currentDeckList="all_decks";break}deckListUI.getDecks(currentDeckList,function(sync){if(sync){deckListUI.initSelected(deckControl.init,currentSelected);deckView.reset(deckListUI.getModel().get(currentSelected))}})});user.watchValue("custom_decks",function(newValue,action,oldValue){ideafyDecks.reset(function(sync){var list;if(sync&&newdeck){displayDeck(currentId)}else if(sync&&newValue.length<oldValue.length){list=ideafyDecks.getModel();if(list.count()){ideafyDecks.initSelected(deckControl.init,0);deckView.reset(list.get(0));currentSelected=0}}newdeck=false})});user.watchValue("taiaut_decks",function(newValue,action,oldValue){ideafyDecks.reset(function(sync){if(sync){ideafyDecks.initSelected(deckControl.init,0);deckView.reset(ideafyDecks.getModel().get(0))}})});return widget}},{"../../../libs/amy2":75,"../../../libs/olives":141,"../../../services/config":245,"../../../services/map":249,"./decklist/decklist":206,"./deckview/deckview":215,"./newdeck":216}],208:[function(require,module,exports){var olives=require("../../../../../libs/olives"),emily=require("../../../../../libs/emily"),CouchDBTools=require("../../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../../services/config"),Utils=require("../../../../../services/utils"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Spinner=require("../../../../../libs/spin.min");module.exports=function EditCardConstructor($update,$close){var editCard=new Widget,user=Config.get("user"),labels=Config.get("labels"),cardTemplate={_id:"",default_lang:user.get("lang"),title:"",didYouKnow:"",deck:[],category:"",coefficient:1,sources:[],created_by:user.get("_id"),created_on:[],picture_credit:"",type:null,picture_file:""},model=new CouchDBDocument,error=new Store({error:""}),_currentDataURL,MIN_WIDTH=87,MIN_HEIGHT=87,resizeImage=function(img){var _width,_height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");_width=img.width;_height=img.height;if(_width<_height){_height*=MIN_WIDTH/_width;_width=MIN_WIDTH}else{_width*=MIN_HEIGHT/_height;_height=MIN_HEIGHT}canvas.width=_width;canvas.height=_height;ctx.drawImage(img,0,0,_width,_height);return canvas.toDataURL("image/png")},cropImage=function(dataURL,onEnd){var image=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),dw=MIN_WIDTH,dh=MIN_HEIGHT,sx,sy;image.src=dataURL;setTimeout(function(){canvas.width=dw;canvas.height=dh;sx=Math.floor(Math.max(0,(image.width-dw)/2));sy=Math.floor(Math.max(0,(image.height-dh)/2));ctx.drawImage(image,sx,sy,dw,dh,0,0,dw,dh);onEnd(canvas.toDataURL("image/png"))},300)},uploadCardPicture=function(){var _url="/upload",_fd=new FormData,_type="cardpic",_dir="cards",_dataURL=_currentDataURL;_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("filename",model.get("_id"));_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,null,function(result){if(result.response!=="ok"){console.log(result)}})},spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin();model.setTransport(Config.get("transport"));editCard.seam.addAll({label:new Model(labels),model:new Model(model,{setTitle:function(title){if(title&&title!==""&&title!=="<br>"){this.innerHTML=title.toUpperCase();this.setAttribute("style","color: white;")}else{this.innerHTML=labels.get("cardtitle");this.setAttribute("style","color: whitesmoke;")}},formatTitle:function(type){switch(type){case 2:this.setAttribute("style","background: #5f8f28");break;case 3:this.setAttribute("style","background: #bd262c");break;case 4:this.setAttribute("style","background: #f27b3d");break;default:break}},setSources:function(sources){if(sources&&sources.length){sources instanceof Array?this.innerHTML=sources.join(", "):this.innerHTML=sources}else{this.innerHTML=""}},setPic:function(pic){var json,node=this,style;if(pic&&pic.search("img/decks/")>-1){style="background-image:url('"+pic+"');background-repeat: no-repeat; background-position: center center; background-size: cover;";node.setAttribute("style",style)}else if(pic){json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background-image: url('"+data+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")})}}}),error:new Model(error),editevent:new Event(editCard)});editCard.template='<div class="cardpopup editcard"><div class="card-detail"><div class="cd-header blue-dark" data-model="bind:formatTitle, type"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class ="cardpicture" data-model="bind:setPic, picture_file"></div><div class="picinfo"><span class="cd-creditslbl"data-label="bind:innerHTML, credits"></span><input type="text" class="input editcredit" data-label="bind: placeholder, picturecredit" data-model="bind:value, picture_credit"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editevent="listen:mousedown, press; listen:mouseup, release"></div></span></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><textarea class="input enterdyknow" data-label="bind: placeholder, enterdyknow" data-model="bind:value,didYouKnow"></textarea><span class="cd-sourcelbl" data-label="bind:innerHTML, source"></span><textarea class="input entersources" data-label="bind: placeholder, dyknowsources" data-model="bind: value, sources"></textarea></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl">Save</div></div></div>';editCard.reset=function reset(deckId,id,type){var now=new Date;_currentDataURL=null;error.set("error","");model.reset();if(id==="newcard"){model.reset(cardTemplate);model.set("_id","C:"+now.getTime());model.set("created_on",[now.getFullYear(),now.getMonth(),now.getDate()]);model.set("deck",[deckId]);if(type==="contexts"){model.set("type",2);model.set("picture_file","img/decks/context.png")}if(type==="problems"){model.set("type",3);model.set("picture_file","img/decks/problem.png")}if(type==="techno"){model.set("type",4);model.set("picture_file","img/decks/technology.png")}}else{model.sync(Config.get("db"),id)}};editCard.changeType=function changeType(idx){switch(idx){case 1:model.set("type",2);model.set("picture_file","img/decks/context.png");break;case 2:model.set("type",3);model.set("picture_file","img/decks/problem.png");break;case 3:model.set("type",4);model.set("picture_file","img/decks/technology.png");break;default:model.set("type",2);model.set("picture_file","img/decks/context.png");break}};editCard.clearDefault=function clearDefault(event,node){var field=node.getAttribute("name");if(model.get(field)==="")node.innerHTML=""};editCard.updateTitle=function updateTitle(event,node){var title=node.innerHTML;model.get("type")===4?title=title.toUpperCase():title=title.charAt(0).toUpperCase()+title.slice(1);model.set("title",title)};editCard.selectpress=function(event,node){node.value=""};editCard.release=function(event,node){setTimeout(function(){node.classList.remove("pressed")},300)};editCard.uploadnDisplay=function(event,node){var _reader=new FileReader,_img=new Image,el=editCard.dom.querySelector(".cardpicture"),picSpinner=new Spinner({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();el.setAttribute("style","background-image: none");picSpinner.spin(el);_reader.onload=function(e){_img.src=e.target.result;setTimeout(function(){cropImage(resizeImage(_img),function(result){el.setAttribute("style","background-image: url('"+result+"')");picSpinner.stop();_currentDataURL=result})},300)};_reader.readAsDataURL(node.files[0])};editCard.press=function(event,node){node.classList.add("pressed")};editCard.cancel=function(event,node){node.classList.remove("pressed");$close();model.unsync();model.reset({})};editCard.upload=function(event,node){var now=new Date;node.classList.remove("pressed");error.set("error","");spinner.spin(node);if(!model.get("title")||model.get("title")==="<br>"){error.set("error",labels.get("titlerequired"))}if(!error.get("error")){if(!model.get("_rev")){model.sync(Config.get("db"),model.get("_id")).then(function(){editCard.uploadCard()})}else{model.set("last_modified",[now.getFullYear(),now.getMonth(),now.getDate()]);editCard.uploadCard(node)}}else{spinner.stop()}};editCard.uploadCard=function uploadCard(node){if(_currentDataURL){uploadCardPicture();model.set("picture_file",model.get("_id"))}model.upload().then(function(){return $update(model.get("type"),model.get("_id"))}).then(function(){spinner.stop();$close();model.unsync();model.reset({})})};return editCard}},{"../../../../../libs/CouchDBTools":72,"../../../../../libs/emily":97,"../../../../../libs/olives":141,"../../../../../libs/spin.min":143,"../../../../../services/config":245,"../../../../../services/utils":256}],209:[function(require,module,exports){var olives=require("../../../../../libs/olives"),emily=require("../../../../../libs/emily"),CouchDBTools=require("../../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../../services/config"),Utils=require("../../../../../services/utils"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Spinner=require("../../../../../libs/spin.min");module.exports=function EditCharConstructor($update,$close){var editChar=new Widget,user=Config.get("user"),labels=Config.get("labels"),charTemplate={_id:"",default_lang:user.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:user.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},model=new CouchDBDocument,charUpdates={},error=new Store({error:""}),_currentDataURL,MIN_WIDTH=87,MIN_HEIGHT=87,resizeImage=function(img){var _width,_height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");_width=img.width;_height=img.height;if(_width<_height){_height*=MIN_WIDTH/_width;_width=MIN_WIDTH}else{_width*=MIN_HEIGHT/_height;_height=MIN_HEIGHT}canvas.width=_width;canvas.height=_height;ctx.drawImage(img,0,0,_width,_height);return canvas.toDataURL("image/png")},cropImage=function(dataURL,onEnd){var image=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),dw=MIN_WIDTH,dh=MIN_HEIGHT,sx,sy;image.src=dataURL;setTimeout(function(){canvas.width=dw;canvas.height=dh;sx=Math.floor(Math.max(0,(image.width-dw)/2));sy=Math.floor(Math.max(0,(image.height-dh)/2));ctx.drawImage(image,sx,sy,dw,dh,0,0,dw,dh);onEnd(canvas.toDataURL("image/png"))},300)},uploadCardPicture=function(){var _url="/upload",_fd=new FormData,_type="cardpic",_dir="cards",_dataURL=_currentDataURL;_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("filename",model.get("_id"));_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,null,function(result){if(result.response!=="ok"){console.log(result)}})},spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin();model.setTransport(Config.get("transport"));editChar.seam.addAll({label:new Model(labels),model:new Model(model,{setTitle:function(title){if(title&&title!==""&&title!=="<br>"){this.innerHTML=title.toUpperCase();this.setAttribute("style","color: white;")}else{this.innerHTML=labels.get("cardtitle");this.setAttribute("style","color: whitesmoke;")}},setPic:function(pic){var json,node=this,style;if(pic&&pic.search("img/decks/")>-1){style="background-image:url('"+pic+"');background-repeat: no-repeat; background-position: center center; background-size: cover;";node.setAttribute("style",style)}else if(pic){json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background-image: url('"+data+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")})}},setAge:function(age){if(!age&&age!==0){this.innerHTML="";this.setAttribute("placeholder","age")}},setCity:function(loc){var city="";if(loc&&loc.length){city=loc.split(",")[0].trim();this.value=city}else{this.value=""}},setCountry:function(loc){var country="";if(loc&&loc.length){country=loc.split(",").slice(1,loc.length).join().trim();this.value=country}else{this.value=""}},setFamilyStatus:function(couple){if(couple||couple===0){this.selectedIndex=couple}},setChildren:function(children){if(children||children===0){this.selectedIndex=children}},setChildrenlbl:function(children){children&&children==="1"?this.innerHTML=labels.get("onechildlbl"):this.innerHTML=labels.get("childrenlbl")},setSituation:function(details){if(details&&details.length){this.selectedIndex=details[0]}},setLeisureName:function(leisure){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(leisure[i]&&name.search(i)>0)node.value=leisure[i].name})},setLeisureDesc:function(leisure){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(leisure[i]&&name.search(i)>0)node.value=leisure[i].comment})},setInterestName:function(interests){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(interests[i]&&name.search(i)>0)node.value=interests[i].name})},setInterestDesc:function(interests){var node=this,name=node.getAttribute("name");[0,1,2].forEach(function(i){if(interests[i]&&name.search(i)>0)node.value=interests[i].comment})},setComment:function(comments){var node=this,name=node.getAttribute("name");[0,1].forEach(function(i){if(comments&&comments[i]&&name.search(i)>0)node.value=comments[i]})}}),error:new Model(error),editevent:new Event(editChar)});editChar.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl"></div></span><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl"></div></div></div>';editChar.reset=function reset(deckId,id){var now=new Date;_currentDataURL=null;error.set("error","");charUpdates={};model.reset();if(id==="newcard"){model.reset(charTemplate);model.set("_id","C:"+now.getTime());model.set("created_on",[now.getFullYear(),now.getMonth(),now.getDate()]);model.set("deck",[deckId])}else{model.sync(Config.get("db"),id)}};editChar.clearDefault=function clearDefault(event,node){var field=node.getAttribute("name");if(model.get(field)==="")node.innerHTML=""};editChar.updateTitle=function updateTitle(event,node){var title=node.innerHTML;title=title.charAt(0).toUpperCase()+title.slice(1);model.set("title",title)};editChar.selectpress=function(event,node){node.value=""};editChar.release=function(event,node){setTimeout(function(){node.classList.remove("pressed")},300)};editChar.uploadnDisplay=function(event,node){var _reader=new FileReader,_img=new Image,el=editChar.dom.querySelector(".cardpicture"),picSpinner=new Spinner({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();el.setAttribute("style","background-image: none");picSpinner.spin(el);_reader.onload=function(e){_img.src=e.target.result;setTimeout(function(){cropImage(resizeImage(_img),function(result){el.setAttribute("style","background-image: url('"+result+"')");picSpinner.stop();_currentDataURL=result})},300)};_reader.readAsDataURL(node.files[0])};editChar.updateField=function(event,node){var prop=node.getAttribute("name"),fn,ln,title;charUpdates[prop]=node.value};editChar.updateLocation=function(event,node){var location=model.get("location"),city,country;city=editChar.dom.querySelector("input[name='city']").value||"";country=editChar.dom.querySelector("input[name='country']").value||"";city&&country?location=city+", "+country:location=city+country;charUpdates.location=location};editChar.updateFamily=function(event,node){var name=node.getAttribute("name"),family=model.get("family");family[name]=node.selectedIndex;charUpdates.family=family};editChar.updateJob=function(event,node){var occupation=model.get("occupation"),name=node.getAttribute("name"),value;switch(name){case"situation":occupation.details[0]=node.selectedIndex;break;case"job":occupation.details[1]=node.value;break;case"organization":occupation.details[2]=node.value;break;default:occupation.description=node.value}charUpdates.occupation=occupation};editChar.updateLeisureName=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),leisure=model.get("leisure_activities");leisure[idx].name=node.value;charUpdates.leisure_activities=leisure};editChar.updateLeisureDesc=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),leisure=model.get("leisure_activities");leisure[idx].comment=node.value;charUpdates.leisure_activities=leisure};editChar.updateInterestName=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),interests=model.get("interests");interests[idx].name=node.value;charUpdates.interests=interests};editChar.updateInterestDesc=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),interests=model.get("interests");interests[idx].comment=node.value;charUpdates.interests=interests};editChar.updateComments=function(event,node){var name=node.getAttribute("name"),idx=name.charAt(name.length-1),comments=model.get("comments");comments[idx]=node.value;charUpdates.comments=comments};editChar.press=function(event,node){node.classList.add("pressed")};editChar.cancel=function(event,node){$close()};editChar.upload=function(event,node){var now=new Date,fn=model.get("firstname"),ln=model.get("lastname");node.classList.remove("pressed");error.set("error","");spinner.spin(node);if(!model.get("title")){if(fn&&ln){model.set("title",fn+" "+ln)}else if(fn||ln){model.set("title",fn+ln)}}if(!model.get("title")){error.set("error",labels.get("titlerequired"))}if(!error.get("error")){if(!model.get("_rev")){model.sync(Config.get("db"),model.get("_id")).then(function(){editChar.uploadCard()})}else{model.set("last_modified",[now.getFullYear(),now.getMonth(),now.getDate()]);editChar.uploadCard(node)}}else{spinner.stop()}};editChar.uploadCard=function uploadCard(node){var prop;if(_currentDataURL){uploadCardPicture();model.set("picture_file",model.get("_id"))}if(charUpdates!=={}){for(prop in charUpdates){model.set(prop,charUpdates[prop])}}model.upload().then(function(){return $update(model.get("type"),model.get("_id"))}).then(function(){spinner.stop();$close();model.unsync();model.reset({})})};return editChar}},{"../../../../../libs/CouchDBTools":72,"../../../../../libs/emily":97,"../../../../../libs/olives":141,"../../../../../libs/spin.min":143,"../../../../../services/config":245,"../../../../../services/utils":256}],210:[function(require,module,exports){var olives=require("../../../../../libs/olives"),emily=require("../../../../../libs/emily"),CouchDBTools=require("../../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../../services/config"),Confirm=require("../../../../../services/confirm"),Map=require("../../../../../services/map"),Store=emily.Store,CouchDBBulkDocuments=CouchDBTools.CouchDBBulkDocuments,CouchDBView=CouchDBTools.CouchDBView,Promise=emily.Promise,Spinner=require("../../../../../libs/spin.min");module.exports=function ImportCardConstructor($update,$close){var importCard=new Widget,labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),db=Config.get("db"),currentDeck=new Store([]),selectedDeck=new Store([]),deletedCards=[],deckId,model=new Store;importCard.template='<div class="importcard"><div class="importfrom"><label data-label="bind:innerHTML, importfrom"></label><select data-model="bind:setDecks, decks" data-importevent="listen: change, updateSelect"></select></div><div class="importlist"><legend data-label="bind:innerHTML, seldeck"></legend><ul name="selected" data-selected="foreach"><li name="selected" data-selected="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="importarea"><button class="addremove invisible" data-model="bind: setVisible, sel; bind: setDirection, direction" data-importevent="listen: mouseup , addRemoveSelected">Add/remove</button><button class="invisible" data-label="bind:innerHTML, selall" data-model="bind:setVisible, sel" data-importevent="listen: mouseup , selectAll"></button><button class="invisible" data-label="bind:innerHTML, clearsel" data-model="bind: setVisible, sel" data-importevent="listen: mouseup , clearSelected">Clear selection</button></div><div class="importlist"><legend data-label="bind:innerHTML, workdeck"></legend><ul data-current="foreach"><li name="current" data-current="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="cancelmail" data-importevent="listen:mousedown, press; listen:mouseup , cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-importevent="listen:mousedown, press; listen:mouseup , upload" data-label="bind:innerHTML, savelbl">Save</div></div>';importCard.seam.addAll({label:new Model(labels),model:new Model(model,{setDecks:function(decks){var i,l,res="",selected,idx;if(decks){for(i=0,l=decks.length;i<l;i++){if(decks[i]._id!==deckId)res+="<option>"+decks[i].title+"</option>"}}this.innerHTML=res},setDirection:function(direction){direction?node.classList.remove("invisible"):node.classList.add("invisible");direction==="remove"?this.innerHTML=labels.get("remsel"):this.innerHTML=labels.get("impsel")},setVisible:function(sel){sel?this.classList.remove("invisible"):this.classList.add("invisible")}}),current:new Model(currentDeck,{setType:function(type){switch(type){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;");break;default:break}},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),selected:new Model(selectedDeck,{setType:function(type){switch(type){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;");break;default:break}},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),importevent:new Event(importCard)});importCard.cancel=function(event,node){node.classList.remove("pressed");$close()};importCard.upload=function(event,node){var spin=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin(node),chr=["newcard"],ctx=["newcard"],pb=["newcard"],tch=["newcard"];
if(deletedCards.length){transport.request("DeleteCards",{idList:deletedCards},function(result){if(result==="ok")deletedCards=[];return result})}currentDeck.loop(function(v,i){switch(v.type){case 1:chr.push(v.id);break;case 2:ctx.push(v.id);break;case 3:pb.push(v.id);break;case 4:tch.push(v.id);break;default:chr.push(v.id);break}});$update({characters:chr,contexts:ctx,problems:pb,techno:tch}).then(function(){spin.stop();node.classList.remove("pressed");$close()})};importCard.press=function(event,node){node.classList.add("pressed")};importCard.updateSelect=function(event,node){var id=node.selectedIndex;selectedDeck.reset([]);importCard.getDeckCards(model.get("decks")[id]._id,selectedDeck)};importCard.toggleSelect=function(event,node){var type=node.getAttribute("name"),id=node.getAttribute("data-"+type+"_id"),store,sel=model.get("sel")||0;if(type==="current"){store=currentDeck;if(model.get("direction")!=="remove"){importCard.clearSelection("selected");model.set("direction","remove");sel=0}}else{store=selectedDeck;if(model.get("direction")!=="add"){importCard.clearSelection("current");model.set("direction","add");sel=0}}if(store.get(id).selected){store.update(id,"selected",false);model.set("sel",sel-1)}else{store.update(id,"selected",true);model.set("sel",sel+1)}};importCard.selectAll=function(event,node){var store;model.get("direction")==="add"?store=selectedDeck:store=currentDeck;store.loop(function(v,i){store.update(i,"selected",true)})};importCard.clearSelected=function(event,node){var store;model.get("direction")==="add"?store=selectedDeck:store=currentDeck;store.loop(function(v,i){store.update(i,"selected",false)});model.set("sel",0)};importCard.addRemoveSelected=function(event,node){var dir=model.get("direction");dir==="add"?importCard.addSelected():importCard.removeSelected()};importCard.addSelected=function addSelected(){var dump=currentDeck.toJSON(),res=JSON.parse(dump),el=importCard.dom.querySelector("ul[name='current']"),spinner=(new Spinner).spin(el);currentDeck.reset([]);selectedDeck.loop(function(v,i){if(v.selected&&dump.search(v.id)===-1)res.push({id:v.id,type:v.type,title:v.title,deck:v.deck.concat(),selected:v.selected})});res.sort(function(x,y){var a=x.title,b=y.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});currentDeck.reset(res);spinner.stop();importCard.clearSelection("selected");model.set("direction","remove")};importCard.removeSelected=function removeSelected(){var toRemove=[],warning=[],warningMSG="";currentDeck.loop(function(v,i){if(v.selected){toRemove.push(i);if(v.deck.length===1&&v.deck[0]===deckId)warning.push({title:v.title.toUpperCase(),id:v.id})}});if(warning.length){warning.forEach(function(card){warningMSG+=card.title+", "});warningMSG=warningMSG.slice(0,-2);Confirm.reset(labels.get("delcardwarning")+warningMSG,function(decision){if(decision){currentDeck.delAll(toRemove);importCard.clearSelection("current");model.set("sel",0);warning.forEach(function(card){deletedCards.push(card.id)})}Confirm.hide()},"importcard-confirm");Confirm.show()}else{currentDeck.delAll(toRemove);importCard.clearSelection("current");model.set("sel",0)}};importCard.clearSelection=function(type){var store;type==="current"?store=currentDeck:store=selectedDeck;store.loop(function(v,i){if(v.selected&&v.selected===true){store.update(i,"selected",false)}})};importCard.getDecks=function getDecks($id){var cdb=new CouchDBBulkDocuments,keys=user.get("taiaut_decks").concat(user.get("custom_decks")),promise=new Promise;cdb.setTransport(transport);cdb.sync(db,{keys:keys}).then(function(){var lang=user.get("lang"),arr=[],i;cdb.loop(function(v,i){if(v.doc.public||v.doc.created_by===user.get("_id")||v.doc.sharedwith&&v.doc.sharedwith.indexOf(user.get("_id"))){if(!v.doc.default_lang||v.doc.default_lang===lang){arr.push(v.doc)}else{v.doc.translations&&v.doc.translations[lang]?arr.push(v.doc.translations[lang]):arr.push(v.doc)}}});for(i=arr.length-1;i>=0;i--){if(arr[i]._id===$id)arr.splice(i,1)}arr.sort(function(x,y){var a=x.title,b=y.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});model.set("decks",arr.concat());promise.fulfill();cdb.unsync()});return promise};importCard.getDeckCards=function getDeckCards($deckId,store){var cdb=new CouchDBView,promise=new Promise,el=importCard.dom.querySelector("ul[name='selected']"),spinner=(new Spinner).spin(el);cdb.setTransport(transport);cdb.sync(db,"library","_view/cards",{key:'"'+$deckId+'"'}).then(function(){var arr=[];cdb.loop(function(v,i){arr.push({id:v.value._id,type:v.value.type,title:v.value.title,deck:v.value.deck})});arr.sort(function(x,y){var a=x.title,b=y.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});spinner.stop();store.reset(arr);promise.fulfill()});return promise};importCard.reset=function reset($deckId){model.reset({});currentDeck.reset([]);selectedDeck.reset([]);deletedCards=[];importCard.dom.querySelector("select").selectedIndex=0;deckId=$deckId;importCard.getDecks(deckId).then(function(){importCard.getDeckCards(deckId,currentDeck);importCard.getDeckCards(model.get("decks")[0]._id,selectedDeck)})};user.watchValue("taiaut_decks",function(){importCard.getDecks()});user.watchValue("custom_decks",function(){importCard.getDecks()});user.watchValue("lang",function(){importCard.getDecks()});return importCard}},{"../../../../../libs/CouchDBTools":72,"../../../../../libs/emily":97,"../../../../../libs/olives":141,"../../../../../libs/spin.min":143,"../../../../../services/config":245,"../../../../../services/confirm":246,"../../../../../services/map":249}],211:[function(require,module,exports){var olives=require("../../../../../libs/olives"),emily=require("../../../../../libs/emily"),amy=require("../../../../../libs/amy2"),CouchDBTools=require("../../../../../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Stack=amy.StackPlugin,Config=require("../../../../../services/config"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,EditChar=require("./editchar"),EditCard=require("./editcard"),ImportCard=require("./importcard"),Promise=emily.Promise;module.exports=function NewCardConstructor($update){var newCard=new Widget,_contentStack=new Stack,cardSetup=new Store;cardCDB=new CouchDBDocument,labels=Config.get("labels"),user=Config.get("user"),transport=Config.get("transport"),close=function(){newCard.dom.classList.add("invisible")},updateDeck=function(cardType,cardId){var promise=new Promise,deckId=cardSetup.get("deckId"),deckCDB=new CouchDBDocument,type="characters";switch(cardType){case 1:type="characters";break;case 2:type="contexts";break;case 3:type="problems";break;case 4:type="techno";break;default:console.log("no type detected");break}deckCDB.setTransport(transport);deckCDB.sync(Config.get("db"),deckId).then(function(){var now=new Date,content=deckCDB.get("content"),arr=content[type];if(arr.indexOf(cardId)<0){arr.push(cardId);content[type]=arr;deckCDB.set("content",content)}deckCDB.set("last_updated",[now.getFullYear(),now.getMonth(),now.getDate()]);return deckCDB.upload()}).then(function(){deckCDB.unsync();$update("updated",deckId,cardType);promise.fulfill()});return promise},removeCard=function(cardId){var cdb=new CouchDBDocument,promise=new Promise;cdb.setTransport(transport);cdb.sync(Config.get("db"),cardId).then(function(){var deck=cdb.get("deck")||[],p=new Promise;deck.splice(deck.indexOf(cardSetup.get("deckId")),1);if(deck.length){cdb.set("deck",deck);cdb.upload().then(function(){p.fulfill()})}else{if(file.search("img/decks")===-1){json={type:"card",file:file};transport.request("DeleteAttachment",json,function(result){if(result!=="ok"){console.log(result)}})}cdb.remove().then(function(){p.fulfill()})}return p}).then(function(){return promise});return promise},addToDeck=function(cardId){var cdb=new CouchDBDocument,promise=new Promise;cdb.setTransport(transport);cdb.sync(Config.get("db"),cardId).then(function(){var deck=cdb.get("deck")||[],id=cardSetup.get("deckId");if(deck.indexOf(id)<0)deck.push(id);cdb.set("deck",deck);return cdb.upload()}).then(function(){promise.fulfill();cdb.unsync()});return promise},updateImport=function(content){var promise=new Promise,deckId=cardSetup.get("deckId"),cdb=new CouchDBDocument,toAdd=[],toRemove=[],now=new Date;cdb.setTransport(transport);cdb.sync(Config.get("db"),deckId).then(function(){var oldContent={},newContent={characters:content.characters.concat(),contexts:content.contexts.concat(),problems:content.problems.concat(),techno:content.techno.concat()},trans,isTranslation=false;cdb.get("translations")?trans=cdb.get("translations"):trans={};if(trans.hasOwnProperty(user.get("lang")))isTranslation=true;if(isTranslation){["characters","contexts","problems","techno"].forEach(function(type){oldContent[type]=trans[user.get("lang")].content[type].concat()});trans[user.get("lang")].content=newContent;cdb.set("translations",trans)}else{["characters","contexts","problems","techno"].forEach(function(type){oldContent[type]=cdb.get("content")[type].concat()});cdb.set("content",newContent)}["characters","contexts","problems","techno"].forEach(function(type){var old=oldContent[type],upd=newContent[type],i,j,k,l;for(i=0,l=old.length;i<l;i++){if(upd.indexOf(old[i])<0)toRemove.push(old[i])}for(j=0,k=upd.length;j<k;j++){if(old.indexOf(upd[j])<0)toAdd.push(upd[j])}});toAdd.forEach(function(cardId){addToDeck(cardId)});toRemove.forEach(function(cardId){removeCard(cardId)});if(toAdd.length||toRemove.length){cdb.set("last_updated",[now.getFullYear(),now.getMonth(),now.getDate()])}return cdb.upload()}).then(function(){$update("updated",deckId,null);promise.fulfill()});return promise},editCard=new EditCard(updateDeck,close),editChar=new EditChar(updateDeck,close),importCard=new ImportCard(updateImport,close);newCard.template='<div id="card_creation" class="invisible"><div class="header blue-dark" data-label="bind: innerHTML, cardeditor"></div><div class="create_header"><label data-label="bind:innerHTML, createnew"></label><select class="changetype" data-setup="bind: selectedIndex, type" data-newcardevent="listen: change, changeType"><option data-label="bind:innerHTML, char"></option><option data-label="bind:innerHTML, context"></option><option data-label="bind:innerHTML, problem"></option><option data-label="bind:innerHTML, techno"></option><option data-label="bind:innerHTML, importcard"></option></select></div><div class="createcontentstack" data-newcardcontentstack="destination"></div></div>';newCard.seam.addAll({label:new Model(labels),setup:new Model(cardSetup),newcardcontentstack:_contentStack,newcardevent:new Event(newCard)});newCard.close=close;newCard.reset=function reset($cardId,$cardType,$deckId,$deckTitle){document.getElementById("card_creation").classList.remove("invisible");cardSetup.reset({deckId:$deckId,title:$deckTitle,type:["characters","contexts","problems","techno"].indexOf($cardType)});if($cardType==="characters"){editChar.reset($deckId,$cardId);_contentStack.getStack().show("editchar")}else{editCard.reset($deckId,$cardId,$cardType);_contentStack.getStack().show("editcard")}};newCard.press=function(event,node){node.classList.add("pressed")};newCard.changeType=function(event,node){var idx=node.selectedIndex;if(idx===4){importCard.reset(cardSetup.get("deckId"));_contentStack.getStack().show("importcard")}else if(idx===0){editChar.reset(cardSetup.get("deckId"),"newcard");_contentStack.getStack().show("editchar")}else{editCard.reset(cardSetup.get("deckId"),"newcard",cardSetup.get("type"));_contentStack.getStack().show("editcard");editCard.changeType(idx)}};newCard.init=function(){_contentStack.getStack().add("editchar",editChar);_contentStack.getStack().add("editcard",editCard);_contentStack.getStack().add("importcard",importCard)};newCard.init();return newCard}},{"../../../../../libs/CouchDBTools":72,"../../../../../libs/amy2":75,"../../../../../libs/emily":97,"../../../../../libs/olives":141,"../../../../../services/config":245,"./editcard":208,"./editchar":209,"./importcard":210}],212:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,CouchDBBulkDocuments=CouchDBTools.CouchDBBulkDocuments,Promise=emily.Promise,CardPopup=require("../../../../services/cardpopup");module.exports=function CardListConstructor($cardType,$editCard,$update){var cardList=new Widget,cards=new Store([]),cardPage=new Store([]),pagination=new Store({currentPage:0,nbPages:0}),popupUI,labels=Config.get("labels"),user=Config.get("user"),currentDeck=null,currentHighlight=null;cardList.seam.addAll({pagination:new Model(pagination,{setPage:function(currentPage){var nb=currentPage+1;if(pagination.get("nbPages")>1){this.innerHTML=labels.get("page")+nb+" / "+pagination.get("nbPages")}else this.innerHTML=""},setLeft:function(currentPage){currentPage>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(currentPage){currentPage<pagination.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new Model(cardPage,{formatTitle:function(title){if(title){this.classList.remove("newcard");if($cardType!=="techno"){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else{this.innerHTML=title.toUpperCase();this.setAttribute("style","font-family:Helvetica;")}}else{this.classList.add("newcard")}},setPic:function(pic){var json,node=this;if(pic&&pic.search("img/decks/")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else if(pic){json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})}else{switch($cardType){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}}),cardlistevent:new Event(cardList)});cardList.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:dblclick, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn" data-cardlistevent="listen: mousedown, press; listen:mouseup, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: mousedown, press; listen:mouseup, deleteCard"></div></div></li></ul></div></div>';cardList.reset=function reset(deck){currentHighlight=null;cardList.dom.querySelector("#cardlist-popup").classList.add("invisible");currentDeck=deck;cardList.getCardList(deck.content[$cardType])};cardList.getCardList=function getCardList(idlist){var cdb=new CouchDBBulkDocuments,query=idlist,promise=new Promise;if(idlist[0]==="newcard"){query=idlist.slice(1,idlist.length)}if(query.length){cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),{keys:query}).then(function(){idlist[0]==="newcard"?cards.reset([{_id:"newcard",title:"",picture_file:""}]):cards.reset([]);cdb.loop(function(v,i){cards.alter("push",v.doc)});pagination.set("nbPages",Math.ceil(cards.count()/12));cardList.displayPage(0);promise.fulfill();cdb.unsync()})}else{cards.reset([{_id:"newcard",title:"",picture_file:""}]);pagination.set("nbPages",1);cardList.displayPage(0);promise.fulfill()}return promise};cardList.displayPage=function displayPage(pageNB){var i,length=cards.count()-12*pageNB;pagination.set("currentPage",pageNB);cardPage.reset([]);for(i=0;i<length;i++){cardPage.alter("push",cards.get(pageNB*12+i))}};cardList.removeCard=function removeCard(cardId){var deckCDB=new CouchDBDocument,cardCDB=new CouchDBDocument,chcount,ctcount,pbcount,tecount,checkRemove=true;if(user.get("active_deck")===currentDeck._id){chcount=currentDeck.content.characters.length;ctcount=currentDeck.content.contexts.length;pbcount=currentDeck.content.problems.length;tecount=currentDeck.content.techno.length;if(chcount<=2||ctcount<=2||pbcount<=2||tecount<=4){checkRemove=false;alert(labels.get("cannotremovecard"))}}if(checkRemove){deckCDB.setTransport(Config.get("transport"));cardCDB.setTransport(Config.get("transport"));deckCDB.sync(Config.get("db"),currentDeck._id).then(function(){var content=deckCDB.get("content"),arr=content[$cardType];arr.splice(arr.indexOf(cardId),1);content[$cardType]=arr;deckCDB.set("content",content);return deckCDB.upload()}).then(function(){$update("updated",currentDeck._id,$cardType);deckCDB.unsync();return cardCDB.sync(Config.get("db"),cardId)}).then(function(){var decks=cardCDB.get("deck"),promise=new Promise,json,file=cardCDB.get("picture_file");decks.splice(decks.indexOf(currentDeck._id),1);if(decks.length){cardCDB.set("deck",decks);cardCDB.upload().then(function(){promise.fulfill()})}else{if(file.search("img/decks")===-1){json={type:"card",file:file};Config.get("transport").request("DeleteAttachment",json,function(result){if(result!=="ok"){console.log(result)}})}cardCDB.remove().then(function(){promise.fulfill()})}return promise})}};cardList.push=function(event,node){node.classList.add("invisible");event.stopPropagation()};cardList.press=function(event,node){node.classList.add("pressed")};cardList.previousPage=function(event,node){cardList.displayPrevious()};cardList.nextPage=function(event,node){cardList.displayNext()};cardList.displayPrevious=function displayPrevious(){var nb=pagination.get("currentPage");if(nb>0){cardList.displayPage(nb-1)}};cardList.displayNext=function displayNext(){var nb=pagination.get("currentPage");if(nb<pagination.get("nbPages")-1)cardList.displayPage(nb+1)};cardList.changePage=function(event,node){var touchPoint=[event.pageX,event.pageY];if(touchPoint[0]>(document.width+301)/2){cardList.displayNext()}else{cardList.displayPrevious()}};cardList.highlight=function(event,node){if(currentHighlight!==null)document.querySelector("li[data-cards_id='"+currentHighlight+"']").classList.remove("highlighted");currentHighlight=node.getAttribute("data-cards_id");node.classList.add("highlighted")};cardList.zoom=function(event,node){var id=node.getAttribute("data-cards_id");if(cardPage.get(id)._id==="newcard"){$editCard("newcard",$cardType);node.classList.remove("highlighted")}else{cardList.setPopup(id);if(user.get("_id")===currentDeck.created_by){node.querySelector(".cardbtnbar").classList.remove("invisible");if(cardPage.get(id).created_by===user.get("_id")){node.querySelector(".editcardbtn").classList.remove("invisible")}else{node.querySelector(".editcardbtn").classList.add("invisible")}}}};cardList.editCard=function editCard(event,node){var id=node.getAttribute("data-cards_id");event.stopPropagation();popupUI.close();node.parentNode.classList.add("invisible");$editCard(cardPage.get(id)._id,$cardType)};cardList.deleteCard=function deleteCard(event,node){var id=node.getAttribute("data-cards_id");event.stopPropagation();popupUI.close();node.parentNode.classList.add("invisible");cardList.removeCard(cardPage.get(id)._id)};cardList.setPopup=function setPopup($id){var id,pos={x:0,y:0},caret="";id=$id%12;switch(id){case 1:pos.x=304;pos.y=157;caret="left";break;case 2:pos.x=23;pos.y=157;caret="right";break;case 3:pos.x=170;pos.y=157;caret="right";break;case 4:pos.x=157;pos.y=339;caret="left";break;case 5:pos.x=304;pos.y=339;caret="left";break;case 6:pos.x=23;pos.y=339;caret="right";break;case 7:pos.x=170;pos.y=339;caret="right";break;case 8:pos.x=157;pos.y=350;caret="left";break;case 9:pos.x=304;pos.y=350;caret="left";break;case 10:pos.x=23;pos.y=350;caret="right";break;case 11:pos.x=170;pos.y=350;caret="right";break;default:pos.x=157;pos.y=157;caret="left";break}popupUI.reset(cardPage.get($id),pos,caret,document.getElementById("cardlist-popup"))};cardList.closePopup=function closePopup(){cardList.dom.querySelector("li[data-cards_id='"+currentHighlight+"']").classList.remove("highlighted");cardList.dom.querySelector("li[data-cards_id='"+currentHighlight+"']").querySelector(".cardbtnbar").classList.add("invisible");currentHighlight=null};popupUI=new CardPopup(cardList.closePopup);return cardList}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/cardpopup":244,"../../../../services/config":245}],213:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,Utils=require("../../../../services/utils"),Avatar=require("../../../../services/avatar"),AutoContact=require("../../../../services/autocontact"),Spinner=require("../../../../libs/spin.min");module.exports=function DeckShareConstructor($action){var _widget=new Widget,_error=new Store({errormsg:""}),_user=Config.get("user"),_transport=Config.get("transport"),_labels=Config.get("labels"),_share=new Store({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:_user.get("signature")}),contactList=new Store([]),shareContacts=new Store([]),sendInProgress=false,spinner=new Spinner({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6}).spin();_widget.seam.addAll({labels:new Model(_labels),share:new Model(_share,{setHeader:function(title){this.innerHTML=_labels.get("sharing")+title}}),contacts:new Model(shareContacts,{setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new Event(_widget),errormsg:new Model(_error)});_widget.template='<div class="deck-share invisible"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mouseup,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';_widget.show=function show(){_widget.dom.classList.remove("invisible");document.getElementById("deckview").setAttribute("style","overflow-y: scroll;")};_widget.hide=function hide(){_widget.dom.classList.add("invisible");document.getElementById("deckview")&&document.getElementById("deckview").setAttribute("style","overflow-y: none;");_share.reset({body:"",docId:"",docType:"",docTitle:"",signature:_user.get("username")+" <"+_user.get("_id")+">"});_error.reset({errormsg:""});shareContacts.reset([]);contactList.reset(_user.get("connections").concat())};_widget.reset=function reset($id){_error.reset({errormsg:""});_share.reset({body:"",docId:$id,docType:"",docTitle:"",signature:_user.get("username")+" <"+_user.get("_id")+">"});_widget.getDocDetails($id);if(_user.get("signature"))_share.set("signature",_user.get("signature"));shareContacts.reset([]);contactList.reset(_user.get("connections").concat())};_widget.getDocDetails=function getDocDetails(id){var cdb=new CouchDBDocument({});cdb.setTransport(_transport);cdb.sync(Config.get("db"),id).then(function(){_share.set("docType",cdb.get("type"));_share.set("docTitle",cdb.get("title"));cdb.unsync()})};_widget.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=_user.get("connections").concat(),clc,vlc=node.value.toLowerCase();if(node.value===""){contactList.reset(connections)}else{for(i=arr.length-1;i>=0;i--){clc=arr[i].username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}contactList.reset(arr)}contactList.loop(function(v,i){if(shareContacts.toJSON().search(v.userid)>-1)contactList.update(i,"selected",true)})};_widget.close=function close(event,node){node.parentNode.classList.add("invisible")};_widget.displayAutoContact=function(event,node){_widget.dom.querySelector("#sharelistauto").classList.remove("invisible");contactList.reset(_user.get("connections").concat())};_widget.discardContact=function(event,node){var id=node.getAttribute("data-contacts_id"),userid=shareContacts.get(id).userid;shareContacts.alter("splice",id,1);contactList.loop(function(v,i){if(v.userid===userid){setTimeout(function(){contactList.update(i,"selected",false)},200)}});_widget.unselectGroup(userid)};_widget.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){_widget.removeContact(contactList.get(id));setTimeout(function(){contactList.update(id,"selected",false);document.getElementById("sharelistauto").classList.add("invisible")},200)}else{_widget.addContact(contactList.get(id));_widget.selectGroup();setTimeout(function(){contactList.update(id,"selected",true);document.getElementById("sharelistauto").classList.add("invisible")},200)}};_widget.selectAll=function(event,node){node.classList.remove("pressed");shareContacts.reset([]);contactList.reset(_user.get("connections").concat());contactList.loop(function(v,i){contactList.update(i,"selected",true);if(v.type==="user")shareContacts.alter("push",v)})};_widget.removeContact=function(contact){if(contact.type==="group"){for(j=contact.contacts.length-1;j>=0;j--){_widget.removeContact(contact.contacts[j])}}else{shareContacts.loop(function(v,i){if(v.userid===contact.userid)shareContacts.alter("splice",i,1)});_widget.unselectGroup(contact.userid);contactList.loop(function(val,idx){if(val.userid===contact.userid)contactList.update(idx,"selected",false)})}};_widget.selectGroup=function(){var cts,add=false;contactList.loop(function(v,i){if(v.type==="group"&&!v.selected){cts=v.contacts;add=true;for(j=cts.length-1;j>=0;j--){if(shareContacts.toJSON().search(cts[j].userid)<0){add=false;break}}if(add){contactList.update(i,"selected",true)}}})};_widget.unselectGroup=function(userid){contactList.loop(function(v,i){if(v.type==="group"&&v.selected){if(JSON.stringify(v.contacts).search(userid)>0)contactList.update(i,"selected",false)}})};_widget.addContact=function(contact){var i,l,add=true;if(contact.type==="user")shareContacts.alter("push",contact);else{for(i=0,l=contact.contacts.length;i<l;i++){shareContacts.loop(function(val,idx){if(val.userid===contact.contacts[i].userid){add=false}});if(add){shareContacts.alter("push",contact.contacts[i]);contactList.loop(function(val,idx){if(val.userid===contact.contacts[i].userid){contactList.update(idx,"selected",true)}})}}}};_widget.press=function(event,node){node.classList.add("pressed")};_widget.share=function(event,node){var now=new Date,promise=new Promise,json={type:"DOC",status:"unread",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getMinutes()],author:_user.get("_id"),username:_user.get("username"),firstname:_user.get("firstname"),toList:"",ccList:"",object:"",body:_share.get("body"),signature:_share.get("signature"),docId:_share.get("docId"),docType:_share.get("docType"),docTitle:_share.get("docTitle"),dest:[]};if(!sendInProgress){sendInProgress=true;spinner.spin(node);_widget.buildRecipientList(json.docId,json.dest).then(function(){if(!json.dest.length){_error.set("errormsg",_labels.get("alreadyshared"));node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());_widget.hide()},2500)}else{_transport.request("ShareDeck",{idList:json.dest,docId:json.docId},function(result){if(result==="ok"){promise.fulfill()}});promise.then(function(){_transport.request("Notify",json,function(result){_error.set("errormsg",_labels.get("shareok"));node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());_widget.hide()},2500)})})}})}};_widget.cancel=function(event,node){node.classList.remove("pressed");_widget.hide()};_widget.buildRecipientList=function buildRecipientList(docId,dest){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),docId).then(function(){var sharedwith=cdb.get("sharedwith")||[],i;shareContacts.loop(function(v,i){if(!sharedwith.length){sharedwith.push(v.userid);dest.push(v.userid)}else{if(sharedwith.indexOf(v.userid)<0){sharedwith.push(v.userid);dest.push(v.userid)}}});cdb.set("sharedwith",sharedwith);return cdb.upload()}).then(function(){promise.fulfill()});return promise};return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/autocontact":241,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256}],214:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,CouchDBView=CouchDBTools.CouchDBView,Utils=require("../../../../services/utils"),Spinner=require("../../../../libs/spin.min");module.exports=function DeckDetailsConstructor($update){var deckDetails=new Widget,deckModel=new Store,range=new Store({max:0}),deckCards=new Store([]),allCards=new CouchDBView,carouselSpinner=new Spinner({top:255,left:297,lines:8,radius:6,color:"#cccccc"}).spin(),user=Config.get("user"),labels=Config.get("labels"),_languages=new Store(Config.get("userLanguages")),_resetLang=function(){_languages.loop(function(v,i){deckModel.get("default_lang")&&v.name===deckModel.get("default_lang").substring(0,2)?_languages.update(i,"selected",true):_languages.update(i,"selected",false)
})},_currentDeck,_currentDataURL,MIN_WIDTH=60,MIN_HEIGHT=60,resizeImage=function(img){var _width,_height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");_width=img.width;_height=img.height;if(_width<_height){_height*=MIN_WIDTH/_width;_width=MIN_WIDTH}else{_width*=MIN_HEIGHT/_height;_height=MIN_HEIGHT}canvas.width=_width;canvas.height=_height;ctx.drawImage(img,0,0,_width,_height);return canvas.toDataURL("image/png")},cropImage=function(dataURL,onEnd){var image=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),dw=MIN_WIDTH,dh=MIN_HEIGHT,sx,sy;image.src=dataURL;setTimeout(function(){canvas.width=dw;canvas.height=dh;sx=Math.floor(Math.max(0,(image.width-dw)/2));sy=Math.floor(Math.max(0,(image.height-dh)/2));ctx.drawImage(image,sx,sy,dw,dh,0,0,dw,dh);onEnd(canvas.toDataURL("image/png"))},300)},uploadDeckIcon=function(){var _url="/upload",_fd=new FormData,_type="deckpic",_dataURL=_currentDataURL;_fd.append("type",_type);_fd.append("dir","decks");_fd.append("filename",deckModel.get("_id"));_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,null,function(result){return result})};allCards.setTransport(Config.get("transport"));deckDetails.seam.addAll({labels:new Model(labels),range:new Model(range,{setCursorWidth:function(max){}}),cards:new Model(deckCards,{setStyle:function(style){if(style&&style==="null"){this.classList.add("invisible")}else{this.classList.remove("invisible")}},formatTitle:function(title){var id,node=this;if(title){id=node.getAttribute("data-cards_id");if(deckCards.get(id).type&&deckCards.get(id).type!==4){this.innerHTML=title.substring(0,1).toUpperCase()+title.substring(1).toLowerCase()}else{this.innerHTML=title.toUpperCase();this.setAttribute("style","font-family:Helvetica;")}}},setPic:function(pic){var json,node=this,picSpinner;if(pic&&pic.search("img/decks/")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else if(pic){picSpinner=new Spinner({color:"#657b99"}).spin(node);json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background-image: url('"+data+"');");picSpinner.stop()})}else{this.setAttribute("style","background-image: none;")}}}),deckdetails:new Model(deckModel,{displayLang:function(lang){var l;if(lang){deckDetails.dom.querySelector(".idealang").classList.remove("invisible");l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}else deckDetails.dom.querySelector(".idealang").classList.add("invisible")},formatDate:function(date){date?this.innerHTML=Utils.formatDate(date):this.innerHTML=""},setPic:function(picture){var json,node=this,picSpinner;if(picture===""){this.setAttribute("style","background-image:url('img/connect/graygroup.png');")}else if(picture==="img/logo.png"){this.setAttribute("style","background-image:url('img/logo.png');")}else if(picture==="decklogo"){picSpinner=new Spinner({color:"#657b99"}).spin(node);json={dir:"decks",filename:deckModel.get("_id")};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background-image: url('"+data+"');");picSpinner.stop()})}if(deckModel.get("created_by")===user.get("_id")){node.querySelector("input").classList.remove("invisible")}},edit:function(uid){if(uid===user.get("_id")){this.setAttribute("contenteditable",true);this.classList.add("editable")}else{this.setAttribute("contenteditable",false);this.classList.remove("editable")}}}),select:new Model(_languages,{setBg:function(name){if(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),carouselevent:new Event(deckDetails),editevent:new Event(deckDetails)});deckDetails.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="idealang invisible"><div class="currentlang" data-deckdetails="bind: displayLang, default_lang" data-editevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: mousedown, editPic"><input class="invisible" type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: change, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" data-deckdetails="bind:formatDate,date"></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider invisible" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div></div>';deckDetails.displayCards=function displayCards(id){var i,arr=[],slider=deckDetails.dom.querySelector(".deckslider");for(i=0;i<5;i++){allCards.get(id-2+i)?arr[i]=allCards.get(id-2+i).value:arr[i]={style:"null"}}deckCards.reset(arr);deckCards.count()?slider.classList.remove("invisible"):slider.classList.add("invisible")};deckDetails.updateCards=function(event,node){deckDetails.displayCards(node.value)};deckDetails.displayButtons=function(event,node){deckDetails.dom.querySelector(".cancelmail").classList.remove("invisible");deckDetails.dom.querySelector(".sendmail").classList.remove("invisible")};deckDetails.hideButtons=function(){deckDetails.dom.querySelector(".cancelmail").classList.add("invisible");deckDetails.dom.querySelector(".sendmail").classList.add("invisible")};deckDetails.editPic=function(event,node){if(deckModel.get("created_by")===user.get("_id")){node.setAttribute("style","background-image: url('img/brainstorm/reload.png')");document.body.onfocus=function(){if(!node.querySelector("input").value.length){deckModel.set("picture_file","");deckModel.set("picture_file",_currentDeck.picture_file)}document.body.onfocus=null}}};deckDetails.showLang=function(event,node){if(deckModel.get("created_by")===user.get("_id")){deckDetails.dom.querySelector(".idealang ul").classList.remove("invisible")}};deckDetails.selectFlag=function(event,node){var id;event.stopPropagation();event.preventDefault();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};deckDetails.setLang=function(event,node){var id;event.stopPropagation();event.preventDefault();id=node.getAttribute("data-select_id");deckModel.set("default_lang",_languages.get(id).name);if(deckModel.get("default_lang")!==_currentDeck.default_lang.substring(0,2)){deckDetails.displayButtons()}else{deckDetails.hideButtons()}deckDetails.dom.querySelector(".idealang ul").classList.add("invisible")};deckDetails.changePic=function(event,node){var _reader=new FileReader,_img=new Image,el=deckDetails.dom.querySelector(".decklogo"),picSpinner=new Spinner({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();el.setAttribute("style","background-image: none");picSpinner.spin(el);_reader.onload=function(e){_img.src=e.target.result;setTimeout(function(){cropImage(resizeImage(_img),function(result){el.setAttribute("style","background-image: url('"+result+"')");picSpinner.stop();_currentDataURL=result;deckDetails.displayButtons()})},300)};if(node.files.length){_reader.readAsDataURL(node.files[0])}else{node.querySelector("input").classList.add("invisible")}};deckDetails.press=function(event,node){node.classList.add("pressed")};deckDetails.cancel=function(event,node){deckModel.reset(_currentDeck);deckDetails.hideButtons();node.classList.remove("pressed")};deckDetails.upload=function(event,node){var deckCDB=new CouchDBDocument,title=deckDetails.dom.querySelector(".deckheader h2").innerHTML,description=deckDetails.dom.querySelector(".deckdescription").innerHTML,uploadSpinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30}).spin(node);node.classList.add("invisible");deckCDB.setTransport(Config.get("transport"));deckCDB.sync(Config.get("db"),deckModel.get("_id")).then(function(){var now=new Date;if(_currentDataURL){uploadDeckIcon();deckCDB.set("picture_file","decklogo")}deckCDB.set("title",title);deckCDB.set("description",description);deckCDB.set("last_updated",[now.getFullYear(),now.getMonth(),now.getDate()]);return deckCDB.upload()}).then(function(){$update("updated",deckCDB.get("_id"));deckDetails.hideButtons();node.classList.remove("pressed");uploadSpinner.stop()});if(_currentDataURL){uploadDeckIcon()}};deckDetails.reset=function reset(deck){var slider=deckDetails.dom.querySelector(".deckslider");slider.classList.add("invisible");deckDetails.dom.querySelector(".cancelmail").classList.add("invisible");deckDetails.dom.querySelector(".sendmail").classList.add("invisible");_currentDataURL=null;deckModel.set("picture_file","");deckModel.reset(deck);_resetLang();deckCards.reset([]);_currentDeck=JSON.parse(deckModel.toJSON());range.set("max",0);carouselSpinner.spin(deckDetails.dom.querySelector(".deckcarousel"));allCards.reset([]);allCards.sync(Config.get("db"),"library","_view/cards",{key:'"'+deckModel.get("_id")+'"'}).then(function(){carouselSpinner.stop();if(allCards.count())range.set("max",allCards.count()-1);allCards.unsync();allCards.alter("sort",function(x,y){var a=x.value.title,b=y.value.title;if(a<b)return-1;if(a>b)return 1;if(a===b)return 0});deckDetails.displayCards(0)})};return deckDetails}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/config":245,"../../../../services/utils":256}],215:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),amy=require("../../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../../services/map"),Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Stack=amy.StackPlugin,Store=emily.Store,DeckDetails=require("./deckdetails"),CardList=require("./cardlist"),NewCard=require("./cardeditor/newcard"),DeckShare=require("./deck-share");module.exports=function DeckViewConstructor($update){var deckView=new Widget,newCardUI=new NewCard($update),deckShareUI=new DeckShare,cardMenu=new Store([{name:"characters",active:false,count:0},{name:"contexts",active:false,count:0},{name:"problems",active:false,count:0},{name:"techno",active:false,count:0}]),innerStack=new Stack,deckTitle="",deckId="";deckView.seam.addAll({cardmenu:new Model(cardMenu,{setClass:function(name){name&&this.classList.add(name)},setActive:function(active){active?this.classList.add("active"):this.classList.remove("active")}}),place:new Place({newCard:newCardUI,shareDeck:deckShareUI}),deckviewstack:innerStack,deckviewevent:new Event(deckView)});deckView.template='<div id="deckview" class="details"><div data-place="place: newCard"></div><div data-place="place: shareDeck"></div><ul class="card-menu" data-cardmenu="foreach"><li><div class="card-type" data-cardmenu = "bind: setClass, name; bind:setActive, active" data-deckviewevent="listen: mousedown, viewCards"></div><div class="card-count" data-cardmenu="bind:innerHTML, count"></div></li></li></ul><div id="deckviewstack" data-deckviewstack="destination"></div></div>';deckView.viewCards=function(event,node){var id=node.getAttribute("data-cardmenu_id");cardMenu.loop(function(v,i){i===parseInt(id)?cardMenu.update(i,"active",true):cardMenu.update(i,"active",false)});innerStack.getStack().show(cardMenu.get(id).name)};deckView.editCard=function editCard(id,type){newCardUI.reset(id,type,deckId,deckTitle)};deckView.hideEditView=function hideEditView(){newCardUI&&newCardUI.close()};deckView.reset=function reset(deck,screen){deckView.hideEditView();deckShareUI.hide();deckView.dom.setAttribute("style","overflow-y: none;");["details","characters","contexts","problems","techno"].forEach(function(value){innerStack.getStack().get(value).reset(deck)});deckId=deck._id;deckTitle=deck.title;cardMenu.reset([]);["characters","contexts","problems","techno"].forEach(function(type){if(deck.content[type][0]==="newcard"){cardMenu.alter("push",{name:type,active:false,count:deck.content[type].length-1})}else{cardMenu.alter("push",{name:type,active:false,count:deck.content[type].length})}});screen?innerStack.getStack().show(screen):innerStack.getStack().show("details")};deckView.init=function init(){innerStack.getStack().add("details",new DeckDetails($update));innerStack.getStack().add("characters",new CardList("characters",deckView.editCard,$update));innerStack.getStack().add("contexts",new CardList("contexts",deckView.editCard,$update));innerStack.getStack().add("problems",new CardList("problems",deckView.editCard,$update));innerStack.getStack().add("techno",new CardList("techno",deckView.editCard,$update))};Config.get("observer").watch("deck-share",function(deckId){deckShareUI.reset(deckId);deckShareUI.show()});return deckView}},{"../../../../libs/amy2":75,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/config":245,"../../../../services/map":249,"./cardeditor/newcard":211,"./cardlist":212,"./deck-share":213,"./deckdetails":214}],216:[function(require,module,exports){var olives=require("../../../libs/olives"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../services/config"),Store=CouchDBTools.CouchDBDocument,Spinner=require("../../../libs/spin.min"),Utils=require("../../../services/utils");module.exports=function newConstructor($onEnd){var _widget=new Widget,_store=new Store({}),_user=Config.get("user"),_languages=new Store(Config.get("userLanguages")),_resetLang=function(){var l=_user.get("lang").substring(0,2);_store.set("default_lang",l);_languages.loop(function(v,i){v.name===l?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_transport=Config.get("transport"),_labels=Config.get("labels"),_error=new Store({error:""}),spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin(),_currentDataURL,MIN_WIDTH=60,MIN_HEIGHT=60,resizeImage=function(img){var _width,_height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");_width=img.width;_height=img.height;if(_width<_height){_height*=MIN_WIDTH/_width;_width=MIN_WIDTH}else{_width*=MIN_HEIGHT/_height;_height=MIN_HEIGHT}canvas.width=_width;canvas.height=_height;ctx.drawImage(img,0,0,_width,_height);return canvas.toDataURL("image/png")},cropImage=function(dataURL,onEnd){var image=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),dw=MIN_WIDTH,dh=MIN_HEIGHT,sx,sy;image.src=dataURL;setTimeout(function(){canvas.width=dw;canvas.height=dh;sx=Math.floor(Math.max(0,(image.width-dw)/2));sy=Math.floor(Math.max(0,(image.height-dh)/2));ctx.drawImage(image,sx,sy,dw,dh,0,0,dw,dh);onEnd(canvas.toDataURL("image/png"))},300)},uploadDeckIcon=function(){var _url="/upload",_fd=new FormData,_type="deckpic",_dir="decks",_dataURL=_currentDataURL;_fd.append("type",_type);_fd.append("dir",_dir);_fd.append("filename",_store.get("_id"));_fd.append("dataString",_dataURL);Utils.uploadFile(_url,_fd,null,function(result){console.log(result)})};_store.setTransport(Config.get("transport"));_resetLang();_widget.seam.addAll({newdeck:new Model(_store,{displayLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}}),select:new Model(_languages,{setBg:function(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new Model(_labels),errormsg:new Model(_error,{setError:function(error){switch(error){case"notitle":this.innerHTML=_labels.get("titlefield")+_labels.get("emptyfielderror");break;case"nodesc":this.innerHTML=_labels.get("descriptionfield")+_labels.get("emptyfielderror");break;default:this.innerHTML=error}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new Event(_widget)});_widget.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newdeck="bind: displayLang, default_lang" data-newdeckevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newdeckevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend data-labels="bind: innerHTML, setdecklogo"></legend><div class="deckicon"><div class="decklogo"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-newdeckevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-labels="bind:innerHTML, importlbl" data-newdeckevent="listen: mousedown, press; listen: mouseup, release"></div></span></div><div class="newidea-footer"><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>';_widget.reset=function reset(edit){_store.reset({_id:"",type:9,description:"",default_lang:_user.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:_user.get("_id"),author:_user.get("username"),"public":false,sharedwith:[]});_currentDataURL=null};_widget.show=function show(){_widget.reset();document.querySelector("#library .cache").classList.add("appear");_widget.dom.classList.add("appear")};_widget.press=function(event,node){node.classList.add("pressed")};_widget.showLang=function(event,node){_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");_store.set("default_lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.selectpress=function(event,node){node.value=""};_widget.release=function(event,node){setTimeout(function(){node.classList.remove("pressed")},300)};_widget.uploadnDisplay=function(event,node){var _reader=new FileReader,_img=new Image,el=_widget.dom.querySelector(".decklogo"),picSpinner=new Spinner({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();el.setAttribute("style","background-image: none;");picSpinner.spin(el);_reader.onload=function(e){_img.src=e.target.result;setTimeout(function(){cropImage(resizeImage(_img),function(result){el.setAttribute("style","background-image: url('"+result+"')");picSpinner.stop();_currentDataURL=result;_store.set("picture_file","decklogo")})},300)};_reader.readAsDataURL(node.files[0])};_widget.closePopup=function closePopup(){_widget.dom.classList.remove("appear");document.querySelector("#library .cache").classList.remove("appear");_store.unsync();_widget.reset();_error.reset({error:""})};_widget.resetError=function(event,node){var name;node.scrollTop=99999;if(_error.get("error")){if(node.classList.contains("description")){name="nodesc"}else if(node.classList.contains("solution")){name="nosol"}else{name="notitle"}if(_error.get("error")===name&&node.value){_error.set("error","")}}};_widget.cancel=function(event,node){_widget.closePopup()};_widget.upload=function(event,node){var now=new Date,id="D:"+now.getTime();node.classList.remove("pressed");if(!_store.get("title")){_error.set("error","notitle")}else if(!_store.get("description")){_error.set("error","nodesc")}if(!_error.get("error")&&!_store.get("_id")){node.classList.add("invisible");spinner.spin(node.parentNode);_store.set("_id",id);_store.set("date",[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()]);_store.sync(Config.get("db"),id).then(function(){if(_store.get("picture_file")){uploadDeckIcon()}return _store.upload()}).then(function(){$onEnd("new",id);var _decks=_user.get("custom_decks")||[];_decks.unshift(id);_user.set("custom_decks",_decks);return _user.upload()}).then(function(){spinner.stop();node.classList.remove("invisible");_widget.closePopup()})}};_widget.reset();return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],217:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Confirm=require("../../../../services/confirm"),Promise=emily.Promise,Place=olives["Place.plugin"],Attachment=require("../../../attach/attachment"),AddAttachment=require("../../../attach/add");module.exports=function LibraryEditConstructor($action){var _widget=new Widget,_attachmentUI=Attachment,_addAttachmentUI=new AddAttachment,_store=new CouchDBDocument,_languages=new Store(Config.get("userLanguages")),user=Config.get("user"),transport=Config.get("transport"),_resetLang=function(){_languages.loop(function(v,i){_store.get("lang")&&v.name===_store.get("lang").substring(0,2)?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_labels=Config.get("labels"),_error=new Store({error:""}),_alist=new Store([]),_addedAttachments=[],_removedAttachments=[],updateReplay;_store.setTransport(transport);_widget.seam.addAll({editlabel:new Model(_labels),editidea:new Model(_store,{displayLang:function(lang){var l;if(lang){l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}},setVisibility:function(visibility){visibility==="public"?this.innerHTML=_labels.get("publiclbl"):this.innerHTML=_labels.get("privatelbl")},hideVisibility:function(visibility){visibility==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(visibility){visibility==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(session){!session||session.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(replay){replay?this.innerHTML=_labels.get("enabledreplaylbl"):this.innerHTML=_labels.get("disabledreplaylbl")},setSessionReplay:function(replay){replay?this.innerHTML=_labels.get("disablereplaylbl"):this.innerHTML=_labels.get("enablereplaylbl")},showAttachments:function(att){att&&att.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new Model(_alist,{setCat:function(cat){var cats=Config.get("cat"),colors=Config.get("catColors"),idx=cats.indexOf(cat);if(idx>-1){this.innerHTML=_labels.get(cat);this.setAttribute("style","color:"+colors[idx])}else{this.innerHTML=cat;this.setAttribute("style","color: #404040")}},setType:function(type){switch(type){default:this.setAttribute("style","background-image: url('../img/r2/download.png')");break}},setRef:function(name){var url=Config.get("location")+"/downloads",idx=this.getAttribute("data-alist_id");if(name){url+="?atype=idea&docid="+_store.get("_id")+"&file="+name;this.setAttribute("href",url)}},setRating:function(docId){var cdb,node=this;if(docId){cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(Config.get("db"),docId).then(function(){var v=cdb.get("votes")||[],l=v.length;if(l===0){node.innerHTML=""}else{node.innerHTML=Math.round(v.reduce(function(x,y){return x+y})/l*100)/100}})}}}),select:new Model(_languages,{setBg:function(name){if(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),place:new Place({AddAttachmentUI:_addAttachmentUI}),editevent:new Event(_widget),errormsg:new Model(_error,{setError:function(error){switch(error){case"notitle":this.innerHTML=_labels.get("titlefield")+_labels.get("emptyfielderror");break;case"nodesc":this.innerHTML=_labels.get("descriptionfield")+_labels.get("emptyfielderror");break;case"nosol":this.innerHTML=_labels.get("solutionfield")+_labels.get("emptyfielderror");break;default:this.innerHTML=""}}})});_widget.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl"></span></div><form class="form"><div class="idealang"><div class="currentlang" data-editidea="bind: displayLang, lang" data-editevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><p><legend class="idealegend" data-editlabel="bind:innerHTML, title"></legend><input type="text" class="input" data-editidea="bind: value, title"></p><p><legend class="idealegend" data-editlabel="bind:innerHTML, principle"></legend><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><legend class="idealegend" data-editlabel="bind:innerHTML, solution"></legend><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editlabel="bind:innerHTML, publishlbl" data-editevent="listen: mousedown, press; listen:mouseup, upload"></label><label class="cancel pressed-btn" data-editlabel="bind:innerHTML, cancellbl" data-editevent="listen: mousedown, press;listen:mouseup, cancel"></label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form><div class="attachments"><legend class="idealegend" data-editlabel="bind:innerHTML, attachments"></legend><div class="toggleattach" data-editevent="listen: mousedown, toggleAttachments"></div><ul class="a-list" data-alist="foreach"><li><a class="a-type" data-alist="bind:setType, type; bind: setRef, fileName" data-editevent="listen: mousedown, press; listen: mouseup, release"></a><label class="a-name" data-alist="bind:innerHTML, name">Name</label><label class="a-cat" data-alist="bind:setCat, category"></label><label class="a-delete" data-editevent="listen:mousedown, press; listen:mouseup, removeAttachment"></label><label class="a-zoom" data-editevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, zoom"></label></li></ul><legend class="a-legend" data-editlabel="bind:innerHTML, alegend"></legend><div data-place="place: AddAttachmentUI"></div></div></div>';_widget.place(Map.get("library-edit"));_widget.reset=function reset(id){_store.unsync();_store.reset();_addedAttachments=[];_removedAttachments=[];_store.sync(Config.get("db"),id).then(function(){_resetLang();_store.get("attachments")?_alist.reset(_store.get("attachments").concat()):_alist.reset([]);_addAttachmentUI.reset(id,"idea",_alist);_alist.watch("added",function(idx,val){_addedAttachments.push(val.docId)})});updateReplay=false};_widget.showLang=function(event,node){_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");_store.set("lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.editVisibility=function(event,node){node.classList.add("pressed");Confirm.reset(_labels.get("setpublicquestion"),function(decision){node.classList.remove("pressed");decision?_store.set("visibility","public"):_store.set("visibility","private");Confirm.hide()},"musession-confirm");Confirm.show()};_widget.press=function(event,node){node.classList.add("pressed")};_widget.release=function(event,node){node.classList.remove("pressed")};_widget.toggleAttachments=function(event,node){var list=_widget.dom.querySelector(".a-list");if(node.classList.contains("show")){list.classList.remove("invisible");node.classList.remove("show")}else{list.classList.add("invisible");node.classList.add("show")}};_widget.removeAttachment=function(event,node){var idx=node.getAttribute("data-alist_id"),id=_alist.get(idx).docId;_removedAttachments.push(id);_alist.alter("splice",idx,1);node.classList.remove("pressed")};_widget.manageAttachments=function(){var aA=_addedAttachments,rA=_removedAttachments;
if(rA.length){rA.forEach(function(attachment_id){var idx1=-1,idx2=-1;for(i=0;i<aA.length;i++){if(aA[i]===attachment_id){idx1=i;break}}if(idx1>-1)aA.splice(idx1,1);_alist.loop(function(val,idx){if(val.docId===attachment_id){idx2=idx}});if(idx2>-1)_alist.alter("splice",idx2,1);_addAttachmentUI.deleteAttachmentDoc(attachment_id)})}if(aA.length||rA.length){_store.set("attachments",JSON.parse(_alist.toJSON()))}};_widget.zoom=function(event,node){var idx=node.getAttribute("data-alist_id");_attachmentUI.reset(_alist.get(idx).docId,"idea")};_widget.enableReplay=function(event,node){setTimeout(function(){_store.get("sessionReplay")?_store.set("sessionReplay",false):_store.set("sessionReplay",true);updateReplay=true;node.classList.remove("pressed")},300)};_widget.updateSessionReplay=function updateSessionReplay(bool){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),_store.get("sessionId")).then(function(){var arr=cdb.get("replayIdeas")||[],i;if(bool){arr.push(_store.get("_id"))}else{for(i=arr.length-1;i>=0;i--){if(arr[i]===_store.get("_id")){arr.splice(i,1)}}}cdb.set("replayIdeas",arr);cdb.upload().then(function(){promise.fulfill();cdb.unsync()})});return promise};_widget.upload=function(event,node){var now=new Date,modDate=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];if(_store.get("title")===""){_error.set("error","notitle")}else if(_store.get("description")===""){_error.set("error","nodesc")}else if(_store.get("solution")===""){_error.set("error","nosol")}else{_widget.manageAttachments();_store.set("modification_date",modDate);_store.upload().then(function(){if(updateReplay){_widget.updateSessionReplay(_store.get("sessionReplay")).then(null,function(err){console.log(err)})}_widget.dom.querySelector(".idealang ul").classList.add("invisible");$action("close")})}node.classList.remove("pressed")};_widget.cancel=function(event,node){node.classList.remove("pressed");_widget.dom.querySelector(".idealang ul").classList.add("invisible");$action("close")};return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/config":245,"../../../../services/confirm":246,"../../../../services/map":249,"../../../attach/add":145,"../../../attach/attachment":146}],218:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Utils=require("../../../../services/utils"),Avatar=require("../../../../services/avatar"),Promise=emily.Promise,Observable=emily.Observable,Place=olives["Place.plugin"],Attachment=require("../../../attach/attachment"),WriteTwocent=require("../../../twocents/writetwocent"),TwocentList=require("../../../twocents/twocentlist"),Spinner=require("../../../../libs/spin.min");module.exports=function IdeaDetailConstructor($action){var _widget=new Widget,_libraryTwocentList=new TwocentList("library"),_twocentWriteUI=new WriteTwocent("library"),_attachmentUI=Attachment,_labels=Config.get("labels"),vote=new Store([{active:false},{active:false},{active:false},{active:false},{active:false}]),_voted=false,user=Config.get("user"),transport=Config.get("transport"),_store=new CouchDBDocument,_shareList=new Store([]),_alist=new Store([]),_dom=Map.get("ideas-detail"),_domWrite=Map.get("library-writetwocents"),_obs=new Observable;_store.setTransport(transport);_widget.seam.addAll({label:new Model(_labels),ideadetail:new Model(_store,{displayView:function(id){id?this.classList.remove("invisible"):this.classList.add("invisible")},toggleFavEdit:function(authors){var node=this;if(authors.indexOf(user.get("_id"))>-1){node.setAttribute("href","#library-edit")}else{node.setAttribute("href","#library-favorites");user.get("library-favorites")&&user.get("library-favorites").indexOf(_store.get("_id"))>-1?node.classList.add("unfav"):node.classList.remove("unfav");user.watchValue("library-favorites",function(val){val.indexOf(_store.get("_id"))>-1?node.classList.add("unfav"):node.classList.remove("unfav")})}},toggleTwocentShare:function(authors){authors.indexOf(user.get("_id"))>-1?this.setAttribute("href","#library-share"):this.setAttribute("href","#library-2cents")},displayWriteTwocent:function(authors){authors.indexOf(user.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(twocents){if(twocents&&twocents.length){document.getElementById("library-writetwocents").classList.add("invisible")}},date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setAuthor:function(authornames){if(authornames===user.get("username")&&_store.get("authors").indexOf(user.get("_id"))>-1){this.innerHTML=_labels.get("youlbl")}else{this.innerHTML=authornames}},setWrotelbl:function(authors){if(authors.length===1&&authors[0]===user.get("_id")){this.innerHTML=_labels.get("youwrotelbl")}else if(authors.length>1)this.innerHTML=_labels.get("theywrotelbl");else{this.innerHTML=_labels.get("ideawrotelbl")}},setAvatar:function setAvatar(authors){var _frag=document.createDocumentFragment(),_ui=new Avatar(authors);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},hideRating:function(id){if(id.search("I:WELCOME")>-1)this.classList.add("invisible");else this.classList.remove("invisible")},setRating:function setRating(votes){if(votes.length===0){this.innerHTML=""}else{this.innerHTML=Math.round(votes.reduce(function(x,y){return x+y})/votes.length*100)/100}},setDescription:function setDescription(desc){this.innerHTML=desc.replace(/\n/g,"<br>")},setSolution:function setSolution(sol){this.innerHTML=sol.replace(/\n/g,"<br>")},toggleVoteButton:function(votes){var idea=_store.get("_id"),authors=_store.get("authors");document.getElementById("ratingPopup").classList.remove("appear");if(user.get("rated_ideas").indexOf(idea)<0&&authors.indexOf(user.get("_id"))<0&&!_voted){this.setAttribute("name","vote");this.innerHTML=_labels.get("votebuttonlbl");this.classList.remove("votes");this.classList.add("publicButton")}else{_voted=true;this.classList.remove("publicButton");this.setAttribute("name","voted");if(votes.length===0){this.innerHTML="("+_labels.get("novotesyet")+")"}else if(votes.length===1){this.innerHTML="("+_labels.get("onevote")+")"}else{this.innerHTML="("+votes.length+" "+_labels.get("votes")+")"}this.classList.add("votes")}},setSharedWith:function(sharedwith){if(_store.get("_id").search("I:WELCOME")<0&&sharedwith&&sharedwith.length){this.classList.remove("invisible");sharedwith.length===1?this.innerHTML=_labels.get("sharedwith")+"<b><u>"+1+_labels.get("ideafyer")+"</u></b>":this.innerHTML=_labels.get("sharedwith")+"<b><u>"+sharedwith.length+_labels.get("ideafyer")+"</u></b>"}else this.classList.add("invisible")},showAttachments:function(att){att&&att.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new Model(_alist,{setCat:function(cat){var cats=Config.get("cat"),colors=Config.get("catColors"),idx=cats.indexOf(cat);if(idx>-1){this.innerHTML=_labels.get(cat);this.setAttribute("style","color:"+colors[idx])}else{this.innerHTML=cat;this.setAttribute("sytle","color: #404040")}},setType:function(type){switch(type){default:this.setAttribute("style","background-image: url('../img/r2/download.png')");break}},setRef:function(name){var url=Config.get("location")+"/downloads",idx=this.getAttribute("data-alist_id");if(name){url+="?atype=idea&docid="+_store.get("_id")+"&file="+name;this.setAttribute("href",url)}},setRating:function(docId){var cdb,node=this;if(docId){cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(Config.get("db"),docId).then(function(){var v=cdb.get("votes")||[],l=v.length;if(l===0){node.innerHTML="";node.parentNode.setAttribute("style","display: none;")}else{node.innerHTML=Math.round(v.reduce(function(x,y){return x+y})/l*100)/100;node.parentNode.setAttribute("style","display: inline-block;")}})}}}),share:new Model(_shareList),vote:new Model(vote,{setIcon:function(active){var styleActive="background-image: url('img/public/activeIdeaVote.png');",styleInactive="background-image: url('img/public/rateForList.png');";active?this.setAttribute("style",styleActive):this.setAttribute("style",styleInactive)}}),place:new Place({LibraryTwocentUI:_libraryTwocentList}),ideadetailevent:new Event(_widget)});_widget.template='<div class="library-idea invisible" data-ideadetail="bind:displayView, _id"><div class="header blue-dark"><a href="#library-2cents" data-ideadetail="bind: toggleTwocentShare, authors" data-ideadetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, ideadetailsheadertitle"></span><a href="#library-favorites" data-ideadetail="bind: toggleFavEdit, authors" data-ideadetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache" class="invisible"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-ideadetail="bind:setAvatar, authors"></div><h2 data-ideadetail="bind:innerHTML,title"></h2><span class="date" data-ideadetail="bind:date, creation_date"></span><br><span class="author" data-ideadetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-ideadetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><legend class="idealegend" data-label="bind:innerHTML, principle"></legend><p data-ideadetail="bind:setDescription,description"></p><legend class="idealegend" data-label="bind:innerHTML, solution"></legend><p data-ideadetail="bind:setSolution,solution"></p><div class="attachments invisible" data-ideadetail="bind:showAttachments, attachments"><legend class="idealegend" data-label="bind:innerHTML, attachments"></legend><div class="toggleattach" data-ideadetailevent="listen: mousedown, toggleAttachments"></div><ul class="a-list" data-alist="foreach"><li><a class="a-type" data-alist="bind:setType, type; bind: setRef, fileName" data-ideadetailevent="listen: mousedown, press; listen: mouseup, release"></a><label class="a-name" data-alist="bind:innerHTML, name">Name</label><label class="a-cat" data-alist="bind:setCat, category"></label><div class="a-rating"><a class="item-acorn"></a><label class="rating" data-alist="bind:setRating,docId"></label></div><label class="a-zoom" data-ideadetailevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, zoom"></label></li></ul></div></div><div class="detail-footer"><div class="sharedwith invisible" data-ideadetail="bind: setSharedWith, sharedwith" data-ideadetailevent="listen:mousedown, displayList"></div><div id="sharelist" class="autocontact invisible"><div class="autoclose" data-ideadetailevent="listen:mousedown,close"></div><ul data-share="foreach"><li data-share="bind:innerHTML, value.username"></li></ul></div><div class ="rateIdea" data-ideadetail="bind:hideRating, id"><a class="item-acorn"></a><div class="rating" data-ideadetail="bind:setRating,votes"></div><div class="publicButton" data-ideadetail="bind: toggleVoteButton, votes" name="vote" data-ideadetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-ideadetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="library-writetwocents" class="invisible" data-ideadetail="bind: displayWriteTwocent, authors"></div><div id="library-twocents" class="twocents" data-ideadetail="bind: displayTwocentList, twocents" data-place="place: LibraryTwocentUI"></div></div>';_widget.showCache=function showCache(){_widget.dom.querySelector("#idea-cache").classList.remove("invisible")};_widget.hideCache=function hideCache(){_widget.dom.querySelector("#idea-cache").classList.add("invisible")};_widget.reset=function reset(viewStore,index){var id=viewStore.get(index).id,promise=new Promise;vote.reset([{active:false},{active:false},{active:false},{active:false},{active:false}]);_widget.getIdea(id).then(function(){_store.get("attachments")?_alist.reset(_store.get("attachments")):_alist.reset([]);_store.watchValue("attachments",function(val){_alist.reset(val)});_voted=false;_twocentWriteUI.reset(_store.get("_id"));_libraryTwocentList.reset(_store.get("_id"));_domWrite=document.getElementById("library-writetwocents");_twocentWriteUI.place(_domWrite);promise.fulfill()});return promise};_widget.getIdea=function getIdea(id){_store.unsync();_store.reset();return _store.sync(Config.get("db"),id)};_widget.refresh=function(){return _widget.getIdea(_store.get("_id"))};_widget.action=function(event,node){var name=node.getAttribute("href"),id=_store.get("_id"),fav,idx,favSpinner=new Spinner({color:"#FFFFFF",lines:8,length:6,width:3,radius:6,left:3,top:3});switch(name){case"#library-2cents":_twocentWriteUI.reset(id);_domWrite.classList.remove("invisible");break;case"#library-favorites":node.classList.add("favwait");favSpinner.spin(node);user.get("library-favorites")?fav=user.get("library-favorites").concat():fav=[];idx=fav.indexOf(id);idx>-1?fav.splice(fav.indexOf(id),1):fav.push(id);if(fav.length<100){user.set("library-favorites",fav);user.upload().then(function(){favSpinner.stop();node.classList.remove("favwait");idx>-1?alert(_labels.get("removedfav")):alert(_labels.get("addedfav"));node.classList.toggle("unfav")})}else{alert(_labels.get("maxfavsize"));favSpinner.stop();node.classList.remove("favwait")}break;default:$action(name);break}};_widget.edit=function(){_stack.getStack().show("#public-edit")};_widget.press=function(event,node){node.classList.add("pressed")};_widget.release=function(event,node){node.classList.remove("pressed")};_widget.toggleAttachments=function(event,node){var list=_widget.dom.querySelector(".a-list");if(node.classList.contains("show")){list.classList.remove("invisible");node.classList.remove("show")}else{list.classList.add("invisible");node.classList.add("show")}};_widget.zoom=function(event,node){var idx=node.getAttribute("data-alist_id");_attachmentUI.reset(_alist.get(idx).docId,"idea")};_widget.vote=function(event,node){if(!_voted){document.getElementById("cache").classList.add("appear1");document.getElementById("ratingPopup").classList.add("appear")}node.classList.remove("pressed")};_widget.previewVote=function(event,node){var i=0,idx=node.getAttribute("data-vote_id");vote.loop(function(v,i){i<=idx?vote.update(i,"active",true):vote.update(i,"active",false)})};_widget.castVote=function(event,node){var grade=parseInt(node.getAttribute("data-vote_id"))+1,id=_store.get("_id"),json={id:id,vote:grade,voter:user.get("_id")};if(!_voted){_voted=true;transport.request("Vote",json,function(result){var ri=user.get("rated_ideas")||[];if(result!=="ok"){console.log(result,"something went wrong, please try again later");_voted=false}else{ri.unshift(id);user.set("rated_ideas",ri);alert(Config.get("labels").get("thankyou"));document.getElementById("ratingPopup").classList.remove("appear");document.getElementById("cache").classList.remove("appear1");vote.reset([{active:false},{active:false},{active:false},{active:false},{active:false}])}})}};_widget.close=function close(event,node){node.parentNode.classList.add("invisible")};_widget.displayList=function(event,node){transport.request("GetUserNames",{list:_store.get("sharedwith")},function(result){_shareList.reset(result);document.getElementById("sharelist").classList.remove("invisible")})};_widget.place(_dom);return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256,"../../../attach/attachment":146,"../../../twocents/twocentlist":236,"../../../twocents/writetwocent":238}],219:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),Widget=olives.OObject,Map=require("../../../../services/map"),Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Utils=require("../../../../services/utils"),Avatar=require("../../../../services/avatar");module.exports=function LibrarySendmailConstructor($action){var _widget=new Widget,_error=new Store({errormsg:""}),_user=Config.get("user"),_transport=Config.get("transport"),_labels=Config.get("labels"),_mail=new Store({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:false});_widget.seam.addAll({labels:new Model(_labels),mail:new Model(_mail,{setUserAvatar:function(from){if(from)this.setAttribute("style","background: url('"+Config.get("avatar")+"') no-repeat center center; background-size: cover")},date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setAvatar:function setAvatar(authors){if(authors){var _frag=document.createDocumentFragment(),_ui=new Avatar(authors);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}},setRating:function(rating){},setVotes:function(votes){}}),mailevent:new Event(_widget),errormsg:new Model(_error)});_widget.template='<div class="idea-sendmail"><div class="header blue-dark"><span data-labels="bind:innerHTML, sendidealbl"></span></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment.votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';_widget.reset=function reset(idea){_error.reset({errormsg:""});_mail.reset({toField:"",from:_user.get("username"),subject:"",body:"",signature:_user.get("username")+" <"+_user.get("_id"),attachment:idea,sent:false});if(_user.get("signature"))_mail.set("signature",_user.get("signature"))};_widget.validateAddress=function validateAddress(value){var emailPattern=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,emailArray=value.toLowerCase().split(/,|;/),result=true;for(i=0,l=emailArray.length;i<l;i++){if(!emailPattern.test(emailArray[i].trim())){_error.set("errormsg",emailArray[i]+_labels.get("notavalidaddress"));result=false;break}}return result};_widget.validateMessage=function validateMessage(){_mail.get("toField")?_widget.validateAddress(_mail.get("toField")):_error.set("errormsg",_labels.get("norecipient"));return _error.get("errormsg")===""};_widget.sendMail=function sendMail(){var json={};json.type="doc";json.recipient=_mail.get("toField");json.cc=_user.get("_id");json.replyTo=_user.get("_id");json.subject=_user.get("username")+_labels.get("sentdocmsg");json.header=_mail.get("subject");json.body=_mail.get("body");json.signature=_mail.get("signature");json.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+_mail.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+_mail.get("attachment").authornames+", <span style='color:black';>"+Utils.formatDate(_mail.get("attachment").creation_date)+"</span></p></div>";json.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+_mail.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+_mail.get("attachment").solution+"</p></div>";_transport.request("SendMail",json,function(result){if(result.sendmail==="ok"){_error.set("errormsg",_labels.get("yourmessage")+result.recipient+_labels.get("sentoklbl"));setTimeout(function(){$action("close")},350)}else{_error.set("errormsg",_labels.get("somethingwrong"));_mail.set("sent",false);console.log("error",result.error);console.log("response",result.response)}})};_widget.press=function(event,node){if(!node.classList.contains("sendmail")||!_mail.get("sent"))node.classList.add("pressed")};_widget.send=function(event,node){if(!_mail.get("sent")){_mail.set("sent",true);_error.set("errormsg","");node.classList.remove("pressed");_widget.validateMessage()?_widget.sendMail():_mail.set("sent",false)}};_widget.cancel=function(event,node){node.classList.remove("pressed");$action("close")};_widget.place(Map.get("library-sendmail"));return _widget}},{"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256}],220:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../../services/config"),Promise=emily.Promise,Avatar=require("../../../../services/avatar"),Utils=require("../../../../services/utils"),AutoContact=require("../../../../services/autocontact"),Spinner=require("../../../../libs/spin.min");module.exports=function LibraryShareConstructor($action){var _widget=new Widget,_error=new Store({errormsg:""}),_user=Config.get("user"),_transport=Config.get("transport"),_labels=Config.get("labels"),_share=new Store({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:_user.get("signature")}),contactList=new Store([]),shareContacts=new Store([]),sendInProgress=false,spinner=new Spinner({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6}).spin();_widget.seam.addAll({labels:new Model(_labels),share:new Model(_share,{setHeader:function(title){this.innerHTML=_labels.get("sharing")+title}}),contacts:new Model(shareContacts,{setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new Event(_widget),errormsg:new Model(_error)});_widget.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';_widget.reset=function reset($id){_error.reset({errormsg:""});_share.reset({body:"",docId:$id,docType:"",docTitle:"",signature:_user.get("username")+" <"+_user.get("_id")+">"});_widget.getIdeaDetails($id);if(_user.get("signature"))_share.set("signature",_user.get("signature"));shareContacts.reset([]);contactList.reset(_user.get("connections").concat())};_widget.getIdeaDetails=function getIdeaDetails(id){var cdb=new CouchDBDocument({});cdb.setTransport(_transport);cdb.sync(Config.get("db"),id).then(function(){_share.set("docType",cdb.get("type"));_share.set("docTitle",cdb.get("title"));cdb.unsync()})};_widget.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=_user.get("connections").concat(),clc,vlc=node.value.toLowerCase();if(node.value===""){contactList.reset(connections)}else{for(i=arr.length-1;i>=0;i--){clc=arr[i].username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}contactList.reset(arr)}contactList.loop(function(v,i){if(shareContacts.toJSON().search(v.userid)>-1)contactList.update(i,"selected",true)})};_widget.close=function close(event,node){node.parentNode.classList.add("invisible")};_widget.displayAutoContact=function(event,node){_widget.dom.querySelector("#sharelistauto").classList.remove("invisible");contactList.reset(_user.get("connections").concat())};_widget.discardContact=function(event,node){var id=node.getAttribute("data-contacts_id"),userid=shareContacts.get(id).userid;shareContacts.alter("splice",id,1);contactList.loop(function(v,i){if(v.userid===userid){setTimeout(function(){contactList.update(i,"selected",false)},200)}});_widget.unselectGroup(userid)};_widget.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){_widget.removeContact(contactList.get(id));setTimeout(function(){contactList.update(id,"selected",false);document.getElementById("sharelistauto").classList.add("invisible")},200)}else{_widget.addContact(contactList.get(id));_widget.selectGroup();setTimeout(function(){contactList.update(id,"selected",true);document.getElementById("sharelistauto").classList.add("invisible")},200)}};_widget.selectAll=function(event,node){node.classList.remove("pressed");shareContacts.reset([]);contactList.reset(_user.get("connections").concat());contactList.loop(function(v,i){contactList.update(i,"selected",true);if(v.type==="user")shareContacts.alter("push",v)})};_widget.removeContact=function(contact){if(contact.type==="group"){for(j=contact.contacts.length-1;j>=0;j--){_widget.removeContact(contact.contacts[j])}}else{shareContacts.loop(function(v,i){if(v.userid===contact.userid)shareContacts.alter("splice",i,1)});_widget.unselectGroup(contact.userid);contactList.loop(function(val,idx){if(val.userid===contact.userid)contactList.update(idx,"selected",false)})}};_widget.selectGroup=function(){var cts,add=false;contactList.loop(function(v,i){if(v.type==="group"&&!v.selected){cts=v.contacts;add=true;for(j=cts.length-1;j>=0;j--){if(shareContacts.toJSON().search(cts[j].userid)<0){add=false;break}}if(add){contactList.update(i,"selected",true)}}})};_widget.unselectGroup=function(userid){contactList.loop(function(v,i){if(v.type==="group"&&v.selected){if(JSON.stringify(v.contacts).search(userid)>0)contactList.update(i,"selected",false)}})};_widget.addContact=function(contact){var i,l,add=true;if(contact.type==="user")shareContacts.alter("push",contact);else{for(i=0,l=contact.contacts.length;i<l;i++){shareContacts.loop(function(val,idx){if(val.userid===contact.contacts[i].userid){add=false}});if(add){shareContacts.alter("push",contact.contacts[i]);contactList.loop(function(val,idx){if(val.userid===contact.contacts[i].userid){contactList.update(idx,"selected",true)}})}}}};_widget.press=function(event,node){node.classList.add("pressed")};_widget.share=function(event,node){var now=new Date,json={type:"DOC",status:"unread",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getMinutes()],author:_user.get("_id"),username:_user.get("username"),firstname:_user.get("firstname"),toList:"",ccList:"",object:"",body:_share.get("body"),signature:_share.get("signature"),docId:_share.get("docId"),docType:_share.get("docType"),docTitle:_share.get("docTitle"),dest:[]};if(!sendInProgress){sendInProgress=true;spinner.spin(node);_widget.buildRecipientList(json.docId,json.dest).then(function(){if(!json.dest.length){_error.set("errormsg","intented recipients already have this idea");node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());$action("close")},2500)}else{_transport.request("Notify",json,function(result){_error.set("errormsg",_labels.get("shareok"));node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());$action("close")},2500)})}})}};_widget.cancel=function(event,node){node.classList.remove("pressed");$action("close")};_widget.buildRecipientList=function buildRecipientList(docId,dest){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),docId).then(function(){var sharedwith=cdb.get("sharedwith")||[],authors=cdb.get("authors"),i;shareContacts.loop(function(v,i){if(authors.indexOf(v.userid)<0){if(!sharedwith.length){sharedwith.push(v.userid);dest.push(v.userid)}else{if(sharedwith.indexOf(v.userid)<0){sharedwith.push(v.userid);dest.push(v.userid)}}}});cdb.set("sharedwith",sharedwith);return cdb.upload()}).then(function(){promise.fulfill()});return promise};_widget.place(Map.get("library-share"));return _widget}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../libs/spin.min":143,"../../../../services/autocontact":241,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/map":249,"../../../../services/utils":256}],221:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Map=require("../../../services/map"),Stack=amy.StackPlugin,Model=olives["Bind.plugin"],IdeaDetail=require("./detail-stack/library-idea"),Edit=require("./detail-stack/library-edit"),Sendmail=require("./detail-stack/library-sendmail"),Share=require("./detail-stack/library-share"),Config=require("../../../services/config"),Store=emily.Store,Spinner=require("../../../libs/spin.min");
module.exports=function IdeaStackConstructor(){var _widget=new Widget,_emptyList=new Widget,_ideaDetail,_sendmail,_share,_edit,_stack=new Stack,_observer=Config.get("observer"),_labels=Config.get("labels"),_store=new Store,current=0,spinner=new Spinner({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();_widget.seam.addAll({detailstack:_stack});_widget.template='<div class="detail-stack" data-detailstack="destination"></div>';_emptyList.template='<div class="msgsplash"><div class="header blue-dark"><span data-labels="bind:innerHTML, noideafound"></span></div><div class="innersplash"><span data-labels="bind: innerHTML, tryotherview"></span></div></div>';_emptyList.seam.add("labels",new Model(_labels));_widget.reset=function reset(viewStore,index){var cache;_store=viewStore;current=index;_stack.getStack().show("#library-ideadetail");_ideaDetail.hideCache();spinner.spin(_widget.dom);_ideaDetail.reset(viewStore,index).then(function(){spinner.stop();cache.classList.add("invisible")})};_widget.action=function action(name){switch(name){case"#library-edit":_edit.reset(_store.get(current).id);_stack.getStack().show("#library-edit");break;case"#library-favorites":break;case"#library-share":_share.reset(_store.get(current).id);_stack.getStack().show("#library-share");break;case"close":_stack.getStack().show("#library-ideadetail");spinner.spin(_widget.dom);_ideaDetail.refresh().then(function(){spinner.stop()});break;default:_stack.getStack().show("#library-ideadetail");break}};_widget.edit=function edit(id){_edit.reset(id);_stack.getStack().show("#library-edit")};_widget.sendMail=function sendMail(idea){_sendmail.reset(idea);_stack.getStack().show("#library-sendmail")};_widget.share=function share(idea){_share.reset(idea._id);_stack.getStack().show("#library-share")};_widget.displayEmpty=function displayEmpty(name){_stack.getStack().show("#empty-list")};_ideaDetail=new IdeaDetail(_widget.action);_edit=new Edit(_widget.action);_sendmail=new Sendmail(_widget.action);_share=new Share(_widget.action);_stack.getStack().add("#library-ideadetail",_ideaDetail);_stack.getStack().add("#library-edit",_edit);_stack.getStack().add("#library-sendmail",_sendmail);_stack.getStack().add("#library-share",_share);_stack.getStack().add("#empty-list",_emptyList);_observer.watch("library-viewidea",function(id){_widget.viewIdea(id)});_observer.watch("library-edit",function(id){_widget.edit(id)});_observer.watch("library-sendmail",function(idea){_widget.sendMail(idea)});_observer.watch("library-share",function(idea){_widget.share(idea)});return _widget}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/map":249,"./detail-stack/library-edit":217,"./detail-stack/library-idea":218,"./detail-stack/library-sendmail":219,"./detail-stack/library-share":220}],222:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),amy=require("../../../libs/amy2"),Widget=olives.OObject,Control=amy.ControlPlugin,Model=olives["Bind.plugin"],Delegate=amy.DelegatePlugin,Place=olives["Place.plugin"],Store=emily.Store,Map=require("../../../services/map"),Config=require("../../../services/config"),Detail=require("./idea-stack"),List=require("./lists/idealist"),Stack=amy.StackPlugin,Spinner=require("../../../libs/spin.min"),NewIdea=require("../../../services/newidea");module.exports=function IdeasConstructor(){var _widget=new Widget,_searchInput=new Store({search:""}),_db=Config.get("db"),_observer=Config.get("observer"),_radio=new Control(_widget),_detail=new Detail,listDate,listRating,listSearch,listFav,initldQuery,initlrQuery,_user=Config.get("user"),_labels=Config.get("labels"),_currentLang=_user.get("lang").substring(0,2),_btns=new Store([{name:"#list-fav",css:"byfav",pushed:false,lang:null},{name:"#list-date",css:"bydate",pushed:true,lang:null},{name:"#list-rating",css:"byrating",pushed:false,lang:null},{name:"#lang",css:"bylang",pushed:false,lang:_currentLang}]),_languages=new Store([{name:"*"}]),_usrLg=Config.get("userLanguages"),_stack=new Stack,_listSpinner=new Spinner({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();_usrLg.forEach(function(val){_languages.alter("push",val)});_widget.template='<div id = "ideas"><div id="idea-list" class="list"><div class="header blue-light"><div class="option left" data-ideascontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, idealistheadertitle">My Ideas</span><div class="option right" data-ideasevent="listen: mousedown, plus"></div></div><div data-idealiststack="destination" data-ideascontrol="radio:li.list-item,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-search="bind: value, search" data-label="bind: placeholder, searchprivateplaceholder" data-ideasevent="listen: keypress, search"><ul class="listbtns" data-listbtns="foreach"><li class="tools-button" data-listbtns="bind:setName, name; bind:setClass, css; bind:setPushed, pushed; bind:setLang, lang" data-ideasevent="listen:mouseup,show"></li></ul><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-ideasevent="listen: mousedown, setLang; listen:touchend, mouseup"></li></ul></div></div></div><div id="ideas-detail" class="details" data-ideaplace="place:details"></div></div>';_widget.seam.addAll({idealiststack:_stack,listbtns:new Model(_btns,{setPushed:function(pushed){pushed?this.classList.add("pushed"):this.classList.remove("pushed")},setLang:function(lang){if(lang&&lang!=="*"){this.setAttribute("style","background-image:url('img/flags/"+lang+".png');");this.innerHTML=""}if(lang==="*"){this.setAttribute("style","background-image: none;");this.innerHTML="*"}},setClass:function(css){css&&this.classList.add(css)},setName:function(name){name&&this.setAttribute("name",name)}}),select:new Model(_languages,{setBg:function(name){if(name==="*"){this.setAttribute("style","background-image: none;background: whitesmoke;");this.innerHTML="*"}else{this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}}}),label:new Model(_labels),search:new Model(_searchInput),ideasevent:new Delegate(_widget),ideaplace:new Place({details:_detail}),ideascontrol:_radio});_widget.place(Map.get("ideas"));_widget.selectStart=function(event){var _ideaList=_stack.getStack().getCurrentScreen().getModel(),_id=event.target.getAttribute("data-listideas_id");_detail.reset(_ideaList,_id);_searchInput.set("search","")};_widget.displayHighlightedIdea=function displayHighlightedIdea(){var ideaList=_stack.getStack().getCurrentScreen(),ideaNode=ideaList.dom.querySelector(".list-item.selected")||ideaList.dom.querySelector("li[data-listideas_id='0']"),id;if(ideaNode){id=ideaNode.getAttribute("data-listideas_id");ideaNode.classList.add("selected");ideaNode.scrollIntoView();_radio.init(ideaNode);_detail.reset(ideaList.getModel(),id)}else{_detail.displayEmpty(_stack.getStack().getCurrentName())}};_widget.show=function(event,node){var id=parseInt(node.getAttribute("data-listbtns_id"),10),name=_btns.get(id).name,st=_stack.getStack();if(name==="#lang"){_widget.dom.querySelector(".langlist").classList.remove("invisible")}else{_btns.loop(function(v,i){i===id?_btns.update(i,"pushed",true):_btns.update(i,"pushed",false)});if(name!==st.getCurrentName){st.show(name);if(st.get(name).getModel().count()){_widget.displayHighlightedIdea()}else{_detail.displayEmpty(name)}}}};_widget.setLang=function(event,node){var id,lang;event.stopPropagation();event.preventDefault();id=node.getAttribute("data-select_id");lang=_languages.get(id).name;_currentLang=lang;_listSpinner.spin(_widget.dom.querySelector("#idea-list"));_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",lang)});_widget.dom.querySelector(".langlist").classList.add("invisible");["#list-rating","#list-fav","#list-date"].forEach(function(name){var st=_stack.getStack();st.get(name).setLang(lang).then(function(){_listSpinner.stop();if(st.getCurrentName()===name&&st.get(name).getModel().count()===0){_detail.displayEmpty(name)}else _widget.displayHighlightedIdea()})})};_widget.stopPropagation=function(event,node){event.stopPropagation();event.preventDefault()};_widget.mosaic=function(){var domDetail=document.getElementById("ideas-detail");_widget.dom.classList.toggle("mosaic");if(domDetail.classList.contains("invisible")){domDetail.classList.remove("invisible");_detail.reset(listDate.getModel(),0)}if(_widget.dom.classList.contains("mosaic")){["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(ui){_stack.getStack().get(ui).setMosaic(true)})}else{["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(ui){_stack.getStack().get(ui).setMosaic(false)})}};_widget.plus=function(){NewIdea.reset()};_widget.search=function(event,node){var usr;if(event.keyCode===13){if(node.value===""){_widget.dom.querySelector(".listbtns").classList.remove("invisible");_stack.getStack().show("#list-date");_btns.loop(function(v,i){v.name==="#list-date"?_btns.update(i,"pushed",true):_btns.update(i,"pushed",false)});_widget.displayHighlightedIdea()}else{usr=_user.get("_id").replace(/@/,"at");_widget.searchIdea("users:"+usr+" AND "+node.value)}node.blur()}};_widget.searchIdea=function searchIdea(query){_widget.dom.querySelector(".listbtns").classList.add("invisible");listSearch.resetQuery({q:query,sort:"\\creation_date<date>",include_docs:true}).then(function(){_stack.getStack().show("#list-search");if(listSearch.getModel().count()>0){_searchInput.set("search",listSearch.getModel().get(0).doc.title);_widget.dom.querySelector(".noresult").classList.add("invisible");_widget.displayHighlightedIdea()}else{_widget.dom.querySelector(".noresult").classList.remove("invisible")}})};_widget.reset=function reset(){_searchInput.set("search","");listSearch.resetQuery({q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:true});listRating.resetQuery({startkey:'["'+Config.get("user").get("_id")+'",{}]',endkey:'["'+Config.get("user").get("_id")+'"]',descending:true,include_docs:true});listDate.resetQuery({key:'"'+_user.get("_id")+'"',descending:true,include_docs:true}).then(function(){_stack.getStack().show("#list-date");_widget.displayHighlightedIdea()})};_user.get("settings").contentLang?_currentLang=_user.get("settings").contentLang:_currentLang=_user.get("lang").substring(0,2);if(_currentLang==="all")_currentLang="*";_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",_currentLang)});if(_currentLang==="*"){initldQuery={key:'"'+_user.get("_id")+'"',descending:true};initlrQuery={endkey:'[0,"'+_user.get("_id")+'"]',startkey:'[0,"'+_user.get("_id")+'",{},{}]',descending:true}}else{initldQuery={key:'[0,"'+_user.get("_id")+'","'+_currentLang+'"]',descending:true};initlrQuery={endkey:'[1,"'+_user.get("_id")+'","'+_currentLang+'"]',startkey:'[1,"'+_user.get("_id")+'","'+_currentLang+'",{},{}]',descending:true}}listDate=new List(_db,"library","_view/ideas",initldQuery);listSearch=new List("_fti/local/"+_db,"indexedideas","userbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:true});listRating=new List(_db,"ideas","_view/privatebyvotes",initlrQuery);listFav=new List(_db,"library","_view/allideas","fav");_stack.getStack().add("#list-date",listDate);_stack.getStack().add("#list-rating",listRating);_stack.getStack().add("#list-search",listSearch);_stack.getStack().add("#list-fav",listFav);listDate.init(_currentLang).then(function(){_stack.getStack().show("#list-date");listDate.getModel().count()?_widget.displayHighlightedIdea():_detail.displayEmpty("#list-date");return listFav.setLang(_currentLang)}).then(function(){_user.watchValue("library-favorites",function(val){if(val.length!==listFav.getModel().count()){listFav.resetQuery(_currentLang).then(function(){if(_stack.getStack().getCurrentName()==="#list-fav"){listFav.getModel().count()?_widget.displayHighlightedIdea():_detail.displayEmpty("#list-fav")}})}});_user.watchValue("settings",function(s){var l=s.contentLang;if(l==="all")l="*";if(l&&l!==_currentLang){_currentLang=l;_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",_currentLang)});["#list-date","#list-rating","#list-fav"].forEach(function(ui){_stack.getStack().get(ui).setLang(_currentLang)})}})});listRating.init(_currentLang);["#list-date","#list-rating","#list-fav"].forEach(function(ui){var wid=_stack.getStack().get(ui),_ideaList=wid.getModel(),_ideaNode,_id});_observer.watch("NewIdea",function(id){["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(ui){var wid=_stack.getStack().get(ui),_ideaList=wid.getModel(),_ideaNode,_id,idx,ideaElem;if(ui===_stack.getStack().getCurrentName()){_listSpinner.spin(document.getElementById("idea-list"));_ideaList.watch("added",function(){_ideaList.loop(function(v,i){if(v.id===id)idx=i});_ideaNode=wid.dom.querySelector(".list-item.selected");if(_ideaNode)_ideaNode.classList.remove("selected");ideaElem=wid.dom.querySelector("li[data-listideas_id='"+idx+"']");ideaElem.classList.add("selected");_radio.init(idx);ideaElem.scrollIntoView();_detail.reset(_ideaList,idx);_listSpinner.stop()})}})});return _widget}},{"../../../libs/amy2":75,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/config":245,"../../../services/map":249,"../../../services/newidea":252,"./idea-stack":221,"./lists/idealist":223}],223:[function(require,module,exports){var olives=require("../../../../libs/olives"),emily=require("../../../../libs/emily"),CouchDBTools=require("../../../../libs/CouchDBTools"),Widget=olives.OObject,Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../../services/utils"),Avatar=require("../../../../services/avatar"),ActionBar=require("../../../../services/actionbar"),Promise=emily.Promise;function IdeaListConstructor($db,$design,$view,$query){var _store=new CouchDBView([]),_mosaic=new Store,display=false,currentBar=null,_options={db:$db,view:$view,design:$design,query:{descending:true}},user=Config.get("user"),labels=Config.get("labels"),widget=this;_store.setTransport(Config.get("transport"));if($query){_options.query=$query}this.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,value.doc.authors"></div><h2 data-listideas="bind:innerHTML,value.doc.authornames" data-display="bind:setAuthornames, mosaic"></h2><span class="date" data-listideas="bind:date, value.doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,value.doc.title"></h3><p data-listideas="bind:innerHTML, value.doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, value.doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul></div>';if(_options.query.q){this.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames" data-display="bind:setAuthornames, mosaic"></h2><span class="date" data-listideas="bind:date, doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:setDesc, doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, rating"></span></div></li></ul></div>'}widget.seam.addAll({labels:new Model(labels),listideas:new Model(_store,{date:function date(date){date?this.innerHTML=Utils.formatDate(date):this.innerHTML=""},setDesc:function(desc){this.innerHTML=desc.replace(/\n/g,"<br>")},setRating:function setRating(rating){if(rating===undefined){var _id=this.getAttribute("data-listideas_id"),_arr=_store.get(_id).doc.votes||[];if(_arr.length===0){this.innerHTML="0"}else{this.innerHTML=Math.round(_arr.reduce(function(x,y){return x+y})/_arr.length*100)/100}}else this.innerHTML=Math.round(rating*100)/100},setAvatar:function setAvatar(authors){var _ui,_frag},setVisibility:function(visibility){visibility==="public"?this.classList.add("public"):this.classList.remove("public")}}),display:new Model(_mosaic,{setAuthornames:function(mosaic){var _id=this.getAttribute("data-listideas_id"),names=_store.get(_id).value.doc.authornames,authors=_store.get(_id).value.doc.authors;if(mosaic&&authors.length>1){this.innerHTML=names.split(",")[0]+labels.get("andothers")}else this.innerHTML=names}}),listevent:new Event(this)});widget.getModel=function(){return _store};widget.resetQuery=function(query){var promise=new Promise,nores=widget.dom.querySelector(".noresult"),fav=Config.get("user").get("library-favorites")||[],json={idList:fav};_options.query=query;_store.unsync();_store.reset([]);if($query==="fav"){Config.get("transport").request("GetFavList",json,function(res){var arr=JSON.parse(res),i,l,lang;if(!query||query==="*")_store.reset(arr);else{for(i=0,l=arr.length;i<l;i++){lang=arr[i].value.doc.lang.substring(0,2);if(query===lang)_store.alter("push",arr[i])}}_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}else{_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){currentBar&&currentBar.hide();_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}return promise};widget.setStart=function(event,node){var dom=document.getElementById("ideas");if(currentBar){currentBar.hide();currentBar=null}if(dom.classList.contains("mosaic")){dom.classList.remove("mosaic");node.scrollIntoView()}};widget.setLang=function(lang){var query;if($query==="fav")query=lang;else{switch($view){case"_view/ideas":if(lang==="*"){query={key:'"'+user.get("_id")+'"',descending:true}}else{query={key:'[0,"'+user.get("_id")+'","'+lang+'"]',descending:true}}break;case"_view/privatebyvotes":if(lang==="*"){query={endkey:'[0,"'+user.get("_id")+'"]',startkey:'[0,"'+user.get("_id")+'",{},{}]',descending:true}}else{query={endkey:'[1,"'+user.get("_id")+'"]',startkey:'[1,"'+user.get("_id")+'","'+lang+'",{},{}]',descending:true}}break;default:break}}return widget.resetQuery(query)};widget.setMosaic=function(mosaic){mosaic?_mosaic.set("mosaic",true):_mosaic.set("mosaic",false)};widget.showActionBar=function(event,node){var id=node.getAttribute("data-listideas_id"),dom=document.getElementById("ideas"),frag,display=false;if(currentBar&&currentBar.getParent()===node){display=true}if(!dom.classList.contains("mosaic")&&!display){currentBar=new ActionBar("idea",node,_store.get(id).id);frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};widget.init=function init(){var promise=new Promise,fav=user.get("library-favorites")||[],json={idList:fav},nores=widget.dom.querySelector(".noresult");if($query==="fav"){if(fav.length){Config.get("transport").request("GetFavList",json,function(res){_store.reset(JSON.parse(res));nores.classList.add("invisible");promise.fulfill()})}else{_store.reset([]);nores.classList.remove("invisible");promise.fulfill()}}else{_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}return promise}}module.exports=function IdeaListFactory($db,$design,$view,$query){IdeaListConstructor.prototype=new Widget;return new IdeaListConstructor($db,$design,$view,$query)}},{"../../../../libs/CouchDBTools":72,"../../../../libs/emily":97,"../../../../libs/olives":141,"../../../../services/actionbar":240,"../../../../services/avatar":242,"../../../../services/config":245,"../../../../services/utils":256}],224:[function(require,module,exports){var olives=require("../../libs/olives"),amy=require("../../libs/amy2"),Widget=olives.OObject,Stack=amy.StackPlugin,Map=require("../../services/map"),Menu=require("../../services/submenu"),Ideas=require("./ideas/ideas"),Sessions=require("./sessions/sessions"),Decks=require("./decks/decks"),Config=require("../../services/config");module.exports=function LibraryConstructor(){var _widget=new Widget,_stack=new Stack,_ideas,_sessions,_decks,_observer=Config.get("observer"),setView=function setView(name){_stack.getStack().show(name)},_menu;_widget.seam.add("librarystack",_stack);_widget.template='<div id="library"><div class="cache"></div><div id="library-menu"></div><div class="stack" data-librarystack="destination"></div></div>';_widget.place(Map.get("library"));_widget.showMenu=function showMenu(){_menu.toggleActive(true)};_widget.hideMenu=function hideMenu(){_menu.toggleActive(false)};_widget.reset=function reset(){_ideas.reset();_decks.reset();_sessions.reset();_menu.reset();_stack.getStack().show("#ideas")};_menu=new Menu(_widget.dom.querySelector("#library-menu"),setView);_menu.toggleActive(false);_ideas=new Ideas;_sessions=new Sessions;_decks=new Decks;_stack.getStack().add("#ideas",_ideas);_stack.getStack().add("#sessions",_sessions);_stack.getStack().add("#decks",_decks);_stack.getStack().show("#ideas");_observer.watch("display-doc",function(id,type){switch(type){case 6:var ideasUI=_stack.getStack().get("#ideas");ideasUI.searchIdea(id.substr(2));if(_stack.getStack().getCurrentScreen()!==ideasUI)_stack.getStack().show("#ideas");break;case 9:_stack.getStack().show("#decks");break;default:break}});return _widget}},{"../../libs/amy2":75,"../../libs/olives":141,"../../services/config":245,"../../services/map":249,"../../services/submenu":253,"./decks/decks":207,"./ideas/ideas":222,"./sessions/sessions":225}],225:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../../services/config"),CouchDBView=CouchDBTools.CouchDBView,CouchDBDocument=CouchDBTools.CouchDBDocument,Store=emily.Store,Promise=emily.Promise,Utils=require("../../../services/utils"),AvatarList=require("../../../services/avatarlist"),Confirm=require("../../../services/confirm"),Spinner=require("../../../libs/spin.min");module.exports=function MySessionsContructor(){var _widget=new Widget,_actionWidget=new Widget,_dom=Map.get("sessions"),_sessions=new Store,_db=Config.get("db"),_transport=Config.get("transport"),_user=Config.get("user"),_avatars=Config.get("avatars"),_labels=Config.get("labels"),_sortStatus=new Store({}),_currentSort="sbydate",_sessionData=[],_searchData=[],_currentSearch="",_sessionsCDB=new CouchDBView,spinner=new Spinner({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330}).spin(),confirmCallback;_sessionsCDB.setTransport(_transport);_widget.seam.addAll({label:new Model(_labels),sort:new Model(_sortStatus,{setSelected:function(selected){selected?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(descending){if(descending){this.classList.remove("sort-ascending");this.classList.add("sort-descending")}else{this.classList.remove("sort-descending");this.classList.add("sort-ascending")}}}),sessions:new Model(_sessions,{setMode:function(mode){switch(mode){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');");break}},formatDate:function(date){if(date&&date.length)this.innerHTML=Utils.formatDate(date)},formatIdeas:function(array){if(array&&array.length===1){this.innerHTML=array[0].title}else if(array&&array.length>1){var arr=[];for(i=0;i<array.length;i++){arr.push(array[i].title)}this.innerHTML=arr.join("<br/>")}else{this.innerHTML=_labels.get("noideayet")}},setAvatars:function(array){var ui,frag;if(array){ui=new AvatarList(array);frag=document.createDocumentFragment();node=this;ui.place(frag);!node.hasChildNodes()?node.appendChild(frag):node.replaceChild(frag,node.firstChild)}},setStatus:function(status){if(status){switch(status){case"completed":this.innerHTML=_labels.get("completed");break;case"scheduled":this.innerHTML=_labels.get("scheduled");break;case"deleted":this.innerHTML=_labels.get("deleted");break;default:this.innerHTML=_labels.get("inprogress");break}}},setScore:function(score){if(score>=0){this.innerHTML=score}else{this.innerHTML=""}},setSuffix:function(score){if(score===undefined||score===""||score===null){this.innerHTML=_labels.get("noscore")}else this.innerHTML="ip"},showReplay:function(status){if(status==="completed")this.setAttribute("style","display: inline-block; background-size: 40px 40px;");else this.setAttribute("style","display: none;")},showDelete:function(leader){var idx=this.getAttribute("data-sessions_id");if(leader!==_user.get("_id"))this.setAttribute("style","display: none;");else{if(_sessions.get(idx).id===_user.get("sessionInProgress").id)this.setAttribute("style","display: none;");else{if(_sessions.get(idx).status==="deleted")this.setAttribute("style","display: inline-block; background-size: 40px 40px;");else{if(_sessions.get(idx).status!=="scheduled"&&_sessions.get(idx).participants.length>1){this.setAttribute("style","display: none;")}else this.setAttribute("style","display: inline-block; background-size: 40px 40px;")}}}}}),sortevent:new Event(_widget),sessionevent:new Event(_widget)});_widget.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-dark" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen: dblclick, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessions="bind:showReplay, status" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessions="bind:showDelete, leader" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>';_widget.sort=function sort(event,node){var mode=node.getAttribute("id");if(_sortStatus.get(mode).selected){_sortStatus.set(mode,{selected:true,descending:!_sortStatus.get(mode).descending})}else{_sortStatus.set(_currentSort,{selected:false,descending:_sortStatus.get(_currentSort).descending});_sortStatus.set(mode,{selected:true,descending:_sortStatus.get(mode).descending});_currentSort=mode}_widget.sortSessions(mode)};_widget.sortSessions=function sortSessions(mode){var _scope;_currentSearch?_scope=_searchData:_scope=_sessionData;if(_scope.length){switch(mode){case"sbytitle":Utils.sortByProperty(_scope,"title",_sortStatus.get("sbytitle").descending);break;case"sbydate":Utils.sortByProperty(_scope,"date",_sortStatus.get("sbydate").descending);break;case"sbyidea":Utils.sortByProperty(_scope,"idea",_sortStatus.get("sbyidea").descending);break;case"sbyscore":Utils.sortByProperty(_scope,"score",_sortStatus.get("sbyscore").descending);break}}_sessions.reset(_scope)};_widget.acceptinput=function(event,node){node.removeAttribute("readonly")};_widget.search=function search(event,node){var _resDiv=document.getElementById("sessionsearchresult");_resDiv.innerHTML="";if(event.keyCode===13){_currentSearch=node.value;if(_currentSearch===""){_widget.sortSessions(_currentSort);_sessions.reset(_sessionData)}else{_searchData=Utils.searchArray(_sessionData,_currentSearch);_resDiv.innerHTML=_labels.get("foundlbl")+" "+_searchData.length+" "+_labels.get("matchingsessions");_sessions.reset(_searchData)}}};_widget.displayActionBar=function(event,node){var _id=node.getAttribute("data-sessions_id"),_height=node.offsetHeight,_sid=_sessions.get(_id),ab=node.querySelector(".actionbar");if(ab.hasChildNodes()){ab.setAttribute("style","display: block;margin-top:-"+_height+"px;height: "+_height+"px;");setTimeout(function(){ab.setAttribute("style","display: none;")},2e3)}};_widget.hideActionBar=function(event,node){node.setAttribute("style","display: none;")};_widget.press=function(event,node){var id=node.getAttribute("data-sessions_id");node.classList.add("pressed");if(id){spinner.spin(document.getElementById("sessionlistspinner"))}};_widget.replay=function(event,node){var _id=node.getAttribute("data-sessions_id"),_sid=_sessions.get(_id).id,_mode=_sessions.get(_id).mode;node.parentNode.setAttribute("style","display: none;");node.classList.remove("pressed");spinner.stop();Config.get("observer").notify("replay-session",_sid,_mode)};_widget.deleteSession=function(event,node){var _id=node.getAttribute("data-sessions_id"),_sid=_sessions.get(_id).id,removeFromDB=function(docId){var cdb=new CouchDBDocument,promise=new Promise;cdb.setTransport(_transport);cdb.sync(_db,docId).then(function(){var arr=cdb.get("replayIdeas")||[];arr.forEach(function(idea){var ideaDB=new CouchDBDocument;ideaDB.setTransport(_transport);ideaDB.sync(_db,idea).then(function(){ideaDB.set("sessionId",ideaDB.get("sessionId")+"_deleted");
ideaDB.set("sessionReplay",false);return ideaDB.upload()}).then(function(){ideaDB.unsync()},function(err){console.log(err)})});_transport.request("cleanUpSession",_sid,function(res){if(res.err){console.log(res.err)}cdb.set("status","deleted");cdb.upload().then(function(){return cdb.remove()}).then(function(){promise.fulfill()})})});return promise},question=_labels.get("deletereplay"),confirmCallback=function(decision){if(decision){spinner.spin(document.getElementById("sessionlistspinner"));removeFromDB(_sid).then(function(){spinner.stop();Confirm.hide()})}else{Confirm.hide()}};node.classList.remove("pressed");node.parentNode.setAttribute("style","display: none;");if(_sessions.get(_id).replayIdeas&&_sessions.get(_id).replayIdeas.length){spinner.stop();Confirm.reset(question,confirmCallback,"musession-confirm");Confirm.show()}else{removeFromDB(_sid).then(function(){spinner.stop()})}};_widget.resetSessionData=function resetSessionData(){_sessionData=[];_sessionsCDB.loop(function(v,i){var _item={id:v.id,title:v.value.title,date:v.value.date,idea:v.value.idea,leader:v.value.initiator.id,participants:[],usernames:[],status:v.value.status,score:v.value.score,mode:v.value.mode,replayIdeas:v.value.replayIdeas};_item.participants.push(v.value.initiator.id);_item.usernames.push(v.value.initiator.username);for(j=0;j<v.value.participants.length;j++){_item.participants.push(v.value.participants[j].id);_item.usernames.push(v.value.participants[j].username)}if(_item.idea&&_item.idea.length>1){Utils.sortByProperty(_item.idea,"title",false)}_sessionData.push(_item)});_widget.sortSessions("sbydate")};_widget.getMode=function getMode(sid){var result;_sessionsCDB.loop(function(v,i){if(v.id===sid){result=v.value.mode}});return result};_widget.place(_dom);_widget.reset=function reset(){_sessionsCDB.unsync();_sessionsCDB.reset();_sessions.reset([]);_sortStatus.reset({sbytitle:{selected:false,descending:true},sbydate:{selected:true,descending:true},sbyidea:{selected:false,descending:true},sbyscore:{selected:false,descending:true}});_currentSort="sbydate";_sessionData=[];_searchData=[];_currentSearch="";_sessionsCDB.sync(_db,"library","_view/sessions",{key:'"'+_user.get("_id")+'"',descending:true}).then(function(){_widget.resetSessionData()})};["added","deleted","updated"].forEach(function(change){_sessionsCDB.watch(change,function(idx,value){_widget.resetSessionData();_widget.sortSessions(_currentSort)})});_widget.reset();return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatarlist":243,"../../../services/config":245,"../../../services/confirm":246,"../../../services/map":249,"../../../services/utils":256}],226:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),amy=require("../libs/amy2"),CouchDBTools=require("../libs/CouchDBTools"),Spinner=require("../libs/spin.min"),Widget=olives.OObject,Stack=amy.StackPlugin,Map=require("../services/map"),Event=olives["Event.plugin"],Config=require("../services/config"),Model=olives["Bind.plugin"],Store=emily.Store,Promise=emily.Promise,CouchDBDocument=CouchDBTools.CouchDBDocument;module.exports=function LoginConstructor($init,$reload,$local){var _login=new Widget,_loginForm=new Widget,_signupForm=new Widget,_loading=new Widget,_serverdown=new Widget,_internetdown=new Widget,_stack=new Stack,_store=new Store({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:false}),_labels=Config.get("labels"),_transport=Config.get("transport"),_db=Config.get("db"),spinner,loginSpinner=new Spinner({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270}).spin(),reload=false,_EULA=new Store({eula:""});_login.seam.addAll({loginstack:_stack});_login.template='<div id="login"><div id="login-stack" data-loginstack="destination"><div class="squirrel"></div></div></div>';_loading.seam.add("label",new Model(_labels));_loading.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>';_loading.place(document.getElementById("loading"));_serverdown.seam.add("label",new Model(_labels));_serverdown.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p></div>';_internetdown.seam.add("label",new Model(_labels));_internetdown.template='<div id="nointernet"><p data-label="bind: innerHTML, nointernet"></p></div>';_signupForm.seam.addAll({label:new Model(_labels),loginmodel:new Model(_store),eula:new Model(_EULA),signupevent:new Event(_signupForm)});_signupForm.template='<div><form id="signup-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: input, resetError"><input name="confirm-password" data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: input, resetError"><input name="firstname" data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: input, resetError"><input name="lastname" data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:input, resetError; listen:keypress, entersignup"></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, signup"></label></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label class="signup-button pressed-btn" name="#login-screen" data-signupevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form><div id="EULA" class="invisible"><div class = "confirm EULA"><div class="help-doctor"></div><p class="confirm-question" data-eula="bind:innerHTML,eula"></p><div class="option left" data-signupevent="listen:mousedown, press; listen:mouseup, acceptEULA" data-label="bind: innerHTML, accept"></div><div class="option right" data-signupevent="listen:mousedown, press; listen:mouseup, rejectEULA" data-label="bind:innerHTML, reject"></div></div></div><div>';_signupForm.press=function(event,node){node.focus();node.classList.add("pressed")};_signupForm.release=function(event,node){node.classList.remove("pressed")};_signupForm.entersignup=function(event,node){if(event.keyCode===13){event.target.blur();_signupForm.signup()}};_signupForm.showLogin=function(event,node){_login.reset();_stack.getStack().show("#login-screen")};_signupForm.resetError=function(event,node){var name=node.getAttribute("name"),btn=_signupForm.dom.querySelector("#signup");_store.set("error","");_store.set(name,node.value);if(_store.get("email")&&_store.get("password")&&_store.get("confirm-password")&&_store.get("firstname")&&_store.get("lastname")){btn.classList.add("btn-ready")}else{btn.classList.remove("btn-ready")}};_signupForm.getEULA=function(){_transport.request("GetEULA",{},function(result){var _eula=JSON.parse(result),lang=_labels.get("language"),translation,res;if(_eula.translations)translation=_eula.translations[lang];if(translation){res="<h4>"+translation.title+"</h4></div>"+translation.body+"</div>"}else res="<h4>"+_eula.title+"</h4></div>"+_eula.body+"</div>";_EULA.set("eula",res);_labels.watchValue("language",function(val){res="";translation=_eula.translations[val];if(translation){res="<h4>"+translation.title+"</h4></div>"+translation.body+"</div>"}else res="<h4>"+_eula.title+"</h4></div>"+_eula.body+"</div>";_EULA.set("eula",res)})})};_signupForm.showEULA=function(event,node){_signupForm.dom.querySelector("#EULA").classList.remove("invisible")};_signupForm.acceptEULA=function(event,node){node.classList.remove("pressed");_signupForm.completeSignup(true)};_signupForm.rejectEULA=function(event,node){node.classList.remove("pressed");_signupForm.completeSignup(false)};_signupForm.completeSignup=function(accept){var fn=_store.get("firstname"),ln=_store.get("lastname"),password=_store.get("password"),userid=_store.get("email").toLowerCase(),promise=new Promise,user=new CouchDBDocument;if(accept){_signupForm.dom.querySelector("#EULA").classList.add("invisible");loginSpinner.spin(_signupForm.dom);_transport.request("Signup",{name:userid,password:password,fn:fn,ln:ln,lang:Config.get("lang")},function(result){if(result.signup==="ok"){user.reset(Config.get("userTemplate"));user.set("firstname",fn);user.set("lastname",ln);user.set("username",fn+" "+ln);user.set("lang",Config.get("lang"));var now=new Date;user.set("regdate",[now.getTime()]);user.set("notifications",[{type:"MSG",toList:fn+" "+ln,date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()],object:_labels.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:_labels.get("signupwelcomebody")}]);_transport.request("Welcome",{userid:userid,language:user.get("lang")},function(result){return result});if(result.db){$local.set("db",result.db)}user.set("online",true);user.set("sock",Config.get("socket").socket.sessionid);user.setTransport(_transport);user.sync(result.db,userid).then(function(){return user.upload()}).then(function(){$local.set("currentLogin",userid);$local.set("userAvatar",user.get("picture_file"));$local.sync("ideafy-data");Config.set("uid",'"'+userid+'"');user.unsync();reload?$reload(true):$init(true)})}else{_store.set("error","error : "+result.message);_store.set("email","");loginSpinner.stop()}},this)}else{_signupForm.dom.querySelector("#EULA").classList.add("invisible");_store.set("error",_labels.get("EULArejected"))}};_signupForm.signup=function signup(event,node){var email=_store.get("email"),fn=_store.get("firstname"),ln=_store.get("lastname"),password=_store.get("password"),pwdConfirm=_store.get("confirm-password");node.classList.remove("btn-ready");if(email===""){_store.set("error",_labels.get("signupmissingemail"))}else if(password===""){_store.set("error",_labels.get("signupmissingpwd"))}else if(pwdConfirm===""){_store.set("error",_labels.get("signupmissingpwdok"))}else if(fn===""){_store.set("error",_labels.get("signupmissingfn"))}else if(ln===""){_store.set("error",_labels.get("signupmissingln"))}else{var userid=email.toLowerCase(),emailPattern=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;if(!emailPattern.test(userid)){_store.set("error",_labels.get("signupinvalidemail"))}else{if(password!==pwdConfirm){_store.set("error",_labels.get("signuppwdnomatch"))}else{_signupForm.showEULA()}}}};_loginForm.seam.addAll({label:new Model(_labels),loginmodel:new Model(_store,{forgotpwd:function(reset){reset?this.classList.remove("loginvisible"):this.classList.add("loginvisible")}}),loginevent:new Event(_loginForm)});_loginForm.template='<form id="login-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: input, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:mousedown, press; listen: mouseup, release; listen:mouseup, login"></label></p><p class="login-error"><label data-loginmodel="bind:innerHTML,error" class="login-error"></label><label class="forgotpwd" data-loginmodel="bind:forgotpwd,reset" data-label="bind:innerHTML, forgotpwd"  data-loginevent="listen:mousedown, press; listen:mouseup, release; listen:mouseup, resetPassword">Forgot your password?</label></p><p><label class="signup-button pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showSignup"></label></p></form>';_loginForm.press=function(event,node){node.classList.add("pressed")};_loginForm.release=function(event,node){node.classList.remove("pressed")};_loginForm.enterlogin=function(event,node){if(event.keyCode===13){event.target.blur();_loginForm.login()}};_loginForm.showSignup=function(event,node){_login.reset();_stack.getStack().show("#signup-screen")};_loginForm.resetError=function(event,node){var name=node.getAttribute("name"),btn=_loginForm.dom.querySelector(".login-button");_store.set("error","");_store.set("reset",false);_store.set(name,node.value);if(_store.get("email")&&_store.get("password")){btn.classList.add("btn-ready")}else btn.classList.remove("btn-ready")};_loginForm.login=function login(event,node){var email=_store.get("email").toLowerCase(),password=_store.get("password"),el=node||_loginForm.dom.querySelector(".login-button");if(email&&password){loginSpinner.spin(_loginForm.dom);_transport.request("Login",{name:email,password:password,sock:Config.get("socket").socket.sessionid},function(result){if(result.login==="ok"){Config.set("uid",'"'+email+'"');if(result.db){$local.set("db",result.db)}$local.set("currentLogin",email);_transport.request("GetAvatar",{id:email},function(result){if(!result.error){$local.set("userAvatar",result);$local.sync("ideafy-data");Config.set("avatar",result)}reload?$reload():$init()})}else{_store.set("error",_labels.get("invalidlogin"));_store.set("reset",true);loginSpinner.stop()}})}else _store.set("error",_labels.get("invalidlogin"));el.classList.remove("btn-ready")};_loginForm.resetPassword=function(event,node){var login=_store.get("email").toLowerCase();_transport.request("ResetPWD",{user:login},function(result){if(result==="ok"){_store.set("error",_labels.get("temppwd")+login)}else if(result.rst){_store.set("error",_labels.get("failedpwdreset")+"<a href='mailto:"+result.contact+"?Subject=Password%20support%20"+login+"'>"+_labels.get("support")+"</a>")}else{console.log(result);_store.set("error",_labels.get("somethingwrong"))}})};_stack.getStack().add("#login-screen",_loginForm);_stack.getStack().add("#signup-screen",_signupForm);_stack.getStack().add("#loading-screen",_loading);_stack.getStack().add("#maintenance-screen",_serverdown);_stack.getStack().add("#nointernet",_internetdown);_login.place(Map.get("login"));_login.init=function init(){_stack.getStack().show("#loading-screen");spinner=new Spinner({color:"#06b7fc",lines:10,length:10,width:4,radius:6}).spin(document.getElementById("loadingspin"))};_login.setScreen=function setScreen(target){_stack.getStack().show(target);if(target==="#signup-screen"){_signupForm.getEULA()}};_login.reset=function reset(signout){_store.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:false});if(signout){reload=true}};_login.stopSpinner=function stopSpinner(){loginSpinner&&loginSpinner.stop();spinner&&spinner.stop()};return _login}},{"../libs/CouchDBTools":72,"../libs/amy2":75,"../libs/emily":97,"../libs/olives":141,"../libs/spin.min":143,"../services/config":245,"../services/map":249}],227:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Map=require("../services/map"),Config=require("../services/config"),Avatar=require("../services/avatar");module.exports=function NotifyConstructor(){var notify=new Widget,notifyPopup=new Widget,user=Config.get("user"),observer=Config.get("observer"),labels=Config.get("labels"),current=0,currentUnread=0,popupEnabled=true,notif=new Store({unread:0,newmsg:false}),messages=new Store([]);notify.seam.addAll({notif:new Model(notif,{flashNew:function(newmsg){var flash,node=this;if(newmsg){flash=setInterval(function(){node.classList.contains("orange")?node.classList.remove("orange"):node.classList.add("orange")},600);setTimeout(function(){clearInterval(flash);node.classList.remove("orange");notif.set("newmsg",false)},3e3)}}}),place:new Place({notifyPopup:notifyPopup}),notifevent:new Event(notify)});notify.template='<div id="notify"><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: mousedown, push; listen:mouseup, showPopup"></div><div class = "signout-bubble" data-notifevent="listen:mousedown, signout"></div><div class = "info-bubble" data-notifevent="listen:mousedown, press; listen:mouseup, showAbout"></div><div id="notify-popup" data-place="place:notifyPopup"></div></div>';notify.getUnread=function getUnread(){var msg=user.get("notifications"),unread=0;for(i=0,l=msg.length;i<l;i++){if(msg[i].status==="unread")unread++}return unread};notify.push=function(event,node){node.classList.add("orange");event.stopPropagation()};notify.press=function(event,node){node.classList.add("pressed")};notify.showPopup=function(event,node){node.classList.remove("orange");notifyPopup.showPopup()};notify.signout=function signout(event,node){document.getElementById("cache").classList.add("appear");document.getElementById("dock").querySelector(".selected").classList.remove("selected");document.querySelector('a[href="#public"]').classList.add("selected");Config.get("observer").notify("signout")};notify.showAbout=function(event,node){node.classList.remove("pressed");Config.get("observer").notify("goto-screen","#dashboard");Config.get("observer").notify("show-about")};notifyPopup.seam.addAll({labels:new Model(labels),notify:new Model(messages,{setObject:function(type){var id=this.getAttribute("data-notify_id");if(type){switch(type){case"CXR":this.innerHTML=messages.get(id).username+labels.get("CXRobject");break;case"INV":this.innerHTML=messages.get(id).username+labels.get("INVObject");break;case"CXRaccept":this.innerHTML=messages.get(id).username+labels.get("acceptedCXR");break;case"CXRreject":this.innerHTML=messages.get(id).username+labels.get("rejectedCXR");break;case"CXCancel":this.innerHTML=messages.get(id).username+labels.get("canceledCX");break;case"DOC":this.innerHTML=messages.get(id).username+labels.get("sentdocmsg");break;case"2Q+":this.innerHTML=messages.get(id).username+labels.get("askednew");break;case"2C+":this.innerHTML=messages.get(id).username+labels.get("senttc");break;case"REF":this.innerHTML=messages.get(id).username+labels.get("joinedideafy");break;case"MUD-":this.innerHTML=labels.get("muinaday");break;case"MUQ-":this.innerHTML=labels.get("mufifteen");break;case"MUP+":this.innerHTML=labels.get("newpart");break;case"MUP-":this.innerHTML=labels.get("partleft");break;case"SCANCEL":this.innerHTML=labels.get("scancel");break;case"SSTART":this.innerHTML=labels.get("sstart");break;default:this.innerHTML=messages.get(id).object}}},setStyle:function(status){status==="unread"?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setFirstname:function(firstname){if(firstname)this.innerHTML=firstname;else this.innerHTML=labels.get("ideafy")},setAvatar:function(author){var _frag,_ui,node=this;if(author){_frag=document.createDocumentFragment();_ui=new Avatar([author]);_ui.place(_frag);!node.firstChild?node.appendChild(_frag):node.replaceChild(_frag,node.firstChild)}}}),notifyevent:new Event(notifyPopup)});notifyPopup.template='<div class="invisible"><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:mousedown, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:mousedown, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:setFirstname, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>';notifyPopup.closePopup=function closePopup(event,node){notifyPopup.dom.classList.add("invisible")};notifyPopup.showPopup=function showPopup(event,node){notifyPopup.dom.classList.remove("invisible");messages.reset(user.get("notifications").concat())};notifyPopup.displayComCenter=function displayComCenter(event,node){var id=node.getAttribute("data-notify_id");observer.notify("display-message",id)};observer.watch("display-message",function(){notifyPopup.closePopup()});notify.init=function init(){notify.reset();notifyPopup.dom.classList.add("invisible")};notify.reset=function reset(){currentUnread=notify.getUnread();notif.set("unread",currentUnread);notif.set("newmsg",false);messages.reset(user.get("notifications").concat())};user.watchValue("notifications",function(){var unread=notify.getUnread(),n=user.get("notifications").concat()||[];if(unread>currentUnread){notif.set("newmsg",true);notif.set("unread",unread);currentUnread=unread;if(user.get("settings")&&user.get("settings").notifyPopup)popup.classList.add("show-notify")}else if(unread<currentUnread){notif.set("unread",unread);currentUnread=unread}messages.reset(n)});return notify}},{"../libs/emily":97,"../libs/olives":141,"../services/avatar":242,"../services/config":245,"../services/map":249}],228:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Confirm=require("../../../services/confirm"),Promise=emily.Promise,Attachment=require("../../attach/attachment"),AddAttachment=require("../../attach/add");module.exports=function PublicEditConstructor($action){var _widget=new Widget,_attachmentUI=Attachment,_addAttachmentUI=new AddAttachment,_store=new CouchDBDocument,_languages=new Store(Config.get("userLanguages")),_resetLang=function(){_languages.loop(function(v,i){_store.get("lang")&&v.name===_store.get("lang").substring(0,2)?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_labels=Config.get("labels"),_error=new Store({error:""}),_alist=new Store([]),_addedAttachments=[],_removedAttachments=[],updateReplay;_store.setTransport(Config.get("transport"));_widget.seam.addAll({editlabel:new Model(_labels),editidea:new Model(_store,{displayLang:function(lang){var l;if(lang){l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")}},setVisibility:function(visibility){visibility==="public"?this.innerHTML=_labels.get("publiclbl"):this.innerHTML=_labels.get("privatelbl")},hideVisibility:function(visibility){visibility==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(visibility){visibility==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(session){!session||session.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(replay){replay?this.innerHTML=_labels.get("enabledreplaylbl"):this.innerHTML=_labels.get("disabledreplaylbl")},setSessionReplay:function(replay){replay?this.innerHTML=_labels.get("disablereplaylbl"):this.innerHTML=_labels.get("enablereplaylbl")},showAttachments:function(att){att&&att.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new Model(_alist,{setCat:function(cat){var cats=Config.get("cat"),colors=Config.get("catColors"),idx=cats.indexOf(cat);if(idx>-1){this.innerHTML=_labels.get(cat);this.setAttribute("style","color:"+colors[idx])}else{this.innerHTML=cat;this.setAttribute("style","color: #404040")}},setType:function(type){switch(type){default:this.setAttribute("style","background-image: url('../img/r2/download.png')");break}},setRef:function(name){var url=Config.get("location")+"/downloads",idx=this.getAttribute("data-alist_id");if(name){url+="?atype=idea&docid="+_store.get("_id")+"&file="+name;this.setAttribute("href",url)}},setRating:function(docId){var cdb,node=this;if(docId){cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(Config.get("db"),docId).then(function(){var v=cdb.get("votes")||[],l=v.length;if(l===0){node.innerHTML=""}else{node.innerHTML=Math.round(v.reduce(function(x,y){return x+y})/l*100)/100}})}}}),select:new Model(_languages,{setBg:function(name){if(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),place:new Place({AddAttachmentUI:_addAttachmentUI}),editevent:new Event(_widget),errormsg:new Model(_error,{setError:function(error){switch(error){case"notitle":this.innerHTML=_labels.get("titlefield")+_labels.get("emptyfielderror");break;case"nodesc":this.innerHTML=_labels.get("descriptionfield")+_labels.get("emptyfielderror");break;case"nosol":this.innerHTML=_labels.get("solutionfield")+_labels.get("emptyfielderror");break;default:this.innerHTML=""}}})});_widget.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl">Modify your idea</span></div><form class="form"><div class="idealang"><div class="currentlang" data-editidea="bind: displayLang, lang" data-editevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, upload">Publish</label><label class="cancel pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, cancel">Cancel</label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form><div class="attachments"><legend class="idealegend" data-editlabel="bind:innerHTML, attachments"></legend><div class="toggleattach" data-editevent="listen: mousedown, toggleAttachments"></div><ul class="a-list" data-alist="foreach"><li><a class="a-type" data-alist="bind:setType, type; bind: setRef, fileName" data-editevent="listen: mousedown, press; listen: mouseup, release"></a><label class="a-name" data-alist="bind:innerHTML, name">Name</label><label class="a-cat" data-alist="bind:setCat, category"></label><label class="a-delete" data-editevent="listen:mousedown, press; listen:mouseup, removeAttachment"></label><label class="a-zoom" data-editevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, zoom"></label></li></ul><legend class="a-legend" data-editlabel="bind:innerHTML, alegend"></legend><div data-place="place: AddAttachmentUI"></div></div></div>';_widget.place(Map.get("public-edit"));_widget.reset=function reset(id){_store.unsync();_store.reset();_addedAttachments=[];_removedAttachments=[];_store.sync(Config.get("db"),id).then(function(){_resetLang();_store.get("attachments")?_alist.reset(_store.get("attachments").concat()):_alist.reset([]);_addAttachmentUI.reset(id,"idea",_alist);_alist.watch("added",function(idx,val){_addedAttachments.push(val.docId)})});updateReplay=false};_widget.showLang=function(event,node){_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");_store.set("lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.editVisibility=function(event,node){node.classList.add("pressed");Confirm.reset(_labels.get("setpublicquestion"),function(decision){node.classList.remove("pressed");decision?_store.set("visibility","public"):_store.set("visibility","private");Confirm.hide()},"musession-confirm");Confirm.show()};_widget.press=function(event,node){node.classList.add("pressed")};_widget.release=function(event,node){node.classList.remove("pressed")};_widget.toggleAttachments=function(event,node){var list=_widget.dom.querySelector(".a-list");if(node.classList.contains("show")){list.classList.remove("invisible");node.classList.remove("show")}else{list.classList.add("invisible");node.classList.add("show")}};_widget.removeAttachment=function(event,node){var idx=node.getAttribute("data-alist_id"),id=_alist.get(idx).docId;_removedAttachments.push(id);_alist.alter("splice",idx,1);node.classList.remove("pressed")};_widget.manageAttachments=function(){var aA=_addedAttachments,rA=_removedAttachments;if(rA.length){rA.forEach(function(attachment_id){var idx1=-1,idx2=-1;for(i=0;i<aA.length;i++){if(aA[i]===attachment_id){idx1=i;break}}if(idx1>-1)aA.splice(idx1,1);_alist.loop(function(val,idx){if(val.docId===attachment_id){idx2=idx}});if(idx2>-1)_alist.alter("splice",idx2,1);_addAttachmentUI.deleteAttachmentDoc(attachment_id)})}if(aA.length||rA.length){_store.set("attachments",JSON.parse(_alist.toJSON()))}};_widget.zoom=function(event,node){var idx=node.getAttribute("data-alist_id");_attachmentUI.reset(_alist.get(idx).docId,"idea")};_widget.enableReplay=function(event,node){setTimeout(function(){_store.get("sessionReplay")?_store.set("sessionReplay",false):_store.set("sessionReplay",true);updateReplay=true;node.classList.remove("pressed")},300)};_widget.updateSessionReplay=function updateSessionReplay(bool){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),_store.get("sessionId")).then(function(){var arr=cdb.get("replayIdeas")||[],i;if(bool){arr.push(_store.get("_id"))}else{for(i=arr.length-1;i>=0;i--){if(arr[i]===_store.get("_id")){arr.splice(i,1)}}}cdb.set("replayIdeas",arr);return cdb.upload()}).then(function(){promise.fulfill();cdb.unsync()});return promise};_widget.upload=function(event,node){var now=new Date,modDate=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];
if(_store.get("title")===""){_error.set("error","notitle")}else if(_store.get("description")===""){_error.set("error","nodesc")}else if(_store.get("solution")===""){_error.set("error","nosol")}else{_widget.manageAttachments();_store.set("modification_date",modDate);_store.upload().then(function(){if(updateReplay){_widget.updateSessionReplay(_store.get("sessionReplay")).then(null,function(err){console.log(err)})}_widget.dom.querySelector(".idealang ul").classList.add("invisible");$action("close")})}node.classList.remove("pressed")};_widget.cancel=function(event,node){node.classList.remove("pressed");_widget.dom.querySelector(".idealang ul").classList.add("invisible");$action("close")};return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/config":245,"../../../services/confirm":246,"../../../services/map":249,"../../attach/add":145,"../../attach/attachment":146}],229:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),Promise=emily.Promise,Observable=emily.Observable,Attachment=require("../../attach/attachment"),WriteTwocent=require("../../twocents/writetwocent"),TwocentList=require("../../twocents/twocentlist"),Spinner=require("../../../libs/spin.min");module.exports=function PublicDetailConstructor($action){var _widget=new Widget,_attachmentUI=Attachment,_twocentWriteUI=new WriteTwocent,_publicTwocentList=new TwocentList("public"),_labels=Config.get("labels"),vote=new Store([{active:false},{active:false},{active:false},{active:false},{active:false}]),_voted=false,user=Config.get("user"),transport=Config.get("transport"),_store=new CouchDBDocument,_alist=new Store([]),_dom=Map.get("public-detail"),_domWrite,_obs=new Observable;_store.setTransport(transport);_widget.seam.addAll({label:new Model(_labels),publicdetail:new Model(_store,{toggleFavEdit:function(authors){var node=this;if(authors.indexOf(user.get("_id"))>-1){node.setAttribute("href","#public-edit")}else{node.setAttribute("href","#public-favorites");user.get("public-favorites")&&user.get("public-favorites").indexOf(_store.get("_id"))>-1?node.classList.add("unfav"):node.classList.remove("unfav");user.watchValue("public-favorites",function(val){val.indexOf(_store.get("_id"))>-1?node.classList.add("unfav"):node.classList.remove("unfav")})}},toggleTwocentShare:function(authors){authors.indexOf(user.get("_id"))>-1?this.setAttribute("href","#public-share"):this.setAttribute("href","#public-2cents")},displayWriteTwocent:function(authors){authors.indexOf(user.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(twocents){if(twocents&&twocents.length){document.getElementById("public-writetwocents").classList.add("invisible")}},date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setAuthor:function(authornames){if(authornames===user.get("username")&&_store.get("authors").indexOf(user.get("_id"))>-1){this.innerHTML=_labels.get("youlbl")}else{this.innerHTML=authornames}},setWrotelbl:function(authors){if(authors.length===1&&authors[0]===user.get("_id")){this.innerHTML=_labels.get("youwrotelbl")}else if(authors.length>1)this.innerHTML=_labels.get("theywrotelbl");else{this.innerHTML=_labels.get("ideawrotelbl")}},setAvatar:function setAvatar(authors){var _frag=document.createDocumentFragment(),_ui=new Avatar(authors);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},setRating:function setRating(votes){if(votes.length===0){this.innerHTML=""}else{this.innerHTML=Math.round(votes.reduce(function(x,y){return x+y})/votes.length*100)/100}},setDescription:function setDescription(desc){this.innerHTML=desc.replace(/\n/g,"<br>")},setSolution:function setSolution(sol){this.innerHTML=sol.replace(/\n/g,"<br>")},toggleVoteButton:function(votes){var idea=_store.get("_id"),authors=_store.get("authors");document.getElementById("ratingPopup").classList.remove("appear");if(user.get("rated_ideas").indexOf(idea)<0&&authors.indexOf(user.get("_id"))<0&&!_voted){this.setAttribute("name","vote");this.innerHTML=_labels.get("votebuttonlbl");this.classList.remove("votes");this.classList.add("publicButton")}else{_voted=true;this.classList.remove("publicButton");this.setAttribute("name","voted");if(votes.length===0){this.innerHTML="("+_labels.get("novotesyet")+")"}else if(votes.length===1){this.innerHTML="("+_labels.get("onevote")+")"}else{this.innerHTML="("+votes.length+" "+_labels.get("votes")+")"}this.classList.add("votes")}},showAttachments:function(att){att&&att.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new Model(_alist,{setCat:function(cat){var cats=Config.get("cat"),colors=Config.get("catColors"),idx=cats.indexOf(cat);if(idx>-1){this.innerHTML=_labels.get(cat);this.setAttribute("style","color:"+colors[idx])}else{this.innerHTML=cat;this.setAttribute("sytle","color: #404040")}},setType:function(type){switch(type){default:this.setAttribute("style","background-image: url('../img/r2/download.png')");break}},setRef:function(name){var url=Config.get("location")+"/downloads",idx=this.getAttribute("data-alist_id");if(name){url+="?atype=idea&docid="+_store.get("_id")+"&file="+name;this.setAttribute("href",url)}},setRating:function(docId){var cdb,node=this;if(docId){cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(Config.get("db"),docId).then(function(){var v=cdb.get("votes")||[],l=v.length;if(l===0){node.innerHTML="";node.parentNode.setAttribute("style","display: none;")}else{node.innerHTML=Math.round(v.reduce(function(x,y){return x+y})/l*100)/100;node.parentNode.setAttribute("style","display: inline-block;")}})}}}),vote:new Model(vote,{setIcon:function(active){var styleActive="background-image: url('img/public/activeIdeaVote.png');",styleInactive="background-image: url('img/public/rateForList.png');";active?this.setAttribute("style",styleActive):this.setAttribute("style",styleInactive)}}),place:new Place({PublicTwocentUI:_publicTwocentList}),publicdetailevent:new Event(_widget)});_widget.template='<div class="public-idea"><div class="header blue-dark"><a href="#public-2cents" data-publicdetail="bind: toggleTwocentShare, authors" data-publicdetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, publicdetailsheadertitle"></span><a href="#public-favorites" data-publicdetail="bind: toggleFavEdit, authors" data-publicdetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-publicdetail="bind:setAvatar, authors"></div><h2 data-publicdetail="bind:innerHTML,title"></h2><span class="date" data-publicdetail="bind:date, creation_date"></span><br><span class="author" data-publicdetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-publicdetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><legend class="idealegend" data-label="bind:innerHTML, principle"></legend><p data-publicdetail="bind:setDescription,description"></p><legend class="idealegend" data-label="bind:innerHTML, solution"></legend><p data-publicdetail="bind:setSolution,solution"></p><div class="attachments invisible" data-publicdetail="bind:showAttachments, attachments"><legend class="idealegend" data-label="bind:innerHTML, attachments"></legend><div class="toggleattach" data-publicdetailevent="listen: mousedown, toggleAttachments"></div><ul class="a-list" data-alist="foreach"><li><a class="a-type" data-alist="bind:setType, type; bind: setRef, fileName" data-publicdetailevent="listen: mousedown, press; listen: mouseup, release"></a><label class="a-name" data-alist="bind:innerHTML, name">Name</label><label class="a-cat" data-alist="bind:setCat, category"></label><div class="a-rating"><a class="item-acorn"></a><label class="rating" data-alist="bind:setRating,docId"></label></div><label class="a-zoom" data-publicdetailevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, zoom"></label></li></ul></div></div><div class="detail-footer"><div class ="rateIdea"><a class="item-acorn"></a><div class="rating" data-publicdetail="bind:setRating,votes"></div><div class="publicButton" data-publicdetail="bind:toggleVoteButton, votes" name="vote" data-publicdetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-publicdetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="public-writetwocents" class="invisible" data-publicdetail="bind: displayWriteTwocent, authors"></div><div id="public-twocents" class="twocents" data-publicdetail="bind: displayTwocentList, twocents" data-place="place: PublicTwocentUI"></div></div>';_widget.showCache=function showCache(){_widget.dom.querySelector("#idea-cache").classList.remove("invisible")};_widget.hideCache=function hideCache(){_widget.dom.querySelector("#idea-cache").classList.add("invisible")};_widget.reset=function reset(viewStore,index){var id=viewStore.get(index).id,promise=new Promise;vote.reset([{active:false},{active:false},{active:false},{active:false},{active:false}]);_widget.getIdea(id).then(function(){_store.get("attachments")?_alist.reset(_store.get("attachments")):_alist.reset([]);_store.watchValue("attachments",function(val){_alist.reset(val)});_voted=false;_twocentWriteUI.reset(_store.get("_id"));_publicTwocentList.reset(_store.get("_id"));_domWrite=document.getElementById("public-writetwocents");_twocentWriteUI.place(_domWrite);promise.fulfill()});return promise};_widget.getIdea=function getIdea(id){_store.unsync();_store.reset();return _store.sync(Config.get("db"),id)};_widget.refresh=function(){return _widget.getIdea(_store.get("_id"))};_widget.action=function(event,node){var name=node.getAttribute("href"),id=_store.get("_id"),fav,idx,favSpinner=new Spinner({color:"#FFFFFF",lines:8,length:6,width:3,radius:6,left:3,top:3});switch(name){case"#public-2cents":_twocentWriteUI.reset(id);_domWrite.classList.remove("invisible");break;case"#public-favorites":node.classList.add("favwait");favSpinner.spin(node);user.get("public-favorites")?fav=user.get("public-favorites").concat():fav=[];idx=fav.indexOf(id);idx>-1?fav.splice(idx,1):fav.push(id);if(fav.length<100||fav.length<user.get("public-favorites").length){user.unsync();user.sync(Config.get("db"),user.get("_id")).then(function(){user.set("public-favorites",fav);return user.upload()}).then(function(){favSpinner.stop();node.classList.remove("favwait");if(idx>-1){alert(_labels.get("removedfav"));node.classList.remove("unfav")}else{alert(_labels.get("addedfav"));node.classList.add("unfav")}})}else{alert(_labels.get("maxfavsize"));favSpinner.stop();node.classList.remove("favwait")}break;default:$action(name);break}};_widget.edit=function(){_stack.getStack().show("#public-edit")};_widget.press=function(event,node){node.classList.add("pressed")};_widget.release=function(event,node){node.classList.remove("pressed")};_widget.toggleAttachments=function(event,node){var list=_widget.dom.querySelector(".a-list");if(node.classList.contains("show")){list.classList.remove("invisible");node.classList.remove("show")}else{list.classList.add("invisible");node.classList.add("show")}};_widget.zoom=function(event,node){var idx=node.getAttribute("data-alist_id");_attachmentUI.reset(_alist.get(idx).docId,"idea")};_widget.vote=function(event,node){if(!_voted){document.getElementById("cache").classList.add("appear1");document.getElementById("ratingPopup").classList.add("appear")}node.classList.remove("pressed")};_widget.previewVote=function(event,node){var i=0,idx=node.getAttribute("data-vote_id");vote.loop(function(v,i){i<=idx?vote.update(i,"active",true):vote.update(i,"active",false)})};_widget.castVote=function(event,node){var grade=parseInt(node.getAttribute("data-vote_id"))+1,id=_store.get("_id"),json={id:id,vote:grade,voter:user.get("_id")};if(!_voted){_voted=true;transport.request("Vote",json,function(result){var ri=user.get("rated_ideas")||[];if(result!=="ok"){console.log(result,"something went wrong, please try again later");_voted=false}else{ri.unshift(id);user.set("rated_ideas",ri);alert(Config.get("labels").get("thankyou"));Config.get("observer").notify("update-polling");document.getElementById("cache").classList.remove("appear1");document.getElementById("ratingPopup").classList.remove("appear");vote.reset([{active:false},{active:false},{active:false},{active:false},{active:false}])}})}};_widget.place(_dom);return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256,"../../attach/attachment":146,"../../twocents/twocentlist":236,"../../twocents/writetwocent":238}],230:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),Widget=olives.OObject,Map=require("../../../services/map"),Store=emily.Store,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar");module.exports=function PublicSendmailConstructor($action){var _widget=new Widget,_error=new Store({errormsg:""}),_user=Config.get("user"),_transport=Config.get("transport"),_labels=Config.get("labels"),_mail=new Store({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:false});_widget.seam.addAll({labels:new Model(_labels),mail:new Model(_mail,{setUserAvatar:function(from){if(from)this.setAttribute("style","background: url('"+Config.get("avatar")+"') no-repeat center center; background-size: cover;")},date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setAvatar:function setAvatar(authors){var _frag=document.createDocumentFragment(),_ui=new Avatar(authors);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},setRating:function(rating){},setVotes:function(votes){}}),mailevent:new Event(_widget),errormsg:new Model(_error)});_widget.template='<div class="idea-sendmail"><div class="header blue-dark"><a href="#public-2cents" class="option left"></a><span data-labels="bind:innerHTML, sendidealbl"></span><a href="#public-favorites" class="option right"></a></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment. votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';_widget.place(Map.get("public-sendmail"));_widget.reset=function reset(idea){_error.reset({errormsg:""});_mail.reset({toField:"",from:_user.get("username"),subject:"",body:"",signature:_user.get("username")+" <"+_user.get("_id"),attachment:idea,sent:false});if(_user.get("signature"))_mail.set("signature",_user.get("signature"));json={}};_widget.validateAddress=function validateAddress(value){var emailPattern=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,emailArray=value.toLowerCase().split(/,|;/),result=true;for(i=0,l=emailArray.length;i<l;i++){if(!emailPattern.test(emailArray[i].trim())){_error.set("errormsg",emailArray[i]+_labels.get("notavalidaddress"));result=false;break}}return result};_widget.validateMessage=function validateMessage(){_mail.get("toField")?_widget.validateAddress(_mail.get("toField")):_error.set("errormsg",_labels.get("norecipient"));return _error.get("errormsg")===""};_widget.sendMail=function sendMail(){json.type="doc";json.recipient=_mail.get("toField");json.cc=_user.get("_id");json.replyTo=_user.get("_id");json.subject=_user.get("username")+_labels.get("sentdocmsg");json.header=_mail.get("subject");json.body=_mail.get("body");json.signature=_mail.get("signature");json.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+_mail.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+_mail.get("attachment").authornames+", <span style='color:black';>"+Utils.formatDate(_mail.get("attachment").creation_date)+"</span></p></div>";json.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+_mail.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+_mail.get("attachment").solution+"</p></div>";_transport.request("SendMail",json,function(result){if(result.sendmail==="ok"){_error.set("errormsg",_labels.get("yourmessage")+result.recipient+_labels.get("sentoklbl"));setTimeout(function(){$action("close")},350)}else{_error.set("errormsg",_labels.get("somethingwrong"));_mail.set("sent",false);console.log("error",result.error);console.log("response",result.response)}})};_widget.press=function(event,node){if(!node.classList.contains("sendmail")||!_mail.get("sent"))node.classList.add("pressed")};_widget.send=function(event,node){if(!_mail.get("sent")){_mail.set("sent",true);_error.set("errormsg","");node.classList.remove("pressed");_widget.validateMessage()?_widget.sendMail():_mail.set("sent",false)}};_widget.cancel=function(event,node){node.classList.remove("pressed");$action("close")};return _widget}},{"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],231:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Map=require("../../../services/map"),Store=emily.Store,CouchDBDocument=CouchDBTools.CouchDBDocument,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),Promise=emily.Promise,AutoContact=require("../../../services/autocontact"),Spinner=require("../../../libs/spin.min");module.exports=function PublicShareConstructor($action){var _widget=new Widget,_error=new Store({errormsg:""}),_user=Config.get("user"),_transport=Config.get("transport"),_labels=Config.get("labels"),_share=new Store({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:_user.get("signature")}),contactList=new Store([]),shareContacts=new Store([]),sendInProgress=false,spinner=new Spinner({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6}).spin();_widget.seam.addAll({labels:new Model(_labels),share:new Model(_share,{setHeader:function(title){this.innerHTML=_labels.get("sharing")+title}}),contacts:new Model(shareContacts,{setSelected:function(selected){selected?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new Model(contactList,{highlight:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new Event(_widget),errormsg:new Model(_error)});_widget.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>';_widget.reset=function reset($id){_error.reset({errormsg:""});_share.reset({body:"",docId:$id,docType:"",docTitle:"",signature:_user.get("username")+" <"+_user.get("_id")+">"});_widget.getIdeaDetails($id);if(_user.get("signature"))_share.set("signature",_user.get("signature"));shareContacts.reset([]);contactList.reset(_user.get("connections").concat())};_widget.getIdeaDetails=function getIdeaDetails(id){var cdb=new CouchDBDocument({});cdb.setTransport(_transport);cdb.sync(Config.get("db"),id).then(function(){_share.set("docType",cdb.get("type"));_share.set("docTitle",cdb.get("title"));cdb.unsync()})};_widget.updateAutoContact=function(event,node){var arr=JSON.parse(contactList.toJSON()),connections=_user.get("connections").concat(),clc,vlc=node.value.toLowerCase();if(node.value===""){contactList.reset(connections)}else{for(i=arr.length-1;i>=0;i--){clc=arr[i].username.toLowerCase();if(clc.search(vlc)!==0)arr.splice(i,1)}contactList.reset(arr)}contactList.loop(function(v,i){if(shareContacts.toJSON().search(v.userid)>-1)contactList.update(i,"selected",true)})};_widget.close=function close(event,node){node.parentNode.classList.add("invisible")};_widget.displayAutoContact=function(event,node){_widget.dom.querySelector("#sharelistauto").classList.remove("invisible");contactList.reset(_user.get("connections").concat())};_widget.discardContact=function(event,node){var id=node.getAttribute("data-contacts_id"),userid=shareContacts.get(id).userid;shareContacts.alter("splice",id,1);contactList.loop(function(v,i){if(v.userid===userid){setTimeout(function(){contactList.update(i,"selected",false)},200)}});_widget.unselectGroup(userid)};_widget.select=function(event,node){var id=node.getAttribute("data-auto_id");if(contactList.get(id).selected){_widget.removeContact(contactList.get(id));setTimeout(function(){contactList.update(id,"selected",false);_widget.dom.querySelector("#sharelistauto").classList.add("invisible")},200)}else{_widget.addContact(contactList.get(id));_widget.selectGroup();setTimeout(function(){contactList.update(id,"selected",true);_widget.dom.querySelector("#sharelistauto").classList.add("invisible")},200)}};_widget.selectAll=function(event,node){node.classList.remove("pressed");shareContacts.reset([]);contactList.reset(_user.get("connections").concat());contactList.loop(function(v,i){contactList.update(i,"selected",true);if(v.type==="user")shareContacts.alter("push",v)})};_widget.removeContact=function(contact){if(contact.type==="group"){for(j=contact.contacts.length-1;j>=0;j--){_widget.removeContact(contact.contacts[j])}}else{shareContacts.loop(function(v,i){if(v.userid===contact.userid)shareContacts.alter("splice",i,1)});_widget.unselectGroup(contact.userid);contactList.loop(function(val,idx){if(val.userid===contact.userid)contactList.update(idx,"selected",false)})}};_widget.selectGroup=function(){var cts,add=false;contactList.loop(function(v,i){if(v.type==="group"&&!v.selected){cts=v.contacts;add=true;for(j=cts.length-1;j>=0;j--){if(shareContacts.toJSON().search(cts[j].userid)<0){add=false;break}}if(add)contactList.update(i,"selected",true)}})};_widget.unselectGroup=function(userid){contactList.loop(function(v,i){if(v.type==="group"&&v.selected){if(JSON.stringify(v.contacts).search(userid)>0)contactList.update(i,"selected",false)}})};_widget.addContact=function(contact){var i,l,add=true;if(contact.type==="user")shareContacts.alter("push",contact);else{for(i=0,l=contact.contacts.length;i<l;i++){shareContacts.loop(function(val,idx){if(val.userid===contact.contacts[i].userid)add=false});if(add){shareContacts.alter("push",contact.contacts[i]);contactList.loop(function(val,idx){if(val.userid===contact.contacts[i].userid)contactList.update(idx,"selected",true)})}}}};_widget.press=function(event,node){node.classList.add("pressed")};_widget.share=function(event,node){var now=new Date,json={type:"DOC",status:"unread",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getMinutes()],author:_user.get("_id"),username:_user.get("username"),firstname:_user.get("firstname"),toList:"",ccList:"",object:"",body:_share.get("body"),signature:_share.get("signature"),docId:_share.get("docId"),docType:_share.get("docType"),docTitle:_share.get("docTitle"),dest:[]};if(!sendInProgress){sendInProgress=true;spinner.spin(node);_widget.buildRecipientList(json.docId,json.dest).then(function(){if(!json.dest.length){_error.set("errormsg","intented recipients already have this idea");node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());$action("close")},2500)}else{_transport.request("Notify",json,function(result){_error.set("errormsg",_labels.get("shareok"));node.classList.remove("pressed");sendInProgress=false;setTimeout(function(){spinner.stop();_widget.reset(json.docId);_widget.dom.querySelector("#sharelistauto").classList.add("invisible");contactList.reset(_user.get("connections").concat());$action("close")},2e3)})}})}};_widget.cancel=function(event,node){node.classList.remove("pressed");$action("close")};_widget.buildRecipientList=function buildRecipientList(docId,dest){var promise=new Promise,cdb=new CouchDBDocument;cdb.setTransport(_transport);cdb.sync(Config.get("db"),docId).then(function(){var sharedwith=cdb.get("sharedwith")||[],authors=cdb.get("authors"),i;shareContacts.loop(function(v,i){if(authors.indexOf(v.userid)<0){if(!sharedwith.length){sharedwith.push(v.userid);dest.push(v.userid)}else{if(sharedwith.indexOf(v.userid)<0){sharedwith.push(v.userid);dest.push(v.userid)}}}});cdb.set("sharedwith",sharedwith);return cdb.upload()}).then(function(){promise.fulfill()});return promise};_widget.place(Map.get("public-share"));return _widget}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../libs/spin.min":143,"../../../services/autocontact":241,"../../../services/avatar":242,"../../../services/config":245,"../../../services/map":249,"../../../services/utils":256}],232:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),ActionBar=require("../../../services/actionbar"),Promise=emily.Promise;function ListPollingConstructor($db,$design,$view,$query){var _store=new CouchDBView([]),_mosaic=new Store,_labels=Config.get("labels"),polling,display=false,currentBar=null,user=Config.get("user"),_options={db:$db,view:$view,design:$design,query:{descending:true,limit:50}},widget=this;if($query){_options.query=$query}this.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'>"+"<li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'>"+"<div class='item-header'>"+"<div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div>"+"<h2 data-listideas='bind:innerHTML,value.doc.authornames' data-display='bind:setAuthornames, mosaic'></h2>"+"<span class='date' data-listideas='bind:date,value.doc.creation_date'></span>"+"</div>"+"<div class='item-body'>"+"<h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3>"+"<p data-listideas='bind:setDesc,value.doc.description'></p>"+"</div>"+"<div class='item-footer'>"+"<a class='idea-type'></a>"+"<a class='item-acorn'></a>"+"<span class='rating' data-listideas='bind:setRating, value.rating'></span>"+" </div>"+"</li>"+"</ul></div>";this.seam.addAll({labels:new Model(_labels),listideas:new Model(_store,{date:function date(creadate){this.innerHTML=Utils.formatDate(creadate)},setDesc:function(desc){this.innerHTML=desc.replace(/\n/g,"<br>")},setRating:function setRating(rating){if(rating===undefined){var _id=this.getAttribute("data-listideas_id"),_arr=_store.get(_id).doc.votes||[];if(_arr.length===0){this.innerHTML=""}else{this.innerHTML=Math.round(_arr.reduce(function(x,y){return x+y})/_arr.length*100)/100}}else{this.innerHTML=rating}},setAvatar:function setAvatar(authors){var _ui,_frag}}),display:new Model(_mosaic,{setAuthornames:function(mosaic){var _id=this.getAttribute("data-listideas_id"),names=_store.get(_id).value.doc.authornames,authors=_store.get(_id).value.doc.authors;if(mosaic&&authors.length>1){this.innerHTML=names.split(",")[0]+_labels.get("andothers")}else this.innerHTML=names}}),listevent:new Event(this)});this.getModel=function(){return _store};widget.resetQuery=function resetQuery(query){var promise=new Promise,interval=user.get("settings").polling_interval||Config.get("polling_interval"),cdb=new CouchDBView,nores=widget.dom.querySelector(".noresult");if(query){_options.query=query}clearInterval(polling);
cdb.setTransport(Config.get("transport"));cdb.sync(_options.db,_options.design,_options.view,_options.query).then(function(){currentBar&&currentBar.hide();_store.reset(JSON.parse(cdb.toJSON()));_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");cdb.unsync();polling=setInterval(function(){cdb.reset([]);cdb.sync(_options.db,_options.design,_options.view,_options.query).then(function(){currentBar&&currentBar.hide();_store.reset(JSON.parse(cdb.toJSON()));_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");cdb.unsync()})},interval);promise.fulfill()});return promise};this.setLang=function(lang){if(lang==="*"){return widget.resetQuery({startkey:"[0,{}]",endkey:"[0]",descending:true,limit:50})}else{return widget.resetQuery({key:'[1,"'+lang+'"]',descending:true,limit:50})}};this.setMosaic=function(mosaic){mosaic?_mosaic.set("mosaic",true):_mosaic.set("mosaic",false)};this.setStart=function(event,node){var dom=document.getElementById("public");if(currentBar){currentBar.hide();currentBar=null}if(dom.classList.contains("mosaic")){dom.classList.remove("mosaic");node.scrollIntoView()}};this.showActionBar=function(event,node){var id=node.getAttribute("data-listideas_id"),display=false,frag,dom=document.getElementById("public");if(currentBar&&currentBar.getParent()===node){display=true}if(!dom.classList.contains("mosaic")&&!display){currentBar=new ActionBar("idea",node,_store.get(id).id);frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag)}};this.init=function init(){var promise=new Promise,interval=user.get("settings").polling_interval||Config.get("polling_interval"),cdb=new CouchDBView,nores=widget.dom.querySelector(".noresult");cdb.setTransport(Config.get("transport"));cdb.sync(_options.db,_options.design,_options.view,_options.query).then(function(){_store.reset(JSON.parse(cdb.toJSON()));_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");cdb.unsync();polling=setInterval(function(){cdb.reset([]);cdb.sync(_options.db,_options.design,_options.view,_options.query).then(function(){_store.reset(JSON.parse(cdb.toJSON()));_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");cdb.unsync()})},interval);promise.fulfill()});return promise};user.watchValue("settings",function(){var cdb=new CouchDBView,interval,nores=widget.dom.querySelector(".noresult");if(user.get("settings").polling_interval!==Config.get("polling_interval")){Config.set("polling_interval",user.get("settings").polling_interval);interval=Config.get("polling_interval");clearInterval(polling);cdb.setTransport(Config.get("transport"));polling=setInterval(function(){cdb.reset();cdb.sync(_options.db,_options.design,_options.view,_options.query).then(function(){currentBar&&currentBar.hide();_store.reset(JSON.parse(cdb.toJSON()));_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");cdb.unsync()})},interval)}});Config.get("observer").watch("update-polling",function(){widget.resetQuery()})}module.exports=function ListPollingFactory($db,$design,$view,$query){ListPollingConstructor.prototype=new Widget;return new ListPollingConstructor($db,$design,$view,$query)}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/actionbar":240,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256}],233:[function(require,module,exports){var olives=require("../../../libs/olives"),emily=require("../../../libs/emily"),CouchDBTools=require("../../../libs/CouchDBTools"),Widget=olives.OObject,Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Config=require("../../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../../services/utils"),Avatar=require("../../../services/avatar"),ActionBar=require("../../../services/actionbar"),Promise=emily.Promise;function ListPublicConstructor($db,$design,$view,$query){var _store=new CouchDBView([]),_mosaic=new Store,_usr=Config.get("user"),_labels=Config.get("labels"),display=false,currentBar=null,_options={db:$db,view:$view,design:$design,query:{descending:true,limit:50}},widget=this;_store.setTransport(Config.get("transport"));if($query){_options.query=$query}this.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'>"+"<li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'>"+"<div class='item-header'>"+"<div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div>"+"<h2 data-listideas='bind:innerHTML,value.doc.authornames' data-display='bind:setAuthornames, mosaic'></h2>"+"<span class='date' data-listideas='bind:date,value.doc.creation_date'></span>"+"</div>"+"<div class='item-body'>"+"<h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3>"+"<p data-listideas='bind:innerHTML,value.doc.description'></p>"+"</div>"+"<div class='item-footer'>"+"<a class='idea-type'></a>"+"<a class='item-acorn'></a>"+"<span class='rating' data-listideas='bind:setRating, value.rating'></span>"+" </div>"+"</li>"+"</ul></div>";if(_options.query.q){this.template="<div><div class='noresult date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'>"+"<li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'>"+"<div class='item-header'>"+"<div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div>"+"<h2 data-listideas='bind:innerHTML,doc.authornames' data-display='bind:setAuthornames, mosaic'></h2>"+"<span class='date' data-listideas='bind:date,doc.creation_date'></span>"+"</div>"+"<div class='item-body'>"+"<h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3>"+"<p data-listideas='bind:setDesc,doc.description'></p>"+"</div>"+"<div class='item-footer'>"+"<a class='idea-type'></a>"+"<a class='item-acorn'></a>"+"<span class='rating' data-listideas='bind:setRating, rating'></span>"+" </div>"+"</li>"+"</ul></div>"}widget.seam.addAll({labels:new Model(_labels),listideas:new Model(_store,{date:function date(date){if(date)this.innerHTML=Utils.formatDate(date)},setDesc:function(desc){if(desc)this.innerHTML=desc.replace(/\n/g,"<br>")},setRating:function setRating(rating){if(rating===undefined){var _id=this.getAttribute("data-listideas_id"),_arr=_store.get(_id).doc.votes||[];if(_arr.length===0){this.innerHTML=""}else{this.innerHTML=Math.round(_arr.reduce(function(x,y){return x+y})/_arr.length*100)/100}}else this.innerHTML=rating},setAvatar:function setAvatar(authors){var _ui,_frag}}),display:new Model(_mosaic,{setAuthornames:function(mosaic){var _id=this.getAttribute("data-listideas_id"),names=_store.get(_id).value.doc.authornames,authors=_store.get(_id).value.doc.authors;if(mosaic&&authors.length>1){this.innerHTML=names.split(",")[0]+_labels.get("andothers")}else this.innerHTML=names}}),listevent:new Event(this)});widget.getModel=function(){return _store};widget.resetQuery=function(query){var promise=new Promise,fav=_usr.get("public-favorites")||[],json={idList:fav},nores=widget.dom.querySelector(".noresult");_options.query=query;_store.unsync();_store.reset([]);if($query==="fav"&&fav.length){Config.get("transport").request("GetFavList",json,function(res){var arr=JSON.parse(res),i,l,lang;if(!query||query==="*")_store.reset(arr);else{for(i=0,l=arr.length;i<l;i++){lang=arr[i].value.doc.lang.substring(0,2);if(query===lang)_store.alter("push",arr[i])}}_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}else{_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){currentBar&&currentBar.hide();_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}return promise};widget.setLang=function(lang){if($query==="fav")return widget.resetQuery(lang);else if(lang==="*"){return widget.resetQuery({startkey:"[0,{}]",endkey:"[0]",descending:true,limit:50})}else{return widget.resetQuery({startkey:'[1,"'+lang+'", {}]',endkey:'[1,"'+lang+'"]',descending:true,limit:50})}};widget.setMosaic=function(mosaic){mosaic?_mosaic.set("mosaic",true):_mosaic.set("mosaic",false)};widget.setStart=function(event,node){if(currentBar){currentBar.hide();currentBar=null}var dom=document.getElementById("public");if(currentBar){currentBar.hide();currentBar=null}if(dom.classList.contains("mosaic")){dom.classList.remove("mosaic");node.scrollIntoView()}};widget.showActionBar=function(event,node){var id=node.getAttribute("data-listideas_id"),display=false,frag,dom=document.getElementById("public");if(currentBar&&currentBar.getParent()===node){display=true}if(!dom.classList.contains("mosaic")&&!display){currentBar=new ActionBar("idea",node,_store.get(id).id);frag=document.createDocumentFragment();currentBar.place(frag);node.appendChild(frag);display=true}};widget.init=function init(){var promise=new Promise,fav=_usr.get("public-favorites")||[],json={idList:fav},nores=widget.dom.querySelector(".noresult");if($query==="fav"){if(fav.length){Config.get("transport").request("GetFavList",json,function(res){_store.reset(JSON.parse(res));nores.classList.add("invisible");promise.fulfill()})}else{_store.reset([]);nores.classList.remove("invisible");promise.fulfill()}}else{_store.sync(_options.db,_options.design,_options.view,_options.query).then(function(){_store.count()?nores.classList.add("invisible"):nores.classList.remove("invisible");promise.fulfill()})}return promise}}module.exports=function ListPublicFactory($db,$design,$view,$query){ListPublicConstructor.prototype=new Widget;return new ListPublicConstructor($db,$design,$view,$query)}},{"../../../libs/CouchDBTools":72,"../../../libs/emily":97,"../../../libs/olives":141,"../../../services/actionbar":240,"../../../services/avatar":242,"../../../services/config":245,"../../../services/utils":256}],234:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),amy=require("../../libs/amy2"),Widget=olives.OObject,Model=olives["Bind.plugin"],Map=require("../../services/map"),Stack=amy.StackPlugin,IdeaDetail=require("./detail-stack/public-idea"),Edit=require("./detail-stack/public-edit"),Sendmail=require("./detail-stack/public-sendmail"),Share=require("./detail-stack/public-share"),Config=require("../../services/config"),Store=emily.Store,Spinner=require("../../libs/spin.min");module.exports=function IdeaStackConstructor(){var _widget=new Widget,_emptyList=new Widget,_ideaDetail,_sendmail,_share,_edit,_stack=new Stack,_labels=Config.get("labels"),_observer=Config.get("observer"),_store=new Store,current=0,spinner=new Spinner({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();_widget.seam.addAll({detailstack:_stack});_widget.template='<div class="detail-stack" data-detailstack="destination"></div>';_emptyList.template='<div class="msgsplash"><div class="header blue-dark"><span data-labels="bind:innerHTML, noideafound"></span></div><div class="innersplash"><span data-labels="bind: innerHTML, tryotherview"></span></div></div>';_emptyList.seam.add("labels",new Model(_labels));_widget.reset=function reset(viewStore,index){_store=viewStore;current=index;if(_store.count()){_stack.getStack().show("#public-ideadetail");_ideaDetail.hideCache();spinner.spin(_widget.dom);_ideaDetail.reset(viewStore,index).then(function(){spinner.stop();cache.classList.add("invisible")})}else{_stack.getStack().show("#empty-list")}};_widget.displayEmpty=function displayEmpty(name){_stack.getStack().show("#empty-list")};_widget.action=function action(name){var id=_store.get(current).id;switch(name){case"#public-edit":_edit.reset(id);_stack.getStack().show("#public-edit");break;case"#public-favorites":break;case"#public-share":_share.reset(id);_stack.getStack().show("#public-share");break;case"close":_stack.getStack().show("#public-ideadetail");break;default:_stack.getStack().show("#public-ideadetail");break}};_widget.edit=function edit(id){_edit.reset(id);_stack.getStack().show("#public-edit")};_widget.sendMail=function sendMail(idea){_sendmail.reset(idea);_stack.getStack().show("#public-sendmail")};_widget.share=function share(idea){_share.reset(idea._id);_stack.getStack().show("#public-share")};_ideaDetail=new IdeaDetail(_widget.action);_edit=new Edit(_widget.action);_sendmail=new Sendmail(_widget.action);_share=new Share(_widget.action);_stack.getStack().add("#public-ideadetail",_ideaDetail);_stack.getStack().add("#public-edit",_edit);_stack.getStack().add("#public-sendmail",_sendmail);_stack.getStack().add("#public-share",_share);_stack.getStack().add("#empty-list",_emptyList);_observer.watch("public-viewidea",function(id){_widget.viewIdea(id)});_observer.watch("public-edit",function(id){_widget.edit(id)});_observer.watch("public-sendmail",function(idea){_widget.sendMail(idea)});_observer.watch("public-share",function(idea){_widget.share(idea)});return _widget}},{"../../libs/amy2":75,"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/map":249,"./detail-stack/public-edit":228,"./detail-stack/public-idea":229,"./detail-stack/public-sendmail":230,"./detail-stack/public-share":231}],235:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),amy=require("../../libs/amy2"),Widget=olives.OObject,Control=amy.ControlPlugin,Model=olives["Bind.plugin"],Place=olives["Place.plugin"],Delegate=amy.DelegatePlugin,Map=require("../../services/map"),Config=require("../../services/config"),Detail=require("./public-stack"),Utils=require("../../services/utils"),List=require("./lists/list-public"),Polling=require("./lists/list-polling"),Stack=amy.StackPlugin,Menu=require("../../services/submenu"),Store=emily.Store,Spinner=require("../../libs/spin.min"),NewIdea=require("../../services/newidea");module.exports=function PublicConstructor(){var _widget=new Widget,_db=Config.get("db"),_observer=Config.get("observer"),_radio=new Control(_widget),_detail=new Detail,_menu,listDate,listRating,listFav,listSearch,initQuery,_user=Config.get("user"),_labels=Config.get("labels"),_currentLang=_user.get("lang").substring(0,2),_btns=new Store([{name:"#list-fav",css:"byfav",pushed:false,lang:null},{name:"#list-date",css:"bydate",pushed:true,lang:null},{name:"#list-rating",css:"byrating",pushed:false,lang:null},{name:"#lang",css:"bylang",pushed:false,lang:_currentLang}]),_languages=new Store([{name:"*"}]),_usrLg=Config.get("userLanguages"),_stack=new Stack,_listSpinner=new Spinner({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();_usrLg.forEach(function(val){_languages.alter("push",val)});_widget.template='<div id="public"><div class="cache"></div><div id = "public-menu"></div><div id="public-list" class="list"><div class="header blue-light"><div class="option left" data-publiccontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, publicideasheadertitle"></span><div class="option right" data-publicevent="listen: mousedown, plus"></div></div><div data-liststack="destination" data-publiccontrol="radio:li.list-item,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-label="bind: placeholder, searchpublicplaceholder" data-publicevent="listen: keypress, search"><ul class="listbtns" data-listbtns="foreach"><li class="tools-button" data-listbtns="bind:setName, name; bind:setClass, css; bind:setPushed, pushed; bind:setLang, lang" data-publicevent="listen:mouseup,show"></li></ul><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-publicevent="listen: mousedown, setLang; listen:mouseup, stopPropagation"></li></ul></div></div></div><div id="public-detail" class="details" data-publicplace="place:details"></div></div>';_widget.seam.addAll({liststack:_stack,listbtns:new Model(_btns,{setPushed:function(pushed){pushed?this.classList.add("pushed"):this.classList.remove("pushed")},setLang:function(lang){if(lang&&lang!=="*"){this.setAttribute("style","background-image:url('img/flags/"+lang+".png');");this.innerHTML=""}if(lang==="*"){this.setAttribute("style","background-image: none;");this.innerHTML="*"}},setClass:function(css){css&&this.classList.add(css)},setName:function(name){name&&this.setAttribute("name",name)}}),select:new Model(_languages,{setBg:function(name){if(name==="*"){this.setAttribute("style","background-image: none;background: whitesmoke;");this.innerHTML="*"}else{this.setAttribute("style","background-image:url('img/flags/"+name+".png');")}}}),label:new Model(_labels),publicevent:new Delegate(_widget),publicplace:new Place({details:_detail}),publiccontrol:_radio});_widget.place(Map.get("public"));_widget.selectStart=function(event){var _ideaList=_stack.getStack().getCurrentScreen().getModel(),_id=event.target.getAttribute("data-listideas_id");_detail.reset(_ideaList,_id)};_widget.displayHighlightedIdea=function displayHighlightedIdea(){var ideaList,ideaNode,id;ideaList=_stack.getStack().getCurrentScreen(),ideaNode=ideaList.dom.querySelector(".list-item.selected")||ideaList.dom.querySelector("li[data-listideas_id='0']"),id=0;if(ideaNode)id=ideaNode.getAttribute("data-listideas_id");ideaNode.classList.add("selected");ideaNode.scrollIntoView();_radio.init(ideaNode);_detail.reset(ideaList.getModel(),id)};_widget.show=function(event,node){var id=parseInt(node.getAttribute("data-listbtns_id"),10),name=_btns.get(id).name,st=_stack.getStack();if(name==="#lang"){_widget.dom.querySelector(".langlist").classList.remove("invisible")}else{_btns.loop(function(v,i){i===id?_btns.update(i,"pushed",true):_btns.update(i,"pushed",false)});if(name!==st.getCurrentName()){st.show(name);if(st.get(name).getModel().count()){_widget.displayHighlightedIdea()}else{_detail.displayEmpty(name)}}}};_widget.setLang=function(event,node){var id,lang;event.stopPropagation();event.preventDefault();id=node.getAttribute("data-select_id");lang=_languages.get(id).name;_currentLang=lang;_listSpinner.spin(_widget.dom.querySelector("#public-list"));_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",lang)});_widget.dom.querySelector(".langlist").classList.add("invisible");["#list-rating","#list-fav","#list-date"].forEach(function(name){var st=_stack.getStack();st.get(name).setLang(lang).then(function(){_listSpinner.stop();if(st.getCurrentName()===name&&st.get(name).getModel().count()===0){_detail.displayEmpty(name)}else _widget.displayHighlightedIdea()})})};_widget.stopPropagation=function(event,node){event.stopPropagation();event.preventDefault()};_widget.mosaic=function mosaic(){var domDetail=document.getElementById("public-detail");_widget.dom.classList.toggle("mosaic");if(domDetail.classList.contains("invisible")){domDetail.classList.remove("invisible");_detail.reset(listDate.getModel(),0)}if(_widget.dom.classList.contains("mosaic")){["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(ui){_stack.getStack().get(ui).setMosaic(true)})}else{["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(ui){_stack.getStack().get(ui).setMosaic(false)})}};_widget.plus=function(){NewIdea.reset();document.getElementById("cache").classList.add("appear")};_widget.search=function(event,node){if(event.keyCode===13){if(node.value===""){listDate.resetQuery().then(function(){_widget.dom.querySelector(".listbtns").classList.remove("invisible");_stack.getStack().show("#list-date");_btns.loop(function(v,i){v.name==="#list-date"?_btns.update(i,"pushed",true):_btns.update(i,"pushed",false)});_widget.displayHighlightedIdea()})}else{_widget.searchIdea(node.value)}node.blur()}};_widget.searchIdea=function searchIdea(query){_widget.dom.querySelector(".listbtns").classList.add("invisible");listSearch.resetQuery({q:query,sort:"\\creation_date<date>",include_docs:true}).then(function(){_stack.getStack().show("#list-search");if(listSearch.getModel().count()>0){_widget.displayHighlightedIdea()}else{_detail.displayEmpty("search")}})};_widget.reset=function reset(){listRating.init(_detail.reset);listDate.init(_detail.reset).then(function(){_stack.getStack().show("#list-date");_detail.reset(listDate.getModel(),0)})};_widget.showMenu=function showMenu(){_menu.toggleActive(true)};_widget.hideMenu=function hideMenu(){_menu.toggleActive(false)};_menu=new Menu(_widget.dom.querySelector("#public-menu"));_menu.toggleActive(false);_user.get("settings").contentLang?_currentLang=_user.get("settings").contentLang:_currentLang=_user.get("lang").substring(0,2);if(_currentLang==="all")_currentLang="*";_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",_currentLang)});if(_currentLang==="*"){initQuery={startkey:"[0,{}]",endkey:"[0]",descending:true,limit:50}}else{initQuery={startkey:'[1,"'+_currentLang+'", {}]',endkey:'[1,"'+_currentLang+'"]',descending:true,limit:50}}listDate=new Polling(_db,"library","_view/publicideasbylang",initQuery);listRating=new List(_db,"ideas","_view/ideasbyvotes",initQuery);listFav=new List(_db,"library","_view/publicideas","fav");listSearch=new List("_fti/local/"+_db,"indexedideas","publicbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:60,include_docs:true});_stack.getStack().add("#list-rating",listRating);_stack.getStack().add("#list-search",listSearch);_stack.getStack().add("#list-fav",listFav);_stack.getStack().add("#list-date",listDate);listDate.init().then(function(){var lang;_stack.getStack().show("#list-date");listDate.getModel().count()?_widget.displayHighlightedIdea():_detail.displayEmpty("#list-date");return listFav.setLang(_currentLang)}).then(function(){_user.watchValue("public-favorites",function(val){if(val.length!==listFav.getModel().count()){listFav.resetQuery(_currentLang).then(function(){if(_stack.getStack().getCurrentName()==="#list-fav"){listFav.getModel().count()?_widget.displayHighlightedIdea():_detail.displayEmpty("#list-fav")}})}});_user.watchValue("settings",function(s){var l=s.contentLang;if(l==="all")l="*";if(l&&l!==_currentLang){_currentLang=l;_btns.loop(function(v,i){if(v.name==="#lang")_btns.update(i,"lang",_currentLang)});["#list-date","#list-rating","#list-fav"].forEach(function(ui){_stack.getStack().get(ui).setLang(_currentLang)})}})});listRating.init();["#list-date","#list-rating","#list-fav"].forEach(function(ui){var wid=_stack.getStack().get(ui),_ideaList=wid.getModel(),_ideaNode,_id});_observer.watch("NewIdea",function(id,public){var _ideaList=listDate.getModel(),_ideaNode,_id,idx,ideaElem;if(public){if(_stack.getStack().getCurrentName()!=="#list-date")_stack.getStack().show("#list-date");_btns.loop(function(v,i){v.name==="#list-date"?_btns.update(i,"pushed",true):_btns.update(i,"pushed",false)});_listSpinner.spin(document.getElementById("public-list"));listDate.resetQuery().then(function(){_ideaList.loop(function(v,i){if(v.id===id)idx=i});_ideaNode=listDate.dom.querySelector(".list-item.selected");if(_ideaNode)_ideaNode.classList.remove("selected");ideaElem=listDate.dom.querySelector("li[data-listideas_id='"+idx+"']");ideaElem.classList.add("selected");_radio.init(idx);ideaElem.scrollIntoView();_detail.reset(_ideaList,idx);_listSpinner.stop()})}});return _widget}},{"../../libs/amy2":75,"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/map":249,"../../services/newidea":252,"../../services/submenu":253,"../../services/utils":256,"./lists/list-polling":232,"./lists/list-public":233,"./public-stack":234}],236:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),CouchDBTools=require("../../libs/CouchDBTools"),Widget=olives.OObject,Config=require("../../services/config"),CouchDBDocument=CouchDBTools.CouchDBDocument,Store=emily.Store,Promise=emily.Promise,Utils=require("../../services/utils"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],TwocentReplyList=require("./twocentreplylist"),WriteTwocent=require("./writetwocent"),WriteTwocentReply=require("./writetwocentreply"),Avatar=require("../../services/avatar");function TwocentListConstructor($view){var ui=this,cdb=new CouchDBDocument,labels=Config.get("labels"),store=new Store([]),transport=Config.get("transport"),user=Config.get("user"),$id,view=$view;cdb.setTransport(transport);ui.seam.addAll({labels:new Model(Config.get("labels")),twocents:new Model(store,{date:function date(date){if(date){this.innerHTML=Utils.formatDate(date)}},setFirstName:function(firstname){var id;if(firstname){if(firstname!==user.get("firstname")){this.innerHTML=firstname}else{id=this.getAttribute("data-twocents_id");store.get(id).author===user.get("_id")?this.innerHTML=Config.get("labels").get("youlbl"):this.innerHTML=firstname}}},setCommentlbl:function(firstname){var id;if(firstname){if(firstname!==user.get("firstname")){this.innerHTML=labels.get("twocentcommentlbl")}else{id=this.getAttribute("data-twocents_id");store.get(id).author===user.get("_id")?this.innerHTML=labels.get("youcommentedlbl"):this.innerHTML=labels.get("twocentcommentlbl")}}},setVisible:function(author){if(author){author===user.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")}},setInVisible:function(author){if(author){author===user.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;")}},deleteOK:function(replies){var tc;if(replies&&replies.length>0){this.setAttribute("style","display: none;")}else{tc=this.getAttribute("data-twocents_id");user.get("_id")===store.get(tc).author?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")}},toggleHideButton:function(replies){if(!replies||!replies.length)this.classList.add("invisible");else{this.classList.remove("invisible");if(replies.length===1){this.innerHTML=Config.get("labels").get("showonetcreply")}else{this.innerHTML=Config.get("labels").get("showtcrepliesbefore")+replies.length+Config.get("labels").get("showtcrepliesafter")}}},displayReplies:function(replies){var tc,_ui,frag;if(!replies||!replies.length){this.classList.add("invisible")}else{tc=this.getAttribute("data-twocents_id");_ui=new TwocentReplyList(replies,$id,tc,view);frag=document.createDocumentFragment();_ui.render();_ui.place(frag);if(this.hasChildNodes()){this.replaceChild(frag,this.firstChild)}else{this.appendChild(frag)}this.classList.remove("invisible")}},setAvatar:function setAvatar(author){var _frag,_ui;if(author){_frag=document.createDocumentFragment();_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}}),twocentevent:new Event(ui)});ui.template='<ul class="twocentList" data-twocents="foreach"><li class="twocent"><div class="twocentHeader"><div class="twocentAvatar" data-twocents="bind: setAvatar, author"></div><div class="twocentAuthor"data-twocents="bind: setFirstName, firstname"></div><span class="commentLabel" data-twocents="bind: setCommentlbl, firstname"></span><br/><div class="twocentDate date" data-twocents="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-twocents="bind: setVisible, author" data-twocentevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-twocents="bind: deleteOK, replies" data-twocentevent="listen: mousedown, deleteTwocent"></div><div class="twocentButton twocentReplyButton" data-twocents="bind: setInVisible, author" data-twocentevent="listen: mousedown, reply"></div></div></div><div class="twocentBody"><p class="twocentMessage" data-twocents="bind: innerHTML, message"></p><div class="repliesButton hideReplies" name="hide" data-twocents="bind: toggleHideButton, replies" data-twocentevent="listen: mousedown, toggleReplies" data-labels="bind:innerHTML, hidetwocentreplies"></div></div><div class="writePublicTwocentReply invisible"></div><div class="displayReplies" data-twocents="bind: displayReplies, replies"></div></li></ul>';ui.edit=function(event,node){var id=node.getAttribute("data-twocents_id"),currentUI=ui.dom.children[id],writeUI=new WriteTwocent,frag=document.createDocumentFragment(),cancel=function cancel(){ui.dom.replaceChild(currentUI,writeUI.dom)};writeUI.reset($id,store.get(id),id,cancel);writeUI.render();writeUI.place(frag);ui.dom.replaceChild(frag,currentUI)};ui.reset=function reset(id){var promise=new Promise;$id=id;store.reset([]);cdb.unsync();cdb.reset({});cdb.sync(Config.get("db"),$id).then(function(){var tc=cdb.get("twocents")||[];if(tc.length){store.reset(cdb.get("twocents"))}cdb.watchValue("twocents",function(value){store.reset(value)});promise.fulfill()},function(err){console.log(err)});return promise};ui.deleteTwocent=function(event,node){var position=node.getAttribute("data-twocents_id"),json={docId:$id,type:"delete",position:position,twocent:{author:user.get("_id")}};alert("Are you sure?");transport.request("WriteTwocent",json,function(result){if(result!=="ok"){alert(Config.get("labels").get("somethingwrong"))}})};ui.reply=function(event,node){var position=node.getAttribute("data-twocents_id"),parent=ui.dom.querySelector(".writePublicTwocentReply[data-twocents_id='"+position+"']"),writeUI=new WriteTwocentReply(parent),frag=document.createDocumentFragment();writeUI.reset($id,position);writeUI.render();writeUI.place(frag);if(!parent.hasChildNodes()){parent.appendChild(frag)}parent.classList.remove("invisible")};ui.toggleReplies=function(event,node){var position=node.getAttribute("data-twocents_id"),replies=store.get(position).replies,name=node.getAttribute("name"),dom=ui.dom.querySelector(".displayReplies[data-twocents_id='"+position+"']");if(name==="show"){dom.classList.remove("invisible");node.setAttribute("name","hide");node.classList.remove("showReplies");node.classList.add("hideReplies")}else{dom.classList.add("invisible");node.setAttribute("name","show");node.classList.remove("hideReplies");node.classList.add("showReplies")}}}module.exports=function TwocentListFactory($view){TwocentListConstructor.prototype=new Widget;return new TwocentListConstructor($view)}},{"../../libs/CouchDBTools":72,"../../libs/emily":97,"../../libs/olives":141,"../../services/avatar":242,"../../services/config":245,"../../services/utils":256,"./twocentreplylist":237,"./writetwocent":238,"./writetwocentreply":239}],237:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),Widget=olives.OObject,Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Utils=require("../../services/utils"),Config=require("../../services/config"),WriteTwocentReply=require("./writetwocentreply"),Avatar=require("../../services/avatar");function TwocentReplyListConstructor($data,$id,$tc,$view){var store=new Store($data),ui=this,avatars,user=Config.get("user"),labels=Config.get("labels"),transport=Config.get("transport");ui.seam.addAll({reply:new Model(store,{date:function date(date){if(date){this.innerHTML=Utils.formatDate(date)}},setFirstname:function(firstname){var id=this.getAttribute("data-reply_id");this.innerHTML=firstname;if(store.get(id).author===user.get("_id")){this.innerHTML=labels.get("youlbl")}},setReplylbl:function(firstname){var id=this.getAttribute("data-reply_id");this.innerHTML=labels.get("twocentreplycommentlbl");if(store.get(id).author===user.get("_id")){this.innerHTML=labels.get("yourepliedlbl")}},setAvatar:function setAvatar(author){var _frag=document.createDocumentFragment(),_ui=new Avatar([author]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)},setVisible:function(author){author&&author===user.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")},setInVisible:function(author){author&&author===user.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;")
}}),replyevent:new Event(ui),labels:new Model(labels)});ui.template='<ul class="replies" data-reply="foreach"><li class="twocentReply"><div class="twocentHeader"><div class="replyAvatar" data-reply="bind:setAvatar, author"></div><div class="twocentAuthor" data-reply="bind: setFirstname, firstname"></div><span class="commentLabel" data-labels="bind: setReplylbl, firstname"></span><br/><div class="twocentDate date" data-reply="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, deleteTwocentReply"></div><div class="twocentButton twocentReplyButton" data-reply="bind: setInVisible, author" data-replyevent="listen:mousedown, reply"></div></div></div><p class="twocentMessage replyMessage" data-reply="bind: innerHTML, message"></p><div class="writePublicTwocentReply replyToReply invisible"></div></li></ul>';ui.edit=function(event,node){var id=node.getAttribute("data-reply_id"),currentUI=ui.dom.children[id],writeUI=new WriteTwocentReply,cancel=function cancel(){ui.dom.replaceChild(currentUI,writeUI.dom)},frag=document.createDocumentFragment();writeUI.reset($id,$tc,$data[id],id,null,cancel);writeUI.render();writeUI.place(frag);ui.dom.replaceChild(frag,currentUI);UI=ui.dom};ui.deleteTwocentReply=function(event,node){var position=node.getAttribute("data-reply_id"),json={docId:$id,type:"deltcreply",twocent:$tc,position:position};transport.request("WriteTwocent",json,function(result){if(result!=="ok"){alert(Config.get("labels").get("somethingwrong"))}})};ui.reply=function(event,node){var id=node.getAttribute("data-reply_id"),twocentParent=ui.dom.parentNode,parent=twocentParent.querySelector(".writePublicTwocentReply[data-reply_id='"+id+"']"),frag=document.createDocumentFragment(),writeUI=new WriteTwocentReply(parent);writeUI.reset($id,$tc,null,id,$data[id].firstname);writeUI.render();writeUI.place(frag);if(!parent.hasChildNodes()){parent.appendChild(frag)}parent.classList.remove("invisible")}}module.exports=function TwocentReplyListFactory($data,$id,$tc,$view){TwocentReplyListConstructor.prototype=new Widget;return new TwocentReplyListConstructor($data,$id,$tc,$view)}},{"../../libs/emily":97,"../../libs/olives":141,"../../services/avatar":242,"../../services/config":245,"../../services/utils":256,"./writetwocentreply":239}],238:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),Widget=olives.OObject,Config=require("../../services/config"),Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Utils=require("../../services/utils"),Spinner=require("../../libs/spin.min");module.exports=function WriteTwocentConstructor($view){var ui=new Widget,user=Config.get("user"),transport=Config.get("transport"),now=new Date,twocent=new Store({author:user.get("_id"),message:"",firstname:user.get("firstname"),date:[now.getFullYear(),now.getMonth(),now.getDate()],datemod:"",plusones:0,replies:[]}),currentDoc,cancel,publishSpinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:24}),view=$view||"public",editTC="new",position=0;ui.seam.addAll({twocent:new Model(twocent,{date:function(date){if(date){this.innerHTML=Utils.formatDate(date)}},setVisible:function(date){date?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new Model(Config,{setAvatar:function(avatar){this.setAttribute("style","background: url('"+avatar+"') no-repeat center center;background-size:cover;")}}),labels:new Model(Config.get("labels")),twocentevent:new Event(ui)});ui.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: mousedown, press; listen: mouseup, publish">Publish</div></div></div>';ui.reset=function reset($id,$twocent,$pos,$cancel){var now=new Date;if($id){currentDoc=$id}if($twocent){twocent.reset($twocent);editTC=$twocent;position=$pos;twocent.set("datemod",[now.getFullYear(),now.getMonth(),now.getDate()])}else{twocent.reset({author:user.get("_id"),message:"",firstname:user.get("firstname"),date:"",datemod:"",plusones:0,replies:[]});twocent.set("date",[now.getFullYear(),now.getMonth(),now.getDate()]);editTC="new"}if($cancel)cancel=$cancel};ui.cancel=function(event,node){node.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;");if(cancel){cancel()}else{document.getElementById(view+"-writetwocents").classList.add("invisible")}};ui.publish=function(event,node){node.setAttribute("style","-webkit-box-shadow: none; background: none;");if(twocent.get("message")){var content=JSON.parse(twocent.toJSON()),json,type;publishSpinner.spin(node);editTC==="new"?type="new":type="edit";json={docId:currentDoc,type:type,position:position,twocent:content};transport.request("WriteTwocent",json,function(result){if(result!=="ok"){alert(Config.get("labels").get("somethingwrong"))}else{if(editTC==="new"){document.getElementById(view+"-writetwocents").classList.add("invisible")}else{cancel()}}node.setAttribute("style","background: #8cab68;");publishSpinner.stop()},ui)}};ui.press=function(event,node){node.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")};return ui}},{"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/utils":256}],239:[function(require,module,exports){var olives=require("../../libs/olives"),emily=require("../../libs/emily"),Widget=olives.OObject,Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("../../services/config"),Utils=require("../../services/utils"),Spinner=require("../../libs/spin.min");function WriteTwocentReplyConstructor($parent){var user=Config.get("user"),transport=Config.get("transport"),currentDoc,currentTwocent,position,replyTo,now=new Date,cancel,publishSpinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:24}),replyTemplate={author:user.get("_id"),message:"",firstname:user.get("firstname"),date:"",datemod:"",plusones:0},reply=new Store(replyTemplate);this.seam.addAll({model:new Model(reply,{date:function date(date){this.innerHTML=Utils.formatDate(date)}}),config:new Model(Config,{setAvatar:function(avatar){this.setAttribute("style","background: url('"+avatar+"') no-repeat center center;background-size:cover;")}}),writereplyevent:new Event(this),labels:new Model(Config.get("labels"))});this.template='<div class="writeTwocent writeTwocentReply"><div class="replyAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText replyMessage" data-labels="bind: placeholder, addtwocentreplyplaceholder" data-model="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-model="bind: date, date"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, publish;">Publish</div></div></div>';this.reset=function($id,$twocent,$reply,$pos,$replyTo,$cancel){var now=new Date;if($id&&$twocent){currentDoc=$id;currentTwocent=$twocent}$replyTo?replyTo=$replyTo:replyTo="";if($reply){reply.reset($reply);editTCR=$reply;position=$pos;reply.set("datemod",[now.getFullYear(),now.getMonth(),now.getDate()])}else{reply.reset({author:user.get("_id"),message:"",firstname:user.get("firstname"),date:"",datemod:"",plusones:0});reply.set("date",[now.getFullYear(),now.getMonth(),now.getDate()]);editTCR="newreply"}cancel=$cancel};this.cancel=function(event,node){node.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;");cancel?cancel():$parent.classList.add("invisible");reply.reset({author:user.get("_id"),message:"",firstname:user.get("firstname"),date:"",datemod:"",plusones:0})};this.publish=function(event,node){node.setAttribute("style","-webkit-box-shadow: none; background: none;");if(reply.get("message")){var content=JSON.parse(reply.toJSON()),json,type;publishSpinner.spin(node);editTCR==="newreply"?type=editTCR:type="editreply";if(replyTo){content.message="@ "+replyTo+" : "+content.message}json={docId:currentDoc,type:type,position:position,twocent:currentTwocent,reply:content};transport.request("WriteTwocent",json,function(result){node.setAttribute("style","background: #8cab68;");publishSpinner.stop();if(result!=="ok"){alert(Config.get("labels").get("somethingwrong"))}else{$parent.classList.add("invisible");reply.reset({author:user.get("_id"),message:"",firstname:user.get("firstname"),date:"",datemod:"",plusones:0})}})}};this.press=function(event,node){node.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")}}module.exports=function WriteTwocentReplyFactory($parent){WriteTwocentReplyConstructor.prototype=new Widget;return new WriteTwocentReplyConstructor($parent)}},{"../../libs/emily":97,"../../libs/olives":141,"../../libs/spin.min":143,"../../services/config":245,"../../services/utils":256}],240:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("./config"),Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,CouchDBDocument=CouchDBTools.CouchDBDocument,Promise=emily.Promise,New2C=require("./new2c"),Spinner=require("../libs/spin.min"),Confirm=require("./confirm"),Utils=require("./utils");function ActionBarConstructor($type,$parent,$data){var buttons=new Store([]),parentHeight=$parent.offsetHeight,style=new Store({height:parentHeight}),padding=10,user=Config.get("user"),labels=Config.get("labels"),observer=Config.get("observer"),transport=Config.get("transport"),db=Config.get("db"),buildButtons,ui=this,spinner=new Spinner({color:"#9AC9CD",lines:10,length:10,width:8,radius:10}).spin(),favSpinner=new Spinner({color:"#a0a0a0",lines:10,length:6,width:4,radius:6}).spin();this.seam.addAll({buttons:new Model(buttons,{setIcon:function(icon){this.setAttribute("style","background-image:url('"+icon+"');")}}),style:new Model(style,{setPosition:function(height){this.setAttribute("style","height:"+height+"px; margin-top:-"+(height-padding)+"px;")},setButtons:function(height){var mt=Math.floor((height-padding-40)/2);this.setAttribute("style","margin-top:"+mt+"px;")}}),action:new Event(this)});this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:mouseup, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:mousedown, press; listen:mouseup, action"></li></ul><div id="abspinner"></div></div>';this.hide=function(){var parent=ui.dom.parentElement;parent&&parent.removeChild(parent.lastChild)};this.getParent=function(){return $parent};this.press=function(event,node){event.stopPropagation();event.preventDefault();node.classList.add("pressed");spinner.el=document.getElementById("abspinner")};this.action=function(event,node){var id=node.getAttribute("data-buttons_id"),action=buttons.get(id).name;event.stopPropagation();event.preventDefault();node.classList.remove("pressed");switch(action){case"delete":this.deleteItem().then(function(){ui.hide()});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":Config.get("observer").notify("replay-session",$data.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();break;case"unfav":favSpinner.spin(node);document.getElementById("public")?this.removeFav("public-favorites"):this.removeFav("library-favorites");break;case"addfav":favSpinner.spin(node);document.getElementById("public")?this.addFav("public-favorites"):this.addFav("library-favorites");break;default:break}};buildButtons=function(type,data){var cdbView;switch(type){case"idea":cdbView=new CouchDBView;cdbView.setTransport(transport);cdbView.sync(db,"ideas","_view/all",{key:'"'+data+'"',include_docs:true}).then(function(){var pubFav=user.get("public-favorites")||[],libFav=user.get("library-favorites")||[];data=cdbView.get(0).doc;$data=cdbView.get(0).doc;if(data.authors.indexOf(user.get("_id"))>-1)buttons.alter("push",{name:"edit",icon:"img/wall/35modify.png"});if(data.sessionId&&data.sessionId!==""&&data.sessionId.search("deleted")===-1){if(data.sessionReplay||data.authors.indexOf(user.get("_id"))>-1){var cdb=new CouchDBView;cdb.setTransport(Config.get("transport"));cdb.sync(Config.get("db"),"library","_view/sessioncount",{key:'"'+data.sessionId+'"'}).then(function(){if(cdb.get(0)){buttons.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})}})}}if(document.getElementById("public")){if(pubFav.indexOf(data._id)>-1){buttons.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"})}else{buttons.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"})}}else if(document.getElementById("library")){if(libFav.indexOf(data._id)>-1){buttons.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"})}else{buttons.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"})}}buttons.alter("push",{name:"mail",icon:"img/wall/35mail.png"});if(data.authors.indexOf(user.get("_id"))>-1){if(user.get("connections")&&user.get("connections").length){buttons.alter("push",{name:"share",icon:"img/wall/35share.png"})}else if(user.get("facebook")||user.get("twitter")||user.get("gplus")||user.get("linkedin")){buttons.alter("push",{name:"share",icon:"img/wall/35share.png"})}}if(data.authors.length===1&&data.authors[0]===user.get("_id")&&!data.twocents.length&&!data.sharedwith.length&&data.visibility!=="public"){buttons.alter("push",{name:"delete",icon:"img/wall/35delete.png"})}if(data.authors.indexOf(user.get("_id"))===-1&&data.sharedwith.indexOf(user.get("_id"))>-1&&document.getElementById("library")){buttons.alter("push",{name:"delete",icon:"img/wall/35delete.png"})}});break;case"deck":var cdb=new CouchDBDocument;cdb.setTransport(transport);cdb.sync(db,$data).then(function(){if(cdb.get("created_by")===user.get("_id")){if(user.get("connections")&&user.get("connections").length){buttons.alter("push",{name:"share",icon:"img/wall/35share.png"})}else if(user.get("facebook")||user.get("twitter")||user.get("gplus")||user.get("linkedin")){buttons.alter("push",{name:"share",icon:"img/wall/35share.png"})}}if(user.get("taiaut_decks").length+user.get("custom_decks").length>1){buttons.alter("push",{name:"delete",icon:"img/wall/35delete.png"})}});break;case"message":buttons.alter("push",{name:"mail",icon:"img/wall/35mail.png"});buttons.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":buttons.alter("push",{name:"mail",icon:"img/wall/35mail.png"});if(data.type==="user")buttons.alter("push",{name:"twocent",icon:"img/2centDisable.png"});buttons.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:break}};this.deleteItem=function deleteItem(){var promise=new Promise,cdb=new CouchDBDocument,scope=this;cdb.setTransport(transport);switch($type){case"idea":if($data.authors.length===1&&$data.authors[0]===user.get("_id")){cdb.sync(Config.get("db"),$data._id).then(function(){var att=cdb.get("attachments")||[];if(att.length){att.forEach(function(val){Utils.deleteAttachmentDoc(val.docId)})}return cdb.remove()}).then(function(){promise.fulfill()})}else{transport.request("RemoveFromLibrary",{id:$data._id,userid:user.get("_id")},function(result){promise.fulfill()})}break;case"deck":if(user.get("active_deck")===$data){alert(labels.get("cannotdelactivedeck"));scope.hide()}else{Confirm.reset(labels.get("deldeckwarning"),function(decision){var spinner=new Spinner({lines:10,length:20,width:8,radius:10}).spin();if(!decision){Confirm.hide();scope.hide()}else{Confirm.hide();spinner.spin(document.getElementById("deckview"));if(user.get("taiaut_decks").indexOf($data)>-1){var arr=user.get("taiaut_decks");arr.splice(arr.indexOf($data),1);user.set("taiaut_decks",arr);user.upload().then(function(){spinner.stop();promise.fulfill()})}else{cdb.sync(db,$data).then(function(){var sw=cdb.get("sharedwith")||[],cd=user.get("custom_decks").concat();if(sw.length&&sw.indexOf(user.get("_id"))>-1){sw.splice(sw.indexOf(user.get("_id")),1);cdb.set("sharedwith",sw);cdb.upload.then(function(){cd.splice(cd.indexOf($data),1);user.set("custom_decks",cd);return user.upload()}).then(function(){spinner.stop();promise.fulfill()})}else if(cdb.get("created_by")===user.get("_id")){transport.request("DeleteDeck",{id:$data,userid:user.get("_id")},function(result){if(result==="ok"){cd.splice(cd.indexOf($data),1);user.set("custom_decks",cd);user.upload().then(function(){spinner.stop();promise.fulfill()})}else{console.log(result)}})}})}}},"importcard-confirm");Confirm.show()}break;case"message":var arr=user.get("notifications").concat(),i,index;for(i=0,l=arr.length;i<l;i++){if(JSON.stringify(arr[i])===JSON.stringify($data)){index=i;break}}arr.splice(index,1);user.set("notifications",arr);user.upload();break;case"contact":var arr=user.get("connections").concat(),now=new Date,date=[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()];if($data.type==="user"){for(i=arr.length-1;i>=0;i--){if(arr[i].type==="user"&&arr[i].userid===$data.userid)arr.splice(i,1);else if(arr[i].type==="group"){var grp=arr[i].contacts;for(j=grp.length-1;j>=0;j--){if(grp[j].userid===$data.userid)grp.splice(j,1)}}}}else{for(i=arr.length-1;i>=0;i--){if(arr[i].username===$data.username)arr.splice(i,1)}}user.set("connections",arr);if($data.type==="user")user.get("news").unshift({type:"CX-",date:date,content:{userid:$data.userid,username:$data.username}});user.upload().then(function(){if($data.type==="user"){var now=new Date,json={dest:[$data.userid],date:date,original:"",type:"CXCancel",author:user.get("_id"),username:user.get("username"),firstname:user.get("firstname"),toList:$data.username,ccList:"",object:user.get("username")+labels.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:user.get("firstname"),lastname:user.get("lastname"),userid:user.get("_id"),username:user.get("username"),intro:user.get("intro"),type:"user"}};transport.request("Notify",json,function(result){console.log(result)})}observer.notify("contact-deleted")});break;default:break}return promise};this.editItem=function editItem(){switch($type){case"idea":document.getElementById("public")?observer.notify("public-edit",$data._id):observer.notify("library-edit",$data._id);break;default:break}spinner.stop()};this.mailItem=function mailItem(){switch($type){case"idea":document.getElementById("public")?observer.notify("public-sendmail",$data):observer.notify("library-sendmail",$data);break;case"message":break;case"contact":observer.notify("message-contact",$data);break;default:break}};this.shareItem=function shareItem(){switch($type){case"idea":document.getElementById("public")?observer.notify("public-share",$data):observer.notify("library-share",$data);break;case"deck":observer.notify("deck-share",$data);break;case"message":break;case"contact":break;default:break}};this.sendTwocent=function sendTwocent(){New2C.reset($data)};this.addFav=function(list){var fav,update;user.get(list)?fav=user.get(list).concat():fav=[];if(fav.length<100){fav.push($data._id);user.set(list,fav);user.upload().then(function(){favSpinner.stop();alert(labels.get("addedfav"));ui.hide()})}else{favSpinner.stop();alert(labels.get("maxfavsize"));ui.hide()}};this.removeFav=function(list){var fav;user.get(list)?fav=user.get(list).concat():fav=[];fav.splice(fav.indexOf($data._id),1);user.set(list,fav);user.upload().then(function(){favSpinner.stop();alert(labels.get("removedfav"));ui.hide()})};buildButtons($type,$data)}module.exports=function ActionBarFactory($type,$parent,$data){ActionBarConstructor.prototype=new Widget;return new ActionBarConstructor($type,$parent,$data)}},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"../libs/spin.min":143,"./config":245,"./confirm":246,"./new2c":250,"./utils":256}],241:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Store=emily.Store,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Map=require("./map"),Config=require("./config");var AutoContactConstructor=function($dom,$outputNode,$update){var _widget=this,_user=Config.get("user"),_search=false,_contactList=new Store([]);_widget.seam.addAll({auto:new Model(_contactList,{setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")},setType:function(type){type==="group"?this.classList.add("group"):this.classList.remove("group")}}),select:new Event(_widget)});_widget.template='<div class = "autocontact"><div class="autoclose" data-select="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:setType, type; bind:setSelected, selected" data-select="listen:mousedown, select"></li></ul></div>';_widget.init=function init(){var arr=_user.get("connections").concat(),usernames=[],currentList=[],types={};_contactList.reset([]);for(i=0,l=arr.length;i<l;i++){usernames.push(arr[i].username);types[arr[i].username]=arr[i].type}usernames.sort().forEach(function(value){_contactList.alter("push",{username:value,type:types[value],selected:false})});if($outputNode.value){currentList=$outputNode.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++){currentList[i]=currentList[i].trim()}}_contactList.loop(function(v,i){currentList.indexOf(v.username)>-1?_contactList.update(i,"selected",true):_contactList.update(i,"selected",false)})};_widget.updateList=function updateList(){var arr,pattern,usernames=[],types={};if($outputNode.value){_search=true;arr=$outputNode.value.split(/,|;/);pattern=arr[arr.length-1].trim().toLowerCase();_contactList.reset([]);_user.get("connections").forEach(function(item){if(item.username.toLowerCase().search(pattern)===0){_contactList.alter("push",{username:item.username,type:item.type})}});if($outputNode.value){currentList=$outputNode.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++){currentList[i]=currentList[i].trim()}}_contactList.loop(function(v,i){currentList.indexOf(v.username)>-1?_contactList.update(i,"selected",true):_contactList.update(i,"selected",false)})}};_widget.close=function(event,node){event.stopPropagation();$dom.classList.add("invisible")};_widget.select=function(event,node){var id=node.getAttribute("data-auto_id"),selected=_contactList.get(id).selected;_contactList.update(id,"selected",!selected);selected?_widget.remove(_contactList.get(id)):_widget.add(_contactList.get(id))};_widget.add=function add(contact){var group;if(contact.type==="user"){if(!_search){$outputNode.value?$outputNode.value+=", "+contact.username:$outputNode.value=contact.username}else{var arr=$outputNode.value.split(/,|;/),res="";arr.forEach(function(value){value=value.trim()});arr.pop();for(i=0,l=arr.length;i<l;i++){res+=arr[i]+", "}res+=contact.username;$outputNode.value=res;_search=false}}else{_user.get("connections").forEach(function(value){if(value.username===contact.username){group=value.contacts}});group.forEach(function(value){if($outputNode.value.search(value.username)<0){_widget.add(value);_contactList.loop(function(v,i){if(v.username===value.username)_contactList.update(i,"selected",true)})}})}$update($outputNode.value)};_widget.remove=function remove(contact){var currentList,res="";if(contact.type==="user"){currentList=$outputNode.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++){currentList[i]=currentList[i].trim()}currentList.splice(currentList.indexOf(contact.username),1);currentList.forEach(function(value){res+=value+", "});$outputNode.value=res.substr(0,res.length-2);$update(res.substr(0,res.length-2));_contactList.loop(function(v,i){if(v.type==="group"&&v.selected){_user.get("connections").forEach(function(value){if(value.username===v.username){if(JSON.stringify(value).search(contact.username)>-1){_contactList.update(i,"selected",false)}}})}})}else{_user.get("connections").forEach(function(value){if(value.username===contact.username){value.contacts.forEach(function(user){_contactList.loop(function(v,i){if(v.username===user.username){_contactList.update(i,"selected",false)}});_widget.remove(user)})}})}};_widget.init();_widget.render();_widget.place($dom)};module.exports=function AutoContactFactory($dom,$outputNode,$update){AutoContactConstructor.prototype=new Widget;return new AutoContactConstructor($dom,$outputNode,$update)}},{"../libs/emily":97,"../libs/olives":141,"./config":245,"./map":249}],242:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Config=require("./config"),Utils=require("./utils");var AvatarConstructor=function($array){var _store=new Store({img:"",online:false}),_avatars=Config.get("avatars"),_cdb=new CouchDBView([]),_id=$array[0],bool=false;_cdb.setTransport(Config.get("transport"));this.seam.addAll({avatar:new Model(_store,{setStyle:function(img){if(img&&img!=="in progress"){this.setAttribute("style","background-image: url('"+img+"');")}},setStatus:function(online){online?this.classList.add("online"):this.classList.remove("online")}}),event:new Event(this)});this.template='<div class="avatar" data-avatar="bind: setStyle, img; bind: setStatus, online"></div>';_cdb.sync(Config.get("db"),"users","_view/online",{key:'"'+_id+'"'}).then(function(){if(_cdb.count())_store.set("online",true);_cdb.unsync();Config.get("socket").on("Presence",function(data){if(data.presenceData.id===_id)_store.set("online",data.presenceData.online)})});if($array.length>1){_store.set("img","img/avatars/deedee6.png")}else if(_id===Config.get("user").get("_id")){_store.set("img",Config.get("avatar"));Config.watchValue("avatar",function(){_store.set("img",Config.get("avatar"))})}else if(_id==="ideafy@taiaut.com"||_id==="IDEAFY"){_store.set("img","img/avatars/doctordeedee.png")}else if(_avatars.get(_id)){if(_avatars.get(_id)==="in progress"){_avatars.watchValue(_id,function(val){if(val&&val!=="in progress"){_store.set("img",val)}})}else{_store.set("img",_avatars.get(_id))}}else{Utils.getAvatarById(_id).then(function(res){_store.set("img",_avatars.get(_id))})}};module.exports=function AvatarFactory($id){AvatarConstructor.prototype=new Widget;return new AvatarConstructor($id)}},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"./config":245,"./utils":256}],243:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Store=emily.Store,Avatar=require("./avatar");var AvatarListConstructor=function($ids){var _store=new Store([]);$ids.forEach(function(id){_store.alter("push",{id:id})});this.seam.addAll({avatar:new Model(_store,{setAvatar:function(id){if(id){var _frag=document.createDocumentFragment(),_ui=new Avatar([id]);_ui.place(_frag);!this.hasChildNodes()?this.appendChild(_frag):this.replaceChild(_frag,this.firstChild)}}})});this.template='<ul data-avatar="foreach"><li data-avatar="bind: setAvatar, id"></li></ul>'};module.exports=function AvatarListFactory($ids){AvatarListConstructor.prototype=new Widget;return new AvatarListConstructor($ids)}},{"../libs/emily":97,"../libs/olives":141,"./avatar":242}],244:[function(require,module,exports){var olives=require("olives"),emily=require("emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("./config");var CardPopupConstructor=function($close){var cardDetails=new Store,labels=Config.get("labels"),_dom,position={x:0,y:0},charTemplate='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatName, firstname"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><ul><li><span class="cd-agelbl"></span><span data-carddetails="bind:innerHTML, age"></span><span class="agesuffix" data-label="bind:innerHTML, agelbl"></span></li><li><span class="cd-locationlbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, location"></span></li><li><span class="cd-joblbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, occupation.description"></span></li><li><span class="cd-familylbl"></span><span class="cd-info" data-carddetails="bind: setFamily, family"></span></li><li><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit"></span></li></ul></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl">Hobbies</span><p class = "charinfo" data-carddetails="bind:setLeisure, leisure_activities">hobbies</p><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "charinfo" data-carddetails="bind: setInterests, interests">Centers of interest</p><span class="contentTitle" data-label="bind: innerHTML, commentslbl">Comments</span><p class = "charinfo" data-carddetails="bind:setComments, comments"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',defaultTemplate='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatTitle, title"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><p><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit">Picture credits</span><br/><span class="cd-sourcelbl" data-label="bind:innerHTML, source">Source : </span><span class="cd-info" data-carddetails="bind: setSources, sources"></span></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><p class = "dyknow" data-carddetails="bind:innerHTML,didYouKnow"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',storyTemplate='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark story"> <div class="storytitlelbl" data-label="bind:innerHTML, storytitlelbl"></div><div class="storytitle"><span data-label="bind:innerHTML, cdtitlelbl"></span> <span data-carddetails="bind: formatTitle, title"></span></div><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-contentarea story"><span class="contentTitle" data-label="bind: innerHTML, scenariodesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,story"></p><span class="contentTitle" data-label="bind: innerHTML, soldesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,solution"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>';
this.seam.addAll({label:new Model(labels),carddetails:new Model(cardDetails,{setPosition:function(position){if(position){this.setAttribute("style","left:"+position.x+"px; top:"+position.y+"px;")}},setCaret:function(caret){var top,y=cardDetails.get("position").y;y>340?top=240:top=60;caret?this.setAttribute("style","display: inline-block; margin-top:"+top+"px;"):this.setAttribute("style","display: none;")},setPic:function(pic){var json,node=this;if(!pic){this.setAttribute("style","background-image: none;")}else if(pic.search("img/decks")>-1){this.setAttribute("style","background-image:url('"+pic+"');")}else{json={dir:"cards",filename:pic};Config.get("transport").request("GetFile",json,function(data){node.setAttribute("style","background:white; background-image: url('"+data+"');")})}},setSources:function(sources){if(sources&&sources.length){sources instanceof Array?this.innerHTML=sources.join(", "):this.innerHTML=sources}else{this.innerHTML=""}},formatTitle:function(title){if(title){this.innerHTML=title.toUpperCase()}},formatName:function(firstname){if(firstname){this.innerHTML=firstname.substring(0,1).toUpperCase()+firstname.substring(1).toLowerCase()+"  "+cardDetails.get("lastname").toUpperCase()}},setFamily:function(family){var couple=family.couple,children=family.children,res1,res2;if(couple===0){res1=labels.get("singlelbl")}else if(couple===1){res1=labels.get("marriedlbl")}else if(couple===2){res1=labels.get("divorcedlbl")}else if(couple===3){res1=labels.get("widowlbl")}if(children===0){res2=""}else{if(cardDetails.get("age")<20){children===1?res2=children+labels.get("onesiblinglbl"):res2=children+labels.get("siblingslbl")}else{children===1?res2=children+labels.get("onechildlbl"):res2=children+labels.get("childrenlbl")}res2=", "+res2}this.innerHTML=res1+res2},setLeisure:function(hobbies){var res="<ul>",i;if(hobbies&&hobbies.length){for(i=0;i<hobbies.length;i++){if(hobbies[i].comment){res+="<li>"+hobbies[i].name+" ("+hobbies[i].comment+")</li>"}else{res+="<li>"+hobbies[i].name+"</li>"}}this.innerHTML=res+"</ul>"}else{this.innerHTML=""}},setInterests:function(interests){var res="<ul>",i;if(interests&&interests.length){for(i=0;i<interests.length;i++){if(interests[i].comment){res+="<li>"+interests[i].name+" ("+interests[i].comment+")</li>"}else{res+="<li>"+interests[i].name+"</li>"}}this.innerHTML=res+"</ul>"}else{this.innerHTML=""}},setComments:function(comments){var res="<ul>",i;if(comments&&comments.length){for(i=0;i<comments.length;i++){res+="<li>"+comments[i]+"</li>"}this.innerHTML=res+"</ul>"}else{this.innerHTML=""}}}),popupevent:new Event(this)});this.close=function(event,node){_dom.classList.add("invisible");$close()};this.reset=function reset(card,position,caret,dom){_dom=dom;this.template="";typeof card==="string"?cardDetails.reset(JSON.parse(card)):cardDetails.reset(card);cardDetails.set("position",position);caret==="left"?cardDetails.set("caret",{left:true,right:false}):cardDetails.set("caret",{left:false,right:true});if(cardDetails.get("type")===1){this.template=charTemplate}else if(cardDetails.get("type")===5){this.template=storyTemplate}else{this.template=defaultTemplate}this.render();this.place(_dom);_dom.classList.remove("invisible")}};module.exports=function CardPopupFactory($close){CardPopupConstructor.prototype=new Widget;return new CardPopupConstructor($close)}},{"./config":245,emily:22,olives:63}],245:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),socketio=require("../libs/socket.io.min"),Transport=olives.SocketIOTransport.Client,Store=emily.Store,Observable=emily.Observable,CouchDBDocument=CouchDBTools.CouchDBDocument;var _location,_transport,_user,_observer,_config=new Store,_socket,_version="",_categories=[];_location="http://8.19.34.68:1664";_version="1.4.0";_socket=socketio.connect(_location);_transport=new Transport(_socket);_user=new CouchDBDocument;_observer=new Observable;_categories=["bus","mkt","notes","arch","spec","planning"];_catColors=["#9ac9cd","#f27b3d","#bd262c","#5f8f28","#657b99","#a000a1"];_user.setTransport(_transport);_config.reset({location:_location,version:_version,socket:_socket,transport:_transport,db:"ideafy",user:_user,observer:_observer,cat:_categories,catColors:_catColors,polling_interval:6e4,userTemplate:{lastname:"",firstname:"",address:{street1:"",street2:"",zip:null,state:"",city:"",country:""},gender:1,lang:"en-us",birthdate:[],connections:[],taiaut_decks:["INT"],custom_decks:[],categories:[],calendar:[],active_deck:"INT",occupation:{situation:"",job:"",organization:""},family:{couple:null,children:null},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],type:7,notifications:[],sentMessages:[],facebook:"",twitter:"",gplus:"",linkedin:"",username:"",sessionInProgress:{},organization:"",rated:[],rated_ideas:[],favorites:[],ip:0,picture_file:"img/avatars/deedee0.png",intro:"Ideafyer",title:null,achievements:[],ideas_count:0,su_sessions_count:0,mu_sessions_count:0,twocents_count:0,twoquestions_count:0,tutorial_complete:false,profile_complete:false,news:[],twocents:[],twoquestions:[],"public-favorites":[],"library-favorites":[],settings:{notifyPopup:true,useascharacter:false,ccme:false,privacy_lvl:0,showTips:true,startupScreen:"#public",listSize:null,polling_interval:6e4,contentLang:""},online:false},ideaTemplate:{title:"",sessionId:"",sessionReplay:false,authors:[],description:"",solution:"",creation_date:[],character:"",problem:"",lang:"en-us",context:"",techno:[],type:6,sharedwith:[],modification_date:[],inspired_by:"",visibility:"private",votes:[],rating:"",authornames:"",twocents:[],attachments:[]},TQTemplate:{author:[],question:"",creation_date:[],lang:"en-us",type:10,modification_date:[],votes:[],rating:"",username:"",twocents:[]},sessionTemplate:{title:"",description:"",initiator:{id:"",username:"",picture_file:""},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"",type:8,deck:"",status:"in progress",step:"",lang:"en-us",characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:0,sessionReplay:false},avatars:new Store({}),avatar:null,defaultLabels:{language:"en-us",outdated:"Your version is outdated and some features may not work properly. Please update Ideafy",emailplaceholder:"Email",passwordplaceholder:"Password",repeatpasswordplaceholder:"Confirm password",loginbutton:"Log in",newuserbutton:"New user",invalidlogin:"Invalid username or password",missingloginparam:"Please enter both username and password or register",signupmissingemail:"Please enter your email address in the field above",signupmissingpwd:"A password is required",signupmissingpwdok:"Please confirm your password",signupmissingfn:"Please enter your first name",signupmisingln:"Please enter your last name",signupinvalidemail:"Invalid email address",signuppwdnomatch:"Passwords do not match",signupwelcomeobject:"Welcome to Ideafy",signupwelcomebody:"Thank you for trying Ideafy. We hope you'll enjoy it. We designed it so you can manage ideas that matter to you or just play around. But don't keep what you're doing to yourself.",signupbutton:"Sign up",Initialization:"Initializing user data. Please wait ...",firstnameplaceholder:"First name",lastnameplaceholder:"Last name",createidealbl:"Enter a new idea",createdecklbl:"Create a new deck",ideatitleplaceholder:"Enter a title for your idea",ideadescplaceholder:"Enter a description of your idea in non technical terms",decktitleplaceholder:"Enter a title for your deck",deckdescplaceholder:"Enter a description of your deck",ideasolplaceholder:"Describe how your idea would work, what components, products, services or technologies you would  use",privatelbl:"Private",publiclbl:"Public",ideavisiblelbl:"Your idea is :",setideavisiblelbl:"Change status :",ideafyreplaylbl:"Ideafy Replay is :",ideafysetreplaylbl:"Change Ideafy Replay status :",enabledreplaylbl:"Enabled",disabledreplaylbl:"Disabled",enablereplaylbl:"Enable",disablereplaylbl:"Disable",oklbl:"Ok",continuelbl:"Continue",setpublicquestion:"Warning, every Ideafy user will be able to view your idea. This operation is irreversible. Do you want to proceed?",publicideasheadertitle:"Public Ideas",publicdetailsheadertitle:"Idea overview",searchpublicplaceholder:"Search public ideas...",ideadetailsheadertitle:"Idea Overview",idealistheadertitle:"My Ideas",searchprivateplaceholder:"Search your ideas...",modifyidealbl:"Modify your idea",sendidealbl:"Email your idea",sharedwith:"Shared with ",ideafyer:" Ideafyer",ideafyers:" Ideafyers",votebuttonlbl:"Vote",novotesyet:"No vote yet",onevote:"1 vote",votes:"votes",ideawrotelbl:" wrote : ",twocentcommentlbl:"commented :",youwrotelbl:"wrote :",theywrotelbl:"wrote :",youcommentedlbl:"commented :",youlbl:"You",hidetwocentreplies:"Hide replies",showonetcreply:"Reply",showtcrepliesbefore:"",showtcrepliesafter:" Replies",twocentreplycommentlbl:"replied :",yourepliedlbl:"replied :",addtwocentplaceholder:"Add your two cents",addtwocentreplyplaceholder:"Respond to this comment",twocentcreationdate:"Creation date: ",twocentmodificationdate:"Last modified: ",cancellbl:"Cancel",publishlbl:"Publish",savelbl:"Save",titlefield:"Title field",descriptionfield:"Description field",solutionfield:"Solution field",emptyfielderror:" cannot be left empty",somethingwrong:"Something went wrong, please try again later",thankyou:"Thank you",loadingmessage:"Application loading, please wait...",maintenancemessage:"We're sorry. The server is currently unavailable. Please come back later.","library-ideas":"My Ideas","library-sessions":"My Ideafy Sessions",sbytitle:"Session title",sbydate:"Date",sbyidea:"Idea title",sbyscore:"Score",searchsessions:"Search previous sessions...",foundlbl:"Found",matchingsessions:"matching session(s)",noideayet:"---",completed:"completed",inprogress:"in progress",noscore:"no score yet",deletereplay:"This session has the Ideafy replay feature enabled. Are you sure you want to delete it?","library-decks":"My Ideafy decks",brainstormheadertitle:"Brainstorm",brainstormchoosemode:"Choose your Ideafy mode",continuesession:"Continue last session",quickbmode:"Quick mode session",quickstart:"Describe your session",quickstarthelp:"<h2>Why is this step important?</h2><p>Giving your session a name and other background information will make it easier to retrieve later on from your library. Besides, it's always interesting to keep track of the particular context in which ideas or other contents were generated. If you are setting up a multi-user session, this will provide important context information to invitees and may persuade them to join.</p>",mustarthelp:"<h2>Multi-user housekeeping rules</h2><p>The session leader sets the objectives of a session and facilitates the session. He/she needs to set the pace of the brainstorming and be a good coach, listening to participant inputs and not imposing his/her views. Fostering good teamwork and having fun is as important for the leader as being creative.</p><p>Remember : if the session leader exits or if all participants leave the session before it is over (in the summary step) the session will end and all the current work will be lost.</p>",quickstarttitle:"Name your session",quickstarttitleplaceholderpre:"",quickstarttitleplaceholderpost:"'s session",quickstartdesc:"Enter a description of your session",quickstartdescplaceholder:"Date, context, purpose, ...",nextbutton:"Next",finishbutton:"Ready",quicksetup:"Set up a situation",quicksetuphelp:"<h2>Setting the stage</h2><p>This step lets you setup a random situation. Draw and select one card of each of the following categories: character, context, problem. They will be the starting point of your session. You can zoom in on each card to get additional information, select a different one by clicking on the deck icon at the top or accept it (thumbs-up button).</p><p>Which is it going to be ? Will you let fortune decide what situation you are going to deal with or will you work the stacks until you get one you are comfortable with? Ideafy encourages you to pick random situations because they force you to think outside the box.</p><p>Note that when you start a <i>Custom session</i> you can specify one or more of your starting cards to address specific situations.</p>",musetuphelp:"<h2>Setting the stage</h2><p>It is up to the session leader to draw cards of each type and to validate the selected cards by pushing the thumbs-up button.</p><p>Participants are able to view each card that is drawn and use the chat interface to provide feedback.</p><p>Select cards that are inspiring or that you can tie to the objectives of your session. Remember these cards can set your thoughts in the right direction to formulate problems or use cases and ultimately come up with an original idea.</p>",credits:"Credits : ",source:"Source : ",dyknow:"Did you know ?",agelbl:" years old",hobbieslbl:"Leisure activities",interestslbl:"Centers of interest",commentslbl:"Comments",singlelbl:"single",marriedlbl:"married",divorcedlbl:"divorced",widowlbl:"widow",nochildlbl:"no children",onechildlbl:" child",childrenlbl:" children",siblingslbl:" siblings",onesiblinglbl:" sibling",quickscenario:"Write your story",quickscenariohelp:"<p>This is your <strong>whiteboard.</strong></p><p>Now is the time to show your creativity and imagination. The cards you just picked give you a scope, a set of directions to project your thoughts. Use them as hints but do not feel overly constrained: they are here to help you <strong>write your own story and describe your own use case</strong>.</p><p>Finding the problem to solve is often the most important step of an innovation. So get started and use the tools below to <strong>post any thought, drawing or picture that will help you focus on a story.</strong></p><br><p>When you are done, click on the <strong>ready</strong> button at the bottom to write up your story.</p>",muscenariohelp:"<p>This is your shared whiteboard. Each participant may add new notes, pictures or drawing in relation to the scope defined by the cards drawn during the previous phase.</p><p>Once the leader feels there is enough material to start writing up a story, he/she may push the finish button only he/she can see at the bottom of the toolbar. Only the leader can fill the scenario template. Other participants will be able to see what the leader types and to help out by making suggestions in the chat window. Once the scenario is complete the leader can press net to proceed to the next step.</p>",choosecolorlbl:"Choose a color",importlbl:"Choose a picture",importpiclbl:"Choose a picture",importcameralbl:"Take a picture",pencilsizelbl:"Size",pencilcolorlbl:"Color",drawbgcolorlbl:"Background",cleardrawinglbl:"Clear",storytitleplaceholder:"Enter the title of your story",storydescplaceholder:"Tell your story, describe the problem your character is facing",storysolplaceholder:"How would you plan to fix this problem ?",quicktech:"Assign technologies",quicktechhelp:"<h2>Draw technologies</h2><p>The next phase of your session consists in finding a way to implement your solution using state of the art technologies. In this step you will draw three technology cards that you will try to include in your design.</p>",mutechhelp:"<h2>Draw technologies</h2><p>As in the setup phase it is up to the leader to draw technology cards and validate those selected by the team for this session. Remember :  finding a way to integrate random technologies in your solution forces you to think outside the box and come up with original and innovative designs.</p>",tech1lbl:"Techno 1",tech2lbl:"Techno 2",tech3lbl:"Techno 3",scenariolbl:"Scenario",storytitlelbl:"Your Story",cdtitlelbl:"Title : &nbsp",scenariodesclbl:"Scenario description",soldesclbl:"Solution description",quickidea:"Describe your idea",quickideahelp:"<p>Welcome back to your <strong>whiteboard.</strong></p><p>Your goal now is to try to apply the technologies that you just picked to design a solution to the use case described in your scenario.</p><p>Again do not feel too constrained: at this stage you can either alter your scenario to accomodate a technology, add additional technologies to the ones you have drawn to complete your solution or skip some of these if they do not fit in your design.</p><p>You are almost done: at the end of this step you will be able to refine your use case and turn it into an <strong>idea</strong>. You will be asked to provide a description in layman terms and also to describe how you would implement it with your chosen technologies.</p><br><p>When you are done, clik on the <strong>ready</strong> button at the bottom to write up your story.</p>",muideahelp:"<p>Welcome back to your <strong>whiteboard.</strong></p><p>Your goal now is to try to apply the technologies that you just picked to design a solution to the use case described in your scenario.</p><p>Do not feel too constrained: at this stage you can either alter your scenario to accomodate a technology, add additional technologies to the ones you have drawn to complete your solution or skip some of these if they do not fit in your design.</p><p>You are almost done: at the end of this step you will be able to refine your use case and turn it into an <strong>idea</strong>. As in the scenario phase it is up to the leader to display and complete the idea template.</p><br><p>When the leader clicks on the next button he can have the team vote on making the idea public and/or on enabling viewers (other than the participants) to view the session details via Ideafy replay. In both cases all of the participants need to agree. One negative vote and the proposal is rejected.</p>",quickwrapup:"Summary",quickstepstart:"Session description",quickstepsetup:"Setup",quickstepscenario:"Scenario",quicksteptech:"Technologies",quickstepidea:"Solution",quickstepwrapup:"Summary",congratulations:"Congratulations !",sessioncompleted:"You successfully completed your Ideafy session",ideatitlelbl:"Your Idea",scenarioheader:"Scenario",scenariosolution:"Solution",ideadescription:"Idea description",ideaimplementation:"Technical implementation",yourtime:"Your time",yourscore:"Your score",musession:"Multi-user session",customsession:"Custom session",ideafytutorial:"ideafy tutorial","connect-contacts":"Contacts","connect-messages":"Messages","connect-twocents":"Two cents","dashboard-profile":"My profile","dashboard-settings":"Settings","dashboard-about":"About Ideafy",tolbl:"To : ",subjectlbl:"Subject : ",yourmessage:"Your message to ",sentok:" has been sent.",sentdocmsg:" sent you an Ideafy document",notavalidaddress:" is not a valid email address",norecipient:"No email address specified",sendlbl:"Send",sharelbl:"Share",msglistheadertitle:"My Messages",notificationlbl:"Notifications",allbtn:"View all",msgbtn:"Messages",notifbtn:"Notifications",unreadbtn:"Unread",searchmsgplaceholder:"Search ...",messageview:"Message panel",replyalllbl:"Reply all",forwardlbl:"Forward",deletelbl:"Delete",newmsg:"New message",cclbl:"Cc :",tocontactlbl:"Contact :",entersubjectlbl:"Please enter a subject",notavalidcontact:" is not a contact",messagesentok:"Your message has been sent",on:"On ",contactview:"Contact panel",contactlistheadertitle:"My Contacts",usrbtn:"Users",grpbtn:"Groups",newcontactlbl:"New contact",addcontactnow:"Add your contact now",lookup:"Or look up the Ideafy database",beforecount:"The <strong>Ideafy community</strong> now counts <strong>",aftercount:" <strong>users </strong> merrily crafting and exchanging ideas.<br>Look up your acquaintances and friends in the community and connect.",addcontactrightintro:"Building up your address book is the best and fastest way to increase exposure of your ideas and thoughts, but also to get access to a much broader content.",searchcontactplaceholder:"Enter email address of the person you wish to connect with ...",clearemailfirst:"Please clear the email field first",needbothfnln:"Both first and last names are required",selectcontact:"Select contact and press + to invite",noentryfound:"No matching entry in the database",cannotaddself:"You cannot add a connection to yourself",alreadyconnected:" is already a contact",alreadysentCXR:"You already sent a connection request to ",CXRobject:" wants to be a connection",CXRsent:"Your connection request has been sent",addamessage:"Add a message",accept:"Accept",reject:"Reject",acceptedCXR:" has accepted your connection request",rejectedCXR:" has declined your connection request",CXRaccepted:"Request accepted, ",CXRrejected:"Contact request rejected",isnowacontact:" is now a contact",isnolongeracontact:" is no longer a contact",canceledCX:" has canceled your connection",newfolderlbl:"New group",groupnamelbl:"Group name",groupdesclbl:"Group description",colortouch:"A colorful touch is always nice","char":"Character",context:"Context",problem:"Problem",techno:"Technology",grpcontacts:"Group contacts",addgrpcontacts:"Add contacts",nogrpname:"Please enter a group name",nogrpintro:"Please provide a group description",grpnameexists:"A group with this name already exists",nocontactselected:"Please add at least one contact to your group",profilelbl:"My Profile",aboutlbl:"About Ideafy",settingslbl:"Application parameters",completionprefix:"Your profile is ",completionsuffix:"% complete",info:"information",leaderboard:"leaderboard",enterbirthdate:"Provide your date of birth",entergender:"Indicate your gender",enterfamily:"Complete your family status",enteraddress:"Specify your address",enterintro:"Change your introduction",enteroccupation:"Describe your occupation",enterleisure:"Provide at least two leisure activities",enterinterest:"Provide at least two areas of interest",entersocialnw:"Add a social network",enterownpic:"Customize your avatar",completeprofile:"<i>Complete your profile</i>",mystatslbl:"My Stats",ideaslbl:"Public Ideas",sessionslbl:"Sessions",contactslbl:"Contacts",toquestionslbl:"Twoquestions",recentactivitylbl:"Recent Activity",enterednewidea:"You entered a new idea: ",reachedrank:"Congratulations ! You made a new rank :",gotaward:"You received an award : ",posted2q:"You posted a TwoQuestion :",commentedon:"You commented on : ",by:" by ",profileintro:"Profile introduction",shortprofiledesc:"Short profile description",day:"Day",dob:"Date of birth",jan:"January",feb:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December",year:"Year",mailaddress:"My Address",street:"Street",city:"City",state:"State",zip:"ZIP code",country:"Country",myfamily:"My Family",single:"Single",married:"Married",divorced:"Divorced",widow:"Widow",relation:"In a couple",children:"Children",myoccupation:"My Occupation",student:"Student",active:"Active",retired:"Retired",unemployed:"Unemployed",stayathome:"Stay at home parent",jobtitle:"Job title",organization:"Organization",name:"Name",comment:"Comment",field:"Field",updatelbl:"Update",selectavatar:"Or select an avatar",uploadcomplete:"Upload complete",mynotes:"My Notes",writesomething:"Write something",stats:"Stats",achievements:"Achievements",decklistheadertitle:"My Decks",ideafypoints:" Ideafy Points",version:"Version : ",groupupdated:"Group updated",socialnwlbl:"Social networks",designedby:"Designed by : ",mtcheadertitle:"My Two Cents Wall",userpref:"User Preferences",publicwallsettings:"Public wall settings",brainstormsettings:"Brainstorm Settings",aboutIdeafy:"About Ideafy",faq:"FAQ",tutorials:"Tutorials",userguide:"User Guide",support:"Support",eula:"View License Agreement",page:"Page ",supportlegend:"A question or an issue?",supportplaceholder:"Enter your text and send",requestsent:"Thank you ! Your request has been sent",createquestion:"New TwoQuestion",questionplaceholder:"Enter your question",noquestion:"Please enter a question",lengthexceeded:"Maximum question length reached",characters:" characters",publicidealbl:"Public Idea",privateidealbl:"Private Idea",publicwarning:"<b>WARNING :</b> publishing your idea as a public one is irreversible. Visit Ideafy's dashboard to learn more.",uploadinprogress:"Upload in progress",notifyingcontacts:" Notifying contacts",askednew:" has asked a new TwoQuestion",melbl:"Me",nowconnected:" are now connected with ",noreplyyet:"No reply yet",mytwoquestions:"My TwoQuestions",mytwocents:"My Twocents",twoqprefix:"",twoqsuffix:"'s TwoQuestions",notwoqyet:"This Ideafyer has not posted any TwoQuestion yet",mytqdetailheader:"My TwoQuestion",tqheaderprefix:"",tqheadersuffix:"'s TwoQuestion",selecttq:"Select a contact to diplay TwoQuestions",mytwocentwall:"My Twocent Wall",sendtcprefix:"Send a Twocent to ",sendtcsuffix:"",twocentplaceholder:"Write your two cents",nomessage:"Please enter a message",sendinginprogress:"Sending in progress",senttc:" wrote you a new Twocent",selectall:"Select all",shareok:"Document shared successfully",signaturelbl:"Signature",sharing:"Sharing : ",messagecenter:"Message Center",twocentview:"Twocent Center",twocentcenter:"TwoQuestions & Twocents","about-taiaut":"About Taiaut",ideafydesc:"Look at Ideafy as your personal accelerator of ideas. You need ideas? Browse the database of ideas shared by other Ideafyers, ask your network or craft new ones using the embedded brainstorming engine. You have creative ideas? Ideafy makes it easy to share them with your network or to expose them to a community of innovative minds. Start discussions, ask questions or just give your two cents. Your Ideafyer friends want to find out what is on your mind. Ideation is fun. Get started and earn as many Ideafy Points and achievements as you can. Will you be the King of Ideas?",taiautdesc:"Ideafy was founded in February 2014. The aim of the company is to empower individuals and businesses to make the most of their innovation potential. Ideafy takes advantage of leading edge communication technologies to advance creative ideas and best innovation practices globally. The company is headquartered in Fresno, California",solene:"Solène Troussé",oliviers:"Olivier Scherrer",olivierw:"Olivier Wietrich",vincent:"Vincent Weyl",contribsolene:"User interface design",contribscherrer:"Framework design and development",contribwietrich:"User Interface development and software packaging",contribvincent:"Application conception & lead developer","public":"Public wall",library:"My Library",brainstorm:"Brainstorming center",connect:"Communication Center",dashboard:"Dashboard",notips:"Do not show tips at startup",showtips:"Show tips at startup",shownotif:"Show notification popup",setlang:"Choose your language",choosestartup:"Choose your startup screen",usechar:"Allow my profile to be used as an Ideafy character (my name will not be shown)",changepwd:"Change password",changelbl:"Change",brainstormtutorial:"Brainstorming tutorial",twoway:"Support is a two-way street",supportusintro:"Ideafy is a free application and we intend to keep it that way. We are committed to bringing you the best experience. Here are a few things you can do to help us support you better:",asanideafyer:"As an Ideafyer",asanexec:"As a business executive",asadev:"As a developer",asaninvest:"As an investor",ideafyerhelp:"Tell us how you feel by rating the application. If you encounter an issue please use the form above and we will try to fix it speedily. All your feedback is welcome and really helps us improve Ideafy.",exechelp:'If you feel like your business could become even more innovative by using such a platform internally or with your partners, we do propose standalone deployments or dedicated instances. This will not be free but we offer ultra competitive conditions. Contact us with the form above or via our <a onclick=\'window.open("http://www.taiaut.com", "_system");\'>website</a>',devhelp:'Ideafy exists thanks to three javascript libraries written by the company partners. They are released under MIT licenses and are available here : <a onclick=\'window.open("http://github.com/flams/emily", "_system");\'>emily</a>, <a onclick=\'window.open("http://github.com/flams/olives", "_system");\'>olives</a> and <a onclick=\'window.open("http://http://github.com/flams/CouchDB-emily-tools", "_system");\'>couchdb-emily-tools</a>. Check them out and if you are up for it help us make them even better.',investhelp:"We have plenty of ideas to expand the Ideafy service and we are constantly looking for funding opportunities. If you are interested, want to find out about our future and be part of it please contact us.",toc:"Table of contents",backtotop:"Back to top",choosepolling:"Poll new public ideas",everymin:"Every minute",everyfive:"Every 5 minutes",everyfifteen:"Every 15 minutes",never:"Disabled",nointernet:"Your device is not connected: please check your Internet access and try again.",schedmaintenance:"Scheduled maintenance",nextmaintenance:"The next maintenance will take place on : ",startnewmub:"Start a new session",joinmub:"Join a session",selectmode:"Select mode",roulette:"Roulette",campfire:"Campfire",boardroom:"Boardroom",rouletteinfo:"Any other Ideafyer may join this session",campfireinfo:"Anyone from your contact list may join this session (no notification)",boardroominfo:"Invitation only: invited contacts are notified and may join this session",clear:"Clear",create:"Create",nofriendtoinvite:"No contact to invite: please add contacts to your list or select an other mode",inviteatleastone:"You must select at least one contact to invite",providesessioninfo:"You must enter a meaningful title and description",sendinginvites:"Sending invitations...",invitesent:"Invitations sent",INVObject:" invited you to an Ideafy session",nolongerjoin:"You can no longer join this session : it is already underway or completed.",clicktojoin:"Push the button below to join session.",selectsession:"Select a session",participantleave:"Are you sure you want to leave? You will not be able to re-join nor will you get credited for any outcome  of the session",leaderleave:"Are you sure you want to cancel this session? This will end it for all participants.",canceledbyleader:"Session canceled by leader: ending now",participantsleft:"All participants have left: the session is canceled",waitingroomlbl:"Waiting room",joinedsession:"<i>You joined this session.</i>",deletingsession:"Deleting session : ",participants:"Participants",startbutton:"Start",joinbutton:"Join",nosessionfound:"No session found",allmodes:"All modes",all:"All",mode:"Mode",lang:"Lang",title:"Title",leader:"Session leader",sessionfull:"The session is full",sessionstarted:"This session is already started",sessiondeleted:"This session has been canceled",chatmsg0:" has initiated the session",chatmsg1:" has joined the session",chatmsg2:" has left the session",chatmsg3:" has canceled the session",chatmsg4:"Your session is starting now",chatmsg5:"Beginning new step : ",chatmsg6:"This concludes the current step. Moving on to the next screen...",chatmsg7:"Session completed",typemsg:"Enter your text",said:" said :",noresult:"No result found",clicktoview:"Press the button below or visit your library to view",skiplbl:"Skip",submitlbl:"Submit",decidemsg:"Decide how you want to share your work",unanimity:"(unanimity is required)",setpublic:"Make the idea public",enablereplay:"Enable session replay",yeslbl:"Yes",nolbl:"No",accepted:"ACCEPTED",rejected:"REJECTED",post:"Post","import":"Import",draw:"Draw",invitesyou:" invites you to join the Ideafy community",invitebody:"<p style='background: whitesmoke; font-family=helvetica; font-size=24px; text-align=justify;'><b>Take advantage of this invitation! Get Ideafy now and join the fast growing online community of Ideafyers. Compete for best idea, most creative mind and many other exciting challenges. Collaborate with your friends, colleagues or family to desgin and share ground-breaking ideas or simple suggestions to make your daily life better. Give your imagination and your ideas a new life: innovate!</b><br><br>Check out <a href='http://app.ideafy.com'>Ideafy</a> now or get the app on your iPad </p><p><a href='https://itunes.apple.com/us/app/ideafy/id605681593?mt=8&uo=4' target='itunes_store'style='display:inline-block;overflow:hidden;background:url(http://linkmaker.itunes.apple.com/htmlResources/assets/images/web/linkmaker/badge_appstore-lrg.png) no-repeat;width:135px;height:40px;@media only screen{background-image:url(http://linkmaker.itunes.apple.com/htmlResources/assets/images/web/linkmaker/badge_appstore-lrg.svg);}'></p>",joinedideafy:" has joined Ideafy",referral:"You earned 200 Ideafy Points for referring this person. You can now add him/her to your contacts.",invitationsent:"Your invitation has been sent",alreadyinvited:"You already invited this person",cardeditor:"Card editor",createnew:"Add a new card",importcard:"Import ...",orlbl:"or",cardtitle:"Choose a title",picturecredit:"Picture origin",enterdyknow:"Add explanations, facts and figures",dyknowsources:"Provide sources if applicable",age:"Age",countrystate:"Country or state",desc:"Description",titlerequired:"A title is required",addcomment:"Additional information",setdeck:"Set brainstorming deck",setdecklogo:"Select an icon",importfrom:"Select deck to import from",remsel:"Remove selection<br><<<",impsel:"Import selection<br>>>>",seldeck:"Selected deck",workdeck:"Working deck",selall:"Select all",clearsel:"Clear selection",delcardwarning:"Removing the following cards from your deck will delete them from the database :<br>",deldeckwarning:"Deleting this deck will definitively remove it from your library. If you are its author, it will also be removed from the database as well as any card you created that is only attached to this deck. Are you sure you want to proceed ?",cannotdelactivedeck:"You cannot remove your active deck.  Please review your settings.",cannotremovecard:"You cannot remove this card from your active deck.  An active deck requires at leat one character card, one context card, one problem card and three technology cards.",alreadyshared:"This has already been shared with intended recipients",addedfav:"This idea has been added to your favorites",removedfav:"This idea has been removed from your favorites",maxfavsize:"Your list of favorites has reached the maximum size. Remove some ideas before trying to add this one.",noideafound:"No idea found",tryotherview:"Change view, modify language filters or add ideas to your favorites. To leave the search view, erase the content of the search field and press the return key.",solution:"Solution",principle:"Principle",defaultlangfilter:"Default language filter : ",pwdchange:"Ideafy password change",pwdchangebody:"You successfully changed your Ideafy password to : ",pwdupdate:"Password change",forgotpwd:"Forgot your password ?",temppwd:"A temporary password has been sent to ",failedpwdreset:"A temporary password has already been sent to you. Check your mailbox or contact ",alegend:"Add attachments",attachments:"Attachments",filelbl:"File",imagelbl:"Image",drawinglbl:"Drawing",choosecat:"Choose category",bus:"Business model",mkt:"Marketing",notes:"Notes",arch:"Architecture",spec:"Specifications",planning:"Planning",other:"Other",noaname:"Missing attachment name",noacat:"Missing attachment category",contrib:"Contributed by: ",rateit:"Rate it!",deleteattachment:"Are you sure you want to delete this attachment ?",attachdescplaceholder:"Enter a description of your attachment",EULArejected:"You must accept the license agreement prior to using the application"},lang:"en-us",userLanguages:[{name:"en"},{name:"zh"},{name:"es"},{name:"ja"},{name:"pt"},{name:"de"},{name:"ar"},{name:"fr"},{name:"ru"}],labels:new Store({})});
module.exports=_config},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"../libs/socket.io.min":142}],246:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Map=require("./map"),Config=require("./config");var _labels=Config.get("labels"),_widget=new Widget,_content=new Store({question:""}),_callback,_class;_widget.seam.addAll({label:new Model(_labels),confirm:new Model(_content),confirmevent:new Event(_widget)});_widget.template='<div  id="confirm-popup" class = "confirm invisible"><div class="help-doctor"></div><p class="confirm-question" data-confirm="bind:innerHTML,question"></p><div class="option left" data-confirmevent="listen:mousedown, press; listen:mouseup, ok" data-label="bind: innerHTML, continuelbl">Continue</div><div class="option right" data-confirmevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl">Cancel</div></div>';_widget.press=function(event,node){node.classList.add("pressed");event.stopPropagation()};_widget.ok=function(event,node){node.classList.remove("pressed");document.getElementById("cache").classList.remove("appear");_callback&&_callback(true)};_widget.cancel=function(event,node){node&&node.classList.remove("pressed");document.getElementById("cache").classList.remove("appear");_callback&&_callback(false)};_widget.hide=function hide(){document.getElementById("cache").classList.remove("appear");_widget.dom.classList.add("invisible")};_widget.show=function show($class){if($class&&!_widget.dom.classList.contains($class)){_class&&_widget.dom.classList.remove(_class);_class=$class;_widget.dom.classList.add($class)}document.getElementById("cache").classList.add("appear");_widget.dom.classList.remove("invisible")};_widget.reset=function reset($question,$callback,$class){_class&&_widget.dom.classList.remove(_class);_content.set("question",$question);_callback=$callback;_class=$class;_class&&_widget.dom.classList.add(_class)};module.exports=_widget},{"../libs/emily":97,"../libs/olives":141,"./config":245,"./map":249}],247:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("./config"),Utils=require("./utils");function DateWidgetConstructor(){var _labels=Config.get("labels"),date=new Store({day:"",month:"",year:""});this.seam.addAll({label:new Model(_labels),model:new Model(date,{setYear:function(y){var res="",current=(new Date).getFullYear(),node=this;if(!node.firstChild){for(i=0;i<10;i++){res+="<option>"+(current+i)+"</option>"}this.innerHTML=res}if(y)this.selectedIndex=y-current},setMonth:function(m){var res="",months=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],node=this;if(!node.firstChild){months.forEach(function(month){res+="<option>"+_labels.get(month)+"</option>"});this.innerHTML=res}if(m){this.selectedIndex=m}},setDays:function(m){var length,res="";if(m===1){date.get("year")%4===0?length=29:length=28}else{[3,5,8,10].indexOf(m)>-1?length=30:length=31}for(i=0;i<length;i++){i<9?res+="<option>0"+(i+1)+"</option>":res+="<option>"+(i+1)+"</option>"}this.innerHTML=res;if(date.get("day")&&date.get("day")<=length)this.selectedIndex=date.get("day")-1;else this.selectedIndex=0},setDay:function(d){if(d)this.selectedIndex=d-1}}),event:new Event(this)});this.template='<div class = "dateui"><div class="dateicon"></div><select name="day" data-model="bind:setDays, month; bind:setDay, day" data-event="listen: change, setDay"></select><select name="month" data-model="bind:setMonth, month" data-event="listen: change, setMonth"></select><select name="year" data-model="bind:setYear, year" data-event="listen: change, setYear"></select></div>';this.getDate=function(){return[date.get("year"),date.get("month")+1,date.get("day")]};this.getDatestamp=function(){var d;d=date.get("year")+"/"+(parseInt(date.get("month"),10)+1)+"/"+date.get("day");return new Date(d).getTime()};this.setDate=function(y,m,d){var now=new Date,_year=y||now.getFullYear(),_month=m||now.getMonth(),_day=d||now.getDate();date.set("year",_year);date.set("month",_month);date.set("day",_day)};this.setDay=function(event,node){date.set("day",parseInt(node.value))};this.setMonth=function(event,node){date.set("month",node.selectedIndex)};this.setYear=function(event,node){date.set("year",parseInt(node.value))};this.reset=function(y,m,d){var _y=y||null,_m=m||null;_d=d||null;_widget.setDate(_y,_m,_d)};this.render();this.reset()}module.exports=function DateWidgetFactory(){DateWidgetConstructor.prototype=new Widget;return new DateWidgetConstructor}},{"../libs/emily":97,"../libs/olives":141,"./config":245,"./utils":256}],248:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("./config");var _widget=new Widget,_labels=Config.get("labels"),_content=new Store({html:""});_widget.seam.addAll({help:new Model(_content),helpevent:new Event(_widget)});_widget.template='<div id="help-popup"><div class="help-doctor"></div><div class="close-help" data-helpevent="listen:mousedown, closeHelp"></div><div class="help-screen" data-help="bind:innerHTML,html"></div></div>';_widget.setContent=function setContent(label){_content.set("html",_labels.get(label))};_widget.closeHelp=function(event,node){_widget.dom.classList.remove("appear");document.getElementById("cache").classList.remove("appear")};module.exports=_widget},{"../libs/emily":97,"../libs/olives":141,"./config":245}],249:[function(require,module,exports){var emily=require("../libs/emily"),Store=emily.Store;var Map=new Store({body:document.body,login:document.getElementById("login"),"login-form":document.getElementById("login-form"),"signup-form":document.getElementById("signup-form"),loading:document.getElementById("loading"),serverdown:document.getElementById("serverdown"),nointernet:document.getElementById("nointernet"),dock:document.getElementById("wrapper"),notify:document.getElementById("notify"),"notify-popup":document.getElementById("notify-popup"),"newidea-popup":document.getElementById("newidea-popup"),"attachment-popup":document.getElementById("attachment-popup"),"new2q-popup":document.getElementById("new2q-popup"),"new2c-popup":document.getElementById("new2c-popup"),"help-popup":document.getElementById("help-popup"),"tip-popup":document.getElementById("tip-popup"),"confirm-popup":document.getElementById("confirm-popup"),"public":document.getElementById("public"),"public-menu":document.getElementById("public-menu"),"public-detail":document.getElementById("public-detail"),"public-writetwocents":document.getElementById("public-writetwocents"),"public-twocents":document.getElementById("public-twocents"),"public-edit":document.querySelector("#public-detail .idea-edit"),"public-sendmail":document.querySelector("#public-detail .idea-sendmail"),"public-share":document.querySelector("#public-detail .idea-share"),brainstorm:document.getElementById("brainstorm"),"brainstorm-menu":document.getElementById("brainstorm-menu"),"ideafy-menu":document.getElementById("ideafy-menu"),"ideafy-quick":document.getElementById("ideafy-quick"),"ideafy-multi":document.getElementById("ideafy-multi"),quickstart:document.getElementById("quickstart"),mustart:document.getElementById("mustart"),quicksetup:document.getElementById("quicksetup"),quickscenario:document.getElementById("quickscenario"),"scenario-whiteboard":document.getElementById("scenario-whiteboard"),quicktech:document.getElementById("quicktech"),quickidea:document.getElementById("quickidea"),quickwrapup:document.getElementById("quickwrapup"),library:document.getElementById("library"),"library-menu":document.getElementById("library-menu"),ideas:document.getElementById("ideas"),"ideas-detail":document.getElementById("ideas-detail"),"library-idea":document.querySelector("library-idea"),"library-writetwocents":document.getElementById("library-writetwocents"),"library-twocents":document.getElementById("library-twocents"),"library-edit":document.querySelector("#ideas-detail .idea-edit"),"library-sendmail":document.querySelector("#ideas-detail .idea-sendmail"),"library-share":document.querySelector("#ideas-detail .idea-share"),sessions:document.getElementById("sessions"),decks:document.getElementById("decks"),decklist:document.getElementById("decklist"),deckview:document.getElementById("deckview"),connect:document.getElementById("connect"),"connect-menu":document.getElementById("connect-menu"),"connect-messages":document.getElementById("connect-messages"),msgdetail:document.getElementById("msgdetail"),"connect-contacts":document.getElementById("connect-contacts"),contactdetails:document.getElementById("contactdetails"),"connect-twocents":document.getElementById("connect-twocents"),dashboard:document.getElementById("dashboard"),"dashboard-menu":document.getElementById("dashboard-menu"),"dashboard-profile":document.getElementById("dashboard-profile"),leaderboard:document.getElementById("leaderboard"),"dashboard-settings":document.getElementById("dashboard-settings"),"dashboard-about":document.getElementById("dashboard-about")});module.exports=Map},{"../libs/emily":97}],250:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("./config"),Map=require("./map");var _widget=new Widget,_dest=new Store({userid:"",username:""}),_user=Config.get("user"),_store=new Store,_labels=Config.get("labels"),_transport=Config.get("transport"),contact,upload=false,_error=new Store({error:""});_widget.seam.addAll({new2c:new Model(_store),dest:new Model(_dest,{setHeader:function(username){this.innerHTML=_labels.get("sendtcprefix")+username+_labels.get("sendtcsuffix")}}),labels:new Model(_labels),errormsg:new Model(_error),new2cevent:new Event(_widget)});_widget.template='<div id="new2c-popup"><div class = "header blue-dark"><span data-dest="bind: setHeader, username"></span><div class="close-popup" data-new2cevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, twocentplaceholder" data-new2c="bind: value, message"></textarea></p><div><span class="errormsg" data-errormsg="bind:innerHTML, error"></span><div class="sendmail" data-new2cevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, sendlbl"></div></div></form></div>';_widget.render();_widget.press=function(event,node){node.classList.add("pressed")};_widget.closePopup=function closePopup(){_widget.dom.classList.remove("appear");document.getElementById("cache").classList.remove("appear");_store.reset();_dest.reset();_error.reset({error:""})};_widget.reset=function reset($contact){contact=$contact;_widget.dom.classList.add("appear");document.getElementById("cache").classList.add("appear");_dest.set("userid",contact.userid);_dest.set("username",contact.username);_store.reset({author:_user.get("_id"),message:"",firstname:_user.get("firstname"),username:_user.get("username"),date:[],datemod:"",plusones:0,replies:[]});upload=false};_widget.cancel=function(event,node){_widget.closePopup()};_widget.upload=function(event,node){var now=new Date,json={},timer;if(!_store.get("message")){_error.set("error",_labels.get("nomessage"));node.classList.remove("pressed")}else{upload=true;timer=setInterval(function(){if(_error.get("error")===_labels.get("sendinginprogress")){_error.set("error",_labels.get("sendinginprogress")+" ...")}else _error.set("error",_labels.get("sendinginprogress"))},150);_store.set("date",[now.getFullYear(),now.getMonth(),now.getDate()]);json.tc=JSON.parse(_store.toJSON());json.userid=_dest.get("userid");json.username=_dest.get("username");_transport.request("SendTwocent",json,function(result){var contact_tc=contact.twocents||[],i,connections=_user.get("connections").concat();if(result==="ok"){contact_tc.unshift(json.tc);contact.twocents=contact_tc;for(i=connections.length-1;i>=0;i--){if(connections[i].type==="user"&&connections[i].userid===contact.userid){connections.splice(i,1,contact)}}_user.set("connections",connections);_user.upload().then(function(){clearInterval(timer);node.classList.remove("pressed");_widget.closePopup()})}else{_error.set("error","something went wrong - try again later");clearInterval(timer);node.classList.remove("pressed")}})}};module.exports=_widget},{"../libs/emily":97,"../libs/olives":141,"./config":245,"./map":249}],251:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Spinner=require("../libs/spin.min"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Promise=emily.Promise,Store=CouchDBTools.CouchDBDocument,Config=require("./config"),Map=require("./map");var _widget=new Widget,_store=new Store(Config.get("TQTemplate")),_languages=new Store(Config.get("userLanguages")),_user=Config.get("user"),_resetLang=function(){_store.set("lang",_user.get("lang"));_languages.loop(function(v,i){v.name===_user.get("lang").substring(0,2)?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_labels=Config.get("labels"),_maxLength=140,_error=new Store({error:""}),spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();_store.setTransport(Config.get("transport"));_user.watchValue("lang",function(){_resetLang()});_widget.seam.addAll({new2q:new Model(_store,{displayLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")},setLength:function(type){if(type===10)this.setAttribute("maxlength",_maxLength)}}),select:new Model(_languages,{setBg:function(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new Model(_labels),errormsg:new Model(_error,{setError:function(error){switch(error){case"noquestion":this.innerHTML=_labels.get("noquestion");break;case"lengthexceeded":this.innerHTML=_labels.get("lengthexceeded")+" ("+_maxLength+_labels.get("characters")+")";break;default:this.innerHTML=error}}}),new2qevent:new Event(_widget)});_widget.template='<div id="new2q-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-new2q="bind: displayLang, lang" data-new2qevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-new2qevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>';_widget.showLang=function(event,node){event.stopPropagation();event.preventDefault();_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");_store.set("lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.press=function(event,node){node.classList.add("pressed");_widget.dom.querySelector(".description").blur()};_widget.reset=function(){document.getElementById("cache").classList.add("appear");_store.unsync();_store.reset(Config.get("TQTemplate"));_resetLang();_error.reset({error:""});_widget.dom.querySelector(".idealang ul").classList.add("invisible");_widget.dom.classList.add("appear")};_widget.closePopup=function closePopup(){document.getElementById("new2q-popup").classList.remove("appear");document.getElementById("cache").classList.remove("appear")};_widget.cancel=function(event,node){_widget.closePopup()};_widget.upload=function(event,node){var now=new Date,timer,id="Q:"+now.getTime();node.classList.remove("pressed");if(!_store.get("question")){_error.set("error","noquestion")}if(!_error.get("error")&&!_store.get("_id")){node.classList.add("invisible");spinner.spin(node.parentNode);timer=setInterval(function(){if(_error.get("error")===_labels.get("uploadinprogress")){_error.set("error",_labels.get("uploadinprogress")+"...")}else{_error.set("error",_labels.get("uploadinprogress"))}},150);_store.set("author",_user.get("_id"));_store.set("username",_user.get("username"));_store.set("creation_date",[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()]);_store.set("lang",_user.get("lang"));_store.sync(Config.get("db"),id).then(function(){return _store.upload()}).then(function(){Config.get("transport").request("UpdateUIP",{userid:_user.get("_id"),type:_store.get("type"),docId:id,question:_store.get("question")},function(result){var i,contacts=_user.get("connections"),l=contacts.length,dest=[],json={type:"2Q+",docId:id,status:"unread",date:[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()],author:_user.get("_id"),username:_user.get("username"),firstname:_user.get("firstname"),toList:"",ccList:"",object:_user.get("username")+_labels.get("askednew"),body:_store.get("question"),signature:""};if(result!=="ok"){console.log(result)}clearInterval(timer);timer=setInterval(function(){if(_error.get("error")===_labels.get("notifyingcontacts")){_error.set("error",_labels.get("notifyingcontacts")+"...")}else _error.set("error",_labels.get("notifyingcontacts"))},150);for(i=0;i<l;i++){if(contacts[i].type==="user"){dest.push(contacts[i].userid)}}json.dest=dest;Config.get("transport").request("Notify",json,function(result){console.log(result)});spinner.stop();node.classList.remove("invisible");_widget.closePopup()})})}};_widget.checkLength=function(event,node){node.value.length>=_maxLength?_error.set("error","lengthexceeded"):_error.set("error","")};module.exports=_widget},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"../libs/spin.min":143,"./config":245,"./map":249}],252:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Spinner=require("../libs/spin.min"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Place=olives["Place.plugin"],Promise=emily.Promise,Store=CouchDBTools.CouchDBDocument,Config=require("./config"),Map=require("./map"),Utils=require("./utils"),AddAttachment=require("../packages/attach/add");var _widget=new Widget,_addAttachmentUI=new AddAttachment,_transport=Config.get("transport"),_languages=new Store(Config.get("userLanguages")),_user=Config.get("user"),_observer=Config.get("observer"),_store=new Store(Config.get("ideaTemplate")),_alist=new Store([]),_resetLang=function(){var l=_user.get("lang").substring(0,2);_store.set("lang",l);_languages.loop(function(v,i){v.name===l?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})},_labels=Config.get("labels"),_error=new Store({error:""}),spinner=new Spinner({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();_store.setTransport(_transport);_user.watchValue("lang",function(){_resetLang()});_widget.seam.addAll({newidea:new Model(_store,{displayLang:function(lang){var l=lang.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+l+".png');")},setVisibility:function(visibility){if(visibility==="public"){this.innerHTML=_labels.get("publicidealbl");this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")}else{this.innerHTML=_labels.get("privateidealbl");this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;")}},setWarning:function(visibility){visibility==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new Model(_alist,{setType:function(type){var node=this;switch(type){case"pic":break;case"drawing":break;default:node.setAttribute("style","background-image:url('img/brainstorm/importDisable100.png');");break}},setBg:function(cat){var colors=Config.get("catColors"),node=this;node.setAttribute("style","background-color: transparent;");Config.get("cat").forEach(function(val,idx){if(val===cat)node.setAttribute("style","background-color:"+colors[idx])})}}),select:new Model(_languages,{setBg:function(name){this.setAttribute("style","background-image:url('img/flags/"+name+".png');")},setSelected:function(selected){selected?this.classList.add("selected"):this.classList.remove("selected")}}),place:new Place({AddAttachment:_addAttachmentUI}),labels:new Model(_labels),errormsg:new Model(_error,{setError:function(error){switch(error){case"notitle":this.innerHTML=_labels.get("titlefield")+_labels.get("emptyfielderror");break;case"nodesc":this.innerHTML=_labels.get("descriptionfield")+_labels.get("emptyfielderror");break;case"nosol":this.innerHTML=_labels.get("solutionfield")+_labels.get("emptyfielderror");break;case"noaname":this.innerHTML=_labels.get("noaname");break;case"noacat":this.innerHTML=_labels.get("noacat");break;default:this.innerHTML=error}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new Event(_widget)});_widget.template='<div id="newidea-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newidea="bind: displayLang, lang" data-newideaevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newideaevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><legend class="a-legend" data-labels="bind:innerHTML, alegend"></legend><div data-place="place:AddAttachment"></div><ul class="a-list" data-alist="foreach" style="display:none"><li data-alist="bind:setBg, category"><label class="a-type" data-alist="bind:setType, type"></label><label class="a-name" data-alist="bind:innerHTML, name"></label><div class="a-del" data-newideaevent="listen:mousedown, removeAttachment"></div></li></ul><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-newidea="bind: setWarning, visibility"><div data-labels="bind: innerHTML, publicwarning"></div><div class="close-warning" data-newideaevent="listen:mousedown, closeWarning"></div></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>';_widget.reset=function(){document.getElementById("cache").classList.add("appear");_store.reset({title:"",sessionId:"",sessionReplay:false,authors:[],description:"",solution:"",creation_date:[],character:"",problem:"",lang:"en-us",context:"",techno:[],type:6,sharedwith:[],modification_date:[],inspired_by:"",visibility:"",votes:[],rating:"",authornames:"",twocents:[],attachments:[]});_resetLang();_error.reset({error:""});_alist.reset([]);_widget.resetAttachment();_store.set("visibility","private");_widget.dom.querySelector(".visibility-slider").value=1;_widget.dom.querySelector(".idealang ul").classList.add("invisible");_widget.dom.classList.add("appear")};_widget.showLang=function(event,node){event.stopPropagation();event.preventDefault();_widget.dom.querySelector(".idealang ul").classList.remove("invisible")};_widget.selectFlag=function(event,node){var id;event.stopPropagation();event.preventDefault();id=parseInt(node.getAttribute("data-select_id"),10);_languages.loop(function(v,i){id===i?_languages.update(i,"selected",true):_languages.update(i,"selected",false)})};_widget.setLang=function(event,node){var id;event.stopPropagation();id=node.getAttribute("data-select_id");_store.set("lang",_languages.get(id).name);_widget.dom.querySelector(".idealang ul").classList.add("invisible")};_widget.resetAttachment=function(){_addAttachmentUI.reset("new","idea",_alist)};_widget.removeAttachment=function(event,node){var idx=parseInt(node.getAttribute("data-alist_id"),10),docId=_alist.get(idx).docId;_alist.alter("splice",idx,1);Utils.deleteAttachmentDoc(docId)};_widget.toggleVisibility=function(event,node){if(node.value==="1"){_store.set("visibility","private")}else{_store.set("visibility","public")}};_widget.closeWarning=function(event,node){node.parentNode.classList.add("invisible")};_widget.press=function(event,node){node.classList.add("pressed");_widget.dom.querySelector(".publicwarning").classList.add("invisible")};_widget.release=function(event,node){node.classList.remove("pressed")};_widget.clearAttachments=function(){if(_addAttachmentUI.getFileName())Utils.deleteAttachmentFile(_addAttachmentUI.getFileName());if(_alist.count()){_alist.loop(function(v,i){Utils.deleteAttachmentDoc(v.docId).then(function(){return true})})}_addAttachmentUI.reset()};_widget.closePopup=function closePopup(){_widget.dom.classList.remove("appear");document.getElementById("cache").classList.remove("appear");if(_addAttachmentUI.getFileName())Utils.deleteAttachmentFile(_store.get("_id"),_addAttachmentUI.getFileName());_widget.resetAttachment();_addAttachmentUI.abortReq();_store.unsync()};_widget.resetError=function(event,node){var name;node.scrollTop=99999;if(_error.get("error")){if(node.classList.contains("description")){name="nodesc"}else if(node.classList.contains("solution")){name="nosol"}else{name="notitle"}if(_error.get("error")===name&&node.value){_error.set("error","")}}};_widget.cancel=function(event,node){if(_alist.count())_widget.clearAttachments();_widget.closePopup()};_widget.upload=function(event,node){var now=new Date,id=_addAttachmentUI.getDocId()||"I:"+now.getTime(),timer;node.classList.remove("pressed");if(!_store.get("title")){_error.set("error","notitle")}else if(!_store.get("description")){_error.set("error","nodesc")}else if(!_store.get("solution")){_error.set("error","nosol")}if(!_error.get("error")){node.classList.add("invisible");spinner.spin(node.parentNode);timer=setInterval(function(){if(_error.get("error")===_labels.get("uploadinprogress")){_error.set("error",_labels.get("uploadinprogress")+"...")}else _error.set("error",_labels.get("uploadinprogress"))},100);_store.set("authors",[_user.get("_id")]);_store.set("authornames",_user.get("username"));_store.set("creation_date",[now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds()]);if(_alist.count()){_alist.loop(function(v,i){att.push(v)});att.sort(function(x,y){if(x.category>y.category)return 1;else if(x.category<y.category)return-1;else{if(x.name>y.name)return 1;else return-1}});_store.set("attachments",att)}_store.sync(Config.get("db"),id).then(function(){return _store.upload()}).then(function(){if(_store.get("visibility")==="public"){_observer.notify("NewIdea",id,"public");_transport.request("UpdateUIP",{userid:_user.get("_id"),type:_store.get("type"),docId:id,docTitle:_store.get("title")},function(result){if(result!=="ok")console.log(result);spinner.stop();node.classList.remove("invisible");_widget.closePopup();clearInterval(timer)})}else{_observer.notify("NewIdea",id);spinner.stop();node.classList.remove("invisible");_widget.closePopup();clearInterval(timer)}})}};["added","updated","deleted"].forEach(function(val){_alist.watch(val,function(){var node=_widget.dom.querySelector(".a-list");_alist.count()?node.setAttribute("style","display:block;"):node.setAttribute("style","display:none;")})});module.exports=_widget},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"../libs/spin.min":143,"../packages/attach/add":145,"./config":245,"./map":249,"./utils":256}],253:[function(require,module,exports){var olives=require("../libs/olives"),amy=require("../libs/amy2"),Widget=olives.OObject,Model=olives["Bind.plugin"],Control=amy.ControlPlugin,Config=require("./config");function SubMenuConstructor($dom,$setWidget){var _active=false,publicTemplate,libraryTemplate,brainstormTemplate,connectTemplate,dashboardTemplate,_ctrl=new Control(this),toggleActiveState=function(state){state?$dom.setAttribute("style","display : block;"):$dom.setAttribute("style","display : none;");_active=state};publicTemplate="<div></div>";libraryTemplate='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#ideas" data-menucontrol="init"><a class="library-item" href="#ideas" data-label="bind:innerHTML, library-ideas"></a></li><li class="menu-item" name="#sessions"><a class="library-item" href="#sessions" data-label="bind:innerHTML, library-sessions"></a></li><li class="menu-item" name="#decks"><a class="library-item" href="#decks" data-label="bind:innerHTML, library-decks"></a></li></ul></div>';brainstormTemplate="<div></div>";connectTemplate='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" data-menucontrol="init" name="#messages"><a class="connect-item" href="#connect-messages" data-label="bind:innerHTML, connect-messages"></a></li><li class="menu-item" name="#contacts"><a class="connect-item" href="#connect-contacts" data-label="bind:innerHTML, connect-contacts"></a></li><li class="menu-item" name="#twocents"><a class="connect-item" href="#connect-twocents" data-label="bind:innerHTML, connect-twocents"></a></li></ul></div>';dashboardTemplate='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#profile" data-menucontrol="init"><a class="dashboard-item" href="#dashboard-profile" data-label="bind:innerHTML, dashboard-profile"></a></li><li class="menu-item" name="#settings"><a class="dashboard-item" href="#dashboard-settings" data-label="bind:innerHTML, dashboard-settings">Settings</a></li><li class="menu-item" name="#about"><a class="dashboard-item" href="#dashboard-about" data-label="bind:innerHTML, dashboard-about">About Ideafy</a></li></ul></div>';
if($dom.id.search("public")>-1){this.template=publicTemplate}if($dom.id.search("library")>-1){this.template=libraryTemplate}if($dom.id.search("brainstorm")>-1){this.template=brainstormTemplate}if($dom.id.search("connect")>-1){this.template=connectTemplate}if($dom.id.search("dashboard")>-1){this.template=dashboardTemplate}this.seam.addAll({label:new Model(Config.get("labels")),menucontrol:_ctrl});this.getState=function getState(){return _active};this.toggleActive=function(state){toggleActiveState(state)};this.setCurrentWidget=function setCurrentWidget(event){var ui=event.target.getAttribute("name");if($setWidget){$setWidget(ui)}setTimeout(function(){toggleActiveState(false)},200)};this.setWidget=function setWidget(name){var node=this.dom.querySelector('li[name="'+name+'"]');$setWidget(name);node.parentNode.querySelector(".selected").classList.remove("selected");node.classList.add("selected");_ctrl.init(this.dom.querySelector('li[name="'+name+'"]'))};this.reset=function reset(){var parent=this.dom.querySelector(".menu-list");if(parent){parent.querySelector(".selected").classList.remove("selected");parent.firstChild.classList.add("selected");_ctrl.init(parent.firstChild)}};this.render();this.place($dom)}module.exports=function SubMenuFactory($dom,$setWidget){SubMenuConstructor.prototype=new Widget;return new SubMenuConstructor($dom,$setWidget)}},{"../libs/amy2":75,"../libs/olives":141,"./config":245}],254:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Store=emily.Store,Config=require("./config"),Utils=require("./utils");function TimeWidgetConstructor(){var _widget=this,_labels=Config.get("labels"),user=Config.get("user"),time=new Store({hour:0,min:0,am:true});_widget.seam.addAll({label:new Model(_labels),model:new Model(time,{setAMPM:function(am){am?this.selectedIndex=0:this.selectedIndex=1}}),user:new Model(user,{displayAMPM:function(lang){switch(lang){case"fr-fr":this.classList.add("invisible");break;default:this.classList.remove("invisible")}}}),event:new Event(this)});_widget.template='<div class = "timeui"><div class="timeicon"></div><input type="number" maxlength="2" max="23" name="hour" data-model="bind:value, hour" data-event="listen:blur, format"><span>:</span><input type="number" maxlength="2" max="59" name="min" data-model="bind:value, min" data-event="listen:blur, format"></select><select name="am" class="invisible" data-model="bind:setAMPM, am" data-user="bind:displayAMPM, lang" data-event="listen: change, setAMPM"><option>AM</option><option>PM</option></select></div>';_widget.getTime=function(){var h,m=time.get("min");time.get("am")?h=time.get("hour"):h=parseInt(time.get("hour"))+12;return[h,m,0]};_widget.format=function(event,node){var n=node.value,field=node.getAttribute("name");if(isNaN(n))time.set(field,"00");else if(n<10&&n.length<2)node.value="0"+n;if(field==="hour"&&n>23)time.set(field,"00");if(field==="min"&&n>59)time.set(field,"00")};_widget.setAMPM=function(event,node){node.selectedIndex===1?time.set("am",false):time.set("am",true)};_widget.getTimestamp=function(){var h,m=parseInt(time.get("min"),10)||0;time.get("am")?h=parseInt(time.get("hour"),10):h=parseInt(time.get("hour"),10)+12;return(3600*h+60*m)*1e3};_widget.setTime=function(h,m,am){var now=new Date,lang=user.get("lang"),_hour=h||now.getHours(),_min=m||now.getMinutes(),_am=am;_min<10?time.set("min","0"+_min):time.set("min",_min);_hour>11?time.set("am",false):time.set("am",true);switch(lang){case"fr-fr":time.set("hour",_hour);break;default:_hour<12?time.set("hour",_hour):time.set("hour",_hour%12);break}};_widget.updateNow=function(event,node){if(node.checked)_widget.reset()};_widget.reset=function(){_widget.setTime()};_widget.render();_widget.reset()}module.exports=function TimeWidgetFactory(){TimeWidgetConstructor.prototype=new Widget;return new TimeWidgetConstructor}},{"../libs/emily":97,"../libs/olives":141,"./config":245,"./utils":256}],255:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Widget=olives.OObject,Model=olives["Bind.plugin"],Event=olives["Event.plugin"],Config=require("./config"),Store=emily.Store,CouchDBView=CouchDBTools.CouchDBView,Map=require("./map");var _widget=new Widget,_labels=Config.get("labels"),_cdb=new CouchDBView([]),_user=Config.get("user"),_previous=[],_allTips=new Store([]),_tip=new Store({});_cdb.setTransport(Config.get("transport"));_widget.seam.addAll({labels:new Model(_labels),tip:new Model(_tip,{setTitle:function(id){if(id==="TIP:0")this.innerHTML=_labels.get("signupwelcomeobject");else this.innerHTML=_labels.get("dyknow")}}),tipevent:new Event(_widget)});_widget.template='<div id="tip-popup"><div class="help-doctor"></div><div class="close-tip" data-tipevent="listen:mousedown, close"></div><div class="tip-screen"><legend data-tip="bind:setTitle, id"></legend><p data-tip = "bind: innerHTML, body"></p><div class="next-button" data-labels = "bind: innerHTML, nextbutton" data-tipevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="tip-footer"><input type="checkbox" data-tipevent="listen: change, doNotShow"><label data-labels="bind: innerHTML, notips"></label></div></div>';_widget.init=function init(firstStart){_cdb.sync(Config.get("db"),"about","_view/tip").then(function(){var lang=_user.get("lang");_cdb.loop(function(v,i){var doc=v.value;if(doc.default_lang===lang||!doc.translations[lang]){_allTips.alter("push",{id:doc._id,title:doc.title,body:doc.body})}else{_allTips.alter("push",{id:doc._id,title:doc.translations[lang].title,body:doc.translations[lang].body})}});_cdb.unsync();if(firstStart){_tip.reset(_allTips.get(0))}else{_allTips.alter("splice",0,1);_widget.getRandomTip()}_widget.place(Map.get("tip-popup"));document.getElementById("tip-popup").classList.add("visible");document.getElementById("cache").classList.add("appear")})};_widget.getRandomTip=function getRandomTip(){var nb=_allTips.count(),id=Math.floor(Math.random()*nb);if(nb===0)_widget.close();else{_tip.reset(_allTips.get(id));_allTips.alter("splice",id,1)}};_widget.press=function(event,node){node.classList.add("pressed")};_widget.next=function(event,node){node.classList.remove("pressed");_widget.getRandomTip()};_widget.close=function(event,node){document.getElementById("tip-popup").classList.remove("visible");document.getElementById("cache").classList.remove("appear")};_widget.doNotShow=function(event,node){var settings;node.setAttribute("readonly","readonly");if(node.checked===_user.get("settings").showTips){settings=_user.get("settings");settings.showTips=!node.checked;_user.set("settings",settings);_user.upload().then(function(){node.removeAttribute("readonly")})}};module.exports=_widget},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"./config":245,"./map":249}],256:[function(require,module,exports){var olives=require("../libs/olives"),emily=require("../libs/emily"),CouchDBTools=require("../libs/CouchDBTools"),Config=require("./config"),Observable=emily.Observable,Promise=emily.Promise,LocalStore=olives.LocalStore,Transport=olives.SocketIOTransport,Store=CouchDBTools.CouchDBDocument;var _utils={},user=Config.get("user"),transport=Config.get("transport"),socket=Config.get("socket");_utils.formatDate=function(array){var month=array[1]+1;if(user.get("lang").search("en")===0){return month+"/"+array[2]+"/"+array[0]}else{if(month<10){month="0"+month}return array[2]+"/"+month+"/"+array[0]}};_utils.formatDateStamp=function(stamp){var date=new Date(stamp),array=[date.getFullYear(),date.getMonth()+1,date.getDate()];return _utils.formatDate(array)},_utils.formatDuration=function(duration){var d,days,hrs,min,sec,res;if(duration){d=Math.round(duration/1e3);days=Math.floor(d/86400);hrs=Math.floor(d%86400/3600);min=Math.floor(d%86400%3600/60);sec=Math.floor(d%86400%3600%60);days>0?res=days+"d ":res="";hrs>0?res+=hrs+":":res+="";min>0?res+=(hrs>0&&min<10?"0":"")+min+":":res+="0:";sec<10?res+="0"+sec:res+=sec}else{res=""}return res};_utils.formatTime=function(time){var date=new Date(time),hrs=date.getHours(),min=date.getMinutes(),sec=date.getSeconds(),res="";res+=hrs+":";min>0?res+=(hrs>0&&min<10?"0":"")+min+":":res+="00:";sec<10?res+="0"+sec:res+=sec;return res};_utils.computeTimeStamp=function(date,time){var now=new Date,offSet=now.getTimezoneOffset(),d=date||now.getTime(),t=time||0,stamp;stamp=d+t+offSet;return stamp};_utils.displayFirstSentence=function(elementid,desc){var sentences=[];sentences=desc.split("."[0],1);if(sentences[0].length>140){elementid.innerHTML=sentences[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")}return elementid.innerHTML};_utils.truncate=function(elementid,desc){elementid.innerHTML=desc;while(elementid.scrollHeight>elementid.offsetHeight){var text=elementid.innerHTML;elementid.innerHTML=text.replace(/\W*\s(\S)*$/,"...")}return elementid.innerHTML};_utils.setRating=function(node,rating){var img0="<img src = 'img/wall/disableIdeaVote.png'>",img05="<img src = 'img/wall/semi-activeIdeaVote.png'>",img1="<img src = 'img/wall/activeIdeaVote.png'>",res="",i;if(!rating){for(i=0;i<5;i++){res=res+img0}}else{i=0;while(i<Math.floor(rating)){res=res+img1;i++}if(i<5){Math.round(rating-Math.floor(rating))?res=res+img05:res=res+img0;i++}while(i<5){res=res+img0;i++}}node.innerHTML=res};_utils.searchArray=function(array,s){var _keywords=s.toLowerCase().split(" "),_res=[],i,j,_s,_match;for(i=0,l=array.length;i<l;i++){_s=JSON.stringify(array[i]).toLowerCase();_match=0;for(j=0;j<_keywords.length;j++){if(_s.search(_keywords[j])>-1){_match++}else{break}}if(_match===_keywords.length){_res.push(array[i])}}return _res};_utils.sortByProperty=function(array,prop,descending){switch(prop){case"idea":array.sort(function(x,y){var _x=x[prop],_y=y[prop],a,b;if(descending){if(!_x||!(_x instanceof Array)||!_x.length){a=""}else{_utils.sortByProperty(_x,"title",true);a=_x[0].title}if(!_y||!(_y instanceof Array)||!_y.length){b=""}else{_utils.sortByProperty(_y,"title",true);b=_y[0].title}if(a<b){return 1}if(a>b){return-1}return 0}else{if(!_x||!(_x instanceof Array)||!_x.length){a=""}else{_utils.sortByProperty(_x,"title",false);a=_x[0].title}if(!_y||!(_y instanceof Array)||!_y.length){b=""}else{_utils.sortByProperty(_y,"title",false);b=_y[0].title}if(a<b){return-1}if(a>b){return 1}return 0}});break;case"date":array.sort(function(x,y){var _dx=x[prop],_dy=y[prop],d1=new Date(_dx[0],_dx[1],_dx[2]),d2=new Date(_dy[0],_dy[1],_dy[2]);if(descending){if(d1<d2){return 1}if(d1>d2){return-1}return 0}else{if(d1<d2){return-1}if(d1>d2){return 1}return 0}});break;default:array.sort(function(x,y){var _x=x[prop],_y=y[prop];if(typeof _x==="string"||typeof _y==="string"){if(_x&&_x.toLowerCase){_x=_x.toLowerCase()}if(_y&&_y.toLowerCase){_y=_y.toLowerCase()}if(descending){if(_x<_y){return 1}if(_x>_y){return-1}return 0}else{if(_x<_y){return-1}if(_x>_y){return 1}return 0}}else{if(descending){if(_x<_y){return 1}if(_x>_y){return-1}return 0}else{if(_x<_y){return-1}if(_x>_y){return 1}return 0}}});break}};_utils.uploadFile=function(url,body,progress,onEnd){var req=new XMLHttpRequest;req.open("POST",Config.get("location")+url);req.onreadystatechange=function(){if(req.readyState===4&&onEnd){onEnd(req)}};req.upload.onprogress=function(e){if(e.lengthComputable&&progress){progress.set("status",Math.round(e.loaded/e.total*100))}};if(body.type==="afile"){req.setRequestHeader("content-type",'multipart/form-data; boundary="--=====Ideafy=====--"');req.sendAsBinary(body)}else{req.send(body)}return req};_utils.checkServerStatus=function(){var promise=new Promise,req=new XMLHttpRequest;req.open("GET",Config.get("location"));req.onreadystatechange=function(){if(req.readyState===4){req.status===200?promise.fulfill():promise.reject()}};req.send();return promise};_utils.checkSocketStatus=function(){var sock=Config.get("socket"),obs=Config.get("observer");if(!sock.socket.connected){sock.socket.connect(Config.get("location"));obs.notify("reconnect","all")}else if(!user.get("online"))obs.notify("reconnect","user")};_utils.disconnectSocket=function(){Config.get("socket").socket.disconnect();Config.get("observer").notify("disconnect")};_utils.updateLabels=function(lang){var json={lang:lang},local=new LocalStore,labels=Config.get("labels"),promise=new Promise;local.sync("ideafy-data");transport.request("Lang",json,function(result){if(result==="nok"){local.set("labels",Config.get("defaultLabels"));Config.set("lang","en-us")}else{local.set("labels",result);Config.set("lang",result.language)}local.sync("ideafy-data");labels.reset(local.get("labels"));promise.fulfill()});return promise};_utils.getAvatarById=function(id){var promise=new Promise,local=new LocalStore,avatars=Config.get("avatars");if(avatars.get(id)&&avatars.get(id)!=="in progress"){promise.fulfill(avatars.get(id))}else if(avatars.get(id)==="in progress"){avatars.watchValue(id,function(val){if(val&&val!=="in progress"){promise.fulfill(val)}})}else{avatars.set(id,"in progress");transport.request("GetAvatar",{id:id},function(result){if(result.error){promise.reject()}else{if(avatars.count()<100){avatars.set(id,result)}else{var obj=avatars.toJSON(),arr=obj.keys();avatars.del(arr[0]);avatars.set(id,result)}promise.fulfill(result)}})}return promise};_utils.getAvatarByFileName=function(filename,onEnd){transport.request("GetAvatar",{file:filename},function(result){onEnd(result)})};_utils.getGrade=function(ip,onEnd){transport.request("GetGrade",{ip:ip,lang:user.get("lang")},function(res){onEnd(res)})};_utils.getAchievements=function(userid,onEnd){transport.request("GetAchievements",{userid:userid,lang:user.get("lang")},function(res){onEnd(res)})};_utils.getUserDetails=function(userid,onEnd){transport.request("GetUserDetails",{userid:userid},function(res){onEnd(res)})};_utils.getUserContactIds=function(){var res=[],contacts=user.get("connections").concat();contacts.forEach(function(contact){if(contact.type==="user"){res.push(contact.userid)}});return res};_utils.getContactUsernames=function(){var res=[],contacts=user.get("connections").concat();contacts.forEach(function(contact){if(contact.type==="user"){res.push(contact.username)}});return res};_utils.checkProfileCompletion=function(){var labels=Config.get("labels"),res={percentage:0,missing:[]};if(user.get("firstname")&&user.get("lastname")){res.percentage+=10}if(user.get("birthdate").length===3){res.percentage+=10}else{res.missing.push(labels.get("enterbirthdate"))}if(user.get("family").couple!==null&&user.get("family").children!==null){res.percentage+=10}else{res.missing.push(labels.get("enterfamily"))}if(user.get("address").city&&user.get("address").country){res.percentage+=10}else{res.missing.push(labels.get("enteraddress"))}if(user.get("intro")&&user.get("intro")!=="Ideafyer"){res.percentage+=10}else{res.missing.push(labels.get("enterintro"))}if(user.get("occupation").situation>=0&&user.get("occupation").job&&user.get("occupation").organization){res.percentage+=10}else{res.missing.push(labels.get("enteroccupation"))}if(user.get("leisure_activities")[0].name&&user.get("leisure_activities")[1].name){res.percentage+=10}else{res.missing.push(labels.get("enterleisure"))}if(user.get("interests")[0].name&&user.get("interests")[1].name){res.percentage+=10}else{res.missing.push(labels.get("enterinterest"))}if(user.get("twitter")||user.get("facebook")||user.get("gplus")||user.get("linkedin")){res.percentage+=10}else{res.missing.push(labels.get("entersocialnw"))}if(user.get("picture_file").search("img/avatars/deedee")<0){res.percentage+=10}else{res.missing.push(labels.get("enterownpic"))}return res};_utils.stringToBytes=function(str){var ch,st,re=[],i,j=0,k;for(i=0;i<str.length;i++){ch=str.charCodeAt(i);if(ch<127)re[j++]=ch&255;else{st=[];do{st.unshift(ch&255);ch=ch>>8}while(ch);for(k=0;k<st.length;k++)re[j++]=st[k]}}return re};_utils.changeStyle=function(newStyle){var styleNode=document.querySelector(".currentStyle"),currentStyle=styleNode.getAttribute("href");if(currentStyle!=="css/"+newStyle)styleNode.setAttribute("href","css/"+newStyle)};_utils.exitListener=function(id,callback){var listener=function(e){var element;for(element=e.target;element;element=element.parentNode){if(element.id&&element.id===id){return}}if(e.target.classList.contains("deedee")||e.target.classList.contains("notify-header")||e.target.classList.contains("exit-brainstorm")||e.target.classList.contains("dock-item")){e.stopPropagation();callback(e.target)}};document.addEventListener("mousedown",listener,true);return listener};_utils.deleteAttachmentFile=function(docId,fileName){var json={},promise=new Promise;if(docId.search("I:")===0)json.type="idea";json.docId=docId;json.file=fileName;transport.request("DeleteAttachment",json,function(res){res==="ok"?promise.fulfill():promise.reject()});return promise};_utils.deleteAttachmentDoc=function(docId){var promise=new Promise,cdb=new Store;cdb.setTransport(transport);cdb.sync(Config.get("db"),docId).then(function(){var type="",id=cdb.get("docId");if(id.search("I:")===0)type="idea";return _utils.deleteAttachmentFile(type,id,cdb.get("fileName"))}).then(function(){return cdb.remove()}).then(function(){promise.fulfill()});return promise};module.exports=_utils},{"../libs/CouchDBTools":72,"../libs/emily":97,"../libs/olives":141,"./config":245}],257:[function(require,module,exports){var util=require("util/");var pSlice=Array.prototype.slice;var hasOwn=Object.prototype.hasOwnProperty;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;if(options.message){this.message=options.message;this.generatedMessage=false}else{this.message=getMessage(this);this.generatedMessage=true}var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace){Error.captureStackTrace(this,stackStartFunction)}else{var err=new Error;if(err.stack){var out=err.stack;var fn_name=stackStartFunction.name;var idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&(isNaN(value)||!isFinite(value))){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}try{var ka=objectKeys(a),kb=objectKeys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if(hasOwn.call(obj,key))keys.push(key)}return keys}},{"util/":259}],258:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],259:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":258,_process:261,inherits:260}],260:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;
ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],261:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}]},{},[144]);