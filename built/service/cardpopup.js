/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,i,n,s){function a(e){var a,r=new s,o=n.get("labels"),c='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatName, firstname"></span><div class="close-popup" data-popupevent="listen:touchstart, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><ul><li><span class="cd-agelbl"></span><span data-carddetails="bind:innerHTML, age"></span><span class="agesuffix" data-label="bind:innerHTML, agelbl"></span></li><li><span class="cd-locationlbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, location"></span></li><li><span class="cd-joblbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, occupation.description"></span></li><li><span class="cd-familylbl"></span><span class="cd-info" data-carddetails="bind: setFamily, family"></span></li><li><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit"></span></li></ul></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl">Hobbies</span><p class = "charinfo" data-carddetails="bind:setLeisure, leisure_activities">hobbies</p><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "charinfo" data-carddetails="bind: setInterests, interests">Centers of interest</p><span class="contentTitle" data-label="bind: innerHTML, commentslbl">Comments</span><p class = "charinfo" data-carddetails="bind:setComments, comments"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',l='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatTitle, title"></span><div class="close-popup" data-popupevent="listen:touchstart, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><p><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit">Picture credits</span><br/><span class="cd-sourcelbl" data-label="bind:innerHTML, source">Source : </span><span class="cd-info" data-carddetails="bind: setSources, sources"></span></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><p class = "dyknow" data-carddetails="bind:innerHTML,didYouKnow"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',d='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark story"> <div class="storytitlelbl" data-label="bind:innerHTML, storytitlelbl"></div><div class="storytitle"><span data-label="bind:innerHTML, cdtitlelbl"></span> <span data-carddetails="bind: formatTitle, title"></span></div><div class="close-popup" data-popupevent="listen:touchstart, close"></div></div><div class="cd-contentarea story"><span class="contentTitle" data-label="bind: innerHTML, scenariodesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,story"></p><span class="contentTitle" data-label="bind: innerHTML, soldesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,solution"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>';this.plugins.addAll({label:new t(o),carddetails:new t(r,{setPosition:function(e){e&&this.setAttribute("style","left:"+e.x+"px; top:"+e.y+"px;")},setCaret:function(e){var t,i=r.get("position").y;t=i>340?240:60,e?this.setAttribute("style","display: inline-block; margin-top:"+t+"px;"):this.setAttribute("style","display: none;")},setPic:function(e){var t,i=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(t={dir:"cards",filename:e},n.get("transport").request("GetFile",t,function(e){i.setAttribute("style","background:white; background-image: url('"+e+"');")})):this.setAttribute("style","background-image: none;")},setSources:function(e){this.innerHTML=e&&e.length?e instanceof Array?e.join(", "):e:""},formatTitle:function(e){e&&(this.innerHTML=e.toUpperCase())},formatName:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase()+"  "+r.get("lastname").toUpperCase())},setFamily:function(e){var t,i,n=e.couple,s=e.children;0===n?t=o.get("singlelbl"):1===n?t=o.get("marriedlbl"):2===n?t=o.get("divorcedlbl"):3===n&&(t=o.get("widowlbl")),0===s?i="":(i=r.get("age")<20?1===s?s+o.get("onesiblinglbl"):s+o.get("siblingslbl"):1===s?s+o.get("onechildlbl"):s+o.get("childrenlbl"),i=", "+i),this.innerHTML=t+i},setLeisure:function(e){var t,i="<ul>";if(e&&e.length){for(t=0;t<e.length;t++)i+=e[t].comment?"<li>"+e[t].name+" ("+e[t].comment+")</li>":"<li>"+e[t].name+"</li>";this.innerHTML=i+"</ul>"}else this.innerHTML=""},setInterests:function(e){var t,i="<ul>";if(e&&e.length){for(t=0;t<e.length;t++)i+=e[t].comment?"<li>"+e[t].name+" ("+e[t].comment+")</li>":"<li>"+e[t].name+"</li>";this.innerHTML=i+"</ul>"}else this.innerHTML=""},setComments:function(e){var t,i="<ul>";if(e&&e.length){for(t=0;t<e.length;t++)i+="<li>"+e[t]+"</li>";this.innerHTML=i+"</ul>"}else this.innerHTML=""}}),popupevent:new i(this)}),this.close=function(){a.classList.add("invisible"),e()},this.reset=function(e,t,i,n){a=n,this.template="","string"==typeof e?r.reset(JSON.parse(e)):r.reset(e),r.set("position",t),"left"===i?r.set("caret",{left:!0,right:!1}):r.set("caret",{left:!1,right:!0}),this.template=1===r.get("type")?c:5===r.get("type")?d:l,this.render(),this.place(a),a.classList.remove("invisible")}}return function(t){return a.prototype=new e,new a(t)}});