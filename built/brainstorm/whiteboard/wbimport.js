/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","service/utils","Store","Promise","lib/spin.min"],function(e,t,i,s,n,a,r,c,o){return function(t,d){var l,u=new e,p=i.get("labels"),g=(new FileReader,new r({status:null})),v=null,h=new r({type:"import",content:""}),m=400,b=300,f=function(e){var t,i,s=document.getElementById("preview"),n=s.getContext("2d");t=e.width,i=e.height,t>i?t>m&&(i*=m/t,t=m):i>b&&(t*=b/i,i=b),s.width=t,s.height=i,n.drawImage(e,0,0,t,i)},w=function(e){var t=new c,s="/upload",n=new FormData,r="postit",o="sessions/"+l,d=document.getElementById("preview"),u=d.toDataURL("image/png"),p=new Date,v=e||i.get("user").get("_id")+"_"+p.getTime();return n.append("type",r),n.append("dir",o),n.append("filename",v),n.append("dataString",u),a.uploadFile(s,n,g,function(){h.set("content",v),t.fulfill()}),t},y=function(){var e=document.getElementById("preview"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)};return u.template='<div class="import"><ul id="importbuttons"><li><div class="importbutton choosepic" data-importevent="listen: touchstart, press; listen:touchend, picturePreview"></div><label data-labels="bind:innerHTML, importpiclbl"></label></li><li><div class="importbutton takepic" data-importevent="listen: touchstart, press; listen:touchend, cameraPreview"></div><label data-labels="bind:innerHTML, importcameralbl"></label></li></ul><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:touchstart,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: touchstart, press; listen:touchend, post"></div><div class = "delpostit" name="del" data-importevent="listen:touchstart, press;listen:touchend, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>',u.plugins.addAll({labels:new s(p),importmodel:new s(h,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(e){var t,s,n=this,a=i.get("transport");e?(s=(new o).spin(n),t={dir:"sessions/"+l,filename:e},a.request("GetFile",t,function(e){var t=new Image,i=n.getContext("2d");t.src=e,n.width=t.width,n.height=t.height,i.drawImage(t,0,0),s.stop(),u.dom.querySelector("#importbuttons").classList.remove("invisible"),u.dom.querySelector("#postpic").scrollIntoView()})):this.innerHTML=""}}),importprogress:new s(g,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),importevent:new n(u)}),u.cancel=function(e,t){t.parentNode.classList.add("invisible"),d("import")},u.check=function(e,t){t.classList.remove("pressed"),t.files.length&&u.preview("change",t)},u.cameraPreview=function(e,t){function i(e){n.src=e,setTimeout(function(){f(n),t.classList.remove("pressed"),r.classList.add("invisible"),u.dom.querySelector("#postpic").classList.remove("invisible")},750)}function s(e){alert("error: "+e),t.classList.remove("pressed")}var n=new Image,a={quality:50,correctOrientation:!0},r=document.getElementById("importbuttons");navigator.camera.getPicture(i,s,a)},u.picturePreview=function(e,t){function i(e){a.src=e,setTimeout(function(){f(a),t.classList.remove("pressed"),c.classList.add("invisible"),u.dom.querySelector("#postpic").classList.remove("invisible")},1e3)}function s(e){alert("error: "+e),t.classList.remove("pressed")}var n=navigator.camera.PictureSourceType.PHOTOLIBRARY,a=new Image,r={quality:50,correctOrientation:!0,sourceType:n},c=document.getElementById("importbuttons");navigator.camera.getPicture(i,s,r)},u.press=function(e,t){t.classList.add("pressed")},u.post=function(e,i){w(h.get("content")).then(function(){v||0===v?t.alter("splice",v,1,JSON.parse(h.toJSON())):t.alter("push",JSON.parse(h.toJSON())),i.classList.remove("pressed"),u.reset(),g.reset({status:""}),y(),document.getElementById("importbuttons").classList.remove("invisible"),d("import")})},u.reset=function(e){v=e,h.reset({type:"import",content:""}),u.dom.querySelector("#importbuttons").classList.remove("invisible"),(v||0===v)&&(u.dom.querySelector("#importbuttons").classList.add("invisible"),h.reset(t.get(e)),u.dom.querySelector("#postpic").scrollIntoView())},u.setSessionId=function(e){l=e},u.del=function(e,i){(v||0===v)&&t.del(v),i.classList.remove("pressed"),i.parentNode.classList.add("invisible"),u.reset(),y(),document.getElementById("importbuttons").classList.remove("invisible"),d("import")},u}});