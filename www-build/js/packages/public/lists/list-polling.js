/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","CouchDBStore","Store","service/config","Olives/Model-plugin","Olives/Event-plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,l,c,h){var p=new n([]),d,v,m,g=!1,y=null,b=r.get("user"),w={db:e,view:c,design:l,query:{descending:!0,include_docs:!0,limit:30}};this.template="<ul class='ideas-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:mousemove, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div><h2 data-listideas='bind:innerHTML,doc.authornames'></h2><span class='date' data-listideas='bind:date,doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3><p data-listideas='bind:innerHTML,doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul>",this.plugins.addAll({listideas:new i(p,{date:function E(E){this.innerHTML=o.formatDate(E)},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=p.get(n).doc.votes||[];r.length===0?this.innerHTML="":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=t},setAvatar:function(t){var n,r;r=document.createDocumentFragment(),n=new u(t),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r)}}),listevent:new s(this)}),this.getModel=function(){return p},this.resetQuery=function(e){var n=new f,i=b.get("settings").polling_interval||r.get("polling_interval"),s=new t;return w.query=e,clearInterval(m),s.setTransport(r.get("transport")),s.sync(w.db,w.design,w.view,w.query).then(function(){p.reset(JSON.parse(s.toJSON())),s.unsync(),m=setInterval(function(){s.reset(),s.sync(w.db,w.design,w.view,w.query).then(function(){p.reset(JSON.parse(s.toJSON())),s.unsync()})},i),n.resolve()}),n},this.setStart=function(e,t){d=[e.pageX,e.pageY],y&&this.hideActionBar(y)},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("public");v=[e.pageX,e.pageY];if(!r.classList.contains("mosaic")&&!g&&d[0]-v[0]>40&&v[1]-d[1]<20&&v[1]-d[1]>-20){var i=new a("idea",t,p.get(n).doc,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),y=i,g=!0}},this.hideActionBar=function(t){var n=t.dom.parentElement;n.removeChild(n.lastChild),g=!1,y=null},h&&(w.query=h),this.init=function(n){var i=new f,s=b.get("settings").polling_interval||r.get("polling_interval"),o=new t;return o.setTransport(r.get("transport")),o.sync(w.db,w.design,w.view,w.query).then(function(){p.reset(JSON.parse(o.toJSON())),n(p,0),o.unsync(),m=setInterval(function(){o.reset(),o.sync(w.db,w.design,w.view,w.query).then(function(){p.reset(JSON.parse(o.toJSON())),o.unsync()})},s),i.resolve()}),i},b.watchValue("settings",function(){var e=new t,n;b.get("settings").polling_interval!==r.get("polling_interval")&&(r.set("polling_interval",b.get("settings").polling_interval),n=r.get("polling_interval"),clearInterval(m),e.setTransport(r.get("transport")),m=setInterval(function(){e.reset(),e.sync(w.db,w.design,w.view,w.query).then(function(){p.reset(JSON.parse(e.toJSON())),e.unsync()})},n))})}return function(n,r,i,s){return l.prototype=new e,new l(n,r,i,s)}});