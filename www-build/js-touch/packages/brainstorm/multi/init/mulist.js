/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h){var p=new e,d=i.get("labels"),v=i.get("user"),m=i.get("db"),g=i.get("transport"),y=new o([]),b=new o([]),w=new l,E=new o([]),S=new o({modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"}),x=new o([{name:"*"}]),T=i.get("userLanguages"),N="mulistall",C=u.getUserContactIds(),k=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200})).spin();return T.forEach(function(e){x.alter("push",e)}),p.plugins.addAll({labels:new t(d),options:new t(S,{setBg:function(e){e==="all"?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))},setMode:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+d.get(e[t])+"</option>";this.innerHTML=r}}),select:new t(x,{setBg:function(e){e==="*"?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),muall:new t(y,{setParticipants:function(e){var t=e.length+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){this.setAttribute("style","background-image: url('img/flags/"+e.substring(0,2)+".png');"),this.innerHTML=" "}}),musearch:new t(b,{setParticipants:function(e){var t=parseInt(e,10)+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');"),this.innerHTML=" "}}),mupreview:new f({preview:w}),mulistevent:new n(p)}),p.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><div class="selectlang"><div data-options="bind:setBg, selectedLang"></div><button data-mulistevent = "listen:touchstart, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-mulistevent="listen: touchend, filterLang"></li></ul></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div class="noresult invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: touchstart, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: touchstart, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',p.reset=function(){N="mulistall",k.spin(document.getElementById("mulistspinner")),S.set("selectedLang","all"),S.set("selectedMode","allmodes"),p.buildList(N).then(function(){k.stop()})},p.buildList=function(t,n){var r=[],i=new s;return t==="mulistall"&&(y.reset([]),p.addSessions(r,"roulette").then(function(){return p.addSessions(r,"campfire")}).then(function(){return p.addSessions(r,"boardroom")}).then(function(){r.length?p.dom.querySelector(".noresult").classList.add("invisible"):p.dom.querySelector(".noresult").classList.remove("invisible"),y.reset(r),i.fulfill()})),t==="musearch"&&(b.reset([]),p.syncSearch(r,n).then(function(){r.length?p.dom.querySelector(".noresult").classList.add("invisible"):p.dom.querySelector(".noresult").classList.remove("invisible"),b.reset(r),i.fulfill()})),i},p.syncSearch=function(t,n,i){var o=new s,u=new r;return u.setTransport(g),u.sync("_fti/local/"+m,"indexedsessions","waiting",{q:n,descending:!0}).then(function(){u.loop(function(e,n){var r=!1;e.fields.mode==="roulette"?r=!0:e.fields.mode==="campfire"&&C.indexOf(e.fields.initiator.id)>-1?r=!0:e.fields.mode==="boardroom"&&e.fields.invited.search(v.get("_id"))>-1&&(r=!0),r&&(i?e.fields.mode.search(i.mode)>-1&&e.fields.lang.search(i.lang)>-1&&t.push(e):t.push(e))}),o.fulfill()}),o},p.addSessions=function(t,n,i){var o=new s,u=new r,a="_view/"+n,f={};return u.setTransport(g),n==="roulette"?i?f={key:'"'+i+'"',descending:!1,limit:50}:f={descending:!1,limit:50}:i?f={key:'["'+v.get("_id")+'","'+i+'"]',descending:!1}:f={startkey:'["'+v.get("_id")+'",{}]',endkey:'["'+v.get("_id")+'"]',descending:!0},u.sync(m,"library",a,f).then(function(){console.log("MODE : ",n,"QUERY : ",JSON.stringify(f),"RESULT : ",u.toJSON()),u.loop(function(e,n){t.unshift(e)}),o.fulfill(),u.unsync()},function(e){console.log(e,n)}),o},p.search=function(e,t){e.keyCode===13&&(t.value===""?p.toggleList("mulistall"):p.toggleList("musearch"))},p.displayLang=function(e,t){p.dom.querySelector(".langlist").classList.remove("invisible")},p.filterLang=function(e,t){var n=parseInt(t.getAttribute("data-select_id"),10);p.dom.querySelector(".langlist").classList.add("invisible"),n===0?S.set("selectedLang","all"):S.set("selectedLang",x.get(n).name),k.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){k.stop()})},p.filterMode=function(e,t){var n=t.selectedIndex;S.set("selectedMode",S.get("modes")[n]);switch(n){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}k.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){k.stop()})},p.filterList=function(){var t=[],n=document.getElementById("mulist-content").querySelector("input").value,r=new s,i="",o="";return S.get("selectedMode")!=="allmodes"&&(i=S.get("selectedMode")),S.get("selectedLang")!=="all"&&(o=S.get("selectedLang")),i===""&&o===""?p.buildList(N,n).then(function(){r.fulfill()}):N==="mulistall"?(y.reset([]),i?p.addSessions(t,i,o).then(function(){y.reset(t),t.length?p.dom.querySelector(".noresult").classList.add("invisible"):p.dom.querySelector(".noresult").classList.remove("invisible"),r.fulfill()}):p.addSessions(t,"roulette",o).then(function(){return p.addSessions(t,"campfire",o)}).then(function(){return p.addSessions(t,"boardroom",o)}).then(function(){y.reset(t),t.length?p.dom.querySelector(".noresult").classList.add("invisible"):p.dom.querySelector(".noresult").classList.remove("invisible"),r.fulfill()})):(b.reset([]),p.syncSearch(t,n,{mode:i,lang:o}).then(function(){b.reset(t),t.length?p.dom.querySelector(".noresult").classList.add("invisible"):p.dom.querySelector(".noresult").classList.remove("invisible"),r.fulfill()})),r},p.zoom=function(e,t){var n;t.classList.add("pressed"),N==="mulistall"?(n=parseInt(t.getAttribute("data-muall_id"),10),w.reset(y.get(n).id)):N==="musearch"&&(n=t.getAttribute("data-musearch_id"),w.reset(b.get(n).id))},p.toggleList=function(t){t!==N&&(document.getElementById(N).classList.add("invisible"),document.getElementById(t).classList.remove("invisible"),N=t),k.spin(document.getElementById("mulistspinner")),p.filterList().then(function(){k.stop()})},p.refreshList=function(){p.toggleList(N)},w.init(p.refreshList),v.watchValue("lang",function(){var e;S.set("modes",["allmodes","roulette","campfire","boardroom"]),e=S.get("lang"),e.splice(0,1,d.get("all")),S.set("lang",e)}),p}});