/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/cardpopup","../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b,w,E="step",S,x=0,T,N=new u({timer:null,display:!1}),C=new u({title:"",description:"",solution:"",visibility:"private"}),k=new u,L=new u([]),A=[],O={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},M=new u(O),_=new u([]),D=new o("idea",_,M),P=i.get("transport"),H=i.get("labels"),B=i.get("user"),j=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return y.plugins.addAll({labels:new n(H,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(k),techs:new n(L,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},i.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new n(M,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),quickideatimer:new n(N,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(C,{setVisibility:function(e){e==="public"?(this.value=0,this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")):(this.value=1,this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))}}),wbstack:D,quickideaevent:new r(y)}),y.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:touchstart, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:touchstart,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: touchstart, select; listen:touchend, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: touchstart, select; listen:touchend, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: touchstart, push; listen:touchend, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: touchstart, push; listen:touchend, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: touchstart, push; listen:touchend, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: touchstart, press; listen:touchend, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:touchend, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: touchstart, press; listen:touchend, next"></div></div></div>',y.place(t.get("quickidea")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var n=new Date,r,s;j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),E==="step"?(E="screen",clearInterval(T),N.set("display",!0),s=y.getSessionDuration(),d.set("idea",JSON.parse(C.toJSON())),y.createIdeaDoc().then(function(){return y.updateSessionScore(N.get("timer"))}).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");return e.quickidea=N.get("timer"),p.set("idea",[JSON.parse(C.toJSON())]),p.set("elapsedTimers",e),p.set("duration",s),p.set("status","completed"),M.set("readonly",!0),m("quickidea")}).then(function(){B.set("sessionInProgress",{}),user.upload()})):m("quickidea")},y.stopSpinner=function(){j.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),v("quickidea")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){N.set("display",!N.get("display"))},y.toggleVisibility=function(e,t){E==="step"&&(C.get("visibility")==="public"?C.set("visibility","private"):C.set("visibility","public"))},y.push=function(e,t){var n=t.getAttribute("name");M.set(n,"active")},y.select=function(e,t){t.classList.add("higlighted")},y.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),y.setPopup(n,r)},y.setPopup=function(t,n){var r={x:147,y:30},s="left",o=M.get("cardpopup"),f=new u,l="",c,h;w&&(w.type==="scenario"?o.scenario=!1:o.techs[w.id]=!1,M.set("cardpopup",o)),t==="scenario"?o.scenario=!0:o.techs[n]=!0,M.set("cardpopup",o),w={type:t,id:n},t==="scenario"?(r.y=55,f.reset(d.get("scenario")),f.set("type",5),l=f.toJSON(),b.reset(l,r,s,document.getElementById("quickidea-popup"))):(n==0&&(r.y=200),n==1&&(r.y=260),n==2&&(r.y=350),A[n]?(l=A[n],b.reset(l,r,s,document.getElementById("quickidea-popup"))):(h=new a,h.setTransport(P),h.sync(i.get("db"),d.get("techno").get(n).id).then(function(){l=h.toJSON(),b.reset(l,r,s,document.getElementById("quickidea-popup")),A[n]=l})))},y.closePopup=function(){var t=M.get("cardpopup");t[w]=!1,M.set("cardpopup",t),w=""},b=new s(y.closePopup),y.post=function(e,t){D.selectScreen("postit"),M.set("import","inactive"),M.set("drawing","inactive")},y.importpic=function(e,t){D.selectScreen("import"),M.set("postit","inactive"),M.set("drawing","inactive")},y.draw=function(e,t){D.selectScreen("drawing"),M.set("import","inactive"),M.set("postit","inactive")},y.exitTool=function(t){M.set(t,"inactive")},y.finish=function(e,t){D.setReadonly(!0),M.set("ready",!1),M.set("showidea",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new f,n={sid:p.get("_id"),step:"quickidea",time:e,wbcontent:_.toJSON(),idea:C.toJSON()};return P.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},y.getSessionDuration=function(){var t=p.get("elapsedTime"),n=p.get("resumeTime")||p.get("startTime");return now=new Date,now.getTime()-n+t},y.createIdeaDoc=function(){var t=new a(i.get("ideaTemplate")),n=new Date,r="I:"+n.getTime(),s=new f;return t.setTransport(P),t.set("title",C.get("title")),t.set("sessionId",p.get("_id")),t.set("authors",[p.get("initiator").id]),t.set("description",C.get("description")),t.set("solution",C.get("solution")),t.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),t.set("character",p.get("characters")[0]),t.set("problem",p.get("problems")[0]),t.set("context",p.get("contexts")[0]),t.set("techno",p.get("techno")[0]),t.set("visibility",C.get("visibility")),t.set("authornames",p.get("initiator").username),t.set("lang",p.get("lang").substring(0,2)),t.set("_id",r),t.sync(i.get("db"),r).then(function(){return t.upload()}).then(function(){t.get("visibility")==="public"&&P.request("UpdateUIP",{userid:B.get("_id"),type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(e){e!=="ok"&&console.log(e)}),s.fulfill(),t.unsync()}),s},y.reset=function(t){M.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),L.reset(),D.setSessionId(p.get("_id")),_.reset(p.get("ideaWB")),_.getNbItems()?D.selectScreen("main"):D.selectScreen("default"),clearInterval(T),p.get("idea").length?(D.setReadonly(!0),M.set("ready",!1),M.set("showidea",!0),C.reset(p.get("idea")[0]),d.set("idea",p.get("idea")[0]),M.set("readonly",!0),M.set("shownext",!0),E="screen"):(C.reset({title:"",description:"",solution:"",visibility:"private"}),_.getNbItems()?M.set("ready",!0):M.set("ready",!1),D.setReadonly(!1),E="step"),p.get("elapsedTimers").quickidea&&(x=p.get("elapsedTimers").quickidea,N.set("timer",x)),E==="screen"?N.set("display",!0):y.initTimer(x)},y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;N.set("display",!1),N.set("timer",r),p.get("step")==="quickidea"&&(clearInterval(T),T=setInterval(function(){var e=new Date;N.set("timer",r+e.getTime()-n)},1e3))},p.watchValue("_id",function(e){D.setSessionId(e)}),d.watchValue("scenario",function(e){k.reset(d.get("scenario"))}),d.watchValue("techno",function(e){L.reset(JSON.parse(d.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){_.watch(e,function(){JSON.stringify(p.get("ideaWB"))!==_.toJSON()&&(p.set("ideaWB",JSON.parse(_.toJSON())),p.upload()),_.getNbItems()?M.set("ready",!0):M.set("ready",!1)})}),C.watch("updated",function(){C.get("title")&&C.get("description")&&C.get("solution")?M.set("shownext",!0):M.set("shownext",!1)}),y}});