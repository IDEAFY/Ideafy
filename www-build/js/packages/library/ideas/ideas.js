/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","Amy/Control-plugin","Olives/Model-plugin","Amy/Delegate-plugin","CouchDBStore","service/map","service/config","./idea-stack","./lists/idealist","Amy/Stack-plugin"],function(e,t,n,r,i,s,o,u,a,f){return function(){var c=new e,h=s.get("ideas"),p=h.querySelector(".bydate"),d=h.querySelector(".byrating"),v=new i({search:""}),m=o.get("db"),g=o.get("observer"),y=new t(this),b=new u,w=new f;c.plugins.addAll({idealiststack:w,search:new n(v),ideasevent:new r(this),ideascontrol:y}),this.selectStart=function(e){var t=w.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");b.reset(t,n),v.set("search","")},this.show=function(e,t){var n=h.querySelector(".bydate"),r=h.querySelector(".byrating"),i=t.getAttribute("name");i!==w.getStack().getCurrentName&&(w.getStack().show(i),i==="#list-date"?(b.reset(E.getModel(),0),r.classList.remove("pushed"),n.classList.add("pushed")):(b.reset(x.getModel(),0),r.classList.add("pushed"),n.classList.remove("pushed")))},this.mosaic=function(){var e=document.getElementById("ideas-detail");h.classList.toggle("mosaic"),e.classList.contains("invisible")?(e.classList.remove("invisible"),b.reset(E.getModel(),0)):e.classList.add("invisible")},this.plus=function(){s.get("newidea-popup").classList.add("appear"),s.get("cache").classList.add("appear")},this.search=function(e,t){e.keyCode===13&&(t.value===""?(p.setAttribute("style","display: inline-block;"),d.setAttribute("style","display: inline-block;"),w.getStack().show("#list-date"),p.classList.add("pushed"),d.classList.remove("pushed")):c.searchIdea(t.value))},c.searchIdea=function(t){p.setAttribute("style","display: none;"),d.setAttribute("style","display: none;"),S.resetQuery({q:t,sort:"\\creation_date<date>",include_docs:!0}).then(function(){w.getStack().show("#list-search"),v.set("search",S.getModel().get(0).doc.title),b.reset(S.getModel(),0)})},c.alive(h);var E=new a(m,"library","_view/ideas",{key:o.get("uid"),descending:!0,include_docs:!0}),S=new a("_fti/local/"+m,"indexedideas","userbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),x=new a(m,"ideas","_view/privatebyvotes",{startkey:'["'+o.get("user").get("_id")+'",{}]',endkey:'["'+o.get("user").get("_id")+'"]',descending:!0,include_docs:!0});return w.getStack().add("#list-date",E),w.getStack().add("#list-rating",x),w.getStack().add("#list-search",S),x.init(),E.init().then(function(){w.getStack().show("#list-date"),b.reset(E.getModel(),0)}),c}});