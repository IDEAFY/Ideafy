/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./mustart","./musetup","./muscenario","./mutech","./muidea","./muwrapup","CouchDBDocument","service/config","Promise","Store","lib/spin.min","Place.plugin","service/confirm"],function(e,t,n,s,i,a,r,l,o,c,d,u,g,m,p,b,v,h){return function(t){var f,w,y,S,L,k,T,M,A=new e,C=new e,I=(document.createDocumentFragment(),new n),H=g.get("labels"),q=[{name:"mustart",label:H.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:H.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:H.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:H.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:H.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:H.get("quickstepwrapup"),currentStep:!1,status:null}],_=new p(q),D=g.get("user"),B=g.get("db"),x=new u,E=new p,P=new p({msg:""}),O=new b({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin();return C.plugins.addAll({labels:new s(H),step:new s(_,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(C)}),C.template='<div class = "progressbar invisible"><ul id = "musteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: touchstart, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: touchstart, press; listen:touchend, exit"></div></div>',C.changeStep=function(e,t){var n=t.getAttribute("data-step_id");_.get(n).status?(_.loop(function(e,t){n==t?_.update(t,"currentStep",!0):_.update(t,"currentStep",!1)}),I.getStack().show(_.get(n).name)):e.stopImmediatePropagation()},C.press=function(e,t){t.classList.add("pressed")},C.exit=function(e,n){n.classList.remove("pressed"),D.get("sessionInProgress").id!==x.get("_id")?t():"muwrapup"===x.get("step")?(k.getChatUI().leave(),x.get("initiator").id===D.get("_id")&&k.getChatUI().setReadonly(),D.set("sessionInProgress",""),D.upload().then(function(){t()})):T.show()},A.template='<div id="musession"><div data-place="place:progress"></div><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></div><div class="stack" data-musessionstack="destination"></div></div>',A.plugins.addAll({musessionstack:I,place:new v({progress:C}),info:new s(P)}),A.toggleProgress=function(e){e?C.exit():C.dom.classList.toggle("invisible")},A.leaveSession=function(){var e,n=x.get("participants"),s=I.getStack().get(x.get("step"));for(e=n.length-1;e>=0;e--)if(n[e].id===D.get("_id")){n.splice(e,1);break}x.set("participants",n),x.upload().then(function(){s.getChatUI().leave(),x.unsync(),T.hide(),document.body.removeChild(document.querySelector(".confirm"))}),D.set("sessionInProgress",""),D.upload().then(function(){t()})},A.cancelSession=function(){var e=5e3;A.displayInfo("deleting",e).then(function(){t()})},A.displayInfo=function(e,t){var n,s=document.querySelector(".sessionmsg"),i=new m,a=function(){s.classList.add("invisible"),clearInterval(n),P.set("msg",""),i.fulfill()};return T.hide(),document.body.removeChild(document.querySelector(".confirm")),s.classList.remove("invisible"),n=setInterval(function(){switch(e){case"deleting":P.set("msg",H.get("deletingsession")+t/1e3+"s");break;case"participantsleft":P.set("msg",H.get("participantsleft")+" "+t/1e3+"s");break;default:e!==P.get("msg")&&P.set("msg",e)}0>=t&&a(),t-=1e3},1e3),("deleting"===e||"participantsleft"===e)&&(x.set("status","deleted"),x.upload().then(function(){return D.set("sessionInProgress",""),D.upload()}).then(function(){var e=x.get("chat"),t=e.length,n=new m;return t?e.forEach(function(e){var s=new u;s.setTransport(g.get("transport")),s.sync(B,e).then(function(){return s.remove()}).then(function(){t--,0>=t&&n.fulfill})}):n.fulfill(),n}).then(function(){x.remove()})),i},A.createChat=function(e){var t,n,s=new u,i=(new Date).getTime(),a=[],r=new m;switch(a.push({username:x.get("initiator").username,userid:x.get("initiator").id}),x.get("participants").forEach(function(e){a.push({username:e.username,userid:e.id})}),s.set("users",a),e){case 1:t="quicksetup";break;case 2:t="quickscenario";break;case 3:t="quicktech";break;case 4:t="quickidea";break;case 5:t="quickwrapup";break;default:t="quickstart"}return s.set("msg",[{user:"SYS",type:5,arg:t,time:i}]),s.set("sid",x.get("_id")),s.set("lang",x.get("lang")),s.set("readonly",!1),s.set("step",e),s.set("type",17),n=s.get("sid")+"_"+e,s.setTransport(g.get("transport")),s.sync(B,n).then(function(){return s.upload()}).then(function(){var e=x.get("chat").concat();s.unsync(),e.push(n),x.set("chat",e),r.fulfill()}),r},A.retrieveSession=function(e,t){O.spin(document.getElementById("brainstorm")),x.reset({}),x.sync(B,e).then(function(){var e=x.get("step"),n=1e4;_.getNbItems(),t||(T=new h(document.body,null,null,"musession-confirm"),M=function(e){e?x.get("initiator").id===D.get("_id")?A.cancelSession():A.leaveSession():T.hide()},x.get("initiator").id===D.get("_id")?T.reset(H.get("leaderleave"),M):T.reset(H.get("participantleave"),M)),_.loop(function(s,i){n>i&&(I.getStack().get(s.name).reset(t),_.update(i,"status","done"),s.name===e&&(n=i,_.update(i,"currentStep",!0),"muwrapup"===s.name?_.update(i,"status","done"):_.update(i,"status","ongoing")))}),t?(O.stop(),I.getStack().show("muwrapup")):(O.stop(),I.getStack().show(e))})},A.reset=function(e,t){x.unsync(),E.reset(),document.querySelector(".confirm")&&document.body.removeChild(document.querySelector(".confirm")),_.reset([{name:"mustart",label:H.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:H.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:H.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:H.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:H.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:H.get("quickstepwrapup"),currentStep:!1,status:null}]),e&&A.retrieveSession(e,t)},A.prev=function(e){var n;_.loop(function(t,s){t.name===e&&(n=s)}),n>0?(_.update(n,"currentStep",!1),_.update(n-1,"currentStep",!0),I.getStack().show(_.get(n-1).name)):(alert("Exiting session"),t())},A.next=function(e){var t,n,s=I.getStack().get(e),i="",a=new m;return _.loop(function(n,s){n.name===e&&(t=s)}),t<_.getNbItems()&&(i=_.get(t+1).name,n=I.getStack().get(i),_.update(t,"currentStep",!1),_.update(t+1,"currentStep",!0),"done"!==_.get(t).status?(_.update(t,"status","done"),_.update(t+1,"status","ongoing"),"muwrapup"===_.get(t+1).name&&_.update(t+1,"status","done"),n.reset(),A.createChat(t+1).then(function(){return x.set("step",i),x.upload()}).then(function(){n.initTimer&&n.initTimer(),s.stopSpinner(),I.getStack().show(i),"muwrapup"===i?(D.unsync(),D.sync(g.get("db"),D.get("_id")).then(function(){return D.set("sessionInProgress",""),D.upload()}).then(function(){a.fulfill()})):a.fulfill()})):(s.stopSpinner(),I.getStack().show(i),a.fulfill())),a},A.init=function(){f=new a(x,A.prev,A.next,A.toggleProgress),w=new r(x,E,A.prev,A.next,A.toggleProgress),y=new l(x,E,A.prev,A.next,A.toggleProgress),S=new o(x,E,A.prev,A.next,A.toggleProgress),L=new c(x,E,A.prev,A.next,A.toggleProgress),k=new d(x,E,A.prev,A.next,A.toggleProgress),x.setTransport(g.get("transport")),I.getStack().add("mustart",f),I.getStack().add("musetup",w),I.getStack().add("muscenario",y),I.getStack().add("mutech",S),I.getStack().add("muidea",L),I.getStack().add("muwrapup",k)},A.init(),x.watchValue("status",function(e){"deleted"===e&&x.get("initiator").id!==D.get("_id")&&(D.set("sessionInProgress",""),D.upload(),A.displayInfo(H.get("canceledbyleader"),2e3).then(function(){x.unsync(),t()}))}),x.watchValue("step",function(e){var t,n=x.get("step");x.get("initiator")&&x.get("initiator").id!==D.get("_id")&&(_.loop(function(e,s){e.name===n&&(t=s)}),_.update(t-1,"status","done"),_.update(t,"status","ongoing"),_.update(t-1,"currentStep",!1),_.update(t,"currentStep",!0),I.getStack().get(e).reset(),I.getStack().show(e)),"muwrapup"===step&&(D.unsync(),D.sync(g.get("db"),D.get("_id")).then(function(){return D.set("sessionInProgress",""),D.upload()}))}),x.watchValue("participants",function(e){0===e.length&&"muwrapup"!==x.get("step")&&A.displayInfo("participantsleft",1e4).then(function(){return D.set("sessionInProgress",""),D.upload()}).then(function(){t(),document.body.removeChild(document.querySelector(".confirm"))})}),A}});