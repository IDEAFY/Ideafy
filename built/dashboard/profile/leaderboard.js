/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","service/utils","service/avatar"],function(e,t,i,s,n,a,r){return function(){var c=new e,o=new n([]);return c.template='<div><ul data-leaders="foreach"><li class="leader" data-leaders="bind:setSpotLight, value.userid"><div data-leaders="bind:setAvatar, value.userid"></div><div class="username" data-leaders="bind:innerHTML, value.username"></div><div class="distinction" data-leaders="bind:setDistinction, value.ip"></div><div class="grade" data-leaders="bind:setGrade, value.ip"></div><div class="score" data-leaders="bind: setScore, value.ip"></div></li></ul></div>',c.plugins.addAll({leaders:new i(o,{setSpotLight:function(e){e===t.get("user").get("_id")?(this.classList.add("userleader"),this.scrollIntoView(!1)):this.classList.remove("userleader")},setAvatar:function(e){var t,i;e&&(i=document.createDocumentFragment(),t=new r([e]),t.place(i),this.hasChildNodes()?this.replaceChild(i,this.firstChild):this.appendChild(i))},setGrade:function(e){var t=this;a.getGrade(e,function(e){t.setAttribute("style","background: url('img/profile/"+e.grade.badge+"') no-repeat center center; background-size: 40px 40px;")})},setDistinction:function(e){var t=this;a.getGrade(e,function(e){e.distinction&&t.setAttribute("style","background: url('img/profile/"+e.distinction.badge+"') no-repeat center center; background-size: 40px 40px;")})},setScore:function(e){this.innerHTML=e+" ip"}}),leaderevent:new s(c)}),c.init=function(e){o.setTransport(t.get("transport")),o.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0}).then(function(){c.place(e)})},t.get("observer").watch("reconnect",function(){o.unsync(),o.reset([]),o.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0})}),c}});