/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/config","Olives/Model-plugin","Olives/Event-plugin","CouchDBStore","Store","service/avatar"],function(e,t,n,r,s,o,u){return function(){var f=new e,l=new s,c=new o({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:""}),h=new o([]),p={},d=t.get("user"),v=t.get("transport"),m=t.get("labels"),g=function(e,t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;e==="email"?n.test(t.toLowerCase())?(c.set("result",""),y("userid",t.toLowerCase())):c.set("result",m.get("signupinvalidemail")):c.get("email")?c.set("result",m.get("clearemailfirst")):c.get("firstname")&&c.get("lastname")?(c.set("result",""),y("username",c.get("firstname").toLowerCase()+" "+c.get("lastname").toLowerCase())):c.set("result",m.get("needbothfnln"))},y=function(e,n){var r=new s;r.setTransport(v),e==="userid"?r.sync(t.get("db"),"users","_view/searchbyid",{key:'"'+n+'"',descending:!0}).then(function(){h.reset(JSON.parse(r.toJSON())),h.getNbItems()?c.set("display",!0):c.set("result",m.get("noentryfound")),r.unsync()}):r.sync(t.get("db"),"users","_view/searchbyusername",{key:'"'+n+'"',descending:!0}).then(function(){h.reset(JSON.parse(r.toJSON())),h.getNbItems()?c.set("display",!0):c.set("result",m.get("noentryfound")),r.unsync()})},b=function(e){var t=!1,n=d.get("sentMessages"),r=!1;if(e.userid===d.get("_id"))c.set("result",m.get("cannotaddself"));else if(JSON.stringify(d.get("connections")).search(e.userid)>-1)c.set("result",e.username+m.get("alreadyconnected"));else{for(i=0;i<n.length;i++)console.log(n[i]),n[i].type==="CXR"&&n[i].toList.search(e.username)>-1&&(r=!0);r?c.set("result",m.get("alreadysentCXR")+e.username):t=!0}return t},w=function(e){var t=new Date,n={};b(e)&&(n.dest=[e.userid],n.type="CXR",n.status="unread",n.date=[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],n.author=d.get("_id"),n.username=d.get("username"),n.firstname=d.get("firstname"),n.toList=e.username,n.ccList="",n.object=d.get("username")+m.get("CXRobject"),n.body=c.get("message"),n.signature=d.get("signature"),n.contactInfo={firstname:d.get("firstname"),lastname:d.get("lastname"),userid:d.get("_id"),username:d.get("username"),intro:d.get("intro"),type:"user"},v.request("Notify",n,function(e){var e=JSON.parse(e);e[0].res==="ok"?(c.set("result",m.get("CXRsent")),setTimeout(function(){f.reset()},2e3)):model.set("result","There was an error, please try again later")}))};return f.plugins.addAll({label:new n(m),count:new n(l),search:new n(c,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")}}),contacts:new n(h,{setAvatar:function(t){var n,r;_frag=document.createDocumentFragment(),_ui=new u([t]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),searchdbevent:new r(f)}),f.template='<div id="addcontact"><div class="header blue-dark"><span class="newcontactlbl" data-label="bind:innerHTML, newcontactlbl"></span></div><div class = "detail-contents"><div class="doctor-deedee"></div><div class="addcontactform"><p class="half"><span data-label="bind:innerHTML, beforecount"></span><strong><span data-count="bind:innerHTML, 0.value"></span></strong><span data-label="bind:innerHTML, aftercount"></span></p><p class="half" data-label="bind: innerHTML, addcontactrightintro"></p><legend data-label="bind:innerHTML, addcontactnow"></legend><input class="search" type="text" name="email" data-label="bind:placeholder, searchcontactplaceholder" data-search="bind: value, email" data-searchdbevent="listen: keypress, searchDB"><legend data-label="bind:innerHTML, lookup"></legend><div class="searchcontact"><input type="text" class="search half" name="fn" data-label="bind:placeholder, firstnameplaceholder" data-search="bind: value, firstname" data-searchdbevent="listen: keypress, searchDB"><input class="search half right" type="text" name="ln" data-label="bind: placeholder, lastnameplaceholder" data-search="bind: value, lastname" data-searchdbevent="listen: keypress, searchDB"></div><p class="searchresult" data-search="bind: innerHTML, result; bind:setStyle, sentok"></p></div></div><div class = "contactlist invisible" data-search="bind: setVisible, display"><legend data-label="bind:innerHTML, selectcontact"></legend><ul data-contacts="foreach"><li class = "contact list-item"><div data-contacts="bind:setAvatar, value.userid"></div><p class="contact-name" data-contacts="bind:innerHTML, value.username"></p><p class="contact-intro" data-contacts="bind:innerHTML, value.intro"></p><div class="select-contact" data-searchdbevent="listen:mousedown, check"></div></li></ul><textarea class="input" data-label="bind:placeholder, addamessage" data-search="bind:value, message"></textarea><div class="addcontactbtns"><div class="addct" data-searchdbevent="listen:mousedown, press; listen:mouseup, add"></div><div class="cancelct" data-searchdbevent="listen:mousedown, press; listen:mouseup, cancel"></div></div></div></div>',f.init=function(){l.setTransport(v),l.sync(t.get("db"),"users","_view/count")},f.searchDB=function(e,t){var n;e.keyCode===13&&(e.target.blur(),console.log(e.target),n=t.getAttribute("name"),g(n,t.value))},f.check=function(e,t){var n=t.getAttribute("data-contacts_id");t.innerHTML?(t.innerHTML="",p[n]=!1):(t.innerHTML="&#10003;",p[n]=!0)},f.reset=function(){c.reset({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:""}),h.reset([])},f.press=function(e,t){t.classList.add("pushed")},f.cancel=function(e,t){t.classList.remove("pushed"),f.reset()},f.add=function(e,t){t.classList.remove("pushed");for(i in Object.keys(p))w(h.get(i).value)},f.init(),f}});