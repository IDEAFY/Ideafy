/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min"],function(e,t,i,n,s,a,r){return function(){var o=new e,c=new a(s.get("ideaTemplate")),l=new a(s.get("userLanguages")),d=s.get("user"),u=function(){var e=d.get("lang").substring(0,2);c.set("lang",e),l.loop(function(t,i){t.name===e?l.update(i,"selected",!0):l.update(i,"selected",!1)})},p=s.get("labels"),g=new a({error:""}),h=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();return c.setTransport(s.get("transport")),u(),o.plugins.addAll({newidea:new i(c,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setVisibility:function(e){"public"===e?(this.innerHTML=p.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=p.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){"public"===e?this.classList.remove("invisible"):this.classList.add("invisible")}}),select:new i(l,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new i(p),errormsg:new i(g,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;case"nosol":this.innerHTML=p.get("solutionfield")+p.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new n(o)}),o.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:touchstart, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newidea="bind: displayLang, lang" data-newideaevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newideaevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',o.render(),o.place(t.get("newidea-popup")),o.showLang=function(){o.dom.querySelector(".idealang ul").classList.remove("invisible")},o.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),l.loop(function(e,t){i===t?l.update(t,"selected",!0):l.update(t,"selected",!1)})},o.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),c.set("lang",l.get(i).name),o.dom.querySelector(".idealang ul").classList.add("invisible")},o.toggleVisibility=function(e,t){"1"===t.value?c.set("visibility","private"):c.set("visibility","public")},o.press=function(e,t){t.classList.add("pressed"),o.dom.querySelector(".publicwarning").classList.add("invisible")},o.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),document.getElementById("cache").classList.add("invisible"),c.unsync(),c.reset(s.get("ideaTemplate")),u(),g.reset({error:""}),o.dom.querySelector(".visibility-slider").value=1,o.dom.querySelector(".idealang ul").classList.add("invisible")},o.resetError=function(e,t){var i;t.scrollTop=99999,g.get("error")&&(i=t.classList.contains("description")?"nodesc":t.classList.contains("solution")?"nosol":"notitle",g.get("error")===i&&t.value&&g.set("error",""))},o.cancel=function(){o.closePopup()},o.upload=function(e,t){var i,n=new Date,a="I:"+n.getTime();t.classList.remove("pressed"),c.get("title")?c.get("description")?c.get("solution")||g.set("error","nosol"):g.set("error","nodesc"):g.set("error","notitle"),g.get("error")||c.get("_id")||(t.classList.add("invisible"),h.spin(t.parentNode),i=setInterval(function(){g.get("error")===p.get("uploadinprogress")?g.set("error",p.get("uploadinprogress")+"..."):g.set("error",p.get("uploadinprogress"))},100),c.set("authors",[d.get("_id")]),c.set("authornames",d.get("username")),c.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),c.sync(s.get("db"),a).then(function(){return c.upload()}).then(function(){"public"===c.get("visibility")?s.get("transport").request("UpdateUIP",{userid:d.get("_id"),type:c.get("type"),docId:a,docTitle:c.get("title")},function(e){"ok"!==e&&console.log(e),h.stop(),t.classList.remove("invisible"),o.closePopup(),clearInterval(i)}):(h.stop(),t.classList.remove("invisible"),o.closePopup(),clearInterval(i))}))},o}});