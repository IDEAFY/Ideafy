/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils"],function(e,t,i,n,s,a){return function(r){var o,c,l=new e,d=t.get("user"),u=t.get("transport"),p=new Date,g=new s({author:d.get("_id"),message:"",firstname:d.get("firstname"),date:[p.getFullYear(),p.getMonth(),p.getDate()],datemod:"",plusones:0,replies:[]}),h=r||"public",m="new",v=0;return l.plugins.addAll({twocent:new i(g,{date:function(e){e&&(this.innerHTML=a.formatDate(e))},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new i(t,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),labels:new i(t.get("labels")),twocentevent:new n(l)}),l.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: touchstart, press; listen: touchend, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: touchstart, press; listen: touchend, publish">Publish</div></div></div>',l.reset=function(e,t,i,n){var s=new Date,a={author:d.get("_id"),message:"",firstname:d.get("firstname"),date:"",datemod:"",plusones:0,replies:[]};e&&(o=e),t?(g.reset(t),m=t,v=i,g.set("datemod",[s.getFullYear(),s.getMonth(),s.getDate()])):(g.reset(a),g.set("date",[s.getFullYear(),s.getMonth(),s.getDate()]),m="new"),n&&(c=n)},l.cancel=function(e,t){t.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),c?c():document.getElementById(h+"-writetwocents").classList.add("invisible")},l.publish=function(e,i){if(i.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;"),g.get("message")){var n,s,a=JSON.parse(g.toJSON());s="new"===m?"new":"edit",n={docId:o,type:s,position:v,twocent:a},u.request("WriteTwocent",n,function(e){"ok"!==e?alert(t.get("labels").get("somethingwrong")):("new"===m?document.getElementById(h+"-writetwocents").classList.add("invisible"):c(),l.reset(o))},l)}},l.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")},l}});