/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min","service/utils"],function(e,t,n,r,i,s,o,u){return function(a){var f=new e,l=new s({}),c=i.get("user"),h=i.get("transport"),p=i.get("labels"),d=new s({error:""}),v=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),m,g=60,y=60,b=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=g/t,t=g):(t*=y/n,n=y),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},w=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=g,o=y,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},E=function(){var e="/upload",t=new FormData,n="deckpic",r="decks",i=m;t.append("type",n),t.append("dir",r),t.append("filename",l.get("_id")),t.append("dataString",i),u.uploadFile(e,t,null,function(e){console.log(e)})};return l.setTransport(i.get("transport")),f.plugins.addAll({newdeck:new n(l),labels:new n(p),errormsg:new n(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new r(f)}),f.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:touchstart, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend>Select a deck icon</legend><div class="deckicon"><div class="decklogo"></div><div class="importbutton" data-newdeckevent="listen: touchstart, press; listen:touchend, picturePreview" data-labels="bind:innerHTML, importpiclbl"></div></div><div class="newidea-footer"><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>',f.reset=function(t){l.reset({_id:"",type:9,description:"",default_lang:c.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:c.get("_id"),author:c.get("username"),"public":!1,sharedwith:[]}),m=null},f.show=function(){f.reset(),document.getElementById("cache").classList.add("appear"),f.dom.classList.add("appear")},f.press=function(e,t){t.classList.add("pressed")},f.picturePreview=function(e,t){var n=navigator.camera.PictureSourceType.PHOTOLIBRARY,r=new Image,i={quality:50,correctOrientation:!0,sourceType:n},s,o;s=function(e){r.src=e,setTimeout(function(){w(b(r),function(e){var n=f.dom.querySelector(".decklogo");n.setAttribute("style","background-image: url('"+e+"')"),m=e,l.set("picture_file","decklogo"),t.classList.remove("pressed")})},750)},o=function(e){alert("error: "+e)},navigator.camera.getPicture(s,o,i)},f.closePopup=function(){f.dom.classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),l.unsync(),f.reset(),d.reset({error:""})},f.resetError=function(e,t){var n;t.scrollTop=99999,d.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",d.get("error")===n&&t.value&&d.set("error",""))},f.cancel=function(e,t){f.closePopup()},f.upload=function(e,t){var n=new Date,r="D:"+n.getTime();t.classList.remove("pressed"),l.get("title")?l.get("description")||d.set("error","nodesc"):d.set("error","notitle"),!d.get("error")&&!l.get("_id")&&(t.classList.add("invisible"),v.spin(t.parentNode),l.set("_id",r),l.set("date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),l.sync(i.get("db"),r).then(function(){return l.get("picture_file")&&E(),l.upload()}).then(function(){a("new",r);var e=c.get("custom_decks")||[];return e.unshift(r),c.set("custom_decks",e),c.upload()}).then(function(){v.stop(),t.classList.remove("invisible"),f.closePopup()}))},f.reset(),f}});