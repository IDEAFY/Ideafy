/*
 Emily <VERSION> http://flams.github.com/emily

 The MIT License (MIT)

 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
*/

define("Tools",[],function(){function e(e,t,i){var s,n;return t?(t.forEach(function(t,a){var r=i(t,e);r>=0&&("undefined"==typeof n||n>r)&&(n=r,s=a)}),s):void 0}return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(e,t,i){return this.loop(e,function(s,n){t[n]&&i||(t[n]=e[n])}),t},count:function(e){var t=0;return this.loop(e,function(){t++}),t},compareObjects:function(e,t){return Object.getOwnPropertyNames(e).sort().join("")==Object.getOwnPropertyNames(t).sort().join("")},compareNumbers:function(e,t){return e>t?1:t>e?-1:0},toArray:function(e){return[].slice.call(e)},loop:function(e,t,i){var s;if(e instanceof Object&&t instanceof Function){if(e instanceof Array)for(s=0;s<e.length;s++)t.call(i,e[s],s,e);else for(s in e)e.hasOwnProperty(s)&&t.call(i,e[s],s,e);return!0}return!1},objectsDiffs:function(e,t){if(e instanceof Object&&t instanceof Object){var i=[],s=[],n=[],a=[];return this.loop(t,function(t,n){"undefined"==typeof e[n]?a.push(n):t!==e[n]?s.push(n):t===e[n]&&i.push(n)}),this.loop(e,function(e,i){"undefined"==typeof t[i]&&n.push(i)}),{updated:s,unchanged:i,added:a,deleted:n}}return!1},jsonify:function(e){return e instanceof Object?JSON.parse(JSON.stringify(e)):!1},clone:function(e){return e instanceof Array?e.slice(0):"object"!=typeof e||null===e||e instanceof RegExp?!1:this.mixin(e,{})},getNestedProperty:function(e,t){return e&&e instanceof Object?"string"==typeof t&&""!==t?t.split(".").reduce(function(e,t){return e&&e[t]},e):"number"==typeof t?e[t]:e:e},setNestedProperty:function(e,t,i){if(e&&e instanceof Object){if("string"==typeof t&&""!==t){var s=t.split(".");return s.reduce(function(e,t,n){return e[t]=e[t]||{},s.length==n+1&&(e[t]=i),e[t]},e)}return"number"==typeof t?(e[t]=i,e[t]):e}return e},closest:function(t,i){return e(t,i,function(e,t){return Math.abs(e-t)})},closestGreater:function(t,i){return e(t,i,function(e,t){return e-t})},closestLower:function(t,i){return e(t,i,function(e,t){return t-e})}}}),define("Observable",["Tools"],function(e){return function(){var t={};this.watch=function(e,i,s){if("function"==typeof i){var n=t[e]=t[e]||[],i=[i,s];return n.push(i),[e,n.indexOf(i)]}return!1},this.unwatch=function(e){var i=e[0],e=e[1];return t[i]&&t[i][e]?(delete t[i][e],t[i].some(function(e){return!!e})||delete t[i],!0):!1},this.notify=function(i){var s=t[i],n=e.toArray(arguments).slice(1);return s?(e.loop(s,function(e){try{e&&e[0].apply(e[1]||null,n)}catch(t){}}),!0):!1},this.hasObserver=function(e){return!(!e||!t[e[0]]||!t[e[0]][e[1]])},this.hasTopic=function(e){return!!t[e]},this.unwatchAll=function(e){return t[e]?delete t[e]:t={},!0}}}),define("StateMachine",["Tools"],function(e){function t(){var t={};this.add=function(e,i,s,n){var a=[];return t[e]?!1:"string"==typeof e&&"function"==typeof i?(a[0]=i,"object"==typeof s&&(a[1]=s),"string"==typeof s&&(a[2]=s),"string"==typeof n&&(a[2]=n),t[e]=a,!0):!1},this.has=function(e){return!!t[e]},this.get=function(e){return t[e]||!1},this.event=function(i){var s=t[i];return s?(s[0].apply(s[1],e.toArray(arguments).slice(1)),s[2]):!1}}return function(i,s){var n={},a="";this.init=function(e){return n[e]?(a=e,!0):!1},this.add=function(e){return n[e]?n[e]:n[e]=new t},this.get=function(e){return n[e]},this.getCurrent=function(){return a},this.has=function(e){return n.hasOwnProperty(e)},this.advance=function(e){return this.has(e)?(a=e,!0):!1},this.event=function(){var t;return t=n[a].event.apply(n[a].event,e.toArray(arguments)),t===!1?!1:(t&&(n[a].event("exit"),a=t,n[a].event("entry")),!0)},e.loop(s,function(e,t){var i=this.add(t);e.forEach(function(e){i.add.apply(null,e)})},this),this.init(i)}}),define("Promise",["Observable","StateMachine"],function(e,t){return function i(){var s=null,n=null,a=new e,r={Pending:[["fulfill",function(e){s=e,a.notify("fulfill",e)},"Fulfilled"],["reject",function(e){n=e,a.notify("reject",e)},"Rejected"],["toFulfill",function(e){a.watch("fulfill",e)}],["toReject",function(e){a.watch("reject",e)}]],Fulfilled:[["toFulfill",function(e){setTimeout(function(){e(s)},0)}]],Rejected:[["toReject",function(e){setTimeout(function(){e(n)},0)}]]},c=new t("Pending",r);this.fulfill=function(e){return c.event("fulfill",e),this},this.reject=function(e){return c.event("reject",e),this},this.then=function(e,t,a,r){var o=new i;return e instanceof Function?t instanceof Function?c.event("toFulfill",this.makeResolver(o,e)):c.event("toFulfill",this.makeResolver(o,e,t)):c.event("toFulfill",this.makeResolver(o,function(){o.fulfill(s)})),t instanceof Function&&c.event("toReject",this.makeResolver(o,t,a)),a instanceof Function&&c.event("toReject",this.makeResolver(o,a,r)),!(t instanceof Function||a instanceof Function||!c.event("toReject",this.makeResolver(o,function(){o.reject(n)}))),o},this.sync=function(e){return e instanceof Object&&e.then?(e.then(function(e){this.fulfill(e)}.bind(this),function(e){this.reject(e)}.bind(this)),!0):!1},this.makeResolver=function(e,t,i){return function(s){var n;try{n=t.call(i,s),e.sync(n)||e.fulfill(n)}catch(a){e.reject(a)}}},this.getReason=function(){return n},this.getValue=function(){return s},this.getObservable=function(){return a},this.getStateMachine=function(){return c},this.getStates=function(){return r}}}),define("Store",["Observable","Tools"],function(e,t){return function(i){var s=t.clone(i)||{},n=new e,a=new e,r=[],c=function(e){var i=t.objectsDiffs(e,s);["updated","deleted","added"].forEach(function(e){i[e].forEach(function(t){n.notify(e,t,s[t]),a.notify(t,s[t],e)})})};this.count=this.getNbItems=function(){return s instanceof Array?s.length:t.count(s)},this.get=function(e){return s[e]},this.has=function(e){return s.hasOwnProperty(e)},this.set=function(e,t){var i,r;return"undefined"!=typeof e?(i=this.has(e),r=this.get(e),s[e]=t,i=i?"updated":"added",n.notify(i,e,s[e],r),a.notify(e,s[e],i,r),!0):!1},this.update=function(e,i,s){var r;return this.has(e)?(r=this.get(e),t.setNestedProperty(r,i,s),n.notify("updated",i,s),a.notify(e,r,"updated"),!0):!1},this.del=function(e){return this.has(e)?(this.alter("splice",e,1)||(delete s[e],n.notify("deleted",e),a.notify(e,s[e],"deleted")),!0):!1},this.delAll=function(e){return e instanceof Array?(e.sort(t.compareNumbers).reverse().forEach(this.del,this),!0):!1},this.alter=function(e){var i,n;return s[e]?(n=t.clone(s),i=this.proxy.apply(this,arguments),c(n),i):!1},this.proxy=function(e){return s[e]?s[e].apply(s,Array.prototype.slice.call(arguments,1)):!1},this.watch=function(e,t,i){return n.watch(e,t,i)},this.unwatch=function(e){return n.unwatch(e)},this.getStoreObservable=function(){return n},this.watchValue=function(e,t,i){return a.watch(e,t,i)},this.unwatchValue=function(e){return a.unwatch(e)},this.getValueObservable=function(){return a},this.loop=function(e,i){t.loop(s,e,i)},this.reset=function(e){if(e instanceof Object){var i=t.clone(s);return s=t.clone(e)||{},c(i),!0}return!1},this.compute=function(e,i,s,n){return"string"!=typeof e||"object"!=typeof i||"function"!=typeof s||this.isCompute(e)?!1:(r[e]=[],t.loop(i,function(t){r[e].push(this.watchValue(t,function(){this.set(e,s.call(n))},this))},this),this.set(e,s.call(n)),!0)},this.removeCompute=function(e){return this.isCompute(e)?(t.loop(r[e],function(e){this.unwatchValue(e)},this),this.del(e),!0):!1},this.isCompute=function(e){return!!r[e]},this.toJSON=function(){return JSON.stringify(s)},this.dump=function(){return s}}}),define("Transport",[],function(){return function(e){var t=null;this.setReqHandlers=function(e){return e instanceof Object?(t=e,!0):!1},this.getReqHandlers=function(){return t},this.request=function(e,i,s,n){return t.has(e)&&"undefined"!=typeof i?(t.get(e)(i,function(){s&&s.apply(n,arguments)}),!0):!1},this.listen=function(e,i,s,n){if(t.has(e)&&"undefined"!=typeof i&&"function"==typeof s){var a,r=function(){s.apply(n,arguments)};return a=t.get(e)(i,r,r),function(){"function"==typeof a?a():"object"==typeof a&&"function"==typeof a.func&&a.func.call(a.scope)}}return!1},this.setReqHandlers(e)}});