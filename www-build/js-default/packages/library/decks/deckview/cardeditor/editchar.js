/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(f,l){var c=new e,h=t.get("user"),p=t.get("labels"),d={_id:"",default_lang:h.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:h.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},v=new n,m={},g=new s({error:""}),y,b=87,w=87,E=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=b/t,t=b):(t*=w/n,n=w),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},S=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=b,o=w,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},x=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=y;t.append("type",n),t.append("dir",r),t.append("filename",v.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){e.response!=="ok"&&console.log(e)})},T=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return v.setTransport(t.get("transport")),c.plugins.addAll({label:new r(p),model:new r(v,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=p.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))},setAge:function(e){!e&&e!==0&&(this.innerHTML="",this.setAttribute("placeholder","age"))},setCity:function(e){var t="";e&&e.length?(t=e.split(",")[0].trim(),this.value=t):this.value=""},setCountry:function(e){var t="";e&&e.length?(t=e.split(",").slice(1,e.length).join().trim(),this.value=t):this.value=""},setFamilyStatus:function(e){if(e||e===0)this.selectedIndex=e},setChildren:function(e){if(e||e===0)this.selectedIndex=e},setChildrenlbl:function(e){e&&e==="1"?this.innerHTML=p.get("onechildlbl"):this.innerHTML=p.get("childrenlbl")},setSituation:function(e){e&&e.length&&(this.selectedIndex=e[0])},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setComment:function(e){var t=this,n=t.getAttribute("name");[0,1].forEach(function(r){e&&e[r]&&n.search(r)>0&&(t.value=e[r])})}}),error:new r(g),editevent:new i(c)}),c.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl"></div></span><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl"></div></div></div>',c.reset=function(n,r){var i=new Date;y=null,g.set("error",""),m={},v.reset(),r==="newcard"?(v.reset(d),v.set("_id","C:"+i.getTime()),v.set("created_on",[i.getFullYear(),i.getMonth(),i.getDate()]),v.set("deck",[n])):v.sync(t.get("db"),r)},c.clearDefault=function(t,n){var r=n.getAttribute("name");v.get(r)===""&&(n.innerHTML="")},c.updateTitle=function(t,n){var r=n.innerHTML;r=r.charAt(0).toUpperCase()+r.slice(1),v.set("title",r)},c.selectpress=function(e,t){t.value=""},c.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},c.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=c.dom.querySelector(".cardpicture"),s=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){S(E(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),y=e})},300)},n.readAsDataURL(t.files[0])},c.updateField=function(e,t){var n=t.getAttribute("name"),r,i,s;m[n]=t.value},c.updateLocation=function(e,t){var n=v.get("location"),r,i;r=c.dom.querySelector("input[name='city']").value||"",i=c.dom.querySelector("input[name='country']").value||"",r&&i?n=r+", "+i:n=r+i,m.location=n},c.updateFamily=function(e,t){var n=t.getAttribute("name"),r=v.get("family");r[n]=t.selectedIndex,m.family=r},c.updateJob=function(e,t){var n=v.get("occupation"),r=t.getAttribute("name"),i;switch(r){case"situation":n.details[0]=t.selectedIndex;break;case"job":n.details[1]=t.value;break;case"organization":n.details[2]=t.value;break;default:n.description=t.value}m.occupation=n},c.updateLeisureName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("leisure_activities");i[r].name=t.value,m.leisure_activities=i},c.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("leisure_activities");i[r].comment=t.value,m.leisure_activities=i},c.updateInterestName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("interests");i[r].name=t.value,m.interests=i},c.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("interests");i[r].comment=t.value,m.interests=i},c.updateComments=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=v.get("comments");i[r]=t.value,m.comments=i},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){l()},c.upload=function(e,n){var r=new Date,i=v.get("firstname"),s=v.get("lastname");n.classList.remove("pressed"),g.set("error",""),T.spin(n),v.get("title")||(i&&s?v.set("title",i+" "+s):(i||s)&&v.set("title",i+s)),v.get("title")||g.set("error",p.get("titlerequired")),g.get("error")?T.stop():v.get("_rev")?(v.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),c.uploadCard(n)):v.sync(t.get("db"),v.get("_id")).then(function(){console.log("new card created : ",v.toJSON()),c.uploadCard()})},c.uploadCard=function(t){var n;y&&(x(),v.set("picture_file",v.get("_id")));if(m!=={})for(n in m)v.set(n,m[n]);v.upload().then(function(){return console.log("card upload successful :",v.get("_rev")),f(v.get("type"),v.get("_id"))}).then(function(){T.stop(),l(),v.unsync(),v.reset({})})},MODEL=v,c}});