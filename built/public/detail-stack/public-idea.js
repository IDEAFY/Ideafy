/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin","lib/spin.min"],function(e,t,i,n,s,a,r,o,c,l,d,u,p,g,h){return function(v){var m,b=new e,f=new c,y=new l("public"),w=o.get("labels"),L=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),k=!1,S=o.get("user"),T=o.get("transport"),M=new p,A=s.get("public-detail");return new d,M.setTransport(T),b.plugins.addAll({label:new i(w),publicdetail:new i(M,{toggleFavEdit:function(e){var t=this;e.indexOf(S.get("_id"))>-1?t.setAttribute("href","#public-edit"):(t.setAttribute("href","#public-favorites"),S.get("public-favorites")&&S.get("public-favorites").indexOf(M.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav"),S.watchValue("public-favorites",function(e){e.indexOf(M.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav")}))},toggleTwocentShare:function(e){e.indexOf(S.get("_id"))>-1?this.setAttribute("href","#public-share"):this.setAttribute("href","#public-2cents")},displayWriteTwocent:function(e){e.indexOf(S.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("public-writetwocents").classList.add("invisible")},date:function C(C){C&&(this.innerHTML=a.formatDate(C))},setAuthor:function(e){this.innerHTML=e===S.get("username")&&M.get("authors").indexOf(S.get("_id"))>-1?w.get("youlbl"):e},setWrotelbl:function(e){this.innerHTML=1===e.length&&e[0]===S.get("_id")?w.get("youwrotelbl"):e.length>1?w.get("theywrotelbl"):w.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),i=new r(e);i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setRating:function(e){this.innerHTML=0===e.length?"":Math.round(100*(e.reduce(function(e,t){return e+t})/e.length))/100},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setSolution:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=M.get("_id"),i=M.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),S.get("rated_ideas").indexOf(t)<0&&i.indexOf(S.get("_id"))<0&&!k?(this.setAttribute("name","vote"),this.innerHTML=w.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(k=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),this.innerHTML=0===e.length?"("+w.get("novotesyet")+")":1===e.length?"("+w.get("onevote")+")":"("+e.length+" "+w.get("votes")+")",this.classList.add("votes"))}}),vote:new i(L,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",i="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",i)}}),place:new g({PublicTwocentUI:y}),publicdetailevent:new n(b)}),b.template='<div class="public-idea"><div class="header blue-dark"><a href="#public-2cents" data-publicdetail="bind: toggleTwocentShare, authors" data-publicdetailevent="listen: touchstart, action" class="option left"></a><span data-label="bind: innerHTML, publicdetailsheadertitle"></span><a href="#public-favorites" data-publicdetail="bind: toggleFavEdit, authors" data-publicdetailevent="listen: touchstart, action" class="option right"></a></div><div id="idea-cache"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-publicdetail="bind:setAvatar, authors"></div><h2 data-publicdetail="bind:innerHTML,title"></h2><span class="date" data-publicdetail="bind:date, creation_date"></span><br><span class="author" data-publicdetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-publicdetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><legend class="idealegend" data-label="bind:innerHTML, principle"></legend><p class="ideap" data-publicdetail="bind:setDescription,description"></p><legend class="idealegend" data-label="bind:innerHTML, solution"></legend><p class="ideap" data-publicdetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class ="rateIdea"><a class="item-acorn"></a><div class="rating" data-publicdetail="bind:setRating,votes"></div><div class="publicButton" data-publicdetail="bind:toggleVoteButton, votes" name="vote" data-publicdetailevent="listen: touchstart, press; listen: touchend, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-publicdetailevent="listen: touchstart, previewVote; listen: touchend, castVote"></li></ul></div></div></div></div><div id="public-writetwocents" class="invisible" data-publicdetail="bind: displayWriteTwocent, authors"></div><div id="public-twocents" class="twocents" data-publicdetail="bind: displayTwocentList, twocents" data-place="place: PublicTwocentUI"></div></div>',b.showCache=function(){b.dom.querySelector("#idea-cache").classList.remove("invisible")},b.hideCache=function(){b.dom.querySelector("#idea-cache").classList.add("invisible")},b.reset=function(e,t){var i=e.get(t).id,n=new u;return L.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),b.getIdea(i).then(function(){k=!1,f.reset(M.get("_id")),y.reset(M.get("_id")),m=document.getElementById("public-writetwocents"),f.place(m),n.fulfill()}),n},b.getIdea=function(e){return M.unsync(),M.reset(),M.sync(o.get("db"),e)},b.action=function(e,t){var i,n,s=t.getAttribute("href"),a=M.get("_id"),r=new h({color:"#FFFFFF",lines:8,length:6,width:3,radius:6,left:3,top:3});switch(s){case"#public-2cents":f.reset(a),m.classList.remove("invisible");break;case"#public-favorites":t.classList.add("favwait"),r.spin(t),i=S.get("public-favorites")?S.get("public-favorites").concat():[],n=i.indexOf(a),n>-1?i.splice(n,1):i.push(a),i.length<100||i.length<S.get("public-favorites").length?(S.unsync(),S.sync(o.get("db"),S.get("_id")).then(function(){return S.set("public-favorites",i),S.upload()}).then(function(){r.stop(),t.classList.remove("favwait"),n>-1?(alert(w.get("removedfav")),t.classList.remove("unfav")):(alert(w.get("addedfav")),t.classList.add("unfav"))})):(alert(w.get("maxfavsize")),r.stop(),t.classList.remove("favwait"));break;default:v(s)}},b.edit=function(){_stack.getStack().show("#public-edit")},b.press=function(e,t){t.classList.add("pressed")},b.vote=function(e,t){k||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},b.previewVote=function(e,t){var i=t.getAttribute("data-vote_id");L.loop(function(e,t){i>=t?L.update(t,"active",!0):L.update(t,"active",!1)})},b.castVote=function(e,t){var i=parseInt(t.getAttribute("data-vote_id"))+1,n=M.get("_id"),s={id:n,vote:i,voter:S.get("_id")};k||(k=!0,T.request("Vote",s,function(e){var t=S.get("rated_ideas")||[];"ok"!==e?(console.log(e,"something went wrong, please try again later"),k=!1):(t.unshift(n),S.set("rated_ideas",t),alert(o.get("labels").get("thankyou")),o.get("observer").notify("update-polling"),document.getElementById("ratingPopup").classList.remove("appear"),L.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},b.place(A),b}});