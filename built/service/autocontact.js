/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,s,a,r){function o(e,t,o){var c=this,d=a.get("user"),u=!1,p=new r([]);c.plugins.addAll({auto:new n(p,{setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")},setType:function(e){"group"===e?this.classList.add("group"):this.classList.remove("group")}}),select:new s(c)}),c.template='<div class = "autocontact"><div class="autoclose" data-select="listen:touchstart,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:setType, type; bind:setSelected, selected" data-select="listen:touchstart, select"></li></ul></div>',c.init=function(){var e=d.get("connections"),n=[],s=[],a={};for(p.reset([]),i=0,l=e.length;l>i;i++)n.push(e[i].username),a[e[i].username]=e[i].type;if(n.sort().forEach(function(e){p.alter("push",{username:e,type:a[e]})}),t.value)for(s=t.value.split(/,|;/),i=0,l=s.length;l>i;i++)s[i]=s[i].trim();p.loop(function(e,t){s.indexOf(e.username)>-1?p.update(t,"selected",!0):p.update(t,"selected",!1)})},c.updateList=function(){var e,n;if(t.value){if(u=!0,e=t.value.split(/,|;/),n=e[e.length-1].trim().toLowerCase(),p.reset([]),d.get("connections").forEach(function(e){0===e.username.toLowerCase().search(n)&&p.alter("push",{username:e.username,type:e.type})}),t.value)for(currentList=t.value.split(/,|;/),i=0,l=currentList.length;l>i;i++)currentList[i]=currentList[i].trim();p.loop(function(e,t){currentList.indexOf(e.username)>-1?p.update(t,"selected",!0):p.update(t,"selected",!1)})}},c.close=function(t){t.stopPropagation(),e.classList.add("invisible")},c.select=function(e,t){var i=t.getAttribute("data-auto_id"),n=p.get(i).selected;p.update(i,"selected",!n),n?c.remove(p.get(i)):c.add(p.get(i))},c.add=function(e){var n;if("user"===e.type)if(u){var s=t.value.split(/,|;/),a="";for(s.forEach(function(e){e=e.trim()}),s.pop(),i=0,l=s.length;l>i;i++)a+=s[i]+", ";a+=e.username,t.value=a,u=!1}else t.value?t.value+=", "+e.username:t.value=e.username;else d.get("connections").forEach(function(t){t.username===e.username&&(n=t.contacts)}),n.forEach(function(e){t.value.search(e.username)<0&&(c.add(e),p.loop(function(t,i){t.username===e.username&&p.update(i,"selected",!0)}))});o(t.value)},c.remove=function(e){var n,s="";if("user"===e.type){for(n=t.value.split(/,|;/),i=0,l=n.length;l>i;i++)n[i]=n[i].trim();n.splice(n.indexOf(e.username),1),n.forEach(function(e){s+=e+", "}),t.value=s.substr(0,s.length-2),o(s.substr(0,s.length-2)),p.loop(function(t,i){"group"===t.type&&t.selected&&d.get("connections").forEach(function(n){n.username===t.username&&JSON.stringify(n).search(e.username)>-1&&p.update(i,"selected",!1)})})}else d.get("connections").forEach(function(t){t.username===e.username&&t.contacts.forEach(function(e){p.loop(function(t,i){t.username===e.username&&p.update(i,"selected",!1)}),c.remove(e)})})},c.init(),c.render(),c.place(e)}return function(t,i,n){return o.prototype=new e,new o(t,i,n)}});