/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","Olives/Model-plugin","Olives/Event-plugin","service/config","Store","CouchDBStore","Promise","service/new2c"],function(e,t,n,r,i,s,o,u){function a(e,a,f,c){var h=new i([]),p=a.offsetHeight,d=new i({height:p}),v=10,m=r.get("user"),g=r.get("labels"),y=r.get("observer"),b=r.get("transport"),w,E=this;this.plugins.addAll({buttons:new t(h,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(d,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-v)+"px;")},setButtons:function(e){var t=Math.floor((e-v-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new n(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:mouseup, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:mousedown, press; listen:mouseup, action"></li></ul></div>',this.hide=function(e,t){c(this)},this.press=function(e,t){t.classList.add("pressed")},this.action=function(e,t){var n=t.getAttribute("data-buttons_id"),i=h.get(n).name;e.stopPropagation(),t.classList.remove("pressed");switch(i){case"delete":this.deleteItem().then(function(){c(E)});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":r.get("observer").notify("replay-session",f.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();default:}},w=function(e,t){switch(e){case"idea":t.authors.indexOf(m.get("_id"))>-1&&h.alter("push",{name:"edit",icon:"img/wall/35modify.png"}),t.sessionId&&(t.sessionReplay||t.authors.indexOf(m.get("_id"))>-1)&&h.alter("push",{name:"replay",icon:"img/library/25goToSession.png"}),h.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(m.get("_id"))>-1&&(m.get("connections")&&m.get("connections").length?h.alter("push",{name:"share",icon:"img/wall/35share.png"}):(m.get("facebook")||m.get("twitter")||m.get("gplus")||m.get("linkedin"))&&h.alter("push",{name:"share",icon:"img/wall/35share.png"})),t.authors.length===1&&t.authors[0]===m.get("_id")&&!t.twocents.length&&!t.sharedwith.length&&t.visibility!=="public"&&h.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),t.authors.indexOf(m.get("_id"))===-1&&t.sharedwith.indexOf(m.get("_id"))>-1&&document.getElementById("library")&&h.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"message":h.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),h.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":h.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.type==="user"&&h.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),h.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:}},this.deleteItem=function(){var n=new o,i=new s;i.setTransport(b);switch(e){case"idea":f.authors.length===1&&f.authors[0]===m.get("_id")?i.sync(r.get("db"),f._id).then(function(){i.remove(),n.resolve()}):b.request("RemoveFromLibrary",{id:f._id,userid:m.get("_id")},function(e){});break;case"message":var u=m.get("notifications"),a,c;for(a=0,l=u.length;a<l;a++)if(JSON.stringify(u[a])===JSON.stringify(f)){c=a;break}u.splice(c,1),m.set("notifications",u),m.upload();break;case"contact":var u=m.get("connections"),h=new Date,p=[h.getFullYear(),h.getMonth(),h.getDate(),h.getHours(),h.getMinutes(),h.getSeconds()];if(f.type==="user"){for(a=u.length-1;a>=0;a--)if(u[a].type==="user"&&u[a].userid===f.userid)u.splice(a,1);else if(u[a].type==="group"){var d=u[a].contacts;for(j=d.length-1;j>=0;j--)d[j].userid===f.userid&&d.splice(j,1)}}else for(a=u.length-1;a>=0;a--)u[a].username===f.username&&u.splice(a,1);m.set("connections",u),f.type==="user"&&m.get("news").unshift({type:"CX-",date:p,content:{userid:f.userid,username:f.username}}),m.upload().then(function(){if(f.type==="user"){var e=new Date,t={dest:[f.userid],date:p,original:"",type:"CXCancel",author:m.get("_id"),username:m.get("username"),firstname:m.get("firstname"),toList:f.username,ccList:"",object:m.get("username")+g.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:m.get("firstname"),lastname:m.get("lastname"),userid:m.get("_id"),username:m.get("username"),intro:m.get("intro"),type:"user"}};b.request("Notify",t,function(e){console.log(e)})}y.notify("contact-deleted")});break;default:}return n},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?y.notify("public-edit",f._id):y.notify("library-edit",f._id);break;default:}},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?y.notify("public-sendmail",f):y.notify("library-sendmail",f);break;case"message":break;case"contact":y.notify("message-contact",f);break;default:}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?y.notify("public-share",f):y.notify("library-share",f);break;case"message":break;case"contact":break;default:}},this.sendTwocent=function(){u.reset(f)},w(e,f)}return function(n,r,i,s){return a.prototype=new e,new a(n,r,i,s)}});