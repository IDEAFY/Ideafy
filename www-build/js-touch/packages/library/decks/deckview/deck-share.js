/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(u){var a=new e,f=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:p.get("signature")}),g=new o([]),y=new o([]),b=!1,w=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return a.plugins.addAll({labels:new r(v),share:new r(m,{setHeader:function(e){this.innerHTML=v.get("sharing")+e}}),contacts:new r(y,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(g,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(a),errormsg:new r(f)}),a.template='<div class="deck-share invisible"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: touchstart, press; listen:touchend, selectAll">Select all</div><input class="search" data-shareevent="listen:touchstart, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:touchstart,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:touchend, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:touchstart, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: touchstart, press; listen:touchend, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:touchstart, press; listen:touchend, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',a.show=function(){a.dom.classList.remove("invisible"),document.getElementById("deckview").setAttribute("style","overflow-y: scroll;")},a.hide=function(){a.dom.classList.add("invisible"),document.getElementById("deckview").setAttribute("style","overflow-y: none;"),m.reset({body:"",docId:"",docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),f.reset({errormsg:""}),y.reset([]),g.reset(p.get("connections").concat())},a.reset=function(t){f.reset({errormsg:""}),m.reset({body:"",docId:t,docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),a.getDocDetails(t),p.get("signature")&&m.set("signature",p.get("signature")),y.reset([]),g.reset(p.get("connections").concat())},a.getDocDetails=function(t){var r=new l({});r.setTransport(d),r.sync(n.get("db"),t).then(function(){m.set("docType",r.get("type")),m.set("docTitle",r.get("title")),r.unsync()})},a.updateAutoContact=function(e,t){var n=JSON.parse(g.toJSON()),r=p.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")g.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);g.reset(n)}g.loop(function(e,t){y.toJSON().search(e.userid)>-1&&g.update(t,"selected",!0)})},a.close=function(t,n){n.parentNode.classList.add("invisible")},a.displayAutoContact=function(e,t){a.dom.querySelector("#sharelistauto").classList.remove("invisible"),g.reset(p.get("connections").concat())},a.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=y.get(n).userid;y.alter("splice",n,1),g.loop(function(e,t){e.userid===r&&setTimeout(function(){g.update(t,"selected",!1)},200)}),a.unselectGroup(r)},a.select=function(e,t){var n=t.getAttribute("data-auto_id");g.get(n).selected?(a.removeContact(g.get(n)),setTimeout(function(){g.update(n,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(a.addContact(g.get(n)),a.selectGroup(),setTimeout(function(){g.update(n,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},a.selectAll=function(e,t){t.classList.remove("pressed"),y.reset([]),g.reset(p.get("connections").concat()),g.loop(function(e,t){g.update(t,"selected",!0),e.type==="user"&&y.alter("push",e)})},a.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)a.removeContact(e.contacts[j]);else y.loop(function(t,n){t.userid===e.userid&&y.alter("splice",n,1)}),a.unselectGroup(e.userid),g.loop(function(t,n){t.userid===e.userid&&g.update(n,"selected",!1)})},a.selectGroup=function(){var e,t=!1;g.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(y.toJSON().search(e[j].userid)<0){t=!1;break}t&&g.update(r,"selected",!0)}})},a.unselectGroup=function(e){g.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&g.update(n,"selected",!1)})},a.addContact=function(e){var t,n,r=!0;if(e.type==="user")y.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)y.loop(function(n,s){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(y.alter("push",e.contacts[t]),g.loop(function(n,r){n.userid===e.contacts[t].userid&&g.update(r,"selected",!0)}))},a.press=function(e,t){t.classList.add("pressed")},a.share=function(e,t){var n=new Date,r=new c,i={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:p.get("_id"),username:p.get("username"),firstname:p.get("firstname"),toList:"",ccList:"",object:"",body:m.get("body"),signature:m.get("signature"),docId:m.get("docId"),docType:m.get("docType"),docTitle:m.get("docTitle"),dest:[]};b||(b=!0,w.spin(t),a.buildRecipientList(i.docId,i.dest).then(function(){i.dest.length?(d.request("ShareDeck",{idList:i.dest,docId:i.docId},function(e){e==="ok"&&r.fulfill()}),r.then(function(){d.request("Notify",i,function(e){f.set("errormsg",v.get("shareok")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(i.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),a.hide()},2500)})})):(f.set("errormsg",v.get("alreadyshared")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(i.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),a.hide()},2500))}))},a.cancel=function(e,t){t.classList.remove("pressed"),a.hide()},a.buildRecipientList=function(t,r){var i=new c,s=new l;return s.setTransport(d),s.sync(n.get("db"),t).then(function(){var e=s.get("sharedwith")||[],t;return y.loop(function(t,n){e.length?e.indexOf(t.userid)<0&&(e.push(t.userid),r.push(t.userid)):(e.push(t.userid),r.push(t.userid))}),s.set("sharedwith",e),s.upload()}).then(function(){i.fulfill()}),i},a}});