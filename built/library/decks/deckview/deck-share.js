/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,s,a,r,o,c,l,d,u,p){return function(){var t=new e,o=new r({errormsg:""}),c=n.get("user"),l=n.get("transport"),h=n.get("labels"),g=new r({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:c.get("signature")}),f=new r([]),m=new r([]),v=!1,b=new p({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6}).spin();return t.plugins.addAll({labels:new s(h),share:new s(g,{setHeader:function(e){this.innerHTML=h.get("sharing")+e}}),contacts:new s(m,{setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),auto:new s(f,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new a(t),errormsg:new s(o)}),t.template='<div class="deck-share invisible"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: touchstart, press; listen:touchend, selectAll">Select all</div><input class="search" data-shareevent="listen:touchstart, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:touchstart,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:touchend, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:touchstart, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: touchstart, press; listen:touchend, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:touchstart, press; listen:touchend, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',t.show=function(){t.dom.classList.remove("invisible"),document.getElementById("deckview").setAttribute("style","overflow-y: scroll;")},t.hide=function(){t.dom.classList.add("invisible"),document.getElementById("deckview")&&document.getElementById("deckview").setAttribute("style","overflow-y: none;"),g.reset({body:"",docId:"",docType:"",docTitle:"",signature:c.get("username")+" <"+c.get("_id")+">"}),o.reset({errormsg:""}),m.reset([]),f.reset(c.get("connections").concat())},t.reset=function(e){o.reset({errormsg:""}),g.reset({body:"",docId:e,docType:"",docTitle:"",signature:c.get("username")+" <"+c.get("_id")+">"}),t.getDocDetails(e),c.get("signature")&&g.set("signature",c.get("signature")),m.reset([]),f.reset(c.get("connections").concat())},t.getDocDetails=function(e){var t=new d({});t.setTransport(l),t.sync(n.get("db"),e).then(function(){g.set("docType",t.get("type")),g.set("docTitle",t.get("title")),t.unsync()})},t.updateAutoContact=function(e,t){var n,s=JSON.parse(f.toJSON()),a=c.get("connections").concat(),r=t.value.toLowerCase();if(""===t.value)f.reset(a);else{for(i=s.length-1;i>=0;i--)n=s[i].username.toLowerCase(),0!==n.search(r)&&s.splice(i,1);f.reset(s)}f.loop(function(e,t){m.toJSON().search(e.userid)>-1&&f.update(t,"selected",!0)})},t.close=function(e,t){t.parentNode.classList.add("invisible")},t.displayAutoContact=function(){t.dom.querySelector("#sharelistauto").classList.remove("invisible"),f.reset(c.get("connections").concat())},t.discardContact=function(e,n){var i=n.getAttribute("data-contacts_id"),s=m.get(i).userid;m.alter("splice",i,1),f.loop(function(e,t){e.userid===s&&setTimeout(function(){f.update(t,"selected",!1)},200)}),t.unselectGroup(s)},t.select=function(e,n){var i=n.getAttribute("data-auto_id");f.get(i).selected?(t.removeContact(f.get(i)),setTimeout(function(){f.update(i,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(t.addContact(f.get(i)),t.selectGroup(),setTimeout(function(){f.update(i,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},t.selectAll=function(e,t){t.classList.remove("pressed"),m.reset([]),f.reset(c.get("connections").concat()),f.loop(function(e,t){f.update(t,"selected",!0),"user"===e.type&&m.alter("push",e)})},t.removeContact=function(e){if("group"===e.type)for(j=e.contacts.length-1;j>=0;j--)t.removeContact(e.contacts[j]);else m.loop(function(t,n){t.userid===e.userid&&m.alter("splice",n,1)}),t.unselectGroup(e.userid),f.loop(function(t,n){t.userid===e.userid&&f.update(n,"selected",!1)})},t.selectGroup=function(){var e,t=!1;f.loop(function(n,i){if("group"===n.type&&!n.selected){for(e=n.contacts,t=!0,j=e.length-1;j>=0;j--)if(m.toJSON().search(e[j].userid)<0){t=!1;break}t&&f.update(i,"selected",!0)}})},t.unselectGroup=function(e){f.loop(function(t,n){"group"===t.type&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&f.update(n,"selected",!1)})},t.addContact=function(e){var t,n,i=!0;if("user"===e.type)m.alter("push",e);else for(t=0,n=e.contacts.length;n>t;t++)m.loop(function(n){n.userid===e.contacts[t].userid&&(i=!1)}),i&&(m.alter("push",e.contacts[t]),f.loop(function(n,i){n.userid===e.contacts[t].userid&&f.update(i,"selected",!0)}))},t.press=function(e,t){t.classList.add("pressed")},t.share=function(e,n){var i=new Date,s=new u,a={type:"DOC",status:"unread",date:[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getMinutes()],author:c.get("_id"),username:c.get("username"),firstname:c.get("firstname"),toList:"",ccList:"",object:"",body:g.get("body"),signature:g.get("signature"),docId:g.get("docId"),docType:g.get("docType"),docTitle:g.get("docTitle"),dest:[]};v||(v=!0,b.spin(n),t.buildRecipientList(a.docId,a.dest).then(function(){a.dest.length?(l.request("ShareDeck",{idList:a.dest,docId:a.docId},function(e){"ok"===e&&s.fulfill()}),s.then(function(){l.request("Notify",a,function(){o.set("errormsg",h.get("shareok")),n.classList.remove("pressed"),v=!1,setTimeout(function(){b.stop(),t.reset(a.docId),t.dom.querySelector("#sharelistauto").classList.add("invisible"),f.reset(c.get("connections").concat()),t.hide()},2500)})})):(o.set("errormsg",h.get("alreadyshared")),n.classList.remove("pressed"),v=!1,setTimeout(function(){b.stop(),t.reset(a.docId),t.dom.querySelector("#sharelistauto").classList.add("invisible"),f.reset(c.get("connections").concat()),t.hide()},2500))}))},t.cancel=function(e,n){n.classList.remove("pressed"),t.hide()},t.buildRecipientList=function(e,t){var i=new u,s=new d;return s.setTransport(l),s.sync(n.get("db"),e).then(function(){var e=s.get("sharedwith")||[];return m.loop(function(n){e.length?e.indexOf(n.userid)<0&&(e.push(n.userid),t.push(n.userid)):(e.push(n.userid),t.push(n.userid))}),s.set("sharedwith",e),s.upload()}).then(function(){i.fulfill()}),i},t}});