/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Amy/Stack-plugin","Olives/Model-plugin","Olives/Event-plugin","./quickstart","./quicksetup","./quickscenario","./quicktech","./quickidea","./quickwrapup","CouchDBStore","service/config","Promise","Store"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(v,m){var g=new e,y=new e,b=document.createDocumentFragment(),w=t.get("ideafy-quick"),E=new n,S=h.get("labels"),x=new d([{name:"quickstart",label:S.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}]),T=h.get("user"),N=new c;return _sessionData=new d,y.plugins.addAll({labels:new r(S),step:new r(x,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(y)}),y.template='<div class = "progressbar"><ul id = "quicksteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',y.place(b),g.plugins.add("quickstack",E),g.alive(w),y.changeStep=function(e,t){var n=t.getAttribute("data-step_id");x.get(n).status?(x.loop(function(e,t){n==t?x.update(t,"currentStep",!0):x.update(t,"currentStep",!1)}),E.getStack().show(x.get(n).name)):e.stopImmediatePropagation()},y.press=function(e,t){t.classList.add("pressed")},y.exit=function(e,t){t.classList.remove("pressed"),m()},g.retrieveSession=function(t){_sessionData.reset(),N.unsync(),N.reset(),N.sync(h.get("db"),t.id).then(function(){var e=N.get("step"),n=1e4,r=x.getNbItems();E.getStack().get("quickstart").reset(t),E.getStack().get("quicksetup").reset(t),E.getStack().get("quickscenario").reset(t),E.getStack().get("quicktech").reset(t),E.getStack().get("quickidea").reset(t),E.getStack().get("quickwrapup").reset(t),x.loop(function(t,r){r<n&&(t.name===e?(n=r,x.update(r,"currentStep",!0),t.name==="quickwrapup"?x.update(r,"status","done"):x.update(r,"status","ongoing")):x.update(r,"status","done"))}),e==="quickwrapup"?(E.getStack().show("quickwrapup"),x.update(0,"currentStep",!1)):(x.update(0,"currentStep",!0),x.update(n,"currentStep",!1),E.getStack().show("quickstart"),N.get("status")!=="completed"&&(T.set("sessionInProgress",t),T.upload()))})},g.startNewSession=function(){N.unsync(),N.reset(h.get("sessionTemplate")),_sessionData.reset({}),N.set("initiator",{id:T.get("_id"),username:T.get("username"),picture_file:T.get("picture_file")}),N.set("mode","quick"),N.set("step","quickstart"),N.set("deck",T.get("active_deck")),E.getStack().get("quickstart").reset(),E.getStack().get("quicksetup").reset(),E.getStack().get("quickscenario").reset(),E.getStack().get("quicktech").reset(),E.getStack().get("quickidea").reset(),E.getStack().get("quickwrapup").reset(),E.getStack().show("quickstart")},g.reset=function(t){x.reset([{name:"quickstart",label:S.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}]),t?g.retrieveSession(t):g.startNewSession()},g.prev=function(t){var n;x.loop(function(e,r){e.name===t&&(n=r)}),n>0?(x.update(n,"currentStep",!1),x.update(n-1,"currentStep",!0),E.getStack().show(x.get(n-1).name)):(alert("Exiting session"),m())},g.next=function(t){var n,r;x.loop(function(e,r){e.name===t&&(n=r)}),n<x.getNbItems()-1&&(x.get(n).status!=="done"?(x.update(n,"status","done"),x.update(n,"currentStep",!1),x.update(n+1,"status","ongoing"),x.update(n+1,"currentStep",!0),N.set("step",x.get(n+1).name),N.upload(),r=E.getStack().get(x.get(n+1).name),r.initTimer&&r.initTimer(),E.getStack().show(x.get(n+1).name)):E.getStack().show(x.get(n+1).name))},g.init=function(t){N.setTransport(h.get("transport")),E.getStack().add("quickstart",new s(N,g.prev,g.next,g.toggleProgress)),E.getStack().add("quicksetup",new o(N,_sessionData,g.prev,g.next,g.toggleProgress)),E.getStack().add("quickscenario",new u(N,_sessionData,g.prev,g.next,g.toggleProgress)),E.getStack().add("quicktech",new a(N,_sessionData,g.prev,g.next,g.toggleProgress)),E.getStack().add("quickidea",new f(N,_sessionData,g.prev,g.next,g.toggleProgress)),E.getStack().add("quickwrapup",new l(N,_sessionData,g.prev,g.next,g.toggleProgress)),g.reset(t)},g.toggleProgress=function(t){var n=t.querySelector(".progressbar");n?setTimeout(function(){t.removeChild(n),y.place(b)},600):t.appendChild(b)},g.init(v),g}});