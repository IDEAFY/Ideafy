/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(f,l){var c=new e,h=t.get("user"),p=t.get("labels"),d={_id:"",default_lang:h.get("lang"),title:"",didYouKnow:"",deck:[],category:"",coefficient:1,sources:[],created_by:h.get("_id"),created_on:[],picture_credit:"",type:null,picture_file:""},v=new n,m=new s({error:""}),g,y=87,b=87,w=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=y/t,t=y):(t*=b/n,n=b),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},E=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=y,o=b,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},S=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=g;t.append("type",n),t.append("dir",r),t.append("filename",v.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){console.log(e)})},x=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return v.setTransport(t.get("transport")),c.plugins.addAll({label:new r(p),model:new r(v,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=p.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},formatTitle:function(e){switch(e){case 2:this.setAttribute("style","background: #5f8f28");break;case 3:this.setAttribute("style","background: #bd262c");break;case 4:this.setAttribute("style","background: #f27b3d");break;default:}},setSources:function(e){e&&e.length?e instanceof Array?this.innerHTML=e.join(", "):this.innerHTML=e:this.innerHTML=""},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))}}),error:new r(m),editevent:new i(c)}),c.template='<div class="cardpopup editcard"><div class="card-detail"><div class="cd-header blue-dark" data-model="bind:formatTitle, type"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class ="cardpicture" data-model="bind:setPic, picture_file"></div><div class="picinfo"><span class="cd-creditslbl"data-label="bind:innerHTML, credits"></span><input type="text" class="input editcredit" data-label="bind: placeholder, picturecredit" data-model="bind:value, picture_credit"></div><button class="choosepic" data-label="bind:innerHTML, importpiclbl" data-editevent="listen: mousedown, press; listen:mouseup, picturePreview"></button><button class="takepic" data-editevent="listen: mousedown, press; listen:mouseup, cameraPreview" data-label="bind:innerHTML, importcameralbl"></button></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><textarea class="input enterdyknow" data-label="bind: placeholder, enterdyknow" data-model="bind:value,didYouKnow"></textarea><span class="cd-sourcelbl" data-label="bind:innerHTML, source"></span><textarea class="input entersources" data-label="bind: placeholder, dyknowsources" data-model="bind: value, sources"></textarea></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl">Save</div></div></div>',c.reset=function(n,r,i){var s=new Date;g=null,m.set("error",""),v.reset(),r==="newcard"?(v.reset(d),v.set("_id","C:"+s.getTime()),v.set("created_on",[s.getFullYear(),s.getMonth(),s.getDate()]),v.set("deck",[n]),i==="contexts"&&(v.set("type",2),v.set("picture_file","img/decks/context.png")),i==="problems"&&(v.set("type",3),v.set("picture_file","img/decks/problem.png")),i==="techno"&&(v.set("type",4),v.set("picture_file","img/decks/techno.png"))):v.sync(t.get("db"),r).then(function(){console.log("card synchronized :",v.toJSON())})},c.changeType=function(t){switch(t){case 1:v.set("type",2),v.set("picture_file","img/decks/context.png");break;case 2:v.set("type",3),v.set("picture_file","img/decks/problem.png");break;case 3:v.set("type",4),v.set("picture_file","img/decks/technology.png");break;default:v.set("type",2),v.set("picture_file","img/decks/context.png")}},c.clearDefault=function(t,n){var r=n.getAttribute("name");v.get(r)===""&&(n.innerHTML="")},c.updateTitle=function(t,n){v.set("title",n.innerHTML)},c.picturePreview=function(e,t){var n=navigator.camera.PictureSourceType.PHOTOLIBRARY,r=new Image,i={quality:50,correctOrientation:!0,sourceType:n},s,o,a=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin(),f=c.dom.querySelector(".cardpicture");s=function(e){r.src=e,f.setAttribute("style","background-image: none"),a.spin(f),setTimeout(function(){E(w(r),function(e){f.setAttribute("style","background-image: url('"+e+"')"),a.stop(),g=e,t.classList.remove("pressed")})},750)},o=function(e){alert("error: "+e)},navigator.camera.getPicture(s,o,i)},c.cameraPreview=function(e,t){var n=new Image,r={quality:50,correctOrientation:!0},i,s,o=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin(),a=c.dom.querySelector(".cardpicture");i=function(e){n.src=e,a.setAttribute("style","background-image: none"),o.spin(a),setTimeout(function(){E(w(n),function(e){a.setAttribute("style","background-image: url('"+e+"')"),g=e,o.stop(),t.classList.remove("pressed")})},750)},s=function(e){alert("error: "+e),t.classList.remove("pressed")},navigator.camera.getPicture(i,s,r)},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),l(),v.unsync(),v.reset({})},c.upload=function(e,n){var r=new Date;n.classList.remove("pressed"),m.set("error",""),x.spin(n),console.log(v.get("title")),(!v.get("title")||v.get("title")==="<br>")&&m.set("error",p.get("titlerequired")),m.get("error")?x.stop():v.get("_rev")?(v.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),c.uploadCard(n)):v.sync(t.get("db"),v.get("_id")).then(function(){console.log("new card created : ",v.toJSON()),c.uploadCard()})},c.uploadCard=function(t){g&&S(),v.upload().then(function(){return console.log("card upload successful :",v.get("_rev")),f(v.get("type"),v.get("_id"))}).then(function(){x.stop(),l(),v.unsync(),v.reset({})})},CARDMODEL=v,UPLOADSPIN=x,c}});