/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","CouchDBDocument","CouchDBView","lib/spin.min"],function(e,t,n,i,s,a,r,o,c){return function(l){var d,u,p=new e,g=new s,h=new s({max:0}),f=new s([]),m=new o,v=new c({top:255,left:297,lines:8,radius:6,color:"#cccccc"}).spin(),b=t.get("user"),y=t.get("labels"),w=new s(t.get("userLanguages")),k=function(){w.loop(function(e,t){g.get("default_lang")&&e.name===g.get("default_lang").substring(0,2)?w.update(t,"selected",!0):w.update(t,"selected",!1)})},L=60,S=60,T=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=L/t,t=L):(t*=S/n,n=S),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},x=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),r=a.getContext("2d"),o=L,c=S;s.src=e,setTimeout(function(){a.width=o,a.height=c,n=Math.floor(Math.max(0,(s.width-o)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),r.drawImage(s,n,i,o,c,0,0,o,c),t(a.toDataURL("image/png"))},300)},M=function(){var e="/upload",t=new FormData,n="deckpic",i=u;t.append("type",n),t.append("dir","decks"),t.append("filename",g.get("_id")),t.append("dataString",i),a.uploadFile(e,t,null,function(e){return e})};return m.setTransport(t.get("transport")),p.plugins.addAll({labels:new n(y),range:new n(h,{setCursorWidth:function(){}}),cards:new n(f,{setStyle:function(e){e&&"null"===e?this.classList.add("invisible"):this.classList.remove("invisible")},formatTitle:function(e){var t,n=this;e&&(t=n.getAttribute("data-cards_id"),f.get(t).type&&4!==f.get(t).type?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var n,i,s=this;e&&e.search("img/decks/")>-1?this.setAttribute("style","background-image:url('"+e+"');"):e?(i=new c({color:"#657b99"}).spin(s),n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');"),i.stop()})):this.setAttribute("style","background-image: none;")}}),deckdetails:new n(g,{displayLang:function(e){var t;e?(p.dom.querySelector(".idealang").classList.remove("invisible"),t=e.substring(0,2),this.setAttribute("style","background-image:url('img/flags/"+t+".png');")):p.dom.querySelector(".idealang").classList.add("invisible")},formatDate:function(e){this.innerHTML=e?a.formatDate(e):""},setPic:function(e){var n,i,s=this;""===e?this.setAttribute("style","background-image:url('img/connect/graygroup.png');"):"img/logo.png"===e?this.setAttribute("style","background-image:url('img/logo.png');"):"decklogo"===e&&(i=new c({color:"#657b99"}).spin(s),n={dir:"decks",filename:g.get("_id")},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');"),i.stop()}))},edit:function(e){e===b.get("_id")?(this.setAttribute("contenteditable",!0),this.classList.add("editable")):(this.setAttribute("contenteditable",!1),this.classList.remove("editable"))}}),select:new n(w,{setBg:function(e){e&&this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),carouselevent:new i(p),editevent:new i(p)}),p.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="idealang invisible"><div class="currentlang" data-deckdetails="bind: displayLang, default_lang" data-editevent="listen: touchstart, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: touchstart, selectFlag; listen: touchend, setLang"></li></ul></div><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: touchstart, editPic; listen: touchend, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" data-deckdetails="bind:formatDate,date"></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:touchstart, press; listen:touchend, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:touchstart, press; listen:touchend, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"></div><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider invisible" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div>',p.displayCards=function(e){var t,n=[];for(f.reset([]),t=0;5>t;t++)n[t]=m.get(e-2+t)?m.get(e-2+t).value:{style:"null"};f.reset(n),v.stop()},p.updateCards=function(e,t){p.displayCards(t.value)},p.displayButtons=function(){p.dom.querySelector(".cancelmail").classList.remove("invisible"),p.dom.querySelector(".sendmail").classList.remove("invisible")},p.hideButtons=function(){p.dom.querySelector(".cancelmail").classList.add("invisible"),p.dom.querySelector(".sendmail").classList.add("invisible")},p.editPic=function(e,t){g.get("created_by")===b.get("_id")&&(t.setAttribute("style","background-image: url('img/brainstorm/reload.png')"),document.body.onfocus=function(){t.querySelector("input").value.length||(g.set("picture_file",""),g.set("picture_file",d.picture_file)),document.body.onfocus=null})},p.showLang=function(){g.get("created_by")===b.get("_id")&&p.dom.querySelector(".idealang ul").classList.remove("invisible")},p.selectFlag=function(e,t){var n;e.stopPropagation(),e.preventDefault(),n=parseInt(t.getAttribute("data-select_id"),10),w.loop(function(e,t){n===t?w.update(t,"selected",!0):w.update(t,"selected",!1)})},p.setLang=function(e,t){var n;e.stopPropagation(),e.preventDefault(),n=t.getAttribute("data-select_id"),g.set("default_lang",w.get(n).name),g.get("default_lang")!==d.default_lang.substring(0,2)?p.displayButtons():p.hideButtons(),p.dom.querySelector(".idealang ul").classList.add("invisible")},p.changePic=function(e,t){var n,i,s=navigator.camera.PictureSourceType.PHOTOLIBRARY,a=new Image,r={quality:50,correctOrientation:!0,sourceType:s},o=new c({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();n=function(e){a.src=e,t.setAttribute("style","background-image: none"),o.spin(t),setTimeout(function(){x(T(a),function(e){t.setAttribute("style","background-image: url('"+e+"')"),o.stop(),u=e,p.displayButtons()})},750)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(n,i,r)},p.press=function(e,t){t.classList.add("pressed")},p.cancel=function(e,t){g.reset(d),p.hideButtons(),t.classList.remove("pressed")},p.upload=function(e,n){var i=new r,s=p.dom.querySelector(".deckheader h2").innerHTML,a=p.dom.querySelector(".deckdescription").innerHTML,o=new c({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30}).spin(n);n.classList.add("invisible"),i.setTransport(t.get("transport")),i.sync(t.get("db"),g.get("_id")).then(function(){var e=new Date;return u&&(M(),i.set("picture_file","decklogo")),i.set("title",s),i.set("description",a),i.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),i.upload()}).then(function(){l("updated",i.get("_id")),p.hideButtons(),n.classList.remove("pressed"),o.stop()}),u&&M()},p.reset=function(e){var n=p.dom.querySelector(".deckslider");p.dom.querySelector(".cancelmail").classList.add("invisible"),p.dom.querySelector(".sendmail").classList.add("invisible"),u=null,g.reset(e),k(),d=JSON.parse(g.toJSON()),h.set("max",0),v.spin(p.dom.querySelector(".deckcarousel")),m.reset([]),m.sync(t.get("db"),"library","_view/cards",{key:'"'+g.get("_id")+'"'}).then(function(){m.getNbItems()?n.classList.remove("invisible"):n.classList.add("invisible"),m.getNbItems()&&h.set("max",m.getNbItems()-1),m.unsync(),m.alter("sort",function(e,t){var n=e.value.title,i=t.value.title;return i>n?-1:n>i?1:n===i?0:void 0}),p.displayCards(0)})},p}});