/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","CouchDBDocument","CouchDBView","service/config","Promise","Store","./mubinit","./mubwait","./session/mucontroller","lib/spin.min"],function(e,t,i,s,n,a,l,r,o,d,c,u,g){return function(i,s){var a,r,o,m=new e,b=new t,v=l.get("user");return new g({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328}).spin(),m.plugins.add("mustack",b),m.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>',m.place(document.getElementById("ideafy-multi")),m.reset=function(e){e?"join"===e.mode?m.join(e.id):m.replayMUSession(e.id):(r.reset(),b.getStack().show("mubinit"))},m.replayMUSession=function(e){o.reset(e,!0),b.getStack().show("musession")},m.join=function(e){var t=new n;t.setTransport(l.get("transport")),t.sync(l.get("db"),e).then(function(){var i=t.get("participants"),s=!1;i.forEach(function(e){e.id===v.get("_id")&&(s=!0)}),s?"mustart"===t.get("step")?(a.reset(e),b.getStack().show("mubwait")):m.startSession(e):(i.push({id:v.get("_id"),username:v.get("username"),intro:v.get("intro")}),t.set("participants",i),3===i.length&&t.set("status","full"),t.upload().then(function(){a.reset(e),b.getStack().show("mubwait")},function(e){console.log(e),alert("failed to join session")}))},function(e){console.log(e),alert("failed to join session")})},m.startSession=function(e){b.getStack().show("musession"),o.reset(e)},r=new d(s),a=new c(s,m.startSession),o=new u(s),b.getStack().add("mubinit",r),b.getStack().add("mubwait",a),b.getStack().add("musession",o),i?"join"===i.mode?m.join(i.id):m.replayMUSession(i.id):b.getStack().show("mubinit"),l.get("observer").watch("start-mu_session",function(e){a.reset(e),b.getStack().show("mubwait")}),m}});