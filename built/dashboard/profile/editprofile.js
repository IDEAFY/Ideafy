/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","service/avatar","service/utils","Store","lib/spin.min","LocalStore"],function(e,t,s,i,a,n,r,c,o){return function(){var a=new e,l=t.get("user"),d=new r,u=[{name:"azur",file:"img/avatars/deedee0.png",selected:!1},{name:"blue",file:"img/avatars/deedee1.png",selected:!1},{name:"green",file:"img/avatars/deedee2.png",selected:!1},{name:"grey",file:"img/avatars/deedee3.png",selected:!1},{name:"orange",file:"img/avatars/deedee4.png",selected:!1},{name:"red",file:"img/avatars/deedee5.png",selected:!1},{name:"yellow",file:"img/avatars/deedee6.png",selected:!1}],p=new r(u),g={},v=new r({status:null}),m=t.get("labels"),h=new c({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:360}).spin(),b=80,f=80,w=function(e){var t,s,i=document.createElement("canvas"),a=i.getContext("2d");return t=e.width,s=e.height,s>t?(s*=b/t,t=b):(t*=f/s,s=f),i.width=t,i.height=s,a.drawImage(e,0,0,t,s),i.toDataURL("image/png")},y=function(e){var t,s,i=new Image,a=document.createElement("canvas"),n=document.getElementById("avatarcanvas"),r=a.getContext("2d"),c=n.scrollWidth,o=n.scrollHeight;i.src=e,setTimeout(function(){a.width=c,a.height=o,t=Math.floor(Math.max(0,(i.width-c)/2)),s=Math.floor(Math.max(0,(i.height-o)/2)),r.drawImage(i,t,s,c,o,0,0,c,o),d.set("avatar",a.toDataURL("image/png"))},300)},L=function(){var e="/upload",t=new FormData;t.append("type","avatar"),t.append("filename",g.picture_file),t.append("img",d.get("avatar")),n.uploadFile(e,t,v,function(e){"ok"!==e.response&&console.log(e)})};return a.plugins.addAll({label:new s(m),avatars:new s(p,{setPic:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setChecked:function(e){this.innerHTML=e?"&#10003;":""}}),progress:new s(v,{showProgress:function(e){var t=0;e&&(t=Math.floor(80*(e/100))),this.setAttribute("style","width:"+t+"px;"),this.innerHTML=100===e?m.get("uploadcomplete"):""}}),profile:new s(d,{setAvatar:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setDay:function(e){e[2]&&(this.value=e[2])},setMonth:function(e){var t=e[1]||0;this.value=this.options[t].innerHTML},setYear:function(e){e[0]&&(this.value=e[0])},setFamilyStatus:function(e){(e||0===e)&&(this.selectedIndex=e)},setChildren:function(e){(e||0===e)&&(this.selectedIndex=e)},setSituation:function(e){(e||0===e)&&(this.selectedIndex=e)},setLeisureName:function(e){var t=this,s=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&s.search(i)>0&&(t.value=e[i].name)})},setLeisureDesc:function(e){var t=this,s=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&s.search(i)>0&&(t.value=e[i].comment)})},setInterestName:function(e){var t=this,s=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&s.search(i)>0&&(t.value=e[i].name)})},setInterestDesc:function(e){var t=this,s=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&s.search(i)>0&&(t.value=e[i].comment)})}}),editprofileevent:new i(a)}),a.template='<div><div class = "setavatar"><canvas id ="avatarcanvas" class="currentavatar" data-profile="bind:setAvatar, avatar" data-editprofileevent="listen:touchstart, changeAvatar"></canvas><div id="rotate" class="invisible" data-editprofileevent="listen:touchstart, rotateAvatar"></div><div id="changeavatar" class="invisible"><div class="avatarcache"></div><div class="importbutton" data-editprofileevent="listen: touchstart, selectpress; listen:touchend, picturePreview" data-label="bind:innerHTML, importpiclbl"></div><div class="importbutton" data-editprofileevent="listen: touchstart, selectpress; listen:touchend, cameraPreview" data-label="bind:innerHTML, importcameralbl"></div><p data-label="bind:innerHTML, selectavatar"></p><ul class="defaultlist" data-avatars="foreach"><li><div class="defaultAvatar" data-avatars="bind: setPic, file"></div><div class="checkbox" data-avatars="bind: setChecked, selected" data-editprofileevent="listen: touchend, setDefaultAvatar"></div></li></ul></div></div><form class="profileinfo"><div class = "username"><div class = "firstname"><label data-label="bind:innerHTML, firstnameplaceholder"></label><input class="input" name="firstname" type="text" data-profile="bind: value, firstname" data-editprofileevent="listen: input, updateField"></div><div class = "lastname"><label data-label="bind:innerHTML, lastnameplaceholder"></label><input class="input" type="text" name="lastname" data-profile="bind: value, lastname" data-editprofileevent="listen: input, updateField"></div></div><label data-label="bind:innerHTML, profileintro"></label><input class="input" name="intro" type="text" data-profile="bind:value, intro" data-label="bind:placeholder, shortprofiledesc" data-editprofileevent="listen: input, updateField"><label data-label="bind:innerHTML, dob"></label><div class="dob"><input class="day" name="day" type="text" data-label="bind:placeholder, day" data-profile="bind: setDay, birthdate" data-editprofileevent="listen:input, updateDate"><select name="month" data-profile="bind: setMonth, birthdate" data-editprofileevent="listen:change, updateDate"><option data-label="bind:innerHTML, jan"></option><option data-label="bind:innerHTML, feb"></option><option data-label="bind:innerHTML, mar"></option><option data-label="bind:innerHTML, apr"></option><option data-label="bind:innerHTML, may"></option><option data-label="bind:innerHTML, jun"></option><option data-label="bind:innerHTML, jul"></option><option data-label="bind:innerHTML, aug"></option><option data-label="bind:innerHTML, sep"></option><option data-label="bind:innerHTML, oct"></option><option data-label="bind:innerHTML, nov"></option><option data-label="bind:innerHTML, dec"></option></select><input class="year" name="year" type="text" data-label="bind:placeholder,year" data-profile="bind: setYear, birthdate" data-editprofileevent="listen:input, updateDate"></div><div class="postal"><label class="streetaddress" data-label="bind:innerHTML, mailaddress"></label><input class="streetaddress input" name="street1" type="text" data-label="bind:placeholder, street" data-profile="bind:value, address.street1" data-editprofileevent="listen:input, updateAddress"><div class="city"><label data-label="bind:innerHTML, city"></label><input class="input city" name="city" type="text" data-profile="bind:value, address.city" data-editprofileevent="listen:input, updateAddress"></div><div class="zipstate"><div class="state"><label data-label="bind:innerHTML, state"></label><input class="input" name="state" placeholder="" type="text" data-profile="bind:value, address.state" data-editprofileevent="listen:input, updateAddress"></div><div class="zip"><label data-label="bind:innerHTML, zip"></label><input class="input" name="zip" placeholder="" type="text" data-profile="bind:value, address.zip" data-editprofileevent="listen:input, updateAddress"></div></div><label data-label="bind:innerHTML, country"></label><input class="input" name="country" type="text" data-profile="bind:value, address.country" data-editprofileevent="listen:input, updateAddress"></div><label data-label="bind:innerHTML, myfamily"></label><div class="family"><select class="status" name="couple" data-profile="bind: setFamilyStatus, family.couple" data-editprofileevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select><select class="children" name="children" data-profile="bind: setChildren, family.children" data-editprofileevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><label data-label="bind:innerHTML, children"></label></div><label data-label="bind:innerHTML, myoccupation"></label><div class="job"><select class="status" name="situation" data-profile="bind: setSituation, occupation.situation" data-editprofileevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select><div class="jobdesc"><label data-label="bind:innerHTML, jobtitle"></label><input class="input" type="text" name="job" data-profile="bind:value, occupation.job" data-label="bind:placeholder, jobtitle" data-editprofileevent="listen:input, updateJob"></div><div class="org"><label data-label="bind:innerHTML, organization"></label><input class="input" name="organization" type="text" data-profile="bind:value, occupation.organization" data-label="bind:placeholder,organization" data-editprofileevent="listen:input, updateJob"></div></div></form><form class="addtlinfo"><legend data-label="bind:innerHTML, socialnwlbl"></legend><ul class="socialnw"><li class="fb"><input class="input" type="text" name="facebook" data-profile="bind: value, facebook" data-editprofileevent="listen: input, updateField"></li><li class="gp"><input class="input" name="gplus" type="text" data-profile="bind: value, gplus" data-editprofileevent="listen: input, updateField"></li><li class="lin"><input class="input" name="linkedin" type="text" data-profile="bind: value, linkedin" data-editprofileevent="listen: input, updateField"></li><li class="tw"><input class="input" name="twitter" type="text" data-profile="bind: value, twitter" data-editprofileevent="listen: input, updateField"></li></ul><legend data-label="bind:innerHTML, hobbieslbl"></legend><label data-label="bind:innerHTML, name"></label><label class="description" data-label="bind:innerHTML, comment"></label><input name="leisure0" class="input" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input" type="text"  data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input class="input" name="leisure2" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><label data-label="bind:innerHTML, field"></label><label class="description" data-label="bind:innerHTML, comment"></label><input class="input" name="interest0" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest1" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest2" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"></form><div class="useascharacter"></div><p class="update"><label class="cancelprofile" data-label="bind:innerHTML, cancellbl" data-editprofileevent="listen: touchstart, press; listen:touchend, cancel"></label><label class="updateprofile" data-label="bind:innerHTML, updatelbl" data-editprofileevent="listen:touchstart, press; listen:touchend, update"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p><div class="uploadprogress" data-progress="bind:showProgress, status"></div></div>',a.init=function(e){a.reset(),a.place(e)},a.selectpress=function(e,t){t.classList.add("pressed")},a.cameraPreview=function(e,t){var s,i,a=new Image,n={quality:50,correctOrientation:!0};s=function(e){a.src=e,setTimeout(function(){y(w(a)),g.picture_file=l.get("_id")+"_@v@t@r",document.getElementById("changeavatar").classList.add("invisible"),t.classList.remove("pressed")},1e3)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(s,i,n)},a.picturePreview=function(e,t){var s,i,a=navigator.camera.PictureSourceType.PHOTOLIBRARY,n=new Image,r={quality:50,correctOrientation:!0,sourceType:a};s=function(e){n.src=e,setTimeout(function(){y(w(n)),g.picture_file=l.get("_id")+"_@v@t@r",document.getElementById("changeavatar").classList.add("invisible"),t.classList.remove("pressed")},750)},i=function(e){alert("error: "+e)},navigator.camera.getPicture(s,i,r)},a.changeAvatar=function(){document.getElementById("changeavatar").classList.remove("invisible"),v.set("status",0)},a.setDefaultAvatar=function(e,t){var s=t.getAttribute("data-avatars_id");p.loop(function(e,t){t===parseInt(s)?p.update(t,"selected",!0):p.update(t,"selected",!1)}),d.set("avatar",p.get(s).file),g.picture_file=p.get(s).file,document.getElementById("changeavatar").classList.add("invisible")},a.rotateAvatar=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),s=new Image;s.src=d.get("avatar"),setTimeout(function(){e.width=s.width,e.height=s.height,t.translate(e.width/2,e.height/2),t.rotate(Math.PI/2),t.translate(-e.height/2,-e.width/2),t.drawImage(s,0,0),d.set("avatar",e.toDataURL("image/png"))},300)},a.reset=function(){d.reset(JSON.parse(l.toJSON())),d.set("avatar",t.get("avatar")),p.reset(u),g={},d.get("picture_file").search("img/avatars/deedee")>-1&&p.loop(function(e,t){d.get("picture_file").search(e.file)>-1&&p.update(t,"selected",!0)})},a.updateField=function(e,t){var s=t.getAttribute("name");g[s]=t.value,d.set(s,t.value)},a.updateDate=function(e,t){var s=d.get("birthdate"),i=t.getAttribute("name");switch(i){case"year":s[0]=t.value;break;case"month":s[1]=t.selectedIndex;break;case"day":s[2]=t.value}d.set("birthdate",s),g.birthdate=s},a.updateAddress=function(e,t){var s=d.get("address"),i=t.getAttribute("name");s[i]=t.value||"",d.set("address",s),g.address=s},a.updateFamily=function(e,t){var s=t.getAttribute("name"),i=d.get("family");i[s]=t.selectedIndex,d.set("family",i),g.family=i},a.updateJob=function(e,t){var s=d.get("occupation"),i=t.getAttribute("name");switch(i){case"situation":s.situation=t.selectedIndex;break;case"job":s.job=t.value;break;case"organization":s.organization=t.value}g.occupation=s},a.updateLeisureName=function(e,t){var s=t.getAttribute("name"),i=s.charAt(s.length-1),a=d.get("leisure_activities");a[i].name=t.value,d.set("leisure_activities",a),g.leisure_activities=a},a.updateLeisureDesc=function(e,t){var s=t.getAttribute("name"),i=s.charAt(s.length-1),a=d.get("leisure_activities");a[i].comment=t.value,d.set("leisure_activities",a),g.leisure_activities=a},a.updateInterestName=function(e,t){var s=t.getAttribute("name"),i=s.charAt(s.length-1),a=d.get("interests");a[i].name=t.value,d.set("interests",a),g.interests=a},a.updateInterestDesc=function(e,t){var s=t.getAttribute("name"),i=s.charAt(s.length-1),a=d.get("interests");a[i].comment=t.value,d.set("interests",a),g.interests=a},a.press=function(e,t){t.classList.add("pressed")},a.cancel=function(e,t){t.classList.remove("pressed"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible")},a.update=function(e,s){var i,a=0;s.classList.remove("pressed"),s.classList.add("invisible"),h.spin(s.parentNode);for(i in g)l.set(i,g[i]),a++;a?l.upload().then(function(){var e=new o;g.picture_file&&(t.set("avatar",d.get("avatar")),e.sync("ideafy-data"),e.set("userAvatar",t.get("avatar"))),g.picture_file&&g.picture_file.search("img/avatars/deedee")<0&&(L(),document.getElementById("rotate").classList.add("invisible")),h.stop(),s.classList.remove("invisible"),t.get("observer").notify("profile-updated"),document.querySelector(".edituserdetails").classList.add("invisible"),document.querySelector(".userdetails").classList.remove("invisible")}):(h.stop(),s.classList.remove("invisible"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible"))},a}});