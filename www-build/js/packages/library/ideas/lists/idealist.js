/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","CouchDBStore","service/config","Olives/Model-plugin","Olives/Event-plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,f,l,c){var h=new t([]),p,d,v=!1,m=null,g={db:e,view:l,design:f,query:{descending:!0,include_docs:!0}};h.setTransport(n.get("transport")),this.template='<ul class="ideas-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:mousemove, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames"></h2><span class="date" data-listideas="bind:date,doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:innerHTML,doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul>',this.plugins.addAll({listideas:new r(h,{date:function y(y){y?this.innerHTML=s.formatDate(y):this.innerHTML=""},setRating:function(t){if(t===undefined){var n=this.getAttribute("data-listideas_id"),r=h.get(n).doc.votes||[];r.length===0?this.innerHTML="0":this.innerHTML=Math.round(r.reduce(function(e,t){return e+t})/r.length*100)/100}else this.innerHTML=Math.round(t*100)/100},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new o(t),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),listevent:new i(this)}),this.getModel=function(){return h},this.resetQuery=function(e){var t=new a;return g.query=e,h.unsync(),h.reset([]),h.sync(g.db,g.design,g.view,g.query).then(function(){t.resolve()}),t},this.setStart=function(e,t){p=[e.pageX,e.pageY],m&&this.hideActionBar(m)},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("ideas");d=[e.pageX,e.pageY];if(!r.classList.contains("mosaic")&&!v&&p[0]-d[0]>40&&d[1]-p[1]<20&&d[1]-p[1]>-20){var i=new u("idea",t,h.get(n).doc,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),m=i,v=!0}},this.hideActionBar=function(t){var n=t.dom.parentElement;n.removeChild(n.lastChild),v=!1,m=null},c&&(g.query=c),this.init=function(){var t=new a;return h.sync(g.db,g.design,g.view,g.query).then(function(){t.resolve()}),t}}return function(n,r,i,s){return f.prototype=new e,new f(n,r,i,s)}});