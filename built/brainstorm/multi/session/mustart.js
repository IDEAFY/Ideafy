/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","service/avatar","./mubchat","Store","Place.plugin"],function(e,t,i,s,n,a,r,o,l,d,c){return function(u,p,g,m){var v=new e,h=(n.get("user"),n.get("db"),n.get("labels")),b="step",f=new d([]),w=new l,y=new r({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545}).spin();return v.plugins.addAll({labels:new i(h),model:new i(u,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new o([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")}}),participant:new i(f,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new o([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "}}),place:new c({chat:w}),mustartevent:new s(v)}),v.template='<div id = "mustart"><div class="previousbutton" data-mustartevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-mustartevent="listen:touchstart, toggleProgress"></div><div class="help-brainstorm" data-mustartevent="listen:touchstart, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:innerHTML, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants"></label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div></form><div class="sessionchat" data-place="place:chat"></div><div>',v.place(t.get("mustart")),v.press=function(e,t){t.classList.add("pressed")},v.next=function(e,t){y.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),g("mustart")},v.prev=function(e,t){t.classList.remove("pressed"),p("quickstart")},v.toggleProgress=function(){m()},v.reset=function(e){b="step",f.reset(u.get("participants")),w.reset(u.get("chat")[0]).then(function(){w.setReadonly(),e&&w.dom.querySelector(".chatread").classList.add("extended")})},v.help=function(){a.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},u.watchValue("participants",function(e){f.reset(e)}),v}});