/* 
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","CouchDBView","Promise","lib/spin.min","service/confirm","service/map"],function(e,t,n,i,s,a,r,o,c,l,d){return function(u,p){var h,g,f=new e,m=t.get("labels"),v=t.get("user"),b=t.get("transport"),w=t.get("db"),y=new s([]),k=new s([]),L=[],S=new s;return f.template='<div class="importcard"><div class="importfrom"><label data-label="bind:innerHTML, importfrom"></label><select data-model="bind:setDecks, decks" data-importevent="listen: change, updateSelect"></select></div><div class="importlist"><legend data-label="bind:innerHTML, seldeck"></legend><ul name="selected" data-selected="foreach"><li name="selected" data-selected="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: touchend, toggleSelect"></li></ul></div><div class="importarea"><button class="addremove invisible" data-model="bind: setVisible, sel; bind: setDirection, direction" data-importevent="listen: touchend, addRemoveSelected">Add/remove</button><button class="invisible" data-label="bind:innerHTML, selall" data-model="bind:setVisible, sel" data-importevent="listen: touchend, selectAll"></button><button class="invisible" data-label="bind:innerHTML, clearsel" data-model="bind: setVisible, sel" data-importevent="listen: touchend, clearSelected">Clear selection</button></div><div class="importlist"><legend data-label="bind:innerHTML, workdeck"></legend><ul data-current="foreach"><li name="current" data-current="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: touchend, toggleSelect"></li></ul></div><div class="cancelmail" data-importevent="listen:touchstart, press; listen:touchend, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-importevent="listen:touchstart, press; listen:touchend, upload" data-label="bind:innerHTML, savelbl">Save</div></div>',f.plugins.addAll({label:new n(m),model:new n(S,{setDecks:function(e){var t,n,i="";if(e)for(t=0,n=e.length;n>t;t++)e[t]._id!==h&&(i+="<option>"+e[t].title+"</option>");this.innerHTML=i},setDirection:function(e){e?node.classList.remove("invisible"):node.classList.add("invisible"),this.innerHTML="remove"===e?m.get("remsel"):m.get("impsel")},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),current:new n(y,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;")}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),selected:new n(k,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;")}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),importevent:new i(f)}),f.cancel=function(e,t){t.classList.remove("pressed"),p()},f.upload=function(e,t){var n=new c({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin(t),i=["newcard"],s=["newcard"],a=["newcard"],r=["newcard"];L.length&&b.request("DeleteCards",{idList:L},function(e){return e}),y.loop(function(e){switch(e.type){case 1:i.push(e.id);break;case 2:s.push(e.id);break;case 3:a.push(e.id);break;case 4:r.push(e.id);break;default:i.push(e.id)}}),u({characters:i,contexts:s,problems:a,techno:r}).then(function(){n.stop(),t.classList.remove("pressed"),p()})},f.press=function(e,t){t.classList.add("pressed")},f.updateSelect=function(e,t){var n=t.selectedIndex;k.reset([]),f.getDeckCards(S.get("decks")[n]._id,k)},f.toggleSelect=function(e,t){var n,i=t.getAttribute("name"),s=t.getAttribute("data-"+i+"_id"),a=S.get("sel")||0;"current"===i?(n=y,"remove"!==S.get("direction")&&(f.clearSelection("selected"),S.set("direction","remove"),a=0)):(n=k,"add"!==S.get("direction")&&(f.clearSelection("current"),S.set("direction","add"),a=0)),n.get(s).selected?(n.update(s,"selected",!1),S.set("sel",a-1)):(n.update(s,"selected",!0),S.set("sel",a+1))},f.selectAll=function(){var e;e="add"===S.get("direction")?k:y,e.loop(function(t,n){e.update(n,"selected",!0)})},f.clearSelected=function(){var e;e="add"===S.get("direction")?k:y,e.loop(function(t,n){e.update(n,"selected",!1)}),S.set("sel",0)},f.addRemoveSelected=function(){var e=S.get("direction");"add"===e?f.addSelected():f.removeSelected()},f.addSelected=function(){var e=y.toJSON(),t=JSON.parse(e),n=f.dom.querySelector("ul[name='current']"),i=(new c).spin(n);y.reset([]),k.loop(function(n){n.selected&&-1===e.search(n.id)&&t.push({id:n.id,type:n.type,title:n.title,deck:n.deck.concat(),selected:n.selected})}),t.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),y.reset(t),i.stop(),f.clearSelection("selected"),S.set("direction","remove")},f.removeSelected=function(){var e=[],t=[],n="";y.loop(function(n,i){n.selected&&(e.push(i),1===n.deck.length&&n.deck[0]===h&&t.push({title:n.title.toUpperCase(),id:n.id}))}),t.length?(d.get("cache").classList.add("appear"),t.forEach(function(e){n+=e.title+", "}),n=n.slice(0,-2),g=new l(document.body,m.get("delcardwarning")+n,function(n){n&&(y.delAll(e),f.clearSelection("current"),S.set("sel",0),t.forEach(function(e){L.push(e.id)})),document.body.removeChild(document.querySelector(".confirm")),d.get("cache").classList.remove("appear")},"importcard-confirm")):(y.delAll(e),f.clearSelection("current"),S.set("sel",0))},f.clearSelection=function(e){var t;t="current"===e?y:k,t.loop(function(e,n){e.selected&&e.selected===!0&&t.update(n,"selected",!1)})},f.getDecks=function(e){var t=new a,n=v.get("taiaut_decks").concat(v.get("custom_decks")),i=new o;return t.setTransport(b),t.sync(w,{keys:n}).then(function(){var n,s=v.get("lang"),a=[];for(t.loop(function(e){(e.doc.public||e.doc.created_by===v.get("_id")||e.doc.sharedwith&&e.doc.sharedwith.indexOf(v.get("_id")))&&(e.doc.default_lang&&e.doc.default_lang!==s?e.doc.translations&&e.doc.translations[s]?a.push(e.doc.translations[s]):a.push(e.doc):a.push(e.doc))}),n=a.length-1;n>=0;n--)a[n]._id===e&&a.splice(n,1);a.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),S.set("decks",a.concat()),i.fulfill(),t.unsync()}),i},f.getDeckCards=function(e,t){var n=new r,i=new o,s=f.dom.querySelector("ul[name='selected']"),a=(new c).spin(s);return n.setTransport(b),n.sync(w,"library","_view/cards",{key:'"'+e+'"'}).then(function(){var e=[];n.loop(function(t){e.push({id:t.value._id,type:t.value.type,title:t.value.title,deck:t.value.deck})}),e.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),a.stop(),t.reset(e),i.fulfill()}),i},f.reset=function(e){S.reset({}),y.reset([]),k.reset([]),L=[],f.dom.querySelector("select").selectedIndex=0,h=e,f.getDecks(h).then(function(){f.getDeckCards(h,y),f.getDeckCards(S.get("decks")[0]._id,k)})},v.watchValue("taiaut_decks",function(){f.getDecks()}),v.watchValue("custom_decks",function(){f.getDecks()}),v.watchValue("lang",function(){f.getDecks()}),f}});