/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","Olives/Model-plugin","Olives/Event-plugin","service/config","Store","Promise","service/autocontact"],function(e,t,n,r,s,o,u){return function(f){var c=new e,h=new s,p=new s({errormsg:""}),d=r.get("labels"),v=r.get("user"),m=r.get("transport"),g=!1,y={},b=function(e){var t=h.get("toList").toLowerCase().split(/,|;/),n=h.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(v.get("connections")).toLowerCase(),s=[],u={},a=new o;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1)){p.set("errormsg",d.get("tolbl")+" : "+t[i].trim()+d.get("notavalidcontact")),g=!1,a.reject();break}s.push(t[i].trim())}if(!p.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1)){p.set("errormsg",d.get("tolbl")+" : "+n[i].trim()+d.get("notavalidcontact")),g=!1,a.reject();break}s.push(n[i].trim())}return p.get("errormsg")||(u.list=s,m.request("CheckRecipientList",u,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.resolve()}else p.set("errormsg",t.error),a.reject()})),a};return c.plugins.addAll({labels:new t(d),errormsg:new t(p),newmessage:new t(h,{setAvatar:function(e){this.setAttribute("style","background: url('"+r.get("avatar")+"') no-repeat center center;background-size:cover;")}}),newmessageevent:new n(c)}),c.template='<div id="newmsg"><div class="header blue-dark"><span data-labels="bind: innerHTML, newmsg">New message</span></div><div class="avatar" data-newmessage="bind: setAvatar, author"></div><form class="form"><p><textarea class="mail-header" name="toList" data-newmessage="bind: value, toList" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea class="mail-header" name="ccList" data-newmessage="bind: value, ccList" data-labels="bind:placeholder, cclbl" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><input type="text" class="input" data-newmessage="bind:value, object" data-labels="bind:placeholder, subjectlbl"></p><p><textarea class="input" data-newmessage="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-newmessage="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-newmessageevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-newmessageevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',c.reset=function(t){var n,r,i="";h.reset({author:v.get("_id"),username:v.get("username"),firstname:v.get("firstname"),type:"MSG",signature:v.get("username"),toList:"",ccList:"",object:"",body:"",date:null}),v.get("signature")?h.set("signature",v.get("signature")):h.set("signature",v.get("username")),p.reset({errormsg:""});if(t){console.log(t);if(t.type==="user")h.set("toList",t.username);else{for(n=0,r=t.contacts.length;n<r;n++)i?i=i+", "+t.contacts[n].username:i=t.contacts[n].username;h.set("toList",i)}}},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),g=!1,c.reset(),f("#defaultPage")},c.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){h.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new u(r,t,s),y.name=i,r.classList.remove("invisible")},c.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?y.name.init():y.name.updateList()},c.send=function(e,t){var n=new Date,r={};t.classList.remove("pressed"),g||(g=!0,p.set("errormsg",""),r=JSON.parse(h.toJSON()),h.get("object")||(p.set("errormsg",d.get("entersubjectlbl")),g=!1),r.dest=[],b(function(e){r.dest=e}).then(function(){p.get("errormsg")?(console.log(result),g=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],m.request("Notify",r,function(e){g=!1,c.reset(),p.set("errormsg",d.get("messagesentok")),setTimeout(function(){p.set("errormsg",""),g=!1,f("#defaultPage")},2e3)}))}))},c}});