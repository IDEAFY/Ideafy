/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Bind.plugin","Amy/Stack-plugin","Amy/Control-plugin","Event.plugin","Place.plugin","service/config","service/map","./decklist/decklist","./deckview/deckview","./newdeck"],function(e,t,n,i,s,a,r,o,c,l,d){return function(){var o,u,p,h=new e,g=new i(h),f=r.get("user"),v=new n,m=function(e){var t=v.getStack().getCurrentScreen(),n=t.getModel();o=t.highlightDeck(g.init,e),y.reset(n.get(o))},b=!1,w=function(e,t,n){var i;p=t,"new"===e&&(b=!0,p=t),"updated"===e&&(i=v.getStack().getCurrentScreen(),i.reset(function(e){e&&(i.highlightDeck(g.init,t),y.reset(i.getModel().get(o),n))}))},y=new l(w),k=new d(w);return h.plugins.addAll({label:new t(r.get("labels")),deckliststack:v,decksevent:new s(h),deckplace:new a({deckView:y,newDeck:k}),deckscontrol:g}),h.template='<div id="decks"><div id="decklist" class="list"><div class="header blue-light"><div class="option left" data-deckscontrol=""></div><span data-label="bind: innerHTML, decklistheadertitle"></span><div class="option right" data-decksevent="listen: touchstart, plus"></div></div><div class="overflow" data-deckliststack="destination" data-deckscontrol="radio:li,selected,touchstart,selectStart"></div></div><div data-deckplace="place:deckView"></div><div data-deckplace="place:newDeck"></div></div>',h.reset=function(){u.reset(function(e){e&&(v.getStack().show("ideafy"),u.highlightDeck(g.init,0),y.reset(u.getModel().get(0)),o=0)})},h.displayDeck=m,h.init=function(){u=new c("all_decks"),v.getStack().add("ideafy",u),u.init(function(e){e&&(v.getStack().show("ideafy"),y.init(),u.highlightDeck(g.init,0),y.reset(u.getModel().get(0),"details"),o=0)})},h.selectStart=function(e){var t=v.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-decks_id");y.reset(t.get(n)),o=n},h.plus=function(){k.show()},h.init(),f.watchValue("lang",function(){var e,t=v.getStack().getCurrentName(),n=v.getStack().getCurrentScreen();switch(t){case"taiaut":e="taiaut_decks";case"custom":e="custom_decks";break;default:e="all_decks"}n.getDecks(e,function(e){e&&(n.initSelected(g.init,o),y.reset(n.getModel().get(o)))})}),f.watchValue("custom_decks",function(e,t,n){u.reset(function(t){var i;t&&b?m(p):t&&e.length<n.length&&(i=u.getModel(),i.getNbItems()&&(u.initSelected(g.init,0),y.reset(i.get(0)),o=0)),b=!1})}),f.watchValue("taiaut_decks",function(){u.reset(function(e){e&&(u.initSelected(g.init,0),y.reset(u.getModel().get(0)))})}),h}});