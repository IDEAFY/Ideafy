/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(l){var c=new e,h=new r,p=o.get("labels"),d=new n({error:""}),v;return h.setTransport(o.get("transport")),c.plugins.addAll({editlabel:new i(p),editidea:new i(h,{setVisibility:function(e){e==="public"?this.innerHTML=p.get("publiclbl"):this.innerHTML=p.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=p.get("enabledreplaylbl"):this.innerHTML=p.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=p.get("disablereplaylbl"):this.innerHTML=p.get("enablereplaylbl")}}),editevent:new s(c),errormsg:new i(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;case"nosol":this.innerHTML=p.get("solutionfield")+p.get("emptyfielderror");break;default:this.innerHTML=""}}})}),c.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl">Modify your idea</span></div><form class="form"><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, upload">Publish</label><label class="cancel pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, cancel">Cancel</label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',c.place(t.get("public-edit")),c.reset=function(t){h.unsync(),h.reset(),h.sync(o.get("db"),t),v=!1},c.editVisibility=function(e,t){var n=new u(t,p.get("setpublicquestion"),function(e){e?h.set("visibility","public"):h.set("visibility","private"),n.close()})},c.press=function(e,t){t.classList.add("pressed")},c.enableReplay=function(e,t){setTimeout(function(){h.get("sessionReplay")?h.set("sessionReplay",!1):h.set("sessionReplay",!0),v=!0,t.classList.remove("pressed")},300)},c.updateSessionReplay=function(t){var n=new a,i=new r;return i.setTransport(o.get("transport")),i.sync(o.get("db"),h.get("sessionId")).then(function(){var e=i.get("replayIdeas")||[],n;if(t)e.push(h.get("_id"));else for(n=e.length-1;n>=0;n--)e[n]===h.get("_id")&&e.splice(n,1);return i.set("replayIdeas",e),i.upload()}).then(function(){n.fulfill(),i.unsync()}),n},c.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];h.get("title")===""?d.set("error","notitle"):h.get("description")===""?d.set("error","nodesc"):h.get("solution")===""?d.set("error","nosol"):(h.set("modification_date",r),h.upload().then(function(){v&&c.updateSessionReplay(h.get("sessionReplay")).then(null,function(e){console.log(e)}),l("close")})),t.classList.remove("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),l("close")},c}});