/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","CouchDBStore"],function(e,t,n,r,i,s){return function(){var u=new e,a=new s(i.get("ideaTemplate")),f=i.get("user"),l=i.get("labels"),c=new s({error:""}),h=!1;return a.setTransport(i.get("transport")),u.plugins.addAll({newidea:new n(a,{setVisibility:function(e){e==="public"?(this.innerHTML=l.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=l.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){e==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),labels:new n(l),errormsg:new n(c,{setError:function(e){switch(e){case"notitle":this.innerHTML=l.get("titlefield")+l.get("emptyfielderror");break;case"nodesc":this.innerHTML=l.get("descriptionfield")+l.get("emptyfielderror");break;case"nosol":this.innerHTML=l.get("solutionfield")+l.get("emptyfielderror");break;default:this.innerHTML=e}}}),newideaevent:new r(u)}),u.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><p><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title"></p><p><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea></p><div class="visibility-input"><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',u.render(),u.place(t.get("newidea-popup")),u.toggleVisibility=function(e,t){var n=a.get("visibility");t.classList.remove("pressed"),n==="public"?a.set("visibility","private"):a.set("visibility","public")},u.press=function(e,t){t.classList.add("pressed"),document.querySelector(".publicwarning").classList.add("invisible")},u.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),a.unsync(),a.reset(i.get("ideaTemplate")),c.reset({error:""}),document.querySelector(".visibility-slider").value=1},u.resetError=function(e,t){var n;t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",c.get("error")===n&&t.value&&c.set("error","")},u.cancel=function(e,t){u.closePopup()},u.upload=function(e,t){var n=new Date,r="I:"+n.getTime(),s;t.classList.remove("pressed"),a.get("title")?a.get("description")?a.get("solution")||c.set("error","nosol"):c.set("error","nodesc"):c.set("error","notitle"),!c.get("error")&&!a.get("_id")&&!h?(h=!0,s=setInterval(function(){c.get("error")===l.get("uploadinprogress")?c.set("error",l.get("uploadinprogress")+"..."):c.set("error",l.get("uploadinprogress"))},100),a.set("authors",[f.get("_id")]),a.set("authornames",f.get("username")),a.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),a.set("lang",f.get("lang")),a.sync(i.get("db"),r),setTimeout(function(){a.upload(),a.get("visibility")==="public"?i.get("transport").request("UpdateUIP",{userid:f.get("_id"),type:a.get("type"),docId:r,docTitle:a.get("title")},function(e){e!=="ok"&&console.log(e),u.closePopup(),clearInterval(s)}):(u.closePopup(),clearInterval(s))},500)):t.classList.remove("pressed")},u}});