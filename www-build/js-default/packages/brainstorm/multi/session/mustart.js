/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","service/avatar","./mubchat","Store","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v){var m=new e,g=i.get("user"),y=i.get("db"),b=i.get("labels"),w="step",E=new f([]),S=new a,x=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return m.plugins.addAll({labels:new n(b),model:new n(h,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new u([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")}}),participant:new n(E,{setAvatar:function(t){var n,r;t&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new u([t]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),place:new l({chat:S}),mustartevent:new r(m)}),m.template='<div id = "mustart"><div class="previousbutton" data-mustartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-mustartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-mustartevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:innerHTML, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants"></label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div></form><div class="sessionchat" data-place="place:chat"></div><div>',m.place(t.get("mustart")),m.press=function(e,t){t.classList.add("pressed")},m.next=function(e,t){x.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),d("mustart")},m.prev=function(e,t){t.classList.remove("pressed"),p("quickstart")},m.toggleProgress=function(e,t){v()},m.reset=function(t){w="step",E.reset(h.get("participants")),S.reset(h.get("chat")[0]).then(function(){S.setReadonly(),t&&S.dom.querySelector(".chatread").classList.add("extended")})},m.help=function(e,t){s.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},h.watchValue("participants",function(e){E.reset(e)}),m}});