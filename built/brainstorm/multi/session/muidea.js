/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/cardpopup","../../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min","./mubchat","./muvote"],function(e,t,i,s,n,a,r,o,l,d,c,u,g,p,m){return function(v,h,b,f,w){var y,S,L,k,T=new e,M=new p,I=new m,A="step",C=0,H=new l({timer:null,display:!1}),q=new l({title:"",description:"",solution:"",visibility:"private"}),_=new l,x=new l([]),D=[],B={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},P=new l(B),N=new l([]),O=new o("idea",N,P,"mu"),E=a.get("transport"),j=a.get("user"),J=a.get("db"),V=a.get("labels"),F=!1,R=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();return T.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===j.get("_id")},T.plugins.addAll({labels:new i(V,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new i(_),techs:new i(x,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(P,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){T.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showIdea:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;"scenario"===this.getAttribute("name")?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),muideatimer:new i(H,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new i(q),wbstack:O,place:new n({chat:M,vote:I}),muideaevent:new s(T)}),T.template='<div id = "muidea"><div class="previousbutton" data-muideaevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muidea" data-muideaevent="listen:touchstart, toggleProgress"></div><div class="timer" data-muideatimer="bind:setTime, timer; bind: displayTimer, display" data-muideaevent="listen:touchstart,toggleTimer"></div><div id="muidea-left"><div class="idea-cards leftarea folded" data-muideaevent="listen:touchstart, fold"><div class="card defaultscenario" name="scenario" data-muideaevent="listen: touchstart, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-muideaevent="listen: touchstart, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul><div class="caret"></div></div><div id="muidea-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muideaevent="listen: touchstart, push; listen:touchend, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muideaevent="listen: touchstart, push; listen:touchend, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muideaevent="listen: touchstart, push; listen:touchend, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muideaevent="listen: touchstart, press; listen:touchend, finish"></div></div></div><div id="muidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muideaevent="listen:touchstart, toggleCaret"></div></div><div id = "muidea-writeup" class="writeup invisible" data-wbtools="bind: showIdea,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muideaevent="listen: touchstart, press; listen:touchend, next"></div></div><div class="sessionvote" data-place="place:vote"></div><div class="sessionchat" data-place="place:chat"></div></div>',T.place(t.get("muidea")),T.press=function(e,t){t.classList.add("pressed")},T.next=function(e,t){var i,s,n,a=(new Date,new c);t.classList.add("invisible"),t.classList.remove("pressed"),"step"===A?(A="screen",P.set("readonly",!0),clearInterval(L),H.set("display",!0),clearInterval(k),i=T.getSessionDuration(),I.reset(v,function(e){F=!0,s=e.visibility,n=e.replay,q.set("visibility",s),q.set("sessionReplay",n),a.fulfill(),I.close()}),a.then(function(){return R.spin(t.parentNode),h.set("idea",JSON.parse(q.toJSON())),T.createIdeaDoc()}).then(function(){return v.unsync(),v.sync(J,v.get("_id"))}).then(function(){var e=v.get("elapsedTimers");return M.conclude("next"),e.muidea=H.get("timer"),v.set("idea",[JSON.parse(q.toJSON())]),n&&v.set("replayIdeas",[]),v.set("elapsedTimers",e),v.set("duration",i),v.set("status","completed"),v.set("idea",[h.get("idea")]),v.upload()}).then(function(){return T.updateSessionScore(H.get("timer"))}).then(function(){f("muidea")})):f("muidea")},T.stopSpinner=function(){R.stop()},T.prev=function(e,t){t.classList.remove("pressed"),b("muidea")},T.toggleProgress=function(){w()},T.toggleTimer=function(){T.isLeader()&&H.set("display",!H.get("display"))},T.toggleVisibility=function(){"step"===A&&T.isLeader()&&("public"===q.get("visibility")?q.set("visibility","private"):q.set("visibility","public"))},T.push=function(e,t){var i=t.getAttribute("name");P.set(i,"active")},T.zoom=function(e,t){var i,s;"scenario"===t.getAttribute("name")?i="scenario":(i="techno",s=t.getAttribute("data-techs_id")),T.setPopup(i,s)},T.fold=function(e,t){v.get("ideaReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),S&&y.close())},T.setPopup=function(e,t){var i,s={x:147,y:30},n="left",r=P.get("cardpopup"),o=new l,c="";S&&("scenario"===S.type?r.scenario=!1:r.techs[S.id]=!1,P.set("cardpopup",r)),"scenario"===e?r.scenario=!0:r.techs[t]=!0,P.set("cardpopup",r),S={type:e,id:t},"scenario"===e?(s.y=55,o.reset(h.get("scenario")),o.set("type",5),c=o.toJSON(),y.reset(c,s,n,document.getElementById("muidea-popup"))):(0==t&&(s.y=200),1==t&&(s.y=260),2==t&&(s.y=350),D[t]?(c=D[t],y.reset(c,s,n,document.getElementById("muidea-popup"))):(i=new d,i.setTransport(E),i.sync(a.get("db"),h.get("techno").get(t).id).then(function(){c=i.toJSON(),y.reset(c,s,n,document.getElementById("muidea-popup")),D[t]=c})))},T.closePopup=function(){var e=P.get("cardpopup");e[S]=!1,P.set("cardpopup",e),S=""},y=new r(T.closePopup),T.getChatUI=function(){return M},T.post=function(){O.selectScreen("postit"),P.set("import","inactive"),P.set("drawing","inactive")},T.importpic=function(){O.selectScreen("import"),P.set("postit","inactive"),P.set("drawing","inactive")},T.draw=function(){O.selectScreen("drawing"),P.set("import","inactive"),P.set("postit","inactive")},T.exitTool=function(e){P.set(e,"inactive")},T.finish=function(e,t){var i=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();i.spin(t.parentNode),t.classList.add("invisible"),v.unsync(),v.sync(J,v.get("_id")).then(function(){return v.set("ideaReady",!0),v.upload()}).then(function(){i.stop(),t.classList.remove("pressed"),P.set("ready",!1),T.displayIdea(),T.updateIdea()})},T.updateField=function(e,t){t.classList.contains("enterTitle")&&q.set("title",t.value),t.classList.contains("enterDesc")&&q.set("description",t.value),t.classList.contains("enterSol")&&q.set("solution",t.value)},T.displayIdea=function(){O.setReadonly(!0),P.set("showidea",!0),T.dom.querySelector(".idea-cards").classList.remove("folded"),T.dom.querySelector(".idea-cards .caret").classList.add("invisible"),T.dom.querySelector(".writeup").scrollIntoView(),T.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},T.hideIdea=function(){T.dom.querySelector(".idea-cards").classList.add("folded"),T.dom.querySelector(".idea-cards .caret").classList.remove("invisible"),T.dom.querySelector(".whiteboard .caret").classList.add("invisible")},T.toggleCaret=function(e,t){e.stopPropagation();var i=T.dom.querySelector(".writeup"),s=T.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?i.scrollIntoView():s.scrollIntoView()},T.toggleView=function(e,t){var i=t.querySelector(".caret"),s=T.dom.querySelector(".writeup"),n=T.dom.querySelector(".whiteboard");i.classList.contains("descending")?(i.classList.remove("descending"),n.scrollIntoView()):e.pageY-t.scrollHeight>0&&(i.classList.add("descending"),s.scrollIntoView())},T.updateIdea=function(){k=setInterval(function(){var e=v.get("idea")[0]||{title:"",description:"",solution:""},t=e.title,i=e.description,s=e.solution,n={};(q.get("title")!==t||q.get("description")!==i||q.get("solution")!==s)&&(n.title=q.get("title"),n.description=q.get("description"),n.solution=q.get("solution"),v.set("idea",[n]),v.upload().then(function(){return!0},function(e){console.log("failed to update idea",e)}))},8e3)},T.updateSessionScore=function(e){var t=new c,i={sid:v.get("_id"),step:"muidea",time:e,wbcontent:N.toJSON(),idea:q.toJSON()};return E.request("UpdateSessionScore",i,function(e){"ok"===e.res?(v.unsync(),v.sync(J,v.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},T.getSessionDuration=function(){var e=v.get("elapsedTime"),t=v.get("resumeTime")||v.get("startTime");return now=new Date,now.getTime()-t+e},T.createIdeaDoc=function(){var e=new d(a.get("ideaTemplate")),t=new Date,i="I:"+t.getTime(),s=[],n=[],r=new c;return s.push(v.get("initiator").id),n.push(v.get("initiator").username),v.get("participants").forEach(function(e){s.push(e.id),n.push(e.username)}),e.setTransport(E),e.set("title",q.get("title")),e.set("sessionId",v.get("_id")),e.set("authors",s),e.set("description",q.get("description")),e.set("solution",q.get("solution")),e.set("creation_date",[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()]),e.set("character",v.get("characters")[0]),e.set("problem",v.get("problems")[0]),e.set("context",v.get("contexts")[0]),e.set("techno",v.get("techno")[0]),e.set("visibility",q.get("visibility")),e.set("sessionReplay",q.get("sessionReplay")),e.set("authornames",n.join(", ")),e.set("lang",v.get("lang").substring(0,2)),e.set("_id",i),e.sync(a.get("db"),i).then(function(){return e.upload()}).then(function(){"public"===e.get("visibility")&&(E.request("UpdateUIP",{userid:j.get("_id"),type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){"ok"!==e&&console.log(e)}),v.get("participants").forEach(function(t){E.request("UpdateUIP",{userid:t.id,type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){"ok"!==e&&console.log(t.id," "+e)})})),r.fulfill(),e.unsync()}),r},T.reset=function(e){M.clear(),v.get("chat")[4]&&M.reset(v.get("chat")[4]),P.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),x.reset(),O.setSessionId(v.get("_id")),N.reset(v.get("ideaWB")),N.getNbItems()?O.selectScreen("main"):O.selectScreen("default"),clearInterval(L),e||v.get("idea").length?(A="screen",M.dom.querySelector(".chatread").classList.add("extended"),P.set("ready",!1),T.displayIdea(),q.reset(v.get("idea")[0]),h.set("idea",v.get("idea")[0]),P.set("readonly",!0),P.set("shownext",!1)):(q.reset({title:"",description:"",solution:"",visibility:"private"}),N.getNbItems()?P.set("ready",!0):P.set("ready",!1),O.setReadonly(!1),A="step",F=!1),v.get("elapsedTimers").muidea&&(C=v.get("elapsedTimers").muidea,H.set("timer",C),"screen"===A?H.set("display",!0):T.isLeader()&&T.initTimer(C))},T.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;H.set("display",!1),H.set("timer",s),"muidea"===v.get("step")&&(L=setInterval(function(){var e=new Date;H.set("timer",s+e.getTime()-i)},1e3))},v.watchValue("_id",function(e){O.setSessionId(e)}),v.watchValue("chat",function(e){5===e.length&&M.getModel().get("_id")!==e[4]&&M.reset(e[4])}),h.watchValue("scenario",function(){_.reset(h.get("scenario"))}),h.watchValue("techno",function(){x.reset(JSON.parse(h.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){N.watch(e,function(){P.get("showidea")||((v.get("ideaWB").length!==N.getNbItems()||JSON.stringify(v.get("ideaWB"))!==N.toJSON())&&(v.set("ideaWB",JSON.parse(N.toJSON())),v.upload().then(function(){return"success"},function(e){console.log("failure : ",e)})),N.getNbItems()?P.set("ready",!0):P.set("ready",!1))})}),v.watchValue("ideaWB",function(e){"muidea"!==v.get("step")||P.get("showidea")||(e.length&&"default"===O.getStack().getCurrentName()&&O.selectScreen("main"),e.length||O.selectScreen("default"),(e.length!==N.getNbItems()||JSON.stringify(e)!==N.toJSON())&&N.reset(e))}),v.watchValue("ideaReady",function(e){"muidea"===v.get("step")&&e&&!T.isLeader()&&(P.set("readonly",!0),T.displayIdea())}),v.watchValue("idea",function(e){T.isLeader()||(q.reset(e[0]),h.set("idea",JSON.parse(q.toJSON())))}),q.watch("updated",function(){T.isLeader()&&q.get("title")&&q.get("description")&&q.get("solution")?P.set("shownext",!0):P.set("shownext",!1)}),v.watchValue("vote",function(e){!e||F||T.isLeader()||I.isActive()||(I.reset(v,function(e){e&&I.close()}),F=!0)}),T}});