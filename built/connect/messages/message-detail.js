/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/avatar","service/utils","./message-reply"],function(e,t,s,n,a,c,r,o,d){return function(u){var p=new e,g=new d,v=new s,h=new s({response:""}),m=t.get("labels"),b=t.get("user"),f=t.get("observer"),w=t.get("transport");return p.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class="msgdetailarea"><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="more" class="more" data-messageevent="listen:touchstart, press; listen:touchend, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:touchstart, press; listen:touchend, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><p data-message="bind:setSignature, type"></p><p class="invisible" data-message="bind:setJoinMsg, sessionStatus"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:touchstart, press; listen:touchend, showDoc"></div><div class="gotosession invisible" data-message="bind: showSessionBtn, sessionStatus" data-messageevent="listen:touchstart, press; listen:touchend, gotoSession"></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: touchstart, press; listen: touchend, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:touchstart, press; listen:touchend, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:touchstart, press; listen:touchend, rejectCXR"></div></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div></div>',p.plugins.addAll({label:new a(m),message:new a(v,{date:function y(y){var e=new Date,t=y[3],s=y[4],i=y[5];y&&y[0]===e.getFullYear()&&y[1]===e.getMonth()&&y[2]===e.getDate()?(10>t&&(t="0"+t),10>s&&(s="0"+s),10>i&&(i="0"+i),this.innerHTML=t+":"+s+":"+i):this.innerHTML=o.formatDate(y)+"  "+t+":"+s},setObject:function(e){switch(e){case"CXR":this.innerHTML=v.get("username")+m.get("CXRobject");break;case"INV":this.innerHTML=v.get("username")+m.get("INVObject");break;case"CXRaccept":this.innerHTML=v.get("username")+m.get("acceptedCXR");break;case"CXRreject":this.innerHTML=v.get("username")+m.get("rejectedCXR");break;case"CXCancel":this.innerHTML=v.get("username")+m.get("canceledCX");break;case"DOC":this.innerHTML=v.get("username")+m.get("sentdocmsg");break;case"2Q+":this.innerHTML=v.get("username")+m.get("askednew");break;case"2C+":this.innerHTML=v.get("username")+m.get("senttc");break;case"REF":this.innerHTML=messages.get(id).username+m.get("joinedideafy");break;default:this.innerHTML=v.get("object")}},setBody:function(e){switch(e){case"CXRaccept":this.innerHTML=m.get("youlbl")+m.get("nowconnected")+v.get("username");break;case"DOC":this.innerHTML="<p>"+v.get("body")+"</p><p>"+v.get("username")+"</p><p>"+v.get("signature")+"</p><br><br><p>"+m.get("clicktoview")+" : <b>"+v.get("docTitle")+"</b></p>";break;case"INV":this.innerHTML=v.get("username")+m.get("INVObject")+" : <b>"+v.get("docTitle")+"</b>";break;case"REF":this.innerHTML=m.get("referral");break;default:this.innerHTML=v.get("body").replace(/\n/g,"<br>")}},setSignature:function(e){"MSG"===e?(this.classList.remove("invisible"),this.innerHTML=v.get("signature")):this.classList.add("invisible")},showOptions:function(e){e.search("CX")>-1||"2Q+"===e||"INV"===e?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(e){this.innerHTML=e?e:m.get("melbl")},showCcList:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(e){"CXR"===e?this.classList.remove("invisible"):this.classList.add("invisible")},showDocBtn:function(e){"DOC"===e?this.classList.remove("invisible"):this.classList.add("invisible")},showSessionBtn:function(e){e&&"waiting"===e&&!v.get("joined")?this.classList.remove("invisible"):this.classList.add("invisible")},setJoinMsg:function(e){e?(this.classList.remove("invisible"),"unavailable"===e?this.innerHTML=m.get("nolongerjoin"):"joined"===e?this.innerHTML=m.get("joinedsession"):"waiting"===e&&(this.innerHTML=m.get("clicktojoin"))):this.classList.add("invisible")},showTwoQ:function(e){"2Q+"===e||"2C+"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function(e){var t=document.createDocumentFragment(),s=new r([e]);s.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),cxr:new a(h,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(e){this.innerHTML="YES"===e?m.get("CXRaccepted")+v.get("username")+m.get("isnowacontact"):m.get("CXRrejected")}}),messageevent:new c(p)}),p.showDoc=function(e,t){t.classList.remove("pushed"),"DOC"===v.get("type")&&f.notify("display-doc",v.get("docId"),v.get("docType"))},p.showTwoQ=function(e,t){t.classList.remove("pushed"),"2Q+"===v.get("type")&&f.notify("display-twoq",v.get("docId"),v.get("author")),"2C+"===v.get("type")&&f.notify("display-twoc")},p.press=function(e,t){t.classList.add("pushed")},p.action=function(e,t){var s=t.getAttribute("name"),i=document.getElementById("msgreply"),n=document.querySelector(".msgoptionlist");switch(s){case"more":n.classList.remove("invisible");break;case"reply":n.classList.add("invisible"),g.reset(JSON.parse(v.toJSON()),"reply"),i.classList.remove("invisible");break;case"replyall":n.classList.add("invisible"),g.reset(JSON.parse(v.toJSON()),"replyall"),i.classList.remove("invisible");break;case"forward":n.classList.add("invisible"),g.reset(JSON.parse(v.toJSON()),"forward"),i.classList.remove("invisible");break;case"deletemsg":n.classList.add("invisible"),p.deletemsg(v.toJSON()),u("#defaultPage")}t.classList.remove("pushed")},p.deletemsg=function(e){var t,s=b.get("notifications").concat();for(i=0,l=s.length;l>i;i++)if(JSON.stringify(s[i])===e){t=i;break}s.splice(t,1),b.set("notifications",s),b.upload()},p.acceptCXR=function(e,t){var s=b.get("connections"),n=b.get("news")||[],a=0,c=new Date,r=[c.getFullYear(),c.getMonth(),c.getDate(),c.getHours(),c.getMinutes(),c.getSeconds()];for(t.classList.remove("pushed"),i=0,l=s.length;l>i;i++)"user"===s[i].type?(s[i].lastname<v.get("contactInfo").lastname&&a++,s[i].lastname===v.get("contactInfo").lastname&&s[i].firstname<v.get("contactInfo").firstname&&a++):s[i].username<v.get("contactInfo").lastname&&a++;s.splice(a,0,v.get("contactInfo")),b.set("connections",s),n.unshift({type:"CX+",date:r,content:{userid:v.get("author"),username:v.get("username")}}),b.set("news",n),b.upload().then(function(){var e={dest:[v.get("author")],date:r,original:"",type:"CXRaccept",author:b.get("_id"),username:b.get("username"),firstname:b.get("firstname"),toList:v.get("username"),ccList:"",object:b.get("username")+m.get("acceptedCXR"),body:m.get("youlbl")+m.get("nowconnected")+b.get("username"),signature:"",contactInfo:{firstname:b.get("firstname"),lastname:b.get("lastname"),userid:b.get("_id"),username:b.get("username"),intro:b.get("intro"),type:"user"}};h.set("response","YES"),w.request("Notify",e,function(e){"ok"===JSON.parse(e)[0].res&&setTimeout(function(){p.deletemsg(v.toJSON()),u("#defaultPage")},1e3)})})},p.rejectCXR=function(e,t){var s,i=new Date;t.classList.remove("pushed"),h.set("response","NO"),s={dest:[v.get("author")],original:"",date:[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()],type:"CXRreject",author:b.get("_id"),username:b.get("username"),firstname:b.get("firstname"),toList:v.get("username"),ccList:"",object:b.get("username")+m.get("rejectedCXR"),body:"",signature:""},w.request("Notify",s,function(e){"ok"===JSON.parse(e)[0].res&&setTimeout(function(){p.deletemsg(v.toJSON()),u("#defaultPage")},1500)})},p.checkSessionStatus=function(e){var s=new n;s.setTransport(w),s.sync(t.get("db"),e).then(function(){"waiting"===s.get("status")?v.set("sessionStatus","waiting"):v.set("sessionStatus","unavailable"),s.unsync()},function(e){alert(e)})},p.gotoSession=function(e,s){var n=b.get("notifications");for(s.classList.remove("pushed"),v.set("joined",!0),t.get("observer").notify("join-musession",v.get("docId")),i=0,l=n.length;l>i;i++)if("INV"===n[i].type&&n[i].docId===v.get("docId")){n[i].joined=!0;break}b.set("notifications",n),b.upload()},p.reset=function(e){v.reset({}),h.reset({response:""}),v.reset(e),g.reset(e,"reply"),"INV"===v.get("type")&&(v.get("joined")?v.set("joined",!0):(v.set("sessionStatus",null),p.checkSessionStatus(v.get("docId"))))},p}});