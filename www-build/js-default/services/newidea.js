/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var a=new e,f=new s(i.get("ideaTemplate")),l=new s(i.get("userLanguages")),c=i.get("user"),h=function(){var e=c.get("lang").substring(0,2);f.set("lang",e),l.loop(function(t,n){t.name===e?l.update(n,"selected",!0):l.update(n,"selected",!1)})},p=i.get("labels"),d=new s({error:""}),v=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return f.setTransport(i.get("transport")),h(),a.plugins.addAll({newidea:new n(f,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setVisibility:function(e){e==="public"?(this.innerHTML=p.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=p.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){e==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),select:new n(l,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new n(p),errormsg:new n(d,{setError:function(e){switch(e){case"notitle":this.innerHTML=p.get("titlefield")+p.get("emptyfielderror");break;case"nodesc":this.innerHTML=p.get("descriptionfield")+p.get("emptyfielderror");break;case"nosol":this.innerHTML=p.get("solutionfield")+p.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new r(a)}),a.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newidea="bind: displayLang, lang" data-newideaevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newideaevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',a.render(),a.place(t.get("newidea-popup")),a.showLang=function(e,t){e.stopPropagation(),e.preventDefault(),a.dom.querySelector(".idealang ul").classList.remove("invisible")},a.selectFlag=function(e,t){var n;e.stopPropagation(),e.preventDefault(),n=parseInt(t.getAttribute("data-select_id"),10),l.loop(function(e,t){n===t?l.update(t,"selected",!0):l.update(t,"selected",!1)})},a.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),f.set("lang",l.get(n).name),a.dom.querySelector(".idealang ul").classList.add("invisible")},a.toggleVisibility=function(e,t){t.value==="1"?f.set("visibility","private"):f.set("visibility","public")},a.press=function(e,t){t.classList.add("pressed"),a.dom.querySelector(".publicwarning").classList.add("invisible")},a.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.unsync(),f.reset(i.get("ideaTemplate")),h(),d.reset({error:""}),a.dom.querySelector(".visibility-slider").value=1,a.dom.querySelector(".idealang ul").classList.add("invisible")},a.resetError=function(e,t){var n;t.scrollTop=99999,d.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",d.get("error")===n&&t.value&&d.set("error",""))},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,t){var n=new Date,r="I:"+n.getTime(),s;t.classList.remove("pressed"),f.get("title")?f.get("description")?f.get("solution")||d.set("error","nosol"):d.set("error","nodesc"):d.set("error","notitle"),!d.get("error")&&!f.get("_id")&&(t.classList.add("invisible"),v.spin(t.parentNode),s=setInterval(function(){d.get("error")===p.get("uploadinprogress")?d.set("error",p.get("uploadinprogress")+"..."):d.set("error",p.get("uploadinprogress"))},100),f.set("authors",[c.get("_id")]),f.set("authornames",c.get("username")),f.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),f.sync(i.get("db"),r).then(function(){return f.upload()}).then(function(){f.get("visibility")==="public"?i.get("transport").request("UpdateUIP",{userid:c.get("_id"),type:f.get("type"),docId:r,docTitle:f.get("title")},function(e){e!=="ok"&&console.log(e),v.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s)}):(v.stop(),t.classList.remove("invisible"),a.closePopup(),clearInterval(s))}))},a}});