/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../whiteboard/whiteboard","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(p,d,v,m,g){var y=new e,b,w,E=i.get("labels"),S=new s,x=new s,T=new s,N=new s({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),C={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},k=new s(C),L=new s({timer:null,display:!1}),A,O=new s({title:"",story:"",solution:""}),M=new s([]),_=new a("scenario",M,k),D,P=0,H="step",B=i.get("transport"),j=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return y.plugins.addAll({labels:new n(E,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(N,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(k,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new n(L,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(O),wbstack:_,quickscenarioevent:new r(y)}),y.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: touchstart, press; listen: touchstart, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:touchstart, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:touchstart,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:touchstart, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: touchstart, push; listen:touchend, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: touchstart, push; listen:touchend, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: touchstart, push; listen:touchend, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: touchstart, press; listen:touchend, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: touchstart, press; listen:touchend, next"></div></div></div>',y.place(t.get("quickscenario")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),H==="step"?(H="screen",clearInterval(A),L.set("display",!0),d.set("scenario",JSON.parse(O.toJSON())),y.updateSessionScore(L.get("timer")).then(function(){return p.unsync(),p.sync(i.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quickscenario=L.get("timer"),p.set("scenario",[JSON.parse(O.toJSON())]),p.set("elapsedTimers",e),k.set("readonly",!0),m("quickscenario")})):m("quickscenario")},y.stopSpinner=function(){j.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),v("quickscenario")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,t){L.set("display",!L.get("display"))},y.push=function(e,t){var n=t.getAttribute("name");k.set(n,"active")},y.zoom=function(e,t){var n=t.getAttribute("name");y.setPopup(n)},y.setPopup=function(t){var n={x:240,y:130},r="left",s=N.get(t),u=k.get("cardpopup"),a="",f;w&&(u[w]=!1),u[t]=!0,k.set("cardpopup",u),w=t,t==="char"&&(n.y=120,s.id===S.get("_id")&&(a=S.toJSON())),t==="context"&&(n.y=290,s.id===x.get("_id")&&(a=x.toJSON())),t==="problem"&&(n.y=350,s.id===T.get("_id")&&(a=T.toJSON())),a?b.reset(a,n,r,document.getElementById("quickscenario-popup")):(f=new o,f.setTransport(B),f.sync(i.get("db"),s.id).then(function(){a=f.toJSON(),b.reset(a,n,r,document.getElementById("quickscenario-popup")),t==="char"&&S.reset(JSON.parse(f.toJSON())),t==="context"&&x.reset(JSON.parse(f.toJSON())),t==="problem"&&T.reset(JSON.parse(f.toJSON()))}))},y.closePopup=function(){var t=k.get("cardpopup");t[w]=!1,k.set("cardpopup",t),w=""},b=new u(y.closePopup),y.post=function(e,t){_.selectScreen("postit"),k.set("import","inactive"),k.set("drawing","inactive")},y.importpic=function(e,t){_.selectScreen("import"),k.set("postit","inactive"),k.set("drawing","inactive")},y.draw=function(e,t){_.selectScreen("drawing"),k.set("import","inactive"),k.set("postit","inactive")},y.exitTool=function(t){k.set(t,"inactive")},y.finish=function(e,t){_.setReadonly(!0),k.set("ready",!1),k.set("showstory",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new f,n={sid:p.get("_id"),step:"quickscenario",time:e,wbcontent:M.toJSON(),scenario:O.toJSON()};return B.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},y.reset=function(t){k.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),_.setSessionId(p.get("_id")),M.reset(p.get("scenarioWB")),M.getNbItems()?_.selectScreen("main"):_.selectScreen("default"),p.get("scenario").length?(H="screen",k.set("ready",!1),k.set("showstory",!0),_.setReadonly(!0),O.reset(p.get("scenario")[0]),d.set("scenario",p.get("scenario")[0]),k.set("readonly",!0),k.set("shownext",!0)):(O.reset({title:"",story:"",solution:""}),M.getNbItems()?k.set("ready",!0):k.set("ready",!1),_.setReadonly(!1),H="step"),p.get("elapsedTimers").quickscenario&&(P=p.get("elapsedTimers").quickscenario,L.set("timer",P)),H==="screen"?L.set("display",!0):y.initTimer(P)},y.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;L.set("display",!1),L.set("timer",r),p.get("step")==="quickscenario"&&(clearInterval(A),A=setInterval(function(){var e=new Date;L.set("timer",r+e.getTime()-n)},1e3))},d.watchValue("characters",function(e){N.set("char",e)}),d.watchValue("contexts",function(e){N.set("context",e)}),d.watchValue("problems",function(e){N.set("problem",e)}),p.watchValue("_id",function(e){_.setSessionId(e)}),["added","deleted","updated"].forEach(function(e){M.watch(e,function(){JSON.stringify(p.get("scenarioWB"))!==M.toJSON()&&(p.set("scenarioWB",JSON.parse(M.toJSON())),p.upload()),M.getNbItems()&&H==="step"?k.set("ready",!0):k.set("ready",!1)})}),O.watch("updated",function(){O.get("title")&&O.get("story")&&O.get("solution")?k.set("shownext",!0):k.set("shownext",!1)}),WBC=M,y}});