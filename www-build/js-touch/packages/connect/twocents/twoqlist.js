/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,l,c,h,p){var d=new n([]),v=new t([]),m,g,y=!1,b="",w=null,E={db:l,view:h,design:c,query:{descending:!0}},S=r.get("labels"),x=this;d.setTransport(r.get("transport")),e==="contact"?b="contacttwoqlist":b="",this.template='<div><ul class="twoq-list '+b+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:touchstart, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+b+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:touchstart, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new i(d,{date:function T(T){T?this.innerHTML=o.formatDate(T):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=S.get("noreplyyet"):n===1?this.innerHTML=n+" "+S.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+S.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new i(v,{date:function N(N){N?this.innerHTML=o.formatDate(N):this.innerHTML=""},showReplies:function(t){var n;t&&(n=t.length),n===0?this.innerHTML=S.get("noreplyyet"):n===1?this.innerHTML=n+" "+S.get("showonetcreply"):n>1&&(this.innerHTML=n+" "+S.get("showtcrepliesafter"))},setAvatar:function(t){var n,r;t&&(r=document.createDocumentFragment(),n=new u([t]),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new s(this)}),this.getModel=function(){var e,t;return t=!x.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),t?e=v:e=d,e},this.resetQuery=function(e){var t=new f;return E.query=e,d.unsync(),d.reset([]),x.hideSearch(),d.sync(E.db,E.design,E.view,E.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){m=[e.pageX,e.pageY],w&&this.hideActionBar(w)},this.showActionBar=function(e,t){var n=t.getAttribute("data-twoqlist_id"),r=document.getElementById("mtc-list"),i,s;g=[e.pageX,e.pageY],!r.classList.contains("mosaic")&&!y&&m[0]-g[0]>40&&g[1]-m[1]<20&&g[1]-m[1]>-20&&(actionBar=new a("2Q",t,d.get(n).value,this.hideActionBar),s=document.createDocumentFragment(),actionBar.place(s),t.appendChild(s),w=actionBar,y=!0)},this.hideActionBar=function(t){var n=t.dom.parentElement;n.removeChild(n.lastChild),y=!1,w=null},this.showSearch=function(){var t=document.querySelector(".twoq-searchlist"),n=document.querySelector(".twoq-list");t&&t.classList.contains("invisible")&&(n.classList.add("invisible"),t.classList.remove("invisible"))},this.hideSearch=function(){var t=this.dom.querySelector(".twoq-searchlist"),n=this.dom.querySelector(".twoq-list");t&&!t.classList.contains("invisible")&&(n.classList.remove("invisible"),t.classList.add("invisible"))},this.search=function(t){v.reset([]),t.toLowerCase()?(this.showSearch(),d.loop(function(e,n){JSON.stringify(e).search(t)>-1&&v.alter("push",e)})):this.hideSearch()},p&&(E.query=p),this.init=function(){var t=new f;return d.sync(E.db,E.design,E.view,E.query).then(function(){t.fulfill()}),t}}return function(n,r,i,s,o){return l.prototype=new e,new l(n,r,i,s,o)}});