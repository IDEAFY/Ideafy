/*! Socket.IO.min.js build:0.9.10, production. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */

/**
 * https://github.com/flams/CouchDB-emily-tools
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

/**
 * @license Emily <VERSION> http://flams.github.com/emily
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

/**
 * Emily
 * Copyright(c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 * MIT Licensed
 */

/**
 * @license Olives <VERSION> http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

/**
 * Olives http://flams.github.com/olives
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Olivier Wietrich <Olivier.Wietrich@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/*
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/* 
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Authors: Vincent Weyl <vincent.weyl@taiaut.com> - Olivier Wietrich <Olivier.Wietrich@taiaut.com
 * Copyright (c) 2012-2013 TAIAUT
 */

var io="undefined"==typeof module?{}:module.exports;(function(){(function(e,t){var n=e;n.version="0.9.10",n.protocol=1,n.transports=[],n.j=[],n.sockets={},n.connect=function(e,r){var i=n.util.parseUri(e),s,o;t&&t.location&&(i.protocol=i.protocol||t.location.protocol.slice(0,-1),i.host=i.host||(t.document?t.document.domain:t.location.hostname),i.port=i.port||t.location.port),s=n.util.uniqueUri(i);var u={host:i.host,secure:"https"==i.protocol,port:i.port||("https"==i.protocol?443:80),query:i.query||""};n.util.merge(u,r);if(u["force new connection"]||!n.sockets[s])o=new n.Socket(u);return!u["force new connection"]&&o&&(n.sockets[s]=o),o=o||n.sockets[s],o.of(i.path.length>1?i.path:"")}})("object"==typeof module?module.exports:this.io={},this),function(e,t){var n=e.util={},r=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];n.parseUri=function(e){var t=r.exec(e||""),n={},s=14;while(s--)n[i[s]]=t[s]||"";return n},n.uniqueUri=function(e){var n=e.protocol,r=e.host,i=e.port;return"document"in t?(r=r||document.domain,i=i||(n=="https"&&document.location.protocol!=="https:"?443:document.location.port)):(r=r||"localhost",!i&&n=="https"&&(i=443)),(n||"http")+"://"+r+":"+(i||80)},n.query=function(e,t){var r=n.chunkQuery(e||""),i=[];n.merge(r,n.chunkQuery(t||""));for(var s in r)r.hasOwnProperty(s)&&i.push(s+"="+r[s]);return i.length?"?"+i.join("&"):""},n.chunkQuery=function(e){var t={},n=e.split("&"),r=0,i=n.length,s;for(;r<i;++r)s=n[r].split("="),s[0]&&(t[s[0]]=s[1]);return t};var s=!1;n.load=function(e){if("document"in t&&document.readyState==="complete"||s)return e();n.on(t,"load",e,!1)},n.on=function(e,t,n,r){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener&&e.addEventListener(t,n,r)},n.request=function(e){if(e&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!e||n.ua.hasCORS))return new XMLHttpRequest;if(!e)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}return null},"undefined"!=typeof window&&n.load(function(){s=!0}),n.defer=function(e){if(!n.ua.webkit||"undefined"!=typeof importScripts)return e();n.load(function(){setTimeout(e,100)})},n.merge=function(e,t,r,i){var s=i||[],o=typeof r=="undefined"?2:r,u;for(u in t)t.hasOwnProperty(u)&&n.indexOf(s,u)<0&&(typeof e[u]!="object"||!o?(e[u]=t[u],s.push(t[u])):n.merge(e[u],t[u],o-1,s));return e},n.mixin=function(e,t){n.merge(e.prototype,t.prototype)},n.inherit=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n},n.isArray=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},n.intersect=function(e,t){var r=[],i=e.length>t.length?e:t,s=e.length>t.length?t:e;for(var o=0,u=s.length;o<u;o++)~n.indexOf(i,s[o])&&r.push(s[o]);return r},n.indexOf=function(e,t,n){for(var r=e.length,n=n<0?n+r<0?0:n+r:n||0;n<r&&e[n]!==t;n++);return r<=n?-1:n},n.toArray=function(e){var t=[];for(var n=0,r=e.length;n<r;n++)t.push(e[n]);return t},n.ua={},n.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var e=new XMLHttpRequest}catch(t){return!1}return e.withCredentials!=undefined}(),n.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),n.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(e,t){function n(){}e.EventEmitter=n,n.prototype.on=function(e,n){return this.$events||(this.$events={}),this.$events[e]?t.util.isArray(this.$events[e])?this.$events[e].push(n):this.$events[e]=[this.$events[e],n]:this.$events[e]=n,this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(e,t){function n(){r.removeListener(e,n),t.apply(this,arguments)}var r=this;return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,n){if(this.$events&&this.$events[e]){var r=this.$events[e];if(t.util.isArray(r)){var i=-1;for(var s=0,o=r.length;s<o;s++)if(r[s]===n||r[s].listener&&r[s].listener===n){i=s;break}if(i<0)return this;r.splice(i,1),r.length||delete this.$events[e]}else(r===n||r.listener&&r.listener===n)&&delete this.$events[e]}return this},n.prototype.removeAllListeners=function(e){return e===undefined?(this.$events={},this):(this.$events&&this.$events[e]&&(this.$events[e]=null),this)},n.prototype.listeners=function(e){return this.$events||(this.$events={}),this.$events[e]||(this.$events[e]=[]),t.util.isArray(this.$events[e])||(this.$events[e]=[this.$events[e]]),this.$events[e]},n.prototype.emit=function(e){if(!this.$events)return!1;var n=this.$events[e];if(!n)return!1;var r=Array.prototype.slice.call(arguments,1);if("function"==typeof n)n.apply(this,r);else{if(!t.util.isArray(n))return!1;var i=n.slice();for(var s=0,o=i.length;s<o;s++)i[s].apply(this,r)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){function f(e){return e<10?"0"+e:e}function date(e,t){return isFinite(e.valueOf())?e.getUTCFullYear()+"-"+f(e.getUTCMonth()+1)+"-"+f(e.getUTCDate())+"T"+f(e.getUTCHours())+":"+f(e.getUTCMinutes())+":"+f(e.getUTCSeconds())+"Z":null}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a instanceof Date&&(a=date(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")},JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,typeof JSON!="undefined"?JSON:undefined),function(e,t){var n=e.parser={},r=n.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],i=n.reasons=["transport not supported","client not handshaken","unauthorized"],s=n.advice=["reconnect"],o=t.JSON,u=t.util.indexOf;n.encodePacket=function(e){var t=u(r,e.type),n=e.id||"",a=e.endpoint||"",f=e.ack,l=null;switch(e.type){case"error":var c=e.reason?u(i,e.reason):"",h=e.advice?u(s,e.advice):"";if(c!==""||h!=="")l=c+(h!==""?"+"+h:"");break;case"message":e.data!==""&&(l=e.data);break;case"event":var p={name:e.name};e.args&&e.args.length&&(p.args=e.args),l=o.stringify(p);break;case"json":l=o.stringify(e.data);break;case"connect":e.qs&&(l=e.qs);break;case"ack":l=e.ackId+(e.args&&e.args.length?"+"+o.stringify(e.args):"")}var d=[t,n+(f=="data"?"+":""),a];return l!==null&&l!==undefined&&d.push(l),d.join(":")},n.encodePayload=function(e){var t="";if(e.length==1)return e[0];for(var n=0,r=e.length;n<r;n++){var i=e[n];t+="�"+i.length+"�"+e[n]}return t};var a=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;n.decodePacket=function(e){var t=e.match(a);if(!t)return{};var n=t[2]||"",e=t[5]||"",u={type:r[t[1]],endpoint:t[4]||""};n&&(u.id=n,t[3]?u.ack="data":u.ack=!0);switch(u.type){case"error":var t=e.split("+");u.reason=i[t[0]]||"",u.advice=s[t[1]]||"";break;case"message":u.data=e||"";break;case"event":try{var f=o.parse(e);u.name=f.name,u.args=f.args}catch(l){}u.args=u.args||[];break;case"json":try{u.data=o.parse(e)}catch(l){}break;case"connect":u.qs=e||"";break;case"ack":var t=e.match(/^([0-9]+)(\+)?(.*)/);if(t){u.ackId=t[1],u.args=[];if(t[3])try{u.args=t[3]?o.parse(t[3]):[]}catch(l){}}break;case"disconnect":case"heartbeat":}return u},n.decodePayload=function(e){if(e.charAt(0)=="�"){var t=[];for(var r=1,i="";r<e.length;r++)e.charAt(r)=="�"?(t.push(n.decodePacket(e.substr(r+1).substr(0,i))),r+=Number(i)+1,i=""):i+=e.charAt(r);return t}return[n.decodePacket(e)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t){function n(e,t){this.socket=e,this.sessid=t}e.Transport=n,t.util.mixin(n,t.EventEmitter),n.prototype.heartbeats=function(){return!0},n.prototype.onData=function(e){this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout();if(e!==""){var n=t.parser.decodePayload(e);if(n&&n.length)for(var r=0,i=n.length;r<i;r++)this.onPacket(n[r])}return this},n.prototype.onPacket=function(e){return this.socket.setHeartbeatTimeout(),e.type=="heartbeat"?this.onHeartbeat():(e.type=="connect"&&e.endpoint==""&&this.onConnect(),e.type=="error"&&e.advice=="reconnect"&&(this.isOpen=!1),this.socket.onPacket(e),this)},n.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var e=this;this.closeTimeout=setTimeout(function(){e.onDisconnect()},this.socket.closeTimeout)}},n.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},n.prototype.onConnect=function(){return this.socket.onConnect(),this},n.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},n.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},n.prototype.packet=function(e){this.send(t.parser.encodePacket(e))},n.prototype.onHeartbeat=function(e){this.packet({type:"heartbeat"})},n.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},n.prototype.onClose=function(){var e=this;this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},n.prototype.prepareUrl=function(){var e=this.socket.options;return this.scheme()+"://"+e.host+":"+e.port+"/"+e.resource+"/"+t.protocol+"/"+this.name+"/"+this.sessid},n.prototype.ready=function(e,t){t.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(e){this.options={port:80,secure:!1,document:"document"in n?document:!1,resource:"socket.io",transports:t.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},t.util.merge(this.options,e),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||t.util.ua.hasCORS)){var r=this;t.util.on(n,"beforeunload",function(){r.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function i(){}e.Socket=r,t.util.mixin(r,t.EventEmitter),r.prototype.of=function(e){return this.namespaces[e]||(this.namespaces[e]=new t.SocketNamespace(this,e),e!==""&&this.namespaces[e].packet({type:"connect"})),this.namespaces[e]},r.prototype.publish=function(){this.emit.apply(this,arguments);var e;for(var t in this.namespaces)this.namespaces.hasOwnProperty(t)&&(e=this.of(t),e.$emit.apply(e,arguments))},r.prototype.handshake=function(e){function n(t){t instanceof Error?(r.connecting=!1,r.onError(t.message)):e.apply(null,t.split(":"))}var r=this,s=this.options,o=["http"+(s.secure?"s":"")+":/",s.host+":"+s.port,s.resource,t.protocol,t.util.query(this.options.query,"t="+ +(new Date))].join("/");if(this.isXDomain()&&!t.util.ua.hasCORS){var u=document.getElementsByTagName("script")[0],a=document.createElement("script");a.src=o+"&jsonp="+t.j.length,u.parentNode.insertBefore(a,u),t.j.push(function(e){n(e),a.parentNode.removeChild(a)})}else{var f=t.util.request();f.open("GET",o,!0),this.isXDomain()&&(f.withCredentials=!0),f.onreadystatechange=function(){f.readyState==4&&(f.onreadystatechange=i,f.status==200?n(f.responseText):f.status==403?r.onError(f.responseText):(r.connecting=!1,!r.reconnecting&&r.onError(f.responseText)))},f.send(null)}},r.prototype.getTransport=function(e){var n=e||this.transports,r;for(var i=0,s;s=n[i];i++)if(t.Transport[s]&&t.Transport[s].check(this)&&(!this.isXDomain()||t.Transport[s].xdomainCheck(this)))return new t.Transport[s](this,this.sessionid);return null},r.prototype.connect=function(e){if(this.connecting)return this;var n=this;return n.connecting=!0,this.handshake(function(r,i,s,o){function u(e){n.transport&&n.transport.clearTimeouts(),n.transport=n.getTransport(e);if(!n.transport)return n.publish("connect_failed");n.transport.ready(n,function(){n.connecting=!0,n.publish("connecting",n.transport.name),n.transport.open(),n.options["connect timeout"]&&(n.connectTimeoutTimer=setTimeout(function(){if(!n.connected){n.connecting=!1;if(n.options["try multiple transports"]){var e=n.transports;while(e.length>0&&e.splice(0,1)[0]!=n.transport.name);e.length?u(e):n.publish("connect_failed")}}},n.options["connect timeout"]))})}n.sessionid=r,n.closeTimeout=s*1e3,n.heartbeatTimeout=i*1e3,n.transports||(n.transports=n.origTransports=o?t.util.intersect(o.split(","),n.options.transports):n.options.transports),n.setHeartbeatTimeout(),u(n.transports),n.once("connect",function(){clearTimeout(n.connectTimeoutTimer),e&&typeof e=="function"&&e()})}),this},r.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);if(this.transport&&!this.transport.heartbeats())return;var e=this;this.heartbeatTimeoutTimer=setTimeout(function(){e.transport.onClose()},this.heartbeatTimeout)},r.prototype.packet=function(e){return this.connected&&!this.doBuffer?this.transport.packet(e):this.buffer.push(e),this},r.prototype.setBuffer=function(e){this.doBuffer=e,!e&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},r.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},r.prototype.disconnect=function(){if(this.connected||this.connecting)this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted");return this},r.prototype.disconnectSync=function(){var e=t.util.request(),n=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,t.protocol,"",this.sessionid].join("/")+"/?disconnect=1";e.open("GET",n,!1),e.send(null),this.onDisconnect("booted")},r.prototype.isXDomain=function(){var e=n.location.port||("https:"==n.location.protocol?443:80);return this.options.host!==n.location.hostname||this.options.port!=e},r.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},r.prototype.onOpen=function(){this.open=!0},r.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},r.prototype.onPacket=function(e){this.of(e.endpoint).onPacket(e)},r.prototype.onError=function(e){e&&e.advice&&e.advice==="reconnect"&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",e&&e.reason?e.reason:e)},r.prototype.onDisconnect=function(e){var t=this.connected,n=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1;if(t||n)this.transport.close(),this.transport.clearTimeouts(),t&&(this.publish("disconnect",e),"booted"!=e&&this.options.reconnect&&!this.reconnecting&&this.reconnect())},r.prototype.reconnect=function(){function e(){if(n.connected){for(var e in n.namespaces)n.namespaces.hasOwnProperty(e)&&""!==e&&n.namespaces[e].packet({type:"connect"});n.publish("reconnect",n.transport.name,n.reconnectionAttempts)}clearTimeout(n.reconnectionTimer),n.removeListener("connect_failed",t),n.removeListener("connect",t),n.reconnecting=!1,delete n.reconnectionAttempts,delete n.reconnectionDelay,delete n.reconnectionTimer,delete n.redoTransports,n.options["try multiple transports"]=i}function t(){if(!n.reconnecting)return;if(n.connected)return e();if(n.connecting&&n.reconnecting)return n.reconnectionTimer=setTimeout(t,1e3);n.reconnectionAttempts++>=r?n.redoTransports?(n.publish("reconnect_failed"),e()):(n.on("connect_failed",t),n.options["try multiple transports"]=!0,n.transports=n.origTransports,n.transport=n.getTransport(),n.redoTransports=!0,n.connect()):(n.reconnectionDelay<s&&(n.reconnectionDelay*=2),n.connect(),n.publish("reconnecting",n.reconnectionDelay,n.reconnectionAttempts),n.reconnectionTimer=setTimeout(t,n.reconnectionDelay))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var n=this,r=this.options["max reconnection attempts"],i=this.options["try multiple transports"],s=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(t,this.reconnectionDelay),this.on("connect",t)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(e,t){this.socket=e,this.name=t||"",this.flags={},this.json=new r(this,"json"),this.ackPackets=0,this.acks={}}function r(e,t){this.namespace=e,this.name=t}e.SocketNamespace=n,t.util.mixin(n,t.EventEmitter),n.prototype.$emit=t.EventEmitter.prototype.emit,n.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},n.prototype.packet=function(e){return e.endpoint=this.name,this.socket.packet(e),this.flags={},this},n.prototype.send=function(e,t){var n={type:this.flags.json?"json":"message",data:e};return"function"==typeof t&&(n.id=++this.ackPackets,n.ack=!0,this.acks[n.id]=t),this.packet(n)},n.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1),n=t[t.length-1],r={type:"event",name:e};return"function"==typeof n&&(r.id=++this.ackPackets,r.ack="data",this.acks[r.id]=n,t=t.slice(0,t.length-1)),r.args=t,this.packet(r)},n.prototype.disconnect=function(){return this.name===""?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},n.prototype.onPacket=function(e){function n(){r.packet({type:"ack",args:t.util.toArray(arguments),ackId:e.id})}var r=this;switch(e.type){case"connect":this.$emit("connect");break;case"disconnect":this.name===""?this.socket.onDisconnect(e.reason||"booted"):this.$emit("disconnect",e.reason);break;case"message":case"json":var i=["message",e.data];e.ack=="data"?i.push(n):e.ack&&this.packet({type:"ack",ackId:e.id}),this.$emit.apply(this,i);break;case"event":var i=[e.name].concat(e.args);e.ack=="data"&&i.push(n),this.$emit.apply(this,i);break;case"ack":this.acks[e.ackId]&&(this.acks[e.ackId].apply(this,e.args),delete this.acks[e.ackId]);break;case"error":e.advice?this.socket.onError(e):e.reason=="unauthorized"?this.$emit("connect_failed",e.reason):this.$emit("error",e.reason)}},r.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},r.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(e){t.Transport.apply(this,arguments)}e.websocket=r,t.util.inherit(r,t.Transport),r.prototype.name="websocket",r.prototype.open=function(){var e=t.util.query(this.socket.options.query),r=this,i;return i||(i=n.MozWebSocket||n.WebSocket),this.websocket=new i(this.prepareUrl()+e),this.websocket.onopen=function(){r.onOpen(),r.socket.setBuffer(!1)},this.websocket.onmessage=function(e){r.onData(e.data)},this.websocket.onclose=function(){r.onClose(),r.socket.setBuffer(!0)},this.websocket.onerror=function(e){r.onError(e)},this},t.util.ua.iDevice?r.prototype.send=function(e){var t=this;return setTimeout(function(){t.websocket.send(e)},0),this}:r.prototype.send=function(e){return this.websocket.send(e),this},r.prototype.payload=function(e){for(var t=0,n=e.length;t<n;t++)this.packet(e[t]);return this},r.prototype.close=function(){return this.websocket.close(),this},r.prototype.onError=function(e){this.socket.onError(e)},r.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},r.check=function(){return"WebSocket"in n&&!("__addTask"in WebSocket)||"MozWebSocket"in n},r.xdomainCheck=function(){return!0},t.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(){t.Transport.websocket.apply(this,arguments)}e.flashsocket=n,t.util.inherit(n,t.Transport.websocket),n.prototype.name="flashsocket",n.prototype.open=function(){var e=this,n=arguments;return WebSocket.__addTask(function(){t.Transport.websocket.prototype.open.apply(e,n)}),this},n.prototype.send=function(){var e=this,n=arguments;return WebSocket.__addTask(function(){t.Transport.websocket.prototype.send.apply(e,n)}),this},n.prototype.close=function(){return WebSocket.__tasks.length=0,t.Transport.websocket.prototype.close.call(this),this},n.prototype.ready=function(e,r){function i(){var t=e.options,i=t["flash policy port"],o=["http"+(t.secure?"s":"")+":/",t.host+":"+t.port,t.resource,"static/flashsocket","WebSocketMain"+(e.isXDomain()?"Insecure":"")+".swf"];n.loaded||(typeof WEB_SOCKET_SWF_LOCATION=="undefined"&&(WEB_SOCKET_SWF_LOCATION=o.join("/")),i!==843&&WebSocket.loadFlashPolicyFile("xmlsocket://"+t.host+":"+i),WebSocket.__initialize(),n.loaded=!0),r.call(s)}var s=this;if(document.body)return i();t.util.load(i)},n.check=function(){return typeof WebSocket!="undefined"&&"__initialize"in WebSocket&&!!swfobject?swfobject.getFlashPlayerVersion().major>=10:!1},n.xdomainCheck=function(){return!0},typeof window!="undefined"&&(WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0),t.transports.push("flashsocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window)var swfobject=function(){function e(){if(R)return;try{var e=O.getElementsByTagName("body")[0].appendChild(m("span"));e.parentNode.removeChild(e)}catch(t){return}R=!0;var n=D.length;for(var r=0;r<n;r++)D[r]()}function t(e){R?e():D[D.length]=e}function n(e){if(typeof A.addEventListener!=S)A.addEventListener("load",e,!1);else if(typeof O.addEventListener!=S)O.addEventListener("load",e,!1);else if(typeof A.attachEvent!=S)g(A,"onload",e);else if(typeof A.onload=="function"){var t=A.onload;A.onload=function(){t(),e()}}else A.onload=e}function r(){_?i():s()}function i(){var e=O.getElementsByTagName("body")[0],t=m(x);t.setAttribute("type",C);var n=e.appendChild(t);if(n){var r=0;(function(){if(typeof n.GetVariable!=S){var i=n.GetVariable("$version");i&&(i=i.split(" ")[1].split(","),V.pv=[parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10)])}else if(r<10){r++,setTimeout(arguments.callee,10);return}e.removeChild(t),n=null,s()})()}else s()}function s(){var e=P.length;if(e>0)for(var t=0;t<e;t++){var n=P[t].id,r=P[t].callbackFn,i={success:!1,id:n};if(V.pv[0]>0){var s=v(n);if(s)if(y(P[t].swfVersion)&&!(V.wk&&V.wk<312))w(n,!0),r&&(i.success=!0,i.ref=o(n),r(i));else if(P[t].expressInstall&&u()){var l={};l.data=P[t].expressInstall,l.width=s.getAttribute("width")||"0",l.height=s.getAttribute("height")||"0",s.getAttribute("class")&&(l.styleclass=s.getAttribute("class")),s.getAttribute("align")&&(l.align=s.getAttribute("align"));var c={},h=s.getElementsByTagName("param"),p=h.length;for(var d=0;d<p;d++)h[d].getAttribute("name").toLowerCase()!="movie"&&(c[h[d].getAttribute("name")]=h[d].getAttribute("value"));a(l,c,n,r)}else f(s),r&&r(i)}else{w(n,!0);if(r){var m=o(n);m&&typeof m.SetVariable!=S&&(i.success=!0,i.ref=m),r(i)}}}}function o(e){var t=null,n=v(e);if(n&&n.nodeName=="OBJECT")if(typeof n.SetVariable!=S)t=n;else{var r=n.getElementsByTagName(x)[0];r&&(t=r)}return t}function u(){return!U&&y("6.0.65")&&(V.win||V.mac)&&!(V.wk&&V.wk<312)}function a(e,t,n,r){U=!0,I=r||null,q={success:!1,id:n};var i=v(n);if(i){i.nodeName=="OBJECT"?(j=l(i),F=null):(j=i,F=n),e.id=k;if(typeof e.width==S||!/%$/.test(e.width)&&parseInt(e.width,10)<310)e.width="310";if(typeof e.height==S||!/%$/.test(e.height)&&parseInt(e.height,10)<137)e.height="137";O.title=O.title.slice(0,47)+" - Flash Player Installation";var s=V.ie&&V.win?["Active"].concat("").join("X"):"PlugIn",o="MMredirectURL="+A.location.toString().replace(/&/g,"%26")+"&MMplayerType="+s+"&MMdoctitle="+O.title;typeof t.flashvars!=S?t.flashvars+="&"+o:t.flashvars=o;if(V.ie&&V.win&&i.readyState!=4){var u=m("div");n+="SWFObjectNew",u.setAttribute("id",n),i.parentNode.insertBefore(u,i),i.style.display="none",function(){i.readyState==4?i.parentNode.removeChild(i):setTimeout(arguments.callee,10)}()}c(e,t,n)}}function f(e){if(V.ie&&V.win&&e.readyState!=4){var t=m("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(l(e),t),e.style.display="none",function(){e.readyState==4?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(l(e),e)}function l(e){var t=m("div");if(V.win&&V.ie)t.innerHTML=e.innerHTML;else{var n=e.getElementsByTagName(x)[0];if(n){var r=n.childNodes;if(r){var i=r.length;for(var s=0;s<i;s++)(r[s].nodeType!=1||r[s].nodeName!="PARAM")&&r[s].nodeType!=8&&t.appendChild(r[s].cloneNode(!0))}}}return t}function c(e,t,n){var r,i=v(n);if(V.wk&&V.wk<312)return r;if(i){typeof e.id==S&&(e.id=n);if(V.ie&&V.win){var s="";for(var o in e)e[o]!=Object.prototype[o]&&(o.toLowerCase()=="data"?t.movie=e[o]:o.toLowerCase()=="styleclass"?s+=' class="'+e[o]+'"':o.toLowerCase()!="classid"&&(s+=" "+o+'="'+e[o]+'"'));var u="";for(var a in t)t[a]!=Object.prototype[a]&&(u+='<param name="'+a+'" value="'+t[a]+'" />');i.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+s+">"+u+"</object>",H[H.length]=e.id,r=v(e.id)}else{var f=m(x);f.setAttribute("type",C);for(var l in e)e[l]!=Object.prototype[l]&&(l.toLowerCase()=="styleclass"?f.setAttribute("class",e[l]):l.toLowerCase()!="classid"&&f.setAttribute(l,e[l]));for(var c in t)t[c]!=Object.prototype[c]&&c.toLowerCase()!="movie"&&h(f,c,t[c]);i.parentNode.replaceChild(f,i),r=f}}return r}function h(e,t,n){var r=m("param");r.setAttribute("name",t),r.setAttribute("value",n),e.appendChild(r)}function p(e){var t=v(e);t&&t.nodeName=="OBJECT"&&(V.ie&&V.win?(t.style.display="none",function(){t.readyState==4?d(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function d(e){var t=v(e);if(t){for(var n in t)typeof t[n]=="function"&&(t[n]=null);t.parentNode.removeChild(t)}}function v(e){var t=null;try{t=O.getElementById(e)}catch(n){}return t}function m(e){return O.createElement(e)}function g(e,t,n){e.attachEvent(t,n),B[B.length]=[e,t,n]}function y(e){var t=V.pv,n=e.split(".");return n[0]=parseInt(n[0],10),n[1]=parseInt(n[1],10)||0,n[2]=parseInt(n[2],10)||0,t[0]>n[0]||t[0]==n[0]&&t[1]>n[1]||t[0]==n[0]&&t[1]==n[1]&&t[2]>=n[2]?!0:!1}function b(e,t,n,r){if(V.ie&&V.mac)return;var i=O.getElementsByTagName("head")[0];if(!i)return;var s=n&&typeof n=="string"?n:"screen";r&&(z=null,W=null);if(!z||W!=s){var o=m("style");o.setAttribute("type","text/css"),o.setAttribute("media",s),z=i.appendChild(o),V.ie&&V.win&&typeof O.styleSheets!=S&&O.styleSheets.length>0&&(z=O.styleSheets[O.styleSheets.length-1]),W=s}V.ie&&V.win?z&&typeof z.addRule==x&&z.addRule(e,t):z&&typeof O.createTextNode!=S&&z.appendChild(O.createTextNode(e+" {"+t+"}"))}function w(e,t){if(!X)return;var n=t?"visible":"hidden";R&&v(e)?v(e).style.visibility=n:b("#"+e,"visibility:"+n)}function E(e){var t=/[\\\"<>\.;]/,n=t.exec(e)!=null;return n&&typeof encodeURIComponent!=S?encodeURIComponent(e):e}var S="undefined",x="object",T="Shockwave Flash",N="ShockwaveFlash.ShockwaveFlash",C="application/x-shockwave-flash",k="SWFObjectExprInst",L="onreadystatechange",A=window,O=document,M=navigator,_=!1,D=[r],P=[],H=[],B=[],j,F,I,q,R=!1,U=!1,z,W,X=!0,V=function(){var e=typeof O.getElementById!=S&&typeof O.getElementsByTagName!=S&&typeof O.createElement!=S,t=M.userAgent.toLowerCase(),n=M.platform.toLowerCase(),r=n?/win/.test(n):/win/.test(t),i=n?/mac/.test(n):/mac/.test(t),s=/webkit/.test(t)?parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,o=!1,u=[0,0,0],a=null;if(typeof M.plugins!=S&&typeof M.plugins[T]==x)a=M.plugins[T].description,a&&(typeof M.mimeTypes==S||!M.mimeTypes[C]||!!M.mimeTypes[C].enabledPlugin)&&(_=!0,o=!1,a=a.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),u[0]=parseInt(a.replace(/^(.*)\..*$/,"$1"),10),u[1]=parseInt(a.replace(/^.*\.(.*)\s.*$/,"$1"),10),u[2]=/[a-zA-Z]/.test(a)?parseInt(a.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof A[["Active"].concat("Object").join("X")]!=S)try{var f=new(window[["Active"].concat("Object").join("X")])(N);f&&(a=f.GetVariable("$version"),a&&(o=!0,a=a.split(" ")[1].split(","),u=[parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10)]))}catch(l){}return{w3:e,pv:u,wk:s,ie:o,win:r,mac:i}}(),$=function(){if(!V.w3)return;(typeof O.readyState!=S&&O.readyState=="complete"||typeof O.readyState==S&&(O.getElementsByTagName("body")[0]||O.body))&&e(),R||(typeof O.addEventListener!=S&&O.addEventListener("DOMContentLoaded",e,!1),V.ie&&V.win&&(O.attachEvent(L,function(){O.readyState=="complete"&&(O.detachEvent(L,arguments.callee),e())}),A==top&&function(){if(R)return;try{O.documentElement.doScroll("left")}catch(t){setTimeout(arguments.callee,0);return}e()}()),V.wk&&function(){if(R)return;if(!/loaded|complete/.test(O.readyState)){setTimeout(arguments.callee,0);return}e()}(),n(e))}(),J=function(){V.ie&&V.win&&window.attachEvent("onunload",function(){var e=B.length;for(var t=0;t<e;t++)B[t][0].detachEvent(B[t][1],B[t][2]);var n=H.length;for(var r=0;r<n;r++)p(H[r]);for(var i in V)V[i]=null;V=null;for(var s in swfobject)swfobject[s]=null;swfobject=null})}();return{registerObject:function(e,t,n,r){if(V.w3&&e&&t){var i={};i.id=e,i.swfVersion=t,i.expressInstall=n,i.callbackFn=r,P[P.length]=i,w(e,!1)}else r&&r({success:!1,id:e})},getObjectById:function(e){if(V.w3)return o(e)},embedSWF:function(e,n,r,i,s,o,f,l,h,p){var d={success:!1,id:n};V.w3&&!(V.wk&&V.wk<312)&&e&&n&&r&&i&&s?(w(n,!1),t(function(){r+="",i+="";var t={};if(h&&typeof h===x)for(var v in h)t[v]=h[v];t.data=e,t.width=r,t.height=i;var m={};if(l&&typeof l===x)for(var g in l)m[g]=l[g];if(f&&typeof f===x)for(var b in f)typeof m.flashvars!=S?m.flashvars+="&"+b+"="+f[b]:m.flashvars=b+"="+f[b];if(y(s)){var E=c(t,m,n);t.id==n&&w(n,!0),d.success=!0,d.ref=E}else{if(o&&u()){t.data=o,a(t,m,n,p);return}w(n,!0)}p&&p(d)})):p&&p(d)},switchOffAutoHideShow:function(){X=!1},ua:V,getFlashPlayerVersion:function(){return{major:V.pv[0],minor:V.pv[1],release:V.pv[2]}},hasFlashPlayerVersion:y,createSWF:function(e,t,n){return V.w3?c(e,t,n):undefined},showExpressInstall:function(e,t,n,r){V.w3&&u()&&a(e,t,n,r)},removeSWF:function(e){V.w3&&p(e)},createCSS:function(e,t,n,r){V.w3&&b(e,t,n,r)},addDomLoadEvent:t,addLoadEvent:n,getQueryParamValue:function(e){var t=O.location.search||O.location.hash;if(t){/\?/.test(t)&&(t=t.split("?")[1]);if(e==null)return E(t);var n=t.split("&");for(var r=0;r<n.length;r++)if(n[r].substring(0,n[r].indexOf("="))==e)return E(n[r].substring(n[r].indexOf("=")+1))}return""},expressInstallCallback:function(){if(U){var e=v(k);e&&j&&(e.parentNode.replaceChild(j,e),F&&(w(F,!0),V.ie&&V.win&&(j.style.display="block")),I&&I(q)),U=!1}}}}();(function(){if("undefined"==typeof window||window.WebSocket)return;var e=window.console;if(!e||!e.log||!e.error)e={log:function(){},error:function(){}};if(!swfobject.hasFlashPlayerVersion("10.0.0")){e.error("Flash Player >= 10.0.0 is required.");return}location.protocol=="file:"&&e.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(e,t,n,r,i){var s=this;s.__id=WebSocket.__nextId++,WebSocket.__instances[s.__id]=s,s.readyState=WebSocket.CONNECTING,s.bufferedAmount=0,s.__events={},t?typeof t=="string"&&(t=[t]):t=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(s.__id,e,t,n||null,r||0,i||null)})},0)},WebSocket.prototype.send=function(e){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var t=WebSocket.__flash.send(this.__id,encodeURIComponent(e));return t<0?!0:(this.bufferedAmount+=t,!1)},WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING)return;this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id)},WebSocket.prototype.addEventListener=function(e,t,n){e in this.__events||(this.__events[e]=[]),this.__events[e].push(t)},WebSocket.prototype.removeEventListener=function(e,t,n){if(!(e in this.__events))return;var r=this.__events[e];for(var i=r.length-1;i>=0;--i)if(r[i]===t){r.splice(i,1);break}},WebSocket.prototype.dispatchEvent=function(e){var t=this.__events[e.type]||[];for(var n=0;n<t.length;++n)t[n](e);var r=this["on"+e.type];r&&r(e)},WebSocket.prototype.__handleEvent=function(e){"readyState"in e&&(this.readyState=e.readyState),"protocol"in e&&(this.protocol=e.protocol);var t;if(e.type=="open"||e.type=="error")t=this.__createSimpleEvent(e.type);else if(e.type=="close")t=this.__createSimpleEvent("close");else{if(e.type!="message")throw"unknown event type: "+e.type;var n=decodeURIComponent(e.message);t=this.__createMessageEvent("message",n)}this.dispatchEvent(t)},WebSocket.prototype.__createSimpleEvent=function(e){if(document.createEvent&&window.Event){var t=document.createEvent("Event");return t.initEvent(e,!1,!1),t}return{type:e,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(e,t){if(document.createEvent&&window.MessageEvent&&!window.opera){var n=document.createEvent("MessageEvent");return n.initMessageEvent("message",!1,!1,t,null,null,window,null),n}return{type:e,data:t,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(e){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(e)})},WebSocket.__initialize=function(){if(WebSocket.__flash)return;WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation);if(!window.WEB_SOCKET_SWF_LOCATION){e.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var t=document.createElement("div");t.id="webSocketContainer",t.style.position="absolute",WebSocket.__isFlashLite()?(t.style.left="0px",t.style.top="0px"):(t.style.left="-100px",t.style.top="-100px");var n=document.createElement("div");n.id="webSocketFlash",t.appendChild(n),document.body.appendChild(t),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(t){t.success||e.error("[WebSocket] swfobject.embedSWF failed")})},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var e=0;e<WebSocket.__tasks.length;++e)WebSocket.__tasks[e]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{var t=WebSocket.__flash.receiveEvents();for(var n=0;n<t.length;++n)WebSocket.__instances[t[n].webSocketId].__handleEvent(t[n])}catch(r){e.error(r)}},0),!0},WebSocket.__log=function(t){e.log(decodeURIComponent(t))},WebSocket.__error=function(t){e.error(decodeURIComponent(t))},WebSocket.__addTask=function(e){WebSocket.__flash?e():WebSocket.__tasks.push(e)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var e=window.navigator.mimeTypes["application/x-shockwave-flash"];return!e||!e.enabledPlugin||!e.enabledPlugin.filename?!1:e.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))})(),function(e,t,n){function r(e){if(!e)return;t.Transport.apply(this,arguments),this.sendBuffer=[]}function i(){}e.XHR=r,t.util.inherit(r,t.Transport),r.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},r.prototype.payload=function(e){var n=[];for(var r=0,i=e.length;r<i;r++)n.push(t.parser.encodePacket(e[r]));this.send(t.parser.encodePayload(n))},r.prototype.send=function(e){return this.post(e),this},r.prototype.post=function(e){function t(){this.readyState==4&&(this.onreadystatechange=i,s.posting=!1,this.status==200?s.socket.setBuffer(!1):s.onClose())}function r(){this.onload=i,s.socket.setBuffer(!1)}var s=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),n.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=r:this.sendXHR.onreadystatechange=t,this.sendXHR.send(e)},r.prototype.close=function(){return this.onClose(),this},r.prototype.request=function(e){var n=t.util.request(this.socket.isXDomain()),r=t.util.query(this.socket.options.query,"t="+ +(new Date));n.open(e||"GET",this.prepareUrl()+r,!0);if(e=="POST")try{n.setRequestHeader?n.setRequestHeader("Content-type","text/plain;charset=UTF-8"):n.contentType="text/plain"}catch(i){}return n},r.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},r.check=function(e,r){try{var i=t.util.request(r),s=n.XDomainRequest&&i instanceof XDomainRequest,o=e&&e.options&&e.options.secure?"https:":"http:",u=o!=n.location.protocol;if(i&&(!s||!u))return!0}catch(a){}return!1},r.xdomainCheck=function(e){return r.check(e,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t){function n(e){t.Transport.XHR.apply(this,arguments)}e.htmlfile=n,t.util.inherit(n,t.Transport.XHR),n.prototype.name="htmlfile",n.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var e=this.doc.createElement("div");e.className="socketio",this.doc.body.appendChild(e),this.iframe=this.doc.createElement("iframe"),e.appendChild(this.iframe);var n=this,r=t.util.query(this.socket.options.query,"t="+ +(new Date));this.iframe.src=this.prepareUrl()+r,t.util.on(window,"unload",function(){n.destroy()})},n.prototype._=function(e,t){this.onData(e);try{var n=t.getElementsByTagName("script")[0];n.parentNode.removeChild(n)}catch(r){}},n.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},n.prototype.close=function(){return this.destroy(),t.Transport.XHR.prototype.close.call(this)},n.check=function(e){if(typeof window!="undefined"&&["Active"].concat("Object").join("X")in window)try{var n=new(window[["Active"].concat("Object").join("X")])("htmlfile");return n&&t.Transport.XHR.check(e)}catch(r){}return!1},n.xdomainCheck=function(){return!1},t.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(e,t,n){function r(){t.Transport.XHR.apply(this,arguments)}function i(){}e["xhr-polling"]=r,t.util.inherit(r,t.Transport.XHR),t.util.merge(r,t.Transport.XHR),r.prototype.name="xhr-polling",r.prototype.heartbeats=function(){return!1},r.prototype.open=function(){var e=this;return t.Transport.XHR.prototype.open.call(e),!1},r.prototype.get=function(){function e(){this.readyState==4&&(this.onreadystatechange=i,this.status==200?(s.onData(this.responseText),s.get()):s.onClose())}function t(){this.onload=i,this.onerror=i,s.onData(this.responseText),s.get()}function r(){s.onClose()}if(!this.isOpen)return;var s=this;this.xhr=this.request(),n.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=t,this.xhr.onerror=r):this.xhr.onreadystatechange=e,this.xhr.send(null)},r.prototype.onClose=function(){t.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i;try{this.xhr.abort()}catch(e){}this.xhr=null}},r.prototype.ready=function(e,n){var r=this;t.util.defer(function(){n.call(r)})},t.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(e,t,n){function r(e){t.Transport["xhr-polling"].apply(this,arguments),this.index=t.j.length;var n=this;t.j.push(function(e){n._(e)})}var i=n.document&&"MozAppearance"in n.document.documentElement.style;e["jsonp-polling"]=r,t.util.inherit(r,t.Transport["xhr-polling"]),r.prototype.name="jsonp-polling",r.prototype.post=function(e){function n(){r(),i.socket.setBuffer(!1)}function r(){i.iframe&&i.form.removeChild(i.iframe);try{f=document.createElement('<iframe name="'+i.iframeId+'">')}catch(e){f=document.createElement("iframe"),f.name=i.iframeId}f.id=i.iframeId,i.form.appendChild(f),i.iframe=f}var i=this,s=t.util.query(this.socket.options.query,"t="+ +(new Date)+"&i="+this.index);if(!this.form){var o=document.createElement("form"),u=document.createElement("textarea"),a=this.iframeId="socketio_iframe_"+this.index,f;o.className="socketio",o.style.position="absolute",o.style.top="0px",o.style.left="0px",o.style.display="none",o.target=a,o.method="POST",o.setAttribute("accept-charset","utf-8"),u.name="d",o.appendChild(u),document.body.appendChild(o),this.form=o,this.area=u}this.form.action=this.prepareUrl()+s,r(),this.area.value=t.JSON.stringify(e);try{this.form.submit()}catch(l){}this.iframe.attachEvent?f.onreadystatechange=function(){i.iframe.readyState=="complete"&&n()}:this.iframe.onload=n,this.socket.setBuffer(!0)},r.prototype.get=function(){var e=this,n=document.createElement("script"),r=t.util.query(this.socket.options.query,"t="+ +(new Date)+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),n.async=!0,n.src=this.prepareUrl()+r,n.onerror=function(){e.onClose()};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(n,s),this.script=n,i&&setTimeout(function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)},100)},r.prototype._=function(e){return this.onData(e),this.isOpen&&this.get(),this},r.prototype.ready=function(e,n){var r=this;if(!i)return n.call(this);t.util.load(function(){n.call(r)})},r.check=function(){return"document"in n},r.xdomainCheck=function(){return!0},t.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this)})(),define("lib/socket.io.min",function(){}),define("CouchDBBase",["Store","Tools","Promise"],function(e,t,n){function r(e){return typeof e=="object"&&typeof e.event=="function"?!0:!1}function i(e){return typeof e=="object"&&typeof e.request=="function"&&typeof e.listen=="function"?!0:!1}function s(e){return typeof e=="object"&&typeof e.fulfill=="function"&&typeof e.reject=="function"&&typeof e.then=="function"?!0:!1}function o(){var e=null,t="CouchDB",o=null,u,a=new n;this.setPromise=function(e){return s(e)?(a=e,!0):!1},this.getPromise=function(){return a},this.getStateMachine=function(){return e},this.setStateMachine=function(t){return r(t)?(e=t,!0):!1},this.getTransport=function(){return o},this.setTransport=function(e){return i(e)?(o=e,!0):!1},this.getHandlerName=function(){return t},this.setHandlerName=function(e){return typeof e=="string"?(t=e,!0):!1},this.sync=function(){return a=new n,(u=this.setSyncInfo.apply(this,arguments))?(e.event("sync"),a):!1},this.unsync=function(){return e.event("unsync")},this.getSyncInfo=function(){return u},this.onSync=function(){},this.onListen=function(){},this.onUnsync=function(){this.stopListening&&this.stopListening(),delete this.stopListening},this.unsync=function(){e.event("unsync")},this.onChange=function(){},this.onAdd=function(){},this.onRemove=function(){},this.setSyncInfo=function(e){return u=e}}return function(t){return o.prototype=new e(t),new o}}),define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,n,r,i){function s(){this.setSyncInfo=function(e,t,n){return typeof e=="string"&&typeof t=="string"?!n||typeof n=="object"?{database:e,document:t,query:n||{}}:!1:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document,query:e.query},function(e){var t=JSON.parse(e);t._id&&(this.reset(t),this.getStateMachine().event("listen")),this.getPromise().fulfill(t)},this)},this.onListen=function(){var e=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:{feed:"continuous",heartbeat:2e4,descending:!0}},function(t){var n;if(t=="\n")return!1;n=JSON.parse(t),n.id==e.document&&n.changes.pop().rev!=this.get("_rev")&&(n.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change"))},this)},this.onChange=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document},function(e){this.reset(JSON.parse(e))},this)},this.onRemove=function(){this.reset({})},this.upload=function(){var e=new r,t=this.getSyncInfo();return t.document?(this.getStateMachine().event("upload",e),e):!1},this.remove=function(){var e=this.getSyncInfo(),t=new r;return this.getStateMachine().event("removeFromDatabase",t),t},this.databaseCreate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(t){var n=JSON.parse(t);n.ok?(this.set("_rev",n.rev),this.set("_id",n.id),this.getStateMachine().event("listen"),e.fulfill(n)):e.reject(n)},this)},this.databaseUpdate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json",Connection:"close"},data:this.toJSON()},function(t){var n=JSON.parse(t);n.ok?(this.set("_rev",n.rev),e.fulfill(n)):e.reject(n)},this)},this.databaseRemove=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+t.database+"/"+t.document,query:{rev:this.get("_rev")}},function(t){var n=JSON.parse(t);n.ok?e.fulfill(n):e.reject(n)})},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(e){return s.prototype=new t(e),new s}}),define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(e,t,n,r){function i(){this.setSyncInfo=function(e,t,n,r){return typeof e=="string"&&typeof t=="string"&&typeof n=="string"?!r||typeof r=="object"?{database:e,design:t,view:n,query:r||{}}:!1:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(t){var n=JSON.parse(t);if(!n.rows)throw new Error("CouchDBStore ["+e.database+", "+e.design+", "+e.view+"].sync() failed: "+t);this.reset(n.rows),typeof n.total_rows=="undefined"&&(e.reducedView=!0),this.getStateMachine().event("listen"),this.getPromise().fulfill(n)},this)},this.onListen=function(){var e=this.getSyncInfo();n.mixin({feed:"continuous",heartbeat:2e4,descending:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(t){if(t=="\n")return!1;var n=JSON.parse(t),r;e.reducedView?r="updateReduced":n.deleted?r="remove":n.changes&&n.changes[0].rev.search("1-")==0?r="add":r="change",this.getStateMachine().event(r,n.id)},this)},this.onChange=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){var n=JSON.parse(t);n.rows.length==this.getNbItems()?n.rows.some(function(t,n){t.id==e&&this.set(n,t)},this):this.evenDocsInStore.call(this,n.rows,e)},this)},this.evenDocsInStore=function(e,t){var n=this.getNbItems();e.length<n?this.loop(function(e,n){e.id==t&&this.del(n)},this):e.length>n&&e.some(function(e,n){if(e.id==t)return this.alter("splice",n,0,e)},this)},this.onAdd=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){var n=JSON.parse(t);n.rows.some(function(t,n){t.id==e&&this.alter("splice",n,0,t)},this)},this)},this.onRemove=function(e){this.loop(function(t,n){t.id==e&&this.del(n)},this)},this.updateReduced=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(e){var t=JSON.parse(e);this.set(0,t.rows[0])},this)},this.setStateMachine(new r("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(e){return i.prototype=new t(e),new i}}),define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,n,r,i){function s(){this.setSyncInfo=function(e,t){if(typeof e=="string"&&typeof t=="object"){var n={database:e,query:t||{}};return Array.isArray(n.query.keys)&&(n.keys=n.query.keys,delete n.query.keys),n}return!1},this.onSync=function(){var e=this.getSyncInfo(),t={path:"/"+e.database+"/_all_docs",query:e.query},n;Array.isArray(e.keys)?(t.method="POST",t.data=JSON.stringify({keys:e.keys}),t.headers={"Content-Type":"application/json"},n=t.data):(t.method="GET",n=JSON.stringify(e.query)),e.query.include_docs=!0,this.getTransport().request(this.getHandlerName(),t,function(t){var r=JSON.parse(t);if(!r.rows)throw new Error('CouchDBBulkDocuments.sync("'+e.database+'", '+n+") failed: "+t);this.reset(r.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this)},this)},this.onListen=function(){var e=this.getSyncInfo();n.mixin({feed:"continuous",heartbeat:2e4,descending:!0,include_docs:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(e){var t;if(e=="\n")return!1;var t=JSON.parse(e),n;t.changes[0].rev.search("1-")==0?n="add":t.deleted?n="remove":n="change",this.getStateMachine().event(n,t.id,t.doc)},this)},this.onAdd=function(e){var t=this.getSyncInfo();if(!t.query.startkey&&!t.query.endkey)return!1;t.query.include_docs=!0,t.query.update_seq=!0,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_all_docs",query:t.query},function(t){var n=JSON.parse(t);n.rows.forEach(function(t,n){t.id==e&&this.alter("splice",n,0,t.doc)},this)},this)},this.onChange=function(e,t){this.loop(function(n,r){n.id==e&&this.set(r,t)},this)},this.onRemove=function(e){this.loop(function(t,n){t.id==e&&this.del(n)},this)},this.databaseUpdate=function(e){var t=[],n=this.getSyncInfo();this.loop(function(e){t.push(e.doc)}),this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+n.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:t})},function(t){var n=JSON.parse(t);this.loop(function(e,t){n[t].ok&&(e.doc._rev=n[t].rev)}),e.fulfill(n)},this)},this.upload=function(){var e=new r;return this.getStateMachine().event("upload",e),e},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(e){return s.prototype=new t(e),new s}}),define("CouchDBUser",["CouchDBDocument","Promise"],function(e,t){function n(){var e="_users",n="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(t){return t?(e=t,!0):!1},this.getIdPrefix=function(){return n},this.setIdPrefix=function(e){return e?(n=e,!0):!1},this.setId=function(e){return e?(this.set("_id",n+e),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(t){return this.sync(e,n+t)},this.login=function(){var e=new t,n=this.get("name"),r=this.get("password");return n&&typeof n=="string"&&typeof r=="string"?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+n,auth:n+":"+r},e.fulfill,e):e.reject({error:"name & password must be strings"}),e},this.create=function(){var e=new t;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.load(this.get("name")).then(function(){e.reject({error:"Failed to create user. The user already exists"})},function(){this.upload().then(function(t){e.fulfill(t)},function(t){e.reject(t)})},this),e}}return function(){return n.prototype=new e,new n}}),define("CouchDBSecurity",["CouchDBDocument"],function(e){function t(){var e="_security";this.setName=function(t){return t?(e=t,!0):!1},this.getName=function(){return e},this.load=function(t){return this.sync(t,e)}}return function(){return t.prototype=new e,new t}}),define("lib/couchdbtools",function(){}),define("Tools",[],function(){function e(e,t,n){var r,i;if(!t)return;return t.forEach(function(t,s){var o=n(t,e);o>=0&&(typeof i=="undefined"||o<i)&&(i=o,r=s)}),r}return{getGlobal:function(){var e=function(){return this};return e.call(null)},mixin:function(e,t,n){return this.loop(e,function(r,i){if(!t[i]||!n)t[i]=e[i]}),t},count:function(e){var t=0;return this.loop(e,function(){t++}),t},compareObjects:function(e,t){var n=function(e){return Object.getOwnPropertyNames(e).sort().join("")};return n(e)==n(t)},compareNumbers:function(e,t){return e>t?1:e<t?-1:0},toArray:function(e){return[].slice.call(e)},loop:function(e,t,n){var r,i;if(e instanceof Object&&t instanceof Function){if(e instanceof Array)for(r=0;r<e.length;r++)t.call(n,e[r],r,e);else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e);return!0}return!1},objectsDiffs:function(e,t){if(e instanceof Object&&t instanceof Object){var n=[],r=[],i=[],s=[];return this.loop(t,function(t,i){typeof e[i]=="undefined"?s.push(i):t!==e[i]?r.push(i):t===e[i]&&n.push(i)}),this.loop(e,function(e,n){typeof t[n]=="undefined"&&i.push(n)}),{updated:r,unchanged:n,added:s,deleted:i}}return!1},jsonify:function(e){return e instanceof Object?JSON.parse(JSON.stringify(e)):!1},clone:function(e){return e instanceof Array?e.slice(0):typeof e!="object"||e===null||e instanceof RegExp?!1:this.mixin(e,{})},getNestedProperty:function(e,t){if(e&&e instanceof Object){if(typeof t=="string"&&t!==""){var n=t.split(".");return n.reduce(function(e,t){return e&&e[t]},e)}return typeof t=="number"?e[t]:e}return e},setNestedProperty:function(e,t,n){if(e&&e instanceof Object){if(typeof t=="string"&&t!==""){var r=t.split(".");return r.reduce(function(e,t,i){return e[t]=e[t]||{},r.length==i+1&&(e[t]=n),e[t]},e)}return typeof t=="number"?(e[t]=n,e[t]):e}return e},closest:function(t,n){return e(t,n,function(e,t){return Math.abs(e-t)})},closestGreater:function(t,n){return e(t,n,function(e,t){return e-t})},closestLower:function(t,n){return e(t,n,function(e,t){return t-e})}}}),define("Observable",["Tools"],function(e){return function(){var t={};this.watch=function(e,n,r){if(typeof n=="function"){var i=t[e]=t[e]||[],s=[n,r];return i.push(s),[e,i.indexOf(s)]}return!1},this.unwatch=function(e){var n=e[0],r=e[1];return t[n]&&t[n][r]?(delete t[n][r],t[n].some(function(e){return!!e})||delete t[n],!0):!1},this.notify=function(n){var r=t[n],i=e.toArray(arguments).slice(1);return r?(e.loop(r,function(e){try{e&&e[0].apply(e[1]||null,i)}catch(t){}}),!0):!1},this.hasObserver=function(e){return!!(e&&t[e[0]]&&t[e[0]][e[1]])},this.hasTopic=function(e){return!!t[e]},this.unwatchAll=function(e){return t[e]?delete t[e]:t={},!0}}}),define("StateMachine",["Tools"],function(e){function t(t,r){var i={},s="";this.init=function(e){return i[e]?(s=e,!0):!1},this.add=function(e){if(!i[e]){var t=i[e]=new n;return t}return i[e]},this.get=function(e){return i[e]},this.getCurrent=function(){return s},this.has=function(e){return i.hasOwnProperty(e)},this.advance=function(e){return this.has(e)?(s=e,!0):!1},this.event=function(t){var n;return n=i[s].event.apply(i[s].event,e.toArray(arguments)),n===!1?!1:(n&&(i[s].event("exit"),s=n,i[s].event("entry")),!0)},e.loop(r,function(e,t){var n=this.add(t);e.forEach(function(e){n.add.apply(null,e)})},this),this.init(t)}function n(){var t={};this.add=function(e,n,r,i){var s=[];return t[e]?!1:typeof e=="string"&&typeof n=="function"?(s[0]=n,typeof r=="object"&&(s[1]=r),typeof r=="string"&&(s[2]=r),typeof i=="string"&&(s[2]=i),t[e]=s,!0):!1},this.has=function(e){return!!t[e]},this.get=function(e){return t[e]||!1},this.event=function(n){var r=t[n];return r?(r[0].apply(r[1],e.toArray(arguments).slice(1)),r[2]):!1}}return t}),define("Promise",["Observable","StateMachine"],function(e,t){return function n(){var r=null,i=null,s=new e,o={Pending:[["fulfill",function(e){r=e,s.notify("fulfill",e)},"Fulfilled"],["reject",function(e){i=e,s.notify("reject",e)},"Rejected"],["toFulfill",function(e){s.watch("fulfill",e)}],["toReject",function(e){s.watch("reject",e)}]],Fulfilled:[["toFulfill",function(e){setTimeout(function(){e(r)},0)}]],Rejected:[["toReject",function(e){setTimeout(function(){e(i)},0)}]]},u=new t("Pending",o);this.fulfill=function(e){return u.event("fulfill",e),this},this.reject=function(e){return u.event("reject",e),this},this.then=function(){var e=new n;return arguments[0]instanceof Function?arguments[1]instanceof Function?u.event("toFulfill",this.makeResolver(e,arguments[0])):u.event("toFulfill",this.makeResolver(e,arguments[0],arguments[1])):u.event("toFulfill",this.makeResolver(e,function(){e.fulfill(r)})),arguments[1]instanceof Function&&u.event("toReject",this.makeResolver(e,arguments[1],arguments[2])),arguments[2]instanceof Function&&u.event("toReject",this.makeResolver(e,arguments[2],arguments[3])),!(arguments[1]instanceof Function)&&!(arguments[2]instanceof Function)&&u.event("toReject",this.makeResolver(e,function(){e.reject(i)})),e},this.sync=function(e){if(e instanceof Object&&e.then){var t=function(e){this.fulfill(e)},n=function(e){this.reject(e)};return e.then(t.bind(this),n.bind(this)),!0}return!1},this.makeResolver=function(e,t,n){return function(r){var i;try{i=t.call(n,r),e.sync(i)||e.fulfill(i)}catch(s){e.reject(s)}}},this.getReason=function(){return i},this.getValue=function(){return r},this.getObservable=function(){return s},this.getStateMachine=function(){return u},this.getStates=function(){return o}}}),define("Store",["Observable","Tools"],function(e,t){return function(n){var r=t.clone(n)||{},i=new e,s=new e,o=[],u=function(e){var n=t.objectsDiffs(e,r);["updated","deleted","added"].forEach(function(e){n[e].forEach(function(t){i.notify(e,t,r[t]),s.notify(t,r[t],e)})})};this.getNbItems=function(){return r instanceof Array?r.length:t.count(r)},this.count=this.getNbItems,this.get=function(e){return r[e]},this.has=function(e){return r.hasOwnProperty(e)},this.set=function(e,t){var n,o,u;return typeof e!="undefined"?(n=this.has(e),o=this.get(e),r[e]=t,u=n?"updated":"added",i.notify(u,e,r[e],o),s.notify(e,r[e],u,o),!0):!1},this.update=function(e,n,r){var o;return this.has(e)?(o=this.get(e),t.setNestedProperty(o,n,r),i.notify("updated",n,r),s.notify(e,o,"updated"),!0):!1},this.del=function(e){return this.has(e)?(this.alter("splice",e,1)||(delete r[e],i.notify("deleted",e),s.notify(e,r[e],"deleted")),!0):!1},this.delAll=function(e){return e instanceof Array?(e.sort(t.compareNumbers).reverse().forEach(this.del,this),!0):!1},this.alter=function(e){var n,i;return r[e]?(i=t.clone(r),n=this.proxy.apply(this,arguments),u(i),n):!1},this.proxy=function(e){return r[e]?r[e].apply(r,Array.prototype.slice.call(arguments,1)):!1},this.watch=function(e,t,n){return i.watch(e,t,n)},this.unwatch=function(e){return i.unwatch(e)},this.getStoreObservable=function(){return i},this.watchValue=function(e,t,n){return s.watch(e,t,n)},this.unwatchValue=function(e){return s.unwatch(e)},this.getValueObservable=function(){return s},this.loop=function(e,n){t.loop(r,e,n)},this.reset=function(e){if(e instanceof Object){var n=t.clone(r);return r=t.clone(e)||{},u(n),!0}return!1},this.compute=function(e,n,r,i){var s=[];return typeof e=="string"&&typeof n=="object"&&typeof r=="function"&&!this.isCompute(e)?(o[e]=[],t.loop(n,function(t){o[e].push(this.watchValue(t,function(){this.set(e,r.call(i))},this))},this),this.set(e,r.call(i)),!0):!1},this.removeCompute=function(e){return this.isCompute(e)?(t.loop(o[e],function(e){this.unwatchValue(e)},this),this.del(e),!0):!1},this.isCompute=function(e){return!!o[e]},this.toJSON=function(){return JSON.stringify(r)},this.dump=function(){return r}}}),define("Transport",[],function(){return function(e){var t=null;this.setReqHandlers=function(e){return e instanceof Object?(t=e,!0):!1},this.getReqHandlers=function(){return t},this.request=function(e,n,r,i){return t.has(e)&&typeof n!="undefined"?(t.get(e)(n,function(){r&&r.apply(i,arguments)}),!0):!1},this.listen=function(e,n,r,i){if(t.has(e)&&typeof n!="undefined"&&typeof r=="function"){var s=function(){r.apply(i,arguments)},o;return o=t.get(e)(n,s,s),function(){typeof o=="function"?o():typeof o=="object"&&typeof o.func=="function"&&o.func.call(o.scope)}}return!1},this.setReqHandlers(e)}}),define("lib/emily",function(){}),define("DomUtils",["Tools"],function(e){return{getNodes:function(e,t){return this.isAcceptedType(e)?(e.parentNode||document.createDocumentFragment().appendChild(e),e.parentNode.querySelectorAll(t||"*")):!1},getDataset:function(e){var t=0,n,r={},i,s;if(this.isAcceptedType(e)){if(e.hasOwnProperty("dataset"))return e.dataset;for(n=e.attributes.length;t<n;t++)i=e.attributes[t].name.split("-"),i.shift()=="data"&&(r[s=i.join("-")]=e.getAttribute("data-"+s));return r}return!1},isAcceptedType:function(e){return e instanceof HTMLElement||e instanceof SVGElement?!0:!1},setAttribute:function(e,t,n){return e instanceof HTMLElement?(e[t]=n,!0):e instanceof SVGElement?(e.setAttribute(t,n),!0):!1},matches:function(t,n,r){return e.toArray(this.getNodes(t,n)).indexOf(r)>-1}}}),define("Bind.plugin",["Store","Observable","Tools","DomUtils"],function(e,t,n,r){return function(t,i){function s(e){f[e]&&f[e].forEach(function(e){o.unwatchValue(e)}),delete f[e]}var o=null,u={},a={},f={};this.observers=f,this.setModel=function(t){return t instanceof e?(o=t,!0):!1},this.getModel=function(){return o},this.ItemRenderer=function(e,t){var i=null,u=null,a=null,f=null,l=null;this.setRenderer=function(e){return i=e,!0},this.getRenderer=function(){return i},this.setRootNode=function(e){var t;return r.isAcceptedType(e)?(a=e,t=a.querySelector("*"),this.setRenderer(t),t&&a.removeChild(t),!0):!1},this.getRootNode=function(){return a},this.setPlugins=function(e){return u=e,!0},this.getPlugins=function(){return u},this.items={},this.setStart=function(e){return f=parseInt(e,10)},this.getStart=function(){return f},this.setNb=function(e){return l=e=="*"?e:parseInt(e,10)},this.getNb=function(){return l},this.addItem=function(e){var t,n;return typeof e=="number"&&!this.items[e]?(n=this.getNextItem(e),t=this.create(e),t?(n?a.insertBefore(t,n):a.appendChild(t),!0):!1):!1},this.getNextItem=function(e){var t=Object.keys(this.items).map(function(e){return Number(e)}),r=n.closestGreater(e,t),i=t[r];if(i!=e)return this.items[i];return},this.removeItem=function(e){var t=this.items[e];return t?(a.removeChild(t),delete this.items[e],s(e),!0):!1},this.create=function(e){if(o.has(e)){var t=i.cloneNode(!0),s=r.getNodes(t);return n.toArray(s).forEach(function(t){t.setAttribute("data-"+u.name+"_id",e)}),this.items[e]=t,u.apply(t),t}},this.render=function(){var e=l=="*"?o.getNbItems():l,t=[];if(l!==null&&f!==null){n.loop(this.items,function(n,r){r=Number(r),(r<f||r>=f+e||!o.has(r))&&t.push(r)},this),t.sort(n.compareNumbers).reverse().forEach(this.removeItem,this);for(var r=f,i=e+f;r<i;r++)this.addItem(r);return!0}return!1},this.setPlugins(e),this.setRootNode(t)},this.setItemRenderer=function(e,t){e=e||"default",a[e]=t},this.getItemRenderer=function(e){return a[e]},this.foreach=function(e,t,n,r){var i=new this.ItemRenderer(this.plugins,e);i.setStart(n||0),i.setNb(r||"*"),i.render(),o.watch("added",i.render,i),o.watch("deleted",function(e){i.render(),s(e)},this),this.setItemRenderer(t,i)},this.updateStart=function(e,t){var n=this.getItemRenderer(e);return n?(n.setStart(t),!0):!1},this.updateNb=function(e,t){var n=this.getItemRenderer(e);return n?(n.setNb(t),!0):!1},this.refresh=function(e){var t=this.getItemRenderer(e);return t?(t.render(),!0):!1},this.bind=function(e,t,i){i=i||"";var s=e.getAttribute("data-"+this.plugins.name+"_id"),u=i.split("."),a=s||u.shift(),f=s?i:u.join("."),l=n.getNestedProperty(o.get(a),f),c=n.toArray(arguments).slice(3);if(l||l===0||l===!1)this.execBinding.apply(this,[e,t,l].concat(c))||r.setAttribute(e,t,l);this.hasBinding(t)||e.addEventListener("change",function(n){o.has(a)&&(f?o.update(a,i,e[t]):o.set(a,e[t]))},!0),this.observers[a]=this.observers[a]||[],this.observers[a].push(o.watchValue(a,function(i){this.execBinding.apply(this,[e,t,n.getNestedProperty(i,f)].concat(c))||r.setAttribute(e,t,n.getNestedProperty(i,f))},this))},this.set=function(e){return r.isAcceptedType(e)&&e.name?(o.set(e.name,e.value),!0):!1},this.getItemIndex=function(e){var t=r.getDataset(e);return t&&typeof t[this.plugins.name+"_id"]!="undefined"?+t[this.plugins.name+"_id"]:!1},this.form=function l(l){if(l&&l.nodeName=="FORM"){var e=this;return l.addEventListener("submit",function(t){n.toArray(l.querySelectorAll("[name]")).forEach(e.set,e),t.preventDefault()},!0),!0}return!1},this.addBinding=function(e,t){return e&&typeof e=="string"&&typeof t=="function"?(u[e]=t,!0):!1},this.execBinding=function(e,t){return this.hasBinding(t)?(u[t].apply(e,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(e){return u.hasOwnProperty(e)},this.getBinding=function(e){return u[e]},this.addBindings=function(e){return n.loop(e,function(e,t){this.addBinding(t,e)},this)},this.setModel(t),this.addBindings(i)}}),define("Event.plugin",["DomUtils"],function(e){return function(t,n){var r=null,i={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},s=!!n;this.addEventListener=function(e,t,n,r){e.addEventListener(this.map(t),n,!!r)},this.listen=function(e,t,n,i){this.addEventListener(e,t,function(t){r[n].call(r,t,e)},!!i)},this.delegate=function(t,n,i,s,o){this.addEventListener(t,i,function(i){e.matches(t,n,i.target)&&r[s].call(r,i,t)},!!o)},this.getParent=function(){return r},this.setParent=function(e){return e instanceof Object?(r=e,!0):!1},this.map=function(e){return s?i[e]||e:e},this.setMap=function(e,t){return typeof e=="string"&&typeof t=="string"?(i[e]=t,!0):!1},this.setParent(t)}}),define("LocalStore",["Store","Tools"],function(e,t){function n(){var e=null,n=localStorage,r=function(){n.setItem(e,this.toJSON())};this.setLocalStorage=function(e){return e&&e.setItem instanceof Function?(n=e,!0):!1},this.getLocalStorage=function(){return n},this.sync=function(i){var s;return typeof i=="string"?(e=i,s=JSON.parse(n.getItem(i)),t.loop(s,function(e,t){this.has(t)||this.set(t,e)},this),r.call(this),this.watch("added",r,this),this.watch("updated",r,this),this.watch("deleted",r,this),!0):!1}}return function(t){return n.prototype=new e(t),new n}}),define("Plugins",["Tools","DomUtils"],function(e,t){return function(n){var r={},i=function(e){return e.trim()},s=function(e,t,n){t.split(";").forEach(function(t){var s=t.split(":"),o=s[0].trim(),u=s[1]?s[1].split(",").map(i):[];u.unshift(e),r[n]&&r[n][o]&&r[n][o].apply(r[n],u)})};this.add=function(e,t){var n=this,i="plugins";return typeof e=="string"&&typeof t=="object"&&t?(r[e]=t,t[i]={name:e,apply:function(){return n.apply.apply(n,arguments)}},!0):!1},this.addAll=function(t){return e.loop(t,function(e,t){this.add(t,e)},this)},this.get=function(e){return r[e]},this.del=function(e){return delete r[e]},this.apply=function(n){var r;return t.isAcceptedType(n)?(r=t.getNodes(n),e.loop(e.toArray(r),function(n){e.loop(t.getDataset(n),function(e,t){s(n,e,t)})}),n):!1},this.addAll(n)}}),define("OObject",["StateMachine","Store","Plugins","DomUtils","Tools"],function(e,t,n,r,i){return function(s){var o=function(e){var t=f||document.createElement("div");if(!e.template)throw Error("UI.template must be set prior to render");typeof e.template=="string"?t.innerHTML=e.template.trim():r.isAcceptedType(e.template)&&t.appendChild(e.template);if(t.childNodes.length>1)throw Error("UI.template should have only one parent node");e.dom=t.childNodes[0],e.plugins.apply(e.dom)},u=function c(e,c,t){c&&(t?c.insertBefore(e.dom,t):c.appendChild(e.dom),f=c)},a=function(e,t){o(e),u.apply(null,i.toArray(arguments))},f=null,l=new e("Init",{Init:[["render",o,this,"Rendered"],["place",a,this,"Rendered"]],Rendered:[["place",u,this],["render",o,this]]});this.model=s instanceof t?s:new t,this.plugins=new n,this.template=null,this.dom=null,this.place=function(e,t){l.event("place",this,e,t)},this.render=function(){l.event("render",this)},this.setTemplateFromDom=function(e){return r.isAcceptedType(e)?(this.template=e,!0):!1},this.alive=function(e){return r.isAcceptedType(e)?(this.setTemplateFromDom(e),this.place(e.parentNode,e.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return f}}}),define("Place.plugin",["OObject","Tools"],function(e,t){return function(n){var r={};this.place=function(t,n){if(!(r[n]instanceof e))throw new Error(n+" is not an OObject UI in place:"+n);r[n].place(t)},this.set=function(t,n){return typeof t=="string"&&n instanceof e?(r[t]=n,!0):!1},this.setAll=function(e){t.loop(e,function(e,t){this.set(t,e)},this)},this.get=function(e){return r[e]},this.setAll(n)}}),define("SocketIOTransport",["Observable","Tools"],function(e,t){return function(e){var t=null;this.setSocket=function(e){return e&&typeof e.emit=="function"?(t=e,!0):!1},this.getSocket=function(){return t},this.on=function(e,n){return t.on(e,n)},this.once=function(e,n){return t.once(e,n)},this.emit=function(e,n,r){return t.emit(e,n,r)},this.removeListener=function(e,n,r){return t.removeListener(e,n,r)},this.request=function(e,t,n,r){if(typeof e=="string"&&typeof t!="undefined"){var i={eventId:Date.now()+Math.floor(Math.random()*1e6),data:t},s=function(){n&&n.apply(r||null,arguments)};return this.once(i.eventId,s),this.emit(e,i),!0}return!1},this.listen=function(e,t,n,r){if(typeof e=="string"&&typeof t!="undefined"&&typeof n=="function"){var i={eventId:Date.now()+Math.floor(Math.random()*1e6),data:t,keepAlive:!0},s=function(){n&&n.apply(r||null,arguments)},o=this;return this.on(i.eventId,s),this.emit(e,i),function(){o.emit("disconnect-"+i.eventId),o.removeListener(i.eventId,s)}}return!1},this.setSocket(e)}}),define("lib/olives",function(){}),define("Amy/DomUtils",["DomUtils","Tools"],function(e,t){return{hasQuerySelector:function(n,r,i){return t.toArray(e.getNodes(n,i)).indexOf(r)>-1}}}),define("Amy/TestUtils",[],function(){var e=function(e){return typeof e=="string"},t=function(t,n){throw new Error(e(n)?n:t)};return{assertIsObject:function(e,n){return e instanceof Object||t("Is not Object",n),!0},assertIsObservable:function(e,n){return(!e||typeof e["watch"]!="function"||typeof e["notify"]!="function")&&t("Is not Observable",n),!0},assertIsString:function(n,r){return e(n)||t("Is not String",r),!0}}}),define("Amy/Stack-plugin",["Amy/Stack-service"],function(e){return function(t,n){var r=new e(t,n);this.getStack=function(){return r},this.destination=function(e){r.setDestination(e)},this.hide=function(){r.hide()},this.show=function(e,t,n,i){e.addEventListener(t,function(e){r.show(e.target.getAttribute(n))},i=="true")}}}),define("Amy/Event-controller",["Amy/TestUtils","Tools"],function(e,t){return function(e,n){var r=e instanceof Object?e:null,i=function(e){return typeof e=="boolean"?e:!1},s=function(){var e=!0,t;for(t=arguments.length;t>=0;t--)e=e&&typeof arguments[t]=="string";return e},o=i(n),u={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"};this.addListener=function(e,t,n,r){e.addEventListener(this.map(t),n,r)},this.call=function(e){r[e].apply(r,t.toArray(arguments).slice(1))},this.isTouch=function(){return o},this.setTouch=function(e){return i(e)?(o=e,!0):!1},this.setMap=function(e,t){return s(e,t)?(u[e]=t,!0):!1},this.map=function(e){var t=u[e];return t&&o?t:e},this.setScope=function(e){return r=e,!0},this.scope=function(){return r}}}),define("Amy/Delegate-plugin",["Amy/Event-controller","Amy/DomUtils"],function(e,t){function n(){this.listen=function(e,t,n,r){var i=this;this.addListener(e,t,function(t){i.call(n,t,e)},r=="true")},this.selector=function(e,n,r,i,s){var o=this;this.addListener(e,r,function(r){t.hasQuerySelector(e,r.target,n)&&o.call(i,r,e)},s=="true")}}return function(t,r){return n.prototype=new e(t,r),new n}}),define("Amy/Control-plugin",["Amy/Event-controller","Amy/DomUtils"],function(e,t){function n(){var e=null;this.init=function(t){e=t},this.radio=function(n,r,i,s,o,u){var a=this;this.addListener(n,s,function(s){var u=s.target;t.hasQuerySelector(n,u,r)&&(a.radioClass(u,e,i),e=u,a.call(o,s))},u=="true")},this.radioClass=function(e,t,n){e.classList.add(n),t&&t!=e&&t.classList.remove(n)},this.toggleClass=function(e,t){return e.classList.toggle(t)},this.toggle=function(e,n,r,i,s,o){var u=this;this.addListener(e,i,function(i){var o=i.target;t.hasQuerySelector(e,o,n)&&(u.toggleClass(o,r),u.call(s,i))},o=="true")}}return function(t,r){return n.prototype=new e(t,r),new n}}),define("Amy/Stack-service",["Store","OObject","DomUtils","Tools"],function(e,t,n,r){return function(r,i){var s=new e(r),o=i,u="",a=null;this.setDestination=function(e){return n.isAcceptedType(e)?(o=e,!0):!1},this.getDestination=function(){return o},this.setCurrentScreen=function(e){a=e},this.getCurrentScreen=function(){return a},this.add=function(e,n){return typeof e=="string"&&n instanceof t?(s.set(e,n),this.hide(n),!0):!1},this.get=function(e){return s.get(e)},this.del=function(e){return s.del(e)},this.reset=function(e){return s.reset(e)},this.getCurrentName=function(){return u},this.show=function(e){var t=this.get(e);return t&&e!==u?(t.place(o),a&&this.hide(a),this.setCurrentScreen(t),u=e,!0):!1},this.hide=function(e){e.place(document.createDocumentFragment())}}}),define("lib/amy2",function(){}),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("lib/spin.min",t):e.Spinner=t()}(this,function(){function e(e,t){var n=document.createElement(e||"div"),r;for(r in t)n[r]=t[r];return n}function t(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function n(e,t,n,r){var i=["opacity",t,~~(e*100),n,r].join("-"),s=.01+n/r*100,o=Math.max(1-(1-e)/t*(100-s),e),u=c.substring(0,c.indexOf("Animation")).toLowerCase(),a=u&&"-"+u+"-"||"";return l[i]||(h.insertRule("@"+a+"keyframes "+i+"{"+"0%{opacity:"+o+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+o+"}"+"}",h.cssRules.length),l[i]=1),i}function r(e,t){var n=e.style,r,i;if(n[t]!==undefined)return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(i=0;i<f.length;i++){r=f[i]+t;if(n[r]!==undefined)return r}}function i(e,t){for(var n in t)e.style[r(e,n)||n]=t[n];return e}function s(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]===undefined&&(e[r]=n[r])}return e}function o(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function u(e){if(typeof this=="undefined")return new u(e);this.opts=s(e||{},u.defaults,p)}function a(){function n(t,n){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',n)}h.addRule(".spin-vml","behavior:url(#default#VML)"),u.prototype.lines=function(e,r){function s(){return i(n("group",{coordsize:a+" "+a,coordorigin:-u+" "+ -u}),{width:a,height:a})}function o(e,o,a){t(l,t(i(s(),{rotation:360/r.lines*e+"deg",left:~~o}),t(i(n("roundrect",{arcsize:r.corners}),{width:u,height:r.width,left:r.radius,top:-r.width>>1,filter:a}),n("fill",{color:r.color,opacity:r.opacity}),n("stroke",{opacity:0}))))}var u=r.length+r.width,a=2*u,f=-(r.width+r.length)*2+"px",l=i(s(),{position:"absolute",top:f,left:f}),c;if(r.shadow)for(c=1;c<=r.lines;c++)o(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=r.lines;c++)o(c);return t(e,l)},u.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}}var f=["webkit","Moz","ms","O"],l={},c,h=function(){var n=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],n),n.sheet||n.styleSheet}(),p={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};u.defaults={},s(u.prototype,{spin:function(t){this.stop();var n=this,r=n.opts,s=n.el=i(e(0,{className:r.className}),{position:r.position,width:0,zIndex:r.zIndex}),u=r.radius+r.length+r.width,a,f;t&&(t.insertBefore(s,t.firstChild||null),f=o(t),a=o(s),i(s,{left:(r.left=="auto"?f.x-a.x+(t.offsetWidth>>1):parseInt(r.left,10)+u)+"px",top:(r.top=="auto"?f.y-a.y+(t.offsetHeight>>1):parseInt(r.top,10)+u)+"px"})),s.setAttribute("role","progressbar"),n.lines(s,n.opts);if(!c){var l=0,h=(r.lines-1)*(1-r.direction)/2,p,d=r.fps,v=d/r.speed,m=(1-r.opacity)/(v*r.trail/100),g=v/r.lines;(function y(){l++;for(var e=0;e<r.lines;e++)p=Math.max(1-(l+(r.lines-e)*g)%v*m,r.opacity),n.opacity(s,e*r.direction+h,p,r);n.timeout=n.el&&setTimeout(y,~~(1e3/d))})()}return n},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=undefined),this},lines:function(r,s){function o(t,n){return i(e(),{position:"absolute",width:s.length+s.width+"px",height:s.width+"px",background:t,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/s.lines*u+s.rotate)+"deg) translate("+s.radius+"px"+",0)",borderRadius:(s.corners*s.width>>1)+"px"})}var u=0,a=(s.lines-1)*(1-s.direction)/2,f;for(;u<s.lines;u++)f=i(e(),{position:"absolute",top:1+~(s.width/2)+"px",transform:s.hwaccel?"translate3d(0,0,0)":"",opacity:s.opacity,animation:c&&n(s.opacity,s.trail,a+u*s.direction,s.lines)+" "+1/s.speed+"s linear infinite"}),s.shadow&&t(f,i(o("#000","0 0 4px #000"),{top:"2px"})),t(r,t(f,o(s.color,"0 0 1px rgba(0,0,0,.1)")));return r},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}});var d=i(e("group"),{behavior:"url(#default#VML)"});return!r(d,"transform")&&d.adj?a():c=r(d,"animation"),u}),define("service/map",["Store"],function(e){return new e({body:document.body,login:document.getElementById("login"),"login-form":document.getElementById("login-form"),"signup-form":document.getElementById("signup-form"),loading:document.getElementById("loading"),serverdown:document.getElementById("serverdown"),nointernet:document.getElementById("nointernet"),dock:document.getElementById("wrapper"),notify:document.getElementById("notify"),"notify-popup":document.getElementById("notify-popup"),"newidea-popup":document.getElementById("newidea-popup"),"new2q-popup":document.getElementById("new2q-popup"),"new2c-popup":document.getElementById("new2c-popup"),"help-popup":document.getElementById("help-popup"),"tip-popup":document.getElementById("tip-popup"),cache:document.getElementById("cache"),"public":document.getElementById("public"),"public-menu":document.getElementById("public-menu"),"public-detail":document.getElementById("public-detail"),"public-writetwocents":document.getElementById("public-writetwocents"),"public-twocents":document.getElementById("public-twocents"),"public-edit":document.querySelector("#public-detail .idea-edit"),"public-sendmail":document.querySelector("#public-detail .idea-sendmail"),"public-share":document.querySelector("#public-detail .idea-share"),brainstorm:document.getElementById("brainstorm"),"brainstorm-menu":document.getElementById("brainstorm-menu"),"ideafy-menu":document.getElementById("ideafy-menu"),"ideafy-quick":document.getElementById("ideafy-quick"),"ideafy-multi":document.getElementById("ideafy-multi"),quickstart:document.getElementById("quickstart"),mustart:document.getElementById("mustart"),quicksetup:document.getElementById("quicksetup"),quickscenario:document.getElementById("quickscenario"),"scenario-whiteboard":document.getElementById("scenario-whiteboard"),quicktech:document.getElementById("quicktech"),quickidea:document.getElementById("quickidea"),quickwrapup:document.getElementById("quickwrapup"),library:document.getElementById("library"),"library-menu":document.getElementById("library-menu"),ideas:document.getElementById("ideas"),"ideas-detail":document.getElementById("ideas-detail"),"library-idea":document.querySelector("library-idea"),"library-writetwocents":document.getElementById("library-writetwocents"),"library-twocents":document.getElementById("library-twocents"),"library-edit":document.querySelector("#ideas-detail .idea-edit"),"library-sendmail":document.querySelector("#ideas-detail .idea-sendmail"),"library-share":document.querySelector("#ideas-detail .idea-share"),sessions:document.getElementById("sessions"),decks:document.getElementById("decks"),decklist:document.getElementById("decklist"),deckview:document.getElementById("deckview"),connect:document.getElementById("connect"),"connect-menu":document.getElementById("connect-menu"),"connect-messages":document.getElementById("connect-messages"),msgdetail:document.getElementById("msgdetail"),"connect-contacts":document.getElementById("connect-contacts"),contactdetails:document.getElementById("contactdetails"),"connect-twocents":document.getElementById("connect-twocents"),dashboard:document.getElementById("dashboard"),"dashboard-menu":document.getElementById("dashboard-menu"),"dashboard-profile":document.getElementById("dashboard-profile"),leaderboard:document.getElementById("leaderboard"),"dashboard-settings":document.getElementById("dashboard-settings"),"dashboard-about":document.getElementById("dashboard-about")})}),define("service/config",["Store","SocketIOTransport","CouchDBDocument","Observable"],function(e,t,n,r){var i,s,o,u,a=new e,f;return this.reset=function(){i="http://8.19.34.68:1664",f=io.connect(i),s=new t(f),o=new n,u=new r,o.setTransport(s),a.reset({location:i,socket:f,transport:s,db:"ideafy",user:o,observer:u,polling_interval:6e4,userTemplate:{lastname:"",firstname:"",address:{street1:"",street2:"",zip:null,state:"",city:"",country:""},gender:1,lang:"en-us",birthdate:[],connections:[],taiaut_decks:["INT"],custom_decks:[],active_deck:"INT",occupation:{situation:"",job:"",organization:""},family:{couple:null,children:null},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],type:7,notifications:[],sentMessages:[],facebook:"",twitter:"",gplus:"",linkedin:"",username:"",sessionInProgress:{},organization:"",rated:[],rated_ideas:[],favorites:[],ip:0,picture_file:"img/avatars/deedee0.png",intro:"Ideafyer",title:null,achievements:[],ideas_count:0,su_sessions_count:0,mu_sessions_count:0,twocents_count:0,twoquestions_count:0,tutorial_complete:!1,profile_complete:!1,news:[],twocents:[],twoquestions:[],settings:{notifyPopup:!0,useascharacter:!1,ccme:!1,privacy_lvl:0,showTips:!0,startupScreen:"#public",listSize:null,polling_interval:6e4}},ideaTemplate:{title:"",sessionId:"",sessionReplay:!1,authors:[],description:"",solution:"",creation_date:[],character:"",problem:"",lang:"en-us",context:"",techno:[],type:6,sharedwith:[],modification_date:[],inspired_by:"",visibility:"private",votes:[],rating:"",authornames:"",twocents:[]},TQTemplate:{author:[],question:"",creation_date:[],lang:"en-us",type:10,modification_date:[],votes:[],rating:"",username:"",twocents:[]},sessionTemplate:{title:"",description:"",initiator:{id:"",username:"",picture_file:""},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"",type:8,deck:"",status:"in progress",step:"",lang:"en-us",characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:0,sessionReplay:!1},avatars:new e({}),avatar:null,defaultLabels:{language:"en-us",emailplaceholder:"Email",passwordplaceholder:"Password",repeatpasswordplaceholder:"Confirm password",loginbutton:"Log in",newuserbutton:"New user",invalidlogin:"Invalid username or password",missingloginparam:"Please enter both username and password or register",signupmissingemail:"Please enter your email address in the field above",signupmissingpwd:"A password is required",signupmissingpwdok:"Please confirm your password",signupmissingfn:"Please enter your first name",signupmisingln:"Please enter your last name",signupinvalidemail:"Invalid email address",signuppwdnomatch:"Passwords do not match",signupwelcomeobject:"Welcome to Ideady",signupwelcomebody:"Thank you for trying Ideafy. We hope you'll enjoy it. We designed it so you can manage ideas that matter to you or just play around. But don't keep what you're doing to yourself.",signupbutton:"Sign up",Initialization:"Initializing user data. Please wait ...",firstnameplaceholder:"First name",lastnameplaceholder:"Last name",createidealbl:"Enter a new idea",ideatitleplaceholder:"Enter a title for your idea",ideadescplaceholder:"Enter a description of your idea in non technical terms",ideasolplaceholder:"Describe how your idea would work, what components, products, services or technologies you would  use",privatelbl:"Private",publiclbl:"Public",ideavisiblelbl:"Your idea is ",setideavisiblelbl:"Change status:",ideafyreplaylbl:"Ideafy Replay is",ideafysetreplaylbl:"Change Ideafy Replay status: ",enabledreplaylbl:"Enabled",disabledreplaylbl:"Disabled",enablereplaylbl:"Enable",disablereplaylbl:"Disable",oklbl:"Ok",continuelbl:"Continue",setpublicquestion:"Warning, every Ideafy user will be able to view your idea. This operation is irreversible. Do you want to proceed?",publicideasheadertitle:"Public Ideas",publicdetailsheadertitle:"Idea overview",searchpublicplaceholder:"Search public ideas...",ideadetailsheadertitle:"Idea Overview",idealistheadertitle:"My Ideas",searchprivateplaceholder:"Search your ideas...",modifyidealbl:"Modify your idea",sendidealbl:"Email your idea",sharedwith:"Shared with ",ideafyer:" Ideafyer",ideafyers:" Ideafyers",votebuttonlbl:"Vote",novotesyet:"No vote yet",onevote:"1 vote",votes:"votes",ideawrotelbl:" wrote : ",twocentcommentlbl:"commented :",youwrotelbl:"wrote :",theywrotelbl:"wrote :",youcommentedlbl:"commented :",youlbl:"You",hidetwocentreplies:"Hide replies",showonetcreply:"Reply",showtcrepliesbefore:"",showtcrepliesafter:" Replies",twocentreplycommentlbl:"replied :",yourepliedlbl:"replied :",addtwocentplaceholder:"Add your two cents",addtwocentreplyplaceholder:"Respond to this comment",twocentcreationdate:"Creation date: ",twocentmodificationdate:"Last modified: ",cancellbl:"Cancel",publishlbl:"Publish",titlefield:"Title field",descriptionfield:"Description field",solutionfield:"Solution field",emptyfielderror:" cannot be left empty",somethingwrong:"Something went wrong, please try again later",thankyou:"Thank you",loadingmessage:"Application loading, please wait...",maintenancemessage:"We're sorry. The server is currently unavailable. Please come back later.","library-ideas":"My Ideas","library-sessions":"My Ideafy Sessions",sbytitle:"Session title",sbydate:"Date",sbyidea:"Idea title",sbyscore:"Score",searchsessions:"Search previous sessions...",foundlbl:"Found",matchingsessions:"matching session(s)",noideayet:"---",completed:"completed",inprogress:"in progress",noscore:"no score yet",deletereplay:"This session has the Ideafy replay feature enabled. Are you sure you want to delete it?","library-decks":"My Ideafy decks",brainstormheadertitle:"Brainstorm",brainstormchoosemode:"Choose your Ideafy mode",continuesession:"Continue last session",quickbmode:"Quick mode session",quickstart:"Describe your session",quickstarthelp:"<h2>Why is this step important?</h2><p>Giving your session a name and other background information will make it easier to retrieve later on from your library. Besides, it's always interesting to keep track of the particular context in which ideas or other contents were generated. If you are setting up a multi-user session, this will provide important context information to invitees and may persuade them to join.</p>",quickstarttitle:"Name your session",quickstarttitleplaceholderpre:"",quickstarttitleplaceholderpost:"'s session",quickstartdesc:"Enter a description of your session",quickstartdescplaceholder:"Date, context, purpose, ...",nextbutton:"Next",finishbutton:"Ready",quicksetup:"Set up a situation",quicksetuphelp:"<h2>Setting the stage</h2><p>This step lets you setup a random situation. Draw and select one card of each of the following categories: character, context, problem. They will be the starting point of your session. You can zoom in on each card to get additional information, select a different one by clicking on the deck icon at the top or accept it (thumbs-up button).</p><p>Which is it going to be ? Will you let fortune decide what situation you are going to deal with or will you work the stacks until you get one you are comfortable with? Ideafy encourages you to pick random situations because they force you to think outside the box.</p><p>Note that when you start a <i>Custom session</i> you can specify one or more of your starting cards to address specific situations.</p>",credits:"Credits : ",source:"Source : ",dyknow:"Did you know ?",agelbl:" year old",hobbieslbl:"Leisure activities",interestslbl:"Centers of interest",commentslbl:"Comments",singlelbl:"single",marriedlbl:"married",divorcedlbl:"divorced",widowlbl:"widow",nochildlbl:"no children",onechildlbl:" child",childrenlbl:" children",siblingslbl:" siblings",onesiblinglbl:" sibling",quickscenario:"Write your story",quickscenariohelp:"<p>This is your <strong>whiteboard.</strong></p><p>Now is the time to show your creativity and imagination. The cards you just picked give you a scope, a set of directions to project your thoughts. Use them as hints but do not feel overly constrained: they are here to help you <strong>write your own story and describe your own use case</strong>.</p><p>Finding the problem to solve is often the most important step of an innovation. So get started and use the tools below to <strong>post any thought, drawing or picture that will help you focus on a story.</strong></p><br><p>When you are done, click on the <strong>ready</strong> button at the bottom to write up your story.</p>",choosecolorlbl:"Choose a color",importlbl:"Choose a picture",importpiclbl:"Choose a picture",importcameralbl:"Take a picture",pencilsizelbl:"Size",pencilcolorlbl:"Color",drawbgcolorlbl:"Background",cleardrawinglbl:"Clear",storytitleplaceholder:"Enter the title of your story",storydescplaceholder:"Tell your story, describe the problem your character is facing",storysolplaceholder:"How would you plan to fix this problem ?",quicktech:"Assign technologies",quicktechhelp:"<h2>Draw technologies</h2><p>The next phase of your session consists in finding a way to implement your solution using state of the art technologies. In this step you will draw three technology cards that you will try to include in your design.</p>",tech1lbl:"Techno 1",tech2lbl:"Techno 2",tech3lbl:"Techno 3",scenariolbl:"Scenario",storytitlelbl:"Your Story",cdtitlelbl:"Title : &nbsp",scenariodesclbl:"Scenario description",soldesclbl:"Solution description",quickidea:"Describe your idea",quickideahelp:"<p>Welcome back to your <strong>whiteboard.</strong></p><p>Your goal now is to try to apply the technologies that you just picked to design a solution to the use case described in your scenario.</p><p>Again do not feel too constrained: at this stage you can either alter your scenario to accomodate a technology, add additional technologies to the ones you have drawn to complete your solution or skip some of these if they do not fit in your design.</p><p>You are almost done: at the end of this step you will be able to refine your use case and turn it into an <strong>idea</strong>. You will be asked to provide a description in layman terms and also to describe how you would implement it with your chosen technologies.</p><br><p>When you are done, clik on the <strong>ready</strong> button at the bottom to write up your story.</p>",quickwrapup:"Summary",quickstepstart:"Session description",quickstepsetup:"Setup",quickstepscenario:"Scenario",quicksteptech:"Technologies",quickstepidea:"Solution",quickstepwrapup:"Summary",congratulations:"Congratulations !",sessioncompleted:"You successfully completed your Ideafy session",ideatitlelbl:"Your Idea",scenarioheader:"Scenario",scenariosolution:"Solution",ideadescription:"Idea description",ideaimplementation:"Technical implementation",yourtime:"Your time",yourscore:"Your score",musession:"Multi-user session",customsession:"Custom session",ideafytutorial:"ideafy tutorial","connect-contacts":"Contacts","connect-messages":"Messages","connect-twocents":"Two cents","dashboard-profile":"My profile","dashboard-settings":"Settings","dashboard-about":"About Ideafy",tolbl:"To : ",subjectlbl:"Subject : ",yourmessage:"Your message to ",sentok:" has been sent.",sentdocmsg:" sent you an Ideafy document",notavalidaddress:" is not a valid email address",norecipient:"No email address specified",sendlbl:"Send",sharelbl:"Share",msglistheadertitle:"My Messages",notificationlbl:"Notifications",allbtn:"View all",msgbtn:"Messages",notifbtn:"Notifications",unreadbtn:"Unread",searchmsgplaceholder:"Search ...",messageview:"Message panel",replyalllbl:"Reply all",forwardlbl:"Forward",deletelbl:"Delete",newmsg:"New message",cclbl:"Cc :",tocontactlbl:"Contact :",entersubjectlbl:"Please enter a subject",notavalidcontact:" is not a contact",messagesentok:"Your message has been sent",on:"On ",contactview:"Contact panel",contactlistheadertitle:"My Contacts",usrbtn:"Users",grpbtn:"Groups",newcontactlbl:"New contact",addcontactnow:"Add your contact now",lookup:"Or look up the Ideafy database",beforecount:"The <strong>Ideafy community</strong> now counts <strong>",aftercount:" <strong>users </strong> merrily crafting and exchanging ideas.<br>Look up your acquaintances and friends in the community and connect.",addcontactrightintro:"Building up your address book is the best and fastest way to increase exposure of your ideas and thoughts, but also to get access to a much broader content.",searchcontactplaceholder:"Enter email address of the person you wish to connect with ...",clearemailfirst:"Please clear the email field first",needbothfnln:"Both first and last names are required",selectcontact:"Select contact and press + to invite",noentryfound:"No matching entry in the database",cannotaddself:"You cannot add a connection to yourself",alreadyconnected:" is already a contact",alreadysentCXR:"You already sent a connection request to ",CXRobject:" wants to be a connection",CXRsent:"Your connection request has been sent",addamessage:"Add a message",accept:"Accept",reject:"Reject",acceptedCXR:" has accepted your connection request",rejectedCXR:" has declined your connection request",CXRaccepted:"Request accepted, ",CXRrejected:"Contact request rejected",isnowacontact:" is now a contact",isnolongeracontact:" is no longer a contact",canceledCX:" has canceled your connection",newfolderlbl:"New group",groupnamelbl:"Group name",groupdesclbl:"Group description",colortouch:"A colorful touch is always nice","char":"Character",context:"Context",problem:"Problem",grpcontacts:"Group contacts",addgrpcontacts:"Add contacts",nogrpname:"Please enter a group name",nogrpintro:"Please provide a group description",grpnameexists:"A group with this name already exists",nocontactselected:"Please add at least one contact to your group",profilelbl:"My Profile",aboutlbl:"About Ideafy",settingslbl:"Application parameters",completionprefix:"Your profile is ",completionsuffix:"% complete",info:"information",leaderboard:"leaderboard",enterbirthdate:"Provide your date of birth",entergender:"Indicate your gender",enterfamily:"Complete your family status",enteraddress:"Specify your address",enterintro:"Change your introduction",enteroccupation:"Describe your occupation",enterleisure:"Provide at least two leisure activities",enterinterest:"Provide at least two areas of interest",entersocialnw:"Add a social network",enterownpic:"Customize your avatar",completeprofile:"<i>Complete your profile</i>",mystatslbl:"My Stats",ideaslbl:"Public Ideas",sessionslbl:"Sessions",contactslbl:"Contacts",toquestionslbl:"Twoquestions",recentactivitylbl:"Recent Activity",enterednewidea:"You entered a new idea: ",reachedrank:"Congratulations ! You made a new rank :",gotaward:"You received an award : ",posted2q:"You posted a TwoQuestion :",commentedon:"You commented on : ",by:" by ",profileintro:"Profile introduction",shortprofiledesc:"Short profile description",day:"Day",dob:"Date of birth",jan:"January",feb:"February",mar:"March",apr:"April",may:"May",jun:"June",jul:"July",aug:"August",sep:"September",oct:"October",nov:"November",dec:"December",year:"Year",mailaddress:"My Address",street:"Street",city:"City",state:"State",zip:"ZIP code",country:"Country",myfamily:"My Family",single:"Single",married:"Married",divorced:"Divorced",widow:"Widow",relation:"In a relationship",children:"Children",myoccupation:"My Occupation",student:"Student",active:"Active",retired:"Retired",unemployed:"Unemployed",stayathome:"Stay at home parent",jobtitle:"Job title",organization:"Organization",name:"Name",comment:"Comment",field:"Field",updatelbl:"Update",selectavatar:"Or select an avatar",uploadcomplete:"Upload complete",mynotes:"My Notes",writesomething:"Write something",stats:"Stats",achievements:"Achievements",decklistheadertitle:"My Decks",ideafypoints:" Ideafy Points",version:"Version : ",groupupdated:"Group updated",socialnwlbl:"Social networks",designedby:"Designed by : ",mtcheadertitle:"My Two Cents Wall",userpref:"User Preferences",brainstormsettings:"Brainstorm Settings",aboutIdeafy:"About Ideafy",faq:"FAQ",tutorials:"Tutorials",userguide:"User Guide",support:"Support",eula:"View License Agreement",page:"Page ",supportlegend:"A question or an issue?",supportplaceholder:"Enter your text and send",requestsent:"Thank you ! Your request has been sent",createquestion:"New TwoQuestion",questionplaceholder:"Enter your question",noquestion:"Please enter a question",lengthexceeded:"Maximum question length reached",characters:" characters",publicidealbl:"Public Idea",privateidealbl:"Private Idea",publicwarning:"<b>WARNING :</b> publishing your idea as a public one is irreversible. Visit Ideafy's dashboard to learn more.",uploadinprogress:"Upload in progress",notifyingcontacts:" Notifying contacts",askednew:" has asked a new TwoQuestion",melbl:"Me",nowconnected:" are now connected with ",noreplyyet:"No reply yet",mytwoquestions:"My TwoQuestions",mytwocents:"My Twocents",twoqprefix:"",twoqsuffix:"'s TwoQuestions",notwoqyet:"This Ideafyer has not posted any TwoQuestion yet",mytqdetailheader:"My TwoQuestion",tqheaderprefix:"",tqheadersuffix:"'s TwoQuestion",selecttq:"Select a contact to diplay TwoQuestions",mytwocentwall:"My Twocent Wall",sendtcprefix:"Send a Twocent to ",sendtcsuffix:"",twocentplaceholder:"Write your two cents",nomessage:"Please enter a message",sendinginprogress:"Sending in progress",senttc:" wrote you a new Twocent",selectall:"Select all",shareok:"Document shared successfully",signaturelbl:"Signature",sharing:"Sharing : ",messagecenter:"Message Center",twocentview:"Twocent Center",twocentcenter:"TwoQuestions & Twocents","about-taiaut":"About Taiaut",ideafydesc:"Look at Ideafy as your personal accelerator of ideas. You need ideas? Browse the database of ideas shared by other Ideafyers, ask your network or craft new ones using the embedded brainstorming engine. You have creative ideas? Ideafy makes it easy to share them with your network or to expose them to a community of innovative minds. Start discussions, ask questions or just give your two cents. Your Ideafyer friends want to find out what is on your mind. Ideation is fun. Get started and earn as many Ideafy Points and achievements as you can. Will you be the King of Ideas?",taiautdesc:"Taiaut was founded in May 2012 by three partners passionate about innovation and new technology. The aim of the company is to take advantage of leading edge communication technologies to advance creative ideas and best innovation practices globally. The company is headquartered in Boersch, France",solene:"Solène Troussé",oliviers:"Olivier Scherrer",olivierw:"Olivier Wietrich",vincent:"Vincent Weyl",contribsolene:"User interface design",contribscherrer:"Framework design and development",contribwietrich:"User Interface development and software packaging",contribvincent:"Application conception & lead developer","public":"Public wall",library:"My Library",brainstorm:"Brainstorming center",connect:"Communication Center",dashboard:"Dashboard",notips:"Do not show tips at startup",showtips:"Show tips at startup",shownotif:"Show notification popup",setlang:"Choose your language",choosestartup:"Choose your startup screen",usechar:"Allow my profile to be used as an Ideafy character (my name will not be shown)",changepwd:"Change password",changelbl:"Change",brainstormtutorial:"Brainstorming tutorial",twoway:"Support is a two-way street",supportusintro:"Ideafy is a free application and we intend to keep it that way. We are committed to bringing you the best experience. Here are a few things you can do to help us support you better:",asanideafyer:"As an Ideafyer",asanexec:"As a business executive",asadev:"As a developer",asaninvest:"As an investor",ideafyerhelp:"Tell us how you feel by rating the application. If you encounter an issue please use the form above and we will try to fix it speedily. All your feedback is welcome and really helps us improve Ideafy.",exechelp:'If you feel like your business could become even more innovative by using such a platform internally or with your partners, we do propose standalone deployments or dedicated instances. This will not be free but we offer ultra competitive conditions. Contact us with the form above or via our <a onclick=\'window.open("http://www.taiaut.com", "_system");\'>website</a>',devhelp:'Ideafy exists thanks to three javascript libraries written by the company partners. They are released under MIT licenses and are available here : <a onclick=\'window.open("http://github.com/flams/emily", "_system");\'>emily</a>, <a onclick=\'window.open("http://github.com/flams/olives", "_system");\'>olives</a> and <a onclick=\'window.open("http://http://github.com/flams/CouchDB-emily-tools", "_system");\'>couchdb-emily-tools</a>. Check them out and if you are up for it help us make them even better.',investhelp:"We have plenty of ideas to expand the Ideafy service and we are constantly looking for funding opportunities. If you are interested, want to find out about our future and be part of it please contact us.",toc:"Table of contents",backtotop:"Back to top",choosepolling:"Poll new public ideas",everymin:"Every minute",everyfive:"Every 5 minutes",everyfifteen:"Every 15 minutes",never:"Disabled",nointernet:"Your device is not connected: please check your Internet access and try again.",schedmaintenance:"Scheduled maintenance",nextmaintenance:"The next maintenance will take place on : ",startnewmub:"Start a new session",joinmub:"Join a session",selectmode:"Select mode",roulette:"Roulette",campfire:"Campfire",boardroom:"Boardroom",rouletteinfo:"Any other Ideafyer may join this session",campfireinfo:"Anyone from your contact list may join this session (no notification)",boardroominfo:"Invitation only: invited contacts are notified and may join this session",clear:"Clear",create:"Create",nofriendtoinvite:"No contact to invite: please add contacts to your list or select an other mode",inviteatleastone:"You must select at least one contact to invite",providesessioninfo:"You must enter a meaningful title and description",sendinginvites:"Sending invitations...",invitesent:"Invitations sent",INVObject:" invited you to an Ideafy session",nolongerjoin:"You can no longer join this session : it is already underway or completed.",clicktojoin:"Push the button below to join session.",selectsession:"Select a session",participantleave:"Are you sure you want to leave? You will not be able to re-join nor will you get credited for any outcome  of the session",leaderleave:"Are you sure you want to cancel this session? This will end it for all participants.",canceledbyleader:"Session canceled by leader: ending now",participantsleft:"All participants have left: the session is canceled",waitingroomlbl:"Waiting room",joinedsession:"<i>You joined this session.</i>",deletingsession:"Deleting session : ",participants:"Participants",startbutton:"Start",joinbutton:"Join",nosessionfound:"No session found",allmodes:"All modes",all:"All",mode:"Mode",lang:"Lang",title:"Title",leader:"Session leader",sessionfull:"The session is full",sessionstarted:"This session is already started",sessiondeleted:"This session has been canceled",chatmsg0:" has initiated the session",chatmsg1:" has joined the session",chatmsg2:" has left the session",chatmsg3:" has canceled the session",chatmsg4:"Your session is starting now",chatmsg5:"Beginning new step : ",chatmsg6:"This concludes the current step. Moving on to the next screen...",typemsg:"Enter your text",said:" said :",noresult:"No result found",clicktoview:"Press the button below or visit your library to view",skiplbl:"Skip",submitlbl:"Submit",decidemsg:"Decide how you want to share your work",unanimity:"(unanimity is required)",setpublic:"Make the idea public",enablereplay:"Enable session replay",yeslbl:"Yes",nolbl:"No",accepted:"ACCEPTED",rejected:"REJECTED"},lang:"en-us",labels:new e({})})},this.reset(),a}),define("service/utils",["service/config","Observable","Promise","LocalStore"],function(e,t,n,r){return{formatDate:function(e){var t=e[1]+1;return t<10&&(t="0"+t),e[2]+"/"+t+"/"+e[0]},formatDuration:function(e){var t,n,r,i,s,o;return e?(t=Math.round(e/1e3),n=Math.floor(t/86400),r=Math.floor(t%86400/3600),i=Math.floor(t%86400%3600/60),s=Math.floor(t%86400%3600%60),n>0?o=n+"d ":o="",r>0?o+=r+":":o+="",i>0?o+=(r>0&&i<10?"0":"")+i+":":o+="0:",s<10?o+="0"+s:o+=s):o="",o},formatTime:function(e){var t=new Date(e),n=t.getHours(),r=t.getMinutes(),i=t.getSeconds(),s="";return s+=n+":",r>0?s+=(n>0&&r<10?"0":"")+r+":":s+="00:",i<10?s+="0"+i:s+=i,s},displayFirstSentence:function(e,t){var n=[];return n=t.split("."[0],1),n[0].length>140&&(e.innerHTML=n[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")),e.innerHTML},truncate:function(e,t){e.innerHTML=t;while(e.scrollHeight>e.offsetHeight){var n=e.innerHTML;e.innerHTML=n.replace(/\W*\s(\S)*$/,"...")}return e.innerHTML},setRating:function(e,t){var n="<img src = 'img/wall/disableIdeaVote.png'>",r="<img src = 'img/wall/semi-activeIdeaVote.png'>",i="<img src = 'img/wall/activeIdeaVote.png'>",s="",o;if(!t)for(o=0;o<5;o++)s+=n;else{o=0;while(o<Math.floor(t))s+=i,o++;o<5&&(Math.round(t-Math.floor(t))?s+=r:s+=n,o++);while(o<5)s+=n,o++}e.innerHTML=s},searchArray:function(e,t){var n=t.toLowerCase().split(" "),r=[],i,s,o,u;for(i=0,l=e.length;i<l;i++){o=JSON.stringify(e[i]).toLowerCase(),u=0;for(s=0;s<n.length;s++){if(!(o.search(n[s])>-1))break;u++}u===n.length&&r.push(e[i])}return r},sortByProperty:function i(e,t,n){switch(t){case"idea":e.sort(function(e,r){var s=e[t],o=r[t],u,a;return n?(!!s&&s instanceof Array&&!!s.length?(i(s,"title",!0),u=s[0].title):u="",!!o&&o instanceof Array&&!!o.length?(i(o,"title",!0),a=o[0].title):a="",u<a?1:u>a?-1:0):(!!s&&s instanceof Array&&!!s.length?(i(s,"title",!1),u=s[0].title):u="",!!o&&o instanceof Array&&!!o.length?(i(o,"title",!1),a=o[0].title):a="",u<a?-1:u>a?1:0)});break;case"date":e.sort(function(e,r){var i=e[t],s=r[t],o=new Date(i[0],i[1],i[2]),u=new Date(s[0],s[1],s[2]);return n?o<u?1:o>u?-1:0:o<u?-1:o>u?1:0});break;default:e.sort(function(e,r){var i=e[t],s=r[t];return typeof i=="string"||typeof s=="string"?(i&&i.toLowerCase&&(i=i.toLowerCase()),s&&s.toLowerCase&&(s=s.toLowerCase()),n?i<s?1:i>s?-1:0:i<s?-1:i>s?1:0):n?i<s?1:i>s?-1:0:i<s?-1:i>s?1:0})}},uploadFile:function(t,n,r,i){var s=new XMLHttpRequest;s.open("POST",e.get("location")+t),s.onreadystatechange=function(){s.readyState===4&&i&&i(s)},s.upload.onprogress=function(e){e.lengthComputable&&r&&r.set("status",Math.round(e.loaded/e.total*100))},s.send(n)},checkServerStatus:function(){var t=new n,r=new XMLHttpRequest;return r.open("GET",e.get("location")),r.onreadystatechange=function(){r.readyState===4&&(r.status===200?t.fulfill():t.reject())},r.send(),t},checkSocketStatus:function(){var t=e.get("socket");t.socket.connected||(t.socket.connect(e.get("location")),e.get("observer").notify("reconnect"))},disconnectSocket:function(){e.get("socket").socket.disconnect(),e.get("observer").notify("disconnect")},updateLabels:function(t){var i={lang:t},s=new r,o=e.get("labels"),u=new n;return s.sync("ideafy-data"),e.get("transport").request("Lang",i,function(t){t==="nok"?(s.set("labels",e.get("defaultLabels")),e.set("lang","en-us")):(s.set("labels",t),e.set("lang",t.language)),s.sync("ideafy-data"),o.reset(s.get("labels")),u.fulfill()}),u},getAvatarById:function(t){var i=new n,s=new r,o=e.get("avatars");if(o.get(t)&&o.get(t)!=="in progress")i.fulfill(o.get(t));else{if(o.get(t)!=="in progress")return o.set(t,"in progress"),e.get("transport").request("GetAvatar",{id:t},function(e){if(e.error)i.reject();else{if(o.getNbItems()<100)o.set(t,e);else{var n=o.toJSON(),r=n.keys();o.del(r[0]),o.set(t,e)}i.fulfill(e)}}),i;o.watchValue(t,function(e){e&&e!=="in progress"&&(o.unwatch(t),i.fulfill(e))})}},getAvatarByFileName:function(t,n){e.get("transport").request("GetAvatar",{file:t},function(e){n(e)})},getGrade:function(t,n){var r=e.get("transport"),i=e.get("user");r.request("GetGrade",{ip:t,lang:i.get("lang")},function(e){n(e)})},getAchievements:function(t,n){var r=e.get("transport"),i=e.get("user");r.request("GetAchievements",{userid:t,lang:i.get("lang")},function(e){n(e)})},getUserDetails:function(t,n){var r=e.get("transport");r.request("GetUserDetails",{userid:t},function(e){n(e)})},getUserContactIds:function(){var t=[],n=e.get("user").get("connections");return n.forEach(function(e){e.type==="user"&&t.push(e.userid)}),t},checkProfileCompletion:function(){var t=e.get("user"),n=e.get("labels"),r={percentage:0,missing:[]};return t.get("firstname")&&t.get("lastname")&&(r.percentage+=10),t.get("birthdate").length===3?r.percentage+=10:r.missing.push(n.get("enterbirthdate")),t.get("family").couple!==null&&t.get("family").children!==null?r.percentage+=10:r.missing.push(n.get("enterfamily")),t.get("address").city&&t.get("address").country?r.percentage+=10:r.missing.push(n.get("enteraddress")),t.get("intro")&&t.get("intro")!=="Ideafyer"?r.percentage+=10:r.missing.push(n.get("enterintro")),t.get("occupation").situation>=0&&t.get("occupation").job&&t.get("occupation").organization?r.percentage+=10:r.missing.push(n.get("enteroccupation")),t.get("leisure_activities")[0].name&&t.get("leisure_activities")[1].name?r.percentage+=10:r.missing.push(n.get("enterleisure")),t.get("interests")[0].name&&t.get("interests")[1].name?r.percentage+=10:r.missing.push(n.get("enterinterest")),t.get("twitter")||t.get("facebook")||t.get("gplus")||t.get("linkedin")?r.percentage+=10:r.missing.push(n.get("entersocialnw")),t.get("picture_file").search("img/avatars/deedee")<0?r.percentage+=10:r.missing.push(n.get("enterownpic")),r},stringToBytes:function(e){var t,n,r=[],i,s=0,o;for(i=0;i<e.length;i++){t=e.charCodeAt(i);if(t<127)r[s++]=t&255;else{n=[];do n.unshift(t&255),t>>=8;while(t);for(o=0;o<n.length;o++)r[s++]=n[o]}}return r},changeStyle:function(e){var t=document.querySelector(".currentStyle"),n=t.getAttribute("href");n!=="css/"+e&&t.setAttribute("href","css/"+e)},exitListener:function(e,t){var n=function(n){var r;for(r=n.target;r;r=r.parentNode)if(r.id===e)return;!n.target.classList.contains("deedee")&&!n.target.classList.contains("notify-header")&&n.target.id!=="dock"&&!n.target.classList.contains("close-help")&&(n.stopPropagation(),t(n.target))};return document.addEventListener("mousedown",n,!0),n}}}),define("service/avatar",["OObject","Bind.plugin","Event.plugin","service/config","Store","service/utils"],function(e,t,n,r,i,s){function o(e){var o=new i,u=r.get("avatars"),a=e[0];this.plugins.addAll({avatar:new t(o,{setStyle:function(e){e&&e!=="in progress"&&this.setAttribute("style","background-image: url('"+e+"');")}}),event:new n(this)}),this.template='<div class="avatar" data-avatar="bind: setStyle, img"></div>',e.length>1?o.set("img","img/avatars/deedee6.png"):a===r.get("user").get("_id")?(o.set("img",r.get("avatar")),r.watchValue("avatar",function(){o.set("img",r.get("avatar"))})):a==="ideafy@taiaut.com"||a==="IDEAFY"?o.set("img","img/avatars/doctordeedee.png"):u.get(a)?u.get(a)==="in progress"?u.watchValue(a,function(e){e&&e!=="in progress"&&o.set("img",e)}):o.set("img",u.get(a)):s.getAvatarById(a).then(function(e){o.set("img",u.get(a))})}return function(t){return o.prototype=new e,new o(t)}}),define("twocents/writetwocent",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils"],function(e,t,n,r,i,s){return function(o){var u=new e,a=t.get("user"),f=t.get("transport"),l=new Date,c=new i({author:a.get("_id"),message:"",firstname:a.get("firstname"),date:[l.getFullYear(),l.getMonth(),l.getDate()],datemod:"",plusones:0,replies:[]}),h,p,d=o||"public",v="new",m=0;return u.plugins.addAll({twocent:new n(c,{date:function(e){e&&(this.innerHTML=s.formatDate(e))},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new n(t,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),labels:new n(t.get("labels")),twocentevent:new r(u)}),u.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: mousedown, press; listen: mouseup, publish">Publish</div></div></div>',u.reset=function(e,t,n,r){var i=new Date,s={author:a.get("_id"),message:"",firstname:a.get("firstname"),date:"",datemod:"",plusones:0,replies:[]};e&&(h=e),t?(c.reset(t),v=t,m=n,c.set("datemod",[i.getFullYear(),i.getMonth(),i.getDate()])):(c.reset(s),c.set("date",[i.getFullYear(),i.getMonth(),i.getDate()]),v="new"),r&&(p=r)},u.cancel=function(e,t){t.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),p?p():document.getElementById(d+"-writetwocents").classList.add("invisible")},u.publish=function(e,n){n.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;");if(c.get("message")){var r=JSON.parse(c.toJSON()),i,s;v==="new"?s="new":s="edit",i={docId:h,type:s,position:m,twocent:r},f.request("WriteTwocent",i,function(e){e!=="ok"?alert(t.get("labels").get("somethingwrong")):(v==="new"?document.getElementById(d+"-writetwocents").classList.add("invisible"):p(),u.reset(h))},u)}},u.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")},u}}),define("twocents/writetwocentreply",["OObject","Store","Bind.plugin","Event.plugin","service/config","service/utils"],function(e,t,n,r,i,s){function o(e){var o=i.get("user"),u=i.get("transport"),a,f,l,c,h=new Date,p,d={author:o.get("_id"),message:"",firstname:o.get("firstname"),date:"",datemod:"",plusones:0},v=new t(d);this.plugins.addAll({model:new n(v,{date:function m(m){this.innerHTML=s.formatDate(m)}}),config:new n(i,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),writereplyevent:new r(this),labels:new n(i.get("labels"))}),this.template='<div class="writeTwocent writeTwocentReply"><div class="replyAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText replyMessage" data-labels="bind: placeholder, addtwocentreplyplaceholder" data-model="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-model="bind: date, date"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, publish;">Publish</div></div></div>',this.reset=function(e,t,n,r,i,s){var o=new Date;e&&t&&(a=e,f=t),i?c=i:c="",n?(v.reset(n),editTCR=n,l=r,v.set("datemod",[o.getFullYear(),o.getMonth(),o.getDate()])):(v.reset(d),v.set("date",[o.getFullYear(),o.getMonth(),o.getDate()]),editTCR="newreply"),p=s},this.cancel=function(t,n){n.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),v.reset(d),p?p():e.classList.add("invisible")},this.publish=function(t,n){n.setAttribute("style","-webkit-box-shadow: none; background: #8cab68;");if(v.get("message")){var r=JSON.parse(v.toJSON()),s,o;editTCR==="newreply"?o=editTCR:o="editreply",c&&(r.message="@ "+c+" : "+r.message),s={docId:a,type:o,position:l,twocent:f,reply:r},u.request("WriteTwocent",s,function(t){t!=="ok"?alert(i.get("labels").get("somethingwrong")):e.classList.add("invisible")})}},this.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")}}return function(t){return o.prototype=new e,new o(t)}}),define("twocents/twocentreplylist",["OObject","Store","Bind.plugin","Event.plugin","service/utils","service/config","twocents/writetwocentreply","service/avatar"],function(e,t,n,r,i,s,o,u){function a(e,a,f,l){var c=new t(e),h=this,p,d=s.get("user"),v=s.get("labels"),m=s.get("transport");h.plugins.addAll({reply:new n(c,{date:function g(g){g&&(this.innerHTML=i.formatDate(g))},setFirstname:function(e){var t=this.getAttribute("data-reply_id");this.innerHTML=e,c.get(t).author===d.get("_id")&&(this.innerHTML=v.get("youlbl"))},setReplylbl:function(e){var t=this.getAttribute("data-reply_id");this.innerHTML=v.get("twocentreplycommentlbl"),c.get(t).author===d.get("_id")&&(this.innerHTML=v.get("yourepliedlbl"))},setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setVisible:function(e){e&&e===d.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")},setInVisible:function(e){e&&e===d.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;")}}),replyevent:new r(h),labels:new n(v)}),h.template='<ul class="replies" data-reply="foreach"><li class="twocentReply"><div class="twocentHeader"><div class="replyAvatar" data-reply="bind:setAvatar, author"></div><div class="twocentAuthor" data-reply="bind: setFirstname, firstname"></div><span class="commentLabel" data-labels="bind: setReplylbl, firstname"></span><br/><div class="twocentDate date" data-reply="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, deleteTwocentReply"></div><div class="twocentButton twocentReplyButton" data-reply="bind: setInVisible, author" data-replyevent="listen:mousedown, reply"></div></div></div><p class="twocentMessage replyMessage" data-reply="bind: innerHTML, message"></p><div class="writePublicTwocentReply replyToReply invisible"></div></li></ul>',h.edit=function(t,n){var r=n.getAttribute("data-reply_id"),i=h.dom.children[r],s=new o,u=function(){h.dom.replaceChild(i,s.dom)},l=document.createDocumentFragment();s.reset(a,f,e[r],r,null,u),s.render(),s.place(l),h.dom.replaceChild(l,i),UI=h.dom},h.deleteTwocentReply=function(e,t){var n=t.getAttribute("data-reply_id"),r={docId:a,type:"deltcreply",twocent:f,position:n};m.request("WriteTwocent",r,function(e){e!=="ok"&&alert(s.get("labels").get("somethingwrong"))})},h.reply=function(t,n){var r=n.getAttribute("data-reply_id"),i=document.querySelector(".twocent[data-twocents_id='"+f+"']"),s=i.querySelector(".writePublicTwocentReply[data-reply_id='"+r+"']"),u=document.createDocumentFragment(),l=new o(s);l.reset(a,f,null,r,e[r].firstname),l.render(),l.place(u),s.hasChildNodes()||s.appendChild(u),s.classList.remove("invisible")}}return function(t,n,r,i){return a.prototype=new e,new a(t,n,r,i)}}),define("twocents/twocentlist",["OObject","service/config","CouchDBDocument","Store","Promise","service/utils","Bind.plugin","Event.plugin","twocents/twocentreplylist","twocents/writetwocent","twocents/writetwocentreply","service/avatar"],function(e,t,n,r,i,s,o,u,a,f,l,c){function h(e){var h=this,p=new n,d=t.get("labels"),v=new r([]),m=t.get("transport"),g=t.get("user"),y,b=e;p.setTransport(m),h.plugins.addAll({labels:new o(t.get("labels")),twocents:new o(v,{date:function w(w){w&&(this.innerHTML=s.formatDate(w))},setFirstName:function(e){var n;e&&(e!==g.get("firstname")?this.innerHTML=e:(n=this.getAttribute("data-twocents_id"),v.get(n).author===g.get("_id")?this.innerHTML=t.get("labels").get("youlbl"):this.innerHTML=e))},setCommentlbl:function(e){var t;e&&(e!==g.get("firstname")?this.innerHTML=d.get("twocentcommentlbl"):(t=this.getAttribute("data-twocents_id"),v.get(t).author===g.get("_id")?this.innerHTML=d.get("youcommentedlbl"):this.innerHTML=d.get("twocentcommentlbl")))},setVisible:function(e){e&&(e===g.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},setInVisible:function(e){e&&(e===g.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;"))},deleteOK:function(e){var t;e&&e.length>0?this.setAttribute("style","display: none;"):(t=this.getAttribute("data-twocents_id"),g.get("_id")===v.get(t).author?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},toggleHideButton:function(e){!e||!e.length?this.classList.add("invisible"):(this.classList.remove("invisible"),e.length===1?this.innerHTML=t.get("labels").get("showonetcreply"):this.innerHTML=t.get("labels").get("showtcrepliesbefore")+e.length+t.get("labels").get("showtcrepliesafter"))},displayReplies:function(e){var t,n,r;!e||!e.length?this.classList.add("invisible"):(t=this.getAttribute("data-twocents_id"),n=new a(e,y,t,b),r=document.createDocumentFragment(),n.render(),n.place(r),this.hasChildNodes()?this.replaceChild(r,this.firstChild):this.appendChild(r),this.classList.remove("invisible"))},setAvatar:function(e){var t,n;e&&(t=document.createDocumentFragment(),n=new c([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))}}),twocentevent:new u(h)}),h.template='<ul class="twocentList" data-twocents="foreach"><li class="twocent"><div class="twocentHeader"><div class="twocentAvatar" data-twocents="bind: setAvatar, author"></div><div class="twocentAuthor"data-twocents="bind: setFirstName, firstname"></div><span class="commentLabel" data-twocents="bind: setCommentlbl, firstname"></span><br/><div class="twocentDate date" data-twocents="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-twocents="bind: setVisible, author" data-twocentevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-twocents="bind: deleteOK, replies" data-twocentevent="listen: mousedown, deleteTwocent"></div><div class="twocentButton twocentReplyButton" data-twocents="bind: setInVisible, author" data-twocentevent="listen: mousedown, reply"></div></div></div><div class="twocentBody"><p class="twocentMessage" data-twocents="bind: innerHTML, message"></p><div class="repliesButton hideReplies" name="hide" data-twocents="bind: toggleHideButton, replies" data-twocentevent="listen: mousedown, toggleReplies" data-labels="bind:innerHTML, hidetwocentreplies"></div></div><div class="writePublicTwocentReply invisible"></div><div class="displayReplies" data-twocents="bind: displayReplies, replies"></div></li></ul>',h.edit=function(e,t){var n=t.getAttribute("data-twocents_id"),r=h.dom.children[n],i=new f,s=document.createDocumentFragment(),o=function(){h.dom.replaceChild(r,i.dom)};i.reset(y,v.get(n),n,o),i.render(),i.place(s),h.dom.replaceChild(s,r)},h.reset=function(e){var n=new i;return y=e,v.reset([]),p.unsync(),p.reset({}),p.sync(t.get("db"),y).then(function(){var e=p.get("twocents");e.length&&v.reset(p.get("twocents")),p.watchValue("twocents",function(e){v.reset(e)}),n.fulfill()},function(e){console.log(e)}),n},h.deleteTwocent=function(e,n){var r=n.getAttribute("data-twocents_id"),i={docId:y,type:"delete",position:r,twocent:{author:g.get("_id")}};alert("Are you sure?"),m.request("WriteTwocent",i,function(e){e!=="ok"&&alert(t.get("labels").get("somethingwrong"))})},h.reply=function(e,t){var n=t.getAttribute("data-twocents_id"),r=document.querySelector(".writePublicTwocentReply[data-twocents_id='"+n+"']"),i=new l(r),s=document.createDocumentFragment();i.reset(y,n),i.render(),i.place(s),r.hasChildNodes()||r.appendChild(s),r.classList.remove("invisible")},h.toggleReplies=function(e,t){var n=t.getAttribute("data-twocents_id"),r=v.get(n).replies,i=t.getAttribute("name"),s=document.querySelector(".displayReplies[data-twocents_id='"+n+"']");i==="show"?(s.classList.remove("invisible"),t.setAttribute("name","hide"),t.classList.remove("showReplies"),t.classList.add("hideReplies")):(s.classList.add("invisible"),t.setAttribute("name","show"),t.classList.remove("hideReplies"),t.classList.add("showReplies"))}}return function(t){return h.prototype=new e,new h(t)}}),define("public/detail-stack/public-idea",["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(d){var v=new e,m=new a,g=new f("public"),y=u.get("labels"),b=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),w=!1,E=u.get("user"),S=u.get("transport"),x=new h,T=i.get("public-detail"),N,C=new l;return x.setTransport(S),v.plugins.addAll({label:new n(y),publicdetail:new n(x,{toggleRateEdit:function(e){e.indexOf(E.get("_id"))>-1?this.setAttribute("href","#public-edit"):this.setAttribute("href","#public-favorites")},toggleTwocentShare:function(e){e.indexOf(E.get("_id"))>-1?this.setAttribute("href","#public-share"):this.setAttribute("href","#public-2cents")},displayWriteTwocent:function(e){e.indexOf(E.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("public-writetwocents").classList.add("invisible")},date:function k(k){k&&(this.innerHTML=s.formatDate(k))},setAuthor:function(e){e===E.get("username")&&x.get("authors").indexOf(E.get("_id"))>-1?this.innerHTML=y.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e.length===1&&e[0]===E.get("_id")?this.innerHTML=y.get("youwrotelbl"):e.length>1?this.innerHTML=y.get("theywrotelbl"):this.innerHTML=y.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new o(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setRating:function(e){e.length===0?this.innerHTML="":this.innerHTML=Math.round(e.reduce(function(e,t){return e+t})/e.length*100)/100},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setSolution:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=x.get("_id"),n=x.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),E.get("rated_ideas").indexOf(t)<0&&n.indexOf(E.get("_id"))<0&&!w?(this.setAttribute("name","vote"),this.innerHTML=y.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(w=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),e.length===0?this.innerHTML="("+y.get("novotesyet")+")":e.length===1?this.innerHTML="("+y.get("onevote")+")":this.innerHTML="("+e.length+" "+y.get("votes")+")",this.classList.add("votes"))}}),vote:new n(b,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new p({PublicTwocentUI:g}),publicdetailevent:new r(v)}),v.template='<div class="public-idea"><div class="header blue-dark"><a href="#public-2cents" data-publicdetail="bind: toggleTwocentShare, authors" data-publicdetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, publicdetailsheadertitle"></span><a href="#public-favorites" data-publicdetail="bind: toggleRateEdit, authors" data-publicdetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-publicdetail="bind:setAvatar, authors"></div><h2 data-publicdetail="bind:innerHTML,title"></h2><span class="date" data-publicdetail="bind:date, creation_date"></span><br><span class="author" data-publicdetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-publicdetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><p data-publicdetail="bind:setDescription,description"></p><p data-publicdetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class ="rateIdea"><a class="item-acorn"></a><div class="rating" data-publicdetail="bind:setRating,votes"></div><div class="publicButton" data-publicdetail="bind:toggleVoteButton, votes" name="vote" data-publicdetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-publicdetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="public-writetwocents" class="invisible" data-publicdetail="bind: displayWriteTwocent, authors"></div><div id="public-twocents" class="twocents" data-publicdetail="bind: displayTwocentList, twocents" data-place="place: PublicTwocentUI"></div></div>',v.showCache=function(){v.dom.querySelector("#idea-cache").classList.remove("invisible")},v.hideCache=function(){v.dom.querySelector("#idea-cache").classList.add("invisible")},v.reset=function(e,t){var n=e.get(t).id,r=new c;return b.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),v.getIdea(n).then(function(){w=!1,m.reset(x.get("_id")),g.reset(x.get("_id")),N=document.getElementById("public-writetwocents"),m.place(N),r.fulfill()}),r},v.getIdea=function(e){return x.unsync(),x.reset(),x.sync(u.get("db"),e)},v.action=function(e,t){var n=t.getAttribute("href");n==="#public-2cents"?(m.reset(x.get("_id")),N.classList.remove("invisible")):d(n)},v.edit=function(){_stack.getStack().show("#public-edit")},v.press=function(e,t){t.classList.add("pressed")},v.vote=function(e,t){w||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},v.previewVote=function(e,t){var n=0,r=t.getAttribute("data-vote_id");b.loop(function(e,t){t<=r?b.update(t,"active",!0):b.update(t,"active",!1)})},v.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,r=x.get("_id"),i={id:r,vote:n,voter:E.get("_id")};w||(w=!0,S.request("Vote",i,function(e){var t=E.get("rated_ideas")||[];e!=="ok"?(console.log(e,"something went wrong, please try again later"),w=!1):(t.unshift(r),E.set("rated_ideas",t),alert(u.get("labels").get("thankyou")),u.get("observer").notify("update-polling"),document.getElementById("ratingPopup").classList.remove("appear"),b.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},v.place(T),v}}),define("service/confirm",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){function o(e,o,u){var a=i.get("labels"),f=this,l=new s({question:o}),c=u;f.plugins.addAll({label:new n(a),confirm:new n(l),confirmevent:new r(this)}),f.template='<div class = "confirm"><div class="help-doctor"></div><p class="confirm-question" data-confirm="bind:innerHTML,question"></p><div class="option left" data-confirmevent="listen:mousedown, press; listen:mouseup, ok" data-label="bind: innerHTML, continuelbl">Continue</div><div class="option right" data-confirmevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl">Cancel</div></div>',f.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},f.ok=function(e,n){n.classList.remove("pressed"),t.get("cache").classList.remove("appear"),c&&c(!0)},f.cancel=function(e,n){n&&n.classList.remove("pressed"),t.get("cache").classList.remove("appear"),c&&c(!1)},f.close=function(){t.get("cache").classList.remove("appear"),e.removeChild(e.lastChild)},f.hide=function(){t.get("cache").classList.remove("appear"),f.dom.classList.add("invisible")},f.show=function(){t.get("cache").classList.add("appear"),f.dom.classList.remove("invisible")},f.reset=function(e,t){l.set("question",e),c=t},f.render(),f.place(e),o?l.set("question",o):f.hide(),setTimeout(function(){f.close},15e3)}return function(t,n,r){return o.prototype=new e,new o(t,n,r)}}),define("public/detail-stack/public-edit",["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(f){var l=new e,c=new r,h=o.get("labels"),p=new n({error:""}),d;return c.setTransport(o.get("transport")),l.plugins.addAll({editlabel:new i(h),editidea:new i(c,{setVisibility:function(e){e==="public"?this.innerHTML=h.get("publiclbl"):this.innerHTML=h.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=h.get("enabledreplaylbl"):this.innerHTML=h.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=h.get("disablereplaylbl"):this.innerHTML=h.get("enablereplaylbl")}}),editevent:new s(l),errormsg:new i(p,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;case"nosol":this.innerHTML=h.get("solutionfield")+h.get("emptyfielderror");break;default:this.innerHTML=""}}})}),l.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl">Modify your idea</span></div><form class="form"><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, upload">Publish</label><label class="cancel pressed-btn" data-editevent="listen: mousedown, press;listen:mouseup, cancel">Cancel</label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',l.place(t.get("public-edit")),l.reset=function(e){c.unsync(),c.reset(),c.sync(o.get("db"),e),d=!1},l.editVisibility=function(e,t){var n=new u(t,h.get("setpublicquestion"),function(e){e?c.set("visibility","public"):c.set("visibility","private"),n.close()})},l.press=function(e,t){t.classList.add("pressed")},l.enableReplay=function(e,t){setTimeout(function(){c.get("sessionReplay")?c.set("sessionReplay",!1):c.set("sessionReplay",!0),d=!0,t.classList.remove("pressed")},300)},l.updateSessionReplay=function(e){var t=new a,n=new r;return n.setTransport(o.get("transport")),n.sync(o.get("db"),c.get("sessionId")).then(function(){var t=n.get("replayIdeas")||[],r;if(e)t.push(c.get("_id"));else for(r=t.length-1;r>=0;r--)t[r]===c.get("_id")&&t.splice(r,1);return n.set("replayIdeas",t),n.upload()}).then(function(){t.fulfill(),n.unsync()}),t},l.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];c.get("title")===""?p.set("error","notitle"):c.get("description")===""?p.set("error","nodesc"):c.get("solution")===""?p.set("error","nosol"):(c.set("modification_date",r),c.upload().then(function(){d&&l.updateSessionReplay(c.get("sessionReplay")).then(null,function(e){console.log(e)}),f("close")})),t.classList.remove("pressed")},l.cancel=function(e,t){t.classList.remove("pressed"),f("close")},l}}),define("public/detail-stack/public-sendmail",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(f){var c=new e,h=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:!1});return c.plugins.addAll({labels:new r(v),mail:new r(m,{setUserAvatar:function(e){e&&this.setAttribute("style","background: url('"+n.get("avatar")+"') no-repeat center center;")},date:function g(g){g&&(this.innerHTML=a.formatDate(g))},setAvatar:function(e){var t=document.createDocumentFragment(),n=new u(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setRating:function(e){},setVotes:function(e){}}),mailevent:new s(c),errormsg:new r(h)}),c.template='<div class="idea-sendmail"><div class="header blue-dark"><a href="#public-2cents" class="option left"></a><span data-labels="bind:innerHTML, sendidealbl"></span><a href="#public-favorites" class="option right"></a></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment. votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',c.place(t.get("public-sendmail")),c.reset=function(e){h.reset({errormsg:""}),m.reset({toField:"",from:p.get("username"),subject:"",body:"",signature:p.get("username")+" <"+p.get("_id"),attachment:e,sent:!1}),p.get("signature")&&m.set("signature",p.get("signature")),json={}},c.validateAddress=function(e){var t=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,n=e.toLowerCase().split(/,|;/),r=!0;for(i=0,l=n.length;i<l;i++)if(!t.test(n[i].trim())){h.set("errormsg",n[i]+v.get("notavalidaddress")),r=!1;break}return r},c.validateMessage=function(){return m.get("toField")?c.validateAddress(m.get("toField")):h.set("errormsg",v.get("norecipient")),h.get("errormsg")===""},c.sendMail=function(){json.type="doc",json.recipient=m.get("toField"),json.cc=p.get("_id"),json.replyTo=p.get("_id"),json.subject=p.get("username")+v.get("sentdocmsg"),json.header=m.get("subject"),json.body=m.get("body"),json.signature=m.get("signature"),json.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+m.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+m.get("attachment").authornames+", <span style='color:black';>"+a.formatDate(m.get("attachment").creation_date)+"</span></p></div>",json.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+m.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+m.get("attachment").solution+"</p></div>",d.request("SendMail",json,function(e){e.sendmail==="ok"?(h.set("errormsg",v.get("yourmessage")+e.recipient+v.get("sentoklbl")),setTimeout(function(){f("close")},350)):(h.set("errormsg",v.get("somethingwrong")),m.set("sent",!1),console.log("error",e.error),console.log("response",e.response))})},c.press=function(e,t){(!t.classList.contains("sendmail")||!m.get("sent"))&&t.classList.add("pressed")},c.send=function(e,t){m.get("sent")||(m.set("sent",!0),h.set("errormsg",""),t.classList.remove("pressed"),c.validateMessage()?c.sendMail():m.set("sent",!1))},c.cancel=function(e,t){t.classList.remove("pressed"),f("close")},c}}),define("service/autocontact",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,s,o){function u(e,t,u){var a=this,f=s.get("user"),c=!1,h=new o([]);a.plugins.addAll({auto:new n(h,{setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")},setType:function(e){e==="group"?this.classList.add("group"):this.classList.remove("group")}}),select:new r(a)}),a.template='<div class = "autocontact"><div class="autoclose" data-select="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:setType, type; bind:setSelected, selected" data-select="listen:mousedown, select"></li></ul></div>',a.init=function(){var e=f.get("connections"),n=[],r=[],s={};h.reset([]);for(i=0,l=e.length;i<l;i++)n.push(e[i].username),s[e[i].username]=e[i].type;n.sort().forEach(function(e){h.alter("push",{username:e,type:s[e]})});if(t.value){r=t.value.split(/,|;/);for(i=0,l=r.length;i<l;i++)r[i]=r[i].trim()}h.loop(function(e,t){r.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})},a.updateList=function(){var e,n,r=[],s={};if(t.value){c=!0,e=t.value.split(/,|;/),n=e[e.length-1].trim().toLowerCase(),h.reset([]),f.get("connections").forEach(function(e){e.username.toLowerCase().search(n)===0&&h.alter("push",{username:e.username,type:e.type})});if(t.value){currentList=t.value.split(/,|;/);for(i=0,l=currentList.length;i<l;i++)currentList[i]=currentList[i].trim()}h.loop(function(e,t){currentList.indexOf(e.username)>-1?h.update(t,"selected",!0):h.update(t,"selected",!1)})}},a.close=function(t,n){t.stopPropagation(),e.classList.add("invisible")},a.select=function(e,t){var n=t.getAttribute("data-auto_id"),r=h.get(n).selected;h.update(n,"selected",!r),r?a.remove(h.get(n)):a.add(h.get(n))},a.add=function(e){var n;if(e.type==="user")if(!c)t.value?t.value+=", "+e.username:t.value=e.username;else{var r=t.value.split(/,|;/),s="";r.forEach(function(e){e=e.trim()}),r.pop();for(i=0,l=r.length;i<l;i++)s+=r[i]+", ";s+=e.username,t.value=s,c=!1}else f.get("connections").forEach(function(t){t.username===e.username&&(n=t.contacts)}),n.forEach(function(e){t.value.search(e.username)<0&&(a.add(e),h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!0)}))});u(t.value)},a.remove=function(e){var n,r="";if(e.type==="user"){n=t.value.split(/,|;/);for(i=0,l=n.length;i<l;i++)n[i]=n[i].trim();n.splice(n.indexOf(e.username),1),n.forEach(function(e){r+=e+", "}),t.value=r.substr(0,r.length-2),u(r.substr(0,r.length-2)),h.loop(function(t,n){t.type==="group"&&t.selected&&f.get("connections").forEach(function(r){r.username===t.username&&JSON.stringify(r).search(e.username)>-1&&h.update(n,"selected",!1)})})}else f.get("connections").forEach(function(t){t.username===e.username&&t.contacts.forEach(function(e){h.loop(function(t,n){t.username===e.username&&h.update(n,"selected",!1)}),a.remove(e)})})},a.init(),a.render(),a.place(e)}return function(t,n,r){return u.prototype=new e,new u(t,n,r)}}),define("public/detail-stack/public-share",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(u){var a=new e,f=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:p.get("signature")}),g=new o([]),y=new o([]),b=!1,w=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return a.plugins.addAll({labels:new r(v),share:new r(m,{setHeader:function(e){this.innerHTML=v.get("sharing")+e}}),contacts:new r(y,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(g,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(a),errormsg:new r(f)}),a.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',a.reset=function(e){f.reset({errormsg:""}),m.reset({body:"",docId:e,docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),a.getIdeaDetails(e),p.get("signature")&&m.set("signature",p.get("signature")),y.reset([]),g.reset(p.get("connections").concat())},a.getIdeaDetails=function(e){var t=new l({});t.setTransport(d),t.sync(n.get("db"),e).then(function(){m.set("docType",t.get("type")),m.set("docTitle",t.get("title")),t.unsync()})},a.updateAutoContact=function(e,t){var n=JSON.parse(g.toJSON()),r=p.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")g.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);g.reset(n)}g.loop(function(e,t){y.toJSON().search(e.userid)>-1&&g.update(t,"selected",!0)})},a.close=function(e,t){t.parentNode.classList.add("invisible")},a.displayAutoContact=function(e,t){a.dom.querySelector("#sharelistauto").classList.remove("invisible"),g.reset(p.get("connections").concat())},a.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=y.get(n).userid;y.alter("splice",n,1),g.loop(function(e,t){e.userid===r&&setTimeout(function(){g.update(t,"selected",!1)},200)}),a.unselectGroup(r)},a.select=function(e,t){var n=t.getAttribute("data-auto_id");g.get(n).selected?(a.removeContact(g.get(n)),setTimeout(function(){g.update(n,"selected",!1),a.dom.querySelector("#sharelistauto").classList.add("invisible")},200)):(a.addContact(g.get(n)),a.selectGroup(),setTimeout(function(){g.update(n,"selected",!0),a.dom.querySelector("#sharelistauto").classList.add("invisible")},200))},a.selectAll=function(e,t){t.classList.remove("pressed"),y.reset([]),g.reset(p.get("connections")),g.loop(function(e,t){g.update(t,"selected",!0),e.type==="user"&&y.alter("push",e)})},a.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)a.removeContact(e.contacts[j]);else y.loop(function(t,n){t.userid===e.userid&&y.alter("splice",n,1)}),a.unselectGroup(e.userid),g.loop(function(t,n){t.userid===e.userid&&g.update(n,"selected",!1)})},a.selectGroup=function(){var e,t=!1;g.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(y.toJSON().search(e[j].userid)<0){t=!1;break}t&&g.update(r,"selected",!0)}})},a.unselectGroup=function(e){g.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&g.update(n,"selected",!1)})},a.addContact=function(e){var t,n,r=!0;if(e.type==="user")y.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)y.loop(function(n,i){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(y.alter("push",e.contacts[t]),g.loop(function(n,r){n.userid===e.contacts[t].userid&&g.update(r,"selected",!0)}))},a.press=function(e,t){t.classList.add("pressed")},a.share=function(e,t){var n=new Date,r={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:p.get("_id"),username:p.get("username"),firstname:p.get("firstname"),toList:"",ccList:"",object:"",body:m.get("body"),signature:m.get("signature"),docId:m.get("docId"),docType:m.get("docType"),docTitle:m.get("docTitle"),dest:[]};b||(b=!0,w.spin(t),a.buildRecipientList(r.docId,r.dest).then(function(){r.dest.length?d.request("Notify",r,function(e){f.set("errormsg",v.get("shareok")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(r.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),u("close")},2e3)}):(f.set("errormsg","intented recipients already have this idea"),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(r.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),u("close")},2500))}))},a.cancel=function(e,t){t.classList.remove("pressed"),u("close")},a.buildRecipientList=function(e,t){var r=new c,i=new l;return i.setTransport(d),i.sync(n.get("db"),e).then(function(){var e=i.get("sharedwith")||[],n=i.get("authors"),r;return y.loop(function(r,i){n.indexOf(r.userid)<0&&(e.length?e.indexOf(r.userid)<0&&(e.push(r.userid),t.push(r.userid)):(e.push(r.userid),t.push(r.userid)))}),i.set("sharedwith",e),i.upload()}).then(function(){r.fulfill()}),r},a.place(t.get("public-share")),a}}),define("public/public-stack",["OObject","service/map","Amy/Stack-plugin","./detail-stack/public-idea","./detail-stack/public-edit","./detail-stack/public-sendmail","./detail-stack/public-share","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){return function(){var t=new e,l,c,h,p,d=new n,v=u.get("observer"),m=new a,g=0,y=(new f({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return t.plugins.addAll({detailstack:d}),t.template='<div class="detail-stack" data-detailstack="destination"></div>',t.reset=function(e,n){m=e,g=n,d.getStack().show("#public-ideadetail"),l.hideCache(),y.spin(t.dom),l.reset(e,n).then(function(){y.stop(),cache.classList.add("invisible")})},t.action=function(e){switch(e){case"#public-edit":p.reset(m.get(g).id),d.getStack().show("#public-edit");break;case"#public-favorites":break;case"#public-share":h.reset(m.get(g).id),d.getStack().show("#public-share");break;case"close":d.getStack().show("#public-ideadetail");break;default:d.getStack().show("#public-ideadetail")}},t.edit=function(e){p.reset(e),d.getStack().show("#public-edit")},t.sendMail=function(e){c.reset(e),d.getStack().show("#public-sendmail")},t.share=function(e){h.reset(e._id),d.getStack().show("#public-share")},l=new r(t.action),p=new i(t.action),c=new s(t.action),h=new o(t.action),d.getStack().add("#public-ideadetail",l),d.getStack().add("#public-edit",p),d.getStack().add("#public-sendmail",c),d.getStack().add("#public-share",h),v.watch("public-viewidea",function(e){t.viewIdea(e)}),v.watch("public-edit",function(e){t.edit(e)}),v.watch("public-sendmail",function(e){t.sendMail(e)}),v.watch("public-share",function(e){t.share(e)}),t}}),define("service/new2c",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){return new function(){var o=new e,u=new s({userid:"",username:""}),a=i.get("user"),f=new s,l=i.get("labels"),c=i.get("transport"),h,p=!1,d=new s({error:""});return o.plugins.addAll({new2c:new n(f),dest:new n(u,{setHeader:function(e){this.innerHTML=l.get("sendtcprefix")+e+l.get("sendtcsuffix")}}),labels:new n(l),errormsg:new n(d),new2cevent:new r(o)}),o.template='<div><div class = "header blue-dark"><span data-dest="bind: setHeader, username"></span><div class="close-popup" data-new2cevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, twocentplaceholder" data-new2c="bind: value, message"></textarea></p><div><span class="errormsg" data-errormsg="bind:innerHTML, error"></span><div class="sendmail" data-new2cevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, sendlbl"></div></div></form></div>',o.render(),o.place(t.get("new2c-popup")),o.press=function(e,t){t.classList.add("pressed")},o.closePopup=function(){document.getElementById("new2c-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),f.reset(),u.reset(),d.reset({error:""})},o.reset=function(e){h=e,t.get("new2c-popup").classList.add("appear"),t.get("cache").classList.add("appear"),u.set("userid",h.userid),u.set("username",h.username),f.reset({author:a.get("_id"),message:"",firstname:a.get("firstname"),username:a.get("username"),date:[],datemod:"",plusones:0,replies:[]}),p=!1},o.cancel=function(e,t){o.closePopup()},o.upload=function(e,t){var n=new Date,r={},i;f.get("message")?(p=!0,i=setInterval(function(){d.get("error")===l.get("sendinginprogress")?d.set("error",l.get("sendinginprogress")+" ..."):d.set("error",l.get("sendinginprogress"))},150),f.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),r.tc=JSON.parse(f.toJSON()),r.userid=u.get("userid"),r.username=u.get("username"),c.request("SendTwocent",r,function(e){var n=h.twocents||[],s,u=a.get("connections");if(e==="ok"){n.unshift(r.tc),h.twocents=n;for(s=u.length-1;s>=0;s--)u[s].type==="user"&&u[s].userid===h.userid&&u.splice(s,1,h);a.set("connections",u),a.upload().then(function(){clearInterval(i),t.classList.remove("pressed"),o.closePopup()})}else d.set("error","something went wrong - try again later"),clearInterval(i),t.classList.remove("pressed")})):(d.set("error",l.get("nomessage")),t.classList.remove("pressed"))},o}}),define("service/actionbar",["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){function c(e,c,h,p){var d=new i([]),v=c.offsetHeight,m=new i({height:v}),g=10,y=r.get("user"),b=r.get("labels"),w=r.get("observer"),E=r.get("transport"),S=r.get("db"),x,T=this,N=(new f({color:"#9AC9CD",lines:10,length:10,width:8,radius:10})).spin();this.plugins.addAll({buttons:new t(d,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(m,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-g)+"px;")},setButtons:function(e){var t=Math.floor((e-g-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new n(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:mouseup, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:mousedown, press; listen:mouseup, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(e,t){p(this)},this.press=function(e,t){e.stopPropagation(),t.classList.add("pressed"),N.el=document.getElementById("abspinner")},this.action=function(e,t){var n=t.getAttribute("data-buttons_id"),i=d.get(n).name;e.stopPropagation(),t.classList.remove("pressed");switch(i){case"delete":this.deleteItem().then(function(){p(T)});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":r.get("observer").notify("replay-session",h.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();default:}},x=function(e,t){var n;switch(e){case"idea":n=new s,n.setTransport(E),n.sync(S,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){t=n.get(0).doc,h=n.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&d.alter("push",{name:"edit",icon:"img/wall/35modify.png"});if(t.sessionId&&t.sessionId!==""&&t.sessionId.search("deleted")===-1)if(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1){var e=new s;e.setTransport(r.get("transport")),e.sync(r.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){e.get(0)&&d.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?d.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&d.alter("push",{name:"share",icon:"img/wall/35share.png"})),t.authors.length===1&&t.authors[0]===y.get("_id")&&!t.twocents.length&&!t.sharedwith.length&&t.visibility!=="public"&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),t.authors.indexOf(y.get("_id"))===-1&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&d.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":d.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.type==="user"&&d.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),d.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;default:}},this.deleteItem=function(){var t=new u,n=new o;n.setTransport(E);switch(e){case"idea":h.authors.length===1&&h.authors[0]===y.get("_id")?n.sync(r.get("db"),h._id).then(function(){return n.remove()}).then(function(){t.fulfill()}):E.request("RemoveFromLibrary",{id:h._id,userid:y.get("_id")},function(e){t.fulfill()});break;case"message":var i=y.get("notifications"),s,a;for(s=0,l=i.length;s<l;s++)if(JSON.stringify(i[s])===JSON.stringify(h)){a=s;break}i.splice(a,1),y.set("notifications",i),y.upload();break;case"contact":var i=y.get("connections"),f=new Date,c=[f.getFullYear(),f.getMonth(),f.getDate(),f.getHours(),f.getMinutes(),f.getSeconds()];if(h.type==="user"){for(s=i.length-1;s>=0;s--)if(i[s].type==="user"&&i[s].userid===h.userid)i.splice(s,1);else if(i[s].type==="group"){var p=i[s].contacts;for(j=p.length-1;j>=0;j--)p[j].userid===h.userid&&p.splice(j,1)}}else for(s=i.length-1;s>=0;s--)i[s].username===h.username&&i.splice(s,1);y.set("connections",i),h.type==="user"&&y.get("news").unshift({type:"CX-",date:c,content:{userid:h.userid,username:h.username}}),y.upload().then(function(){if(h.type==="user"){var e=new Date,t={dest:[h.userid],date:c,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:h.username,ccList:"",object:y.get("username")+b.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}};E.request("Notify",t,function(e){console.log(e)})}w.notify("contact-deleted")});break;default:}return t},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-edit",h._id):w.notify("library-edit",h._id);break;default:}N.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-sendmail",h):w.notify("library-sendmail",h);break;case"message":break;case"contact":w.notify("message-contact",h);break;default:}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?w.notify("public-share",h):w.notify("library-share",h);break;case"message":break;case"contact":break;default:}},this.sendTwocent=function(){a.reset(h)},x(e,h)}return function(t,n,r,i){return c.prototype=new e,new c(t,n,r,i)}}),define("public/lists/list-public",["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h=!1,p=null,d={db:e,view:f,design:o,query:{descending:!0,limit:50}};c.setTransport(n.get("transport")),l&&(d.query=l),this.template="<div><div id='noresult' class='date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:innerHTML,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul></div>",d.query.q&&(this.template="<div><div id='noresult' class='date invisible' data-labels='bind:innerHTML,noresult' ></div><ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,doc.authors'></div><h2 data-listideas='bind:innerHTML,doc.authornames'></h2><span class='date' data-listideas='bind:date,doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,doc.title'>Idea title</h3><p data-listideas='bind:setDesc,doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, rating'></span> </div></li></ul></div>"),this.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function v(v){this.innerHTML=s.formatDate(v)},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(e){if(e===undefined){var t=this.getAttribute("data-listideas_id"),n=c.get(t).doc.votes||[];n.length===0?this.innerHTML="":this.innerHTML=Math.round(n.reduce(function(e,t){return e+t})/n.length*100)/100}else this.innerHTML=e},setAvatar:function(e){var t,n}}),listevent:new i(this)}),this.getModel=function(){return c},this.resetQuery=function(e){var t=new a;return d.query=e,c.unsync(),c.reset([]),c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){p&&this.hideActionBar(p)},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("public");if(!r.classList.contains("mosaic")){var i=new u("idea",t,c.get(n).id,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),p=i,h=!0}},this.hideActionBar=function(e){var t=e.dom.parentElement;t.removeChild(t.lastChild),h=!1,p=null},this.init=function(){var e=new a;return c.sync(d.db,d.design,d.view,d.query).then(function(){e.fulfill()}),e}}return function(t,n,r,i){return f.prototype=new e,new f(t,n,r,i)}}),define("public/lists/list-polling",["OObject","CouchDBView","Store","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,n,u,l){var c=new t([]),h,p=!1,d=null,v=r.get("user"),m={db:e,view:u,design:n,query:{descending:!0,limit:50}},g=this;this.template="<ul class='idea-list' data-listideas='foreach'><li class='list-item' data-listevent='listen:mousedown, setStart; listen:dblclick, showActionBar'><div class='item-header'><div class='avatar' data-listideas='bind:setAvatar,value.doc.authors'></div><h2 data-listideas='bind:innerHTML,value.doc.authornames'></h2><span class='date' data-listideas='bind:date,value.doc.creation_date'></span></div><div class='item-body'><h3 data-listideas='bind:innerHTML,value.doc.title'>Idea title</h3><p data-listideas='bind:setDesc,value.doc.description'></p></div><div class='item-footer'><a class='idea-type'></a><a class='item-acorn'></a><span class='rating' data-listideas='bind:setRating, value.rating'></span> </div></li></ul>",this.plugins.addAll({listideas:new i(c,{date:function(e){this.innerHTML=o.formatDate(e)},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(e){if(e===undefined){var t=this.getAttribute("data-listideas_id"),n=c.get(t).doc.votes||[];n.length===0?this.innerHTML="":this.innerHTML=Math.round(n.reduce(function(e,t){return e+t})/n.length*100)/100}else this.innerHTML=e},setAvatar:function(e){var t,n}}),listevent:new s(this)}),this.getModel=function(){return c},g.resetQuery=function(e){var n=new f,i=v.get("settings").polling_interval||r.get("polling_interval"),s=new t;return e&&(m.query=e),clearInterval(h),s.setTransport(r.get("transport")),s.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(s.toJSON())),s.unsync(),h=setInterval(function(){s.reset([]),s.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(s.toJSON())),s.unsync()})},i),n.fulfill()}),n},this.setStart=function(e,t){d&&this.hideActionBar(d)},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("public");if(!r.classList.contains("mosaic")){var i=new a("idea",t,c.get(n).id,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),d=i,p=!0}},this.hideActionBar=function(e){var t=e.dom.parentElement;t.removeChild(t.lastChild),p=!1,d=null},l&&(m.query=l),this.init=function(){var e=new f,n=v.get("settings").polling_interval||r.get("polling_interval"),i=new t;return i.setTransport(r.get("transport")),i.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(i.toJSON())),i.unsync(),h=setInterval(function(){i.reset([]),i.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(i.toJSON())),i.unsync()})},n),e.fulfill()}),e},v.watchValue("settings",function(){var e=new t,n;v.get("settings").polling_interval!==r.get("polling_interval")&&(r.set("polling_interval",v.get("settings").polling_interval),n=r.get("polling_interval"),clearInterval(h),e.setTransport(r.get("transport")),h=setInterval(function(){e.reset(),e.sync(m.db,m.design,m.view,m.query).then(function(){c.reset(JSON.parse(e.toJSON())),e.unsync()})},n))}),r.get("observer").watch("update-polling",function(){g.resetQuery()})}return function(t,n,r,i){return l.prototype=new e,new l(t,n,r,i)}}),define("service/submenu",["OObject","Bind.plugin","Amy/Control-plugin","service/config"],function(e,t,n,r){function i(e,i){var s=!1,o,u,a,f,l,c=new n(this),h=function(t){t?e.setAttribute("style","display : block;"):e.setAttribute("style","display : none;"),s=t};o="<div></div>",u='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#ideas" data-menucontrol="init"><a class="library-item" href="#ideas" data-label="bind:innerHTML, library-ideas"></a></li><li class="menu-item" name="#sessions"><a class="library-item" href="#sessions" data-label="bind:innerHTML, library-sessions"></a></li><li class="menu-item" name="#decks"><a class="library-item" href="#decks" data-label="bind:innerHTML, library-decks"></a></li></ul></div>',a="<div></div>",f='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" data-menucontrol="init" name="#messages"><a class="connect-item" href="#connect-messages" data-label="bind:innerHTML, connect-messages"></a></li><li class="menu-item" name="#contacts"><a class="connect-item" href="#connect-contacts" data-label="bind:innerHTML, connect-contacts"></a></li><li class="menu-item" name="#twocents"><a class="connect-item" href="#connect-twocents" data-label="bind:innerHTML, connect-twocents"></a></li></ul></div>',l='<div class="sub-menu"><div class="left-caret"></div><ul class="menu-list" data-menucontrol="radio:li,selected,mousedown,setCurrentWidget"><li class="menu-item selected" name="#profile" data-menucontrol="init"><a class="dashboard-item" href="#dashboard-profile" data-label="bind:innerHTML, dashboard-profile"></a></li><li class="menu-item" name="#settings"><a class="dashboard-item" href="#dashboard-settings" data-label="bind:innerHTML, dashboard-settings">Settings</a></li><li class="menu-item" name="#about"><a class="dashboard-item" href="#dashboard-about" data-label="bind:innerHTML, dashboard-about">About Ideafy</a></li></ul></div>',e.id.search("public")>-1&&(this.template=o),e.id.search("library")>-1&&(this.template=u),e.id.search("brainstorm")>-1&&(this.template=a),e.id.search("connect")>-1&&(this.template=f),e.id.search("dashboard")>-1&&(this.template=l),this.plugins.addAll({label:new t(r.get("labels")),menucontrol:c}),this.getState=function(){return s},this.toggleActive=function(e){h(e)},this.setCurrentWidget=function(e){var t=e.target.getAttribute("name");i&&i(t),setTimeout(function(){h(!1)},200)},this.setWidget=function(e){var t=this.dom.querySelector('li[name="'+e+'"]');i(e),t.parentNode.querySelector(".selected").classList.remove("selected"),t.classList.add("selected"),c.init(this.dom.querySelector('li[name="'+e+'"]'))},this.reset=function(){var e=this.dom.querySelector(".menu-list");e&&(e.querySelector(".selected").classList.remove("selected"),e.firstChild.classList.add("selected"),c.init(e.firstChild))},this.render(),this.place(e)}return function(t,n){return i.prototype=new e,new i(t,n)}}),define("public/public",["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","service/map","service/config","./public-stack","service/utils","./lists/list-public","./lists/list-polling","Amy/Stack-plugin","service/submenu","Promise"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(){var a=new e,p,d,v,m=o.get("db"),g=new t(a),y=new u,b,w,E,S,x=new c;return a.template='<div id="public"><div id = "public-menu"></div><div id="public-list" class="list"><div class="header blue-light"><div class="option left" data-publiccontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, publicideasheadertitle"></span><div class="option right" data-publicevent="listen: mousedown, plus"></div></div><div data-liststack="destination" data-publiccontrol="radio:li,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-label="bind: placeholder, searchpublicplaceholder" data-publicevent="listen: keypress, search"><div name="#list-date" class="tools-button bydate pushed" data-publicevent="listen:mousedown,show"></div><div name="#list-rating" class="tools-button byrating" data-publicevent="listen:mousedown,show"></div></div></div></div><div id="public-detail" class="details" data-publicplace="place:details"></div></div>',a.plugins.addAll({liststack:x,label:new n(o.get("labels")),publicevent:new i(a),publicplace:new r({details:y}),publiccontrol:g}),a.place(s.get("public")),a.selectStart=function(e){var t=x.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");y.reset(t,n)},a.displayHighlightedIdea=function(){var e=x.getStack().getCurrentScreen(),t=e.dom.querySelector(".list-item.selected")||e.dom.querySelector("li[data-listideas_id='0']");id=t.getAttribute("data-listideas_id"),t.classList.add("selected"),t.scrollIntoView(),g.init(t),y.reset(e.getModel(),id)},a.show=function(e,t){var n=p.querySelector(".bydate"),r=p.querySelector(".byrating"),i=t.getAttribute("name");i!==x.getStack().getCurrentName&&(x.getStack().show(i),i==="#list-date"?(r.classList.remove("pushed"),n.classList.add("pushed")):(r.classList.add("pushed"),n.classList.remove("pushed")),a.displayHighlightedIdea())},a.mosaic=function(){var e=document.getElementById("public-detail");p.classList.toggle("mosaic"),e.classList.contains("invisible")&&(e.classList.remove("invisible"),y.reset(w.getModel(),0))},a.plus=function(){s.get("newidea-popup").classList.add("appear"),s.get("cache").classList.add("appear")},a.search=function(e,t){e.keyCode===13&&(t.value===""?w.resetQuery().then(function(){d.setAttribute("style","display: inline-block;"),v.setAttribute("style","display: inline-block;"),x.getStack().show("#list-date"),d.classList.add("pushed"),v.classList.remove("pushed"),a.displayHighlightedIdea()}):a.searchIdea(t.value),t.blur())},a.searchIdea=function(e){d.setAttribute("style","display: none;"),v.setAttribute("style","display: none;"),S.resetQuery({q:e,sort:"\\creation_date<date>",include_docs:!0}).then(function(){x.getStack().show("#list-search"),S.getModel().getNbItems()>0?(document.getElementById("noresult").classList.add("invisible"),a.displayHighlightedIdea()):document.getElementById("noresult").classList.remove("invisible")})},a.reset=function(){E.init(y.reset),w.init(y.reset).then(function(){x.getStack().show("#list-date"),y.reset(w.getModel(),0)})},a.showMenu=function(){b.toggleActive(!0)},a.hideMenu=function(){b.toggleActive(!1)},b=new h(a.dom.querySelector("#public-menu")),b.toggleActive(!1),p=a.dom,d=p.querySelector(".bydate"),v=p.querySelector(".byrating"),w=new l(m,"library","_view/publicideas"),E=new f(m,"ideas","_view/ideasbyvotes"),S=new f("_fti/local/"+m,"indexedideas","publicbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:60,include_docs:!0}),x.getStack().add("#list-rating",E),x.getStack().add("#list-search",S),x.getStack().add("#list-date",w),E.init(),w.init().then(function(){x.getStack().show("#list-date"),a.displayHighlightedIdea()}),a}}),define("library/ideas/detail-stack/library-idea",["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(d){var v=new e,m=new f("library"),g=new a("library"),y=u.get("labels"),b=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),w=!1,E=u.get("user"),S=u.get("transport"),x=new h,T=new t([]),N=i.get("ideas-detail"),C=i.get("library-writetwocents"),k=new l;return x.setTransport(S),v.plugins.addAll({label:new n(y),ideadetail:new n(x,{toggleRateEdit:function(e){e.indexOf(E.get("_id"))>-1?this.setAttribute("href","#library-edit"):this.setAttribute("href","#library-favorites")},toggleTwocentShare:function(e){e.indexOf(E.get("_id"))>-1?this.setAttribute("href","#library-share"):this.setAttribute("href","#library-2cents")},displayWriteTwocent:function(e){e.indexOf(E.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("library-writetwocents").classList.add("invisible")},date:function L(L){L&&(this.innerHTML=s.formatDate(L))},setAuthor:function(e){e===E.get("username")&&x.get("authors").indexOf(E.get("_id"))>-1?this.innerHTML=y.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e.length===1&&e[0]===E.get("_id")?this.innerHTML=y.get("youwrotelbl"):e.length>1?this.innerHTML=y.get("theywrotelbl"):this.innerHTML=y.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new o(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},hideRating:function(e){e.search("I:WELCOME")>-1?this.classList.add("invisible"):this.classList.remove("invisible")},setRating:function(e){e.length===0?this.innerHTML="":this.innerHTML=Math.round(e.reduce(function(e,t){return e+t})/e.length*100)/100},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setSolution:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=x.get("_id"),n=x.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),E.get("rated_ideas").indexOf(t)<0&&n.indexOf(E.get("_id"))<0&&!w?(this.setAttribute("name","vote"),this.innerHTML=y.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(w=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),e.length===0?this.innerHTML="("+y.get("novotesyet")+")":e.length===1?this.innerHTML="("+y.get("onevote")+")":this.innerHTML="("+e.length+" "+y.get("votes")+")",this.classList.add("votes"))},setSharedWith:function(e){x.get("_id").search("I:WELCOME")<0&&e&&e.length?(this.classList.remove("invisible"),e.length===1?this.innerHTML=y.get("sharedwith")+"<b><u>"+1+y.get("ideafyer")+"</u></b>":this.innerHTML=y.get("sharedwith")+"<b><u>"+e.length+y.get("ideafyer")+"</u></b>"):this.classList.add("invisible")}}),share:new n(T),vote:new n(b,{setIcon:function(e){var t="background: url('img/public/activeIdeaVote.png') no-repeat center center;",n="background: url('img/public/rateForList.png') no-repeat center center;";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new p({LibraryTwocentUI:m}),ideadetailevent:new r(v)}),v.template='<div class="library-idea"><div class="header blue-dark"><a href="#library-2cents" data-ideadetail="bind: toggleTwocentShare, authors" data-ideadetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, ideadetailsheadertitle"></span><a href="#library-favorites" data-ideadetail="bind: toggleRateEdit, authors" data-ideadetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache" class="invisible"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-ideadetail="bind:setAvatar, authors"></div><h2 data-ideadetail="bind:innerHTML,title"></h2><span class="date" data-ideadetail="bind:date, creation_date"></span><br><span class="author" data-ideadetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-ideadetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><p data-ideadetail="bind:setDescription,description"></p><p data-ideadetail="bind:setSolution,solution"></p></div><div class="detail-footer"><div class="sharedwith invisible" data-ideadetail="bind: setSharedWith, sharedwith" data-ideadetailevent="listen:mousedown, displayList"></div><div id="sharelist" class="autocontact invisible"><div class="autoclose" data-ideadetailevent="listen:mousedown,close"></div><ul data-share="foreach"><li data-share="bind:innerHTML, value.username"></li></ul></div><div class ="rateIdea" data-ideadetail="bind:hideRating, id"><a class="item-acorn"></a><div class="rating" data-ideadetail="bind:setRating,votes"></div><div class="publicButton" data-ideadetail="bind: toggleVoteButton, votes" name="vote" data-ideadetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-ideadetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="library-writetwocents" class="invisible" data-ideadetail="bind: displayWriteTwocent, authors"></div><div id="library-twocents" class="twocents" data-ideadetail="bind: displayTwocentList, twocents" data-place="place: LibraryTwocentUI"></div></div>',v.showCache=function(){v.dom.querySelector("#idea-cache").classList.remove("invisible")},v.hideCache=function(){v.dom.querySelector("#idea-cache").classList.add("invisible")},v.reset=function(e,t){var n=e.get(t).id,r=new c;return b.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),v.getIdea(n).then(function(){w=!1,g.reset(x.get("_id")),m.reset(x.get("_id")),C=document.getElementById("library-writetwocents"),g.place(C),r.fulfill()}),r},v.getIdea=function(e){return x.unsync(),x.reset(),x.sync(u.get("db"),e)},v.action=function(e,t){var n=t.getAttribute("href");n==="#library-2cents"?(g.reset(x.get("_id")),C.classList.remove("invisible")):d(n)},v.edit=function(){_stack.getStack().show("#public-edit")},v.press=function(e,t){t.classList.add("pressed")},v.vote=function(e,t){w||document.getElementById("ratingPopup").classList.add("appear"),t.classList.remove("pressed")},v.previewVote=function(e,t){var n=0,r=t.getAttribute("data-vote_id");b.loop(function(e,t){t<=r?b.update(t,"active",!0):b.update(t,"active",!1)})},v.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,r=x.get("_id"),i={id:r,vote:n,voter:E.get("_id")};w||(w=!0,S.request("Vote",i,function(e){var t=E.get("rated_ideas")||[];e!=="ok"?(console.log(e,"something went wrong, please try again later"),w=!1):(t.unshift(r),E.set("rated_ideas",t),alert(u.get("labels").get("thankyou")),document.getElementById("ratingPopup").classList.remove("appear"),b.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},v.close=function(e,t){t.parentNode.classList.add("invisible")},v.displayList=function(e,t){S.request("GetUserNames",{list:x.get("sharedwith")},function(e){T.reset(e),document.getElementById("sharelist").classList.remove("invisible")})},v.place(N),v}}),define("library/ideas/detail-stack/library-edit",["OObject","service/map","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/config","service/confirm","Promise"],function(e,t,n,r,i,s,o,u,a){return function(f){var l=new e,c=new r,h=o.get("labels"),p=new n({error:""}),d;return c.setTransport(o.get("transport")),l.plugins.addAll({editlabel:new i(h),editidea:new i(c,{setVisibility:function(e){e==="public"?this.innerHTML=h.get("publiclbl"):this.innerHTML=h.get("privatelbl")},hideVisibility:function(e){e==="public"?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setVisibleIcon:function(e){e==="public"?this.setAttribute("style","background:url('img/public/publicForList.png') no-repeat left center; background-size: 14px 12px;"):this.setAttribute("style","background-image:url('img/public/privateForList.png');")},setReplay:function(e){!e||e.search("deleted")!==-1?this.setAttribute("style","display:none"):this.setAttribute("style","display:inline-block")},setIdeafyStatus:function(e){e?this.innerHTML=h.get("enabledreplaylbl"):this.innerHTML=h.get("disabledreplaylbl")},setSessionReplay:function(e){e?this.innerHTML=h.get("disablereplaylbl"):this.innerHTML=h.get("enablereplaylbl")}}),editevent:new s(l),errormsg:new i(p,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;case"nosol":this.innerHTML=h.get("solutionfield")+h.get("emptyfielderror");break;default:this.innerHTML=""}}})}),l.template='<div class="idea-edit"><div class="header blue-dark"><span data-editlabel="bind:innerHTML, modifyidealbl"></span></div><form class="form"><p><input type="text" class="input" data-editidea="bind: value, title"></p><p><textarea class="description input" data-editidea="bind: value, description"></textarea></p><p><textarea class="solution input" data-editidea="bind: value, solution"></textarea></p><div class="options"><div class="current-visibility" data-editidea="bind:setVisibleIcon, visibility"><span class="label" data-editlabel="bind:innerHTML,ideavisiblelbl"></span><span data-editlabel="bind:innerHTML, privatelbl" data-editidea="bind:setVisibility, visibility"></span></div><div class="edit-visibility" data-editidea="bind:hideVisibility, visibility"><span class="label" data-editlabel="bind:innerHTML,setideavisiblelbl"></span><div class="visibility public" data-editlabel="bind:innerHTML, publiclbl" data-editevent="listen:mousedown, editVisibility"></div></div></div><div class="options invisible" data-editidea="bind:setReplay, sessionId"><div class="current-visibility replay"><span class="label" data-editlabel="bind:innerHTML,ideafyreplaylbl"></span><span data-editlabel="bind:innerHTML, disabledreplaylbl" data-editidea="bind:setIdeafyStatus, sessionReplay"></span></div><div class="edit-visibility replay"><span class="label" data-editlabel="bind:innerHTML, ideafysetreplaylbl"></span><div class="toggle-replay" data-editidea = "bind: setSessionReplay, sessionReplay" data-editevent="listen:mousedown, press; listen:mouseup, enableReplay" data-editlabel="bind:innerHTML, enablereplaylbl"></div></div></div><p class="submit"><label class="publish pressed-btn" data-editlabel="bind:innerHTML, publishlbl" data-editevent="listen: mousedown, press; listen:mouseup, upload"></label><label class="cancel pressed-btn" data-editlabel="bind:innerHTML, cancellbl" data-editevent="listen: mousedown, press;listen:mouseup, cancel"></label><label class="editerror" data-errormsg="bind:setError, error"></label></p></form></div>',l.place(t.get("library-edit")),l.reset=function(e){c.unsync(),c.reset(),c.sync(o.get("db"),e),d=!1},l.editVisibility=function(e,t){var n=new u(t,h.get("setpublicquestion"),function(e){e?c.set("visibility","public"):c.set("visibility","private"),n.close()})},l.press=function(e,t){t.classList.add("pressed")},l.enableReplay=function(e,t){setTimeout(function(){c.get("sessionReplay")?c.set("sessionReplay",!1):c.set("sessionReplay",!0),d=!0,t.classList.remove("pressed")},300)},l.updateSessionReplay=function(e){var t=new a,n=new r;return n.setTransport(o.get("transport")),n.sync(o.get("db"),c.get("sessionId")).then(function(){var r=n.get("replayIdeas")||[],i;if(e)r.push(c.get("_id"));else for(i=r.length-1;i>=0;i--)r[i]===c.get("_id")&&r.splice(i,1);n.set("replayIdeas",r),n.upload().then(function(){t.fulfill(),n.unsync()})}),t},l.upload=function(e,t){var n=new Date,r=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()];c.get("title")===""?p.set("error","notitle"):c.get("description")===""?p.set("error","nodesc"):c.get("solution")===""?p.set("error","nosol"):(c.set("modification_date",r),c.upload().then(function(){d&&l.updateSessionReplay(c.get("sessionReplay")).then(null,function(e){console.log(e)}),f("close")})),t.classList.remove("pressed")},l.cancel=function(e,t){t.classList.remove("pressed"),f("close")},l}}),define("library/ideas/detail-stack/library-sendmail",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(f){var c=new e,h=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({toField:"",from:"",subject:"",body:"",signature:"",attachment:"",sent:!1});return c.plugins.addAll({labels:new r(v),mail:new r(m,{setUserAvatar:function(e){e&&this.setAttribute("style","background: url('"+n.get("avatar")+"') no-repeat center center; background-size: cover")},date:function g(g){g&&(this.innerHTML=a.formatDate(g))},setAvatar:function(e){if(e){var t=document.createDocumentFragment(),n=new u(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}},setRating:function(e){},setVotes:function(e){}}),mailevent:new s(c),errormsg:new r(h)}),c.template='<div class="idea-sendmail"><div class="header blue-dark"><span data-labels="bind:innerHTML, sendidealbl"></span></div><div class="avatar" data-mail="bind:setUserAvatar, from"></div><form class="form"><p><textarea class="mail-header" data-mail="bind: value, toField" data-labels="bind:placeholder, tolbl"></textarea></p><p><input type="text" class="input" data-mail="bind:value, subject" data-labels="bind:placeholder, subjectlbl"></textarea></p><p><textarea class="input" data-mail="bind:value, body"></textarea></p><p><legend data-labels="bind: innerHTML, signaturelbl"></legend><textarea class="signature" data-mail="bind:value, signature"></textarea></p><div class="attachment"><div class="attachment-header"><div data-mail="bind:setAvatar, attachment.authors"></div><span class="date" data-mail="bind:date, attachment.creation_date"></span><h2 data-mail="bind:innerHTML,attachment.title"></h2><span class="author" data-mail="bind:innerHTML,attachment.authornames"></span><span data-labels="bind:innerHTML, ideawrotelbl"></span><div class="visibility-icon private"></div></div><div class="attachment-body"><p data-mail="bind:innerHTML,attachment.description"></p><p data-mail="bind:innerHTML,attachment.solution"></p><div class = "rating" data-mail="bind:setRating, attachment.rating"></div><div class = "votes" data-mail="bind:setVotes, attachment.votes"></div></div></div><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-mailevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-mailevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',c.reset=function(e){h.reset({errormsg:""}),m.reset({toField:"",from:p.get("username"),subject:"",body:"",signature:p.get("username")+" <"+p.get("_id"),attachment:e,sent:!1}),p.get("signature")&&m.set("signature",p.get("signature"))},c.validateAddress=function(e){var t=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/,n=e.toLowerCase().split(/,|;/),r=!0;for(i=0,l=n.length;i<l;i++)if(!t.test(n[i].trim())){h.set("errormsg",n[i]+v.get("notavalidaddress")),r=!1;break}return r},c.validateMessage=function(){return m.get("toField")?c.validateAddress(m.get("toField")):h.set("errormsg",v.get("norecipient")),h.get("errormsg")===""},c.sendMail=function(){var e={};e.type="doc",e.recipient=m.get("toField"),e.cc=p.get("_id"),e.replyTo=p.get("_id"),e.subject=p.get("username")+v.get("sentdocmsg"),e.header=m.get("subject"),e.body=m.get("body"),e.signature=m.get("signature"),e.attachHeader="<div style='background:#657B99; font-family:Helvetica; padding:15px;'><p style='color:white;font-size:24px;font-weight:bold;margin-top:10px;'>"+m.get("attachment").title+"</p><p style='color: #F27B3D; font-size:16px; font-weight:bold;margin-bottom:10px;'>"+m.get("attachment").authornames+", <span style='color:black';>"+a.formatDate(m.get("attachment").creation_date)+"</span></p></div>",e.attachBody="<div style='border:1px solid #657b99;background:white'><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+m.get("attachment").description+"</p><p style='font-size:14px; font-family:Helvetica; text-align:justify; padding:15px;'>"+m.get("attachment").solution+"</p></div>",d.request("SendMail",e,function(e){e.sendmail==="ok"?(h.set("errormsg",v.get("yourmessage")+e.recipient+v.get("sentoklbl")),setTimeout(function(){f("close")},350)):(h.set("errormsg",v.get("somethingwrong")),m.set("sent",!1),console.log("error",e.error),console.log("response",e.response))})},c.press=function(e,t){(!t.classList.contains("sendmail")||!m.get("sent"))&&t.classList.add("pressed")},c.send=function(e,t){m.get("sent")||(m.set("sent",!0),h.set("errormsg",""),t.classList.remove("pressed"),c.validateMessage()?c.sendMail():m.set("sent",!1))},c.cancel=function(e,t){t.classList.remove("pressed"),f("close")},c.place(t.get("library-sendmail")),c}}),define("library/ideas/detail-stack/library-share",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","service/avatar","service/utils","service/autocontact","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f,l,c,h){return function(u){var a=new e,f=new o({errormsg:""}),p=n.get("user"),d=n.get("transport"),v=n.get("labels"),m=new o({body:"",docId:"",docType:"",attachment:"",docTitle:"",signature:p.get("signature")}),g=new o([]),y=new o([]),b=!1,w=(new h({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:30,top:-6})).spin();return a.plugins.addAll({labels:new r(v),share:new r(m,{setHeader:function(e){this.innerHTML=v.get("sharing")+e}}),contacts:new r(y,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new r(g,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),shareevent:new s(a),errormsg:new r(f)}),a.template='<div class="idea-share"><div class="header blue-dark"><span data-share="bind:setHeader, docTitle">Sharing idea</span></div><form class="form"><legend>Select contacts</legend><div class="selectall" data-labels="bind:innerHTML, selectall" data-shareevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-shareevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="sharelistauto" class="autocontact invisible"><div class="autoclose" data-shareevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-shareevent="listen:mouseup, select"></li></ul></div><div class="sharecontactlist"><ul data-contacts="foreach"><li class = "contact list-item" data-shareevent="listen:mousedown, discardContact"><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><p><legend>Add a message</legend><textarea class="input sharemessage" data-share="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-share="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-shareevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sharelbl" data-shareevent="listen:mousedown, press; listen:mouseup, share">Share</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',a.reset=function(e){f.reset({errormsg:""}),m.reset({body:"",docId:e,docType:"",docTitle:"",signature:p.get("username")+" <"+p.get("_id")+">"}),a.getIdeaDetails(e),p.get("signature")&&m.set("signature",p.get("signature")),y.reset([]),g.reset(p.get("connections").concat())},a.getIdeaDetails=function(e){var t=new l({});t.setTransport(d),t.sync(n.get("db"),e).then(function(){m.set("docType",t.get("type")),m.set("docTitle",t.get("title")),t.unsync()})},a.updateAutoContact=function(e,t){var n=JSON.parse(g.toJSON()),r=p.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")g.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);g.reset(n)}g.loop(function(e,t){y.toJSON().search(e.userid)>-1&&g.update(t,"selected",!0)})},a.close=function(e,t){t.parentNode.classList.add("invisible")},a.displayAutoContact=function(e,t){a.dom.querySelector("#sharelistauto").classList.remove("invisible"),g.reset(p.get("connections").concat())},a.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=y.get(n).userid;y.alter("splice",n,1),g.loop(function(e,t){e.userid===r&&setTimeout(function(){g.update(t,"selected",!1)},200)}),a.unselectGroup(r)},a.select=function(e,t){var n=t.getAttribute("data-auto_id");g.get(n).selected?(a.removeContact(g.get(n)),setTimeout(function(){g.update(n,"selected",!1),document.getElementById("sharelistauto").classList.add("invisible")},200)):(a.addContact(g.get(n)),a.selectGroup(),setTimeout(function(){g.update(n,"selected",!0),document.getElementById("sharelistauto").classList.add("invisible")},200))},a.selectAll=function(e,t){t.classList.remove("pressed"),y.reset([]),g.reset(p.get("connections")),g.loop(function(e,t){g.update(t,"selected",!0),e.type==="user"&&y.alter("push",e)})},a.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)a.removeContact(e.contacts[j]);else y.loop(function(t,n){t.userid===e.userid&&y.alter("splice",n,1)}),a.unselectGroup(e.userid),g.loop(function(t,n){t.userid===e.userid&&g.update(n,"selected",!1)})},a.selectGroup=function(){var e,t=!1;g.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(y.toJSON().search(e[j].userid)<0){t=!1;break}t&&g.update(r,"selected",!0)}})},a.unselectGroup=function(e){g.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&g.update(n,"selected",!1)})},a.addContact=function(e){var t,n,r=!0;if(e.type==="user")y.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)y.loop(function(n,i){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(y.alter("push",e.contacts[t]),g.loop(function(n,r){n.userid===e.contacts[t].userid&&g.update(r,"selected",!0)}))},a.press=function(e,t){t.classList.add("pressed")},a.share=function(e,t){var n=new Date,r={type:"DOC",status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getMinutes()],author:p.get("_id"),username:p.get("username"),firstname:p.get("firstname"),toList:"",ccList:"",object:"",body:m.get("body"),signature:m.get("signature"),docId:m.get("docId"),docType:m.get("docType"),docTitle:m.get("docTitle"),dest:[]};b||(b=!0,w.spin(t),a.buildRecipientList(r.docId,r.dest).then(function(){r.dest.length?d.request("Notify",r,function(e){f.set("errormsg",v.get("shareok")),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(r.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),u("close")},2500)}):(f.set("errormsg","intented recipients already have this idea"),t.classList.remove("pressed"),b=!1,setTimeout(function(){w.stop(),a.reset(r.docId),a.dom.querySelector("#sharelistauto").classList.add("invisible"),g.reset(p.get("connections").concat()),u("close")},2500))}))},a.cancel=function(e,t){t.classList.remove("pressed"),u("close")},a.buildRecipientList=function(e,t){var r=new c,i=new l;return i.setTransport(d),i.sync(n.get("db"),e).then(function(){var e=i.get("sharedwith")||[],n=i.get("authors"),r;return y.loop(function(r,i){n.indexOf(r.userid)<0&&(e.length?e.indexOf(r.userid)<0&&(e.push(r.userid),t.push(r.userid)):(e.push(r.userid),t.push(r.userid)))}),i.set("sharedwith",e),i.upload()}).then(function(){r.fulfill()}),r},a.place(t.get("library-share")),SHARESPIN=w,a}}),define("library/ideas/idea-stack",["OObject","service/map","Amy/Stack-plugin","./detail-stack/library-idea","./detail-stack/library-edit","./detail-stack/library-sendmail","./detail-stack/library-share","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f){return function(){var t=new e,l,c,h,p,d=new n,v=u.get("observer"),m=new a,g=0,y=(new f({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return t.plugins.addAll({detailstack:d}),t.template='<div class="detail-stack" data-detailstack="destination"></div>',t.reset=function(e,n){var r;m=e,g=n,d.getStack().show("#library-ideadetail"),l.hideCache(),y.spin(t.dom),l.reset(e,n).then(function(){y.stop(),r.classList.add("invisible")})},t.action=function(e){switch(e){case"#library-edit":p.reset(m.get(g).id),d.getStack().show("#library-edit");break;case"#library-favorites":break;case"#library-share":console.log(m.get(g)),h.reset(m.get(g).id),d.getStack().show("#library-share");break;case"close":d.getStack().show("#library-ideadetail");break;default:d.getStack().show("#library-ideadetail")}},t.edit=function(e){p.reset(e),d.getStack().show("#library-edit")},t.sendMail=function(e){c.reset(e),d.getStack().show("#library-sendmail")},t.share=function(e){h.reset(e._id),d.getStack().show("#library-share")},l=new r(t.action),p=new i(t.action),c=new s(t.action),h=new o(t.action),d.getStack().add("#library-ideadetail",l),d.getStack().add("#library-edit",p),d.getStack().add("#library-sendmail",c),d.getStack().add("#library-share",h),v.watch("library-viewidea",function(e){t.viewIdea(e)}),v.watch("library-edit",function(e){t.edit(e)}),v.watch("library-sendmail",function(e){t.sendMail(e)}),v.watch("library-share",function(e){t.share(e)}),t}}),define("library/ideas/lists/idealist",["OObject","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a){function f(e,o,f,l){var c=new t([]),h=!1,p=null,d={db:e,view:f,design:o,query:{descending:!0}};c.setTransport(n.get("transport")),l&&(d.query=l),this.template='<div><div id="noresult" class="date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,value.doc.authors"></div><h2 data-listideas="bind:innerHTML,value.doc.authornames"></h2><span class="date" data-listideas="bind:date, value.doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,value.doc.title"></h3><p data-listideas="bind:innerHTML, value.doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, value.doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul></div>',d.query.q&&(this.template='<div><div id="noresult" class="date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames"></h2><span class="date" data-listideas="bind:date, doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:setDesc, doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, rating"></span></div></li></ul></div>'),this.plugins.addAll({labels:new r(n.get("labels")),listideas:new r(c,{date:function v(v){v?this.innerHTML=s.formatDate(v):this.innerHTML=""},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(e){if(e===undefined){var t=this.getAttribute("data-listideas_id"),n=c.get(t).doc.votes||[];n.length===0?this.innerHTML="0":this.innerHTML=Math.round(n.reduce(function(e,t){return e+t})/n.length*100)/100}else this.innerHTML=Math.round(e*100)/100},setAvatar:function(e){var t,n},setVisibility:function(e){e==="public"?this.classList.add("public"):this.classList.remove("public")}}),listevent:new i(this)}),this.getModel=function(){return c},this.resetQuery=function(e){var t=new a;return d.query=e,c.unsync(),c.reset([]),c.sync(d.db,d.design,d.view,d.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){p&&this.hideActionBar(p)},this.showActionBar=function(e,t){var n=t.getAttribute("data-listideas_id"),r=document.getElementById("ideas");touchPoint=[e.pageX,e.pageY];if(!r.classList.contains("mosaic")){var i=new u("idea",t,c.get(n).id,this.hideActionBar),s=document.createDocumentFragment();i.place(s),t.appendChild(s),p=i,h=!0}},this.hideActionBar=function(e){var t=e.dom.parentElement;t.removeChild(t.lastChild),h=!1,p=null},this.init=function(){var e=new a;return c.sync(d.db,d.design,d.view,d.query).then(function(){e.fulfill()}),e}}return function(t,n,r,i){return f.prototype=new e,new f(t,n,r,i)}}),define("library/ideas/ideas",["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","Store","service/map","service/config","./idea-stack","./lists/idealist","Amy/Stack-plugin"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var c=new e,h,p,d,v=new s({search:""}),m=u.get("db"),g=u.get("observer"),y=new t(c),b=new a,w,E,S,x=new l;return c.template='<div id = "ideas"><div id="idea-list" class="list"><div class="header blue-light"><div class="option left" data-ideascontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, idealistheadertitle">My Ideas</span><div class="option right" data-ideasevent="listen: mousedown, plus"></div></div><div class="overflow" data-idealiststack="destination" data-ideascontrol="radio:li,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-search="bind: value, search" data-label="bind: placeholder, searchprivateplaceholder" data-ideasevent="listen: keypress, search"><div name="#list-date" class="tools-button bydate pushed" data-ideasevent="listen:mousedown,show"></div><div name="#list-rating" class="tools-button byrating" data-ideasevent="listen:mousedown,show"></div></div></div></div><div id="ideas-detail" class="details" data-ideaplace="place:details"></div></div>',c.plugins.addAll({idealiststack:x,search:new n(v),ideasevent:new i(c),ideaplace:new r({details:b}),ideascontrol:y}),c.place(o.get("ideas")),c.selectStart=function(e){var t=x.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-listideas_id");b.reset(t,n),v.set("search","")},c.displayHighlightedIdea=function(){var e=x.getStack().getCurrentScreen(),t=e.dom.querySelector(".list-item.selected")||e.dom.querySelector("li[data-listideas_id='0']");id=t.getAttribute("data-listideas_id"),t.classList.add("selected"),t.scrollIntoView(),y.init(t),b.reset(e.getModel(),id)},c.show=function(e,t){var n=h.querySelector(".bydate"),r=h.querySelector(".byrating"),i=t.getAttribute("name");i!==x.getStack().getCurrentName&&(x.getStack().show(i),i==="#list-date"?(r.classList.remove("pushed"),n.classList.add("pushed")):(r.classList.add("pushed"),n.classList.remove("pushed")),c.displayHighlightedIdea())},c.mosaic=function(){var e=document.getElementById("ideas-detail");h.classList.toggle("mosaic"),e.classList.contains("invisible")?(e.classList.remove("invisible"),b.reset(w.getModel(),0)):e.classList.add("invisible")},c.plus=function(){o.get("newidea-popup").classList.add("appear"),o.get("cache").classList.add("appear")},c.search=function(e,t){var n;e.keyCode===13&&(t.value===""?(p.setAttribute("style","display: inline-block;"),d.setAttribute("style","display: inline-block;"),x.getStack().show("#list-date"),p.classList.add("pushed"),d.classList.remove("pushed"),c.displayHighlightedIdea()):(n=u.get("user").get("_id").replace(/@/,"at"),c.searchIdea("users:"+n+" AND "+t.value)),t.blur())},c.searchIdea=function(e){p.setAttribute("style","display: none;"),d.setAttribute("style","display: none;"),S.resetQuery({q:e,sort:"\\creation_date<date>",include_docs:!0}).then(function(){x.getStack().show("#list-search"),S.getModel().getNbItems()>0?(v.set("search",S.getModel().get(0).doc.title),document.getElementById("noresult").classList.add("invisible"),c.displayHighlightedIdea()):document.getElementById("noresult").classList.remove("invisible")})},c.reset=function(){v.set("search",""),S.resetQuery({q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),E.resetQuery({startkey:'["'+u.get("user").get("_id")+'",{}]',endkey:'["'+u.get("user").get("_id")+'"]',descending:!0,include_docs:!0}),w.resetQuery({key:u.get("uid"),descending:!0,include_docs:!0}).then(function(){x.getStack().show("#list-date"),c.displayHighlightedIdea()})},h=c.dom,p=h.querySelector(".bydate"),d=h.querySelector(".byrating"),w=new f(m,"library","_view/ideas",{key:u.get("uid"),descending:!0}),S=new f("_fti/local/"+m,"indexedideas","userbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:30,include_docs:!0}),E=new f(m,"ideas","_view/privatebyvotes",{startkey:'["'+u.get("user").get("_id")+'",{}]',endkey:'["'+u.get("user").get("_id")+'"]',descending:!0}),x.getStack().add("#list-date",w),x.getStack().add("#list-rating",E),x.getStack().add("#list-search",S),E.init(),w.init().then(function(){x.getStack().show("#list-date"),c.displayHighlightedIdea()}),c}}),define("service/avatarlist",["OObject","Bind.plugin","Event.plugin","service/config","service/utils","Store"],function(e,t,n,r,i,s){function o(e){var i=new s([]),o,u=r.get("avatars");this.plugins.addAll({avatar:new t(i,{setAvatar:function(e){this.setAttribute("style","background-image: url('"+e+"');")}}),event:new n(this)}),this.template='<ul data-avatar="foreach"><li data-avatar="bind: setAvatar, img; bind: name, id"></li></ul>';for(o=0;o<e.length;o++)e[o]===r.get("user").get("_id")?i.alter("push",{id:e[o],img:r.get("avatar")}):u.get(e[o])?i.alter("push",{id:e[o],img:u.get(e[o])}):r.get("transport").request("GetAvatar",{id:e[o]},function(t){t.error||i.alter("push",{id:e[o],img:t})})}return function(t){return o.prototype=new e,new o(t)}}),define("library/sessions/sessions",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBView","CouchDBDocument","Store","service/utils","service/avatarlist","service/confirm","lib/spin.min","Promise"],function(e,t,n,r,s,o,u,a,f,l,c,h,p){return function(){var d=new e,v=new e,m=t.get("sessions"),g=new a,y=s.get("db"),b=s.get("transport"),w=s.get("user"),E=s.get("avatars"),S=s.get("labels"),x=new a({}),T="sbydate",N=[],C=[],k="",L=new o,A=(new h({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330})).spin(),O,M;return L.setTransport(b),d.plugins.addAll({label:new n(S),sort:new n(x,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(g,{setMode:function(e){switch(e){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');")}},formatDate:function(e){e&&e.length&&(this.innerHTML=f.formatDate(e))},formatIdeas:function(e){if(e&&e.length===1)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=S.get("noideayet")},setAvatars:function(e){var t,n;e&&(t=new l(e),n=document.createDocumentFragment(),node=this,t.place(n),node.hasChildNodes()?node.replaceChild(n,node.firstChild):node.appendChild(n))},setStatus:function(e){e==="completed"?this.innerHTML=S.get("completed"):this.innerHTML=S.get("inprogress")},setScore:function(e){e>=0?this.innerHTML=e:this.innerHTML=""},setSuffix:function(e){e===undefined||e===""||e===null?this.innerHTML=S.get("noscore"):this.innerHTML="ip"}}),sortevent:new r(d),sessionevent:new r(d)}),d.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen: dblclick, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>',d.sort=function(e,t){var n=t.getAttribute("id");x.get(n).selected?x.set(n,{selected:!0,descending:!x.get(n).descending}):(x.set(T,{selected:!1,descending:x.get(T).descending}),x.set(n,{selected:!0,descending:x.get(n).descending}),T=n),d.sortSessions(n)},d.sortSessions=function(e){var t;k?t=C:t=N;if(t.length)switch(e){case"sbytitle":f.sortByProperty(t,"title",x.get("sbytitle").descending);break;case"sbydate":f.sortByProperty(t,"date",x.get("sbydate").descending);break;case"sbyidea":f.sortByProperty(t,"idea",x.get("sbyidea").descending);break;case"sbyscore":f.sortByProperty(t,"score",x.get("sbyscore").descending)}g.reset(t)},d.acceptinput=function(e,t){t.removeAttribute("readonly")},d.search=function(e,t){var n=document.getElementById("sessionsearchresult");n.innerHTML="",e.keyCode===13&&(k=t.value,k===""?(d.sortSessions(T),g.reset(N)):(C=f.searchArray(N,k),n.innerHTML=S.get("foundlbl")+" "+C.length+" "+S.get("matchingsessions"),g.reset(C)))},d.displayActionBar=function(e,t){var n=t.getAttribute("data-sessions_id"),r=t.offsetHeight,i=g.get(n);t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+r+"px;height: "+r+"px;"),i.participants.length>1||i.participants[0]!=w.get("_id")||i.id===w.get("sessionInProgress").id?t.querySelector(".deletesession").setAttribute("style","display: none;"):t.querySelector(".deletesession").setAttribute("style","display: inline-block;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3)},d.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},d.press=function(e,t){var n=t.getAttribute("data-sessions_id");t.classList.add("pressed"),n&&A.spin(document.getElementById("sessionlistspinner"))},d.replay=function(e,t){var n=t.getAttribute("data-sessions_id"),r=g.get(n).id,i=g.get(n).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),A.stop(),s.get("observer").notify("replay-session",r,i)},d.deleteSession=function(e,t){var n=t.getAttribute("data-sessions_id"),r=g.get(n).id,i=function(e){var t=new u,n=new p;return t.setTransport(b),t.sync(y,e).then(function(){var e=t.get("replayIdeas")||[];e.forEach(function(e){var t=new u;t.setTransport(b),t.sync(y,e).then(function(){return t.set("sessionId",t.get("sessionId")+"_deleted"),t.set("sessionReplay",!1),t.upload()}).then(function(){t.unsync()},function(e){console.log(e)})}),b.request("cleanUpSession",r,function(e){e.err&&console.log(e.err),t.remove().then(function(){t.unsync(),n.fulfill()})})}),n},s,o=S.get("deletereplay"),a=function(e){e?(A.spin(document.getElementById("sessionlistspinner")),i(r).then(function(){A.stop(),s.close()})):s.close()};t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;"),g.get(n).replayIdeas&&g.get(n).replayIdeas.length?(A.stop(),s=new c(document.getElementById("session-list"),o,a),s.show()):i(r).then(function(){A.stop()})},d.resetSessionData=function(){N=[],L.loop(function(e,t){var n={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode,replayIdeas:e.value.replayIdeas};n.participants.push(e.value.initiator.id),n.usernames.push(e.value.initiator.username);for(j=0;j<e.value.participants.length;j++)n.participants.push(e.value.participants[j].id),n.usernames.push(e.value.participants[j].username);n.idea&&n.idea.length>1&&f.sortByProperty(n.idea,"title",!1),N.push(n)}),d.sortSessions("sbydate")},d.getMode=function(e){var t;return L.loop(function(n,r){n.id===e&&(t=n.value.mode)}),t},d.place(m),d.reset=function(){L.unsync(),L.reset(),g.reset([]),x.reset({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),T="sbydate",N=[],C=[],k="",L.sync(y,"library","_view/sessions",{key:s.get("uid"),descending:!0}).then(function(){d.resetSessionData()})},["added","deleted","updated"].forEach(function(e){L.watch(e,function(e,t){d.resetSessionData(),d.sortSessions(T)})}),d.reset(),d}}),define("library/decks/decklist/decklist",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","Promise","service/utils"],function(e,t,n,r,i,s,o,u,a){return function(t){var u=new e,f=n.get("labels"),l=n.get("user"),c=new s([]);return u.plugins.addAll({labels:new r(f),active:new r(l,{}),decks:new r(c,{setVersion:function(e){e?this.innerHTML=f.get("version")+e:this.innerHTML=""},setAuthor:function(e){e==="Taiaut"?(this.innerHTML="",this.setAttribute("style","background-image:url('img/logo.png');")):this.innerHTML=e},date:function(e){e?this.innerHTML=a.formatDate(e):this.innerHTML=""}}),decksevent:new i(u)}),u.template='<ul id="deck-list" data-decks="foreach"><li class="list-item"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>',u.reset=function(e){var n=e||null;c.reset([]),u.getDecks(t,n)},u.getModel=function(){return c},u.getDecks=function(e,t){var r=new o,i=[];switch(e){default:i=l.get("taiaut_decks").concat(l.get("custom_decks"))}r.setTransport(n.get("transport")),r.sync(n.get("db"),{keys:i}).then(function(){var e=l.get("lang"),n=[];r.loop(function(t,r){!t.doc.default_lang||t.doc.default_lang===e?n.push(t.doc):t.doc.translations&&t.doc.translations[e]?n.push(t.doc.translations[e]):n.push(t.doc)}),n.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),c.reset(n),t&&t("ok"),r.unsync()})},u.getImportableDecks=function(){var e=[];return c.loop(function(t,n){(t.public||t.created_by===l.get("_id")||t.sharedwith.indexOf(l.get("_id")))&&e.push(t)}),e},u.initSelected=function(e,t){var n=u.dom,r=n.querySelector(".list-item[data-decks_id='"+t+"']");e(r),r.classList.add("selected")},u.highlightDeck=function(e,t){var n=u.dom,r,i;return t===0?(r=n.querySelector(".list-item[data-decks_id='0']"),i=0):(c.loop(function(e,n){e._id===t&&(i=n)}),r=n.querySelector(".list-item[data-decks_id='"+i+"']")),e(r),r.classList.add("selected"),r.scrollIntoView(),i},u.init=function(e){u.reset(e)},l.watchValue("lang",function(){u.getDecks(t)}),u}}),define("library/decks/deckview/deckdetails",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","CouchDBDocument","CouchDBView","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(f){var l=new e,c=new i,h=new i({max:0}),p=new i([]),d=new u,v=t.get("user"),m=t.get("labels"),g,y=60,b=60,w=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=y/t,t=y):(t*=b/n,n=b),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},E=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=y,o=b,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},S=function(){var e="/upload",t=new FormData,n="deckpic",r=g;t.append("type",n),t.append("dir",c.get("_id")),t.append("filename","decklogo"),t.append("dataString",r),s.uploadFile(e,t,null,function(e){console.log(e)})};return d.setTransport(t.get("transport")),l.plugins.addAll({labels:new n(m),range:new n(h,{setCursorWidth:function(e){}}),cards:new n(p,{setStyle:function(e){e&&e==="null"?this.classList.add("invisible"):this.classList.remove("invisible")},formatTitle:function(e){var t,n=this;e&&(t=n.getAttribute("data-cards_id"),p.get(t).type&&p.get(t).type!==4?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var n,r=this;e&&e.search("img/decks/")>-1?this.setAttribute("style","background-image:url('"+e+"');"):e?(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');")})):this.setAttribute("style","background-image: none;")}}),deckdetails:new n(c,{formatDate:function(e){e?this.innerHTML=s.formatDate(e):this.innerHTML=""},setPic:function(e){var n,r,i=this;e===""?this.setAttribute("style","background-image:url('img/connect/graygroup.png');"):e==="img/logo.png"?this.setAttribute("style","background-image:url('img/logo.png');"):e==="decklogo"&&(dir="decks",json={dir:dir,filename:c.get("_id")},t.get("transport").request("GetFile",json,function(e){i.setAttribute("style","background-image: url('"+e+"');")})),c.get("created_by")===v.get("_id")&&i.querySelector("input").classList.remove("invisible")},edit:function(e){e===v.get("_id")?(this.setAttribute("contenteditable",!0),this.classList.add("editable")):(this.setAttribute("contenteditable",!1),this.classList.remove("editable"))}}),carouselevent:new r(l),editevent:new r(l)}),l.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: mousedown, editPic"><input class="invisible" type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: change, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" ></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"></div><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div>',l.displayCards=function(e){var t,n=[];p.reset([]);for(t=0;t<5;t++)d.get(e-2+t)?n[t]=d.get(e-2+t).value:n[t]={style:"null"};p.reset(n)},l.updateCards=function(e,t){l.displayCards(t.value)},l.displayButtons=function(e,t){l.dom.querySelector(".cancelmail").classList.remove("invisible"),l.dom.querySelector(".sendmail").classList.remove("invisible")},l.hideButtons=function(){l.dom.querySelector(".cancelmail").classList.add("invisible"),l.dom.querySelector(".sendmail").classList.add("invisible")},l.editPic=function(e,t){c.get("created_by")===v.get("_id")&&t.setAttribute("style","background-image: url('img/brainstorm/reload.png')")},l.changePic=function(e,t){var n=new FileReader,r=new Image,i=l.dom.querySelector(".decklogo"),s=(new a({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){E(w(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),g=e,l.displayButtons()})},300)},n.readAsDataURL(t.files[0])},l.press=function(e,t){t.classList.add("pressed")},l.cancel=function(e,t){var n=JSON.parse(c.toJSON());c.reset({}),c.reset(n),l.hideButtons(),t.classList.remove("pressed")},l.upload=function(e,n){var r=new o,i=l.dom.querySelector(".deckheader h2").innerHTML,s=l.dom.querySelector(".deckdescription").innerHTML,u=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30})).spin(n);n.classList.add("invisible"),r.setTransport(t.get("transport")),r.sync(t.get("db"),c.get("_id")).then(function(){var e=new Date;return g&&(S(),r.set("picture_file","decklogo")),r.set("title",i),r.set("description",s),r.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),r.upload()}).then(function(){f("updated",r.get("_id")),l.hideButtons(),n.classList.remove("pressed"),u.stop()}),g&&S()},l.reset=function(e){l.dom.querySelector(".cancelmail").classList.add("invisible"),l.dom.querySelector(".sendmail").classList.add("invisible"),g=null,c.reset(e),h.set("max",0),d.unsync(),d.sync(t.get("db"),"library","_view/cards",{key:'"'+c.get("_id")+'"'}).then(function(){h.set("max",d.getNbItems()-1),l.displayCards(0)})},l}}),define("service/cardpopup",["OObject","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i){function s(e){var s=new i,o=r.get("labels"),u,a={x:0,y:0},f='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatName, firstname"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><ul><li><span class="cd-agelbl"></span><span data-carddetails="bind:innerHTML, age"></span><span class="agesuffix" data-label="bind:innerHTML, agelbl"></span></li><li><span class="cd-locationlbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, location"></span></li><li><span class="cd-joblbl"></span><span class="cd-info" data-carddetails="bind: innerHTML, occupation.description"></span></li><li><span class="cd-familylbl"></span><span class="cd-info" data-carddetails="bind: setFamily, family"></span></li><li><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit"></span></li></ul></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl">Hobbies</span><p class = "charinfo" data-carddetails="bind:setLeisure, leisure_activities">hobbies</p><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "charinfo" data-carddetails="bind: setInterests, interests">Centers of interest</p><span class="contentTitle" data-label="bind: innerHTML, commentslbl">Comments</span><p class = "charinfo" data-carddetails="bind:setComments, comments"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',l='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark"> <span data-carddetails="bind: formatTitle, title"></span><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-picarea"><div class="cardpicture" data-carddetails="bind:setPic, picture_file"></div><div class="cardinfo"><p><span class="cd-creditslbl" data-label="bind:innerHTML, credits"></span><span class="cd-info" data-carddetails="bind:innerHTML, picture_credit">Picture credits</span><br/><span class="cd-sourcelbl" data-label="bind:innerHTML, source">Source : </span><span class="cd-info" data-carddetails="bind: setSources, sources"></span></div></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><p class = "dyknow" data-carddetails="bind:innerHTML,didYouKnow"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>',c='<div class="cardpopup" data-carddetails="bind:setPosition, position"><div class="card-detail"><div class="cd-header blue-dark story"> <div class="storytitlelbl" data-label="bind:innerHTML, storytitlelbl"></div><div class="storytitle"><span data-label="bind:innerHTML, cdtitlelbl"></span> <span data-carddetails="bind: formatTitle, title"></span></div><div class="close-popup" data-popupevent="listen:mousedown, close"></div></div><div class="cd-contentarea story"><span class="contentTitle" data-label="bind: innerHTML, scenariodesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,story"></p><span class="contentTitle" data-label="bind: innerHTML, soldesclbl"></span><p class = "dyknow" data-carddetails="bind:innerHTML,solution"></p></div></div><div class="leftcaret" data-carddetails="bind: setCaret, caret.left"></div><div class="rightcaret" data-carddetails="bind: setCaret, caret.right"></div></div>';this.plugins.addAll({label:new t(o),carddetails:new t(s,{setPosition:function(e){e&&this.setAttribute("style","left:"+e.x+"px; top:"+e.y+"px;")},setCaret:function(e){var t,n=s.get("position").y;n>340?t=240:t=60,e?this.setAttribute("style","display: inline-block; margin-top:"+t+"px;"):this.setAttribute("style","display: none;")},setPic:function(e){var t,n=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(t={dir:"cards",filename:e},r.get("transport").request("GetFile",t,function(e){n.setAttribute("style","background:white; background-image: url('"+e+"');")})):this.setAttribute("style","background-image: none;")},setSources:function(e){e&&e.length?e instanceof Array?this.innerHTML=e.join(", "):this.innerHTML=e:this.innerHTML=""},formatTitle:function(e){e&&(this.innerHTML=e.toUpperCase())},formatName:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase()+"  "+s.get("lastname").toUpperCase())},setFamily:function(e){var t=e.couple,n=e.children,r,i;t===0?r=o.get("singlelbl"):t===1?r=o.get("marriedlbl"):t===2?r=o.get("divorcedlbl"):t===3&&(r=o.get("widowlbl")),n===0?i="":(s.get("age")<20?n===1?i=n+o.get("onesiblinglbl"):i=n+o.get("siblingslbl"):n===1?i=n+o.get("onechildlbl"):i=n+o.get("childrenlbl"),i=", "+i),this.innerHTML=r+i},setLeisure:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)e[n].comment?t+="<li>"+e[n].name+" ("+e[n].comment+")</li>":t+="<li>"+e[n].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},setInterests:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)e[n].comment?t+="<li>"+e[n].name+" ("+e[n].comment+")</li>":t+="<li>"+e[n].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},setComments:function(e){var t="<ul>",n;if(e&&e.length){for(n=0;n<e.length;n++)t+="<li>"+e[n]+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""}}),popupevent:new n(this)}),this.close=function(t,n){u.classList.add("invisible"),e()},this.reset=function(e,t,n,r){u=r,this.template="",typeof e=="string"?s.reset(JSON.parse(e)):s.reset(e),s.set("position",t),n==="left"?s.set("caret",{left:!0,right:!1}):s.set("caret",{left:!1,right:!0}),s.get("type")===1?this.template=f:s.get("type")===5?this.template=c:this.template=l,this.render(),this.place(u),u.classList.remove("invisible")}}return function(t){return s.prototype=new e,new s(t)}}),define("library/decks/deckview/cardlist",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBBulkDocuments","CouchDBDocument","Store","service/cardpopup","Promise"],function(e,t,n,r,i,s,o,u,a){return function(f,l,c){var h=new e,p=new o([]),d=new o([]),v=new o({currentPage:0,nbPages:0}),m,g=t.get("labels"),y=t.get("user"),b=null,w=null;return h.plugins.addAll({pagination:new n(v,{setPage:function(e){var t=e+1;v.get("nbPages")>1?this.innerHTML=g.get("page")+t+" / "+v.get("nbPages"):this.innerHTML=""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<v.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(d,{formatTitle:function(e){e?(this.classList.remove("newcard"),f!=="techno"?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;"))):this.classList.add("newcard")},setPic:function(e){var n,r,i=this;if(e&&e.search("img/decks/")>-1)this.setAttribute("style","background-image:url('"+e+"');");else if(e)n="cards",r={dir:n,filename:e},t.get("transport").request("GetFile",r,function(e){i.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});else switch(f){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}),cardlistevent:new r(h)}),h.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:mousedown, setStart; listen:dblclick, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn" data-cardlistevent="listen: mousedown, press; listen:mouseup, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: mousedown, press; listen:mouseup, deleteCard"></div></div></li></ul></div></div>',h.reset=function(e){w=null,b=e._id,h.getCardList(e.content[f])},h.getCardList=function(e){var n=new i,r=e;e[0]==="newcard"&&(r=e.slice(1,e.length)),r.length?(n.setTransport(t.get("transport")),n.sync(t.get("db"),{keys:r}).then(function(){e[0]==="newcard"?p.reset([{_id:"newcard",title:"",picture_file:""}]):p.reset([]),n.loop(function(e,t){p.alter("push",e.doc)}),v.set("nbPages",Math.ceil(p.getNbItems()/12)),h.displayPage(0),n.unsync()})):(p.reset([{_id:"newcard",title:"",picture_file:""}]),v.set("nbPages",1),h.displayPage(0))},h.displayPage=function(e){var t,n=p.getNbItems()-12*e;v.set("currentPage",e),d.reset([]);for(t=0;t<n;t++)d.alter("push",p.get(e*12+t))},h.removeCard=function(e){var n=new s,r=new s;n.setTransport(t.get("transport")),r.setTransport(t.get("transport")),n.sync(t.get("db"),b).then(function(){var t=n.get("content"),r=t[f];return r.splice(r.indexOf(e),1),t[f]=r,n.set("content",t),n.upload()}).then(function(){return c("updated",b,f),n.unsync(),r.sync(t.get("db"),e)}).then(function(){var e=r.get("deck"),n=new a,i,s=r.get("picture_file");return e.splice(b,1),e.length?(r.set("deck",e),r.upload().then(function(){n.fulfill()})):(s.search("img/decks")===-1&&(i={type:"card",file:s},t.get("transport").request("DeleteAttachment",i,function(e){e!=="ok"&&console.log(e)})),r.remove().then(function(){n.fulfill()})),n}).then(function(){console.log("card removal operation completed")})},h.push=function(e,t){t.classList.add("invisible"),e.stopPropagation()},h.press=function(e,t){t.classList.add("pressed")},h.previousPage=function(e,t){h.displayPrevious()},h.nextPage=function(e,t){h.displayNext()},h.displayPrevious=function(){var e=v.get("currentPage");e>0&&h.displayPage(e-1)},h.displayNext=function(){var e=v.get("currentPage");e<v.get("nbPages")-1&&h.displayPage(e+1)},h.changePage=function(e,t){var n=[e.pageX,e.pageY];n[0]>(document.width+301)/2?h.displayNext():h.displayPrevious()},h.highlight=function(e,t){w!==null&&document.querySelector("li[data-cards_id='"+w+"']").classList.remove("highlighted"),w=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},h.zoom=function(e,t){var n=parseInt(t.getAttribute("data-cards_id"),10)+12*v.get("currentPage");p.get(n)._id==="newcard"?l("newcard",f):(h.setPopup(n),p.get(n).created_by===y.get("_id")&&t.querySelector(".cardbtnbar").classList.remove("invisible"))},h.editCard=function(e,t){var n=parseInt(t.getAttribute("data-cards_id"),10)+12*v.get("currentPage");e.stopPropagation(),m.close(),t.parentNode.classList.add("invisible"),l(p.get(n)._id,f)},h.deleteCard=function(e,t){var n=parseInt(t.getAttribute("data-cards_id"),10)+12*v.get("currentPage");e.stopPropagation(),m.close(),t.parentNode.classList.add("invisible"),h.removeCard(p.get(n)._id)},h.setPopup=function(e){var t={x:0,y:0},n="";e%=12;switch(e){case 1:t.x=304,t.y=157,n="left";break;case 2:t.x=23,t.y=157,n="right";break;case 3:t.x=170,t.y=157,n="right";break;case 4:t.x=157,t.y=339,n="left";break;case 5:t.x=304,t.y=339,n="left";break;case 6:t.x=23,t.y=339,n="right";break;case 7:t.x=170,t.y=339,n="right";break;case 8:t.x=157,t.y=350,n="left";break;case 9:t.x=304,t.y=350,n="left";break;case 10:t.x=23,t.y=350,n="right";break;case 11:t.x=170,t.y=350,n="right";break;default:t.x=157,t.y=157,n="left"}m.reset(p.get(e),t,n,document.getElementById("cardlist-popup"))},h.closePopup=function(){h.dom.querySelector("li[data-cards_id='"+w+"']").classList.remove("highlighted"),h.dom.querySelector("li[data-cards_id='"+w+"']").querySelector(".cardbtnbar").classList.add("invisible"),w=null},m=new u(h.closePopup),h}}),define("library/decks/deckview/cardeditor/editchar",["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(a,f){var l=new e,c=t.get("user"),h=t.get("labels"),p={_id:"",default_lang:c.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:c.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},d=new n,v={},m=new s({error:""}),g,y=87,b=87,w=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=y/t,t=y):(t*=b/n,n=b),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},E=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=y,o=b,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},S=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=g;t.append("type",n),t.append("dir",r),t.append("filename",d.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){e.response!=="ok"&&console.log(e)})},x=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return d.setTransport(t.get("transport")),l.plugins.addAll({label:new r(h),model:new r(d,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=h.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))},setAge:function(e){!e&&e!==0&&(this.innerHTML="",this.setAttribute("placeholder","age"))},setCity:function(e){var t="";e&&e.length?(t=e.split(",")[0].trim(),this.value=t):this.value=""},setCountry:function(e){var t="";e&&e.length?(t=e.split(",").slice(1,e.length).join().trim(),this.value=t):this.value=""},setFamilyStatus:function(e){if(e||e===0)this.selectedIndex=e},setChildren:function(e){if(e||e===0)this.selectedIndex=e},setChildrenlbl:function(e){e&&e==="1"?this.innerHTML=h.get("onechildlbl"):this.innerHTML=h.get("childrenlbl")},setSituation:function(e){e&&e.length&&(this.selectedIndex=e[0])},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setComment:function(e){var t=this,n=t.getAttribute("name");[0,1].forEach(function(r){e&&e[r]&&n.search(r)>0&&(t.value=e[r])})}}),error:new r(m),editevent:new i(l)}),l.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl"></div></span><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl"></div></div></div>',l.reset=function(e,n){var r=new Date;g=null,m.set("error",""),v={},d.reset(),n==="newcard"?(d.reset(p),d.set("_id","C:"+r.getTime()),d.set("created_on",[r.getFullYear(),r.getMonth(),r.getDate()]),d.set("deck",[e])):d.sync(t.get("db"),n).then(function(){console.log("card synchronized :",d.toJSON())})},l.clearDefault=function(e,t){var n=t.getAttribute("name");d.get(n)===""&&(t.innerHTML="")},l.updateTitle=function(e,t){d.set("title",t.innerHTML)},l.selectpress=function(e,t){t.value=""},l.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},l.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=l.dom.querySelector(".cardpicture"),s=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){E(w(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),g=e})},300)},n.readAsDataURL(t.files[0])},l.updateField=function(e,t){var n=t.getAttribute("name"),r,i,s;v[n]=t.value},l.updateLocation=function(e,t){var n=d.get("location"),r,i;r=l.dom.querySelector("input[name='city']").value||"",i=l.dom.querySelector("input[name='country']").value||"",r&&i?n=r+", "+i:n=r+i,v.location=n},l.updateFamily=function(e,t){var n=t.getAttribute("name"),r=d.get("family");r[n]=t.selectedIndex,v.family=r},l.updateJob=function(e,t){var n=d.get("occupation"),r=t.getAttribute("name"),i;switch(r){case"situation":n.details[0]=t.selectedIndex;break;case"job":n.details[1]=t.value;break;case"organization":n.details[2]=t.value;break;default:n.description=t.value}v.occupation=n},l.updateLeisureName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=d.get("leisure_activities");i[r].name=t.value,v.leisure_activities=i},l.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=d.get("leisure_activities");i[r].comment=t.value,v.leisure_activities=i},l.updateInterestName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=d.get("interests");i[r].name=t.value,v.interests=i},l.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=d.get("interests");i[r].comment=t.value,v.interests=i},l.updateComments=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=d.get("comments");i[r]=t.value,v.comments=i},l.press=function(e,t){t.classList.add("pressed")},l.cancel=function(e,t){f()},l.upload=function(e,n){var r=new Date,i=d.get("firstname"),s=d.get("lastname");n.classList.remove("pressed"),m.set("error",""),x.spin(n),d.get("title")||(i&&s?d.set("title",i+" "+s):(i||s)&&d.set("title",i+s)),d.get("title")||m.set("error",h.get("titlerequired")),m.get("error")?x.stop():d.get("_rev")?(d.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),l.uploadCard(n)):d.sync(t.get("db"),d.get("_id")).then(function(){console.log("new card created : ",d.toJSON()),l.uploadCard()})},l.uploadCard=function(e){var t;g&&(S(),d.set("picture_file",d.get("_id")));if(v!=={})for(t in v)d.set(t,v[t]);d.upload().then(function(){return console.log("card upload successful :",d.get("_rev")),a(d.get("type"),d.get("_id"))}).then(function(){x.stop(),f(),d.unsync(),d.reset({})})},MODEL=d,l}}),define("library/decks/deckview/cardeditor/editcard",["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(a,f){var l=new e,c=t.get("user"),h=t.get("labels"),p={_id:"",default_lang:c.get("lang"),title:"",didYouKnow:"",deck:[],category:"",coefficient:1,sources:[],created_by:c.get("_id"),created_on:[],picture_credit:"",type:null,picture_file:""},d=new n,v=new s({error:""}),m,g=87,y=87,b=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=g/t,t=g):(t*=y/n,n=y),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},w=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=g,o=y,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},E=function(){var e="/upload",t=new FormData,n="cardpic",r="cards",i=m;t.append("type",n),t.append("dir",r),t.append("filename",d.get("_id")),t.append("dataString",i),o.uploadFile(e,t,null,function(e){e.response!=="ok"&&console.log(e)})},S=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28})).spin();return d.setTransport(t.get("transport")),l.plugins.addAll({label:new r(h),model:new r(d,{setTitle:function(e){e&&e!==""&&e!=="<br>"?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=h.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},formatTitle:function(e){switch(e){case 2:this.setAttribute("style","background: #5f8f28");break;case 3:this.setAttribute("style","background: #bd262c");break;case 4:this.setAttribute("style","background: #f27b3d");break;default:}},setSources:function(e){e&&e.length?e instanceof Array?this.innerHTML=e.join(", "):this.innerHTML=e:this.innerHTML=""},setPic:function(e){var n,r=this,i;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",r.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){r.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))}}),error:new r(v),editevent:new i(l)}),l.template='<div class="cardpopup editcard"><div class="card-detail"><div class="cd-header blue-dark" data-model="bind:formatTitle, type"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class ="cardpicture" data-model="bind:setPic, picture_file"></div><div class="picinfo"><span class="cd-creditslbl"data-label="bind:innerHTML, credits"></span><input type="text" class="input editcredit" data-label="bind: placeholder, picturecredit" data-model="bind:value, picture_credit"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editevent="listen:mousedown, press; listen:mouseup, release"></div></span></div><div class="cd-contentarea"><span class="contentTitle" data-label="bind: innerHTML, dyknow"></span><textarea class="input enterdyknow" data-label="bind: placeholder, enterdyknow" data-model="bind:value,didYouKnow"></textarea><span class="cd-sourcelbl" data-label="bind:innerHTML, source"></span><textarea class="input entersources" data-label="bind: placeholder, dyknowsources" data-model="bind: value, sources"></textarea></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl">Save</div></div></div>',l.reset=function(e,n,r){var i=new Date;m=null,v.set("error",""),d.reset(),n==="newcard"?(d.reset(p),d.set("_id","C:"+i.getTime()),d.set("created_on",[i.getFullYear(),i.getMonth(),i.getDate()]),d.set("deck",[e]),r==="contexts"&&(d.set("type",2),d.set("picture_file","img/decks/context.png")),r==="problems"&&(d.set("type",3),d.set("picture_file","img/decks/problem.png")),r==="techno"&&(d.set("type",4),d.set("picture_file","img/decks/techno.png"))):d.sync(t.get("db"),n).then(function(){console.log("card synchronized :",d.toJSON())})},l.changeType=function(e){switch(e){case 1:d.set("type",2),d.set("picture_file","img/decks/context.png");break;case 2:d.set("type",3),d.set("picture_file","img/decks/problem.png");break;case 3:d.set("type",4),d.set("picture_file","img/decks/technology.png");break;default:d.set("type",2),d.set("picture_file","img/decks/context.png")}},l.clearDefault=function(e,t){var n=t.getAttribute("name");d.get(n)===""&&(t.innerHTML="")},l.updateTitle=function(e,t){d.set("title",t.innerHTML)},l.selectpress=function(e,t){t.value=""},l.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},l.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=l.dom.querySelector(".cardpicture"),s=(new u({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){w(b(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),m=e})},300)},n.readAsDataURL(t.files[0])},l.press=function(e,t){t.classList.add("pressed")},l.cancel=function(e,t){t.classList.remove("pressed"),f(),d.unsync(),d.reset({})},l.upload=function(e,n){var r=new Date;n.classList.remove("pressed"),v.set("error",""),S.spin(n),(!d.get("title")||d.get("title")==="<br>")&&v.set("error",h.get("titlerequired")),v.get("error")?S.stop():d.get("_rev")?(d.set("last_modified",[r.getFullYear(),r.getMonth(),r.getDate()]),l.uploadCard(n)):d.sync(t.get("db"),d.get("_id")).then(function(){l.uploadCard()})},l.uploadCard=function(e){m&&(E(),d.set("picture_file",d.get("_id"))),d.upload().then(function(){return a(d.get("type"),d.get("_id"))}).then(function(){S.stop(),f(),d.unsync(),d.reset({})})},l}}),define("library/decks/deckview/cardeditor/importcard",["OObject","service/config","Bind.plugin","Event.plugin","Store"],function(e,t,n,r,i){return function(i,s){var o=new e,u=t.get("labels");return o.template='<div class="importcard"><div class="cancelmail" data-importevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-importevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl">Save</div></div>',o.plugins.addAll({label:new n(u),importevent:new r(o)}),o.changeType=function(e){console.log("importcard change type : ",e)},o.cancel=function(e,t){s()},o}}),define("library/decks/deckview/cardeditor/newcard",["OObject","Bind.plugin","Event.plugin","Amy/Stack-plugin","service/config","Store","CouchDBDocument","./editchar","./editcard","./importcard","Promise"],function(e,t,n,r,i,s,o,u,a,f,l){return function(c){var h=new e,p=new r,d=new s;return cardCDB=new o,labels=i.get("labels"),user=i.get("user"),close=function(){document.getElementById("card_creation").classList.add("invisible")},updateDeck=function(e,t){var n=new l,r=d.get("deckId"),s=new o,u="characters";console.log("deck update function in newcard : ",e,t,r);switch(e){case 1:u="characters";break;case 2:u="contexts";break;case 3:u="problems";break;case 4:u="techno";break;default:console.log("no type detected")}return s.setTransport(i.get("transport")),s.sync(i.get("db"),r).then(function(){var e=new Date,n=s.get("content"),r=n[u];return r.indexOf(t)<0&&(r.push(t),n[u]=r,s.set("content",n)),s.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),s.upload()}).then(function(){s.unsync(),c("updated",r,e),n.fulfill()}),n},editCard=new a(updateDeck,close),editChar=new u(updateDeck,close),importCard=new f(updateDeck,close),h.template='<div id="card_creation" class="invisible"><div class="header blue-dark" data-label="bind: innerHTML, cardeditor"></div><div class="create_header"><label data-label="bind:innerHTML, createnew"></label><select class="changetype" data-setup="bind: selectedIndex, type" data-newcardevent="listen: change, changeType"><option data-label="bind:innerHTML, char"></option><option data-label="bind:innerHTML, context"></option><option data-label="bind:innerHTML, problem"></option><option data-label="bind:innerHTML, techno"></option></select></div><div class="createcontentstack" data-newcardcontentstack="destination"></div></div>',h.plugins.addAll({label:new t(labels),setup:new t(d),newcardcontentstack:p,newcardevent:new n(h)}),h.close=close,h.reset=function(e,t,n,r){document.getElementById("card_creation").classList.remove("invisible"),console.log(e,t,n,r),d.reset({deckId:n,title:r,type:["characters","contexts","problems","techno"].indexOf(t)}),t==="characters"?(editChar.reset(n,e),p.getStack().show("editchar")):(editCard.reset(n,e,t),p.getStack().show("editcard"))},h.press=function(e,t){t.classList.add("pressed")},h.import=function(e,t){t.classList.remove("pressed"),p.getStack().show("importcard")},h.changeType=function(e,t){var n=t.selectedIndex;p.getStack().getCurrentName()==="importcard"?importCard.changeType(n):n===0?(editChar.reset(d.get("deckId"),"newcard"),p.getStack().show("editchar")):(editCard.reset(d.get("deckId"),"newcard",d.get("type")),p.getStack().show("editcard"),editCard.changeType(n))},h.init=function(){p.getStack().add("editchar",editChar),p.getStack().add("editcard",editCard),p.getStack().add("importcard",importCard)},h.init(),CSTACK=p,h}}),define("library/decks/deckview/deckview",["OObject","Bind.plugin","Event.plugin","Place.plugin","Amy/Stack-plugin","Store","service/map","./deckdetails","./cardlist","service/config","./cardeditor/newcard"],function(e,t,n,r,i,s,o,u,a,f,l){return function(o){var f=new e,c=new l(o),h=new s([{name:"characters",active:!1,count:0},{name:"contexts",active:!1,count:0},{name:"problems",active:!1,count:0},{name:"techno",active:!1,count:0}]),p=new i,d="",v="";return f.plugins.addAll({cardmenu:new t(h,{setClass:function(e){this.classList.add(e)},setActive:function(e){e?this.classList.add("active"):this.classList.remove("active")}}),place:new r({newCard:c}),deckviewstack:p,deckviewevent:new n(f)}),f.template='<div><div data-place="place: newCard"></div><ul class="card-menu" data-cardmenu="foreach"><li><div class="card-type" data-cardmenu = "bind: setClass, name; bind:setActive, active" data-deckviewevent="listen: mousedown, viewCards"></div><div class="card-count" data-cardmenu="bind:innerHTML, count"></div></li></li></ul><div id="deckviewstack" data-deckviewstack="destination"></div></div>',f.viewCards=function(e,t){var n=t.getAttribute("data-cardmenu_id");h.loop(function(e,t){t===parseInt(n)?h.update(t,"active",!0):h.update(t,"active",!1)}),p.getStack().show(h.get(n).name)},f.editCard=function(e,t){c.reset(e,t,v,d)},f.hideEditView=function(){c.close()},f.reset=function(e,t){["details","characters","contexts","problems","techno"].forEach(function(t){p.getStack().get(t).reset(e)}),v=e._id,d=e.title,h.reset([]),["characters","contexts","problems","techno"].forEach(function(t){e.content[t][0]==="newcard"?h.alter("push",{name:t,active:!1,count:e.content[t].length-1}):h.alter("push",{name:t,active:!1,count:e.content[t].length})}),t?p.getStack().show(t):p.getStack().show("details")},f.init=function(){p.getStack().add("details",new u(o)),p.getStack().add("characters",new a("characters",f.editCard,o)),p.getStack().add("contexts",new a("contexts",f.editCard,o)),p.getStack().add("problems",new a("problems",f.editCard,o)),p.getStack().add("techno",new a("techno",f.editCard,o))},f}}),define("library/decks/newdeck",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min","service/utils"],function(e,t,n,r,i,s,o,u){return function(t){var a=new e,f=new s({}),l=i.get("user"),c=i.get("transport"),h=i.get("labels"),p=new s({error:""}),d=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),v,m=60,g=60,y=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=m/t,t=m):(t*=g/n,n=g),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},b=function(e,t){var n=new Image,r=document.createElement("canvas"),i=r.getContext("2d"),s=m,o=g,u,a;n.src=e,setTimeout(function(){r.width=s,r.height=o,u=Math.floor(Math.max(0,(n.width-s)/2)),a=Math.floor(Math.max(0,(n.height-o)/2)),i.drawImage(n,u,a,s,o,0,0,s,o),t(r.toDataURL("image/png"))},300)},w=function(){var e="/upload",t=new FormData,n="deckpic",r="decks",i=v;t.append("type",n),t.append("dir",r),t.append("filename",f.get("_id")),t.append("dataString",i),u.uploadFile(e,t,null,function(e){console.log(e)})};return f.setTransport(i.get("transport")),a.plugins.addAll({newdeck:new n(f),labels:new n(h),errormsg:new n(p,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new r(a)}),a.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:mousedown, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend data-labels="bind: innerHTML, setdecklogo"></legend><div class="deckicon"><div class="decklogo"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-newdeckevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-labels="bind:innerHTML, importlbl" data-newdeckevent="listen: mousedown, press; listen: mouseup, release"></div></span></div><div class="newidea-footer"><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>',a.reset=function(e){f.reset({_id:"",type:9,description:"",default_lang:l.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:l.get("_id"),author:l.get("username"),"public":!1,sharedwith:[]}),v=null},a.show=function(){a.reset(),document.querySelector("#library .cache").classList.add("appear"),a.dom.classList.add("appear")},a.press=function(e,t){t.classList.add("pressed")},a.selectpress=function(e,t){t.value=""},a.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},a.uploadnDisplay=function(e,t){var n=new FileReader,r=new Image,i=a.dom.querySelector(".decklogo"),s=(new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10})).spin();i.setAttribute("style","background-image: none;"),s.spin(i),n.onload=function(e){r.src=e.target.result,setTimeout(function(){b(y(r),function(e){i.setAttribute("style","background-image: url('"+e+"')"),s.stop(),v=e,f.set("picture_file","decklogo")})},300)},n.readAsDataURL(t.files[0])},a.closePopup=function(){a.dom.classList.remove("appear"),document.querySelector("#library .cache").classList.remove("appear"),f.unsync(),a.reset(),p.reset({error:""})},a.resetError=function(e,t){var n;t.scrollTop=99999,p.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",p.get("error")===n&&t.value&&p.set("error",""))},a.cancel=function(e,t){a.closePopup()},a.upload=function(e,n){var r=new Date,s="D:"+r.getTime();n.classList.remove("pressed"),f.get("title")?f.get("description")||p.set("error","nodesc"):p.set("error","notitle"),!p.get("error")&&!f.get("_id")&&(n.classList.add("invisible"),d.spin(n.parentNode),f.set("_id",s),f.set("date",[r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds()]),f.sync(i.get("db"),s).then(function(){return f.get("picture_file")&&w(),f.upload()}).then(function(){t("new",s);var e=l.get("custom_decks")||[];return e.unshift(s),l.set("custom_decks",e),l.upload()}).then(function(){d.stop(),n.classList.remove("invisible"),a.closePopup()}))},a.reset(),a}}),define("library/decks/decks",["OObject","Bind.plugin","Amy/Stack-plugin","Amy/Control-plugin","Event.plugin","Place.plugin","service/config","service/map","./decklist/decklist","./deckview/deckview","./newdeck","CouchDBDocument"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(){var u=new e,c=new r(u),h=o.get("user"),p,d=new n,v,m,g,y=function(e){var t=d.getStack().getCurrentScreen(),n=t.getModel();p=t.highlightDeck(c.init,e),S.reset(n.get(p))},b=!1,w,E=function(e,t,n){var r=d.getStack().getCurrentScreen();w=t,e==="new"&&(b=!0,w=t),e==="updated"&&r.reset(function(e){e&&(r.highlightDeck(c.init,t),S.reset(r.getModel().get(p),n))})},S=new f(E),x=new l(E);return u.plugins.addAll({label:new t(o.get("labels")),deckliststack:d,decksevent:new i(u),deckplace:new s({deckView:S,newDeck:x}),deckscontrol:c}),u.template='<div id="decks"><div id="decklist" class="list"><div class="header blue-light"><div class="option left" data-deckscontrol=""></div><span data-label="bind: innerHTML, decklistheadertitle"></span><div class="option right" data-decksevent="listen: mousedown, plus"></div></div><div class="overflow" data-deckliststack="destination" data-deckscontrol="radio:li,selected,mousedown,selectStart"></div></div><div id="deckview" data-deckplace="place:deckView" class="details"></div><div data-deckplace="place:newDeck"></div></div>',u.reset=function(){v.reset(function(e){e&&(d.getStack().show("ideafy"),v.highlightDeck(c.init,0),S.reset(v.getModel().get(0)),p=0)})},u.displayDeck=y,u.init=function(){v=new a("all_decks"),d.getStack().add("ideafy",v),v.init(function(e){e&&(d.getStack().show("ideafy"),S.init(),v.highlightDeck(c.init,0),S.reset(v.getModel().get(0)),p=0)})},u.selectStart=function(e){var t=d.getStack().getCurrentScreen().getModel(),n=e.target.getAttribute("data-decks_id");S.reset(t.get(n)),p=n},u.plus=function(e,t){x.show()},u.init(),h.watchValue("lang",function(){var e=d.getStack().getCurrentName(),t,n=d.getStack().getCurrentScreen();switch(e){case"taiaut":t="taiaut_decks";case"custom":t="custom_decks";break;default:t="all_decks"}n.getDecks(t,function(e){e&&(n.initSelected(c.init,p),S.reset(n.getModel().get(p)))})}),h.watchValue("custom_decks",function(){v.reset(function(e){e&&b&&y(w),b=!1})}),h.watchValue("taiaut_decks",function(){v.reset()}),o.get("observer").watch("getImportableDecks",function(e){e(v.getImportableDecks())}),u}}),define("library/library",["OObject","Amy/Stack-plugin","service/map","service/submenu","./ideas/ideas","./sessions/sessions","./decks/decks","service/config"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=new t,l,c,h,p=u.get("observer"),d=function(e){f.getStack().show(e)},v;return a.plugins.add("librarystack",f),a.template='<div id="library"><div class="cache"></div><div id="library-menu"></div><div class="stack" data-librarystack="destination"></div></div>',a.place(n.get("library")),a.showMenu=function(){v.toggleActive(!0)},a.hideMenu=function(){v.toggleActive(!1)},a.reset=function(){l.reset(),h.reset(),c.reset(),v.reset(),f.getStack().show("#ideas")},v=new r(a.dom.querySelector("#library-menu"),d),v.toggleActive(!1),l=new i,c=new s,h=new o,f.getStack().add("#ideas",l),f.getStack().add("#sessions",c),f.getStack().add("#decks",h),f.getStack().show("#ideas"),p.watch("display-doc",function(e,t){switch(t){case 6:var n=f.getStack().get("#ideas");n.searchIdea(e.substr(2)),f.getStack().getCurrentScreen()!==n&&f.getStack().show("#ideas");break;default:}}),a}}),define("brainstorm/ideafy-menu",["OObject","service/map","Store","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r,i,s){return function(o){var u=new e,a=s.get("user"),f=s.get("labels"),l=new n,c={name:"continue",active:!0,selected:!1,label:f.get("continuesession"),bg:"continuesession.png",bgselected:"continueactive.png"},h="";return u.plugins.addAll({ideafymenu:new r(l,{setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")},setBg:function(e){var t=this.getAttribute("data-ideafymenu_id");e?this.setAttribute("style","background-image:url('img/brainstorm/"+l.get(t).bgselected+"');color:white;"):this.setAttribute("style","background-image:url('img/brainstorm/"+l.get(t).bg+"');color:#4D4D4D;")}}),labels:new r(f),ideafyevent:new i(this)}),u.template='<div id="ideafy-menu"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, brainstormchoosemode"></div><ul class="menu" data-ideafymenu = "foreach"><li data-ideafymenu="bind:innerHTML, label; bind: setActive, active; bind:setBg, selected" data-ideafyevent="listen:mousedown, press; listen: mouseup, start"></li></ul></div>',u.place(t.get("ideafy-menu")),this.press=function(e,t){var n=t.getAttribute("data-ideafymenu_id");l.update(n,"selected",!0),t.classList.add("pressed")},this.start=function(e,t){var n=t.getAttribute("data-ideafymenu_id");l.get(n).name==="continue"?o("continue",h):o(l.get(n).name),t.classList.remove("pressed"),l.update(n,"selected",!1)},u.addContinue=function(e){var t=JSON.parse(l.toJSON());l.get(0).name!=="continue"&&(t.unshift(c),l.reset(t)),h=e},u.removeContinue=function(){var e=JSON.parse(l.toJSON());e[0].name==="continue"&&e.splice(0,1),l.reset(e),h=""},u.reset=function(){l.reset([{name:"quick",active:!0,selected:!1,label:f.get("quickbmode"),bg:"quick.png",bgselected:"quickactive.png"},{name:"musession",active:!0,selected:!1,label:f.get("musession"),bg:"multiuser.png",bgselected:"multiuseractive.png"},{name:"customb",active:!1,selected:!1,label:f.get("customsession"),bg:"customb.png",bgselected:"custombactive.png"},{name:"tutorial",active:!0,selected:!1,label:f.get("ideafytutorial"),bg:"tutorial.png",bgselected:"tutorialactive.png"}]),a.get("sessionInProgress")&&a.get("sessionInProgress").id&&u.addContinue(a.get("sessionInProgress"))},u.reset(),a.watchValue("sessionInProgress",function(e){e.id&&e.type?u.addContinue(e):u.removeContinue()}),a.watchValue("lang",function(){var e=s.get("labels");l.loop(function(t,n){switch(t.name){case"continue":l.update(n,"label",e.get("continuesession"));break;case"quick":l.update(n,"label",e.get("quickbmode"));break;case"musession":l.update(n,"label",e.get("musession"));break;case"customb":l.update(n,"label",e.get("customsession"));break;case"tutorial":l.update(n,"label",e.get("ideafytutorial"))}})}),u}}),define("service/help",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,n,r,i,s){return new function(){var o=new e,u=i.get("labels"),a=new s({html:""});return o.plugins.addAll({help:new n(a),helpevent:new r(o)}),o.template='<div><div class="help-doctor"></div><div class="close-help" data-helpevent="listen:mousedown, closeHelp"></div><div class="help-screen" data-help="bind:innerHTML,html"></div></div>',o.render(),o.place(t.get("help-popup")),o.setContent=function(e){a.set("html",u.get(e))},o.closeHelp=function(e,t){document.getElementById("help-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear")},o}}),define("brainstorm/quickb/quickstart",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","Promise"],function(e,t,n,r,i,s,o,u){return function(a,f,l,c){var h=new e,p=i.get("user"),d=i.get("db"),v=i.get("labels"),m="step",g=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return h.plugins.addAll({labels:new n(v),model:new n(a,{setTitle:function(e){var t=new Date;e&&e.username&&this.setAttribute("placeholder",v.get("quickstarttitleplaceholderpre")+e.username+v.get("quickstarttitleplaceholderpost"))}}),quickstartevent:new r(h)}),h.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:mousedown, help"></div><form class="quickstart-form"><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: mousedown, press; listen:mouseup, next"></div></form><div>',h.place(t.get("quickstart")),h.press=function(e,t){t.classList.add("pressed")},h.next=function(e,t){g.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),m==="step"?(m="screen",a.get("title")===""&&a.set("title",v.get("quickstarttitleplaceholderpre")+a.get("initiator").username+v.get("quickstarttitleplaceholderpost")),a.set("lang",p.get("lang")),a.set("_id","S:QUICK:"+a.get("startTime")),a.sync(d,a.get("_id")).then(function(){return p.set("sessionInProgress",{id:a.get("_id"),type:"quick"}),p.upload()}).then(function(){l("quickstart")})):l("quickstart")},h.stopSpinner=function(){g.stop(),h.dom.querySelector(".next-button").classList.remove("invisible")},h.prev=function(e,t){t.classList.remove("pressed"),f("quickstart")},h.toggleProgress=function(e,t){c()},h.reset=function(e){var t=new Date,n=a.get("step"),r=new u;e?(n==="quickstart"?m="step":m="screen",n!=="quickwrapup"&&a.set("resumeTime",t.getTime())):(a.set("startTime",t.getTime()),a.set("date",[t.getFullYear(),t.getMonth(),t.getDate()]),m="step")},h.help=function(e,t){s.setContent("quickstarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},h}}),define("brainstorm/quickb/quicksetup",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Store","Promise","service/cardpopup","service/help","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(h,p,d,v,m){var g=new e,y,b=t.get("quicksetup"),w=i.get("labels"),E=i.get("transport"),S=i.get("db"),x=i.get("user"),T={},N=new o({timer:null,display:!1}),C,k=new o({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),L=new o({"char":{id:"",title:w.get("char"),pic:""},context:{id:"",title:w.get("context"),pic:""},problem:{id:"",title:w.get("problem"),pic:""}}),A={"char":0,context:0,problem:0},O=!0,M={"char":new o,context:new o,problem:new o},_="",D=null,P=0,H="step",B=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373})).spin();return g.plugins.addAll({labels:new n(w),quicksetup:new n(k,{setReload:function(e){e===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){k.get("char").selected&&k.get("context").selected&&k.get("problem").selected?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),quicksetuptimer:new n(N,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicksetupcards:new n(L,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():this.innerHTML=e},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),quicksetupevent:new r(g)}),g.template='<div id = "quicksetup"><div class="previousbutton" data-quicksetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicksetup-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicksetup" data-quicksetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicksetuptimer="bind:setTime, timer; bind: displayTimer, display" data-quicksetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicksetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-quicksetupevent="listen: mousedown, push; listen:mouseup, draw" data-quicksetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, char.pic" data-quicksetup="bind: popup, char.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, context.pic" data-quicksetup="bind: popup, context.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-quicksetupevent="listen:mousedown, zoom" data-quicksetupcards="bind:removeDefault, problem.pic" data-quicksetup="bind: popup, problem.popup"><div class="cardpicture" data-quicksetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-quicksetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-quicksetup="bind:setSelected, char.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="context" data-quicksetup="bind:setSelected, context.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div><div class="drawok" name="problem" data-quicksetup="bind:setSelected, problem.selected" data-quicksetupevent="listen: mousedown, push; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-quicksetupevent="listen: mousedown, press; listen:mouseup, next" data-quicksetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div></div>',g.place(b),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){B.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),H==="step"?(H="screen",p.set("characters",L.get("char")),p.set("contexts",L.get("context")),p.set("problems",L.get("problem")),clearInterval(C),N.set("display",!0),g.updateSessionScore(N.get("timer")).then(function(){return h.unsync(),h.sync(i.get("db"),h.get("_id"))}).then(function(){h.set("elapsedTimers",{quicksetup:N.get("timer")}),h.set("characters",[L.get("char").id]),h.set("contexts",[L.get("context").id]),h.set("problems",[L.get("problem").id]),v("quicksetup")})):v("quicksetup")},g.stopSpinner=function(){B.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.help=function(e,t){f.setContent("quicksetuphelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g.prev=function(e,t){t.classList.remove("pressed"),d("quicksetup")},g.toggleProgress=function(e,t){m()},g.toggleTimer=function(e,t){N.set("display",!N.get("display"))},g.push=function(e,t){H!=="screen"&&t.classList.add("pushed")},g.draw=function(e,t){var n=t.getAttribute("name"),r=k.get(n);_now=new Date,H==="step"&&O&&(r.left===0&&(T[n]=p.get("deck")[n].concat(),r.left=T[n].length,k.set(n,r)),r.selected&&alert("please unlock selected card first"),O&&!r.selected&&(O=!1,r.selected===!1?g.drawCard(n).then(function(){var e=!1;t.classList.remove("pushed"),O=!0,k.loop(function(t,n){t.popup===!0&&(e=!0)}),e&&g.setPopup(n)}):(t.classList.remove("pushed"),O=!0)))},g.accept=function(e,t){var n=t.getAttribute("name"),r=k.get(n);H==="step"&&(L.get(n).id?r.selected?(r.selected=!1,k.set(n,r)):(r.selected=!0,k.set(n,r)):(r.selected=!1,k.set(n,r)))},g.zoom=function(e,t){var n=t.getAttribute("name");g.setPopup(n)},g.setPopup=function(e){var t={x:0,y:337},n="left",r=k.get(_)||"",i=k.get(e);r&&(r.popup=!1,k.set(_,r)),i.popup=!0,k.set(e,i),_=e,e==="char"&&(t.x=475),e==="context"&&(t.x=195,n="right"),e==="problem"&&(t.x=342,n="right"),M[e].getNbItems()&&y.reset(M[e].toJSON(),t,n,document.getElementById("quicksetup-popup"))},g.closePopup=function(){var e=k.get(_);e.popup=!1,k.set(_,e),_=""},y=new a(g.closePopup),g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;N.set("display",!1),N.set("timer",r),h.get("step")==="quicksetup"&&(C=setInterval(function(){var e=new Date;N.set("timer",r+e.getTime()-n)},1e3))},g.reset=function(e){H="step",e?(P=h.get("elapsedTimers").quicksetup||0,h.get("characters").length?(H="screen",k.reset({"char":{selected:!0,left:1,popup:!1},context:{selected:!0,left:1,popup:!1},problem:{selected:!0,left:1,popup:!1}}),_="",N.set("timer",P),N.set("display",!0),g.getDeck(h.get("deck")).then(function(){return g.getCard(h.get("characters")[0],M.char)}).then(function(){var e=M.char;return L.set("char",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("characters",L.get("char")),g.getCard(h.get("contexts")[0],M.context)}).then(function(){var e=M.context;return L.set("context",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("contexts",L.get("context")),g.getCard(h.get("problems")[0],M.problem)}).then(function(){var e=M.problem;L.set("problem",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),p.set("problems",L.get("problem"))})):(g.init(),g.initTimer(P))):g.init()},g.getDeck=function(e){var t=new u,n=new s;return n.setTransport(E),n.sync(S,e).then(function(){var e,r={},s=i.get("user").get("lang");!n.get("default_lang")||n.get("default_lang")===s?e=JSON.parse(n.toJSON()):n.get("translations")&&n.get("translations")[s]?e=n.get("translations")[s]:e=JSON.parse(n.toJSON()),r.char=e.content.characters,r.context=e.content.contexts,r.problem=e.content.problems,r.techno=e.content.techno,p.set("deck",r),t.fulfill(),setTimeout(function(){n.unsync()},2e3)}),t},g.getCard=function(e,t){var n=new u,r=new s;return r.setTransport(E),r.sync(S,e).then(function(){t.reset(JSON.parse(r.toJSON())),n.fulfill(),r.unsync()}),n},g.drawCard=function(e){var t=new u,n=k.get(e),r=L.get(e),i=Math.floor(Math.random()*T[e].length),s=T[e][i];return g.getCard(s,M[e]).then(function(){var o=M[e];A[e]++,T[e].splice(i,1),r.id=s,r.title=o.get("title"),r.pic=o.get("picture_file"),L.set(e,r),n.left=T[e].length,k.set(e,n),t.fulfill()}),t},g.updateSessionScore=function(e){var t=new u,n={sid:h.get("_id"),step:"quicksetup",time:e,cards:A.char+A.context+A.problem};return E.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},g.init=function(){g.getDeck(i.get("user").get("active_deck")).then(function(){var e=p.get("deck");T.char=e.char.concat(),T.context=e.context.concat(),T.problem=e.problem.concat(),A.char=0,A.context=0,A.problem=0,M={"char":new o,context:new o,problem:new o},_="",O=!0,D=null,L.reset({"char":{id:"",title:w.get("char"),pic:""},context:{id:"",title:w.get("context"),pic:""},problem:{id:"",title:w.get("problem"),pic:""}}),k.reset({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}})})},g}}),define("brainstorm/whiteboard/wbdefault",["OObject","service/config","Bind.plugin"],function(e,t,n){return function(r,i){var s=new e,o="",u=t.get("labels"),a="quick";return s.plugins.add("labels",new n(u)),i?a=i:a="quick",r==="scenario"?o=a+"scenariohelp":o=a+"ideahelp",s.template='<div id="whiteboard-default" class="defaultcontent"><div class="doctor-deedee"></div><div class="help" data-labels="bind:innerHTML,'+o+'"></div></div>',s}}),define("brainstorm/whiteboard/wbmain",["OObject","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r){return function(i,s,o){var u=new e,a,f=!0,l=!1,c=r.get("transport");return u.plugins.addAll({wbmain:new t(i,{displayPost:function(e){var t=this,n=t.getAttribute("data-wbmain_id"),r=i.get(n).content,s=i.get(n).style,o=i.get(n).background,u,f;switch(e){case"postit":t.classList.remove("photo"),t.classList.remove("drawing"),t.innerHTML='<div class="inner-postit">'+r.replace(/\n/g,"<br>")+"</div>",t.setAttribute("style","background:url('img/brainstorm/"+s.img+"') no-repeat center center; background-size: contain; color:"+s.marker+";");break;case"import":t.classList.add("photo"),t.classList.remove("drawing"),this.innerHTML="",u="sessions/"+a,f={dir:u,filename:r},c.request("GetFile",f,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});break;case"drawing":t.classList.remove("photo"),t.classList.add("drawing"),this.innerHTML="",u="sessions/"+a,f={dir:u,filename:r},c.request("GetFile",f,function(e){t.setAttribute("style","background:"+o+"; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});break;default:}}}),wbevent:new n(u)}),u.template='<div class="wbmain"><ul class="wblist" data-wbmain="foreach"><li class="wb-item postit" data-wbmain="bind: displayPost, type" data-wbevent="listen: mouseup, edit; listen:dblclick, cancelEdit"></li><ul><div>',u.edit=function(e,t){var n=t.getAttribute("data-wbmain_id"),r=i.get(n).type;f?l?i.get(n).type!=="postit"&&(t.classList.contains("enlarge")?t.classList.remove("enlarge"):t.classList.add("enlarge")):(s.set(r,"active"),o(r,n)):f=!0},u.cancelEdit=function(e,t){e.stopPropagation(),f=!1},u.setSessionId=function(e){a=e},u.setReadonly=function(e){l=e},u}}),define("brainstorm/whiteboard/wbpostit",["OObject","Store","Bind.plugin","Event.plugin","service/config"],function(e,t,n,r,i){return function(s,o){var u=new e,a=i.get("labels"),f="#4D4D4D",l=[{name:"blue",color:"#657B99",img:"postItBlue.png",selected:!1},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:!1},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:!0},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:!1}],c=new t(l),h=null,p=new t({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"}});return u.plugins.addAll({labels:new n(a),postit:new n(p,{setStyle:function(e){var t=e.marker,n=e.img;this.setAttribute("style","background-image:url('img/brainstorm/"+n+"'); color:"+t+";")}}),colors:new n(c,{setBg:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),postitevent:new r(u)}),u.template='<div class="wbpostit"><div class="postit-cancel postit-close" data-postitevent="listen:mousedown,cancel"></div><div class="postit" data-postit="bind:setStyle, style"><textarea data-postit="bind: value, content"></textarea></div><span class="choosecolorlbl" data-labels="bind:innerHTML, choosecolorlbl"></span><ul class="postitcolors" data-colors="foreach"><li class="postitcolor" data-postitevent="listen:mousedown,choose" data-colors="bind:setBg, color;bind:setSelected, selected"></li></ul><div name="post" class = "postpostit" data-postitevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-postitevent="listen:mousedown, press;listen:mouseup, del"></div></div>',u.cancel=function(e,t){o("postit")},u.choose=function(e,t){var n=t.getAttribute("data-colors_id");c.loop(function(e,t){t===parseInt(n,10)?c.update(t,"selected",!0):c.update(t,"selected",!1)}),p.set("style",{postit:c.get(n).name,marker:f,img:c.get(n).img})},u.press=function(e,t){t.classList.add("pressed")},u.post=function(e,t){!h&&h!==0?s.alter("push",JSON.parse(p.toJSON())):s.alter("splice",h,1,JSON.parse(p.toJSON())),t.classList.remove("pressed"),o("postit"),u.reset()},u.reset=function(e){h=e,!h&&h!==0?(p.reset({type:"postit",content:"",style:{postit:"yellow",img:"postItYellow.png",marker:"#4D4D4D"}}),c.reset([{name:"blue",color:"#657B99",img:"postItBlue.png",selected:!1},{name:"azur",color:"#9AC9CD",img:"postItAzur.png",selected:!1},{name:"yellow",color:"#F2E520",img:"postItYellow.png",selected:!0},{name:"orange",color:"#F27B3D",img:"postItOrange.png",selected:!1}])):p.reset(s.get(h))},u.del=function(e,t){h&&s.del(h),t.classList.remove("pressed"),u.reset(),o("postit")},u}}),define("brainstorm/whiteboard/wbimport",["OObject","service/map","service/config","Bind.plugin","Event.plugin","service/utils","Store","Promise"],function(e,t,n,r,i,s,o,u){return function(t,a){var f=new e,l=n.get("labels"),c=new FileReader,h=new o({status:null}),p=null,d=new o({type:"import",content:""}),v,m=400,g=300,y=function(e){var t,n,r=document.getElementById("preview"),i=r.getContext("2d");t=e.width,n=e.height,t>n?t>m&&(n*=m/t,t=m):n>g&&(t*=g/n,n=g),r.width=t,r.height=n,i.drawImage(e,0,0,t,n)},b=function(e){var t=new u,r="/upload",i=new FormData,o="postit",a="sessions/"+v,f=document.getElementById("preview"),l=f.toDataURL("image/png"),c=new Date,p=e||n.get("user").get("_id")+"_"+c.getTime();return i.append("type",o),i.append("dir",a),i.append("filename",p),i.append("dataString",l),s.uploadFile(r,i,h,function(e){d.set("content",p),t.fulfill()}),t},w=function(){var e=document.getElementById("preview"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)};return f.template='<div class="import"><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/*" data-importevent="listen: mousedown, selectpress; listen:mouseup, check; listen: change, preview"><div data-labels="bind:innerHTML, importlbl" data-importevent="listen: mousedown, press; listen: mouseup, release"></div></span><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:mousedown,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-importevent="listen:mousedown, press;listen:mouseup, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>',f.plugins.addAll({labels:new r(l),importmodel:new r(d,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(e){var t,r=this,i=n.get("transport");e?(t={dir:v,filename:e},i.request("GetFile",t,function(e){var t=new Image,n=r.getContext("2d");t.src=e,r.width=t.width,r.height=t.height,n.drawImage(t,0,0)})):this.innerHTML=""}}),importprogress:new r(h,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),importevent:new i(f)}),f.cancel=function(e,t){t.parentNode.classList.add("invisible"),a("import")},f.check=function(e,t){t.classList.remove("pressed"),t.files.length&&f.preview("change",t)},f.preview=function(e,t){var n=new Image,r=new FileReader;r.onloadend=function(e){n.src=e.target.result,setTimeout(function(){y(n),document.getElementById("postpic").classList.remove("invisible")},300)},r.readAsDataURL(t.files[0])},f.selectpress=function(e,t){t.value=""},f.press=function(e,t){t.classList.add("pressed")},f.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},f.post=function(e,n){b(d.get("content")).then(function(){!p&&p!==0?t.alter("push",JSON.parse(d.toJSON())):t.alter("splice",p,1,JSON.parse(d.toJSON())),n.classList.remove("pressed"),f.reset(),h.reset({status:""}),w(),f.dom.querySelector(".importbutton").classList.remove("invisible"),a("import")})},f.reset=function(e){p=e,!p&&p!==0?d.reset({type:"import",content:""}):(d.reset(t.get(e)),f.dom.querySelector("#postpic").scrollIntoView())},f.setSessionId=function(e){v=e},f.del=function(e,n){(p||p===0)&&t.del(p),n.classList.remove("pressed"),n.parentNode.classList.add("invisible"),f.reset(),w(),document.getElementById("importbuttons").classList.remove("invisible"),a("import")},f}}),define("brainstorm/whiteboard/wbdrawing",["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,n,r,i,s,o,u){return function(t,a){var f=new e,l=null,c={},h=new s({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),p=new s([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),d=new s([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),v=n.get("labels"),m=new s({status:null}),g=new s({type:"drawing",content:"",background:""}),y=function(e){var t=new o,r="/upload",i=new FormData,s="postit",a="sessions/"+b,l=f.dom.querySelector(".drawingcanvas"),c=l.toDataURL("image/png"),p=new Date,d=e||n.get("user").get("_id")+"_"+p.getTime();return i.append("type",s),i.append("dir",a),i.append("filename",d),i.append("dataString",c),u.uploadFile(r,i,m,function(e){g.set("content",d),g.set("background",h.get("bg")),t.fulfill()}),t},b,w=!1,E=(document.body.clientWidth-1024)/2,S=(document.body.clientHeight-748)/2;return f.plugins.addAll({labels:new r(v),color:new r(p,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),pencil:new r(h,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){e==="pencil"?this.setAttribute("fill",h.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){h.get("mode")==="pencil"?this.setAttribute("fill",e):this.setAttribute("fill",h.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new r(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),uploadprogress:new r(m,{showProgress:function(e){e?this.innerHTML=e+"%":this.innerHTML=""}}),drawing:new r(g,{draw:function(e){var t=n.get("transport"),r=this,i;e&&(i={dir:b,filename:e},t.request("GetFile",i,function(e){var t=new Image,n=r.getContext("2d");t.src=e,n.drawImage(t,0,0)}))}}),drawingevent:new i(f)}),f.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',f.setSessionId=function(e){b=e},f.clear=function(e,t){var n=f.dom.querySelector(".drawingcanvas"),r=n.getContext("2d");r.clearRect(0,0,n.width,n.height),t.classList.remove("selected")},f.resetColors=function(){h.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),p.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),d.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},f.erase=function(e,t){h.set("mode","erase"),h.set("color",h.get("bg"))},f.drawactive=function(e,t){h.set("mode","pencil"),p.loop(function(e,t){e.active&&h.set("color",e.color)})},f.expand=function(e,t){var n=t.getAttribute("name"),r=document.getElementById(n);r.classList.contains("invisible")?r.classList.remove("invisible"):r.classList.add("invisible")},f.stop=function(e,t){e.stopPropagation()},f.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},f.select=function(e,t){t.classList.add("selected")},f.getColor=function(e,t){var n=t.getAttribute("data-color_id");e.stopPropagation(),p.loop(function(e,t){t===parseInt(n)?p.update(t,"active",!0):p.update(t,"active",!1)}),h.set("color",p.get(n).color),h.set("mode","pencil"),t.parentNode.classList.add("invisible")},f.getBgColor=function(e,t){var n=t.getAttribute("data-bgcolor_id");e.stopPropagation(),d.loop(function(e,t){t===parseInt(n)?d.update(t,"active",!0):d.update(t,"active",!1)}),h.set("bg",d.get(n).color),t.parentNode.classList.add("invisible")},f.cancel=function(e,t){f.clear(e,t),f.resetColors(),g.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),a("drawing")},f.deletedrawing=function(e,n){(l||l===0)&&t.del(l),f.cancel(e,n)},f.post=function(e,n){n.classList.add("selected"),y(g.get("content")).then(function(){!l&&l!==0?t.alter("push",JSON.parse(g.toJSON())):t.alter("splice",l,1,JSON.parse(g.toJSON())),n.classList.remove("selected"),f.cancel(e,n),m.reset({status:""})})},f.reset=function(e){var n=f.dom.querySelector(".drawingcanvas");l=e,f.resetColors(),_lines=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&n.setAttribute("height",380),!l&&l!==0?g.reset({type:"drawing",content:"",background:""}):(g.reset(t.get(e)),h.set("bg",g.get("background")),d.loop(function(e,t){e.color===g.get("background")?d.update(t,"active",!0):d.update(t,"active",!1)}))},f.start=function(e,t){c={x:e.pageX-t.offsetLeft-E,y:e.pageY-t.offsetTop-S},w=!0,e.preventDefault()},f.end=function(e,t){w=!1},f.move=function(e,t){var n,r,i;w&&(n=e.pageX-t.offsetLeft-E-c.x,r=e.pageY-t.offsetTop-S-c.y,i=f.draw(t,n,r),c={x:i.x,y:i.y}),e.preventDefault()},f.draw=function(e,t,n){var r=e.getContext("2d");return r.lineWidth=h.get("size"),r.strokeStyle=h.get("color"),r.lineCap=h.get("cap"),r.beginPath(),r.moveTo(c.x,c.y),r.lineTo(c.x+t,c.y+n),r.stroke(),r.closePath(),{x:c.x+t,y:c.y+n}},f}}),define("brainstorm/whiteboard/whiteboard",["Amy/Stack-plugin","./wbdefault","./wbmain","./wbpostit","./wbimport","./wbdrawing","Store"],function(e,t,n,r,i,s,o){function u(e,u,a,f){var l=new o([]),c=this;this.selectScreen=function(e,t){var n=c.getStack().get(e);n.reset&&n.reset(t),c.getStack().show(e)},this.exitScreen=function(e){u.getNbItems()?c.getStack().show("main"):c.getStack().show("default"),a.set(e,"inactive")},this.getContent=function(){return l},this.setSessionId=function(e){c.getStack().get("main").setSessionId(e),c.getStack().get("import").setSessionId(e),c.getStack().get("drawing").setSessionId(e)},this.setReadonly=function(e){c.getStack().get("main").setReadonly(e)},this.getStack().add("default",new t(e,f)),this.getStack().add("main",new n(u,a,this.selectScreen)),this.getStack().add("postit",new r(u,this.exitScreen)),this.getStack().add("import",new i(u,this.exitScreen)),this.getStack().add("drawing",new s(u,this.exitScreen))}return function(t,n,r,i){return u.prototype=new e,new u(t,n,r,i)}}),define("brainstorm/quickb/quickscenario",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../whiteboard/whiteboard","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(h,p,d,v,m){var g=new e,y,b,w=i.get("labels"),E=new s,S=new s,x=new s,T=new s({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),N={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},C=new s(N),k=new s({timer:null,display:!1}),L,A=new s({title:"",story:"",solution:""}),O=new s([]),M=new a("scenario",O,C),_,D=0,P="step",H=i.get("transport"),B=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return g.plugins.addAll({labels:new n(w,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(T,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(C,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new n(k,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(A),wbstack:M,quickscenarioevent:new r(g)}),g.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:mousedown,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',g.place(t.get("quickscenario")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){B.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),P==="step"?(P="screen",clearInterval(L),k.set("display",!0),p.set("scenario",JSON.parse(A.toJSON())),g.updateSessionScore(k.get("timer")).then(function(){return h.unsync(),h.sync(i.get("db"),h.get("_id"))}).then(function(){var e=h.get("elapsedTimers");e.quickscenario=k.get("timer"),h.set("scenario",[JSON.parse(A.toJSON())]),h.set("elapsedTimers",e),C.set("readonly",!0),v("quickscenario")})):v("quickscenario")},g.stopSpinner=function(){B.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.prev=function(e,t){t.classList.remove("pressed"),d("quickscenario")},g.toggleProgress=function(e,t){m()},g.toggleTimer=function(e,t){k.set("display",!k.get("display"))},g.push=function(e,t){var n=t.getAttribute("name");C.set(n,"active")},g.zoom=function(e,t){var n=t.getAttribute("name");g.setPopup(n)},g.setPopup=function(e){var t={x:240,y:130},n="left",r=T.get(e),s=C.get("cardpopup"),u="",a;b&&(s[b]=!1),s[e]=!0,C.set("cardpopup",s),b=e,e==="char"&&(t.y=120,r.id===E.get("_id")&&(u=E.toJSON())),e==="context"&&(t.y=290,r.id===S.get("_id")&&(u=S.toJSON())),e==="problem"&&(t.y=350,r.id===x.get("_id")&&(u=x.toJSON())),u?y.reset(u,t,n,document.getElementById("quickscenario-popup")):(a=new o,a.setTransport(H),a.sync(i.get("db"),r.id).then(function(){u=a.toJSON(),y.reset(u,t,n,document.getElementById("quickscenario-popup")),e==="char"&&E.reset(JSON.parse(a.toJSON())),e==="context"&&S.reset(JSON.parse(a.toJSON())),e==="problem"&&x.reset(JSON.parse(a.toJSON()))}))},g.closePopup=function(){var e=C.get("cardpopup");e[b]=!1,C.set("cardpopup",e),b=""},y=new u(g.closePopup),g.post=function(e,t){M.selectScreen("postit"),C.set("import","inactive"),C.set("drawing","inactive")},g.importpic=function(e,t){M.selectScreen("import"),C.set("postit","inactive"),C.set("drawing","inactive")},g.draw=function(e,t){M.selectScreen("drawing"),C.set("import","inactive"),C.set("postit","inactive")},g.exitTool=function(e){C.set(e,"inactive")},g.finish=function(e,t){M.setReadonly(!0),C.set("ready",!1),C.set("showstory",!0),t.classList.remove("pressed")},g.updateSessionScore=function(e){var t=new f,n={sid:h.get("_id"),step:"quickscenario",time:e,wbcontent:O.toJSON(),scenario:A.toJSON()};return H.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},g.reset=function(e){C.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),M.setSessionId(h.get("_id")),O.reset(h.get("scenarioWB")),O.getNbItems()?M.selectScreen("main"):M.selectScreen("default"),h.get("scenario").length?(P="screen",C.set("ready",!1),C.set("showstory",!0),M.setReadonly(!0),A.reset(h.get("scenario")[0]),p.set("scenario",h.get("scenario")[0]),C.set("readonly",!0),C.set("shownext",!0)):(A.reset({title:"",story:"",solution:""}),O.getNbItems()?C.set("ready",!0):C.set("ready",!1),M.setReadonly(!1),P="step"),h.get("elapsedTimers").quickscenario&&(D=h.get("elapsedTimers").quickscenario,k.set("timer",D)),P==="screen"?k.set("display",!0):g.initTimer(D)},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;k.set("display",!1),k.set("timer",r),h.get("step")==="quickscenario"&&(clearInterval(L),L=setInterval(function(){var e=new Date;k.set("timer",r+e.getTime()-n)},1e3))},p.watchValue("characters",function(e){T.set("char",e)}),p.watchValue("contexts",function(e){T.set("context",e)}),p.watchValue("problems",function(e){T.set("problem",e)}),h.watchValue("_id",function(e){M.setSessionId(e)}),["added","deleted","updated"].forEach(function(e){O.watch(e,function(){JSON.stringify(h.get("scenarioWB"))!==O.toJSON()&&(h.set("scenarioWB",JSON.parse(O.toJSON())),h.upload()),O.getNbItems()&&P==="step"?C.set("ready",!0):C.set("ready",!1)})}),A.watch("updated",function(){A.get("title")&&A.get("story")&&A.get("solution")?C.set("shownext",!0):C.set("shownext",!1)}),TIM=k,g}}),define("brainstorm/quickb/quicktech",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(h,p,d,v,m){var g=new e,y=null,b=null,w,E=new o({timer:null,display:!1}),S=i.get("transport"),x=i.get("user"),T=i.get("labels"),N,C,k={left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}},L=new o(k),A=[],O=!0,M=new o,_=new o,D=new o,P={tech1:M,tech2:_,tech3:D},H=0,B=new o([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),j="step",F=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373})).spin();return g.plugins.addAll({labels:new n(T),display:new n(L,{setReload:function(e){!e&&H>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){L.get("tech1").selected&&L.get("tech2").selected&&L.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new n(B,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.toUpperCase():this.innerHTML=T.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),quicktechtimer:new n(E,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new r(g)}),g.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:mousedown, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-quicktechevent="listen: mousedown,  accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-quicktechevent="listen: mousedown, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-quicktechevent="listen: mousedown, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>',g.place(t.get("quicktech")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){var n=new Date,r=n.getTime()-y;F.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),j==="step"?(j="screen",p.set("techno",B),clearInterval(w),E.set("display",!0),g.updateSessionScore(E.get("timer")).then(function(){return h.unsync(),h.sync(i.get("db"),h.get("_id"))}).then(function(){var e=h.get("elapsedTimers");e.quicktech=E.get("timer"),h.set("elapsedTimers",e),h.set("techno",[[B.get(0).id,B.get(1).id,B.get(2).id]]),v("quicktech")})):v("quicktech")},g.stopSpinner=function(){F.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.help=function(e,t){s.setContent("quicktechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g.prev=function(e,t){t.classList.remove("pressed"),d("quicktech")},g.toggleProgress=function(e,t){m()},g.toggleTimer=function(e,t){E.set("display",!E.get("display"))},g.select=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||H>0||j==="screen")&&t.classList.add("highlighted")},g.zoom=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||H>0||j==="screen")&&g.setPopup(n)},g.setPopup=function(e){var t={x:0,y:337},n="left",r=L.get(C)||"",i=new o,s,u=L.get(e);r&&(r.popup=!1,L.set(C,r)),u.popup=!0,L.set(e,u),C=e,e==="scenario"?(t.x=240,t.y=275,i.reset(h.get("scenario")[0]),i.set("type",5),s=i.toJSON()):(e==="tech1"&&(t.x=560),e==="tech2"&&(t.x=279,n="right"),e==="tech3"&&(t.x=426,n="right"),P[e].get("_id")&&(s=P[e].toJSON())),s&&N.reset(s,t,n,document.getElementById("quicktech-popup"))},g.closePopup=function(){var e=L.get(C);e.popup=!1,L.set(C,e),C=""},g.push=function(e,t){var n=t.getAttribute("name");t.classList.contains("drawok")?P[n].get("_id")&&j==="step"&&t.classList.add("pushed"):t.classList.add("pushed")},g.draw=function(e,t){var n=[];j==="step"&&O&&(O=!1,["tech1","tech2","tech3"].forEach(function(e){L.get(e).selected||n.push(e)}),g.drawTech(n).then(function(){t.classList.remove("pushed"),O=!0}))},g.drawTech=function(e){var t,n=[],r=new a;return e.forEach(function(e){A.length<=0&&(A=p.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){L.get(e).selected&&n.push(B.get(t).id)}),A.filter(function(e){return!(n.indexOf(e)>-1)})),t=Math.floor(Math.random()*A.length),g.getCardDetails(A[t],e),L.set("left",A.length),H++,A.splice(t,1)}),r.fulfill(),r},g.getCardDetails=function(e,t){var n=new u,r=["tech1","tech2","tech3"].indexOf(t),s=new a;return n.setTransport(S),n.sync(i.get("db"),e).then(function(){P[t].reset(JSON.parse(n.toJSON())),B.update(r,"id",e),B.update(r,"title",n.get("title")),B.update(r,"pic",n.get("picture_file")),s.fulfill(),n.unsync()}),s},g.accept=function(e,t){var n=t.getAttribute("name"),r=["tech1","tech2","tech3"].indexOf(n),i=L.get(n);j==="step"&&(B.get(r).id?(i.selected=!i.selected,L.set(n,i)):alert("please draw a card first"))},g.reset=function(e){var t=h.get("techno")[0];L.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),B.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),j="step",e&&t&&t.length?(j="screen",g.getCardDetails(t[0],"tech1").then(function(){return g.getCardDetails(t[1],"tech2")}).then(function(){return g.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){L.set(e,{popup:!1,selected:!0})}),p.set("techno",B)})):(A=[],H=0,M.reset(),_.reset(),D.reset(),B.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),h.get("elapsedTimers").quicktech?b=h.get("elapsedTimers").quicktech:b=0,E.set("timer",b),j==="screen"?E.set("display",!0):g.initTimer(b)},g.updateSessionScore=function(e){var t=new a,n={sid:h.get("_id"),step:"quicktech",time:e,cards:H};return S.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;E.set("display",!1),E.set("timer",r),h.get("step")==="quicktech"&&(w=setInterval(function(){var e=new Date;E.set("timer",r+e.getTime()-n)},1e3))},N=new f(g.closePopup),p.watchValue("deck",function(e){A=e.techno.concat(),L.set("left",A.length)}),g}}),define("brainstorm/quickb/quickidea",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/cardpopup","../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c){return function(h,p,d,v,m){var g=new e,y,b,w="step",E,S=0,x,T=new u({timer:null,display:!1}),N=new u({title:"",description:"",solution:"",visibility:"private"}),C=new u,k=new u([]),L=[],A={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},O=new u(A),M=new u([]),_=new o("idea",M,O),D=i.get("transport"),P=i.get("labels"),H=i.get("user"),B=(new c({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690})).spin();return g.plugins.addAll({labels:new n(P,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(C),techs:new n(k,{setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(O,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),quickideatimer:new n(T,{setTime:function(e){e&&(this.innerHTML=l.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(N,{setVisibility:function(e){e==="public"?(this.value=0,this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")):(this.value=1,this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))}}),wbstack:_,quickideaevent:new r(g)}),g.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:mousedown,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:mouseup, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',g.place(t.get("quickidea")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){var n=new Date,r,s;B.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),w==="step"?(w="screen",clearInterval(x),T.set("display",!0),s=g.getSessionDuration(),p.set("idea",JSON.parse(N.toJSON())),g.createIdeaDoc().then(function(){return g.updateSessionScore(T.get("timer"))}).then(function(){return h.unsync(),h.sync(i.get("db"),h.get("_id"))}).then(function(){var e=h.get("elapsedTimers");return e.quickidea=T.get("timer"),h.set("idea",[JSON.parse(N.toJSON())]),h.set("elapsedTimers",e),h.set("duration",s),h.set("status","completed"),O.set("readonly",!0),v("quickidea")}).then(function(){H.set("sessionInProgress",{}),user.upload()})):v("quickidea")},g.stopSpinner=function(){B.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.prev=function(e,t){t.classList.remove("pressed"),d("quickidea")},g.toggleProgress=function(e,t){m()},g.toggleTimer=function(e,t){T.set("display",!T.get("display"))},g.toggleVisibility=function(e,t){w==="step"&&(N.get("visibility")==="public"?N.set("visibility","private"):N.set("visibility","public"))},g.push=function(e,t){var n=t.getAttribute("name");O.set(n,"active")},g.select=function(e,t){t.classList.add("higlighted")},g.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),g.setPopup(n,r)},g.setPopup=function(e,t){var n={x:240,y:30},r="left",s=O.get("cardpopup"),o=new u,f="",l,c;b&&(b.type==="scenario"?s.scenario=!1:s.techs[b.id]=!1,O.set("cardpopup",s)),e==="scenario"?s.scenario=!0:s.techs[t]=!0,O.set("cardpopup",s),b={type:e,id:t},e==="scenario"?(n.y=55,o.reset(p.get("scenario")),o.set("type",5),f=o.toJSON(),y.reset(f,n,r,document.getElementById("quickidea-popup"))):(t==0&&(n.y=200),t==1&&(n.y=260),t==2&&(n.y=350),L[t]?(f=L[t],y.reset(f,n,r,document.getElementById("quickidea-popup"))):(c=new a,c.setTransport(D),c.sync(i.get("db"),p.get("techno").get(t).id).then(function(){f=c.toJSON(),y.reset(f,n,r,document.getElementById("quickidea-popup")),L[t]=f})))},g.closePopup=function(){var e=O.get("cardpopup");e[b]=!1,O.set("cardpopup",e),b=""},y=new s(g.closePopup),g.post=function(e,t){_.selectScreen("postit"),O.set("import","inactive"),O.set("drawing","inactive")},g.importpic=function(e,t){_.selectScreen("import"),O.set("postit","inactive"),O.set("drawing","inactive")},g.draw=function(e,t){_.selectScreen("drawing"),O.set("import","inactive"),O.set("postit","inactive")},g.exitTool=function(e){O.set(e,"inactive")},g.finish=function(e,t){_.setReadonly(!0),O.set("ready",!1),O.set("showidea",!0),t.classList.remove("pressed")},g.updateSessionScore=function(e){var t=new f,n={sid:h.get("_id"),step:"quickidea",time:e,wbcontent:M.toJSON(),idea:N.toJSON()};return D.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},g.getSessionDuration=function(){var e=h.get("elapsedTime"),t=h.get("resumeTime")||h.get("startTime");return now=new Date,now.getTime()-t+e},g.createIdeaDoc=function(){var e=new a(i.get("ideaTemplate")),t=new Date,n="I:"+t.getTime(),r=new f;return e.setTransport(D),e.set("title",N.get("title")),e.set("sessionId",h.get("_id")),e.set("authors",[h.get("initiator").id]),e.set("description",N.get("description")),e.set("solution",N.get("solution")),e.set("creation_date",[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()]),e.set("character",h.get("characters")[0]),e.set("problem",h.get("problems")[0]),e.set("context",h.get("contexts")[0]),e.set("techno",h.get("techno")[0]),e.set("visibility",N.get("visibility")),e.set("authornames",h.get("initiator").username),e.set("lang",h.get("lang")),e.set("_id",n),e.sync(i.get("db"),n).then(function(){return e.upload()}).then(function(){e.get("visibility")==="public"&&D.request("UpdateUIP",{userid:H.get("_id"),type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){e!=="ok"&&console.log(e)}),r.fulfill(),e.unsync()}),r},g.reset=function(e){O.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),k.reset(),_.setSessionId(h.get("_id")),M.reset(h.get("ideaWB")),M.getNbItems()?_.selectScreen("main"):_.selectScreen("default"),clearInterval(x),h.get("idea").length?(_.setReadonly(!0),O.set("ready",!1),O.set("showidea",!0),N.reset(h.get("idea")[0]),p.set("idea",h.get("idea")[0]),O.set("readonly",!0),O.set("shownext",!0),w="screen"):(N.reset({title:"",description:"",solution:"",visibility:"private"}),M.getNbItems()?O.set("ready",!0):O.set("ready",!1),_.setReadonly(!1),w="step"),h.get("elapsedTimers").quickidea&&(S=h.get("elapsedTimers").quickidea,T.set("timer",S)),w==="screen"?T.set("display",!0):g.initTimer(S)},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;T.set("display",!1),T.set("timer",r),h.get("step")==="quickidea"&&(clearInterval(x),x=setInterval(function(){var e=new Date;T.set("timer",r+e.getTime()-n)},1e3))},h.watchValue("_id",function(e){_.setSessionId(e)}),p.watchValue("scenario",function(e){C.reset(p.get("scenario"))}),p.watchValue("techno",function(e){k.reset(JSON.parse(p.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){M.watch(e,function(){JSON.stringify(h.get("ideaWB"))!==M.toJSON()&&(h.set("ideaWB",JSON.parse(M.toJSON())),h.upload()),M.getNbItems()?O.set("ready",!0):O.set("ready",!1)})}),N.watch("updated",function(){N.get("title")&&N.get("description")&&N.get("solution")?O.set("shownext",!0):O.set("shownext",!1)}),g}}),define("brainstorm/quickb/quickwrapup",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils"],function(e,t,n,r,i,s,o){return function(u,a,f,l,c){var h=new e,p=new s,d=new s([]),v=i.get("labels");return h.plugins.addAll({labels:new n(v),wrapup:new n(p,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setScore:function(e){e&&(this.innerHTML=e+" ip")},setTime:function(e){e&&(this.innerHTML=o.formatDuration(e))}}),cards:new n(d,{formatTitle:function(e){var t=this.getAttribute("data-cards_id");e&&(t<3?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),quickwrapupevent:new r(h)}),h.template='<div id = "quickwrapup"><div class="previousbutton" data-quickwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickwrapup" data-quickwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div></div><div class="sessioncards" data-quickwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div></div>',h.place(t.get("quickwrapup")),h.press=function(e,t){t.classList.add("pressed")},h.next=function(e,t){t.classList.remove("pressed"),l("quickwrapup")},h.prev=function(e,t){t.classList.remove("pressed"),f("quickwrapup")},h.toggleProgress=function(e,t){c()},h.toggleCards=function(e,t){t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")},h.reset=function(e){d.reset([]),p.reset()},a.watchValue("scenario",function(e){p.set("scenario",e)}),a.watchValue("idea",function(e){p.set("idea",e)}),["added","updated"].forEach(function(e){a.watch(e,function(){var e;a.get("characters")&&a.get("contexts")&&a.get("problems")&&a.get("techno").getNbItems()===3&&(e=[a.get("characters"),a.get("contexts"),a.get("problems"),a.get("techno").get(0),a.get("techno").get(1),a.get("techno").get(2)],d.reset(e))})}),u.watchValue("score",function(e){p.set("score",e)}),u.watchValue("duration",function(e){p.set("duration",e)}),h}}),define("brainstorm/quickb/quickb",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./quickstart","./quicksetup","./quickscenario","./quicktech","./quickidea","./quickwrapup","CouchDBDocument","CouchDBView","service/config","Promise","Store","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return function(g,y){var b=new e,w=new e,E=document.createDocumentFragment(),S=new n,x=p.get("labels"),T=new v([{name:"quickstart",label:x.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:x.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:x.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:x.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:x.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:x.get("quickstepwrapup"),currentStep:!1,status:null}]),N=p.get("user"),C=new c,k=new v,L=(new m({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin();return b.plugins.add("quickstack",S),b.template='<div id="ideafy-quick"><div class="stack" data-quickstack="destination"></div></div>',b.place(t.get("ideafy-quick")),w.plugins.addAll({labels:new r(x),step:new r(T,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(w)}),w.template='<div class = "progressbar invisible"><ul id = "quicksteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, highlightStep; listen:mouseup, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',w.place(b.dom),w.highlightStep=function(e,t){t.classList.toggle("inactive")},w.changeStep=function(e,t){var n=t.getAttribute("data-step_id");T.get(n).status?(T.loop(function(e,t){n==t?T.update(t,"currentStep",!0):T.update(t,"currentStep",!1)}),S.getStack().show(T.get(n).name)):e.stopImmediatePropagation(),w.dom.classList.add("invisible")},w.press=function(e,t){t.classList.add("pressed")},w.exit=function(e,t){t.classList.remove("pressed"),w.dom.classList.add("invisible"),y()},b.retrieveSession=function(e){console.log(e),L.spin(document.getElementById("brainstorm")),k.reset(),C.unsync(),C.reset(),b.sessionExists(e.id).then(function(){return C.sync(p.get("db"),e.id)}).then(function(){console.log(C.toJSON());var t=C.get("step"),n=1e4,r=T.getNbItems();S.getStack().get("quickstart").reset(e),S.getStack().get("quicksetup").reset(e),S.getStack().get("quickscenario").reset(e),S.getStack().get("quicktech").reset(e),S.getStack().get("quickidea").reset(e),S.getStack().get("quickwrapup").reset(e),T.loop(function(e,r){r<n&&(e.name===t?(n=r,T.update(r,"currentStep",!0),e.name==="quickwrapup"?T.update(r,"status","done"):T.update(r,"status","ongoing")):T.update(r,"status","done"))}),t==="quickwrapup"?(L.stop(),S.getStack().show("quickwrapup"),T.update(0,"currentStep",!1)):(T.update(0,"currentStep",!0),T.update(n,"currentStep",!1),L.stop(),S.getStack().show("quickstart"),C.get("status")!=="completed"&&(N.set("sessionInProgress",e),N.upload()))},function(e){L.stop(),alert("session could not be retrieved")})},b.startNewSession=function(){C.unsync(),C.reset(p.get("sessionTemplate")),k.reset({}),C.set("initiator",{id:N.get("_id"),username:N.get("username"),picture_file:N.get("picture_file")}),C.set("mode","quick"),C.set("step","quickstart"),C.set("deck",N.get("active_deck")),S.getStack().get("quickstart").reset(),S.getStack().get("quicksetup").reset(),S.getStack().get("quickscenario").reset(),S.getStack().get("quicktech").reset(),S.getStack().get("quickidea").reset(),S.getStack().get("quickwrapup").reset(),S.getStack().show("quickstart")},b.sessionExists=function(e){var t=new d,n=new h;return n.setTransport(p.get("transport")),n.sync(p.get("db"),"library","_view/sessioncount",{key:'"'+e+'"'}).then(function(){n.getNbItems()?t.fulfill():t.reject("not found")}),t},b.reset=function(e){T.reset([{name:"quickstart",label:x.get("quickstepstart"),currentStep:!0,status:"ongoing"},{name:"quicksetup",label:x.get("quickstepsetup"),currentStep:!1,status:null},{name:"quickscenario",label:x.get("quickstepscenario"),currentStep:!1,status:null},{name:"quicktech",label:x.get("quicksteptech"),currentStep:!1,status:null},{name:"quickidea",label:x.get("quickstepidea"),currentStep:!1,status:null},{name:"quickwrapup",label:x.get("quickstepwrapup"),currentStep:!1,status:null}]),e?b.retrieveSession(e):b.startNewSession()},b.prev=function(e){var t;T.loop(function(n,r){n.name===e&&(t=r)}),t>0?(T.update(t,"currentStep",!1),T.update(t-1,"currentStep",!0),S.getStack().show(T.get(t-1).name)):(alert("Exiting session"),y())},b.next=function(e){var t,n,r=S.getStack().get(e),i=new d;return T.loop(function(n,r){n.name===e&&(t=r)}),t<T.getNbItems()-1&&(T.update(t,"currentStep",!1),T.update(t+1,"currentStep",!0),T.get(t).status!=="done"?(T.update(t,"status","done"),T.update(t+1,"status","ongoing"),C.set("step",T.get(t+1).name),C.upload().then(function(){n=S.getStack().get(T.get(t+1).name),n.initTimer&&n.initTimer(),r.stopSpinner(),S.getStack().show(T.get(t+1).name),i.fulfill()})):(r.stopSpinner(),S.getStack().show(T.get(t+1).name),i.fulfill())),i},b.toggleProgress=function(){w.dom.classList.toggle("invisible")},b.init=function(e){C.setTransport(p.get("transport")),S.getStack().add("quickstart",new s(C,b.prev,b.next,b.toggleProgress)),S.getStack().add("quicksetup",new o(C,k,b.prev,b.next,b.toggleProgress)),S.getStack().add("quickscenario",new u(C,k,b.prev,b.next,b.toggleProgress)),S.getStack().add("quicktech",new a(C,k,b.prev,b.next,b.toggleProgress)),S.getStack().add("quickidea",new f(C,k,b.prev,b.next,b.toggleProgress)),S.getStack().add("quickwrapup",new l(C,k,b.prev,b.next,b.toggleProgress)),b.reset(e)},b.init(g),p.get("observer").watch("reconnect",function(){C.get("_id")&&(C.unsync(),C.sync(p.get("db"),C.get("_id")))}),b}}),define("brainstorm/multi/init/newmub",["OObject","Bind.plugin","Event.plugin","CouchDBDocument","service/config","Promise","Store","service/utils","lib/spin.min"],function(e,t,n,r,s,o,u,a,f){return function(l){var c=new e,h=new u({}),p=new u([]),d=new u([]),v=new u({errormsg:""}),m=s.get("labels"),g=s.get("user"),y={title:"",description:"",initiator:{id:g.get("_id"),username:g.get("username"),intro:g.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:g.get("active_deck"),status:"waiting",step:"mustart",lang:g.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]},b=(new f({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:660})).spin();return c.plugins.addAll({labels:new t(m),newmub:new t(h,{initSessionMode:function(e){switch(e){case"campfire":this.selectedIndex=1,this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2,this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0,this.setAttribute("style","color: #5F8F28;")}},setSessionInfo:function(e){switch(e){case"campfire":this.innerHTML=m.get("campfireinfo");break;case"boardroom":this.innerHTML=m.get("boardroominfo");break;default:this.innerHTML=m.get("rouletteinfo")}},displayInvitations:function(e){e==="boardroom"?this.classList.remove("invisible"):this.classList.add("invisible")},setTitle:function(e){var t=new Date;e&&e.username&&this.setAttribute("placeholder",m.get("quickstarttitleplaceholderpre")+e.username+m.get("quickstarttitleplaceholderpost"))}}),auto:new t(p,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),invited:new t(d,{setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),errormsg:new t(v),newmubevent:new n(c)}),c.template='<div id="newmub"><div id="newmub-content"><form><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label></label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-newmubevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:mouseup, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:mousedown, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=60 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: mousedown, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: mousedown, press; listen:mouseup, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:mousedown, press; listen:mouseup, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>',c.place(document.getElementById("newmub")),c.reset=function(){var e={title:"",description:"",initiator:{id:g.get("_id"),username:g.get("username"),intro:g.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:g.get("active_deck"),status:"waiting",step:"",lang:g.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[]};h.reset(e),h.set("lang",g.get("lang")),h.set("deck",g.get("active_deck")),h.set("initiator",{id:g.get("_id"),username:g.get("username"),intro:g.get("intro")}),d.reset([]),v.set("errormsg",""),p.reset(g.get("connections").concat())},c.changeSessionMode=function(e,t){var n=t.selectedIndex,r=t.childNodes[n],i=r.getAttribute("name");p.reset(g.get("connections")),d.reset([]),h.set("mode",i)},c.displayAutoContact=function(e,t){document.getElementById("invitelistauto").classList.remove("invisible"),p.reset(g.get("connections").concat())},c.updateAutoContact=function(e,t){var n=JSON.parse(p.toJSON()),r=g.get("connections").concat(),s,o=t.value.toLowerCase();if(t.value==="")p.reset(r);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);p.reset(n)}p.loop(function(e,t){d.toJSON().search(e.contact.userid)>-1&&p.update(t,"selected",!0)})},c.close=function(e,t){t.parentNode.classList.add("invisible")},c.discardContact=function(e,t){var n=t.getAttribute("data-invited_id"),r=d.get(n).userid;d.alter("splice",n,1),p.loop(function(e,t){e.userid===r&&setTimeout(function(){p.update(t,"selected",!1)},200)}),c.unselectGroup(r)},c.select=function(e,t){var n=t.getAttribute("data-auto_id");p.get(n).selected?(c.removeContact(p.get(n)),setTimeout(function(){p.update(n,"selected",!1),document.getElementById("invitelistauto").classList.add("invisible")},200)):(c.addContact(p.get(n)),c.selectGroup(),setTimeout(function(){p.update(n,"selected",!0),document.getElementById("invitelistauto").classList.add("invisible")},200))},c.selectAll=function(e,t){t.classList.remove("pressed"),d.reset([]),p.reset(g.get("connections")),p.loop(function(e,t){p.update(t,"selected",!0),e.type==="user"&&d.alter("push",e)})},c.removeContact=function(e){if(e.type==="group")for(j=e.contacts.length-1;j>=0;j--)c.removeContact(e.contacts[j]);else d.loop(function(t,n){t.userid===e.userid&&d.alter("splice",n,1)}),c.unselectGroup(e.userid),p.loop(function(t,n){t.userid===e.userid&&p.update(n,"selected",!1)})},c.selectGroup=function(){var e,t=!1;p.loop(function(n,r){if(n.type==="group"&&!n.selected){e=n.contacts,t=!0;for(j=e.length-1;j>=0;j--)if(d.toJSON().search(e[j].userid)<0){t=!1;break}t&&p.update(r,"selected",!0)}})},c.unselectGroup=function(e){p.loop(function(t,n){t.type==="group"&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&p.update(n,"selected",!1)})},c.addContact=function(e){var t,n,r=!0;if(e.type==="user")d.alter("push",e);else for(t=0,n=e.contacts.length;t<n;t++)d.loop(function(n,i){n.userid===e.contacts[t].userid&&(r=!1)}),r&&(d.alter("push",e.contacts[t]),p.loop(function(n,r){n.userid===e.contacts[t].userid&&p.update(r,"selected",!0)}))},c.removeReadonly=function(e,t){t.removeAttribute("readonly")},c.press=function(e,t){t.classList.add("pressed")},c.clear=function(e,t){t.classList.remove("pressed"),c.reset()},c.create=function(e,t){t.classList.remove("pressed"),v.set("errormsg",""),h.get("title").length<3||h.get("description").length<3?v.set("errormsg",m.get("providesessioninfo")):h.get("mode")!=="roulette"&&g.get("connections").length<1?v.set("errormsg",m.get("nofriendtoinvite")):h.get("mode")==="boardroom"&&!d.getNbItems()?v.set("errormsg",m.get("inviteatleastone")):(t.classList.add("invisible"),b.spin(t.parentNode),c.uploadSession().then(function(){b.stop(),t.classList.remove("invisible"),c.reset()}))},c.createChat=function(e){var t=new r,n=(new Date).getTime(),i=new o;return t.setTransport(s.get("transport")),t.set("users",[{username:g.get("username"),userid:g.get("_id")}]),t.set("msg",[{user:"SYS",type:0,arg:0,time:n}]),t.set("sid",h.get("_id")),t.set("lang",h.get("lang")),t.set("readonly",!1),t.set("step",0),t.set("type",17),t.sync(s.get("db"),e).then(function(){return t.upload()}).then(function(){i.fulfill(),t.unsync()}),i},c.uploadSession=function(){var e=new r,t=new Date,n,i=h.get("chat")||[],u=new o;return h.set("_id","S:MU:"+t.getTime()),h.set("date",[t.getFullYear(),t.getMonth(),t.getDate()]),h.get("mode")==="boardroom"&&d.loop(function(e,t){h.get("invited").push(e.userid)}),h.get("mode")==="campfire"&&h.set("invited",a.getUserContactIds()),n=h.get("_id")+"_0",i.push(n),h.set("chat",i),e.reset(JSON.parse(h.toJSON())),e.setTransport(s.get("transport")),e.sync(s.get("db"),e.get("_id")).then(function(){return c.createChat(n)}).then(function(){return e.upload()}).then(function(){e.get("mode")==="boardroom"?(v.set("errormsg",m.get("sendinginvites")),c.sendInvites(e.get("invited"),e.get("_id"),e.get("title")).then(function(){s.get("observer").notify("start-mu_session",e.get("_id")),u.fulfill(),e.unsync()})):(s.get("observer").notify("start-mu_session",e.get("_id")),u.fulfill(),e.unsync())}),u},c.sendInvites=function(e,t,n){var r=new o,i=new Date,u={type:"INV",status:"unread",date:[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getMinutes()],author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:t,docTitle:n,dest:e};return s.get("transport").request("Notify",u,function(e){v.set("errormsg",m.get("invitesent")),r.fulfill()}),r},c.reset(),g.watchValue("lang",function(){var e=JSON.parse(h.toJSON()),t=JSON.parse(v.toJSON());h.reset({}),h.reset(e),v.reset({}),v.reset(t)}),c}}),define("brainstorm/multi/init/mupreview",["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min"],function(e,t,n,r,i,s,o,u,a){return function(){var u=new e,f=t.get("labels"),l=new n,c=new r({msg:""}),h=new r([]),p=(new a({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin(),d;return l.setTransport(t.get("transport")),u.plugins.addAll({labels:new i(f),model:new i(l,{setTitle:function(e){this.innerHTML=e,user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),user.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,n;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new o([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),participant:new i(h,{setAvatar:function(e){var t,n;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new o([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(c),previewevent:new s(u)}),u.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:mousedown, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button" data-labels="bind:innerHTML, joinbutton" data-previewevent="listen: mousedown, press; listen:mouseup, join"></div><div class="infopreview invisible" data-info="bind:innerHTML, msg"></div></div></div>',u.reset=function(e){document.getElementById("mupreview").classList.remove("invisible"),l.sync(t.get("db"),e).then(function(){h.reset(l.get("participants"))})},u.closePreview=function(e,t){u.dom.classList.add("invisible"),l.unsync(),l.reset(),d()},u.press=function(e,t){t.classList.add("pressed")},u.join=function(e,n){n.classList.add("invisible"),n.classList.remove("pressed"),p.spin(n.parentNode),t.get("observer").notify("join-musession",l.get("_id")),setTimeout(function(){p.stop(),u.dom.classList.add("invisible"),l.unsync(),l.reset()},15e3)},u.init=function(e){d=e},l.watchValue("participants",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");h.reset(e),e.length<3&&l.get("status")==="waiting"?(n.classList.remove("invisible"),r.classList.add("invisible")):(e.length===3&&l.get("status")==="waiting"&&c.set("msg",f.get("sessionfull")),n.classList.add("invisible"),r.classList.remove("invisible"))}),l.watchValue("status",function(e){var t=document.getElementById("mupreview"),n=t.querySelector(".start-button"),r=t.querySelector(".infopreview");e==="waiting"&&l.get("participants").length<3?(n.classList.remove("invisible"),r.classList.add("invisible")):(l.get("participants").length===3&&e==="waiting"&&c.set("msg",f.get("sessionfull")),e==="in progress"&&(c.set("msg",f.get("sessionstarted")),l.unsync()),e==="deleted"&&(c.set("msg",f.get("sessiondeleted")),l.unsync()),n.classList.add("invisible"),r.classList.remove("invisible"))}),SPIP=p,u}}),define("brainstorm/multi/init/mulist",["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,n,r,i,s,o,u,a,f,l){return function(c){var h=new e,p=i.get("labels"),d=i.get("user"),v=i.get("db"),m=i.get("transport"),g=new o([]),y=new o([]),b=new l,w=new o([]),E=new o({lang:[p.get("all")],modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"}),S="mulistall",x=u.getUserContactIds(),T=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200})).spin();return h.plugins.addAll({labels:new t(p),options:new t(E,{setLang:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t]+"</option>";this.innerHTML=r},setMode:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+p.get(e[t])+"</option>";this.innerHTML=r}}),muall:new t(g,{setParticipants:function(e){var t=e.length+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),musearch:new t(y,{setParticipants:function(e){var t=parseInt(e,10)+1,n,r="<ul>";for(n=0;n<t;n++)r+="<li></li>";r+="</ul>",this.innerHTML=r},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setLang:function(e){switch(e){case"fr-fr":this.setAttribute("style","background-image:url('img/flags/france.png');");break;default:this.setAttribute("style","background-image:url('img/flags/USA.png');")}this.innerHTML=" "}}),mupreview:new f({preview:b}),mulistevent:new n(h)}),h.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><select data-options="bind: setLang, lang" data-mulistevent="listen:change, filterLang"></select></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div id="noresult" class="invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',h.reset=function(){S="mulistall",T.spin(document.getElementById("mulistspinner")),E.set("selectedLang","all"),E.set("selectedMode","allmodes"),h.buildList(S).then(function(){T.stop()})},h.buildList=function(e,t){console.log("building list :",e,t);var n=[],r=new s;return e==="mulistall"&&(g.reset([]),h.addSessions(n,"roulette").then(function(){return console.log("roulette ok"),h.addSessions(n,"campfire")}).then(function(){return console.log("campfire ok"),h.addSessions(n,"boardroom")}).then(function(){console.log("after last query",n,h.dom.querySelector("#noresult")),n.length?h.dom.querySelector("#noresult").classList.add("invisible"):h.dom.querySelector("#noresult").classList.remove("invisible"),g.reset(n),r.fulfill()})),e==="musearch"&&(y.reset([]),h.syncSearch(n,t).then(function(){n.length?h.dom.querySelector("#noresult").classList.add("invisible"):h.dom.querySelector("#noresult").classList.remove("invisible"),y.reset(n),r.fulfill()})),r},h.syncSearch=function(e,t,n){var i=new s,o=new r;return o.setTransport(m),o.sync("_fti/local/"+v,"indexedsessions","waiting",{q:t,descending:!0}).then(function(){o.loop(function(t,r){var i=!1;t.fields.mode==="roulette"?i=!0:t.fields.mode==="campfire"&&x.indexOf(t.fields.initiator.id)>-1?i=!0:t.fields.mode==="boardroom"&&t.fields.invited.search(d.get("_id"))>-1&&(i=!0),i&&(n?t.fields.mode.search(n.mode)>-1&&t.fields.lang.search(n.lang)>-1&&e.push(t):e.push(t))}),i.fulfill()}),i},h.addSessions=function(e,t){var n=new s,o=new r,u="_view/"+t,a={};return o.setTransport(m),t==="roulette"?a={descending:!1,limit:50}:a={key:i.get("uid"),descending:!1},o.sync(v,"library",u,a).then(function(){console.log("query result for : ",t,o.toJSON()),o.loop(function(t,n){e.unshift(t)}),n.fulfill(),o.unsync()},function(e){console.log(e,t)}),n},h.search=function(e,t){e.keyCode===13&&(t.value===""?h.toggleList("mulistall"):h.toggleList("musearch"))},h.filterLang=function(e,t){var n=t.selectedIndex;n===0?E.set("selectedLang","all"):E.set("selectedLang",E.get("lang")[n]),T.spin(document.getElementById("mulistspinner")),h.filterList().then(function(){T.stop()})},h.filterMode=function(e,t){var n=t.selectedIndex;E.set("selectedMode",E.get("modes")[n]);switch(n){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}T.spin(document.getElementById("mulistspinner")),h.filterList().then(function(){T.stop()})},h.filterList=function(){var e=[],t=document.getElementById("mulist-content").querySelector("input").value,n=new s,r="",i="";return E.get("selectedMode")!=="allmodes"&&(r=E.get("selectedMode")),E.get("selectedLang")!=="all"&&(i=E.get("selectedLang")),r===""&&i===""?h.buildList(S,t).then(function(){n.fulfill()}):S==="mulistall"?(g.reset([]),r?h.addSessions(e,r,{lang:i}).then(function(){g.reset(e),e.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),n.fulfill()}):h.addSessions(e,"roulette",{lang:i}).then(function(){return h.addSessions(e,"campfire",{lang:i})}).then(function(){return h.addSessions(e,"boardroom",{lang:i})}).then(function(){g.reset(e),e.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),n.fulfill()})):(y.reset([]),h.syncSearch(e,t,{mode:r,lang:i}).then(function(){y.reset(e),e.length?document.getElementById("noresult").classList.add("invisible"):document.getElementById("noresult").classList.remove("invisible"),n.fulfill()})),n},h.zoom=function(e,t){var n;t.classList.add("pressed"),S==="mulistall"?(n=parseInt(t.getAttribute("data-muall_id"),10),b.reset(g.get(n).id)):S==="musearch"&&(n=t.getAttribute("data-musearch_id"),b.reset(y.get(n).id))},h.toggleList=function(e){e!==S&&(document.getElementById(S).classList.add("invisible"),document.getElementById(e).classList.remove("invisible"),S=e),T.spin(document.getElementById("mulistspinner")),h.filterList().then(function(){T.stop()})},h.refreshList=function(){h.toggleList(S)},m.request("GetLanguages",{},function(e){E.set("lang",[p.get("all")].concat(e))}),b.init(h.refreshList),d.watchValue("lang",function(){var e;E.set("modes",["allmodes","roulette","campfire","boardroom"]),e=E.get("lang"),e.splice(0,1,p.get("all")),E.set("lang",e)}),MUALL=g,MUSEARCH=y,MUOPTIONS=E,h}}),define("brainstorm/multi/mubinit",["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","service/config","Promise","Store","./init/newmub","./init/mulist"],function(e,t,n,r,i,s,o,u,a){return function(s){var o=new e,f=new u(s),l=new a(s),c=new t,h=i.get("labels");return o.plugins.addAll({labels:new n(h),muinitstack:c,muinitevent:new r(o)}),o.template='<div id="mub-init"><div id="muinitsliderlbl"><label data-labels="bind:innerHTML, startnewmub"></label><label data-labels="bind:innerHTML, joinmub"></label></div><input id="muinitslider" type="range" min="0" max="1" value ="1" data-muinitevent="listen: mouseup, toggleMode"><div class="exit-brainstorm" data-muinitevent="listen: mousedown, press; listen: mouseup, exit"></div><div class="stack" data-muinitstack="destination"></div></div>',o.place(document.getElementById("mub-init")),o.toggleMode=function(e,t){var n;t.value==="1"?n="new":n="list",c.getStack().show(n),c.getStack().get(n).reset()},o.press=function(e,t){t.classList.add("pressed")},o.exit=function(e,t){t.classList.remove("pressed"),s()},o.reset=function(){f.reset(),l.reset()},c.getStack().add("new",f),c.getStack().add("list",l),c.getStack().show("new"),o}}),define("brainstorm/multi/session/mubchat",["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(){var e=this,l=new r([]),c=new n,h=t.get("labels"),p=t.get("user"),d="null",v=(new a({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:20})).spin();c.setTransport(t.get("transport")),e.plugins.addAll({labels:new i(h),model:new i(c,{setReadonly:function(e){e?(this.setAttribute("contenteditable",!1),this.setAttribute("style","display:none;")):(this.setAttribute("style","disaply:table-cell;"),this.setAttribute("contenteditable",!0))},setHeight:function(e){e?this.classList.add("extended"):this.classList.remove("extended")}}),chat:new i(l,{setLiStyle:function(e){e===d?this.setAttribute("style","text-align: right;"):this.setAttribute("style","text-align: left;")},setInnerMsgStyle:function(e){e==="SYS"?this.setAttribute("style","background: none; border: none"):e===d?this.setAttribute("style","background: #9AC9CD; border: 1px solid #808080; border-radius: 5px;"):this.setAttribute("style","background: #E6E6E6; border: 1px solid #808080; border-radius: 5px;float: left;max-width: 556px;")},setTime:function(e){e&&(this.innerHTML=u.formatTime(e))},setAvatar:function(e){var t,n,r;e==="SYS"?(this.classList.remove("invisible"),this.classList.add("doctor-deedee")):e===d?this.classList.add("invisible"):typeof e=="number"&&(this.classList.remove("invisible"),t=document.createDocumentFragment(),r=c.get("users")[e].userid,n=new o([r]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setUserName:function(e){typeof e=="number"&&e!==d&&(this.innerHTML=" "+c.get("users")[e].username+h.get("said"))},setMsg:function(e){var t,n;e?(this.innerHTML=e,this.setAttribute("style","color: #292929; font-size: 14px;")):(this.setAttribute("style","color: #CCCCCC; font-size: 12px;"),t=this.getAttribute("data-chat_id"),n=l.get(t).type,n<=3?this.innerHTML=c.get("users")[l.get(t).arg].username+h.get("chatmsg"+n):n===5?this.innerHTML=h.get("chatmsg"+n)+h.get(l.get(t).arg):this.innerHTML=h.get("chatmsg"+n))}}),chatevent:new s(e)}),e.template='<div class="mubchat"><div id="chatspinner"></div><div class="chatread" data-model="bind:setHeight, readonly"><ul class="chatmessages" data-chat="foreach"><li data-chat="bind:setLiStyle, user"><div class="container" data-chat="bind:setAvatar, user"></div><div class="innerchatmsg" data-chat="bind:setInnerMsgStyle, user"><span class="time" data-chat="bind: setTime, time"></span><span class="username" data-chat="bind:setUserName, user"></span><br/><span class="chatmsg" data-chat="bind: setMsg, msg"></span></div></li></ul></div><div class="chatwrite placeholder" data-model="bind:setReadonly, readonly" data-labels="bind:innerHTML, typemsg" data-chatevent = "listen:mousedown, removePlaceholder; listen: keypress, post"></div></div>',e.removePlaceholder=function(e,t){t.innerHTML===h.get("typemsg")&&(t.innerHTML="",t.classList.remove("placeholder"))},e.post=function(t,n){var r,i,s;t.keyCode===13&&n.innerHTML!==""&&(r=(new Date).getTime(),i=c.get("msg"),l.alter("push",{user:d,time:r,msg:n.innerHTML}),s=l.getNbItems()-1,e.dom.querySelector("li[data-chat_id='"+s+"']").scrollIntoView(),i.push({user:d,time:r,msg:n.innerHTML}),c.set("msg",i),n.innerHTML=h.get("typemsg"),n.classList.add("placeholder"),n.blur(),c.upload())},e.setReadonly=function(){c.set("readonly",!0)},e.conclude=function(t){e.setReadonly(),e.setMessage(t)},e.setMessage=function(t,n){var r=(new Date).getTime(),i=c.get("msg"),s,o,u=new f;switch(t){case"start":o={user:"SYS",time:r,type:4};break;case"leave":o={user:"SYS",type:2,time:r,arg:d};break;case"next":o={user:"SYS",type:6,time:r};break;case"initStep":o={user:"SYS",type:5,time:r,arg:n};break;default:}return l.alter("push",o),s=l.getNbItems()-1,e.dom.querySelector("li[data-chat_id='"+s+"']").scrollIntoView(),i.push(o),c.set("msg",i),c.upload().then(function(){u.fulfill()}),u},e.clear=function(){l.reset([])},e.reset=function(n){var r=new f;return d="null",e.dom.querySelector(".chatwrite").classList.add("placeholder"),e.dom.querySelector(".chatwrite").innerHTML=h.get("typemsg"),c.unsync(),c.reset({}),l.reset([]),v.spin(e.dom.querySelector("#chatspinner")),c.sync(t.get("db"),n).then(function(){var t,n=c.get("users");for(t=0;t<n.length;t++)if(n[t].userid===p.get("_id")){d=t;break}isNaN(d)&&!c.get("readonly")?e.joinChat().then(function(){v.stop(),r.fulfill()}):(l.reset(c.get("msg")),v.stop(),r.fulfill())}),r},e.joinChat=function(){var e=new f,t=c.get("users"),n=t.length,r=(new Date).getTime(),i=c.get("msg");return t.push({username:p.get("username"),userid:p.get("_id")}),c.set("users",t),c.get("_id").search("_0")>-1&&(i.push({user:"SYS",time:r,type:1,arg:n}),c.set("msg",i),l.reset(i)),c.upload().then(function(){d=n,e.fulfill()}),e},e.leave=function(){var t=new f,n=null,r,i=c.get("users");return e.setMessage("leave").then(function(){for(r=0;r<i.length;r++)if(i[r].userid===p.get("_id")){n=r;break}return i.splice(n,1),c.set("users",i),c.upload()}).then(function(){t.fulfill(),c.unsync(),c.reset(),l.reset([])}),t},e.cancel=function(){c.remove(),c.unsync(),c.reset({}),l.reset([])},e.getModel=function(){return c},c.watchValue("msg",function(t){var n=t.length-1;l.reset(t),e.dom.querySelector("li[data-chat_id='"+n+"']").scrollIntoView()})}return function(){return l.prototype=new e,new l}}),define("brainstorm/multi/mubwait",["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(r,v){var m=new e,g=new n,y=new t,b=new t({msg:""}),w=u.get("user"),E=u.get("labels"),S=new p,x,T,N={listener:null},C,k=(new d({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306})).spin();return g.setTransport(u.get("transport")),m.plugins.addAll({labels:new i(E),model:new i(g,{setTitle:function(e){e&&(this.innerHTML=e),w.get("_id")===g.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),w.get("_id")===g.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,n;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new h([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},showStartButton:function(e){e&&e.length&&w.get("_id")===g.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new i(y,{setAvatar:function(e){var t,n;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new h([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),info:new i(b),place:new o({chat:S}),mubwaitevent:new s(m)}),m.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',m.place(document.getElementById("mubwait")),m.help=function(e,t){a.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},x=new l(m.dom),m.reset=function(e){S.clear(),g.unsync(),g.reset({}),y.reset([]),T=function(e){e?(w.set("sessionInProgress",""),w.upload(),g.get("initiator").id===w.get("_id")?m.cancelSession():m.leaveSession()):x.hide()},N.listener=f.exitListener("mubwait",m.leave),g.sync(u.get("db"),e).then(function(){g.get("initiator").id===w.get("_id")?x.reset(E.get("leaderleave"),T):x.reset(E.get("participantleave"),T),y.reset(g.get("participants")),S.reset(g.get("chat")[0]),w.set("sessionInProgress",{id:e,type:"musession",mode:"join"}),w.upload()})},m.leave=function(e){C=e.getAttribute("href")||e,x.show()},m.leaveSession=function(){var e=g.get("participants"),t;for(t=e.length-1;t>=0;t--)if(e[t].id===w.get("_id")){console.log("participant leaving : ",e[t].username),e.splice(t,1);break}g.set("participants",e),g.set("status","waiting"),g.upload().then(function(){return S.leave()}).then(function(){g.unsync(),g.reset({})}),m.goToScreen()},m.cancelSession=function(){var e=5e3;g.get("participants").length||(e=2e3),m.displayInfo("deleting",e).then(function(){g.remove(),m.goToScreen()})},m.displayInfo=function(e,t){var n,r=document.querySelector(".sessionmsg"),i=new c,s=function(){r.classList.add("invisible"),clearInterval(n),b.set("msg",""),i.fulfill()};return x.hide(),r.classList.remove("invisible"),n=setInterval(function(){e!=="deleting"?b.set("msg",e):b.set("msg",E.get("deletingsession")+t/1e3+"s"),t<=0&&s(),t-=1e3},1e3),e==="deleting"&&(g.set("status","deleted"),g.upload().then(function(){S.cancel()})),i},m.goToScreen=function(){var e;C.getAttribute&&C.getAttribute("data-notify_id")?(x.hide(),r(),u.get("observer").notify("goto-screen","#connect"),document.removeEventListener("mousedown",N.listener,!0),e=C.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(e,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){C===e&&(x.hide(),r(),u.get("observer").notify("goto-screen",e),document.removeEventListener("mousedown",N.listener,!0))}),y.reset([]),g.reset({})},m.checkUpdate=function(e,t){var n=t.getAttribute("name");e.keyCode===13&&(m.updateSession(n,t.innerHTML),t.blur())},m.updateField=function(e,t){var n=t.getAttribute("name");m.updateSession(n,t.innerHTML)},m.updateSession=function(e,t){g.get(e)!==t&&(g.set(e,t),g.upload())},m.press=function(e,t){t.classList.add("pressed")},m.start=function(e,t){var n=new Date,r=g.get("chat");S.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),k.spin(t.parentNode),g.set("status","in progress"),g.set("step","musetup"),g.set("startTime",n.getTime()),g.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),r.push(g.get("_id")+"_1"),g.set("chat",r),m.createChat(g.get("chat")[1]).then(function(){return g.upload()}).then(function(){document.removeEventListener("mousedown",N.listener,!0),g.unsync(),k.stop(),t.classList.remove("invisible"),v(g.get("_id"))})},m.createChat=function(e){var t=new n,r=(new Date).getTime(),i=new c;return t.setTransport(u.get("transport")),t.set("users",S.getModel().get("users")),t.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:r}]),t.set("sid",g.get("_id")),t.set("lang",g.get("lang")),t.set("readonly",!1),t.set("step",1),t.set("type",17),t.sync(u.get("db"),e).then(function(){return t.upload()}).then(function(){i.fulfill(),t.unsync()}),i},g.watchValue("status",function(e){e==="deleted"&&g.get("initiator").id!==w.get("_id")&&m.displayInfo(E.get("canceledbyleader"),2e3).then(function(){g.unsync(),r(),document.removeEventListener("mousedown",N.listener,!0)}),e==="in progress"&&g.get("initiator").id!==w.get("_id")&&(console.log("session in progress -- starting any moment now"),document.removeEventListener("mousedown",N.listener,!0),g.unsync(),v(g.get("_id")),g.reset({}),y.reset([]))}),g.watchValue("participants",function(e){y.reset(e)}),m}}),define("brainstorm/multi/session/mustart",["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","service/avatar","./mubchat","Store","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f,l){return function(c,h,p,d){var v=new e,m=i.get("user"),g=i.get("db"),y=i.get("labels"),b="step",w=new f([]),E=new a,S=(new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545})).spin();return v.plugins.addAll({labels:new n(y),model:new n(c,{setAvatar:function(e){var t,n;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new u([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")}}),participant:new n(w,{setAvatar:function(e){var t,n;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),n=new u([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),place:new l({chat:E}),mustartevent:new r(v)}),v.template='<div id = "mustart"><div class="previousbutton" data-mustartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-mustartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-mustartevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:innerHTML, title"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants"></label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div></form><div class="sessionchat" data-place="place:chat"></div><div>',v.place(t.get("mustart")),v.press=function(e,t){t.classList.add("pressed")},v.next=function(e,t){S.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),p("mustart")},v.prev=function(e,t){t.classList.remove("pressed"),h("quickstart")},v.toggleProgress=function(e,t){d()},v.reset=function(e){b="step",w.reset(c.get("participants")),E.reset(c.get("chat")[0]).then(function(){E.setReadonly(),e&&E.dom.querySelector(".chatread").classList.add("extended")})},v.help=function(e,t){s.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},c.watchValue("participants",function(e){w.reset(e)}),v}}),define("brainstorm/multi/session/musetup",["OObject","service/map","Bind.plugin","Place.plugin","Event.plugin","service/config","CouchDBDocument","Store","Promise","service/cardpopup","service/help","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(t,d,v,m,g){var y=new e,b,w=new p,E=s.get("labels"),S=s.get("transport"),x=s.get("db"),T=s.get("user"),N={},C=new u({timer:null,display:!1}),k,L=new u({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),A=new u({"char":{id:"",title:E.get("char"),pic:""},context:{id:"",title:E.get("context"),pic:""},problem:{id:"",title:E.get("problem"),pic:""}}),O={"char":0,context:0,problem:0},M=!0,_={"char":new u,context:new u,problem:new u},D="",P=null,H=0,B="step",j=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:337,left:490})).spin(),F={};return y.plugins.addAll({labels:new n(E),musetup:new n(L,{setReload:function(e){e===0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){B==="step"&&L.get("char").selected&&L.get("context").selected&&L.get("problem").selected&&T.get("_id")===t.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),musetuptimer:new n(C,{setTime:function(e){e&&(this.innerHTML=c.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),musetupcards:new n(A,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():this.innerHTML=e},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),place:new r({chat:w}),musetupevent:new i(y)}),y.template='<div id = "musetup"><div class="previousbutton" data-musetupevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="musetup-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, musetup" data-musetupevent="listen:mousedown, toggleProgress"></div><div class="timer" data-musetuptimer="bind:setTime, timer; bind: displayTimer, display" data-musetupevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-musetupevent="listen:mousedown, help"></div><div class="drawarea"><div class="decks"><div class="drawbutton drawchar" name="char" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind: setReload, char.left"></div><div class="drawbutton drawcontext" name="context" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, context.left"></div><div class="drawbutton drawproblem" name="problem" data-musetupevent="listen: mousedown, push; listen:mouseup, draw" data-musetup="bind:setReload, problem.left"></div></div><div class="cards"><div class="card char defaultcard" name="char" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, char.pic" data-musetup="bind: popup, char.popup"><div class="cardpicture" data-musetupcards="bind: setPic, char.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, char.title">Character</div></div><div class="card context defaultcard" name="context" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, context.pic" data-musetup="bind: popup, context.popup"><div class="cardpicture" data-musetupcards="bind: setPic, context.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, context.title">Context</div></div><div class="card problem defaultcard" name="problem" data-musetupevent="listen:mousedown, zoom" data-musetupcards="bind:removeDefault, problem.pic" data-musetup="bind: popup, problem.popup"><div class="cardpicture" data-musetupcards="bind: setPic, problem.pic"></div><div class="cardtitle" data-musetupcards="bind:formatTitle, problem.title">Problem</div></div></div><div class="confirmdraw"><div class="drawok" name="char" data-musetup="bind:setSelected, char.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="context" data-musetup="bind:setSelected, context.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="problem" data-musetup="bind:setSelected, problem.selected" data-musetupevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button invisible" data-labels="bind:innerHTML, nextbutton" data-musetupevent="listen: mousedown, press; listen:mouseup, next" data-musetup="bind:updateNext, char.selected;bind:updateNext, context.selected;bind:updateNext, problem.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,n){j.spin(n.parentNode),n.classList.add("invisible"),n.classList.remove("pressed"),B==="step"?(B="screen",d.set("characters",A.get("char")),d.set("contexts",A.get("context")),d.set("problems",A.get("problem")),clearInterval(k),C.set("display",!0),y.updateSessionScore(C.get("timer")).then(function(){return t.unsync(),t.sync(s.get("db"),t.get("_id"))}).then(function(){w.conclude("next"),t.set("elapsedTimers",{musetup:C.get("timer")}),t.set("characters",[A.get("char").id]),t.set("contexts",[A.get("context").id]),t.set("problems",[A.get("problem").id]),m("musetup")})):m("musetup")},y.stopSpinner=function(){j.stop()},y.help=function(e,t){l.setContent("musetuphelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},y.prev=function(e,t){t.classList.remove("pressed"),v("musetup")},y.toggleProgress=function(e,t){g()},y.toggleTimer=function(e,n){t.get("initiator").id===T.get("_id")&&C.set("display",!C.get("display"))},y.push=function(e,n){B!=="screen"&&T.get("_id")===t.get("initiator").id&&n.classList.add("pushed")},y.draw=function(e,n){var r=n.getAttribute("name"),i=L.get(r);_now=new Date,T.get("_id")===t.get("initiator").id&&B==="step"&&M&&(M=!1,i.left===0&&(N[r]=d.get("deck")[r].concat(),i.left=N[r].length,L.set(r,i)),i.selected?(M=!0,alert("please unlock selected card first")):i.selected===!1?y.drawCard(r).then(function(){var e=!1;n.classList.remove("pushed"),M=!0,L.loop(function(t,n){t.popup===!0&&(e=!0)}),e&&y.setPopup(r)}):(n.classList.remove("pushed"),M=!0))},y.pushOk=function(e,n){var r=F[n.getAttribute("name")]||null;T.get("_id")===t.get("initiator").id&&B==="step"&&(r?F[n.getAttribute("name")].spin(n):F[n.getAttribute("name")]=(new h).spin(n))},y.accept=function(e,n){var r=n.getAttribute("name"),i=L.get(r);B==="step"&&t.get("initiator").id===T.get("_id")&&(A.get(r).id?i.selected=!i.selected:i.selected=!1,t.unsync(),t.sync(s.get("db"),t.get("_id")).then(function(){return t.set("selected_"+r,i.selected),t.upload()}).then(function(){F[n.getAttribute("name")].stop(),selection.set(r,i)}))},y.zoom=function(e,t){var n=t.getAttribute("name");y.setPopup(n)},y.setPopup=function(e){var t={x:0,y:257},n="left",r=L.get(D)||"",i=L.get(e);r&&(r.popup=!1,L.set(D,r)),i.popup=!0,L.set(e,i),D=e,e==="char"&&(t.x=475),e==="context"&&(t.x=195,n="right"),e==="problem"&&(t.x=342,n="right"),_[e].getNbItems()&&b.reset(_[e].toJSON(),t,n,document.getElementById("musetup-popup"))},y.closePopup=function(){var e=L.get(D);e.popup=!1,L.set(D,e),D=""},b=new f(y.closePopup),y.getChatUI=function(){return w},y.initTimer=function(e){var n=new Date,r=n.getTime(),i=e||0;C.set("timer",i),t.get("step")==="musetup"&&(clearInterval(k),k=setInterval(function(){var e=new Date;C.set("timer",i+e.getTime()-r)},1e3))},y.reset=function(e){w.clear(),t.get("chat")[1]&&w.reset(t.get("chat")[1]),e?(B="screen",w.dom.querySelector(".chatread").classList.add("extended"),H=t.get("elapsedTimers").musetup||0,L.reset({"char":{selected:!0,left:1,popup:!1},context:{selected:!0,left:1,popup:!1},problem:{selected:!0,left:1,popup:!1}}),D="",C.set("timer",H),C.set("display",!0),t.get("characters").length&&y.getDeck(t.get("deck")).then(function(){return y.getCard(t.get("characters")[0],_.char)}).then(function(){var e=_.char;return A.set("char",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("characters",A.get("char")),y.getCard(t.get("contexts")[0],_.context)}).then(function(){var e=_.context;return A.set("context",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("contexts",A.get("context")),y.getCard(t.get("problems")[0],_.problem)}).then(function(){var e=_.problem;A.set("problem",{id:e.get("_id"),title:e.get("title"),pic:e.get("picture_file")}),d.set("problems",A.get("problem"))})):y.init()},y.getDeck=function(e){var t=new a,n=new o;return n.setTransport(S),n.sync(x,e).then(function(){var e,r={},i=s.get("user").get("lang");!n.get("default_lang")||n.get("default_lang")===i?e=JSON.parse(n.toJSON()):n.get("translations")&&n.get("translations")[i]?e=n.get("translations")[i]:e=JSON.parse(n.toJSON()),r.char=e.content.characters,r.context=e.content.contexts,r.problem=e.content.problems,r.techno=e.content.techno,d.set("deck",r),t.fulfill(),n.unsync()}),t},y.getCard=function(e,t){var n=new a,r=new o;return r.setTransport(S),r.sync(x,e).then(function(){t.reset(JSON.parse(r.toJSON())),n.fulfill(),r.unsync()}),n},y.drawCard=function(e){var n=new a,r=Math.floor(Math.random()*N[e].length),i=N[e][r];return t.set("drawn_"+e,i),t.upload().then(function(){O[e]++,N[e].splice(r,1),n.fulfill()}),n},y.updateDrawnCard=function(e,t){var n,r,i=new a;return e&&t&&(n=L.get(e),r=A.get(e),y.getCard(t,_[e]).then(function(){var s=_[e];r.id=t,r.title=s.get("title"),r.pic=s.get("picture_file"),A.set(e,r),n.left=N[e].length,L.set(e,n),i.fulfill()})),i},y.updateSessionScore=function(e){var n=new a,r={sid:t.get("_id"),step:"musetup",time:e,cards:O.char+O.context+O.problem};return console.log("before transport request : ",r),S.request("UpdateSessionScore",r,function(e){console.log(e),e.res==="ok"?n.fulfill():n.reject()}),n},y.init=function(){A.reset({"char":{id:"",title:E.get("char"),pic:""},context:{id:"",title:E.get("context"),pic:""},problem:{id:"",title:E.get("problem"),pic:""}}),L.reset({"char":{selected:!1,left:null,popup:!1},context:{selected:!1,left:null,popup:!1},problem:{selected:!1,left:null,popup:!1}}),O.char=0,O.context=0,O.problem=0,_={"char":new u,context:new u,problem:new u},D="",T.get("_id")===t.get("initiator").id?y.getDeck(t.get("deck")).then(function(){var e=d.get("deck");N.char=e.char.concat(),N.context=e.context.concat(),N.problem=e.problem.concat(),M=!0,y.initTimer()}):C.set("display",!1),B="step"},t.watchValue("drawn_char",function(e){e&&y.updateDrawnCard("char",e)}),t.watchValue("drawn_context",function(e){e&&y.updateDrawnCard("context",e)}),t.watchValue("drawn_problem",function(e){e&&y.updateDrawnCard("problem",e)}),t.watchValue("selected_char",function(e){var t;t=L.get("char"),t.selected=e,L.set("char",t),e&&d.set("characters",A.get("char"))}),t.watchValue("selected_context",function(e){var t;t=L.get("context"),t.selected=e,L.set("context",t),e&&d.set("contexts",A.get("context"))}),t.watchValue("selected_problem",function(e){var t;t=L.get("problem"),t.selected=e,L.set("problem",t),e&&d.set("problems",A.get("problem"))}),t.watchValue("elapsedTimers",function(e){e.musetup&&(C.set("timer",e.musetup),C.set("display",!0))}),y}}),define("brainstorm/multi/session/muscenario",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../../whiteboard/whiteboard","Promise","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(d,v,m,g,y){var b=new e,w,E,S=new p,x=s.get("labels"),T=s.get("user"),N=s.get("db"),C=new o,k=new o,L=new o,A=new o({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),O={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},M=new o(O),_=new o({timer:null,display:!1}),D,P,H=new o({title:"",story:"",solution:""}),B=new o([]),j=new f("scenario",B,M,"mu"),F,I=0,q="step",R=s.get("transport"),U=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670})).spin();return b.isLeader=function(){return d.get("initiator")&&d.get("initiator").id===T.get("_id")},b.plugins.addAll({labels:new n(x,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new n(A,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(M,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){b.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showStory:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),muscenariotimer:new n(_,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new n(H),wbstack:j,place:new i({chat:S}),muscenarioevent:new r(b)}),b.template='<div id = "muscenario"><div class="previousbutton" data-muscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muscenario" data-muscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-muscenarioevent="listen:mousedown,toggleTimer"></div><div id="muscenario-left"><div class="scenario-cards leftarea folded" data-muscenarioevent="listen:mousedown, fold"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div><div class="caret"></div></div><div id="muscenario-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard" data-muscenarioevent = "listen:mousedown, toggleView"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muscenarioevent="listen:mousedown, toggleCaret"></div></div><div id = "muscenario-writeup" class="writeup invisible" data-wbtools="bind: showStory,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',b.place(t.get("muscenario")),b.press=function(e,t){t.classList.add("pressed")},b.isLeader=function(){return d.get("initiator")&&d.get("initiator").id===T.get("_id")},b.next=function(e,t){U.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),q==="step"?(q="screen",M.set("readonly",!0),clearInterval(D),_.set("display",!0),clearInterval(P),v.set("scenario",JSON.parse(H.toJSON())),d.unsync(),d.sync(N,d.get("_id")).then(function(){var e;return S.conclude("next"),e=d.get("elapsedTimers"),e.muscenario=_.get("timer"),d.set("elapsedTimers",e),d.set("scenario",[v.get("scenario")]),d.upload()}).then(function(){return b.updateSessionScore(_.get("timer"))}).then(function(){g("muscenario")})):g("muscenario")},b.stopSpinner=function(){U.stop()},b.prev=function(e,t){t.classList.remove("pressed"),m("muscenario")},b.toggleProgress=function(e,t){y()},b.toggleTimer=function(e,t){b.isLeader()&&_.set("display",!_.get("display"))},b.push=function(e,t){var n=t.getAttribute("name");M.set(n,"active")},b.zoom=function(e,t){e.stopPropagation();var n=t.getAttribute("name");b.setPopup(n)},b.fold=function(e,t){d.get("scReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),E&&w.close())},b.setPopup=function(e){var t={x:240,y:130},n="left",r=A.get(e),i=M.get("cardpopup"),s="",o;E&&(i[E]=!1),i[e]=!0,M.set("cardpopup",i),E=e,e==="char"&&(t.y=120,r.id===C.get("_id")&&(s=C.toJSON())),e==="context"&&(t.y=290,r.id===k.get("_id")&&(s=k.toJSON())),e==="problem"&&(t.y=350,r.id===L.get("_id")&&(s=L.toJSON())),s?w.reset(s,t,n,document.getElementById("muscenario-popup")):(o=new u,o.setTransport(R),o.sync(N,r.id).then(function(){s=o.toJSON(),w.reset(s,t,n,document.getElementById("muscenario-popup")),e==="char"&&C.reset(JSON.parse(o.toJSON())),e==="context"&&k.reset(JSON.parse(o.toJSON())),e==="problem"&&L.reset(JSON.parse(o.toJSON()))}))},b.closePopup=function(){var e=M.get("cardpopup");e[E]=!1,M.set("cardpopup",e),E=""},w=new a(b.closePopup),b.getChatUI=function(){return S},b.post=function(e,t){j.selectScreen("postit"),M.set("import","inactive"),M.set("drawing","inactive")},b.importpic=function(e,t){j.selectScreen("import"),M.set("postit","inactive"),M.set("drawing","inactive")},b.draw=function(e,t){j.selectScreen("drawing"),M.set("import","inactive"),M.set("postit","inactive")},b.exitTool=function(e){M.set(e,"inactive")},b.finish=function(e,t){var n=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50})).spin();n.spin(t.parentNode),t.classList.add("invisible"),d.unsync(),d.sync(N,d.get("_id")).then(function(){return d.set("scReady",!0),d.upload()}).then(function(){n.stop(),t.classList.remove("pressed"),M.set("ready",!1),b.displayStory(),b.updateScenario()})},b.updateField=function(e,t){t.classList.contains("enterTitle")&&H.set("title",t.value),t.classList.contains("enterDesc")&&H.set("story",t.value),t.classList.contains("enterSol")&&H.set("solution",t.value)},b.displayStory=function(){j.setReadonly(!0),M.set("showstory",!0),b.dom.querySelector(".scenario-cards").classList.remove("folded"),b.dom.querySelector(".scenario-cards .caret").classList.add("invisible"),b.dom.querySelector(".writeup").scrollIntoView(),b.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},b.hideStory=function(){b.dom.querySelector(".scenario-cards").classList.add("folded"),b.dom.querySelector(".scenario-cards .caret").classList.remove("invisible"),b.dom.querySelector(".whiteboard .caret").classList.add("invisible")},b.toggleCaret=function(e,t){e.stopPropagation();var n=b.dom.querySelector(".writeup"),r=b.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?n.scrollIntoView():r.scrollIntoView()},b.toggleView=function(e,t){var n=t.querySelector(".caret"),r=b.dom.querySelector(".writeup"),i=b.dom.querySelector(".whiteboard");n.classList.contains("descending")?(n.classList.remove("descending"),i.scrollIntoView()):e.pageY-t.scrollHeight>0&&(n.classList.add("descending"),r.scrollIntoView())},b.updateScenario=function(){P=setInterval(function(){var e=d.get("scenario")[0]||{title:"",story:"",solution:""},t=e.title,n=e.story,r=e.solution,i={};if(H.get("title")!==t||H.get("story")!==n||H.get("solution")!==r)i.title=H.get("title"),i.story=H.get("story"),i.solution=H.get("solution"),d.set("scenario",[i]),d.upload().then(function(e){return console.log("scenario updated in CouchDB"),!0},function(e){console.log("failed to update scenario",e)})},8e3)},b.updateSessionScore=function(e){var t=new l,n={sid:d.get("_id"),step:"muscenario",time:e,wbcontent:B.toJSON(),scenario:H.toJSON()};return R.request("UpdateSessionScore",n,function(e){console.log(e),e.res==="ok"?(d.unsync(),d.sync(N,d.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},b.reset=function(e){S.clear(),d.get("chat")[2]&&S.reset(d.get("chat")[2]),M.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),j.setSessionId(d.get("_id")),B.reset(d.get("scenarioWB")),B.getNbItems()?j.selectScreen("main"):j.selectScreen("default"),e||d.get("scenario").length?(q="screen",S.dom.querySelector(".chatread").classList.add("extended"),M.set("ready",!1),b.displayStory(),M.set("readonly",!0),M.set("shownext",!1),H.reset(d.get("scenario")[0]),v.set("scenario",d.get("scenario")[0])):(H.reset({title:"",story:"",solution:""}),B.getNbItems()?M.set("ready",!0):M.set("ready",!1),j.setReadonly(!1),b.hideStory(),q="step"),d.get("elapsedTimers").muscenario&&(I=d.get("elapsedTimers").muscenario,_.set("timer",I),q==="screen"?_.set("display",!0):b.isLeader()&&b.initTimer(I))},b.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;_.set("display",!1),_.set("timer",r),d.get("step")==="muscenario"&&(clearInterval(D),D=setInterval(function(){var e=new Date;_.set("timer",r+e.getTime()-n)},1e3))},v.watchValue("characters",function(e){A.set("char",e)}),v.watchValue("contexts",function(e){A.set("context",e)}),v.watchValue("problems",function(e){A.set("problem",e)}),d.watchValue("_id",function(e){j.setSessionId(e)}),d.watchValue("chat",function(e){e.length===3&&S.getModel().get("_id")!==e[2]&&S.reset(e[2])}),["added","deleted","updated"].forEach(function(e){B.watch(e,function(e){if(!M.get("showstory")){if(d.get("scenarioWB").length!==B.getNbItems()||JSON.stringify(d.get("scenarioWB"))!==B.toJSON())d.set("scenarioWB",JSON.parse(B.toJSON())),d.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)});B.getNbItems()&&q==="step"?M.set("ready",!0):M.set("ready",!1)}})}),d.watchValue("scenarioWB",function(e){d.get("step")==="muscenario"&&!M.get("showstory")&&(e.length&&j.getStack().getCurrentName()==="default"&&j.selectScreen("main"),e.length||j.selectScreen("default"),(e.length!==B.getNbItems()||JSON.stringify(e)!==B.toJSON())&&B.reset(e))}),d.watchValue("scReady",function(e){d.get("step")==="muscenario"&&e&&!b.isLeader()&&(M.set("readonly",!0),b.displayStory())}),d.watchValue("scenario",function(e){b.isLeader()||(H.reset(e[0]),v.set("scenario",JSON.parse(H.toJSON())))}),H.watch("updated",function(){b.isLeader()&&H.get("title")&&H.get("story")&&H.get("solution")?M.set("shownext",!0):M.set("shownext",!1)}),SCWHITEB=j,SCCONTENT=B,SC=H,b}}),define("brainstorm/multi/session/mutech",["OObject","service/map","Place.plugin","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min","./mubchat"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return function(d,v,m,g,y){var b=new e,w=null,E=null,S,x=new u({timer:null,display:!1}),T=s.get("transport"),N=s.get("user"),C=s.get("db"),k=s.get("labels"),L,A,O=new p,M=new u({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),_=[],D=!0,P=new u,H=new u,B=new u,j={tech1:P,tech2:H,tech3:B},F=0,I=new u([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),q="step",R=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:336,left:481})).spin(),U={};return b.isLeader=function(){return d.get("initiator")&&d.get("initiator").id===N.get("_id")},b.plugins.addAll({labels:new r(k),display:new r(M,{setReload:function(e){!e&&F>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(e){b.isLeader()&&M.get("tech1").selected&&M.get("tech2").selected&&M.get("tech3").selected&&q==="step"?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new r(I,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){e?this.innerHTML=e.toUpperCase():this.innerHTML=k.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),mutechtimer:new r(x,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),place:new n({chat:O}),mutechevent:new i(b)}),b.template='<div id = "mutech"><div class="previousbutton" data-mutechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="mutech-popup" class="invisible"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, mutech" data-mutechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-mutechtimer="bind:setTime, timer; bind: displayTimer, display" data-mutechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-mutechevent="listen:mousedown, help"></div><div id="mutech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-mutechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-mutechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-mutechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',b.place(t.get("mutech")),b.press=function(e,t){t.classList.add("pressed")},b.next=function(e,t){var n=new Date,r=n.getTime()-w;R.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),q==="step"?(q="screen",v.set("techno",I),clearInterval(S),x.set("display",!0),b.updateSessionScore(x.get("timer")).then(function(){d.unsync(),d.sync(C,d.get("_id")).then(function(){var e=d.get("elapsedTimers");O.conclude("next"),e.mutech=x.get("timer"),d.set("elapsedTimers",e),d.set("techno",[[I.get(0).id,I.get(1).id,I.get(2).id]]),g("mutech")})})):g("mutech")},b.stopSpinner=function(){R.stop()},b.help=function(e,t){o.setContent("mutechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},b.prev=function(e,t){t.classList.remove("pressed"),m("mutech")},b.toggleProgress=function(e,t){y()},b.toggleTimer=function(e,t){b.isLeader()&&x.set("display",!x.get("display"))},b.select=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||F>0||q==="screen")&&t.classList.add("highlighted")},b.zoom=function(e,t){var n=t.getAttribute("name");(n.search("tech")<0||F>0||q==="screen")&&b.setPopup(n)},b.setPopup=function(e){var t={x:0,y:257},n="left",r=M.get(A)||"",i=new u,s,o=M.get(e);r&&(r.popup=!1,M.set(A,r)),o.popup=!0,M.set(e,o),A=e,e==="scenario"?(t.x=240,t.y=275,i.reset(d.get("scenario")[0]),i.set("type",5),s=i.toJSON()):(e==="tech1"&&(t.x=560),e==="tech2"&&(t.x=279,n="right"),e==="tech3"&&(t.x=426,n="right"),j[e].get("_id")&&(s=j[e].toJSON())),s&&L.reset(s,t,n,document.getElementById("mutech-popup"))},b.closePopup=function(){var e=M.get(A);e.popup=!1,M.set(A,e),A=""},b.push=function(e,t){var n=t.getAttribute("name");t.classList.contains("drawok")?j[n].get("_id")&&q==="step"&&b.isLeader()&&t.classList.add("pushed"):t.classList.add("pushed")},b.draw=function(e,t){var n=[];b.isLeader()&&q==="step"&&D?(D=!1,["tech1","tech2","tech3"].forEach(function(e){M.get(e).selected||n.push(e)}),b.drawTech(n).then(function(){t.classList.remove("pushed"),D=!0})):t.classList.remove("pushed")},b.drawTech=function(e){var t,n=[],r=new f,i=new u({count:e.length});return e.length?(e.forEach(function(e){_.length<=0&&(_=v.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){M.get(e).selected&&n.push(I.get(t).id)}),_.filter(function(e){return!(n.indexOf(e)>-1)})),t=Math.floor(Math.random()*_.length),b.getCardDetails(_[t],e).then(function(){var e=i.get("count");e--,i.set("count",e)}),M.set("left",_.length),F++,_.splice(t,1)}),i.watchValue("count",function(e){e||(d.unsync(),d.sync(C,d.get("_id")).then(function(){return["tech1","tech2","tech3"].forEach(function(e,t){d.set("drawn"+e,I.get(t).id)}),d.upload()}).then(function(){r.fulfill()}))})):r.fulfill(),DRS=i,r},b.getCardDetails=function(e,t){var n=new a,r=["tech1","tech2","tech3"],i=r.indexOf(t),s=new f;return n.setTransport(T),n.sync(C,e).then(function(){j[t].reset(JSON.parse(n.toJSON())),I.update(i,"id",e),I.update(i,"title",n.get("title")),I.update(i,"pic",n.get("picture_file")),s.fulfill(),n.unsync()}),s},b.pushOk=function(e,t){var n=U[t.getAttribute("name")]||null;b.isLeader()&&q==="step"&&(n?U[t.getAttribute("name")].spin(t):U[t.getAttribute("name")]=(new h).spin(t))},b.accept=function(e,t){var n=t.getAttribute("name"),r=["tech1","tech2","tech3"],i=r.indexOf(n),s=M.get(n);q==="step"&&b.isLeader()&&(I.get(i)&&I.get(i).id?s.selected=!s.selected:s.selected=!1,d.unsync(),d.sync(C,d.get("_id")).then(function(){return d.set("selected_"+n,s.selected),d.upload()}).then(function(){U[t.getAttribute("name")].stop(),M.set(n,s)}))},b.reset=function(e){var t=d.get("techno")[0];O.clear(),d.get("chat")[3]&&O.reset(d.get("chat")[3]),M.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),e||t.length?(q="screen",O.dom.querySelector(".chatread").classList.add("extended"),b.getCardDetails(t[0],"tech1").then(function(){return b.getCardDetails(t[1],"tech2")}).then(function(){return b.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){M.set(e,{popup:!1,selected:!0})}),v.set("techno",I)})):(_=[],F=0,q="step",P.reset(),H.reset(),B.reset(),I.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),d.get("elapsedTimers").mutech&&(E=d.get("elapsedTimers").mutech,x.set("timer",E),q==="screen"?x.set("display",!0):b.isLeader()&&b.initTimer(E))},b.updateSessionScore=function(e){var t=new f,n={sid:d.get("_id"),step:"mutech",time:e,cards:F};return T.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.fulfill():t.reject()}),t},b.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;x.set("display",!1),x.set("timer",r),d.get("step")==="mutech"&&(clearInterval(S),S=setInterval(function(){var e=new Date;x.set("timer",r+e.getTime()-n)},1e3))},L=new l(b.closePopup),b.getChatUI=function(){return O},d.watchValue("chat",function(e){e.length===4&&O.getModel().get("_id")!==e[3]&&O.reset(e[3])}),v.watchValue("deck",function(e){_=e.techno.concat(),M.set("left",_.length)}),["tech1","tech2","tech3"].forEach(function(e){d.watchValue("drawn"+e,function(t){b.isLeader()||b.getCardDetails(t,e)}),d.watchValue("selected_"+e,function(t){var n;b.isLeader()||(n=M.get(e),n.selected=t,M.set(e,n),t&&v.set("techno",I))})}),b}}),define("brainstorm/multi/session/muvote",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var u=new e,a=i.get("labels"),f=new s,l=i.get("user"),c=null,h=!1,p;return u.plugins.addAll({label:new n(a),model:new n(f,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setButton:function(e){e?this.setAttribute("style","display: inline-block;"):this.setAttribute("style","display:none;")},displayVote:function(e){var t=this.getAttribute("name"),n=f.get(t+"Votes"),r=this.querySelector(".yesvote"),i=this.querySelector(".novote");e?n.indexOf(l.get("_id"))>-1?i.classList.add("invisible"):r.classList.add("invisible"):(r.classList.remove("invisible"),i.classList.remove("invisible"))},setResult:function(e){e?this.innerHTML=a.get(e):this.innerHTML=""}}),event:new r(u)}),u.template='<div class = "confirm invisible"><legend><span data-label="bind:innerHTML, decidemsg"></span><span class="unanimity" data-label="bind: innerHTML, unanimity"></span></legend><div class="votingitem invisible" name="public" data-model="bind:setVisible,public; bind: displayVote, publicVote"><div class="sessionquestion" data-label="bind:innerHTML,setpublic"></div><div class = "votingbuttons" name="public"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, publicResult"></div></div><div class="votingitem invisible" name = "replay" data-model="bind:setVisible,replay; bind: displayVote, replayVote"><div class="sessionquestion" data-label="bind:innerHTML,enablereplay"></div><div class = "votingbuttons" name="replay"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, replayResult"></div></div><div id="muvotespinner"></div><div class="option left votebutton" data-event="listen:mousedown, press; listen:mouseup, submit" data-model="bind:setButton, submit" data-label="bind: innerHTML, submitlbl">Submit</div><div class="option right votebutton" data-event="listen:mousedown, press; listen:mouseup, skip" data-model="bind:setButton, skip" data-label="bind:innerHTML, skiplbl">Skip</div></div>',u.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},u.push=function(e,t){var n=t.parentNode,r=n.getAttribute("name");!f.get(r+"Vote")&&!f.get(r+"Result")&&t.setAttribute("style","-webkit-box-shadow: 0px 0px 2px #657B99;")},u.vote=function(e,t){var n=t.parentNode,r=n.getAttribute("name");t.setAttribute("style","-webkit-box-shadow: none;");if(f.get("leader"))t.classList.toggle("voted"),t.classList.contains("yesvote")?t.classList.contains("voted")?(f.set(r+"Votes",[l.get("_id")]),n.querySelector(".novote").classList.remove("voted")):f.set(r+"Votes",[]):(n.querySelector(".yesvote").classList.remove("voted"),f.set(r+"Votes",[])),!f.get("publicVotes").length&&!f.get("replayVotes").length?f.set("submit",!1):f.set("submit",!0);else if(!f.get(r+"Vote")){var i=f.get(r+"Votes");t.classList.contains("novote")?(r==="public"&&f.set("publicResult","rejected"),r==="replay"&&f.set("replayResult","rejected")):(i.push(l.get("_id")),f.set(r+"Votes",i),i.length===c.get("participants").length+1&&(r==="public"&&f.set("publicResult","accepted"),r==="replay"&&f.set("replayResult","accepted"))),t.classList.add("voted"),f.set(r+"Vote",!0),h?setTimeout(u.uploadVote,3e3):u.uploadVote()}},u.uploadVote=function(){var e;f.get("leader")||(e=c.get("vote"),h=!0,e.public&&(e.publicVotes=f.get("publicVotes"),e.publicResult=f.get("publicResult")),e.replay&&(e.replayVotes=f.get("replayVotes"),e.replayResult=f.get("replayResult")),c.set("vote",e),c.upload().then(function(){console.log("upload ok"),h=!1},function(e){console.log(e)}))},u.submit=function(e,t){var n={};t.classList.remove("pressed"),f.set("skip",!1),f.set("submit",!1),["public","replay"].forEach(function(e){f.get(e+"Votes").length?(n[e]=!0,n[e+"Votes"]=[l.get("_id")]):f.get(e+"Vote")?f.set(e+"Result","rejected"):f.set(e,!1),f.set(e+"Vote",!0)}),c.set("vote",n),c.upload().then(function(){console.log("VOTE : leader upload successful")},function(e){console.log(e)})},u.skip=function(e,t){t&&t.classList.remove("pressed"),u.close(),p({visibility:"private",replay:!1})},u.close=function(){t.get("cache").classList.remove("votingcache"),u.dom.classList.add("invisible"),c=null},u.isActive=function(){return c!==null},u.show=function(){t.get("cache").classList.add("votingcache"),u.dom.classList.remove("invisible")},u.reset=function(e,n){var r;c=e,p=n,f.reset({}),c.get("vote")&&f.reset(c.get("vote")),c.get("initiator").id===l.get("_id")?(f.set("leader",!0),f.set("submit",!1),f.set("skip",!0),["public","replay"].forEach(function(e){f.set(e,!0),f.set(e+"Vote",!1),f.set(e+"Votes",[]),f.set(e+"Result","")})):(f.set("leader",!1),f.set("submit",!1),f.set("skip",!1)),f.set("publicVote",!1),f.set("replayVote",!1),u.show(),r=c.watchValue("vote",function(e){var n={},i=new o({lines:10,length:8,width:4,radius:8,top:10});exitVote=function(){c.unwatch(r),i.spin(u.dom.querySelector("#muvotespinner")),setTimeout(function(){i.stop(),t.get("cache").classList.remove("votingcache"),p&&p(n)},5e3)},e&&e.public&&e.replay?(f.set("publicResult",e.publicResult),f.set("replayResult",e.replayResult),e.publicResult&&e.replayResult&&(e.publicResult==="accepted"?n.visibility="public":n.visibility="private",e.replayResult==="accepted"?n.replay=!0:n.replay=!1,exitVote())):e&&e.public?(f.set("publicResult",e.publicResult),n.replay=!1,e.publicResult&&(e.publicResult==="accepted"?n.visibility="public":n.visibility="private",n.replay=!1,exitVote())):e&&e.replay&&(f.set("replayResult",e.replayResult),n.visibility="private",e.replayResult&&(e.replayResult==="accepted"?n.replay=!0:n.replay=!1,exitVote()))})},VOTE=f,VOTEUI=u,u}}),define("brainstorm/multi/session/muidea",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/cardpopup","../../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min","./mubchat","./muvote"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){return function(v,m,g,y,b){var w=new e,E,S,x=new p,T=new d,N="step",C,k=0,L,A,O=new a({timer:null,display:!1}),M=new a({title:"",description:"",solution:"",visibility:"private"}),_=new a,D=new a([]),P=[],H={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},B=new a(H),j=new a([]),F=new u("idea",j,B,"mu"),I=s.get("transport"),q=s.get("user"),R=s.get("db"),U=s.get("labels"),z=!1,W=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670})).spin();return w.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===q.get("_id")},w.plugins.addAll({labels:new n(U,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(_),techs:new n(D,{setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(B,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){w.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showIdea:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),muideatimer:new n(O,{setTime:function(e){this.innerHTML=c.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(M),wbstack:F,place:new i({chat:x,vote:T}),muideaevent:new r(w)}),w.template='<div id = "muidea"><div class="previousbutton" data-muideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muidea" data-muideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muideatimer="bind:setTime, timer; bind: displayTimer, display" data-muideaevent="listen:mousedown,toggleTimer"></div><div id="muidea-left"><div class="idea-cards leftarea folded" data-muideaevent="listen:mousedown, fold"><div class="card defaultscenario" name="scenario" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul><div class="caret"></div></div><div id="muidea-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muideaevent="listen:mousedown, toggleCaret"></div></div><div id = "muidea-writeup" class="writeup invisible" data-wbtools="bind: showIdea,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionvote" data-place="place:vote"></div><div class="sessionchat" data-place="place:chat"></div></div>',w.place(t.get("muidea")),w.press=function(e,t){t.classList.add("pressed")},w.next=function(e,t){var n=new Date,r,i,s,o,u=new l;t.classList.add("invisible"),t.classList.remove("pressed"),N==="step"?(N="screen",B.set("readonly",!0),clearInterval(L),O.set("display",!0),clearInterval(A),i=w.getSessionDuration(),T.reset(v,function(e){z=!0,s=e.visibility,o=e.replay,M.set("visibility",s),M.set("sessionReplay",o),u.fulfill(),T.close()}),u.then(function(){return W.spin(t.parentNode),m.set("idea",JSON.parse(M.toJSON())),w.createIdeaDoc()}).then(function(){return v.unsync(),v.sync(R,v.get("_id"))}).then(function(){var e=v.get("elapsedTimers");return x.conclude("next"),e.muidea=O.get("timer"),v.set("idea",[JSON.parse(M.toJSON())]),o&&v.set("replayIdeas",[]),v.set("elapsedTimers",e),v.set("duration",i),v.set("status","completed"),v.set("idea",[m.get("idea")]),v.upload()}).then(function(){return w.updateSessionScore(O.get("timer"))}).then(function(){y("muidea")})):y("muidea")},w.stopSpinner=function(){W.stop()},w.prev=function(e,t){t.classList.remove("pressed"),g("muidea")},w.toggleProgress=function(e,t){b()},w.toggleTimer=function(e,t){w.isLeader()&&O.set("display",!O.get("display"))},w.toggleVisibility=function(e,t){N==="step"&&w.isLeader()&&(M.get("visibility")==="public"?M.set("visibility","private"):M.set("visibility","public"))},w.push=function(e,t){var n=t.getAttribute("name");B.set(n,"active")},w.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),w.setPopup(n,r)},w.fold=function(e,t){v.get("ideaReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),S&&E.close())},w.setPopup=function(e,t){var n={x:240,y:30},r="left",i=B.get("cardpopup"),o=new a,u="",l,c;S&&(S.type==="scenario"?i.scenario=!1:i.techs[S.id]=!1,B.set("cardpopup",i)),e==="scenario"?i.scenario=!0:i.techs[t]=!0,B.set("cardpopup",i),S={type:e,id:t},e==="scenario"?(n.y=55,o.reset(m.get("scenario")),o.set("type",5),u=o.toJSON(),E.reset(u,n,r,document.getElementById("muidea-popup"))):(t==0&&(n.y=200),t==1&&(n.y=260),t==2&&(n.y=350),P[t]?(u=P[t],E.reset(u,n,r,document.getElementById("muidea-popup"))):(c=new f,c.setTransport(I),c.sync(s.get("db"),m.get("techno").get(t).id).then(function(){u=c.toJSON(),E.reset(u,n,r,document.getElementById("muidea-popup")),P[t]=u})))},w.closePopup=function(){var e=B.get("cardpopup");e[S]=!1,B.set("cardpopup",e),S=""},E=new o(w.closePopup),w.getChatUI=function(){return x},w.post=function(e,t){F.selectScreen("postit"),B.set("import","inactive"),B.set("drawing","inactive")},w.importpic=function(e,t){F.selectScreen("import"),B.set("postit","inactive"),B.set("drawing","inactive")},w.draw=function(e,t){F.selectScreen("drawing"),B.set("import","inactive"),B.set("postit","inactive")},w.exitTool=function(e){B.set(e,"inactive")},w.finish=function(e,t){var n=(new h({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50})).spin();n.spin(t.parentNode),t.classList.add("invisible"),v.unsync(),v.sync(R,v.get("_id")).then(function(){return v.set("ideaReady",!0),v.upload()}).then(function(){n.stop(),t.classList.remove("pressed"),B.set("ready",!1),w.displayIdea(),w.updateIdea()})},w.updateField=function(e,t){t.classList.contains("enterTitle")&&M.set("title",t.value),t.classList.contains("enterDesc")&&M.set("description",t.value),t.classList.contains("enterSol")&&M.set("solution",t.value)},w.displayIdea=function(){F.setReadonly(!0),B.set("showidea",!0),w.dom.querySelector(".idea-cards").classList.remove("folded"),w.dom.querySelector(".idea-cards .caret").classList.add("invisible"),w.dom.querySelector(".writeup").scrollIntoView(),w.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},w.hideIdea=function(){w.dom.querySelector(".idea-cards").classList.add("folded"),w.dom.querySelector(".idea-cards .caret").classList.remove("invisible"),w.dom.querySelector(".whiteboard .caret").classList.add("invisible")},w.toggleCaret=function(e,t){e.stopPropagation();var n=w.dom.querySelector(".writeup"),r=w.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?n.scrollIntoView():r.scrollIntoView()},w.toggleView=function(e,t){var n=t.querySelector(".caret"),r=w.dom.querySelector(".writeup"),i=w.dom.querySelector(".whiteboard");n.classList.contains("descending")?(n.classList.remove("descending"),i.scrollIntoView()):e.pageY-t.scrollHeight>0&&(n.classList.add("descending"),r.scrollIntoView())},w.updateIdea=function(e,t){A=setInterval(function(){var e=v.get("idea")[0]||{title:"",description:"",solution:""},t=e.title,n=e.description,r=e.solution,i={};if(M.get("title")!==t||M.get("description")!==n||M.get("solution")!==r)i.title=M.get("title"),i.description=M.get("description"),i.solution=M.get("solution"),v.set("idea",[i]),v.upload().then(function(e){return console.log("idea updated in CouchDB"),!0},function(e){console.log("failed to update idea",e)})},8e3)},w.updateSessionScore=function(e){var t=new l,n={sid:v.get("_id"),step:"muidea",time:e,wbcontent:j.toJSON(),idea:M.toJSON()};return I.request("UpdateSessionScore",n,function(e){e.res==="ok"?(v.unsync(),v.sync(R,v.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},w.getSessionDuration=function(){var e=v.get("elapsedTime"),t=v.get("resumeTime")||v.get("startTime");return now=new Date,now.getTime()-t+e},w.createIdeaDoc=function(){var e=new f(s.get("ideaTemplate")),t=new Date,n="I:"+t.getTime(),r=[],i=[],o=new l;return r.push(v.get("initiator").id),i.push(v.get("initiator").username),v.get("participants").forEach(function(e){r.push(e.id),i.push(e.username)}),e.setTransport(I),e.set("title",M.get("title")),e.set("sessionId",v.get("_id")),e.set("authors",r),e.set("description",M.get("description")),e.set("solution",M.get("solution")),e.set("creation_date",[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()]),e.set("character",v.get("characters")[0]),e.set("problem",v.get("problems")[0]),e.set("context",v.get("contexts")[0]),e.set("techno",v.get("techno")[0]),e.set("visibility",M.get("visibility")),e.set("sessionReplay",M.get("sessionReplay")),e.set("authornames",i.join(", ")),e.set("lang",v.get("lang")),e.set("_id",n),e.sync(s.get("db"),n).then(function(){return e.upload()}).then(function(){e.get("visibility")==="public"&&(I.request("UpdateUIP",{userid:q.get("_id"),type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){e!=="ok"&&console.log(e)}),v.get("participants").forEach(function(t){I.request("UpdateUIP",{userid:t.id,type:e.get("type"),docId:e.get("_id"),docTitle:e.get("title")},function(e){e!=="ok"&&console.log(t.id," "+e)})})),o.fulfill(),e.unsync()}),o},w.reset=function(e){x.clear(),v.get("chat")[4]&&x.reset(v.get("chat")[4]),B.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),D.reset(),F.setSessionId(v.get("_id")),j.reset(v.get("ideaWB")),j.getNbItems()?F.selectScreen("main"):F.selectScreen("default"),clearInterval(L),e||v.get("idea").length?(N="screen",x.dom.querySelector(".chatread").classList.add("extended"),B.set("ready",!1),w.displayIdea(),M.reset(v.get("idea")[0]),m.set("idea",v.get("idea")[0]),B.set("readonly",!0),B.set("shownext",!1)):(M.reset({title:"",description:"",solution:"",visibility:"private"}),j.getNbItems()?B.set("ready",!0):B.set("ready",!1),F.setReadonly(!1),N="step",z=!1),v.get("elapsedTimers").muidea&&(k=v.get("elapsedTimers").muidea,O.set("timer",k),N==="screen"?O.set("display",!0):w.isLeader()&&w.initTimer(k))},w.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;O.set("display",!1),O.set("timer",r),v.get("step")==="muidea"&&(L=setInterval(function(){var e=new Date;O.set("timer",r+e.getTime()-n)},1e3))},v.watchValue("_id",function(e){F.setSessionId(e)}),v.watchValue("chat",function(e){e.length===5&&x.getModel().get("_id")!==e[4]&&x.reset(e[4])}),m.watchValue("scenario",function(e){_.reset(m.get("scenario"))}),m.watchValue("techno",function(e){D.reset(JSON.parse(m.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){j.watch(e,function(e){if(!B.get("showidea")){if(v.get("ideaWB").length!==j.getNbItems()||JSON.stringify(v.get("ideaWB"))!==j.toJSON())v.set("ideaWB",JSON.parse(j.toJSON())),v.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)});j.getNbItems()?B.set("ready",!0):B.set("ready",!1)}})}),v.watchValue("ideaWB",function(e){v.get("step")==="muidea"&&!B.get("showidea")&&(e.length&&F.getStack().getCurrentName()==="default"&&F.selectScreen("main"),e.length||F.selectScreen("default"),(e.length!==j.getNbItems()||JSON.stringify(e)!==j.toJSON())&&j.reset(e))}),v.watchValue("ideaReady",function(e){v.get("step")==="muidea"&&e&&!w.isLeader()&&(B.set("readonly",!0),w.displayIdea())}),v.watchValue("idea",function(e){w.isLeader()||(M.reset(e[0]),m.set("idea",JSON.parse(M.toJSON())))}),M.watch("updated",function(){w.isLeader()&&M.get("title")&&M.get("description")&&M.get("solution")?B.set("shownext",!0):B.set("shownext",!1)}),v.watchValue("vote",function(e){e&&!z&&!w.isLeader()&&!T.isActive()&&(T.reset(v,function(e){e&&T.close()}),z=!0)}),w}}),define("brainstorm/multi/session/muwrapup",["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","service/utils","./mubchat"],function(e,t,n,r,i,s,o,u,a){return function(f,l,c,h,p){var d=new e,v=new o,m=new o([]),g=s.get("labels"),y=new a,b;return d.plugins.addAll({labels:new n(g),wrapup:new n(v,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setScore:function(e){e&&(this.innerHTML=e+" ip")},setTime:function(e){e&&(this.innerHTML=u.formatDuration(e))},alertMsg:function(e){var t=this;e&&d.dom.querySelector(".sessionchat").classList.contains("folded")?b=setInterval(function(){t.classList.toggle("flashing")},300):b&&clearInterval(b)},setVisibility:function(e){e&&e==="public"?this.classList.add("publicwrapup"):this.classList.remove("publicwrapup")},setReplay:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(m,{formatTitle:function(e){var t=this.getAttribute("data-cards_id");e&&(t<3?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){e?this.setAttribute("style","background-image:url('"+e+"');"):this.setAttribute("style","background-image: none;")}}),place:new i({chat:y}),muwrapupevent:new r(d)}),d.template='<div id = "muwrapup"><div class="previousbutton" data-muwrapupevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muwrapup" data-muwrapupevent="listen:mousedown, toggleProgress"></div><div class="congrats"><div class="message"><span class="messagetitle" data-labels="bind:innerHTML, congratulations"></span><span class="sessioncompleted" data-labels="bind:innerHTML, sessioncompleted"></span></div><div class="enddeedee"></div></div><div class="summary"><div class="storysummary"><div class="storyheader" data-labels="bind:innerHTML, storytitlelbl">Your Story</div><div class="storytitle" data-wrapup="bind:formatTitle, scenario.title"></div><div class="storycontent"><p class="summaryheader" data-labels="bind:innerHTML, scenarioheader"></p><p class="content" data-wrapup="bind:innerHTML, scenario.story"></p><p class="summaryheader" data-labels="bind:innerHTML, scenariosolution"></p><p class="content" data-wrapup="bind:innerHTML, scenario.solution">solution content</p></div></div><div class="ideasummary"><div class="ideaheader" data-labels="bind:innerHTML, ideatitlelbl"></div><div class="ideatitle" data-wrapup="bind:formatTitle, idea.title"></div><div class="ideacontent"><p class="summaryheader" data-labels="bind:innerHTML, ideadescription"></p><p class="content" data-wrapup="bind:innerHTML, idea.description"></p><p class="summaryheader" data-labels="bind:innerHTML, ideaimplementation"></p><p class="content" data-wrapup="bind:innerHTML, idea.solution">solution content</p></div></div></div><div class="sessionresults"><div class ="sessiontime"><span data-labels="bind:innerHTML, yourtime"></span><span data-wrapup = "bind: setTime, duration"></span></div><div class="sessionscore"><span data-labels="bind:innerHTML, yourscore"></span><span data-wrapup="bind:setScore, score"></span></div><div class="wrapupvisibility" data-wrapup="bind:setVisibility, idea.visibility"></div><div class="wrapupreplay invisible" data-wrapup="bind:setReplay, idea.sessionReplay"></div></div><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessioncards" data-muwrapupevent="listen:mousedown, toggleCards"><legend>Cards used during this session</legend><ul class="cardlist" data-cards="foreach"><li class="card"><div class="cardpicture" data-cards="bind:setPic,pic"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></li></ul></div><div class="togglechat" data-wrapup="bind:alertMsg, newmsg" data-muwrapupevent="listen: mousedown, toggleChat"></div><div class="sessionchat folded" data-place="place:chat"></div></div>',d.place(t.get("muwrapup")),d.press=function(e,t){t.classList.add("pressed")},d.next=function(e,t){t.classList.remove("pressed"),h("muwrapup")},d.exit=function(){p(!0)},d.prev=function(e,t){t.classList.remove("pressed"),c("muwrapup")},d.toggleProgress=function(e,t){p()},d.toggleCards=function(e,t){t.classList.contains("expanded")?t.classList.remove("expanded"):t.classList.add("expanded")},d.toggleChat=function(e,t){v.set("newmsg",!1),d.dom.querySelector(".sessionchat").classList.toggle("folded")},d.getChatUI=function(){return y},d.reset=function(e){m.reset([]),v.reset(),y.clear(),f.get("chat")[5]&&y.reset(f.get("chat")[5]).then(function(){y.getModel().watchValue("msg",function(t){t.length>1&&!e&&(v.set("newmsg",!0),setTimeout(function(){clearInterval(b)},2500))}),e&&y.dom.querySelector(".chatread").classList.add("replayed")}),v.set("scenario",l.get("scenario")),v.set("idea",l.get("idea")),v.set("score",f.get("score")),v.set("duration",f.get("duration")),m.reset([]),e?["added","updated"].forEach(function(e){l.watch(e,function(){var e;l.get("characters")&&l.get("contexts")&&l.get("problems")&&l.get("techno").getNbItems()===3&&(e=[l.get("characters"),l.get("contexts"),l.get("problems"),l.get("techno").get(0),l.get("techno").get(1),l.get("techno").get(2)],m.reset(e))})}):m.reset([l.get("characters"),l.get("contexts"),l.get("problems"),l.get("techno").get(0),l.get("techno").get(1),l.get("techno").get(2)])},l.watchValue("scenario",function(e){v.set("scenario",e)}),l.watchValue("idea",function(e){v.set("idea",e)}),f.watchValue("score",function(e){v.set("score",e)}),f.watchValue("duration",function(e){v.set("duration",e)}),f.watchValue("chat",function(e){e.length===6&&y.getModel().get("_id")!==e[5]&&(y.reset(e[5]),y.getModel().watchValue("msg",function(e){e.length>1&&v.set("newmsg",!0)}))}),MUWRAP=d,d}}),define("brainstorm/multi/session/mucontroller",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./mustart","./musetup","./muscenario","./mutech","./muidea","./muwrapup","CouchDBDocument","service/config","Promise","Store","lib/spin.min","Place.plugin","service/confirm"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g){return function(t){var y=new e,b=new e,w=document.createDocumentFragment(),E=new n,S=h.get("labels"),x=[{name:"mustart",label:S.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}],T,N,C,k,L,A,O=new d(x),M=h.get("user"),_=h.get("db"),D=new c,P=new d,H=new d({msg:""}),B,j,F=(new v({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin();return b.plugins.addAll({labels:new r(S),step:new r(O,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new i(b)}),b.template='<div class = "progressbar invisible"><ul id = "musteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',b.changeStep=function(e,t){var n=t.getAttribute("data-step_id");O.get(n).status?(O.loop(function(e,t){n==t?O.update(t,"currentStep",!0):O.update(t,"currentStep",!1)}),E.getStack().show(O.get(n).name)):e.stopImmediatePropagation()},b.press=function(e,t){t.classList.add("pressed")},b.exit=function(e,n){n.classList.remove("pressed"),D.get("step")==="muwrapup"?(A.getChatUI().leave(),D.get("initiator").id===M.get("_id")&&A.getChatUI().setReadonly(),M.set("sessionInProgress",""),M.upload().then(function(){t()})):B.show()},y.template='<div id="musession"><div data-place="place:progress"></div><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></div><div class="stack" data-musessionstack="destination"></div></div>',y.plugins.addAll({musessionstack:E,place:new m({progress:b}),info:new r(H)}),y.toggleProgress=function(e){e?b.exit():b.dom.classList.toggle("invisible")},y.leaveSession=function(){var e=D.get("participants"),n,r=E.getStack().get(D.get("step"));for(n=e.length-1;n>=0;n--)if(e[n].id===M.get("_id")){e.splice(n,1);break}D.set("participants",e),D.upload().then(function(){r.getChatUI().leave(),D.unsync(),B.hide()}),M.set("sessionInProgress",""),M.upload().then(function(){t()})},y.cancelSession=function(){var e=5e3;y.displayInfo("deleting",e).then(function(){t()})},y.displayInfo=function(e,t){var n,r=document.querySelector(".sessionmsg"),i=new p,s=function(){r.classList.add("invisible"),clearInterval(n),H.set("msg",""),i.fulfill()};B.hide(),r.classList.remove("invisible"),n=setInterval(function(){switch(e){case"deleting":H.set("msg",S.get("deletingsession")+t/1e3+"s");break;case"participantsleft":H.set("msg",S.get("participantsleft")+" "+t/1e3+"s");break;default:e!==H.get("msg")&&H.set("msg",e)}t<=0&&s(),t-=1e3},1e3);if(e==="deleting"||e==="participantsleft")D.set("status","deleted"),D.upload().then(function(){return M.set("sessionInProgress",""),M.upload()}).then(function(){var e=D.get("chat"),t=e.length,n=new p;return t?e.forEach(function(e){var r=new c;r.setTransport(h.get("transport")),r.sync(_,e).then(function(){return r.remove()}).then(function(){t--,t<=0&&n.fulfill})}):n.fulfill(),n}).then(function(){D.remove()});return i},y.createChat=function(e){var t=new c,n=(new Date).getTime(),r=[],i,s,o=new p;r.push({username:D.get("initiator").username,userid:D.get("initiator").id}),D.get("participants").forEach(function(e){r.push({username:e.username,userid:e.id})}),t.set("users",r);switch(e){case 1:i="quicksetup";break;case 2:i="quickscenario";break;case 3:i="quicktech";break;case 4:i="quickidea";break;case 5:i="quickwrapup";break;default:i="quickstart"}return t.set("msg",[{user:"SYS",type:5,arg:i,time:n}]),t.set("sid",D.get("_id")),t.set("lang",D.get("lang")),t.set("readonly",!1),t.set("step",e),t.set("type",17),s=t.get("sid")+"_"+e,t.setTransport(h.get("transport")),t.sync(_,s).then(function(){return t.upload()}).then(function(){var e=D.get("chat").concat();t.unsync(),e.push(s),D.set("chat",e),o.fulfill()}),o},y.retrieveSession=function(e,t){F.spin(document.getElementById("brainstorm")),D.reset({}),D.sync(_,e).then(function(){var e=D.get("step"),n=1e4,r=O.getNbItems();B=new g(y.dom),j=function(e){e?D.get("initiator").id===M.get("_id")?y.cancelSession():y.leaveSession():B.hide()},D.get("initiator").id===M.get("_id")?B.reset(S.get("leaderleave"),j):B.reset(S.get("participantleave"),j),O.loop(function(r,i){i<n&&(E.getStack().get(r.name).reset(t),O.update(i,"status","done"),r.name===e&&(n=i,O.update(i,"currentStep",!0),r.name==="muwrapup"?O.update(i,"status","done"):O.update(i,"status","ongoing")))}),t?(F.stop(),E.getStack().show("muwrapup")):(F.stop(),E.getStack().show(e))})},y.reset=function(e,t){D.unsync(),P.reset(),O.reset([{name:"mustart",label:S.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:S.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:S.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:S.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:S.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:S.get("quickstepwrapup"),currentStep:!1,status:null}]),e&&y.retrieveSession(e,t)},y.prev=function(e){var n;O.loop(function(t,r){t.name===e&&(n=r)}),n>0?(O.update(n,"currentStep",!1),O.update(n-1,"currentStep",!0),E.getStack().show(O.get(n-1).name)):(alert("Exiting session"),t())},y.next=function(e){var t,n=E.getStack().get(e),r,i="",s=new p;return O.loop(function(n,r){n.name===e&&(t=r)}),t<O.getNbItems()&&(i=O.get(t+1).name,r=E.getStack().get(i),O.update(t,"currentStep",!1),O.update(t+1,"currentStep",!0),O.get(t).status!=="done"?(O.update(t,"status","done"),O.update(t+1,"status","ongoing"),O.get(t+1).name==="muwrapup"&&O.update(t+1,"status","done"),r.reset(),y.createChat(t+1).then(function(){return D.set("step",i),D.upload()}).then(function(){r.initTimer&&r.initTimer(),n.stopSpinner(),E.getStack().show(i),i==="muwrapup"?(M.unsync(),M.sync(h.get("db"),M.get("_id")).then(function(){return M.set("sessionInProgress",""),M.upload()}).then(function(){s.fulfill()})):s.fulfill()})):(n.stopSpinner(),E.getStack().show(i),s.fulfill())),s},y.init=function(){T=new s(D,y.prev,y.next,y.toggleProgress),N=new o(D,P,y.prev,y.next,y.toggleProgress),C=new u(D,P,y.prev,y.next,y.toggleProgress),k=new a(D,P,y.prev,y.next,y.toggleProgress),L=new f(D,P,y.prev,y.next,y.toggleProgress),A=new l(D,P,y.prev,y.next,y.toggleProgress),D.setTransport(h.get("transport")),E.getStack().add("mustart",T),E.getStack().add("musetup",N),E.getStack().add("muscenario",C),E.getStack().add("mutech",k),E.getStack().add("muidea",L),E.getStack().add("muwrapup",A)},y.init(),D.watchValue("status",function(e){e==="deleted"&&D.get("initiator").id!==M.get("_id")&&(M.set("sessionInProgress",""),M.upload(),y.displayInfo(S.get("canceledbyleader"),2e3).then(function(){D.unsync(),t()}))}),D.watchValue("step",function(e){var t,n=D.get("step");D.get("initiator")&&D.get("initiator").id!==M.get("_id")&&(O.loop(function(e,r){e.name===n&&(t=r)}),O.update(t-1,"status","done"),O.update(t,"status","ongoing"),O.update(t-1,"currentStep",!1),O.update(t,"currentStep",!0),E.getStack().get(e).reset(),E.getStack().show(e)),step==="muwrapup"&&(M.unsync(),M.sync(h.get("db"),M.get("_id")).then(function(){return M.set("sessionInProgress",""),M.upload()}))}),D.watchValue("participants",function(e){e.length===0&&D.get("step")!=="muwrapup"&&y.displayInfo("participantsleft",1e4).then(function(){return M.set("sessionInProgress",""),M.upload()}).then(function(){t()})}),y}}),define("brainstorm/multi/mub",["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","CouchDBDocument","CouchDBView","service/config","Promise","Store","./mubinit","./mubwait","./session/mucontroller","lib/spin.min"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(n,r){var s=new e,u=new t,a=o.get("user"),p,d,v,m=(new h({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328})).spin();return s.plugins.add("mustack",u),s.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>',s.place(document.getElementById("ideafy-multi")),s.reset=function(e){e?e.mode==="join"?s.join(e.id):s.replayMUSession(e.id):(d.reset(),u.getStack().show("mubinit"))},s.replayMUSession=function(e){v.reset(e,!0),u.getStack().show("musession")},s.join=function(e){var t=new i;t.setTransport(o.get("transport")),t.sync(o.get("db"),e).then(function(){var n=t.get("participants"),r=!1;n.forEach(function(e){e.id===a.get("_id")&&(r=!0)}),r?t.get("step")==="mustart"?(p.reset(e),u.getStack().show("mubwait")):s.startSession(e):(n.push({id:a.get("_id"),username:a.get("username"),intro:a.get("intro")}),t.set("participants",n),n.length===3&&t.set("status","full"),t.upload().then(function(){p.reset(e),u.getStack().show("mubwait")},function(e){console.log(e),alert("failed to join session")}))},function(e){console.log(e),alert("failed to join session")})},s.startSession=function(e){u.getStack().show("musession"),v.reset(e)},d=new f(r),p=new l(r,s.startSession),v=new c(r),u.getStack().add("mubinit",d),u.getStack().add("mubwait",p),u.getStack().add("musession",v),n?n.mode==="join"?(console.log("joining session",n),s.join(n.id)):s.replayMUSession(n.id):u.getStack().show("mubinit"),o.get("observer").watch("start-mu_session",function(e){p.reset(e),u.getStack().show("mubwait")}),s}}),define("brainstorm/brainstorm",["OObject","service/map","service/submenu","Amy/Stack-plugin","Bind.plugin","service/config","Store","service/utils","./ideafy-menu","./quickb/quickb","./multi/mub"],function(e,t,n,r,i,s,o,u,a,f,l){return function(){var u=new e,c,h=new o,p=new r,d=s.get("user");return u.plugins.addAll({brainstormstack:p,header:new i(h,{setDate:function(e){e&&(this.innerHTML=e.toLocaleDateString())},setTime:function(e){var t=e.getHours(),n=e.getMinutes(),r=e.getSeconds();t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r}})}),u.template='<div id="brainstorm"><div id="brainstorm-menu"></div><div class="brainstorm-header header blue-light"><div class="date" data-header="bind: setDate, date"></div><span class="headerTitle" data-header="bind: innerHTML, headertitle"></span><div class="clock" data-header="bind: setTime, date">hh:mm</div></div><div class="stack" data-brainstormstack="destination"></div></div>',u.place(t.get("brainstorm")),u.showMenu=function(){c.toggleActive(!0)},u.hideMenu=function(){c.toggleActive(!1)},u.exitSession=function(){p.getStack().show("menu")},u.reset=function(){p.getStack().get("menu").reset(),p.getStack().show("menu")},u.selectScreen=function(e,t){e==="continue"&&(e=t.type);if(e!=="tutorial"&&p.getStack().get(e))p.getStack().get(e).reset(t),p.getStack().show(e);else{t?e=t.type:t=null;switch(e){case"quick":p.getStack().add("quick",new f(t,u.exitSession));break;case"musession":p.getStack().add("musession",new l(t,u.exitSession));break;case"tutorial":s.get("observer").notify("display-tutorials");break;default:e=""}e&&p.getStack().show(e)}},c=new n(u.dom.querySelector("#brainstorm-menu")),c.toggleActive(!1),h.set("headertitle",s.get("labels").get("brainstormheadertitle")),setInterval(function(){var e=new Date;h.set("date",e)},1e3),p.getStack().add("menu",new a(u.selectScreen)),p.getStack().show("menu"),s.get("observer").watch("replay-session",function(e,t){var n={};n.id=e,t?n.type=t:(e.toLowerCase().search("quick")>-1&&(n.type="quick"),e.toLowerCase().search("s:mu")>-1&&(n.type="musession")),u.selectScreen(n.type,n)}),s.get("observer").watch("join-musession",function(e){var t={type:"musession",id:e,mode:"join"};u.selectScreen(t.type,t)}),u}}),define("connect/contacts/addcontact",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","Store","service/avatar","Promise","lib/spin.min"],function(e,t,n,r,s,o,u,a,f){return function(){var l=new e,c=new s,h=new o({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),p=new o([]),d={},v=t.get("user"),m=t.get("transport"),g=t.get("labels"),y=(new f({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:-20,top:-36})).spin(),b=function(e,t){var n=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;e==="email"?n.test(t.toLowerCase())?(h.set("result",""),w("userid",t.toLowerCase())):h.set("result",g.get("signupinvalidemail")):h.get("email")?h.set("result",g.get("clearemailfirst")):h.get("firstname")&&h.get("lastname")?(h.set("result",""),w("username",h.get("firstname").toLowerCase()+" "+h.get("lastname").toLowerCase())):h.set("result",g.get("needbothfnln"))},w=function(e,n){var r=new s;r.setTransport(m),e==="userid"?r.sync(t.get("db"),"users","_view/searchbyid",{key:'"'+n+'"',descending:!0}).then(function(){p.reset(JSON.parse(r.toJSON())),p.getNbItems()?h.set("display",!0):h.set("invite",!0),r.unsync()}):r.sync(t.get("db"),"users","_view/searchbyusername",{key:'"'+n+'"',descending:!0}).then(function(){p.reset(JSON.parse(r.toJSON())),p.getNbItems()?h.set("display",!0):h.set("result",g.get("noentryfound")),r.unsync()})},E=function(e){var t=!1,n=v.get("sentMessages")||[],r=v.get("connections"),i=!1,s=!1,o,u,a,f;if(e.userid===v.get("_id"))h.set("result",g.get("cannotaddself"));else{for(u=0,a=r.length;u<a;u++)if(r[u].userid===e.userid){s=!0;break}if(s)h.set("result",e.username+g.get("alreadyconnected"));else{for(o=0,f=n.length;o<f;o++)if(n[o].type==="CXR"&&n[o].toList.search(e.username)>-1){i=!0;break}i?h.set("result",g.get("alreadysentCXR")+e.username):t=!0}}return t},S=function(e){var t=new Date,n={};E(e)&&(n.dest=[e.userid],n.type="CXR",n.status="unread",n.date=[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],n.author=v.get("_id"),n.username=v.get("username"),n.firstname=v.get("firstname"),n.toList=e.username,n.ccList="",n.object=v.get("username")+g.get("CXRobject"),n.body=h.get("message"),n.signature=v.get("signature"),n.contactInfo={firstname:v.get("firstname"),lastname:v.get("lastname"),userid:v.get("_id"),username:v.get("username"),intro:v.get("intro"),type:"user"},m.request("Notify",n,function(e){var t=JSON.parse(e);t[0].res==="ok"?(h.set("result",g.get("CXRsent")),setTimeout(function(){l.reset()},2e3)):model.set("result","There was an error, please try again later")}))};return l.plugins.addAll({label:new n(g),count:new n(c),search:new n(h,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")}}),contacts:new n(p,{setAvatar:function(e){var t,n;_frag=document.createDocumentFragment(),_ui=new u([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),searchdbevent:new r(l),invitecontactevent:new r(l)}),l.template='<div id="addcontact"><div class="header blue-dark"><span class="newcontactlbl" data-label="bind:innerHTML, newcontactlbl"></span></div><div class = "detail-contents"><div class="doctor-deedee"></div><div class="addcontactform"><p class="half"><span data-label="bind:innerHTML, beforecount"></span><strong><span data-count="bind:innerHTML, 0.value"></span></strong><span data-label="bind:innerHTML, aftercount"></span></p><p class="half" data-label="bind: innerHTML, addcontactrightintro"></p><legend data-label="bind:innerHTML, addcontactnow"></legend><input class="search" type="text" name="email" data-label="bind:placeholder, searchcontactplaceholder" data-search="bind: value, email" data-searchdbevent="listen: keypress, searchDB"><legend data-label="bind:innerHTML, lookup"></legend><div class="searchcontact"><input type="text" class="search half" name="fn" data-label="bind:placeholder, firstnameplaceholder" data-search="bind: value, firstname" data-searchdbevent="listen: keypress, searchDB"><input class="search half right" type="text" name="ln" data-label="bind: placeholder, lastnameplaceholder" data-search="bind: value, lastname" data-searchdbevent="listen: keypress, searchDB"></div><p class="searchresult" data-search="bind: innerHTML, result; bind:setStyle, sentok"></p></div><div class="contactinvite" data-search="bind: setVisible, invite"><p>The person you are looking for was not found in Ideafy. Would you like to send him/her an invitation ? You will receive 200 Ideafy Points if the person joins the community</p><div><span class="sendmail" data-label="bind:innerHTML, sendlbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, sendInvite">Accept</span><span class="cancelmail" data-label="bind:innerHTML, cancellbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, cancelInvite">Cancel</span></div></div><div class = "contactlist invisible" data-search="bind: setVisible, display"><legend data-label="bind:innerHTML, selectcontact"></legend><ul data-contacts="foreach"><li class = "contact list-item"><div data-contacts="bind:setAvatar, value.userid"></div><p class="contact-name" data-contacts="bind:innerHTML, value.username"></p><p class="contact-intro" data-contacts="bind:innerHTML, value.intro"></p><div class="select-contact" data-searchdbevent="listen:mousedown, check"></div></li></ul><textarea class="input" data-label="bind:placeholder, addamessage" data-search="bind:value, message"></textarea><div class="addcontactbtns"><div class="addct" data-searchdbevent="listen:mousedown, push; listen:mouseup, add"></div><div class="cancelct" data-searchdbevent="listen:mousedown, push; listen:mouseup, cancel"></div></div></div></div></div>',l.init=function(){var e=new a;return c.setTransport(m),c.sync(t.get("db"),"users","_view/count").then(function(){e.fulfill()}),e},l.searchDB=function(e,t){var n;e.keyCode===13&&(e.target.blur(),n=t.getAttribute("name"),b(n,t.value))},l.check=function(e,t){var n=t.getAttribute("data-contacts_id");t.innerHTML?(t.innerHTML="",d[n]=!1):(t.innerHTML="&#10003;",d[n]=!0)},l.reset=function(){h.reset({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),p.reset([])},l.push=function(e,t){t.classList.add("pushed")},l.cancel=function(e,t){t.classList.remove("pushed"),l.reset()},l.press=function(e,t){t.classList.add("pressed")},l.cancelInvite=function(e,t){t.classList.remove("pressed"),l.reset()},l.sendInvite=function(e,t){var n={id:h.get("email").toLowerCase(),senderid:v.get("_id"),sendername:v.get("username"),subject:v.get("username")+g.get("invitesyou"),body:g.get("invitebody")};y.spin(t),m.request("Invite",n,function(e){e==="ok"&&alert(g.get("invitationsent")),e==="alreadyinvited"&&alert(g.get("alreadyinvited")),y.stop(),t.classList.remove("pressed"),l.reset()})},l.add=function(e,t){t.classList.remove("pushed");for(i in Object.keys(d))S(p.get(i).value)},ADDCTSPIN=y,l}}),define("connect/contacts/addgroup",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,n,r,s,o){return function(){var u=new e,a=new s({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),f=new s([{color:"#4D4D4D",icon:"graygroup.png",selected:!0},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}]),c=new s([]),h=new s([]),p=new s({error:""}),d={},v=t.get("user"),m=t.get("labels");return u.plugins.addAll({label:new n(m),error:new n(p),color:new n(f,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new n(a,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),contacts:new n(c,{setAvatar:function(e){var t,n;_frag=document.createDocumentFragment(),_ui=new o([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new n(h,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),addgrpevent:new r(u)}),u.template='<div id="addgroup"><div class="header blue-dark"><span class="newfolderlbl" data-label="bind:innerHTML, newfolderlbl"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-addgrpevent="listen: mousedown, selectColor"></li></ul></form><div class = "groupcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-contacts="foreach"><li class = "contact list-item" data-addgrpevent="listen:mousedown, discardContact"><div data-contacts="bind:setAvatar, userid"></div><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><div class="addgroupbtns"><span class="errormsg" data-error="bind:innerHTML, error"></span><div class="addct" data-addgrpevent="listen:mousedown, press; listen:mouseup, add"></div><div class="cancelct" data-addgrpevent="listen:mousedown, press; listen:mouseup, cancel"></div></div><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-addgrpevent="listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-addgrpevent="listen:mouseup, select"></li></ul></div></div></div></div>',u.init=function(){v.get("connections").forEach(function(e){e.type==="user"&&h.alter("push",{contact:e,selected:!1})})},u.selectColor=function(e,t){var n=t.getAttribute("data-color_id");f.loop(function(e,t){f.update(t,"selected",!1)}),f.update(n,"selected",!0),a.set("color",f.get(n).icon)},u.toggleHide=function(e,t){var n=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},u.select=function(e,t){var n=t.getAttribute("data-auto_id");h.get(n).selected?(u.removeContact(n),setTimeout(function(){h.update(n,"selected",!1)},200)):(u.addContact(n),setTimeout(function(){h.update(n,"selected",!0)},200))},u.addContact=function(e){var t=JSON.parse(c.toJSON()),n=h.get(e).contact,r=0;if(c.toJSON().search(n.userid)<0){for(i=0,l=t.length;i<l;i++)n.lastname>t[i].lastname?r++:n.lastname===t[i].lastname&&n.username>t[i].username&&r++;t.splice(r,0,n),c.reset(t),a.set("contacts",t)}},u.removeContact=function(e){var t=JSON.parse(c.toJSON());for(i=t.length-1;i>=0;i--)t[i].userid===h.get(e).contact.userid&&t.splice(i,1);c.reset(t)},u.updateAutoContact=function(e,t){var n=JSON.parse(h.toJSON()),r=v.get("connections"),s,o=t.value.toLowerCase();if(t.value===""){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1})}else if(e.keyCode===8||e.keyCode===46){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1});for(i=n.length-1;i>=0;i--)n[i].contact.username.toLowerCase().search(o)!==0&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)s=n[i].contact.username.toLowerCase(),s.search(o)!==0&&n.splice(i,1);h.reset(n),h.loop(function(e,t){c.toJSON().search(e.contact.userid)>-1&&h.update(t,"selected",!0)})},u.discardContact=function(e,t){var n=t.getAttribute("data-contacts_id"),r=c.get(n).userid;c.alter("splice",n,1),h.loop(function(e,t){e.contact.userid===r&&setTimeout(function(){h.update(t,"selected",!1)},200)})},u.reset=function(){a.reset({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),c.reset([]),h.reset([]),p.reset({error:""}),v.get("connections").forEach(function(e){e.type==="user"&&h.alter("push",{contact:e,selected:!1})})},u.press=function(e,t){t.classList.add("pushed")},u.cancel=function(e,t){t.classList.remove("pushed"),u.reset(),document.querySelector("#addgroup input.search").value=""},u.add=function(e,t){var n=v.get("connections"),r=0,s=JSON.parse(a.toJSON());t.classList.remove("pushed"),p.set("error","");if(s.username==="")p.set("error",m.get("nogrpname"));else if(s.intro==="")p.set("error",m.get("nogrpintro"));else if(!s.contacts.length)p.set("error",m.get("nocontactselected"));else{for(i=0,l=n.length;i<l;i++)n[i].type==="user"?s.username>n[i].lastname&&r++:(s.username===n[i].username&&p.set("error",m.get("grpnameexists")),s.username>n[i].username&&r++);p.get("error")||(n.splice(r,0,s),v.set("connections",n),v.upload().then(function(){u.reset()}))}},u}}),define("connect/contacts/contact-detail",["OObject","service/config","service/map","Store","Bind.plugin","Event.plugin","service/avatar","service/utils"],function(e,t,n,r,s,o,u,a){return function(){var f=new e,l=new r,c=new r,h=new r([]),p=new r([]),d=t.get("labels"),v=t.get("user"),m=t.get("transport");return f.plugins.addAll({label:new s(d),basicinfo:new s(c,{setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),ctdetails:new s(l),grades:new s(h,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new s(p,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),ctdetailsevent:new o(f)}),f.template='<div id = "contactdetails"><div class="header blue-dark"><span class="subjectlbl" data-details="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class = "contactessentials"><div class="avatar" data-basicinfo="bind:setAvatar, userid"></div><div class="basicinfo"><h2 data-basicinfo="bind:innerHTML,username"></h2><p data-basicinfo="bind:innerHTML, intro"></p></div><div class="contactdashboard"><div class="contactstats"><legend data-label="bind:innerHTML, stats"></legend><div class="userscore"><span class="ip" data-ctdetails="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-ctdetails="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-ctdetails="bind: innerHTML, sessions"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-ctdetails="bind: innerHTML, contacts"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-ctdetails="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="contactbadges"><legend data-label="bind:innerHTML, achievements"></legend><p class="grade" data-stats="bind:innerHTML, title"></p><ul class="badges" data-grades="foreach"><li class="contactbadge"><div data-grades="bind:showBadge, badge"></div><label data-grades="bind:innerHTML, title"></label></li></ul><ul class="badges" data-achievements="foreach"><li class="contactbadge"><div data-achievements="bind:showBadge, badge"></div><label data-achievements="bind:innerHTML, label"></label></li></ul></div></div></div></div><div class = "contactnotes"><legend data-label="bind: innerHTML, mynotes"></legend><div id = "cancelnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push; listen:mouseup, cancelNotes"></div><div id = "uploadnotes" class="invisible" data-ctdetailsevent="listen:mousedown, push;listen:mouseup, uploadNotes"></div><textarea id="ctnotes" class = "input" data-label="bind:placeholder,writesomething" data-basicinfo="bind: value, notes" data-ctdetailsevent="listen:input, displayNoteBtns"></textarea></div></div></div>',f.place(n.get("contactdetails")),f.updateContact=function(e){var t=v.get("connections"),n,r=t.length,i,s;for(n=0;n<r;n++){t[n].userid===e._id&&(t[n].username=e.username,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].intro=e.intro);if(t[n].type==="group"){i=t[n].contacts;for(s=0;s<i.length;s++)i[s].userid===e._id&&(i[s].username=e.username,i[s].firstname=e.firstname,i[s].lastname=e.lastname,i[s].intro=e.intro);t[n].contacts=i}}v.set("connections",t),v.upload()},f.getUserInfo=function(e){a.getUserDetails(e,function(e){(e.username!==c.get("username")||e.firstname!==c.get("firstname")||e.lastname!==c.get("lastname")||e.intro!==c.get("intro"))&&f.updateContact(e),l.reset(e),l.set("sessions",l.get("su_sessions_count")+l.get("mu_sessions_count")),a.getGrade(e.ip,function(e){h.alter("push",e.grade),e.distinction&&h.alter("push",e.distinction)}),p.reset(e.achievements)})},f.reset=function(e){c.reset(e),h.reset([]),p.reset([]),c.get("notes")||c.set("notes",""),f.getUserInfo(e.userid)},f.displayNoteBtns=function(e,t){document.getElementById("uploadnotes").classList.remove("invisible"),document.getElementById("cancelnotes").classList.remove("invisible")},f.hideNoteBtns=function(e,t){document.getElementById("uploadnotes").classList.add("invisible"),document.getElementById("cancelnotes").classList.add("invisible")},f.push=function(e,t){t.classList.add("pushed")},f.uploadNotes=function(e,t){var n=v.get("connections"),r,i=n.length,s,o,u=document.getElementById("uploadnotes"),a=document.getElementById("cancelnotes");for(r=0;r<i;r++){n[r].userid===c.get("userid")&&(n[r].notes=c.get("notes"));if(n[r].type==="group"){s=n[r].contacts;for(o=0;o<s.length;o++)s[o].userid===c.get("userid")&&(s[o].notes=c.get("notes"));n[r].contacts=s}}v.set("connections",n),v.upload().then(function(){t.classList.remove("pushed"),f.hideNoteBtns()})},f.cancelNotes=function(e,t){var n=v.get("connections"),r=n.length;i;for(i=0;i<r;i++)n[i].userid===c.get("userid")&&c.set("notes",n[i].notes);t.classList.add("pushed"),f.hideNoteBtns()},f}}),define("connect/contacts/group-detail",["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,n,r,s,o){return function(){var u=new e,a=new s,f=new s([]),c,h=[{color:"#4D4D4D",icon:"graygroup.png",selected:!1},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}],p=new s(h),d=new s([]),v=new s({error:""}),m={},g=t.get("user"),y=t.get("labels");return u.template='<div id="groupdetails"><div class="header blue-dark"><span class="newfolderlbl" data-group="bind:innerHTML, username"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-grpdetailsevent="listen: mousedown, selectColor"></li></ul></form><div class = "grpcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-grpcontacts="foreach"><li class = "contact list-item" data-grpdetailsevent="listen:mousedown, discardContact"><div data-grpcontacts="bind:setAvatar, userid"></div><p class="contact-name" data-grpcontacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-grpcontacts="bind:innerHTML, intro"></p></li></ul></div><p class="update"><label class="cancelmail" data-label="bind:innerHTML, cancellbl" data-grpdetailsevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-label="bind:innerHTML, updatelbl" data-grpdetailsevent="listen:mousedown, press; listen:mouseup, updateGroup"></label><label class="editerror" data-error="bind:innerHTML, error"></label><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-grpdetailsevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-grpdetailsevent="listen:keyup, updateAutoContact" data-label="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-grpdetailsevent="listen:mouseup, select"></li></ul></div></div></div></div>',u.plugins.addAll({label:new n(y),error:new n(v),color:new n(p,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),group:new n(a,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),grpcontacts:new n(f,{setAvatar:function(e){var t,n;e&&(_frag=document.createDocumentFragment(),_ui=new o([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag))},setSelected:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),auto:new n(d,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),grpdetailsevent:new r(u)}),u.selectColor=function(e,t){var n=t.getAttribute("data-color_id");p.loop(function(e,t){p.update(t,"selected",!1)}),p.update(n,"selected",!0),a.set("color",p.get(n).icon)},u.toggleHide=function(e,t){var n=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),n==="add"?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},u.select=function(e,t){var n=t.getAttribute("data-auto_id");d.get(n).selected?(u.removeContact(n),setTimeout(function(){d.update(n,"selected",!1)},200)):(u.addContact(n),setTimeout(function(){d.update(n,"selected",!0)},200))},u.addContact=function(e){var t=JSON.parse(f.toJSON()),n=d.get(e).contact,r=0;if(f.toJSON().search(n.userid)<0){for(i=0,l=t.length;i<l;i++)n.lastname>t[i].lastname?r++:n.lastname===t[i].lastname&&n.username>t[i].username&&r++;t.splice(r,0,n),f.reset(t),a.set("contacts",t)}},u.removeContact=function(e){var t=JSON.parse(f.toJSON());for(i=t.length-1;i>=0;i--)t[i].userid===d.get(e).contact.userid&&t.splice(i,1);f.reset(t),a.set("contacts",t)},u.updateAutoContact=function(e,t){var n=JSON.parse(d.toJSON()),r=g.get("connections");if(t.value===""){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1})}else if(e.keyCode===8||e.keyCode===46){n=[];for(i=0,l=r.length;i<l;i++)r[i].type==="user"&&n.push({contact:r[i],selected:!1});for(i=n.length-1;i>=0;i--)n[i].contact.username.search(t.value)!==0&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)n[i].contact.username.search(t.value)!==0&&n.splice(i,1);d.reset(n),d.loop(function(e,t){f.toJSON().search(e.contact.userid)>-1&&d.update(t,"selected",!0)})},u.discardContact=function(e,t){var n=t.getAttribute("data-grpcontacts_id"),r=f.get(n).userid;f.alter("splice",n,1),d.loop(function(e,t){e.contact.userid===r&&setTimeout(function(){d.update(t,"selected",!1)},200)}),a.set("contacts",JSON.parse(f.toJSON()))},u.press=function(e,t){t.classList.add("pressed")},u.cancel=function(e,t){t.classList.remove("pressed"),u.reset(c),document.querySelector("#groupdetails input.search").value=""},u.updateGroup=function(e,t){var n=g.get("connections"),r,i=JSON.parse(a.toJSON());t.classList.remove("pressed"),v.set("error","");if(i.username==="")v.set("error",y.get("nogrpname"));else if(i.intro==="")v.set("error",y.get("nogrpintro"));else if(!i.contacts.length)v.set("error",y.get("nocontactselected"));else for(r=n.length-1;r>=0;r--)n[r].type==="group"&&n[r].username===c.username&&(v.get("error")||(n.splice(r,1,i),g.set("connections",n),g.upload().then(function(){u.reset(i),v.set("error",y.get("groupupdated"))})))},u.reset=function(e){p.reset(h),p.loop(function(t,n){t.icon===e.color?p.update(n,"selected",!0):p.update(n,"selected",!1)}),a.reset(e),c=e,f.reset(e.contacts),d.reset([]),v.reset({error:""}),g.get("connections").forEach(function(e){e.type==="user"&&d.alter("push",{contact:e,selected:!1})}),d.loop(function(e,t){f.toJSON().search(e.contact.userid)>-1&&d.update(t,"selected",!0)})},u.init=function(){g.get("connections").forEach(function(e){e.type==="user"&&d.alter("push",{contact:e,selected:!1})})},u}}),define("connect/contacts/contacts",["OObject","service/map","service/config","Amy/Stack-plugin","Bind.plugin","Event.plugin","Amy/Control-plugin","Store","service/avatar","service/actionbar","./addcontact","./addgroup","./contact-detail","./group-detail"],function(e,t,n,r,s,o,u,a,f,c,h,p,d,v){return function(){var m=new e,g=new r,y=new h,b=new p,w=new d,E=new v,S=new a([{name:"all",label:"allbtn",selected:!0},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),x=0,T=new a([]),N=!1,C=n.get("user"),k=n.get("labels"),L=function(e){var t=S.get(e).name,n=C.get("connections"),r=n.length,s=[];switch(t){case"users":for(i=0;i<r;i++)n[i].type==="user"&&s.push(n[i]);break;case"groups":for(i=0;i<r;i++)n[i].type==="group"&&s.push(n[i]);break;default:s=n}return s},A=function(e){var t=[],n=[];t=C.get("connections").concat();if(e==="")n=t,S.update(0,"selected",!0),x=0;else for(i=0,l=t.length;i<l;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&n.push(t[i]);return n};return m.plugins.addAll({label:new s(k),sort:new s(S,{setLabel:function(e){this.innerHTML=k.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),contact:new s(T,{setAvatar:function(e){var t=this.getAttribute("data-contact_id"),n,r;e==="group"?(this.hasChildNodes()&&this.removeChild(this.firstChild),this.setAttribute("style","background: url('img/connect/"+T.get(t).color+"') no-repeat center center; background-size: contain;display:block; width:40px; height:40px;float:left;")):e==="user"&&(this.setAttribute("style","background:none;"),n=document.createDocumentFragment(),r=new f([T.get(t).userid]),r.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setIntro:function(e){e?this.innerHTML=e:this.innerHTML=" "}}),contactdetailstack:g,contactlistcontrol:new u(m),contactlistevent:new o(m)}),m.template='<div id="connect-contacts"><div class="contacts"><div class="header blue-light"><span data-label="bind: innerHTML, contactlistheadertitle">My Contacts</span><div class="option right" data-contactlistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-contactlistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-contactlistevent="listen: keypress, search"><div class="contactlist overflow" data-contactlistcontrol="radio:li,selected,mousedown,selectContact"><ul data-contact="foreach"><li class="contact list-item" data-contactlistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-contact="bind:setAvatar, type"></div><p class="contact-name" data-contact="bind:innerHTML, username"></p><p class="contact-intro" data-contact="bind:setIntro, intro"></p><div class="select-contact"></div></li></ul></div></div><div id="toggleadd" class="group" data-contactlistevent="listen:mousedown, press; listen:mouseup, toggleAddUI"></div><div id="contact-detail" class="details" data-contactdetailstack="destination"></div></div>',m.place(t.get("connect-contacts")),m.plus=function(e,t){var n=document.getElementById("toggleadd");g.getStack().get("#addcontact").reset(),g.getStack().show("#addcontact"),n.classList.contains("user")&&n.classList.remove("user"),n.classList.add("group")},m.init=function(){T.reset(C.get("connections")),y.init().then(function(){g.getStack().show("#addcontact")}),b.init(),E.init()},m.reset=function(){T.reset(C.get("connections")),y.reset(),g.getStack().show("#addcontact")},m.getSelectedContact=function(){var e=document.querySelector(".contact.selected"),t=-1;return e&&(t=e.getAttribute("data-contact_id")),t},m.selectContact=function(e){var t=e.target.getAttribute("data-contact_id"),n=T.get(t);document.getElementById("toggleadd").classList.remove("group"),document.getElementById("toggleadd").classList.remove("user"),n.type==="user"?(w.reset(T.get(t)),g.getStack().getCurrentName()!=="#contactdetails"&&g.getStack().show("#contactdetails")):(E.reset(T.get(t)),g.getStack().getCurrentName()!=="#groupdetails"&&g.getStack().show("#groupdetails"))},m.displaySort=function(e,t){var n=t.getAttribute("data-sort_id");T.reset([]),x>-1&&S.update(x,"selected",!1),S.update(n,"selected",!0),x=n,T.reset(L(n))},m.search=function(e,t){e.keyCode===13&&(S.update(x,"selected",!1),x=-1,T.reset(A(t.value)))},m.setStart=function(e,t){document.querySelector(".actionbar")&&m.hideActionBar()},m.showActionBar=function(e,t){var n=t.getAttribute("data-contact_id"),r=new c("contact",t,T.get(n),m.hideActionBar),i=document.createDocumentFragment();r.place(i),t.appendChild(i),N=!0},m.hideActionBar=function(e){var e=document.querySelector(".actionbar"),t=e.parentNode;t.removeChild(t.lastChild),N=!1},m.press=function(e,t){t.classList.add("pressed")},m.toggleAddUI=function(e,t){t.classList.remove("pressed"),t.classList.contains("group")?(t.classList.remove("group"),g.getStack().get("#addgroup").reset(),g.getStack().show("#addgroup"),t.classList.add("user")):(t.classList.remove("user"),g.getStack().get("#addcontact").reset(),g.getStack().show("#addcontact"),t.classList.add("group"))},g.getStack().add("#contactdetails",w),g.getStack().add("#groupdetails",E),g.getStack().add("#addcontact",y),g.getStack().add("#addgroup",b),b.init(),m.init(),C.watchValue("connections",function(){var e;x>-1&&T.reset(L(x)),g.getStack().getCurrentName()==="#contactdetails"&&(e=m.getSelectedContact(),e>-1?(contactDetail.reset(T.get(e)),g.getStack().show("#contactdetails")):(g.getStack().show("#addcontact"),document.getElementById("toggleadd").classList.add("group")))}),n.get("observer").watch("contact-deleted",function(){g.getStack().show("#addcontact")}),C.watchValue("lang",function(){var e;S.loop(function(t,n){t.selected&&(e=n)}),S.reset([{name:"all",label:"allbtn",selected:!1},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),S.update(e,"selected",!0)}),m}}),define("connect/messages/message-reply",["OObject","Store","Bind.plugin","Event.plugin","service/config","service/utils","Promise","service/autocontact"],function(e,t,n,r,s,o,u,a){return function(){var f=new e,c=new t,h,p={},d=new t({errormsg:""}),v=s.get("labels"),m=s.get("user"),g=s.get("transport"),y=!1,b=function(e){var t=/<(.|\n)*?>/g;return e.replace(t,"")},w=function(e){var t=c.get("toList").toLowerCase().split(/,|;/),n=c.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(m.get("connections")).toLowerCase(),s=[],o={},a=new u;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1||h.toList.search(t[i].trim())>-1||h.ccList.search(t[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+t[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(t[i].trim())}if(!d.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1||h.toList.search(n[i].trim())>-1||h.ccList.search(n[i].trim())>-1)){d.set("errormsg",v.get("tolbl")+" : "+n[i].trim()+v.get("notavalidcontact")),y=!1,a.reject();break}s.push(n[i].trim())}return d.get("errormsg")||(o.list=s,g.request("CheckRecipientList",o,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.fulfill()}else d.set("errormsg",t.error),a.reject()})),a};return f.plugins.addAll({labels:new n(v),errormsg:new n(d),reply:new n(c,{setAvatar:function(e){this.setAttribute("style","background: url('"+s.get("avatar")+"') no-repeat center center;background-size:cover;")},setCC:function(e){switch(e){case"replyall":break;case"forward":break;default:this.innerHTML=c.get("message").username}},setSubject:function(e){switch(e){case"replyall":break;case"forward":break;default:this.innerHTML="  Re : "+c.get("message").object}}}),replyevent:new r(f)}),f.template='<div><div class="avatar" data-reply="bind: setAvatar, message.author"></div><form class="form"><p><textarea name="toList" class="mail-header" data-labels="bind:placeholder, tocontactlbl" data-reply="bind: value, toList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea name="ccList" class="mail-header" data-labels="bind:placeholder, cclbl" data-reply="bind: value, ccList" data-replyevent="listen: mousedown, displayAutoContact; listen:keypress, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><span class="subject" data-labels="bind:innerHTML, subjectlbl"></span><span data-reply="bind:innerHTML, object"></span></p><p><textarea class="input" data-reply="bind:value, body"></textarea></p><blockquote class="original" data-reply="bind:innerHTML, original"></blockquote><p><legend>Signature</legend><textarea class="signature" data-reply="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-replyevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-replyevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div>',f.reset=function(e,t){h=e,c.reset({signature:"",original:"",author:m.get("_id"),username:m.get("username"),firstname:m.get("firstname"),toList:"",ccList:"",object:"",body:""}),c.set("type",t),m.get("signature")?c.set("signature",m.get("signature")):c.set("signature",m.get("username")),c.set("original",v.get("on")+o.formatDate(e.date)+"</p><p>"+e.username+v.get("ideawrotelbl")+"</p><p>"+v.get("subjectlbl")+e.object+"</p><hr><p>"+e.body+"</p>");switch(t){case"replyall":e.ccList?c.set("toList",e.username.concat(", "+e.ccList)):c.set("toList",e.username),e.object.search("Re :")!==0?c.set("object","Re : "+e.object):c.set("object",e.object);break;case"forward":c.set("toList",""),e.object.search("Fwd :")!==0?c.set("object","Fwd : "+e.object):c.set("object",e.object);break;default:c.set("toList",e.username),e.object.search("Re :")!==0?c.set("object","Re : "+e.object):c.set("object",e.object)}c.set("message",e),f.place(document.getElementById("msgreply"))},f.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){c.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new a(r,t,s),p.name=i,r.classList.remove("invisible")},f.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?p.name.init():p.name.updateList()},f.press=function(e,t){t.classList.add("pressed")},f.cancel=function(e,t){t.classList.remove("pressed"),y=!1,document.getElementById("msgreply").classList.add("invisible")},f.send=function(e,t){var n=new Date,r={};t.classList.remove("pressed"),y||(y=!0,d.set("errormsg",""),r=JSON.parse(c.toJSON()),r.type="MSG",r.body=r.body.concat("<br><br>"+r.original),r.dest=[],w(function(e){r.dest=e}).then(function(){d.get("errormsg")?(console.log(result),y=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],g.request("Notify",r,function(e){y=!1,d.set("errormsg",v.get("messagesentok")),setTimeout(function(){d.set("errormsg",""),y=!1,document.getElementById("msgreply").classList.add("invisible")},2e3)}))}))},f}}),define("connect/messages/message-detail",["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/avatar","service/utils","./message-reply"],function(e,t,n,r,s,o,u,a,f){return function(c){var h=new e,p=new f,d=new n,v=new n({response:""}),m=t.get("labels"),g=t.get("user"),y=t.get("observer"),b=t.get("transport");return h.template='<div id="msgdetail"><div class="header blue-dark"><span class="subjectlbl" data-label="bind:innerHTML, subjectlbl"></span><span data-message="bind:setObject, type"></span></div><div class="msgdetailarea"><div class = "detail-contents"><div class="detail-header"><div class="msgoptions" data-message="bind: showOptions, type"><div class="defaultmsgoption"><div name="reply" class="msgreply" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="more" class="more" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div><div class="msgoptionlist invisible"><div name="replyall" class="replyall sort-button" data-label="bind:innerHTML, replyalllbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="forward" class="forward sort-button" data-label="bind:innerHTML, forwardlbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div><div name="deletemsg" class="deletemsg sort-button" data-label="bind:innerHTML, deletelbl" data-messageevent="listen:mousedown, press; listen:mouseup, action"></div></div></div><div data-message="bind:setAvatar, author"></div><p data-message="bind:innerHTML, username"></p><p class="toList"><span data-label="bind: innerHTML, tolbl"></span><span data-message="bind: setToList, toList"></span></p><p class="toList invisible" data-message="bind:showCcList, ccList"><span data-label="bind: innerHTML, cclbl"></span><span data-message="bind: innerHTML, ccList"></span></p><p class="msgdate"><span class="date" data-message="bind: date, date"></span></p></div><div class="detail-body"><p data-message="bind:setBody, type"></p><p data-message="bind:setSignature, type"></p><p class="invisible" data-message="bind:setJoinMsg, sessionStatus"></p><div class="showdoc" data-message="bind: showDocBtn, type" data-messageevent="listen:mousedown, press; listen:mouseup, showDoc"></div><div class="gotosession invisible" data-message="bind: showSessionBtn, sessionStatus" data-messageevent="listen:mousedown, press; listen:mouseup, gotoSession"></div><div class="goto2q invisible" data-message = "bind: showTwoQ, type" data-messageevent="listen: mousedown, press; listen: mouseup, showTwoQ"></div><div class="acceptrejectCXR invisible" data-message="bind:showCXRbtn, type"><div class="acceptCXR" data-label="bind:innerHTML, accept" data-messageevent="listen:mousedown, press; listen:mouseup, acceptCXR"></div><div class="rejectCXR" data-label="bind:innerHTML, reject" data-messageevent="listen:mousedown, press; listen:mouseup, rejectCXR"></div></div></div></div><div id="msgreply" class="invisible"></div><div id="CXRconfirm" class="invisible" data-cxr="bind:setVisibility, response"><span class="CXRconfirmed" data-cxr="bind:setResponseMessage, response"></span></div></div></div>',h.plugins.addAll({label:new s(m),message:new s(d,{date:function w(w){var e=new Date,t=w[3],n=w[4],r=w[5];w&&w[0]===e.getFullYear()&&w[1]===e.getMonth()&&w[2]===e.getDate()?(t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r):this.innerHTML=a.formatDate(w)+"  "+t+":"+n},setObject:function(e){switch(e){case"CXR":this.innerHTML=d.get("username")+m.get("CXRobject");break;case"INV":this.innerHTML=d.get("username")+m.get("INVObject");break;case"CXRaccept":this.innerHTML=d.get("username")+m.get("acceptedCXR");break;case"CXRreject":this.innerHTML=d.get("username")+m.get("rejectedCXR");break;case"CXCancel":this.innerHTML=d.get("username")+m.get("canceledCX");break;case"DOC":this.innerHTML=d.get("username")+m.get("sentdocmsg");break;case"2Q+":this.innerHTML=d.get("username")+m.get("askednew");break;case"2C+":this.innerHTML=d.get("username")+m.get("senttc");break;case"REF":this.innerHTML=messages.get(id).username+m.get("joinedideafy");break;default:this.innerHTML=d.get("object")}},setBody:function(e){switch(e){case"CXRaccept":this.innerHTML=m.get("youlbl")+m.get("nowconnected")+d.get("username");break;case"DOC":this.innerHTML="<p>"+d.get("body")+"</p><p>"+d.get("username")+"</p><p>"+d.get("signature")+"</p><br><br><p>"+m.get("clicktoview")+" : <b>"+d.get("docTitle")+"</b></p>";break;case"INV":this.innerHTML=d.get("username")+m.get("INVObject")+" : <b>"+d.get("docTitle")+"</b>";break;case"REF":this.innerHTML=m.get("referral");break;default:this.innerHTML=d.get("body").replace(/\n/g,"<br>")}},setSignature:function(e){e==="MSG"?(this.classList.remove("invisible"),this.innerHTML=d.get("signature")):this.classList.add("invisible")},showOptions:function(e){e.search("CX")>-1||e==="2Q+"||e==="INV"?this.classList.add("invisible"):this.classList.remove("invisible")},setToList:function(e){e?this.innerHTML=e:this.innerHTML=m.get("melbl")},showCcList:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showCXRbtn:function(e){e==="CXR"?this.classList.remove("invisible"):this.classList.add("invisible")},showDocBtn:function(e){e==="DOC"?this.classList.remove("invisible"):this.classList.add("invisible")},showSessionBtn:function(e){console.log(e),e&&e==="waiting"&&!d.get("joined")?this.classList.remove("invisible"):this.classList.add("invisible")},setJoinMsg:function(e){e?(this.classList.remove("invisible"),e==="unavailable"?this.innerHTML=m.get("nolongerjoin"):e==="joined"?this.innerHTML=m.get("joinedsession"):e==="waiting"&&(this.innerHTML=m.get("clicktojoin"))):this.classList.add("invisible")},showTwoQ:function(e){e==="2Q+"||e==="2C+"?this.classList.remove("invisible"):this.classList.add("invisible")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),cxr:new s(v,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setResponseMessage:function(e){e==="YES"?this.innerHTML=m.get("CXRaccepted")+d.get("username")+m.get("isnowacontact"):this.innerHTML=m.get("CXRrejected")}}),messageevent:new o(h)}),h.showDoc=function(e,t){t.classList.remove("pushed"),d.get("type")==="DOC"&&y.notify("display-doc",d.get("docId"),d.get("docType"))},h.showTwoQ=function(e,t){t.classList.remove("pushed"),d.get("type")==="2Q+"&&y.notify("display-twoq",d.get("docId"),d.get("author")),d.get("type")==="2C+"&&y.notify("display-twoc")},h.press=function(e,t){t.classList.add("pushed")},h.action=function(e,t){var n=t.getAttribute("name"),r=document.getElementById("msgreply"),i=document.querySelector(".msgoptionlist");switch(n){case"more":i.classList.remove("invisible");break;case"reply":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"reply"),r.classList.remove("invisible");break;case"replyall":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"replyall"),r.classList.remove("invisible");break;case"forward":i.classList.add("invisible"),p.reset(JSON.parse(d.toJSON()),"forward"),r.classList.remove("invisible");break;case"deletemsg":i.classList.add("invisible"),h.deletemsg(d.toJSON()),c("#defaultPage");break;default:}t.classList.remove("pushed")},h.deletemsg=function(e){var t=g.get("notifications"),n;for(i=0,l=t.length;i<l;i++)if(JSON.stringify(t[i])===e){n=i;break}t.splice(n,1),g.set("notifications",t),g.upload()},h.acceptCXR=function(e,t){var n=g.get("connections"),r=g.get("news")||[],s=0,o=new Date,u=[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];t.classList.remove("pushed");for(i=0,l=n.length;i<l;i++)n[i].type==="user"?(n[i].lastname<d.get("contactInfo").lastname&&s++,n[i].lastname===d.get("contactInfo").lastname&&n[i].firstname<d.get("contactInfo").firstname&&s++):n[i].username<d.get("contactInfo").lastname&&s++;n.splice(s,0,d.get("contactInfo")),g.set("connections",n),r.unshift({type:"CX+",date:u,content:{userid:d.get("author"),username:d.get("username")}}),g.set("news",r),g.upload().then(function(){var e={dest:[d.get("author")],date:u,original:"",type:"CXRaccept",author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:d.get("username"),ccList:"",object:g.get("username")+m.get("acceptedCXR"),body:m.get("youlbl")+m.get("nowconnected")+g.get("username"),signature:"",contactInfo:{firstname:g.get("firstname"),lastname:g.get("lastname"),userid:g.get("_id"),username:g.get("username"),intro:g.get("intro"),type:"user"}};v.set("response","YES"),b.request("Notify",e,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){h.deletemsg(d.toJSON()),c("#defaultPage")},1e3)})})},h.rejectCXR=function(e,t){var n,r=new Date;t.classList.remove("pushed"),v.set("response","NO"),n={dest:[d.get("author")],original:"",date:[r.getFullYear(),r.getMonth(),r.getDate(),r.getHours(),r.getMinutes(),r.getSeconds()],type:"CXRreject",author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:d.get("username"),ccList:"",object:g.get("username")+m.get("rejectedCXR"),body:"",signature:""},b.request("Notify",n,function(e){JSON.parse(e)[0].res==="ok"&&setTimeout(function(){h.deletemsg(d.toJSON()),c("#defaultPage")},1500)})},h.checkSessionStatus=function(e){var n=new r;n.setTransport(b),n.sync(t.get("db"),e).then(function(){console.log(n.get("status")),n.get("status")==="waiting"?d.set("sessionStatus","waiting"):d.set("sessionStatus","unavailable"),n.unsync()},function(e){alert(e)})},h.gotoSession=function(e,n){var r=g.get("notifications");n.classList.remove("pressed"),d.set("joined",!0),t.get("observer").notify("join-musession",d.get("docId"));for(i=0,l=r.length;i<l;i++)if(r[i].type==="INV"&&r[i].docId===d.get("docId")){r[i].joined=!0;break}g.set("notifications",r),g.upload()},h.reset=function(e){d.reset({}),v.reset({response:""}),d.reset(e),p.reset(e,"reply"),console.log(e),d.get("type")==="INV"&&(d.get("joined")?d.set("joined",!0):(d.set("sessionStatus",null),h.checkSessionStatus(d.get("docId"))))},h}}),define("connect/messages/newmessage",["OObject","Bind.plugin","Event.plugin","service/config","Store","Promise","service/autocontact","lib/spin.min"],function(e,t,n,r,s,o,u,a){return function(f){var c=new e,h=new s,p=new s({errormsg:""}),d=r.get("labels"),v=r.get("user"),m=r.get("transport"),g=!1,y=(new a({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin(),b={},w=function(e){var t=h.get("toList").toLowerCase().split(/,|;/),n=h.get("ccList").toLowerCase().split(/,|;/),r=JSON.stringify(v.get("connections")).toLowerCase(),s=[],u={},a=new o;arr=[];for(i=0,l=t.length;i<l;i++){if(!(r.search(t[i].trim())>-1)){p.set("errormsg",d.get("tolbl")+" : "+t[i].trim()+d.get("notavalidcontact")),g=!1,a.reject();break}s.push(t[i].trim())}if(!p.get("errormsg")&&n[0]!=="")for(i=0,l=n.length;i<l;i++){if(!(r.search(n[i].trim())>-1)){p.set("errormsg",d.get("tolbl")+" : "+n[i].trim()+d.get("notavalidcontact")),g=!1,a.reject();break}s.push(n[i].trim())}return p.get("errormsg")||(u.list=s,m.request("CheckRecipientList",u,function(t){var n=[];if(!t.error){for(i=0,l=t.length;i<l;i++)n.push(t[i].value);e(n),a.fulfill()}else p.set("errormsg",t.error),a.reject()})),a};return c.plugins.addAll({labels:new t(d),errormsg:new t(p),newmessage:new t(h,{setAvatar:function(e){this.setAttribute("style","background: url('"+r.get("avatar")+"') no-repeat center center;background-size:cover;")}}),newmessageevent:new n(c)}),c.template='<div id="newmsg"><div class="header blue-dark"><span data-labels="bind: innerHTML, newmsg">New message</span></div><div class="avatar" data-newmessage="bind: setAvatar, author"></div><form class="form"><p><textarea class="mail-header" name="toList" data-newmessage="bind: value, toList" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"></textarea></p><div id="tolistauto" class="invisible"></div><p><textarea class="mail-header" name="ccList" data-newmessage="bind: value, ccList" data-labels="bind:placeholder, cclbl" data-newmessageevent="listen: mousedown, displayAutoContact; listen:keyup, updateAutoContact"></textarea></p><div id="cclistauto" class="invisible"></div><p><input type="text" class="input" data-newmessage="bind:value, object" data-labels="bind:placeholder, subjectlbl"></p><p><textarea class="input" data-newmessage="bind:value, body"></textarea></p><p><legend>Signature</legend><textarea class="signature" data-newmessage="bind:value, signature"></textarea></p><div class="sendmail-footer"><p class="send"><label class="cancelmail" data-labels="bind:innerHTML, cancellbl" data-newmessageevent="listen: mousedown, press; listen:mouseup, cancel">Cancel</label><label class="sendmail" data-labels="bind:innerHTML, sendlbl" data-newmessageevent="listen:mousedown, press; listen:mouseup, send">Send</label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></form></div>',c.reset=function(e){var t,n,r="";h.reset({author:v.get("_id"),username:v.get("username"),firstname:v.get("firstname"),type:"MSG",signature:v.get("username"),toList:"",ccList:"",object:"",body:"",date:null}),v.get("signature")?h.set("signature",v.get("signature")):h.set("signature",v.get("username")),p.reset({errormsg:""});if(e){console.log(e);if(e.type==="user")h.set("toList",e.username);else{for(t=0,n=e.contacts.length;t<n;t++)r?r=r+", "+e.contacts[t].username:r=e.contacts[t].username;h.set("toList",r)}}},c.press=function(e,t){t.classList.add("pressed")},c.cancel=function(e,t){t.classList.remove("pressed"),g=!1,c.reset(),f("#defaultPage")},c.displayAutoContact=function(e,t){var n=t.getAttribute("name"),r,i,s=function(e){h.set(n,e)};n==="toList"?r=document.getElementById("tolistauto"):r=document.getElementById("cclistauto"),i=new u(r,t,s),b.name=i,r.classList.remove("invisible")},c.updateAutoContact=function(e,t){var n=t.getAttribute("name");e.keyCode===13?t.removeChild(t.firstChild):e.keyCode===186||e.keyCode===188?b.name.init():b.name.updateList()},c.send=function(e,t){var n=new Date,r={};t.classList.add("invisible"),t.classList.remove("pressed"),y.spin(t.parentNode),g||(g=!0,p.set("errormsg",""),r.author=h.get("author"),r.username=h.get("username"),r.firstname=h.get("firstname"),r.signature=h.get("signature"),r.toList=h.get("toList"),r.ccList=h.get("ccList"),r.object=h.get("object"),r.body=h.get("body"),r.type="MSG",h.get("object")||(p.set("errormsg",d.get("entersubjectlbl")),g=!1),r.dest=[],w(function(e){r.dest=e}).then(function(){p.get("errormsg")?(console.log(result),g=!1):(r.date=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],m.request("Notify",r,function(e){g=!1,y.stop(),t.classList.remove("invisible"),c.reset(),p.set("errormsg",d.get("messagesentok")),setTimeout(function(){p.set("errormsg",""),t.classList.remove("invisible"),f("#defaultPage")},2e3)}))}))},c}}),define("connect/messages/messages",["OObject","service/map","Bind.plugin","Event.plugin","Amy/Control-plugin","Amy/Stack-plugin","Store","service/config","service/avatar","service/utils","./message-detail","./newmessage","service/actionbar","Promise"],function(e,t,n,r,s,o,u,a,f,c,h,p,d,v){return function(){var m=new e,g=new o,y=function(e){g.getStack().show(e)},b="#defaultPage",w=new e,E=new h(y),S=new p(y),x=new u([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),T=0,N=new u([]),C=a.get("labels"),k=!1,L=a.get("user"),A=a.get("observer"),O=function(e){var t=x.get(e).name,n=L.get("notifications"),r,i=n.length,s=[];switch(t){case"messages":for(r=0;r<i;r++)n[r].type==="MSG"&&s.push(n[r]);break;case"notifications":for(r=0;r<i;r++)n[r].type!=="MSG"&&s.push(n[r]);break;case"unread":for(r=0;r<i;r++)n[r].status==="unread"&&s.push(n[r]);break;default:s=n}return s},M=function(e){var t=[],n=[];t=L.get("notifications").concat();if(e==="")n=t,x.update(0,"selected",!0),T=0;else for(i=0,l=t.length;i<l;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&n.push(t[i]);return n};return m.plugins.addAll({label:new n(C),sort:new n(x,{setLabel:function(e){this.innerHTML=C.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),msg:new n(N,{setObject:function(e){var t=this.getAttribute("data-msg_id");switch(e){case"INV":this.innerHTML=N.get(t).username+C.get("INVObject");break;case"CXR":this.innerHTML=N.get(t).username+C.get("CXRobject");break;case"CXRaccept":this.innerHTML=N.get(t).username+C.get("acceptedCXR");break;case"CXRreject":this.innerHTML=N.get(t).username+C.get("rejectedCXR");break;case"CXCancel":this.innerHTML=N.get(t).username+C.get("canceledCX");break;case"DOC":this.innerHTML=N.get(t).username+C.get("sentdocmsg");break;case"2Q+":this.innerHTML=N.get(t).username+C.get("askednew");break;case"2C+":this.innerHTML=N.get(t).username+C.get("senttc");break;case"REF":this.innerHTML=N.get(t).username+C.get("joinedideafy");break;default:this.innerHTML=N.get(t).object}},date:function _(_){var e=new Date;if(_&&_[0]===e.getFullYear()&&_[1]===e.getMonth()&&_[2]===e.getDate()){var t=_[3],n=_[4],r=_[5];t<10&&(t="0"+t),n<10&&(n="0"+n),r<10&&(r="0"+r),this.innerHTML=t+":"+n+":"+r}else this.innerHTML=c.formatDate(_)},highlight:function(e){e&&e==="unread"?this.classList.add("unread"):this.classList.remove("unread")},setAvatar:function(e){var t,n;e&&(t=document.createDocumentFragment(),n=new f([e]),n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))}}),msglistevent:new r(m),msglistcontrol:new s(m),msgdetailstack:g}),m.template='<div id="connect-messages"><div class="messages"><div class="header blue-light"><span data-label="bind: innerHTML, msglistheadertitle">My Messages</span><div class="option right" data-msglistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-msglistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-msglistevent="listen: keypress, search"><div class="msglist overflow" data-msglistcontrol="radio:li,selected,mouseup,selectMsg"><ul data-msg="foreach"><li class="msg list-item" data-msglistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-msg="bind:setAvatar, author"></div><p class="msg-author unread" data-msg="bind:highlight, status; bind:innerHTML, username">Author</p><div class="select-msg"></div><span class="date" data-msg="bind: date, date"></span><p class="msg-subject unread" data-msg="bind:highlight, status; bind:setObject, type">Subject</p></li></ul></div></div><div id="msg-detail" class="details" data-msgdetailstack="destination"></div></div>',m.place(t.get("connect-messages")),m.plus=function(e,t){g.getStack().get("#newmsg").reset(),g.getStack().show("#newmsg")},m.displaySort=function(e,t){var n=t.getAttribute("data-sort_id");N.reset([]),g.getStack().show("#defaultPage"),T>-1&&x.update(T,"selected",!1),x.update(n,"selected",!0),T=n,N.reset(O(n))},m.search=function(e,t){e.keyCode===13&&(x.update(T,"selected",!1),T=-1,N.reset(M(t.value)))},m.selectMsg=function(e,t){var n=e.target.getAttribute("data-msg_id"),r=L.get("notifications"),s;if(N.get(n).status==="unread"){for(i=0,l=r.length;i<l;i++)if(JSON.stringify(r[i])===JSON.stringify(N.get(n))){index=i;break}N.update(n,"status","read"),r[index]=N.get(n),L.set("notifications",r),L.upload()}g.getStack().show("#msgdetail"),E.reset(N.get(n)),b="#msgdetail"},m.init=function(){N.reset(L.get("notifications")),m.cleanOld()},m.reset=function(){x.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),m.init(),g.getStack().show("#defaultPage")},m.getSelectedmsg=function(){var e=document.querySelector(".msg.selected"),t=-1;return e&&(t=e.getAttribute("data-msg_id")),t},m.cleanOld=function(){var e=new v,t=new Date,n,r,s=!1,o=L.get("notifications")||[],u=L.get("sentMessages")||[];for(i=o.length-1;i>=0;i--)n=new Date(o[i].date[0],o[i].date[1],o[i].date[2],o[i].date[3],o[i].date[4],o[i].date[5]),t.getTime()-n.getTime()>2592e6&&(o.pop(),s=!0);for(i=u.length-1;i>=0;i--)r=new Date(u[i].date[0],u[i].date[1],u[i].date[2],u[i].date[3],u[i].date[4],u[i].date[5]),t.getTime()-r.getTime()>2592e6&&(u.pop(),s=!0);return s?(L.set("notifications",o),L.set("sentMessages",u),L.upload().then(function(){e.fulfill()})):e.fulfill(),e},m.setStart=function(e,t){document.querySelector(".actionbar")&&m.hideActionBar()},m.showActionBar=function(e,t){var n=t.getAttribute("data-msg_id"),r=new d("message",t,N.get(n),m.hideActionBar),i=document.createDocumentFragment();r.place(i),t.appendChild(i),k=!0},m.hideActionBar=function(){var e=document.querySelector(".actionbar"),t=e.parentNode;t.removeChild(t.lastChild),k=!1},w.template='<div class="msgsplash"><div class="header blue-dark"><span>'+a.get("labels").get("messageview")+'</span></div><div class="innersplash" data-labels="bind: innerHTML, messagecenter"></div></div>',w.plugins.add("labels",new n(C)),m.init(),g.getStack().add("#defaultPage",w),g.getStack().add("#msgdetail",E),g.getStack().add("#newmsg",S),g.getStack().show("#defaultPage"),L.watchValue("notifications",function(){var e,t=[];N.reset([]),t=O(T),N.reset(t),g.getStack().getCurrentName()==="#msgdetail"&&(e=m.getSelectedmsg(),e>-1?E.reset(N.get(e)):g.getStack().show("#defaultPage"))}),A.watch("display-message",function(e){var t=L.get("notifications");x.update(T,"selected",!1),t[e].type==="MSG"?(x.update(1,"selected",!0),T=1):(x.update(2,"selected",!0),T=2),t[e].status="read",L.set("notifications",t),L.upload(),N.reset([t[e]]),document.querySelector('li[data-msg_id="0"]').classList.add("selected"),msgControl.init(document.querySelector('li[data-msg_id="0"]')),g.getStack().show("#msgdetail"),E.reset(t[e]),b="#msgdetail"}),A.watch("message-contact",function(e){S.reset(e),g.getStack().show("#newmsg")}),L.watchValue("lang",function(){var e;x.loop(function(t,n){t.selected&&(e=n)}),x.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),x.update(e,"selected",!0)}),m}}),define("connect/twocents/mtc-details",["OObject","service/config","Store","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","service/avatar","service/utils","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f){return function(){var n=new e,i=t.get("labels"),s=t.get("user"),u=new o("connect");return n.plugins.addAll({labels:new r(i),place:new f({TwocentUI:u})}),n.template='<div class="twocent-detail"><div class="header blue-dark"><span data-labels="bind: innerHTML, mytwocentwall"></span></div><div class = "detail-contents"><div id="connect-twocents" class="twocents" data-place="place: TwocentUI"></div></div></div>',n.reset=function(){u.reset(s.get("_id"),"connect")},n}}),define("connect/twocents/mtq-details",["OObject","service/config","Store","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","service/avatar","service/utils","Place.plugin"],function(e,t,n,r,i,s,o,u,a,f){return function(){var l=new e,c=t.get("labels"),h=t.get("user"),p=new n,d=new s("connect"),v=new o("connect"),m;return l.plugins.addAll({labels:new r(c),tqdetail:new r(p,{setHeader:function(e){e?e===h.get("_id")?this.innerHTML=c.get("mytqdetailheader"):this.innerHTML=c.get("tqheaderprefix")+p.get("username")+c.get("tqheadersuffix"):this.innerHTML=c.get("selecttq")},displayWriteTwocent:function(e){!e||e===h.get("_id")?this.classList.add("invisible"):this.classList.remove("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("connect-writetwocents").classList.add("invisible")},displayTwocentNB:function(e){var t=e.length||0;t?t===1?this.innerHTML=t+" "+c.get("showonetcreply"):this.innerHTML=t+"showtcrepliesafter":this.innerHTML=c.get("noreplyyet")},date:function g(g){g&&(this.innerHTML=a.formatDate(g))},setAuthor:function(e){e===h.get("username")&&p.get("author")===h.get("_id")?this.innerHTML=c.get("youlbl"):this.innerHTML=e},setWrotelbl:function(e){e===h.get("_id")?this.innerHTML=c.get("youwrotelbl"):this.innerHTML=c.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new u([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)}}),place:new f({TwoQTwocentList:v}),tqevent:new i(l)}),l.template='<div class="twocent-detail"><div class="header blue-dark"><span data-tqdetail="bind: setHeader, author"></span></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-tqdetail="bind:setAvatar, author"></div><span class="author" data-tqdetail="bind:setAuthor,username"></span><span class="commentlbl" data-tqdetail="bind: setWrotelbl, author"></span><p data-tqdetail="bind:innerHTML,question"></p><span class="date" data-tqdetail="bind:date, creation_date"></span></div><div class="detail-body"></div><div class="detail-footer"><div class="tcbutton" data-tqevent="listen:mousedown, press; listen: mouseup, write"></div><div class="tcreplies" data-tqdetail = "bind: displayTwocentNB, twocents"></div></div><div id="connect-writetwocents" class="invisible" data-tqdetail="bind: displayWriteTwocent, author"></div><div id="connect-twocents" class="twocents" data-tqdetail="bind: displayTwocentList, twocents" data-place="place:TwoQTwocentList"></div></div></div>',l.press=function(e,t){t.classList.add("pressed")},l.write=function(e,t){t.classList.remove("pressed"),document.getElementById("connect-writetwocents").classList.remove("invisible")},l.hide=function(){document.querySelector(".detail-contents").classList.add("invisible"),p.reset({})},l.reset=function(e){p.reset(e.value),d.reset(p.get("_id")),v.reset(p.get("_id")),m=l.dom.querySelector("#connect-writetwocents"),d.place(m)},l.place(document.createDocumentFragment()),l}}),define("connect/twocents/mtc-stack",["OObject","service/map","Amy/Stack-plugin","Bind.plugin","./mtc-details","./mtq-details","service/config","Store"],function(e,t,n,r,i,s,o,u){return function(){var t=new e,u=new e,a=o.get("labels"),f=new n;return t.template='<div id = "mtcdetailstack" data-mtcdetailstack = "destination"></div>',t.plugins.addAll({mtcdetailstack:f}),t.setView=function(e){var t=f.getStack().getCurrentName();e==="2Q"&&t!=="twoqdetail"?f.getStack().show("twoqdetail"):e==="2C"&&t!=="twocdetail"?(f.getStack().get("twocdetail").reset(),f.getStack().show("twocdetail")):f.getStack().show("defaultPage")},t.reset=function(e,t){e==="2Q"&&t&&(f.getStack().get("twoqdetail").reset(t),f.getStack().show("twoqdetail")),(e==="default"||!t)&&f.getStack().show("defaultPage")},u.template='<div class="msgsplash"><div class="header blue-dark" data-labels="bind: innerHTML, twocentview"><span></span></div><div class="innersplash" data-labels="bind: innerHTML, twocentcenter"></div></div>',u.plugins.add("labels",new r(a)),t.init=function(e,t){var n=new s,r=new i;f.getStack().add("twoqdetail",n),f.getStack().add("twocdetail",r),f.getStack().add("defaultPage",u),e==="default"&&f.getStack().show("defaultPage"),e==="2Q"&&(f.getStack().show("twoqdetail"),twoQDetail.reset(t))},t}}),define("connect/twocents/twoqlist",["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,r,i,s,o,u,a,f){function l(e,l,c,h,p){var d=new n([]),v=new t([]),m=!1,g="",y=null,b={db:l,view:h,design:c,query:{descending:!0}},w=r.get("labels"),E=this;d.setTransport(r.get("transport")),e==="contact"?g="contacttwoqlist":g="",this.template='<div><ul class="twoq-list '+g+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+g+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new i(d,{date:function S(S){S?this.innerHTML=o.formatDate(S):this.innerHTML=""},showReplies:function(e){var t;e&&(t=e.length),t===0?this.innerHTML=w.get("noreplyyet"):t===1?this.innerHTML=t+" "+w.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+w.get("showtcrepliesafter"))},setAvatar:function(e){var t,n;e&&(n=document.createDocumentFragment(),t=new u([e]),t.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new i(v,{date:function x(x){x?this.innerHTML=o.formatDate(x):this.innerHTML=""},showReplies:function(e){var t;e&&(t=e.length),t===0?this.innerHTML=w.get("noreplyyet"):t===1?this.innerHTML=t+" "+w.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+w.get("showtcrepliesafter"))},setAvatar:function(e){var t,n;e&&(n=document.createDocumentFragment(),t=new u([e]),t.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setVisibility:function(e){e&&e==="public"?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new s(this)}),this.getModel=function(){var e,t;return t=!E.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),t?e=v:e=d,e},this.resetQuery=function(e){var t=new f;return b.query=e,d.unsync(),d.reset([]),E.hideSearch(),d.sync(b.db,b.design,b.view,b.query).then(function(){t.fulfill()}),t},this.setStart=function(e,t){y&&this.hideActionBar(y)},this.showActionBar=function(e,t){var n=t.getAttribute("data-twoqlist_id"),r=document.getElementById("mtc-list"),i,s;r.classList.contains("mosaic")||(actionBar=new a("2Q",t,d.get(n).value,this.hideActionBar),s=document.createDocumentFragment(),actionBar.place(s),t.appendChild(s),y=actionBar,m=!0)},this.hideActionBar=function(e){var t=e.dom.parentElement;t.removeChild(t.lastChild),m=!1,y=null},this.showSearch=function(){var e=document.querySelector(".twoq-searchlist"),t=document.querySelector(".twoq-list");e&&e.classList.contains("invisible")&&(t.classList.add("invisible"),e.classList.remove("invisible"))},this.hideSearch=function(){var e=this.dom.querySelector(".twoq-searchlist"),t=this.dom.querySelector(".twoq-list");e&&!e.classList.contains("invisible")&&(t.classList.remove("invisible"),e.classList.add("invisible"))},this.search=function(e){v.reset([]),e.toLowerCase()?(this.showSearch(),d.loop(function(t,n){JSON.stringify(t).search(e)>-1&&v.alter("push",t)})):this.hideSearch()},p&&(b.query=p),this.init=function(){var e=new f;return d.sync(b.db,b.design,b.view,b.query).then(function(){e.fulfill()}),e}}return function(t,n,r,i,s){return l.prototype=new e,new l(t,n,r,i,s)}}),define("connect/twocents/mytwocents",["OObject","service/map","service/config","Bind.plugin","Place.plugin","Amy/Delegate-plugin","Amy/Stack-plugin","Amy/Control-plugin","./mtc-stack","./twoqlist","Store"],function(e,t,n,r,s,o,u,a,f,c,h){return function(){var p=new e,d=new u,v=new a(p),m=new f,g,y,b=[{name:"#mytwoq",active:!0},{name:"#contacttwoq",active:!1},{name:"#mytwoc",active:!1}],w=new h(b),E=new h({view:"#mytwoq"}),S=new h([]),x=n.get("user"),T=x.get("connections"),N=n.get("labels"),C=n.get("db");p.plugins.addAll({labels:new r(N),twoqbuttons:new r(w,{setBg:function(e){switch(e){case"#mytwoq":this.classList.add("mytwoq");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.classList.add("mytwoc");break;default:}},setActive:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")}}),mtctools:new r(E,{setVisible:function(e){this.getAttribute("name")===e?this.classList.remove("invisible"):this.classList.add("invisible")},setLegend:function(e){switch(e){case"#mytwoq":this.innerHTML=N.get("mytwoquestions");break;case"#contacttwoq":this.classList.add("contacttwoq");break;case"#mytwoc":this.innerHTML=N.get("mytwocents");break;default:}},updateLegend:function(e){e&&E.get("view")==="#contacttwoq"&&(this.innerHTML=N.get("twoqprefix")+e+N.get("twoqsuffix"))}}),auto:new r(S),mtcliststack:d,mtcdetails:new s({mtcDetails:m}),mtccontrol:v,mtcevent:new o(p)}),p.template='<div id="connect-tc"><div id="mtc-list"><div class="header blue-light"><span data-labels="bind: innerHTML, mtcheadertitle"></span><div class="option right" data-mtcevent="listen: mousedown, plus"></div></div><ul class="twoqbuttons" data-twoqbuttons="foreach"><li data-twoqbuttons="bind: setBg,name; bind:setActive, active" data-mtcevent="listen:mousedown, selectView; listen: mouseup, showView"></li></ul><div class="selectcontact" name = "#contacttwoq" data-mtctools="bind:setVisible, view"><legend>Select a contact</legend><input class="search" data-mtcevent="listen:mousedown, updateAutoContact; listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl" data-mtctools = "bind:value, contact"><div class="rightcaret" data-mtcevent="listen: mousedown, updateAutoContact"></div><div class = "autocontact invisible"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-mtcevent="listen:mousedown, highlightContact; listen:mouseup, selectContact"></li></ul></div></div><legend data-mtctools="bind:setLegend, view; bind: updateLegend, contact"></legend><input name="#mytwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: input, search"><input name="#contacttwoq" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><input name="#mytwoc" class="search" type="text" data-mtctools="bind:setVisible, view" data-labels="bind: placeholder, searchmsgplaceholder" data-mtcevent="listen: keypress, search"><div data-mtcliststack="destination" data-mtccontrol="radio:li,selected,mousedown,selectStart"></div></div><div id="mtc-detail" data-mtcdetails="place:mtcDetails" class="details"></div></div>',p.place(t.get("connect-twocents")),p.plus=function(){t.get("new2q-popup").classList.add("appear"),t.get("cache").classList.add("appear")},p.selectView=function(e,t){var n=t.getAttribute("data-twoqbuttons_id");w.loop(function(e,t){t===parseInt(n)?w.update(t,"active",!0):w.update(t,"active",!1)}),E.set("view",w.get(n).name)},p.showView=function(e,t){var n=t.getAttribute("data-twoqbuttons_id");switch(w.get(n).name){case"#mytwoq":d.getStack().show("#mytwoq"),m.setView("#defaultPage");break;case"#contacttwoq":d.getStack().show("#contacttwoq"),m.setView("#defaultPage");break;case"#mytwoc":d.getStack().show("#blank"),m.setView("2C")}},p.updateAutoContact=function(e,t){var n=JSON.parse(S.toJSON()),r,s,o=document.getElementById("mtc-list"),u=o.querySelector(".autocontact");u.classList.contains("invisible")&&u.classList.remove("invisible"),e.keyCode===8&&(t.value="");if(!t.value||t.value===""){n=[];for(i=0,l=T.length;i<l;i++)T[i].type==="user"&&n.push({contact:T[i]});S.reset(n)}else{s=t.value.toLowerCase();for(i=n.length-1;i>=0;i--)r=n[i].contact.username.toLowerCase(),r.search(s)!==0&&n.splice(i,1);S.reset(n)}e.keyCode===13&&(t.value===""?(d.getStack().show("#blank"),m.getStack().show("defaultPage")):S.getNbItems()?(E.set("contact",S.get(0).contact.username),y.resetQuery({key:'"'+S.get(0).contact.userid+'"',descending:!0}).then(function(){var e=y.getModel(),t;e.getNbItems()?(d.getStack().show("#contacttwoq"),m.reset("2Q",e.get(0)),t=y.dom.querySelector("li[data-twoqlist_id='0']"),v.init(t),t.classList.add("selected"),m.reset("2Q",e.get(0))):(d.getStack().show("#blank"),m.reset("default"))})):(d.getStack().show("#blank"),m.reset("default")))},p.highlightContact=function(e,t){t.classList.add("highlighted")},p.selectContact=function(e,t){var n=t.getAttribute("data-auto_id"),r=document.getElementById("mtc-list"),i=r.querySelector(".autocontact");t.classList.remove("highlighted"),E.set("contact",S.get(n).contact.username),i.classList.add("invisible"),y.resetQuery({key:'"'+S.get(n).contact.userid+'"',descending:!0}).then(function(){var e=y.getModel(),t;e.getNbItems()?(d.getStack().show("#contacttwoq"),m.reset("2Q",e.get(0)),t=y.dom.querySelector("li[data-twoqlist_id='0']"),v.init(t),t.classList.add("selected"),m.reset("2Q",e.get(0))):(d.getStack().show("#blank"),m.reset("default"))})},p.selectStart=function(e,t){var n=d.getStack().getCurrentScreen().getModel(),r;if(E.get("view")==="#mytwoq"||E.get("view")==="#contacttwoq")r=e.target.getAttribute("data-twoqlist_id")||e.target.getAttribute("data-twoqsearch_id"),m.reset("2Q",n.get(r))},p.search=function(e,t){d.getStack().getCurrentScreen().search(t.value)},p.reset=function(){var e;w.reset(b),E.set("view","#mytwoq"),S.reset([]),T=x.get("connections");for(e=0,l=T.length;e<l;e++)T[e].type==="user"&&S.alter("push",{contact:T[e],selected:!1});g.resetQuery({key:n.get("uid"),descending:!0}).then(function(){d.getStack().show("#mytwoq"),m.reset("default")})},n.get("observer").watch("display-twoq",function(e,t){y.resetQuery({key:'"'+t+'"',descending:!0}).then(function(){var t=y.getModel(),n,r;d.getStack().show("#contacttwoq"),E.set("view","#contacttwoq"),w.loop(function(e,t){e.name==="#contacttwoq"?w.update(t,"active",!0):w.update(t,"active",!1)}),t.loop(function(t,r){t.id===e&&(n=r,E.set("contact",t.value.username))}),r=y.dom.querySelector("li[data-twoqlist_id='"+n+"']"),v.init(r),r.classList.add("selected"),m.reset("2Q",t.get(n))})}),n.get("observer").watch("display-twoc",function(){d.getStack().show("#blank"),E.set("view","#mytwoc"),w.loop(function(e,t){e.name==="#mytwoc"?w.update(t,"active",!0):w.update(t,"active",!1)}),m.setView("2C")});for(i=0,l=T.length;i<l;i++)T[i].type==="user"&&S.alter("push",{contact:T[i],selected:!1});return g=new c("user",C,"questions","_view/questionsbyauthor",{key:n.get("uid"),descending:!0}),y=new c("contact",C,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:!0}),blank=new c("user",C,"questions","_view/questionsbyauthor",{key:'"Blank_List"',descending:!0}),d.getStack().add("#mytwoq",g),d.getStack().add("#contacttwoq",y),d.getStack().add("#blank",blank),y.init(),blank.init(),g.init().then(function(){d.getStack().show("#mytwoq"),m.init("default")}),p}}),define("connect/connect",["OObject","service/map","Amy/Stack-plugin","service/submenu","./contacts/contacts","./messages/messages","./twocents/mytwocents","service/config"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=new n,l=u.get("observer"),c=function(e){f.getStack().show(e)},h,p=new s,d=new i,v=new o;return a.plugins.add("connectstack",f),a.template='<div id="connect"><div id="connect-menu"></div><div class="stack" data-connectstack="destination"></div></div>',a.place(t.get("connect")),a.showMenu=function(){h.toggleActive(!0)},a.hideMenu=function(){h.toggleActive(!1)},a.reset=function(){h.reset(),d.reset(),p.reset(),v.reset(),f.getStack().show("#messages")},h=new r(a.dom.querySelector("#connect-menu"),c),h.toggleActive(!1),p.init(),d.init(),f.getStack().add("#messages",p),f.getStack().add("#contacts",d),f.getStack().add("#twocents",v),f.getStack().show("#messages"),l.watch("display-message",function(e){f.getStack().show("#messages")}),l.watch("display-twoq",function(){f.getStack().show("#twocents")}),l.watch("display-twoc",function(){f.getStack().show("#twocents")}),l.watch("message-contact",function(){f.getStack().show("#messages")}),a}}),define("dashboard/profile/leaderboard",["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","service/utils","service/avatar"],function(e,t,n,r,i,s,o){return function(){var u=new e,a=new i([]);return u.template='<div><ul data-leaders="foreach"><li class="leader" data-leaders="bind:setSpotLight, value.userid"><div data-leaders="bind:setAvatar, value.userid"></div><div class="username" data-leaders="bind:innerHTML, value.username"></div><div class="distinction" data-leaders="bind:setDistinction, value.ip"></div><div class="grade" data-leaders="bind:setGrade, value.ip"></div><div class="score" data-leaders="bind: setScore, value.ip"></div></li></ul></div>',u.plugins.addAll({leaders:new n(a,{setSpotLight:function(e){e===t.get("user").get("_id")?(this.classList.add("userleader"),this.scrollIntoView(!1)):this.classList.remove("userleader")},setAvatar:function(e){var t,n;e&&(n=document.createDocumentFragment(),t=new o([e]),t.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n))},setGrade:function(e){var t=this;s.getGrade(e,function(e){t.setAttribute("style","background: url('img/profile/"+e.grade.badge+"') no-repeat center center; background-size: 40px 40px;")})},setDistinction:function(e){var t=this;s.getGrade(e,function(e){e.distinction&&t.setAttribute("style","background: url('img/profile/"+e.distinction.badge+"') no-repeat center center; background-size: 40px 40px;")})},setScore:function(e){this.innerHTML=e+" ip"}}),leaderevent:new r(u)}),u.init=function(e){a.setTransport(t.get("transport")),a.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0}).then(function(){u.place(e)})},t.get("observer").watch("reconnect",function(){a.unsync(),a.reset([]),a.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0})}),u}}),define("dashboard/profile/editprofile",["OObject","service/config","Bind.plugin","Event.plugin","service/avatar","service/utils","Store","lib/spin.min","LocalStore"],function(e,t,n,r,i,s,o,u,a){return function(){var i=new e,f=t.get("user"),l=new o,c=[{name:"azur",file:"img/avatars/deedee0.png",selected:!1},{name:"blue",file:"img/avatars/deedee1.png",selected:!1},{name:"green",file:"img/avatars/deedee2.png",selected:!1},{name:"grey",file:"img/avatars/deedee3.png",selected:!1},{name:"orange",file:"img/avatars/deedee4.png",selected:!1},{name:"red",file:"img/avatars/deedee5.png",selected:!1},{name:"yellow",file:"img/avatars/deedee6.png",selected:!1}],h=new o(c),p={},d=new o({status:null}),v=t.get("labels"),m=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:360})).spin(),g=80,y=80,b=function(e){var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)},w=function(e){var t,n,r=document.createElement("canvas"),i=r.getContext("2d");return t=e.width,n=e.height,t<n?(n*=g/t,t=g):(t*=y/n,n=y),r.width=t,r.height=n,i.drawImage(e,0,0,t,n),r.toDataURL("image/png")},E=function(e){var t=new Image,n=document.createElement("canvas"),r=document.getElementById("avatarcanvas"),i=n.getContext("2d"),s=r.scrollWidth,o=r.scrollHeight,u,a;t.src=e,setTimeout(function(){n.width=s,n.height=o,u=Math.floor(Math.max(0,(t.width-s)/2)),a=Math.floor(Math.max(0,(t.height-o)/2)),i.drawImage(t,u,a,s,o,0,0,s,o),l.set("avatar",n.toDataURL("image/png"))},300)},S=function(e){var t="/upload",n=new FormData;n.append("type","avatar"),n.append("filename",p.picture_file),n.append("img",l.get("avatar")),s.uploadFile(t,n,d,function(e){e.response!=="ok"&&console.log(e)})};return i.plugins.addAll({label:new n(v),avatars:new n(h,{setPic:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setChecked:function(e){e?this.innerHTML="&#10003;":this.innerHTML=""}}),progress:new n(d,{showProgress:function(e){var t=0;e&&(t=Math.floor(e/100*80)),this.setAttribute("style","width:"+t+"px;"),e===100?this.innerHTML=v.get("uploadcomplete"):this.innerHTML=""}}),profile:new n(l,{setAvatar:function(e){this.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")},setDay:function(e){e[2]&&(this.value=e[2])},setMonth:function(e){var t=e[1]||0;this.value=this.options[t].innerHTML},setYear:function(e){e[0]&&(this.value=e[0])},setFamilyStatus:function(e){if(e||e===0)this.selectedIndex=e},setChildren:function(e){if(e||e===0)this.selectedIndex=e},setSituation:function(e){if(e||e===0)this.selectedIndex=e},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(r){e[r]&&n.search(r)>0&&(t.value=e[r].comment)})}}),editprofileevent:new r(i)}),i.template='<div><div class = "setavatar"><canvas id ="avatarcanvas" class="currentavatar" data-profile="bind:setAvatar, avatar" data-editprofileevent="listen:mousedown, changeAvatar"></canvas><div id="rotate" class="invisible" data-editprofileevent="listen:mousedown, rotateAvatar"></div><div id="changeavatar" class="invisible"><div class="avatarcache"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editprofileevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl" data-editprofileevent="listen: mousedown, press; listen: mouseup, release"></div></span><p data-label="bind:innerHTML, selectavatar"></p><ul class="defaultlist" data-avatars="foreach"><li><div class="defaultAvatar" data-avatars="bind: setPic, file"></div><div class="checkbox" data-avatars="bind: setChecked, selected" data-editprofileevent="listen: mouseup, setDefaultAvatar"></div></li></ul></div></div><form class="profileinfo"><div class = "username"><div class = "firstname"><label data-label="bind:innerHTML, firstnameplaceholder"></label><input class="input" name="firstname" type="text" data-profile="bind: value, firstname" data-editprofileevent="listen: input, updateField"></div><div class = "lastname"><label data-label="bind:innerHTML, lastnameplaceholder"></label><input class="input" type="text" name="lastname" data-profile="bind: value, lastname" data-editprofileevent="listen: input, updateField"></div></div><label data-label="bind:innerHTML, profileintro"></label><input class="input" name="intro" type="text" data-profile="bind:value, intro" data-label="bind:placeholder, shortprofiledesc" data-editprofileevent="listen: input, updateField"><label data-label="bind:innerHTML, dob"></label><div class="dob"><input class="day" name="day" type="text" data-label="bind:placeholder, day" data-profile="bind: setDay, birthdate" data-editprofileevent="listen:input, updateDate"><select name="month" data-profile="bind: setMonth, birthdate" data-editprofileevent="listen:change, updateDate"><option data-label="bind:innerHTML, jan"></option><option data-label="bind:innerHTML, feb"></option><option data-label="bind:innerHTML, mar"></option><option data-label="bind:innerHTML, apr"></option><option data-label="bind:innerHTML, may"></option><option data-label="bind:innerHTML, jun"></option><option data-label="bind:innerHTML, jul"></option><option data-label="bind:innerHTML, aug"></option><option data-label="bind:innerHTML, sep"></option><option data-label="bind:innerHTML, oct"></option><option data-label="bind:innerHTML, nov"></option><option data-label="bind:innerHTML, dec"></option></select><input class="year" name="year" type="text" data-label="bind:placeholder,year" data-profile="bind: setYear, birthdate" data-editprofileevent="listen:input, updateDate"></div><div class="postal"><label class="streetaddress" data-label="bind:innerHTML, mailaddress"></label><input class="streetaddress input" name="street1" type="text" data-label="bind:placeholder, street" data-profile="bind:value, address.street1" data-editprofileevent="listen:input, updateAddress"><div class="city"><label data-label="bind:innerHTML, city"></label><input class="input city" name="city" type="text" data-profile="bind:value, address.city" data-editprofileevent="listen:input, updateAddress"></div><div class="zipstate"><div class="state"><label data-label="bind:innerHTML, state"></label><input class="input" name="state" placeholder="" type="text" data-profile="bind:value, address.state" data-editprofileevent="listen:input, updateAddress"></div><div class="zip"><label data-label="bind:innerHTML, zip"></label><input class="input" name="zip" placeholder="" type="text" data-profile="bind:value, address.zip" data-editprofileevent="listen:input, updateAddress"></div></div><label data-label="bind:innerHTML, country"></label><input class="input" name="country" type="text" data-profile="bind:value, address.country" data-editprofileevent="listen:input, updateAddress"></div><label data-label="bind:innerHTML, myfamily"></label><div class="family"><select class="status" name="couple" data-profile="bind: setFamilyStatus, family.couple" data-editprofileevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select><select class="children" name="children" data-profile="bind: setChildren, family.children" data-editprofileevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><label data-label="bind:innerHTML, children"></label></div><label data-label="bind:innerHTML, myoccupation"></label><div class="job"><select class="status" name="situation" data-profile="bind: setSituation, occupation.situation" data-editprofileevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select><div class="jobdesc"><label data-label="bind:innerHTML, jobtitle"></label><input class="input" type="text" name="job" data-profile="bind:value, occupation.job" data-label="bind:placeholder, jobtitle" data-editprofileevent="listen:input, updateJob"></div><div class="org"><label data-label="bind:innerHTML, organization"></label><input class="input" name="organization" type="text" data-profile="bind:value, occupation.organization" data-label="bind:placeholder,organization" data-editprofileevent="listen:input, updateJob"></div></div></form><form class="addtlinfo"><legend data-label="bind:innerHTML, socialnwlbl"></legend><ul class="socialnw"><li class="fb"><input class="input" type="text" name="facebook" data-profile="bind: value, facebook" data-editprofileevent="listen: input, updateField"></li><li class="gp"><input class="input" name="gplus" type="text" data-profile="bind: value, gplus" data-editprofileevent="listen: input, updateField"></li><li class="lin"><input class="input" name="linkedin" type="text" data-profile="bind: value, linkedin" data-editprofileevent="listen: input, updateField"></li><li class="tw"><input class="input" name="twitter" type="text" data-profile="bind: value, twitter" data-editprofileevent="listen: input, updateField"></li></ul><legend data-label="bind:innerHTML, hobbieslbl"></legend><label data-label="bind:innerHTML, name"></label><label class="description" data-label="bind:innerHTML, comment"></label><input name="leisure0" class="input" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input" type="text"  data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><input class="input" name="leisure2" type="text" data-profile="bind: setLeisureName, leisure_activities" data-editprofileevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-profile="bind: setLeisureDesc, leisure_activities" data-editprofileevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><label data-label="bind:innerHTML, field"></label><label class="description" data-label="bind:innerHTML, comment"></label><input class="input" name="interest0" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest1" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"><input class="input" name="interest2" type="text" data-profile="bind: setInterestName, interests" data-editprofileevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-profile="bind: setInterestDesc, interests" data-editprofileevent="listen: input, updateInterestDesc"></form><div class="useascharacter"></div><p class="update"><label class="cancelprofile" data-label="bind:innerHTML, cancellbl" data-editprofileevent="listen: mousedown, press; listen:mouseup, cancel"></label><label class="updateprofile" data-label="bind:innerHTML, updatelbl" data-editprofileevent="listen:mousedown, press; listen:mouseup, update"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p><div class="uploadprogress" data-progress="bind:showProgress, status"></div></div>',i.init=function(e){i.reset(),i.place(e)},i.selectpress=function(e,t){t.value=""},i.press=function(e,t){t.classList.add("pressed")},i.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},i.uploadnDisplay=function(e,t){var n=new Image,r=new FileReader,i=new FileReader,s=document.getElementById("avatarcanvas");r.onload=function(e){n.src=e.target.result,setTimeout(function(){E(w(n)),p.picture_file=f.get("_id")+"_@v@t@r",document.getElementById("changeavatar").classList.add("invisible")},300)},r.readAsDataURL(t.files[0])},i.changeAvatar=function(e,t){document.getElementById("changeavatar").classList.remove("invisible"),d.set("status",0)},i.setDefaultAvatar=function(e,t){var n=t.getAttribute("data-avatars_id");h.loop(function(e,t){t===parseInt(n)?h.update(t,"selected",!0):h.update(t,"selected",!1)}),l.set("avatar",h.get(n).file),p.picture_file=h.get(n).file,document.getElementById("changeavatar").classList.add("invisible")},i.rotateAvatar=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d"),i=new Image;i.src=l.get("avatar"),setTimeout(function(){n.width=i.width,n.height=i.height,r.translate(n.width/2,n.height/2),r.rotate(Math.PI/2),r.translate(-n.height/2,-n.width/2),r.drawImage(i,0,0),l.set("avatar",n.toDataURL("image/png"))},300)},i.reset=function(){l.reset(JSON.parse(f.toJSON())),l.set("avatar",t.get("avatar")),h.reset(c),p={},l.get("picture_file").search("img/avatars/deedee")>-1&&h.loop(function(e,t){l.get("picture_file").search(e.file)>-1&&h.update(t,"selected",!0)})},i.updateField=function(e,t){var n=t.getAttribute("name");p[n]=t.value,l.set(n,t.value)},i.updateDate=function(e,t){var n=l.get("birthdate"),r=t.getAttribute("name"),i;switch(r){case"year":n[0]=t.value;break;case"month":n[1]=t.selectedIndex;break;case"day":n[2]=t.value}l.set("birthdate",n),p.birthdate=n},i.updateAddress=function(e,t){var n=l.get("address"),r=t.getAttribute("name");n[r]=t.value||"",l.set("address",n),p.address=n},i.updateFamily=function(e,t){var n=t.getAttribute("name"),r=l.get("family");r[n]=t.selectedIndex,l.set("family",r),p.family=r},i.updateJob=function(e,t){var n=l.get("occupation"),r=t.getAttribute("name"),i;switch(r){case"situation":n.situation=t.selectedIndex;break;case"job":n.job=t.value;break;case"organization":n.organization=t.value}p.occupation=n},i.updateLeisureName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=l.get("leisure_activities");i[r].name=t.value,l.set("leisure_activities",i),p.leisure_activities=i},i.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=l.get("leisure_activities");i[r].comment=t.value,l.set("leisure_activities",i),p.leisure_activities=i},i.updateInterestName=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=l.get("interests");i[r].name=t.value,l.set("interests",i),p.interests=i},i.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),r=n.charAt(n.length-1),i=l.get("interests");i[r].comment=t.value,l.set("interests",i),p.interests=i},i.press=function(e,t){t.classList.add("pressed")},i.cancel=function(e,t){t.classList.remove("pressed"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible")},i.update=function(e,n){var r,i=0;n.classList.remove("pressed"),n.classList.add("invisible"),m.spin(n.parentNode);for(r in p)f.set(r,p[r]),i++;i?f.upload().then(function(){var e=new a;p.picture_file&&(t.set("avatar",l.get("avatar")),e.sync("ideafy-data"),e.set("userAvatar",t.get("avatar"))),p.picture_file&&p.picture_file.search("img/avatars/deedee")<0&&(S(),document.getElementById("rotate").classList.add("invisible")),m.stop(),n.classList.remove("invisible"),t.get("observer").notify("profile-updated"),document.querySelector(".edituserdetails").classList.add("invisible"),document.querySelector(".userdetails").classList.remove("invisible")}):(m.stop(),n.classList.remove("invisible"),document.querySelector(".userdetails").classList.remove("invisible"),document.querySelector(".edituserdetails").classList.add("invisible"))},i}}),define("dashboard/profile/profile",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","./leaderboard","./editprofile","Promise"],function(e,t,n,r,s,o,u,a,f,c){return function(){var h=new e,p=s.get("user"),d=p.get("ip"),v=s.get("labels"),m=new o({total:0,ideas:0,sessions:0,contacts:0,twoQ:0}),g=new o({status:""}),y=new o({view:"info",completion:0,socialnw:0}),b=new o(p.get("news")),w,E,S=new o([]),x=new o;return h.plugins.addAll({label:new n(v),stats:new n(y,{setViewLbl:function(e){this.innerHTML=v.get(e)},toggleInformation:function(e){e==="info"?this.classList.remove("invisible"):this.classList.add("invisible")},toggleLeaderboard:function(e){e==="leaderboard"?this.classList.remove("invisible"):this.classList.add("invisible")},setPercentage:function(e){this.innerHTML=v.get("completionprefix")+e+v.get("completionsuffix")},setProgress:function(e){e===100?this.setAttribute("style","width:100%;border-top-right-radius:5px;border-bottom-right-radius:5px;"):this.setAttribute("style","width:"+e+"%;")},showDetails:function(e){e===100?this.classList.add("invisible"):this.classList.remove("invisible")},showSocialNW:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),grades:new n(S,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new n(x,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),progressbar:new n(m,{setWidth:function(e){this.setAttribute("style","width:"+e+"%;")}}),progress:new n(g),config:new n(s,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),user:new n(p,{setLocation:function(e){e.country?this.innerHTML=e.country.toUpperCase():this.innerHTML=v.get("completeprofile"),e.city&&e.country&&(this.innerHTML=e.city+", "+e.country.toUpperCase()),e.city&&e.state&&e.country&&(this.innerHTML=e.city+", "+e.state.toUpperCase()+" "+e.country.toUpperCase())},setAge:function(e){var t=new Date,n,r;e&&e.length===3?(n=new Date(e[0],e[1],e[2]),r=t.getTime()-n.getTime(),this.innerHTML=Math.floor(r/1e3/3600/24/365)+" "+v.get("agelbl")):this.innerHTML=v.get("completeprofile")},setFamily:function(e){var t=e.couple,n=e.children,r,i;t===null?r=v.get("completeprofile"):t===0?r=v.get("singlelbl"):t===1?r=v.get("marriedlbl"):t===2?r=v.get("divorcedlbl"):t===3&&(r=v.get("widowlbl")),!n||n===0?i="":(p.get("age")<20?n===1?i=n+v.get("onesiblinglbl"):i=n+v.get("siblingslbl"):n===1?i=n+v.get("onechildlbl"):i=n+v.get("childrenlbl"),i=", "+i),this.innerHTML=r+i},setOccupation:function(e){e.situation===4?this.innerHTML=v.get("stayathome"):e.situation===3?this.innerHTML=v.get("unemployed"):e.situation===0?e.organization?this.innerHTML=v.get("student")+" @ "+e.organization:this.innerHTML=v.get("student"):e.situation===2?e.job?this.innerHTML=e.job+" ("+v.get("retired")+")":this.innerHTML=v.get("retired"):e.situation===1?!e.job&&!e.organization?this.innerHTML=v.get("active"):e.job&&!e.organization?this.innerHTML=e.job:!e.job&&e.organization?this.innerHTML=v.get("active")+" @ "+e.organization:this.innerHTML=e.job+" @ "+e.organization:this.innerHTML=v.get("completeprofile")},showLeisure:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setLeisure:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)e[i].comment?t+="<li>"+e[i].name+" ("+e[i].comment+")</li>":t+="<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showInterests:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setInterests:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)e[i].comment?t+="<li>"+e[i].name+" ("+e[i].comment+")</li>":t+="<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showSN:function(e){e?this.innerHTML=e:this.innerHTML=""},setSessionCount:function(e){var t=p.get("su_sessions_count")||0,n=p.get("mu_sessions_count")||0;this.innerHTML=t+n},setContactCount:function(e){var t=0;for(i=0,l=e.length;i<l;i++)e[i].type==="user"&&t++;this.innerHTML=t},setBarLength:function(e){e>=3e5?this.setAttribute("style","width: 100%"):e>=3e4?this.setAttribute("style","width: 75%"):e>=3e3?this.setAttribute("style","width: 50%"):this.setAttribute("style","width: 25%")}}),news:new n(b,{setType:function(e){e.search("CX")>-1?this.setAttribute("style","background: url('img/profileDisable.png') no-repeat center center; background-size: contain;"):e.search("RWD")>-1||e.search("RANK")>-1?this.setAttribute("style","background: url('img/brainstorm/yourScore40.png') no-repeat center center; background-size: 40px;"):e.search("ID")>-1?this.setAttribute("style","background: url('img/libraryIdeaDisabled40.png') no-repeat center center; background-size: 40px;"):e.search("2Q")>-1?this.setAttribute("style","background: url('img/2questionDisable50.png') no-repeat center center; background-size: 40px;"):e.search("2CTS")>-1&&this.setAttribute("style","background: url('img/2centDisable.png') no-repeat center center; background-size: 40px;")},setContent:function(e){var t=this.getAttribute("data-news_id");switch(b.get(t).type){case"CX+":this.innerHTML="<span class='newsinfo'>"+b.get(t).content.username+"</span>"+v.get("isnowacontact");break;case"CX-":this.innerHTML="<span class='newsinfo'>"+b.get(t).content.username+"</span>"+v.get("isnolongeracontact");break;case"IDEA+":this.innerHTML=v.get("enterednewidea")+"<span class='newsinfo'>"+b.get(t).content.title+"</span>";break;case"SHID":this.innerHTML=v.get("sharedanidea")+"("+"<span class='newsinfo'>"+b.get(t).content.title+"</span>)";break;case"RANK":this.innerHTML=v.get("reachedrank")+"<span class='newsinfo'>"+b.get(t).content.label+"</span>";break;case"RWD":this.innerHTML=v.get("gotaward")+"<span class='newsinfo'>"+b.get(t).content.label+"</span>";break;case"2Q+":this.innerHTML=v.get("posted2q")+"<span class='newsinfo'>"+b.get(t).content.question+"</span>";break;case"2CTS":this.innerHTML=v.get("commentedon")+"<span class='newsinfo'>"+b.get(t).content.title+"</span>"+v.get("by")+b.get("id").content.username}},formatDate:function(e){this.innerHTML=u.formatDate(e)}}),profileevent:new r(h)}),h.template='<div id="dashboard-profile"><div class="header blue-dark"><span data-label="bind:innerHTML, profilelbl"></span></div><input class="infoslider" type="range" min="0" max="1" value ="0" data-profileevent="listen:mouseup, switchLeaderboard"><span class="slidertext" data-stats="bind:setViewLbl, view"></span><div id="profile-content" data-stats="bind:toggleInformation, view"><div class="leftprofile"><div class="userdetails"><div class="editbtn" data-profileevent="listen:mousedown, edit"></div><div class="cd-picarea"><div class="cardpicture" data-config="bind:setAvatar, avatar"></div><div class="cardinfo"><h2 data-user="bind:innerHTML,username"></h2><blockquote data-user="bind:innerHTML, intro"></blockquote><p><span class="cd-agelbl"></span><span data-user="bind:setAge, birthdate"></span></p><p><span class="cd-locationlbl"></span><span class="cd-info" data-user="bind: setLocation, address"></span></p><p><span class="cd-joblbl"></span><span class="cd-info" data-user="bind: setOccupation, occupation"></span></p><p><span class="cd-familylbl"></span><span class="cd-info" data-user="bind: setFamily, family"></span></p></div></div><div class="cd-contentarea"><div data-user="bind:showLeisure, leisure_activities"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl"></span><p class = "userinfo" data-user="bind:setLeisure, leisure_activities"></p></div><div data-user="bind:showInterests, interests"><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "userinfo" data-user="bind: setInterests, interests"></p></div><div data-stats="bind:showSocialNW, socialnw"><span class="contentTitle" data-label="bind: innerHTML, socialnwlbl"></span><p class = "userinfo fb" data-user="bind:showSN, facebook"></p><p class = "userinfo gp" data-user="bind:showSN, gplus; bind:innerHTML"></p><p class = "userinfo tw" data-user="bind:showSN, twitter"></p><p class = "userinfo lin" data-user="bind:showSN, linkedin"></p></div></div><div><legend data-stats="bind: setPercentage, completion"></legend><div class="completionbar"><div class="innerbar" data-stats = "bind:setProgress, completion"></div></div></div></div><div class="edituserdetails invisible"></div><div class="mystats"><legend data-label="bind:innerHTML, mystatslbl"></legend><div class="completionbar"><ul data-user="bind: setBarLength, ip"><li class="innerbar myids" data-progressbar="bind: setWidth, ideas"></li><li class="innerbar myss" data-progressbar="bind:setWidth, sessions"></li><li class="innerbar myctcts" data-progressbar="bind: setWidth, contacts"></li><li class="innerbar my2q" data-progressbar="bind:setWidth, twoQ"></li></ul></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-user="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-user="bind: setSessionCount, ip"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-user="bind: setContactCount, connections"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-user="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="recentactivity"><legend data-label="bind:innerHTML, recentactivitylbl"></legend><ul data-news="foreach"><li><div class="newstype" data-news="bind:setType, type"></div><div class="newsdate" data-news="bind:formatDate, date"></div><p class="newstext" data-news="bind:setContent, content"></p></li></ul></div></div><div class = "rightprofile"><div class="userscore"><span class="ip" data-user="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><div class="userachievements"><h2 class="grade" data-stats="bind:innerHTML, title"></h2><ul class="badges" data-grades="foreach"><li class="badge"><div data-grades="bind:showBadge, badge"></div><legend data-grades="bind:innerHTML, title"></legend></li></ul><ul class="badges" data-achievements="foreach"><li class="badge"><div data-achievements="bind:showBadge, badge"></div><legend data-achievements="bind:innerHTML, label"></legend></li></ul></div></div></div><div id="leaderboard" data-stats="bind:toggleLeaderboard, view"></div></div>',h.place(t.get("dashboard-profile")),h.switchLeaderboard=function(e,t){var n=document.getElementById("leaderboard"),r=document.getElementById("profile-content");w||(w=new a,w.init(n)),t.value==1?(t.setAttribute("style","background: #5F8F28;"),y.set("view","leaderboard")):(t.setAttribute("style","background: #9AC9CD;"),y.set("view","info"))},h.edit=function(e,t){var n=document.querySelector(".edituserdetails");document.querySelector(".userdetails").classList.add("invisible"),E?E.reset():(E=new f,E.init(n)),n.classList.remove("invisible")},s.get("observer").watch("profile-updated",function(e){h.checkProfileCompletion().then(function(){h.updateGrade(),h.updateAchievements()})}),p.watchValue("ip",function(){h.updateGrade(),h.updateProgressBar()}),p.watchValue("tutorial_complete",function(){h.updateGrade(),h.updateAchievements()}),p.watchValue("settings",function(){h.updateGrade(),h.updateAchievements()}),p.watchValue("news",function(){b.reset(p.get("news"))}),p.watchValue("lang",function(){h.updateGrade().then(function(){h.updateAchievements()}),b.reset([]),b.reset(p.get("news"))}),h.checkProfileCompletion=function(){var e=u.checkProfileCompletion(),t=new c;return y.set("completion",e.percentage),y.set("missing",e.missing),e.missing.indexOf(v.get("entersocialnw"))<0&&y.set("socialnw",1),e.percentage===100&&p.get("profile_complete")!==!0?(p.set("profile_complete",!0),p.upload().then(function(){t.fulfill()})):e.percentage<100&&p.get("profile_complete")?(p.set("profile_complete",!1),p.upload().then(function(){t.fulfill()})):t.fulfill(),t},h.updateGrade=function(){var e=new c;return u.getGrade(p.get("ip"),function(t){var n;t.distinction?n=[t.grade,t.distinction]:n=[t.grade],S.reset(n),y.set("title",t.grade.label),e.fulfill()}),e},h.updateAchievements=function(){var e=new c;return u.getAchievements(p.get("_id"),function(t){t.length?x.reset(t):x.reset(p.get("achievements")),e.fulfill()}),e},h.updateProgressBar=function(){var e,t,n,r,i,s,o,u,a;t=p.get("ideas_count"),r=p.get("su_sessions_count")||0,i=p.get("mu_sessions_count")||0,n=r+i,o=p.get("twoquestions_count")||0,s=0;for(u=0,a=p.get("connections").length;u<a;u++)p.get("connections")[u].type==="user"&&s++;e=t+o+s+n,m.set("total",e),m.set("ideas",Math.floor(t/e*100)),m.set("contacts",Math.floor(s/e*100)),m.set("sessions",Math.floor(n/e*100)),m.set("twoQ",Math.floor(o/e*100))},h.cleanOldNews=function(){var e=new Date,t=p.get("news"),n,r,i=new c;if(t.length){for(n=t.length-1;n>=0;n--)r=new Date(t[n].date[0],t[n].date[1],t[n].date[2]),e.getTime()-r.getTime()>1296e6&&t.splice(n,1);p.set("news",t),p.upload().then(function(){i.fulfill()})}return i},h.init=function(){h.checkProfileCompletion().then(function(){return h.updateGrade()}).then(function(){return h.updateAchievements()}).then(function(){h.updateProgressBar(),h.cleanOldNews()})},h.reset=function(){b.reset([]),b.reset(p.get("news")),h.init()},h.init(),h}}),define("dashboard/settings/settings",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","CouchDBBulkDocuments"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=i.get("labels"),l=[{name:f.get("public"),dest:"#public"},{name:f.get("library"),dest:"#library"},{name:f.get("brainstorm"),dest:"#brainstorm"},{name:f.get("connect"),dest:"#connect"},{name:f.get("dashboard"),dest:"#dashboard"}],c=[{name:f.get("everymin"),value:6e4},{name:f.get("everyfive"),value:3e5},{name:f.get("everyfifteen"),value:9e5},{name:f.get("never"),value:864e5}],h=new s({screens:l,timers:c,pwd:"",pwdbis:"",lang:[],pwdchange:""}),p=new s,d=i.get("transport"),v=i.get("user");return a.plugins.addAll({label:new n(f),options:new n(h,{setLang:function(e){var t,n,r="";for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t]+"</option>";this.innerHTML=r,this.selectedIndex=e.indexOf(v.get("lang"))},setStartupScreen:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].name+"</option>",e[t].dest===v.get("settings").startupScreen&&(s=t);this.innerHTML=r,this.selectedIndex=s},setPollingInterval:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].name+"</option>",e[t].value===v.get("settings").polling_interval&&(s=t);this.innerHTML=r,this.selectedIndex=s},setDecks:function(e){var t,n,r="",i,s;for(t=0,n=e.length;t<n;t++)r+="<option>"+e[t].title+"</option>",e[t].id===v.get("active_deck")&&(s=t);this.innerHTML=r,this.selectedIndex=s}}),settings:new n(p),settingsevent:new r(a)}),a.template='<div id="dashboard-settings"><div class="header blue-dark"><span data-label="bind:innerHTML, settingslbl"></span></div><div class="settingscontent"><div class="settingmodule"><legend data-label="bind:innerHTML, userpref"></legend><ul><li><span data-label="bind:innerHTML, setlang"></span><select data-options="bind:setLang, lang" data-settingsevent="listen: change, updateLang"></select></li><li class="startupscreen"><span data-label="bind: innerHTML, choosestartup"></span><select data-options="bind:setStartupScreen, screens" data-settingsevent="listen: change, updateStartup"></select></li><li class="startupscreen"><span data-label="bind: innerHTML, choosepolling"></span><select data-options="bind:setPollingInterval, timers" data-settingsevent="listen: change, updatePollingInterval"></select></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, showTips" data-settingsevent="listen: change, showTips"><label data-label="bind:innerHTML, showtips"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, notifyPopup" data-settingsevent="listen: change, showNotif"><label data-label="bind:innerHTML, shownotif"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, useascharacter" data-settingsevent="listen: change, useAsChar"><label data-label="bind:innerHTML, usechar"></label></li><li><span data-label="bind: innerHTML, changepwd"></span><input class="input" type="password" data-label="bind:placeholder, passwordplaceholder" data-options="bind: value, pwd" data-settingsevent="listen: input, clearOK"><input class="input" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-options="bind: value, pwdbis" data-settingsevent="listen: input, clearOK"><span class="changeok" data-options="bind: innerHTML, pwdchange"></span><div class="next-button" data-label="bind:innerHTML, changelbl" data-settingsevent="listen: mousedown, press; listen:mouseup, changePWD"></div></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, brainstormsettings"></legend><ul><li class="activedeck"><span data-label="bind:innerHTML, setdeck">Set brainstorming deck</span><select data-options="bind:setDecks, decks" data-settingsevent="listen: change, updateDeck"></select></li></ul></div></div></div>',a.place(t.get("dashboard-settings")),a.updateLang=function(e,t){t.value!==v.get("lang")&&o.updateLabels(t.value).then(function(){v.set("lang",t.value),v.upload(),h.set("timers",[{name:f.get("everymin"),value:6e4},{name:f.get("everyfive"),value:3e5},{name:f.get("everyfifteen"),value:9e5},{name:f.get("never"),value:864e5}]),h.set("screens",[{name:f.get("public"),dest:"#public"},{name:f.get("library"),dest:"#library"},{name:f.get("brainstorm"),dest:"#brainstorm"},{name:f.get("connect"),dest:"#connect"},{name:f.get("dashboard"),dest:"#dahsboard"}])})},a.getDecks=function(){var e=new u,t=v.get("taiaut_decks").concat(v.get("custom_decks")),n=[];e.setTransport(i.get("transport")),e.sync(i.get("db"),{keys:t}).then(function(){h.set("decks",[]),e.loop(function(e,t){var r=e.doc.content;r.characters.length>=2&&r.contexts.length>=2&&r.problems.length>=2&&r.techno.length>=4&&n.push({id:e.doc._id,title:e.doc.title})}),e.unsync(),n.sort(function(e,t){var n=e.title,r=t.title;if(n<r)return-1;if(n>r)return 1;if(n===r)return 0}),h.set("decks",n)})},a.updateDeck=function(e,t){var n=t.selectedIndex,r=h.get("decks")[n].id;v.set("active_deck",r),v.upload()},a.updateStartup=function(e,t){var n=t.selectedIndex,r=v.get("settings");r.startupScreen=l[n].dest,v.set("settings",r),v.upload()},a.updatePollingInterval=function(e,t){var n=t.selectedIndex,r=v.get("settings");r.polling_interval=c[n].value,v.set("settings",r),v.upload()},a.showTips=function(e,t){var n=v.get("settings");n.showTips=t.checked,v.set("settings",n),v.upload().then(function(){console.log("upload successful")})},a.showNotif=function(e,t){var n=v.get("settings");n.notifyPopup=t.checked,v.set("settings",n),v.upload()},a.useAsChar=function(e,t){var n=v.get("settings");n.useascharacter=t.checked,v.set("settings",n),v.upload()},a.press=function(e,t){t.classList.add("pressed")},a.clearOK=function(e,t){h.set("pwdchange","")},a.changePWD=function(e,t){t.classList.remove("pressed"),h.get("pwd")!==h.get("pwdbis")?h.set("pwdbis",""):d.request("ChangePWD",{userid:v.get("_id"),pwd:h.get("pwd")},function(e){e==="ok"&&h.set("pwdchange","&#10003;")})},a.reset=function(){p.reset(v.get("settings")),v.watchValue("settings",function(e){p.reset(v.get("settings"))}),a.getDecks(),d.request("GetLanguages",{},function(e){h.set("lang",e)}),h.set("timers",[{name:f.get("everymin"),value:6e4},{name:f.get("everyfive"),value:3e5},{name:f.get("everyfifteen"),value:9e5},{name:f.get("never"),value:864e5}]),h.set("screens",[{name:f.get("public"),dest:"#public"},{name:f.get("library"),dest:"#library"},{name:f.get("brainstorm"),dest:"#brainstorm"},{name:f.get("connect"),dest:"#connect"},{name:f.get("dashboard"),dest:"#dahsboard"}])},a.reset(),o.updateLabels(v.get("lang")),v.watchValue("taiaut_decks",a.getDecks),v.watchValue("custom_decks",a.getDecks),v.watchValue("active_deck",a.getDecks),a}}),define("dashboard/about/aboutideafy",["OObject","service/config","Bind.plugin","Store"],function(e,t,n,r){return function(){var i=new e,s=t.get("labels"),o=new r([{name:s.get("solene"),contrib:s.get("contribsolene")},{name:s.get("oliviers"),contrib:s.get("contribscherrer")},{name:s.get("olivierw"),contrib:s.get("contribwietrich")},{name:s.get("vincent"),contrib:s.get("contribvincent")}]);return i.plugins.addAll({labels:new n(s),credits:new n(o)}),i.template='<div class="aboutcontent"><legend data-labels="bind:innerHTML, aboutlbl"></legend><p data-labels="bind:innerHTML, ideafydesc"></p><legend data-labels="bind:innerHTML, about-taiaut"></legend><p data-labels="bind:innerHTML, taiautdesc"></p><legend data-labels="bind: innerHTML, credits"></legend><p><ul data-credits="foreach"><li><span class="contributor" data-credits="bind:innerHTML, name"></span><span class="contribution" data-credits="bind:innerHTML, contrib"></span></li></ul></p></div>',i}}),define("dashboard/about/faq",["OObject","service/config","CouchDBView","Bind.plugin","Event.plugin","Store"],function(e,t,n,r,i,s){return function(){var o=new e,u=new n,a=t.get("user");return faqlist=new s([]),o.plugins.addAll({faq:new r(faqlist),faqevent:new i(o)}),o.template='<div class="aboutcontent"><ul data-faq="foreach"><li><legend data-faq="bind:innerHTML, question"></legend><p data-faq="bind: innerHTML, response"></p></li></ul></div>',u.setTransport(t.get("transport")),o.fetch=function(e){u.unsync(),u.reset([]),faqlist.reset([]),u.sync(t.get("db"),"about","_view/faq").then(function(){u.loop(function(t,n){t.value.default_lang===e||!t.value.translations[e]?faqlist.alter("push",t.value):faqlist.alter("push",t.value.translations[e])})})},o.fetch(a.get("lang")),a.watchValue("lang",function(){o.fetch(a.get("lang"))}),o}}),define("dashboard/about/userguide",["OObject","service/config","CouchDBView","Bind.plugin","Event.plugin","Store"],function(e,t,n,r,i,s){return function(){var o=new e,u=new n,a=t.get("user"),f=t.get("labels"),l=new s([]);return o.plugins.addAll({label:new r(f),howto:new r(l),howtoevent:new i(o)}),o.template='<div class="aboutcontent"><div id="userguidetoc"><legend data-label="bind:innerHTML, toc"></legend><ul data-howto="foreach"><li><span data-howto="bind: innerHTML, title" data-howtoevent="listen: mousedown, press; listen:touchend, goto"></span></li></ul></div><br/><ul data-howto="foreach"><li data-howto="bind:id, _id"><legend data-howto="bind:innerHTML, title"></legend><p data-howto="bind: innerHTML, body"></p><span class="backtotop" data-label="bind:innerHTML, backtotop" data-howtoevent="listen: mousedown, backToTop"></span></li></ul></div>',o.press=function(e,t){t.setAttribute("style","font-weight: bold;")},o.goto=function(e,t){var n=t.getAttribute("data-howto_id"),r=l.get(n)._id;t.setAttribute("style","font-weight: normal;"),document.getElementById(r).scrollIntoView()},o.backToTop=function(e,t){document.getElementById("userguidetoc").scrollIntoView()},u.setTransport(t.get("transport")),o.fetch=function(e){u.unsync(),u.reset([]),l.reset([]),u.sync(t.get("db"),"about","_view/howto").then(function(){u.loop(function(t,n){t.value.default_lang===e||!t.value.translations[e]?l.alter("push",t.value):l.alter("push",t.value.translations[e])})})},o.fetch(a.get("lang")),a.watchValue("lang",function(){o.fetch(a.get("lang"))}),o}}),define("dashboard/about/tutorials",["OObject","service/config","Bind.plugin","Store"],function(e,t,n,r){return function(){var i=new e,s=t.get("labels"),o=[{name:"brainstormtutorial",src:"http://37.153.96.26:1664/tuto04.m4v"}],u=new r(o);return i.plugins.addAll({labels:new n(s),tuto:new n(u,{setName:function(e){this.innerHTML=s.get(e)}})}),i.template='<div class="aboutcontent"><ul data-tuto="foreach"><li><legend data-tuto="bind: setName, name"></legend><div class="videocontent"><video width = "640" height="480" controls="controls"><source data-tuto="bind:src,src" type="video/mp4" /></video></div></li></ul></div>',i}}),define("dashboard/about/support",["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBDocument"],function(e,t,n,r,i,s){return function(){var o=new e,u=t.get("labels"),a=t.get("user"),f=new i({body:"",result:""}),l=new i({}),c=new i({}),h=new s,p=new s;return h.setTransport(t.get("transport")),p.setTransport(t.get("transport")),o.plugins.addAll({labels:new n(u),support:new n(f),news:new n(l,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),maintenance:new n(c,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){this.innerHTML=(new Date(e)).toString()}}),supportevent:new r(o)}),o.template='<div class="aboutcontent"><p class="supportmsg invisible" data-news="bind:setVisible, active; bind:innerHTML, content"></p><legend class="support" data-labels="bind:innerHTML, supportlegend"></legend><textarea class="input" data-labels="bind:placeholder, supportplaceholder" data-support="bind: value, body"></textarea><span data-support="bind:innerHTML, result"></span><div class="cancel" data-labels="bind: innerHTML, cancellbl" data-supportevent="listen: mousedown, press; listen: mouseup, cancel"></div><div class="send" data-labels="bind: innerHTML, sendlbl" data-supportevent="listen: mousedown, press; listen: mouseup, send"></div><div class="maintenancemsg invisible" data-maintenance="bind:setVisible,active"><legend data-labels="bind:innerHTML, schedmaintenance"></legend><p><span data-labels="bind: innerHTML, nextmaintenance"></span><span class="dateandtime" data-maintenance="bind:setDate, date">Sunday April 7th 6:00 EST</span><br/><span data-maintenance="bind:innerHTML, comment"></span></p></div><div class="supportus"><legend data-labels="bind: innerHTML, twoway"></legend><p data-labels="bind: innerHTML, supportusintro"><ul><li><h4 data-labels="bind: innerHTML, asanideafyer"></h4><p data-labels="bind: innerHTML, ideafyerhelp"></p></li><li><h4 data-labels="bind: innerHTML, asanexec"></h4><p data-labels="bind: innerHTML, exechelp"></p></li><li><h4 data-labels="bind: innerHTML, asadev"></h4><p data-labels="bind: innerHTML, devhelp"></p></li><li><h4 data-labels="bind: innerHTML, asaninvest"></h4><p data-labels="bind: innerHTML, investhelp"></p></li></ul></p></div></div>',o.send=function(e,t){t.classList.remove("pressed"),o.sendRequest(f.get("body"))},o.cancel=function(e,t){t.classList.remove("pressed"),f.set("body","")},o.press=function(e,t){t.classList.add("pressed")},o.sendRequest=function(e){var n={},r=new Date;n.request=e,n.date=r.getTime(),n.userid=t.get("user").get("_id"),t.get("transport").request("Support",n,function(e){e==="ok"?f.set("result",u.get("requestsent")):f.set("result",e),setTimeout(function(){f.set("result",""),f.set("body","")},3e3)})},o.setSupportMSG=function(e){h.get("lang")===e||!h.get("translations")[e]?l.reset(JSON.parse(h.toJSON())):l.reset(h.get("translations")[e])},o.setMaintenanceMSG=function(e){p.get("lang")===e||!p.get("translations")[e]?c.reset(JSON.parse(p.toJSON())):c.reset(p.get("translations")[e])},h.sync(t.get("db"),"SUPPORTMSG").then(function(){o.setSupportMSG(a.get("lang"))}),p.sync(t.get("db"),"MAINTENANCE").then(function(){o.setMaintenanceMSG(a.get("lang"))}),a.watchValue("lang",function(){o.setSupportMSG(a.get("lang"),"SUPPORTMSG"),o.setMaintenanceMSG(a.get("lang"),"MAINTENANCE")}),h.watchValue("active",function(){o.setSupportMSG(a.get("lang"))}),p.watchValue("active",function(){o.setMaintenanceMSG(a.get("lang"))}),o}}),define("dashboard/about/eula",["OObject","service/config","Bind.plugin","CouchDBDocument","Store"],function(e,t,n,r,i){return function(){var s=new e,o=t.get("user"),u=new i;return s.plugins.add("eula",new n(u)),s.template='<div class="aboutcontent"><h4 data-eula = "bind:innerHTML, title"></h4><div data-eula="bind:innerHTML, body"></div></div>',s.fetch=function(e){var n=new r;n.setTransport(t.get("transport")),n.sync(t.get("db"),"EULA").then(function(){n.get("default_lang")===e||!n.get("translations")[e]?(u.set("title",n.get("title")),u.set("body",n.get("body"))):(u.set("title",n.get("translations")[e].title),u.set("body",n.get("translations")[e].body))})},s.fetch(o.get("lang")),o.watchValue("lang",function(){s.fetch(o.get("lang"))}),s}}),define("dashboard/about/about",["OObject","service/map","Bind.plugin","Event.plugin","Amy/Stack-plugin","service/config","Store","./aboutideafy","./faq","./userguide","./tutorials","./support","./eula"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){return function(){var p=new e,d=new i,v=s.get("labels"),m=[{name:"#about",label:v.get("aboutIdeafy"),currentUI:!1},{name:"#faq",label:v.get("faq"),currentUI:!1},{name:"#userguide",label:v.get("userguide"),currentUI:!1},{name:"#tutorials",label:v.get("tutorials"),currentUI:!1},{name:"#support",label:v.get("support"),currentUI:!1},{name:"#eula",label:v.get("eula"),currentUI:!1}],g=new o(m);return p.plugins.addAll({label:new n(v),aboutmenu:new n(g,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),aboutstack:d,aboutevent:new r(p)}),p.template='<div id="dashboard-about"><div class="header blue-dark"><span data-label="bind:innerHTML, aboutlbl"></span></div><div class = "progressbar"><ul id = "aboutmenu" class="steplist" data-aboutmenu="foreach"><li class="step" data-aboutmenu="bind: innerHTML, label; bind:setCurrent, currentUI" data-aboutevent="listen: mousedown, changeDisplay"></li></ul></div><div id="aboutstack" data-aboutstack="destination"></div></div>',p.place(t.get("dashboard-about")),p.changeDisplay=function(e,t){var n=t.getAttribute("data-aboutmenu_id");p.show(g.get(n).name)},p.show=function(e){var t;g.loop(function(n,r){g.update(r,"currentUI",!1),n.name===e&&(t=r)}),g.update(t,"currentUI",!0),d.getStack().show(g.get(t).name)},d.getStack().add("#about",new u),d.getStack().add("#faq",new a),d.getStack().add("#userguide",new f),d.getStack().add("#tutorials",new l),d.getStack().add("#support",new c),d.getStack().add("#eula",new h),d.getStack().show("#about"),g.update(0,"currentUI",!0),p}}),define("dashboard/dashboard",["OObject","service/map","service/submenu","Amy/Stack-plugin","./profile/profile","./settings/settings","./about/about","service/config"],function(e,t,n,r,i,s,o,u){return function(){var a=new e,f=new r,l,c,h,p=u.get("observer"),d=function(e){f.getStack().show(e)},v;return a.plugins.add("dashboardstack",f),a.template='<div id="dashboard"><div id="dashboard-menu"></div><div class="stack" data-dashboardstack="destination"></div></div>',a.place(t.get("dashboard")),a.showMenu=function(){v.toggleActive(!0)},a.hideMenu=function(){v.toggleActive(!1)},a.reset=function(){v.reset(),l.reset(),c.reset()},v=new n(a.dom.querySelector("#dashboard-menu"),d),v.toggleActive(!1),l=new i,c=new s,h=new o,f.getStack().add("#profile",l),f.getStack().add("#settings",c),f.getStack().add("#about",h),f.getStack().show("#profile"),u.get("observer").watch("display-tutorials",function(){v.setWidget("#about"),f.getStack().get("#about").show("#tutorials")}),u.get("observer").watch("show-about",function(){v.setWidget("#about"),f.getStack().get("#about").show("#userguide")}),a}}),define("notify",["OObject","service/config","service/map","Store","Bind.plugin","Place.plugin","Event.plugin","service/avatar"],function(e,t,n,r,s,o,u,a){return function(){var n=new e,f=new e,c=t.get("user"),h=t.get("observer"),p=t.get("labels"),d=0,v=0,m=!0,g=new r({unread:0,newmsg:!1}),y=new r([]);return n.plugins.addAll({notif:new s(g,{flashNew:function(e){var t,n=this;e&&(t=setInterval(function(){n.classList.contains("orange")?n.classList.remove("orange"):n.classList.add("orange")},600),setTimeout(function(){clearInterval(t),n.classList.remove("orange"),g.set("newmsg",!1)},3e3))}}),place:new o({notifyPopup:f}),notifevent:new u(n)}),n.template='<div><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: mousedown, push; listen:mouseup, showPopup"></div><div class = "signout-bubble" data-notifevent="listen:mousedown, signout"></div><div class = "info-bubble" data-notifevent="listen:mousedown, press; listen:mouseup, showAbout">i</div><div id="notify-popup" data-place="place:notifyPopup"></div></div>',n.getUnread=function(){var e=c.get("notifications"),t=0;for(i=0,l=e.length;i<l;i++)e[i].status==="unread"&&t++;return t},n.push=function(e,t){t.classList.add("orange"),e.stopPropagation()},n.press=function(e,t){t.classList.add("pressed")},n.showPopup=function(e,t){t.classList.remove("orange"),f.showPopup()},n.signout=function(e,n){document.getElementById("cache").classList.add("appear"),document.getElementById("dock").querySelector(".selected").classList.remove("selected"),document.querySelector('a[href="#public"]').classList.add("selected"),t.get("observer").notify("signout")},n.showAbout=function(e,n){n.classList.remove("pressed"),t.get("observer").notify("goto-screen","#dashboard"),t.get("observer").notify("show-about")},f.plugins.addAll({labels:new s(p),notify:new s(y,{setObject:function(e){var t=this.getAttribute("data-notify_id");if(e)switch(e){case"CXR":this.innerHTML=y.get(t).username+p.get("CXRobject");break;case"INV":this.innerHTML=y.get(t).username+p.get("INVObject");break;case"CXRaccept":this.innerHTML=y.get(t).username+p.get("acceptedCXR");break;case"CXRreject":this.innerHTML=y.get(t).username+p.get("rejectedCXR");break;case"CXCancel":this.innerHTML=y.get(t).username+p.get("canceledCX");break;case"DOC":this.innerHTML=y.get(t).username+p.get("sentdocmsg");break;case"2Q+":this.innerHTML=y.get(t).username+p.get("askednew");break;case"2C+":this.innerHTML=y.get(t).username+p.get("senttc");break;case"REF":this.innerHTML=y.get(t).username+p.get("joinedideafy");break;default:this.innerHTML=y.get(t).object}},setStyle:function(e){e==="unread"?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setAvatar:function(e){var t,n,r=this;e&&(t=document.createDocumentFragment(),n=new a([e]),n.place(t),r.firstChild?r.replaceChild(t,r.firstChild):r.appendChild(t))}}),notifyevent:new u(f)}),f.template='<div class="invisible"><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:mousedown, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:mousedown, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:innerHTML, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>',f.closePopup=function(e,t){f.dom.classList.add("invisible")},f.showPopup=function(e,t){f.dom.classList.remove("invisible")},f.displayComCenter=function(e,t){var n=t.getAttribute("data-notify_id");h.notify("display-message",n)},h.watch("display-message",function(){f.closePopup()}),n.init=function(){n.reset(),f.dom.classList.add("invisible")},n.reset=function(){v=n.getUnread(),g.set("unread",v),g.set("newmsg",!1),y.reset(c.get("notifications"))},c.watchValue("notifications",function(){var e=n.getUnread();y.reset([]),e>v?(g.set("newmsg",!0),g.set("unread",e),v=e,c.get("settings")&&c.get("settings").notifyPopup&&popup.classList.add("show-notify")):e<v&&(g.set("unread",e),v=e),y.reset(c.get("notifications"))}),n}}),define("service/newidea",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min"],function(e,t,n,r,i,s,o){return function(){var u=new e,a=new s(i.get("ideaTemplate")),f=i.get("user"),l=i.get("labels"),c=new s({error:""}),h=(new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return a.setTransport(i.get("transport")),u.plugins.addAll({newidea:new n(a,{setVisibility:function(e){e==="public"?(this.innerHTML=l.get("publicidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 135px center; background-repeat:no-repeat; background-size: 30px;")):(this.innerHTML=l.get("privateidealbl"),this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))},setWarning:function(e){e==="public"?this.classList.remove("invisible"):this.classList.add("invisible")}}),labels:new n(l),errormsg:new n(c,{setError:function(e){switch(e){case"notitle":this.innerHTML=l.get("titlefield")+l.get("emptyfielderror");break;case"nodesc":this.innerHTML=l.get("descriptionfield")+l.get("emptyfielderror");break;case"nosol":this.innerHTML=l.get("solutionfield")+l.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newideaevent:new r(u)}),u.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createidealbl"></span><div class="close-popup" data-newideaevent="listen:mousedown, cancel"></div></div><form class="form"><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, ideatitleplaceholder" data-newidea="bind: value, title" data-newideaevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, ideadescplaceholder" data-newidea="bind: value, description" data-newideaevent="listen: input, resetError"></textarea><textarea class="solution input" data-labels="bind:placeholder, ideasolplaceholder" data-newidea="bind: value, solution" data-newideaevent="listen: input, resetError"></textarea><div class="visibility-input"><input class="visibility-slider" type="range" min=0 max=1 value =1 data-newideaevent="listen:change, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><div class="private" data-newidea="bind: setVisibility, visibility"></div></div><div class="newidea-footer"><div class="publicwarning invisible" data-labels="bind: innerHTML, publicwarning" data-newidea="bind: setWarning, visibility"></div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newideaevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',u.render(),u.place(t.get("newidea-popup")),u.toggleVisibility=function(e,t){t.value==="1"?a.set("visibility","private"):a.set("visibility","public")},u.press=function(e,t){t.classList.add("pressed"),u.dom.querySelector(".publicwarning").classList.add("invisible")},u.closePopup=function(){document.getElementById("newidea-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),a.unsync(),a.reset(i.get("ideaTemplate")),c.reset({error:""}),u.dom.querySelector(".visibility-slider").value=1},u.resetError=function(e,t){var n;t.scrollTop=99999,c.get("error")&&(t.classList.contains("description")?n="nodesc":t.classList.contains("solution")?n="nosol":n="notitle",c.get("error")===n&&t.value&&c.set("error",""))},u.cancel=function(e,t){u.closePopup()},u.upload=function(e,t){var n=new Date,r="I:"+n.getTime(),s;t.classList.remove("pressed"),a.get("title")?a.get("description")?a.get("solution")||c.set("error","nosol"):c.set("error","nodesc"):c.set("error","notitle"),!c.get("error")&&!a.get("_id")&&(t.classList.add("invisible"),h.spin(t.parentNode),s=setInterval(function(){c.get("error")===l.get("uploadinprogress")?c.set("error",l.get("uploadinprogress")+"..."):c.set("error",l.get("uploadinprogress"))},100),a.set("authors",[f.get("_id")]),a.set("authornames",f.get("username")),a.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),a.set("lang",f.get("lang")),a.sync(i.get("db"),r).then(function(){return a.upload()}).then(function(){a.get("visibility")==="public"?i.get("transport").request("UpdateUIP",{userid:f.get("_id"),type:a.get("type"),docId:r,docTitle:a.get("title")},function(e){e!=="ok"&&console.log(e),h.stop(),t.classList.remove("invisible"),u.closePopup(),clearInterval(s)}):(h.stop(),t.classList.remove("invisible"),u.closePopup(),clearInterval(s))}))},u}}),define("service/new2q",["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,n,r,i,s,o,u){return function(){var o=new e,a=new s(i.get("TQTemplate")),f=i.get("user"),l=i.get("labels"),c=140,h=new s({error:""}),p=(new u({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340})).spin();return a.setTransport(i.get("transport")),o.plugins.addAll({new2q:new n(a,{setLength:function(e){e===10&&this.setAttribute("maxlength",c)}}),labels:new n(l),errormsg:new n(h,{setError:function(e){switch(e){case"noquestion":this.innerHTML=l.get("noquestion");break;case"lengthexceeded":this.innerHTML=l.get("lengthexceeded")+" ("+c+l.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new r(o)}),o.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',o.render(),o.place(t.get("new2q-popup")),o.press=function(e,t){t.classList.add("pressed")},o.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),a.unsync(),a.reset(i.get("TQTemplate")),h.reset({error:""})},o.cancel=function(e,t){o.closePopup()},o.upload=function(e,t){var n=new Date,r,s="Q:"+n.getTime();t.classList.remove("pressed"),a.get("question")||h.set("error","noquestion"),!h.get("error")&&!a.get("_id")&&(t.classList.add("invisible"),p.spin(t.parentNode),r=setInterval(function(){h.get("error")===l.get("uploadinprogress")?h.set("error",l.get("uploadinprogress")+"..."):h.set("error",l.get("uploadinprogress"))},150),a.set("author",f.get("_id")),a.set("username",f.get("username")),a.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),a.set("lang",f.get("lang")),a.sync(i.get("db"),s).then(function(){return a.upload()}).then(function(){i.get("transport").request("UpdateUIP",{userid:f.get("_id"),type:a.get("type"),docId:s,question:a.get("question")},function(e){var u,c=f.get("connections"),d=c.length,v=[],m={type:"2Q+",docId:s,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:f.get("_id"),username:f.get("username"),firstname:f.get("firstname"),toList:"",ccList:"",object:f.get("username")+l.get("askednew"),body:a.get("question"),signature:""};e!=="ok"&&console.log(e),clearInterval(r),r=setInterval(function(){h.get("error")===l.get("notifyingcontacts")?h.set("error",l.get("notifyingcontacts")+"..."):h.set("error",l.get("notifyingcontacts"))},150);for(u=0;u<d;u++)c[u].type==="user"&&v.push(c[u].userid);m.dest=v,i.get("transport").request("Notify",m,function(e){var e=JSON.parse(e);console.log(e)}),p.stop(),t.classList.remove("invisible"),o.closePopup()})}))},o.checkLength=function(e,t){t.value.length>=c?h.set("error","lengthexceeded"):h.set("error","")},o}}),define("service/tips",["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBView"],function(e,t,n,r,i,s,o){return function(u){var a=new e,f=i.get("labels"),l=new o([]),c=i.get("user"),h=[],p=new s([]),d=new s({});return l.setTransport(i.get("transport")),a.plugins.addAll({labels:new n(f),tip:new n(d,{setTitle:function(e){e==="TIP:0"?this.innerHTML=f.get("signupwelcomeobject"):this.innerHTML=f.get("dyknow")}}),tipevent:new r(a)}),a.template='<div><div class="help-doctor"></div><div class="close-tip" data-tipevent="listen:mousedown, close"></div><div class="tip-screen"><legend data-tip="bind:setTitle, id"></legend><p data-tip = "bind: innerHTML, body"></p><div class="next-button" data-labels = "bind: innerHTML, nextbutton" data-tipevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="tip-footer"><input type="checkbox" data-tipevent="listen: change, doNotShow"><label data-labels="bind: innerHTML, notips"></label></div></div>',a.init=function(e){l.sync(i.get("db"),"about","_view/tip").then(function(){var n=c.get("lang");l.loop(function(e,t){var r=e.value;r.default_lang===n||!r.translations[n]?p.alter("push",{id:r._id,title:r.title,body:r.body}):p.alter("push",{id:r._id,title:r.translations[n].title,body:r.translations[n].body})}),e?d.reset(p.get(0)):(p.alter("splice",0,1),a.getRandomTip()),a.place(t.get("tip-popup")),document.getElementById("tip-popup").classList.add("visible"),document.getElementById("cache").classList.add("visible")})},a.getRandomTip=function(){var e=p.getNbItems(),t=Math.floor(Math.random()*e);e===0?a.close():(d.reset(p.get(t)),p.alter("splice",t,1))},a.press=function(e,t){t.classList.add("pressed")},a.next=function(e,t){t.classList.remove("pressed"),a.getRandomTip()},a.close=function(e,t){document.getElementById("tip-popup").classList.remove("visible"),document.getElementById("cache").classList.remove("visible")},a.doNotShow=function(e,t){var n;t.setAttribute("readonly","readonly"),t.checked===c.get("settings").showTips&&(n=c.get("settings"),n.showTips=!t.checked,c.set("settings",n),c.upload().then(function(){t.removeAttribute("readonly")}))},a}}),define("dock",["OObject","Place.plugin","Amy/Stack-plugin","Amy/Control-plugin","public/public","library/library","brainstorm/brainstorm","connect/connect","dashboard/dashboard","service/map","service/config","./notify","service/newidea","service/help","service/new2q","service/new2c","service/tips"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){return function(){var p=new e,v,g,y,b=new c,w,E,S,x,T,N=new r(this),C=l.get("observer"),k=l.get("user"),L=new n;return p.plugins.addAll({dockstack:L,dockcontrol:N,place:new t({notify:b})}),p.template='<div id="wrapper"><nav id="dock" data-dockcontrol="radio:a,selected,mousedown,setCurrentWidget"><a class="dock-item selected" href="#public" data-dockcontrol="init"></a><a class="dock-item" href="#library"></a><a class="dock-item" href="#brainstorm"></a><a class="dock-item" href="#connect"></a><a class="dock-item" href="#dashboard"></a></nav><div class="stack" data-dockstack="destination"></div><div id="notify" data-place="place:notify"></div></div>',p.place(f.get("dock")),p.init=function(){w=new i,console.log("public ok"),E=new s,console.log("library ok"),S=new o,console.log("brainstorm ok"),x=new u,console.log("connect ok"),T=new a,console.log("dashboard ok"),L.getStack().add("#public",w),L.getStack().add("#library",E),L.getStack().add("#brainstorm",S),L.getStack().add("#connect",x),L.getStack().add("#dashboard",T),b.init(),v=new h,g=new d,y=new m},p.start=function(e){var t=p.dom.querySelector('a[href="#public"]'),n=p.dom.querySelector("a.selected"),r=p.dom.querySelector('a[href="'+k.get("settings").startupScreen+'"]');k.get("settings").startupScreen?(N.radioClass(r,n,"selected"),N.init(r),L.getStack().show(k.get("settings").startupScreen)):(n!==t&&(N.radioClass(t,n,"selected"),N.init(t)),L.getStack().show("#public")),(e||k.get("settings").showTips!==!1)&&y.init(e)},p.reset=function(){w.reset(),E.reset(),S.reset(),x.reset(),T.reset(),b.reset()},this.setCurrentWidget=function(e){var t=e.target.getAttribute("href"),n=3e3;e.preventDefault(),t!==L.getStack().getCurrentName()?(L.getStack().getCurrentScreen().hideMenu(),L.getStack().show(t),L.getStack().getCurrentScreen().showMenu(),setTimeout(function(){L.getStack().getCurrentScreen().hideMenu()},n)):L.getStack().getCurrentScreen().showMenu()},C.watch("replay-session",function(e,t){var n=document.querySelector(".dock-item.selected"),r=document.querySelector(".dock-item[href='#brainstorm']");L.getStack().show("#brainstorm"),N.radioClass(r,n,"selected"),N.init(r)}),C.watch("display-doc",function(){var e=document.querySelector(".dock-item.selected"),t=document.querySelector(".dock-item[href='#library']");L.getStack().show("#library"),N.radioClass(t,e,"selected"),N.init(t)}),C.watch("display-message",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#connect']");L.getStack().show("#connect"),N.radioClass(n,t,"selected"),N.init(n)}),C.watch("display-tutorials",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#dashboard']");L.getStack().show("#dashboard"),N.radioClass(n,t,"selected"),N.init(n)}),C.watch("join-musession",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='#brainstorm']");L.getStack().getCurrentName()!=="#brainstorm"&&(L.getStack().show("#brainstorm"),N.radioClass(n,t,"selected"),N.init(n))}),C.watch("goto-screen",function(e){var t=document.querySelector(".dock-item.selected"),n=document.querySelector(".dock-item[href='"+e+"']");L.getStack().getCurrentName()!==e&&(L.getStack().show(e),N.radioClass(n,t,"selected"),N.init(n))}),p}}),define("login",["OObject","Amy/Stack-plugin","service/map","Event.plugin","service/config","Bind.plugin","Store","lib/spin.min","Promise","CouchDBDocument"],function(e,t,n,r,i,s,o,u,a,f){return function(l,c,h){var p=new e,d=new e,v=new e,m=new e,g=new e,y=new e,b=new t,w=new o({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),E=i.get("labels"),S=i.get("transport"),x=i.get("db"),T,N=(new u({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270})).spin(),C=!1;return p.plugins.addAll({loginstack:b}),m.plugins.add("label",new s(E)),m.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>',m.place(document.getElementById("loading")),g.plugins.add("label",new s(E)),g.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p><div id="loadingspin"></div></div>',y.plugins.add("label",new s(E)),y.template='<div id="nointernt"><p data-label="bind: innerHTML, nointernet"></p><div id="loadingspin"></div></div>',v.plugins.addAll({label:new s(E),loginmodel:new s(w),signupevent:new r(v)}),v.template='<form id="signup-form"><p class="login-fields"><input data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: keypress, resetError"><input data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:keypress, resetError; listen:keypress, entersignup"></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, signup"></label></p><p><label class="login-button pressed-btn" name="#login-screen" data-signupevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form>',v.press=function(e,t){t.classList.add("pressed")},v.release=function(e,t){t.classList.remove("pressed")},v.entersignup=function(e,t){e.keyCode===13&&(e.target.blur(),v.signup())},v.showLogin=function(e,t){b.getStack().show("#login-screen")},v.resetError=function(e,t){w.set("error","")},v.signup=function(e,t){var n=w.get("email"),r=w.get("password"),s=w.get("confirm-password"),o=w.get("firstname"),u=w.get("lastname"),p=new a,d=new f;if(n==="")w.set("error",E.get("signupmissingemail"));else if(r==="")w.set("error",E.get("signupmissingpwd"));else if(s==="")w.set("error",E.get("signupmissingpwdok"));else if(o==="")w.set("error",E.get("signupmissingfn"));else if(u==="")w.set("error",E.get("signupmissingln"));else{var m=n.toLowerCase(),g=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;g.test(m)?r!==s?w.set("error",E.get("signuppwdnomatch")):(N.spin(v.dom),S.request("Signup",{name:m,password:r,fn:o,ln:u,lang:i.get("lang")},function(e){if(e.signup==="ok"){d.reset(i.get("userTemplate")),d.set("firstname",o),d.set("lastname",u),d.set("username",o+" "+u),d.set("lang",i.get("lang"));var t=new Date;d.set("notifications",[{type:"MSG",toList:o+" "+u,date:[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],object:E.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:E.get("signupwelcomebody")}]),S.request("Welcome",{userid:m,language:d.get("lang")},function(e){console.log(e)}),e.db&&h.set("db",e.db),d.setTransport(S),d.sync(e.db,m).then(function(){return d.upload()}).then(function(){h.set("currentLogin",m),h.set("userAvatar",d.get("picture_file")),h.sync("ideafy-data"),i.set("uid",'"'+m+'"'),d.unsync(),C?c(!0):l(!0)})}else w.set("error","error : "+e.message),w.set("email",""),N.stop()},this)):w.set("error",E.get("signupinvalidemail"))}},d.plugins.addAll({label:new s(E),loginmodel:new s(w),loginevent:new r(d)}),d.template='<form id="login-form"><p class="login-fields"><input data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:keypress, resetError"><input data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: keypress, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:mousedown, press; listen: mouseup, release; listen:mouseup, login"></label></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup-button" class="pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showSignup"></label></p></form>',d.press=function(e,t){t.classList.add("pressed")},d.release=function(e,t){t.classList.remove("pressed")},d.enterlogin=function(e,t){e.keyCode===13&&(e.target.blur(),d.login())},d.showSignup=function(e,t){b.getStack().show("#signup-screen")},d.resetError=function(e,t){w.set("error","")},d.login=function(e,t){var n=w.get("email").toLowerCase(),r=w.get("password");n&&r?(N.spin(d.dom),S.request("Login",{name:n,password:r},function(e){e.login==="ok"?(i.set("uid",'"'+n+'"'),e.db&&h.set("db",e.db),h.set("currentLogin",n),S.request("GetAvatar",{id:n},function(e){e.error||(h.set("userAvatar",e),h.sync("ideafy-data"),i.set("avatar",e)),C?c():l()})):(w.set("error",E.get("invalidlogin")),N.stop())})):w.set("error",E.get("invalidlogin"))},b.getStack().add("#login-screen",d),b.getStack().add("#signup-screen",v),b.getStack().add("#loading-screen",m),b.getStack().add("#maintenance-screen",g),b.getStack().add("#nointernet",y),p.alive(n.get("login")),p.init=function(){b.getStack().show("#loading-screen"),T=(new u({color:"#9AC9CD",lines:10,length:20,width:8,radius:15})).spin(document.getElementById("loadingspin"))},p.setScreen=function(e){b.getStack().show(e)},p.reset=function(e){w.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:""}),e&&(C=!0)},p.stopSpinner=function(){N&&N.stop(),T&&T.stop()},p}}),require(["OObject","LocalStore","service/map","Amy/Stack-plugin","Bind.plugin","Amy/Delegate-plugin","./dock","./login","service/config","service/utils","Promise"],function(e,t,n,r,i,s,o,u,a,f,l){var c=new e,h=null,p=new r({"#login":h}),d=new o,v=new t,m=f.updateLabels,g=f.checkServerStatus,y=a.get("labels"),b=a.get("db"),w=a.get("transport"),E=a.get("user"),S;S="1.1.2",c.plugins.addAll({stack:p}),c.init=function(e){p.getStack().add("#dock",d),v.get("db")&&v.get("db")!==b&&(b=v.get("db")),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.init(),h.stopSpinner(),p.getStack().show("#dock"),d.start(e)})},c.reload=function(e){E.unsync(),E.reset(),E.sync(b,v.get("currentLogin")).then(function(){var e=new l;return a.set("uid",'"'+E.get("_id")+'"'),E.get("lang")!==a.get("lang")?m(E.get("lang")).then(function(){e.fulfill()}):e.fulfill(),e}).then(function(){var e=new l;return E.get("picture_file").search("img/avatars/deedee")>-1?(a.set("avatar",E.get("picture_file")),e.fulfill()):v.get("userAvatar")?(a.set("avatar",v.get("userAvatar")),e.fulfill()):w.request("GetFile",{dir:"avatars",filename:E.get("_id")+"_@v@t@r"},function(t){t.error?(console.log(t.error),a.set("avatar","img/avatars/deedee1.png")):a.set("avatar",t),e.fulfill()}),e}).then(function(){d.reset(),h.stopSpinner(),p.getStack().show("#dock"),d.start(e)})},c.alive(n.get("body")),v.sync("ideafy-data"),h=new u(c.init,c.reload,v),document.querySelector(".spinner").classList.add("invisible"),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.init(),navigator.connection&&navigator.connection.type==="none"?(v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),a.set("lang",y.set("language")),h.setScreen("#nointernet")):g().then(function(){v.get("labels")?(y.reset(v.get("labels")),a.set("lang",y.get("language"))):m(navigator.language),w.request("CheckVersion",{version:S},function(e){var t=y.get("outdated")||"Please update your application";e==="outdated"&&alert(t)});var e=v.get("currentLogin")||"";e?w.request("CheckLogin",{id:e},function(e){e.authenticated?c.init():h.setScreen("#login-screen")}):h.setScreen("#signup-screen")},function(e){v.get("labels")?y.reset(v.get("labels")):y.reset(a.get("defaultLabels")),h.setScreen("#maintenance-screen")}),a.get("observer").watch("signout",function(){v.set("currentLogin",""),v.set("userAvatar",""),v.sync("ideafy-data"),p.getStack().add("#login",h),h.reset(!0),p.getStack().show("#login"),p.getStack().setCurrentScreen(h),h.setScreen("#login-screen"),document.getElementById("cache").classList.remove("appear")}),n.get("body").addEventListener("mousedown",f.checkSocketStatus),a.get("observer").watch("reconnect",function(){v.sync("ideafy-data"),g.then(function(){return E.unsync(),E.sync(b,v.get("currentLogin"))},function(){h.setScreen("#maintenance-screen")}).then(function(){console.log("user resynchronized")})})}),define("main",function(){});