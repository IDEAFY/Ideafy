/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","service/cardpopup","../whiteboard/whiteboard","Store","CouchDBStore","Promise","service/utils"],function(e,t,n,r,i,s,o,u,a,f,l){return function(h,p,d,v,m){var g=new e,y,b,w="step",E,S=0,x,T=new u({timer:null,display:!1}),N=new u({title:"",description:"",solution:"",visibility:"private"}),C=new u,k=new u([]),L=[],A=new u({cardpopup:{scenario:!1,techs:[!1,!1,!1]}},{postit:"inactive"},{"import":"inactive"},{drawing:"inactive"},{ready:!1},{showidea:!1},{shownext:!1},{readonly:!1}),O=new u([]),M=new o("idea",O,A),_=i.get("transport"),D=i.get("labels");return g.plugins.addAll({labels:new n(D,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new n(C),techs:new n(k,{setPic:function(e){e&&this.setAttribute("style","background-image:url('"+e+"');")}}),wbtools:new n(A,{setActive:function(e){e==="active"?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;this.getAttribute("name")==="scenario"?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),quickideatimer:new n(T,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new n(N,{setVisibility:function(e){e==="public"?(this.value=0,this.setAttribute("style","background-image:url('img/brainstorm/publicforslider.png'); background-position: 50px center; background-repeat:no-repeat; background-size: 30px;")):(this.value=1,this.setAttribute("style","background-image:url('img/brainstorm/privateforslider.png'); background-position: 15px center; background-repeat:no-repeat; background-size: 20px;"))}}),wbstack:M,quickideaevent:new r(g)}),g.template='<div id = "quickidea"><div class="previousbutton" data-quickideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickidea" data-quickideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickideatimer="bind:setTime, timer; bind: displayTimer, display" data-quickideaevent="listen:mousedown,toggleTimer"></div><div id="quickidea-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-quickideaevent="listen: mousedown, select; listen:mouseup, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul></div><div id="quickidea-popup"></div><div id="quickidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend>Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend>Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend>Drawing tool</legend></div></div><div id="finish-button" class="invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickidea-writeup" class="writeup invisible" data-wbtools="bind: setReady,showidea"><textarea class = "enterTitle" maxlength="40" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><input class="visibility-slider" type="range" min="0" max="1" value ="1" data-idea="bind: setVisibility, visibility" data-quickideaevent="listen:mouseup, toggleVisibility" data-wbtools="bind:setReadonly, readonly"><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea><div class = "finish-button finish-writeup"></div></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickideaevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',g.place(t.get("quickidea")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){var n=new Date,r,s;t.classList.remove("pressed"),w==="step"?(w="screen",clearInterval(x),T.set("display",!0),s=g.getSessionDuration(),p.set("idea",JSON.parse(N.toJSON())),g.createIdeaDoc(),g.updateSessionScore(T.get("timer")).then(function(){h.unsync(),h.sync(i.get("db"),h.get("_id")).then(function(){var e=h.get("elapsedTimers");e.quickidea=T.get("timer"),h.set("idea",[JSON.parse(N.toJSON())]),h.set("elapsedTimers",e),h.set("duration",s),h.set("status","completed"),A.set("readonly",!0),v("quickidea")})})):v("quickidea")},g.prev=function(e,t){t.classList.remove("pressed"),d("quickidea")},g.toggleProgress=function(e,t){m(t)},g.toggleTimer=function(e,t){T.set("display",!T.get("display"))},g.toggleVisibility=function(e,t){w==="step"&&(N.get("visibility")==="public"?N.set("visibility","private"):N.set("visibility","public"))},g.push=function(e,t){var n=t.getAttribute("name");A.set(n,"active")},g.select=function(e,t){t.classList.add("higlighted")},g.zoom=function(e,t){var n,r;t.getAttribute("name")==="scenario"?n="scenario":(n="techno",r=t.getAttribute("data-techs_id")),g.setPopup(n,r)},g.setPopup=function(t,n){var r={x:240,y:30},s="left",o=A.get("cardpopup"),f=new u,l="",c,h;b&&(b.type==="scenario"?o.scenario=!1:o.techs[b.id]=!1,A.set("cardpopup",o)),t==="scenario"?o.scenario=!0:o.techs[n]=!0,A.set("cardpopup",o),b={type:t,id:n},t==="scenario"?(r.y=55,f.reset(p.get("scenario")),f.set("type",5),l=f.toJSON(),y.reset(l,r,s,document.getElementById("quickidea-popup"))):(n==0&&(r.y=200),n==1&&(r.y=260),n==2&&(r.y=350),L[n]?(l=L[n],y.reset(l,r,s,document.getElementById("quickidea-popup"))):(h=new a,h.setTransport(_),h.sync(i.get("db"),p.get("techno").get(n).id).then(function(){l=h.toJSON(),y.reset(l,r,s,document.getElementById("quickidea-popup")),L[n]=l})))},g.closePopup=function(){var t=A.get("cardpopup");t[b]=!1,A.set("cardpopup",t),b=""},y=new s(g.closePopup),g.post=function(e,t){M.selectScreen("postit"),A.set("import","inactive"),A.set("drawing","inactive")},g.importpic=function(e,t){M.selectScreen("import"),A.set("postit","inactive"),A.set("drawing","inactive")},g.draw=function(e,t){M.selectScreen("drawing"),A.set("import","inactive"),A.set("postit","inactive")},g.exitTool=function(t){A.set(t,"inactive")},g.finish=function(e,t){M.setReadonly(!0),A.set("ready",!1),A.set("showidea",!0)},g.updateSessionScore=function(e){var t=new f,n={sid:h.get("_id"),step:"quickidea",time:e,wbcontent:O.toJSON(),idea:N.toJSON()};return _.request("UpdateSessionScore",n,function(e){e.res==="ok"?t.resolve():t.reject()}),t},g.getSessionDuration=function(){var t=h.get("elapsedTime"),n=h.get("resumeTime")||h.get("startTime");return now=new Date,now.getTime()-n+t},g.createIdeaDoc=function(){var t=new a(i.get("ideaTemplate")),n=new Date,r="I:"+n.getTime();t.setTransport(_),t.set("title",N.get("title")),t.set("sessionId",h.get("_id")),t.set("authors",[h.get("initiator").id]),t.set("description",N.get("description")),t.set("solution",N.get("solution")),t.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),t.set("character",h.get("characters")[0]),t.set("problem",h.get("problems")[0]),t.set("context",h.get("contexts")[0]),t.set("visibility",N.get("visibility")),t.set("authornames",h.get("initiator").username),t.set("lang",h.get("lang")),t.set("_id",r),t.sync(i.get("db"),r),setTimeout(function(){t.upload()},300)},g.reset=function(t){A.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]}},{postit:"inactive"},{"import":"inactive"},{drawing:"inactive"},{ready:!1},{showidea:!1},{shownext:!1},{readonly:!1}),k.reset(),M.setSessionId(h.get("_id")),O.reset(h.get("ideaWB")),O.getNbItems()?M.selectScreen("main"):M.selectScreen("default"),clearInterval(x),h.get("idea").length?(M.setReadonly(!0),A.set("ready",!1),A.set("showidea",!0),N.reset(h.get("idea")[0]),p.set("idea",h.get("idea")[0]),A.set("readonly",!0),A.set("shownext",!0),w="screen"):(N.reset({title:"",description:"",solution:"",visibility:"private"}),O.getNbItems()?A.set("ready",!0):A.set("ready",!1),M.setReadonly(!1),w="step"),h.get("elapsedTimers").quickidea?S=h.get("elapsedTimers").quickidea:S=0,T.set("timer",S),w==="screen"?T.set("display",!0):g.initTimer(S)},g.initTimer=function(e){var t=new Date,n=t.getTime(),r=e||0;T.set("display",!1),T.set("timer",r),h.get("step")==="quickidea"&&(x=setInterval(function(){var e=new Date;T.set("timer",r+e.getTime()-n)},1e3))},h.watchValue("_id",function(e){M.setSessionId(e)}),p.watchValue("scenario",function(e){C.reset(p.get("scenario"))}),p.watchValue("techno",function(e){k.reset(JSON.parse(p.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){O.watch(e,function(){JSON.stringify(h.get("ideaWB"))!==O.toJSON()&&(h.set("ideaWB",JSON.parse(O.toJSON())),h.upload()),O.getNbItems()?A.set("ready",!0):A.set("ready",!1)})}),N.watch("updated",function(){N.get("title")&&N.get("description")&&N.get("solution")?A.set("shownext",!0):A.set("shownext",!1)}),g}});