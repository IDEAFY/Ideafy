/**
 * https://github.com/TAIAUT/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent.weyl@taiaut.com>
 * Copyright (c) 2012-2013 TAIAUT
 */

define(["Olives/OObject","service/map","Olives/Model-plugin","Olives/Event-plugin","service/config","CouchDBStore","Store","service/utils","service/avatarlist"],function(e,t,n,r,s,o,u,a,f){return function(){var c=new e,h=new e,p,d,v=t.get("sessions"),m=new u,g=s.get("db"),y=s.get("user"),b=s.get("avatars"),w=s.get("labels"),E=new u({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),S="sbydate",x=[],T=[],N="",C=new o;return C.setTransport(s.get("transport")),c.plugins.addAll({label:new n(w),sort:new n(E,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(m,{formatDate:function(e){e&&e.length&&(this.innerHTML=a.formatDate(e))},formatIdeas:function(e){if(e&&e.length===1)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=w.get("noideayet")},setAvatars:function(e){var t=new f(e),n=document.createDocumentFragment(),r=this;t.place(n),r.hasChildNodes()?r.replaceChild(n,r.firstChild):r.appendChild(n)},setStatus:function(e){e==="completed"?this.innerHTML=w.get("completed"):this.innerHTML=w.get("inprogress")},setScore:function(e){e>=0?this.innerHTML=e:this.innerHTML=""},setSuffix:function(e){e===undefined||e===""||e===null?this.innerHTML=w.get("noscore"):this.innerHTML="ip"}}),sortevent:new r(c),sessionevent:new r(c)}),c.template='<div id="sessions"><div id="session-list" class="list"><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen:mousedown, setStart; listen: mousemove, displayActionBar"><table class="session-boxscore"><tr><td class="session-type"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>',c.sort=function(t,n){var r=n.getAttribute("id");E.get(r).selected?E.set(r,{selected:!0,descending:!E.get(r).descending}):(E.set(S,{selected:!1,descending:E.get(S).descending}),E.set(r,{selected:!0,descending:E.get(r).descending}),S=r),c.sortSessions(r)},c.sortSessions=function(t){var n;N?n=T:n=x;if(n.length)switch(t){case"sbytitle":a.sortByProperty(n,"title",E.get("sbytitle").descending);break;case"sbydate":a.sortByProperty(n,"date",E.get("sbydate").descending);break;case"sbyidea":a.sortByProperty(n,"idea",E.get("sbyidea").descending);break;case"sbyscore":a.sortByProperty(n,"score",E.get("sbyscore").descending)}m.reset(n)},c.acceptinput=function(e,t){t.removeAttribute("readonly")},c.search=function(t,n){var r=document.getElementById("sessionsearchresult");r.innerHTML="",t.keyCode===13&&(N=n.value,N===""?(c.sortSessions(S),m.reset(x)):(T=a.searchArray(x,N),r.innerHTML=w.get("foundlbl")+" "+T.length+" "+w.get("matchingsessions"),m.reset(T)))},c.setStart=function(e,t){p=[e.pageX,e.pageY]},c.displayActionBar=function(e,t){var n=t.getAttribute("data-sessions_id"),r=t.offsetHeight,i=m.get(n);d=[e.pageX,e.pageY],p[0]-d[0]>40&&d[1]-p[1]<20&&d[1]-p[1]>-20&&(t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+r+"px;height: "+r+"px;"),i.participants.length>1||i.participants[0]!=y.get("_id")||i.id===y.get("sessionInProgress").id?t.querySelector(".deletesession").setAttribute("style","display: none;"):t.querySelector(".deletesession").setAttribute("style","display: inline-block;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3))},c.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},c.press=function(e,t){t.classList.add("pressed")},c.replay=function(e,t){var n=t.getAttribute("data-sessions_id"),r=m.get(n).id,i=m.get(n).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),s.get("observer").notify("replay-session",r,i)},c.deleteSession=function(e,t){var n=t.getAttribute("data-sessions_id"),r=m.get(n).id;t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;");var i=new o;i.setTransport(s.get("transport")),i.sync(g,r).then(function(){i.remove()}),s.get("transport").request("cleanUpSession",r,function(e){e.err&&console.log(e.err)})},c.resetSessionData=function(){x=[],C.loop(function(e,t){var n={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode};n.participants.push(e.value.initiator.id),n.usernames.push(e.value.initiator.username);for(j=0;j<e.value.participants.length;j++)n.participants.push(e.value.participants[j].id),n.usernames.push(e.value.participants[j].username);n.idea&&n.idea.length>1&&a.sortByProperty(n.idea,"title",!1),x.push(n)}),m.reset(x)},c.getMode=function(t){var n;return C.loop(function(e,r){e.id===t&&(n=e.value.mode)}),n},c.place(v),C.sync(g,"library","_view/sessions",{key:s.get("uid"),descending:!0}).then(function(){c.resetSessionData(),["added","deleted","updated"].forEach(function(e){C.watch(e,function(e,t){c.resetSessionData(),c.sortSessions(S)})})}),c}});